/*! For license information please see bundle.js.LICENSE.txt */
(()=>{var e={20:(e,t,n)=>{"use strict";var r=n(540),i=Symbol.for("react.element"),o=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,a=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,l={key:!0,ref:!0,__self:!0,__source:!0};function c(e,t,n){var r,o={},c=null,u=null;for(r in void 0!==n&&(c=""+n),void 0!==t.key&&(c=""+t.key),void 0!==t.ref&&(u=t.ref),t)s.call(t,r)&&!l.hasOwnProperty(r)&&(o[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===o[r]&&(o[r]=t[r]);return{$$typeof:i,type:e,key:c,ref:u,props:o,_owner:a.current}}t.Fragment=o,t.jsx=c,t.jsxs=c},45:e=>{"use strict";function t(e){return e>=55296&&e<=56319}function n(e){return e>=56320&&e<=57343}e.exports=function(e,r,i){if("string"!=typeof r)throw new Error("Input must be string");for(var o,s,a=r.length,l=0,c=0;c<a;c+=1){if(o=r.charCodeAt(c),s=r[c],t(o)&&n(r.charCodeAt(c+1))&&(s+=r[c+=1]),(l+=e(s))===i)return r.slice(0,c+1);if(l>i)return r.slice(0,c-s.length+1)}return r}},152:(e,t,n)=>{"use strict";var r=n(668).hp;class i{static isArrayBuffer(e){return"[object ArrayBuffer]"===Object.prototype.toString.call(e)}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=i.toUint8Array(e),r=i.toUint8Array(t);if(n.length!==r.byteLength)return!1;for(let e=0;e<n.length;e++)if(n[e]!==r[e])return!1;return!0}static concat(...e){let t;t=!Array.isArray(e[0])||e[1]instanceof Function?Array.isArray(e[0])&&e[1]instanceof Function?e[0]:e[e.length-1]instanceof Function?e.slice(0,e.length-1):e:e[0];let n=0;for(const e of t)n+=e.byteLength;const r=new Uint8Array(n);let i=0;for(const e of t){const t=this.toUint8Array(e);r.set(t,i),i+=t.length}return e[e.length-1]instanceof Function?this.toView(r,e[e.length-1]):r.buffer}}const o="string",s=/^[0-9a-f\s]+$/i,a=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,l=/^[a-zA-Z0-9-_]+$/;class c{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}static toString(e){const t=i.toUint8Array(e);let n="";for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return decodeURIComponent(escape(n))}}class u{static toString(e,t=!1){const n=i.toArrayBuffer(e),r=new DataView(n);let o="";for(let e=0;e<n.byteLength;e+=2){const n=r.getUint16(e,t);o+=String.fromCharCode(n)}return o}static fromString(e,t=!1){const n=new ArrayBuffer(2*e.length),r=new DataView(n);for(let n=0;n<e.length;n++)r.setUint16(2*n,e.charCodeAt(n),t);return n}}class d{static isHex(e){return typeof e===o&&s.test(e)}static isBase64(e){return typeof e===o&&a.test(e)}static isBase64Url(e){return typeof e===o&&l.test(e)}static ToString(e,t="utf8"){const n=i.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return u.toString(n,!0);case"utf16":case"utf16be":return u.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return u.fromString(e,!0);case"utf16":case"utf16be":return u.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=i.toUint8Array(e);if("undefined"!=typeof btoa){const e=this.ToString(t,"binary");return btoa(e)}return r.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!d.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return"undefined"!=typeof atob?this.FromBinary(atob(t)):new Uint8Array(r.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!d.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=d.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return c.fromString(e);case"utf16":case"utf16be":return u.fromString(e);case"utf16le":case"usc2":return u.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=d.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return c.toString(e);case"utf16":case"utf16be":return u.toString(e);case"utf16le":case"usc2":return u.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let r=0;r<t;r++)n[r]=e.charCodeAt(r);return n.buffer}static ToBinary(e){const t=i.toUint8Array(e);let n="";for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return n}static ToHex(e){const t=i.toUint8Array(e);let n="";const r=t.length;for(let e=0;e<r;e++){const r=t[e];r<16&&(n+="0"),n+=r.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!d.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2){const r=t.slice(e,e+2);n[e/2]=parseInt(r,16)}return n.buffer}static ToUtf16String(e,t=!1){return u.toString(e,t)}static FromUtf16String(e,t=!1){return u.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return(null==e?void 0:e.replace(/[\n\r\t ]/g,""))||""}}d.DEFAULT_UTF8_ENCODING="utf8",t._H=i,t.U$=d},194:e=>{e.exports=function(e){if(!e)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,n=Object.create(null),r=Object.create(null);function i(i,o){n[i]=o,++t>=e&&(t=0,r=n,n=Object.create(null))}return{has:function(e){return void 0!==n[e]||void 0!==r[e]},remove:function(e){void 0!==n[e]&&(n[e]=void 0),void 0!==r[e]&&(r[e]=void 0)},get:function(e){var t=n[e];return void 0!==t?t:void 0!==(t=r[e])?(i(e,t),t):void 0},set:function(e,t){void 0!==n[e]?n[e]=t:i(e,t)},clear:function(){n=Object.create(null),r=Object.create(null)}}}},203:(e,t,n)=>{e.exports={encode:n(877),decode:n(797),encodingLength:n(867)}},228:e=>{"use strict";var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,r,o,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new i(r,o||e,s),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],a]:e._events[l].push(a):(e._events[l]=a,e._eventsCount++),e}function s(e,t){0===--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),a.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,o=r.length,s=new Array(o);i<o;i++)s[i]=r[i].fn;return s},a.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,i,o,s){var a=n?n+e:e;if(!this._events[a])return!1;var l,c,u=this._events[a],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,i),!0;case 5:return u.fn.call(u.context,t,r,i,o),!0;case 6:return u.fn.call(u.context,t,r,i,o,s),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,f=u.length;for(c=0;c<f;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,i);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},a.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,r,i){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return s(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||i&&!a.once||r&&a.context!==r||s(this,o);else{for(var l=0,c=[],u=a.length;l<u;l++)(a[l].fn!==t||i&&!a[l].once||r&&a[l].context!==r)&&c.push(a[l]);c.length?this._events[o]=1===c.length?c[0]:c:s(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&s(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a},251:(e,t)=>{t.read=function(e,t,n,r,i){var o,s,a=8*i-r-1,l=(1<<a)-1,c=l>>1,u=-7,d=n?i-1:0,h=n?-1:1,f=e[t+d];for(d+=h,o=f&(1<<-u)-1,f>>=-u,u+=a;u>0;o=256*o+e[t+d],d+=h,u-=8);for(s=o&(1<<-u)-1,o>>=-u,u+=r;u>0;s=256*s+e[t+d],d+=h,u-=8);if(0===o)o=1-c;else{if(o===l)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,r),o-=c}return(f?-1:1)*s*Math.pow(2,o-r)},t.write=function(e,t,n,r,i,o){var s,a,l,c=8*o-i-1,u=(1<<c)-1,d=u>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:o-1,p=r?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=u):(s=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-s))<1&&(s--,l*=2),(t+=s+d>=1?h/l:h*Math.pow(2,1-d))*l>=2&&(s++,l/=2),s+d>=u?(a=0,s=u):s+d>=1?(a=(t*l-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+f]=255&a,f+=p,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;e[n+f]=255&s,f+=p,s/=256,c-=8);e[n+f-p]|=128*g}},287:(e,t)=>{"use strict";var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),l=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),h=Symbol.for("react.lazy"),f=Symbol.iterator,p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,m={};function y(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||p}function w(){}function b(e,t,n){this.props=e,this.context=t,this.refs=m,this.updater=n||p}y.prototype.isReactComponent={},y.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},y.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},w.prototype=y.prototype;var v=b.prototype=new w;v.constructor=b,g(v,y.prototype),v.isPureReactComponent=!0;var E=Array.isArray,S=Object.prototype.hasOwnProperty,k={current:null},_={key:!0,ref:!0,__self:!0,__source:!0};function R(e,t,r){var i,o={},s=null,a=null;if(null!=t)for(i in void 0!==t.ref&&(a=t.ref),void 0!==t.key&&(s=""+t.key),t)S.call(t,i)&&!_.hasOwnProperty(i)&&(o[i]=t[i]);var l=arguments.length-2;if(1===l)o.children=r;else if(1<l){for(var c=Array(l),u=0;u<l;u++)c[u]=arguments[u+2];o.children=c}if(e&&e.defaultProps)for(i in l=e.defaultProps)void 0===o[i]&&(o[i]=l[i]);return{$$typeof:n,type:e,key:s,ref:a,props:o,_owner:k.current}}function I(e){return"object"==typeof e&&null!==e&&e.$$typeof===n}var A=/\/+/g;function x(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,function(e){return t[e]})}(""+e.key):t.toString(36)}function T(e,t,i,o,s){var a=typeof e;"undefined"!==a&&"boolean"!==a||(e=null);var l=!1;if(null===e)l=!0;else switch(a){case"string":case"number":l=!0;break;case"object":switch(e.$$typeof){case n:case r:l=!0}}if(l)return s=s(l=e),e=""===o?"."+x(l,0):o,E(s)?(i="",null!=e&&(i=e.replace(A,"$&/")+"/"),T(s,t,i,"",function(e){return e})):null!=s&&(I(s)&&(s=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(s,i+(!s.key||l&&l.key===s.key?"":(""+s.key).replace(A,"$&/")+"/")+e)),t.push(s)),1;if(l=0,o=""===o?".":o+":",E(e))for(var c=0;c<e.length;c++){var u=o+x(a=e[c],c);l+=T(a,t,i,u,s)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),c=0;!(a=e.next()).done;)l+=T(a=a.value,t,i,u=o+x(a,c++),s);else if("object"===a)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return l}function C(e,t,n){if(null==e)return e;var r=[],i=0;return T(e,r,"","",function(e){return t.call(n,e,i++)}),r}function N(e){if(-1===e._status){var t=e._result;(t=t()).then(function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)},function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)}),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var D={current:null},P={transition:null},L={ReactCurrentDispatcher:D,ReactCurrentBatchConfig:P,ReactCurrentOwner:k};function B(){throw Error("act(...) is not supported in production builds of React.")}t.Children={map:C,forEach:function(e,t,n){C(e,function(){t.apply(this,arguments)},n)},count:function(e){var t=0;return C(e,function(){t++}),t},toArray:function(e){return C(e,function(e){return e})||[]},only:function(e){if(!I(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=y,t.Fragment=i,t.Profiler=s,t.PureComponent=b,t.StrictMode=o,t.Suspense=u,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=L,t.act=B,t.cloneElement=function(e,t,r){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var i=g({},e.props),o=e.key,s=e.ref,a=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,a=k.current),void 0!==t.key&&(o=""+t.key),e.type&&e.type.defaultProps)var l=e.type.defaultProps;for(c in t)S.call(t,c)&&!_.hasOwnProperty(c)&&(i[c]=void 0===t[c]&&void 0!==l?l[c]:t[c])}var c=arguments.length-2;if(1===c)i.children=r;else if(1<c){l=Array(c);for(var u=0;u<c;u++)l[u]=arguments[u+2];i.children=l}return{$$typeof:n,type:e.type,key:o,ref:s,props:i,_owner:a}},t.createContext=function(e){return(e={$$typeof:l,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=R,t.createFactory=function(e){var t=R.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:c,render:e}},t.isValidElement=I,t.lazy=function(e){return{$$typeof:h,_payload:{_status:-1,_result:e},_init:N}},t.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=P.transition;P.transition={};try{e()}finally{P.transition=t}},t.unstable_act=B,t.useCallback=function(e,t){return D.current.useCallback(e,t)},t.useContext=function(e){return D.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return D.current.useDeferredValue(e)},t.useEffect=function(e,t){return D.current.useEffect(e,t)},t.useId=function(){return D.current.useId()},t.useImperativeHandle=function(e,t,n){return D.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return D.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return D.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return D.current.useMemo(e,t)},t.useReducer=function(e,t,n){return D.current.useReducer(e,t,n)},t.useRef=function(e){return D.current.useRef(e)},t.useState=function(e){return D.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return D.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return D.current.useTransition()},t.version="18.3.1"},310:e=>{"use strict";function t(e,t){for(const n in t)Object.defineProperty(e,n,{value:t[n],enumerable:!0,configurable:!0});return e}e.exports=function(e,n,r){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");r||(r={}),"object"==typeof n&&(r=n,n=""),n&&(r.code=n);try{return t(e,r)}catch(n){r.message=e.message,r.stack=e.stack;const i=function(){};return i.prototype=Object.create(Object.getPrototypeOf(e)),t(new i,r)}}},327:function(e,t){!function(n,r){"use strict";var i={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function o(e){if(!Array.isArray(e)&&!ArrayBuffer.isView(e))return!1;for(var t=0;t<e.length;t++)if(!Number.isInteger(e[t])||e[t]<0||e[t]>255)return!1;return!0}function s(e,t){return(65535&e)*t+(((e>>>16)*t&65535)<<16)}function a(e,t){return e<<t|e>>>32-t}function l(e){return e=s(e^=e>>>16,2246822507),(e=s(e^=e>>>13,3266489909))^e>>>16}function c(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];var n=[0,0,0,0];return n[3]+=e[3]+t[3],n[2]+=n[3]>>>16,n[3]&=65535,n[2]+=e[2]+t[2],n[1]+=n[2]>>>16,n[2]&=65535,n[1]+=e[1]+t[1],n[0]+=n[1]>>>16,n[1]&=65535,n[0]+=e[0]+t[0],n[0]&=65535,[n[0]<<16|n[1],n[2]<<16|n[3]]}function u(e,t){e=[e[0]>>>16,65535&e[0],e[1]>>>16,65535&e[1]],t=[t[0]>>>16,65535&t[0],t[1]>>>16,65535&t[1]];var n=[0,0,0,0];return n[3]+=e[3]*t[3],n[2]+=n[3]>>>16,n[3]&=65535,n[2]+=e[2]*t[3],n[1]+=n[2]>>>16,n[2]&=65535,n[2]+=e[3]*t[2],n[1]+=n[2]>>>16,n[2]&=65535,n[1]+=e[1]*t[3],n[0]+=n[1]>>>16,n[1]&=65535,n[1]+=e[2]*t[2],n[0]+=n[1]>>>16,n[1]&=65535,n[1]+=e[3]*t[1],n[0]+=n[1]>>>16,n[1]&=65535,n[0]+=e[0]*t[3]+e[1]*t[2]+e[2]*t[1]+e[3]*t[0],n[0]&=65535,[n[0]<<16|n[1],n[2]<<16|n[3]]}function d(e,t){return 32==(t%=64)?[e[1],e[0]]:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t|e[0]>>>32-t]:(t-=32,[e[1]<<t|e[0]>>>32-t,e[0]<<t|e[1]>>>32-t])}function h(e,t){return 0==(t%=64)?e:t<32?[e[0]<<t|e[1]>>>32-t,e[1]<<t]:[e[1]<<t-32,0]}function f(e,t){return[e[0]^t[0],e[1]^t[1]]}function p(e){return e=f(e,[0,e[0]>>>1]),e=f(e=u(e,[4283543511,3981806797]),[0,e[0]>>>1]),f(e=u(e,[3301882366,444984403]),[0,e[0]>>>1])}i.x86.hash32=function(e,t){if(i.inputValidation&&!o(e))return r;t=t||0;for(var n=e.length%4,c=e.length-n,u=t,d=0,h=3432918353,f=461845907,p=0;p<c;p+=4)d=s(d=e[p]|e[p+1]<<8|e[p+2]<<16|e[p+3]<<24,h),d=s(d=a(d,15),f),u=s(u=a(u^=d,13),5)+3864292196;switch(d=0,n){case 3:d^=e[p+2]<<16;case 2:d^=e[p+1]<<8;case 1:d=s(d^=e[p],h),u^=d=s(d=a(d,15),f)}return(u=l(u^=e.length))>>>0},i.x86.hash128=function(e,t){if(i.inputValidation&&!o(e))return r;t=t||0;for(var n=e.length%16,c=e.length-n,u=t,d=t,h=t,f=t,p=0,g=0,m=0,y=0,w=597399067,b=2869860233,v=951274213,E=2716044179,S=0;S<c;S+=16)p=e[S]|e[S+1]<<8|e[S+2]<<16|e[S+3]<<24,g=e[S+4]|e[S+5]<<8|e[S+6]<<16|e[S+7]<<24,m=e[S+8]|e[S+9]<<8|e[S+10]<<16|e[S+11]<<24,y=e[S+12]|e[S+13]<<8|e[S+14]<<16|e[S+15]<<24,p=a(p=s(p,w),15),u=a(u^=p=s(p,b),19),u=s(u+=d,5)+1444728091,g=a(g=s(g,b),16),d=a(d^=g=s(g,v),17),d=s(d+=h,5)+197830471,m=a(m=s(m,v),17),h=a(h^=m=s(m,E),15),h=s(h+=f,5)+2530024501,y=a(y=s(y,E),18),f=a(f^=y=s(y,w),13),f=s(f+=u,5)+850148119;switch(p=0,g=0,m=0,y=0,n){case 15:y^=e[S+14]<<16;case 14:y^=e[S+13]<<8;case 13:y=s(y^=e[S+12],E),f^=y=s(y=a(y,18),w);case 12:m^=e[S+11]<<24;case 11:m^=e[S+10]<<16;case 10:m^=e[S+9]<<8;case 9:m=s(m^=e[S+8],v),h^=m=s(m=a(m,17),E);case 8:g^=e[S+7]<<24;case 7:g^=e[S+6]<<16;case 6:g^=e[S+5]<<8;case 5:g=s(g^=e[S+4],b),d^=g=s(g=a(g,16),v);case 4:p^=e[S+3]<<24;case 3:p^=e[S+2]<<16;case 2:p^=e[S+1]<<8;case 1:p=s(p^=e[S],w),u^=p=s(p=a(p,15),b)}return u^=e.length,u+=d^=e.length,u+=h^=e.length,d+=u+=f^=e.length,h+=u,f+=u,u=l(u),u+=d=l(d),u+=h=l(h),d+=u+=f=l(f),h+=u,f+=u,("00000000"+(u>>>0).toString(16)).slice(-8)+("00000000"+(d>>>0).toString(16)).slice(-8)+("00000000"+(h>>>0).toString(16)).slice(-8)+("00000000"+(f>>>0).toString(16)).slice(-8)},i.x64.hash128=function(e,t){if(i.inputValidation&&!o(e))return r;t=t||0;for(var n=e.length%16,s=e.length-n,a=[0,t],l=[0,t],g=[0,0],m=[0,0],y=[2277735313,289559509],w=[1291169091,658871167],b=0;b<s;b+=16)g=[e[b+4]|e[b+5]<<8|e[b+6]<<16|e[b+7]<<24,e[b]|e[b+1]<<8|e[b+2]<<16|e[b+3]<<24],m=[e[b+12]|e[b+13]<<8|e[b+14]<<16|e[b+15]<<24,e[b+8]|e[b+9]<<8|e[b+10]<<16|e[b+11]<<24],g=d(g=u(g,y),31),a=c(a=d(a=f(a,g=u(g,w)),27),l),a=c(u(a,[0,5]),[0,1390208809]),m=d(m=u(m,w),33),l=c(l=d(l=f(l,m=u(m,y)),31),a),l=c(u(l,[0,5]),[0,944331445]);switch(g=[0,0],m=[0,0],n){case 15:m=f(m,h([0,e[b+14]],48));case 14:m=f(m,h([0,e[b+13]],40));case 13:m=f(m,h([0,e[b+12]],32));case 12:m=f(m,h([0,e[b+11]],24));case 11:m=f(m,h([0,e[b+10]],16));case 10:m=f(m,h([0,e[b+9]],8));case 9:m=u(m=f(m,[0,e[b+8]]),w),l=f(l,m=u(m=d(m,33),y));case 8:g=f(g,h([0,e[b+7]],56));case 7:g=f(g,h([0,e[b+6]],48));case 6:g=f(g,h([0,e[b+5]],40));case 5:g=f(g,h([0,e[b+4]],32));case 4:g=f(g,h([0,e[b+3]],24));case 3:g=f(g,h([0,e[b+2]],16));case 2:g=f(g,h([0,e[b+1]],8));case 1:g=u(g=f(g,[0,e[b]]),y),a=f(a,g=u(g=d(g,31),w))}return a=c(a=f(a,[0,e.length]),l=f(l,[0,e.length])),l=c(l,a),a=c(a=p(a),l=p(l)),l=c(l,a),("00000000"+(a[0]>>>0).toString(16)).slice(-8)+("00000000"+(a[1]>>>0).toString(16)).slice(-8)+("00000000"+(l[0]>>>0).toString(16)).slice(-8)+("00000000"+(l[1]>>>0).toString(16)).slice(-8)},e.exports&&(t=e.exports=i),t.murmurHash3=i}()},338:(e,t,n)=>{"use strict";var r=n(961);t.createRoot=r.createRoot,t.hydrateRoot=r.hydrateRoot},368:e=>{"use strict";e.exports=e=>{if("[object Object]"!==Object.prototype.toString.call(e))return!1;const t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}},424:(e,t,n)=>{"use strict";var r=n(743),i=/[\/\?<>\\:\*\|"]/g,o=/[\x00-\x1f\x80-\x9f]/g,s=/^\.+$/,a=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,l=/[\. ]+$/;function c(e,t){if("string"!=typeof e)throw new Error("Input must be string");var n=e.replace(i,t).replace(o,t).replace(s,t).replace(a,t).replace(l,t);return r(n,255)}e.exports=function(e,t){var n=t&&t.replacement||"",r=c(e,n);return""===n?r:c(r,"")}},437:(e,t,n)=>{e.exports=n(327)},446:e=>{"use strict";function t(e){return e>=55296&&e<=56319}function n(e){return e>=56320&&e<=57343}e.exports=function(e){if("string"!=typeof e)throw new Error("Input must be string");for(var r=e.length,i=0,o=null,s=null,a=0;a<r;a++)n(o=e.charCodeAt(a))?null!=s&&t(s)?i+=1:i+=3:o<=127?i+=1:o>=128&&o<=2047?i+=2:o>=2048&&o<=65535&&(i+=3),s=o;return i}},454:e=>{!function(){e.exports=m;var t=86400,n=3200,r=146097*n/400,i=t*r,o=1e3*i,s=864e13,a=4294967296,l=1e6,c="000000000",u=Math.trunc||function(e){var t=e-e%1;return 0==t&&(e<0||0===e&&1/e!=1/0)?-0:t},d=m.prototype,h=(m.fromDate=function(e){return new m(+e)},m.fromInt64BE=E(0,1,2,3,0,4),m.fromInt64LE=E(3,2,1,0,4,0),m.fromString=function(e){var t,n=new m;if(e=(e+="").replace(/^\s*[+\-]?\d+/,function(e){var t=1970+((e=+e)-1970)%400;return n.year=e-t,t}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(e,n,r){return n<0&&(r*=-1),t=6e4*(60*+n+ +r),""}).replace(/\.\d+$/,function(e){return n.nano=+(e+c).substr(1,9),""}).split(/\D+/),1<e.length?e[1]--:e[1]=0,n.time=t=Date.UTC.apply(Date,e)-(t||0),isNaN(t))throw new TypeError("Invalid Date");return y(n)},m.fromTimeT=function(e){return b(e,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(e){return this.nano+=+e||0,this},d.getNano=function(){var e=y(this);return(e.time%1e3*l+ +e.nano+1e9)%1e9},d.getTimeT=function(){var e=y(this),i=Math.floor(e.time/1e3);return(e=e.year)&&(i+=e*r*t/n),i},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return w(y(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(e){var t=this,n=t.toDate(),r={H:function(){return k(n.getUTCHours())},L:function(){return _(n.getUTCMilliseconds(),3)},M:function(){return k(n.getUTCMinutes())},N:function(){return _(t.getNano(),9)},S:function(){return k(n.getUTCSeconds())},Y:function(){var e=t.getYear();return 999999<e?"+"+e:9999<e?"+"+_(e,6):0<=e?_(e,4):-999999<=e?"-"+_(-e,6):e},a:function(){return p[n.getUTCDay()]},b:function(){return f[n.getUTCMonth()]},d:function(){return k(n.getUTCDate())},e:function(){return function(e){return(9<e?"":" ")+(0|e)}(n.getUTCDate())},m:function(){return k(n.getUTCMonth()+1)}};return function e(t){return t.replace(/%./g,function(t){var n=t[1],i=g[n];return n=r[n],i?e(i):n?n():t})}(e||h)},d.writeInt64BE=v(0,1,2,3,0,4),d.writeInt64LE=v(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),f=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],p=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:"\n",R:"%H:%M",T:"%H:%M:%S",t:"\t",X:"%T",Z:"GMT",z:"+0000"};return m;function m(e,t,n){var r=this;if(!(r instanceof m))return new m(e,t,n);r.time=+e||0,r.nano=+t||0,r.year=+n||0,y(r)}function y(e){var t,r,i,a=e.year,c=e.time,d=e.nano,h=((d<0||l<=d)&&(d-=(r=Math.floor(d/l))*l,c+=r,r=1),a%n);return(c<-s||s<c||h)&&((t=u(c/o))&&(a+=t*n,c-=t*o),(i=w(c)).setUTCFullYear(h+i.getUTCFullYear()),i=(c=+i)+(t=u((a-=h)/n))*o,t&&-s<=i&&i<=s&&(a-=t*n,c=i),r=1),r&&(e.year=a,e.time=c,e.nano=d),e}function w(e){var t=new Date(0);return t.setTime(e),t}function b(e,t){e=+e||0;var r=u((t=(0|t)*a)/i)+u(e/i);return(e=u((t=t%i+e%i)/i))&&(r+=e,t-=e*i),new m(1e3*t,0,r*n)}function v(e,i,o,s,l,c){return function(e,i){var o=y(this);S(e=e||new Array(8),i|=0);var s=Math.floor(o.time/1e3),h=(o=o.year*(r*t/n),u(o/a)+u(s/a));return o=o%a+s%a,(s=Math.floor(o/a))&&(h+=s,o-=s*a),d(e,i+l,h),d(e,i+c,o),e};function d(t,n,r){t[n+e]=r>>24&255,t[n+i]=r>>16&255,t[n+o]=r>>8&255,t[n+s]=255&r}}function E(e,t,n,r,i,o){return function(e,t){S(e,t|=0);var n=s(e,t+i);return b(s(e,t+o),n)};function s(i,o){return 16777216*i[o+e]+(i[o+t]<<16|i[o+n]<<8|i[o+r])}}function S(e,t){if(null==(e=e&&e.length))throw new TypeError("Invalid Buffer");if(e<t+8)throw new RangeError("Out of range")}function k(e){return(9<e?"":"0")+(0|e)}function _(e,t){return(c+(0|e)).substr(-t)}}()},463:(e,t)=>{"use strict";function n(e,t){var n=e.length;e.push(t);e:for(;0<n;){var r=n-1>>>1,i=e[r];if(!(0<o(i,t)))break e;e[r]=t,e[n]=i,n=r}}function r(e){return 0===e.length?null:e[0]}function i(e){if(0===e.length)return null;var t=e[0],n=e.pop();if(n!==t){e[0]=n;e:for(var r=0,i=e.length,s=i>>>1;r<s;){var a=2*(r+1)-1,l=e[a],c=a+1,u=e[c];if(0>o(l,n))c<i&&0>o(u,l)?(e[r]=u,e[c]=n,r=c):(e[r]=l,e[a]=n,r=a);else{if(!(c<i&&0>o(u,n)))break e;e[r]=u,e[c]=n,r=c}}}return t}function o(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var s=performance;t.unstable_now=function(){return s.now()}}else{var a=Date,l=a.now();t.unstable_now=function(){return a.now()-l}}var c=[],u=[],d=1,h=null,f=3,p=!1,g=!1,m=!1,y="function"==typeof setTimeout?setTimeout:null,w="function"==typeof clearTimeout?clearTimeout:null,b="undefined"!=typeof setImmediate?setImmediate:null;function v(e){for(var t=r(u);null!==t;){if(null===t.callback)i(u);else{if(!(t.startTime<=e))break;i(u),t.sortIndex=t.expirationTime,n(c,t)}t=r(u)}}function E(e){if(m=!1,v(e),!g)if(null!==r(c))g=!0,P(S);else{var t=r(u);null!==t&&L(E,t.startTime-e)}}function S(e,n){g=!1,m&&(m=!1,w(I),I=-1),p=!0;var o=f;try{for(v(n),h=r(c);null!==h&&(!(h.expirationTime>n)||e&&!T());){var s=h.callback;if("function"==typeof s){h.callback=null,f=h.priorityLevel;var a=s(h.expirationTime<=n);n=t.unstable_now(),"function"==typeof a?h.callback=a:h===r(c)&&i(c),v(n)}else i(c);h=r(c)}if(null!==h)var l=!0;else{var d=r(u);null!==d&&L(E,d.startTime-n),l=!1}return l}finally{h=null,f=o,p=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var k,_=!1,R=null,I=-1,A=5,x=-1;function T(){return!(t.unstable_now()-x<A)}function C(){if(null!==R){var e=t.unstable_now();x=e;var n=!0;try{n=R(!0,e)}finally{n?k():(_=!1,R=null)}}else _=!1}if("function"==typeof b)k=function(){b(C)};else if("undefined"!=typeof MessageChannel){var N=new MessageChannel,D=N.port2;N.port1.onmessage=C,k=function(){D.postMessage(null)}}else k=function(){y(C,0)};function P(e){R=e,_||(_=!0,k())}function L(e,n){I=y(function(){e(t.unstable_now())},n)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(e){e.callback=null},t.unstable_continueExecution=function(){g||p||(g=!0,P(S))},t.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):A=0<e?Math.floor(1e3/e):5},t.unstable_getCurrentPriorityLevel=function(){return f},t.unstable_getFirstCallbackNode=function(){return r(c)},t.unstable_next=function(e){switch(f){case 1:case 2:case 3:var t=3;break;default:t=f}var n=f;f=t;try{return e()}finally{f=n}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=f;f=e;try{return t()}finally{f=n}},t.unstable_scheduleCallback=function(e,i,o){var s=t.unstable_now();switch(o="object"==typeof o&&null!==o&&"number"==typeof(o=o.delay)&&0<o?s+o:s,e){case 1:var a=-1;break;case 2:a=250;break;case 5:a=1073741823;break;case 4:a=1e4;break;default:a=5e3}return e={id:d++,callback:i,priorityLevel:e,startTime:o,expirationTime:a=o+a,sortIndex:-1},o>s?(e.sortIndex=o,n(u,e),null===r(c)&&e===r(u)&&(m?(w(I),I=-1):m=!0,L(E,o-s))):(e.sortIndex=a,n(c,e),g||p||(g=!0,P(S))),e},t.unstable_shouldYield=T,t.unstable_wrapCallback=function(e){var t=f;return function(){var n=f;f=t;try{return e.apply(this,arguments)}finally{f=n}}}},507:function(e,t){(function(){var e,n,r,i,o,s,a,l;l=function(e){return[(e&255<<24)>>>24,(e&255<<16)>>>16,(65280&e)>>>8,255&e].join(".")},a=function(e){var t,r,i,o,s,a;for(t=[],i=o=0;o<=3&&0!==e.length;i=++o){if(i>0){if("."!==e[0])throw new Error("Invalid IP");e=e.substring(1)}s=(a=n(e))[0],r=a[1],e=e.substring(r),t.push(s)}if(0!==e.length)throw new Error("Invalid IP");switch(t.length){case 1:if(t[0]>4294967295)throw new Error("Invalid IP");return t[0]>>>0;case 2:if(t[0]>255||t[1]>16777215)throw new Error("Invalid IP");return(t[0]<<24|t[1])>>>0;case 3:if(t[0]>255||t[1]>255||t[2]>65535)throw new Error("Invalid IP");return(t[0]<<24|t[1]<<16|t[2])>>>0;case 4:if(t[0]>255||t[1]>255||t[2]>255||t[3]>255)throw new Error("Invalid IP");return(t[0]<<24|t[1]<<16|t[2]<<8|t[3])>>>0;default:throw new Error("Invalid IP")}},i=(r=function(e){return e.charCodeAt(0)})("0"),s=r("a"),o=r("A"),n=function(e){var t,n,a,l,c;for(l=0,t=10,n="9",a=0,e.length>1&&"0"===e[a]&&("x"===e[a+1]||"X"===e[a+1]?(a+=2,t=16):"0"<=e[a+1]&&e[a+1]<="9"&&(a++,t=8,n="7")),c=a;a<e.length;){if("0"<=e[a]&&e[a]<=n)l=l*t+(r(e[a])-i)>>>0;else{if(16!==t)break;if("a"<=e[a]&&e[a]<="f")l=l*t+(10+r(e[a])-s)>>>0;else{if(!("A"<=e[a]&&e[a]<="F"))break;l=l*t+(10+r(e[a])-o)>>>0}}if(l>4294967295)throw new Error("too large");a++}if(a===c)throw new Error("empty octet");return[l,a]},e=function(){function e(e,t){var n,r,i;if("string"!=typeof e)throw new Error("Missing `net' parameter");if(t||(i=e.split("/",2),e=i[0],t=i[1]),t||(t=32),"string"==typeof t&&t.indexOf(".")>-1){try{this.maskLong=a(t)}catch(e){throw new Error("Invalid mask: "+t)}for(n=r=32;r>=0;n=--r)if(this.maskLong===4294967295<<32-n>>>0){this.bitmask=n;break}}else{if(!t&&0!==t)throw new Error("Invalid mask: empty");this.bitmask=parseInt(t,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0)}try{this.netLong=(a(e)&this.maskLong)>>>0}catch(t){throw new Error("Invalid net address: "+e)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+t);this.size=Math.pow(2,32-this.bitmask),this.base=l(this.netLong),this.mask=l(this.maskLong),this.hostmask=l(~this.maskLong),this.first=this.bitmask<=30?l(this.netLong+1):this.base,this.last=this.bitmask<=30?l(this.netLong+this.size-2):l(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?l(this.netLong+this.size-1):void 0}return e.prototype.contains=function(t){return"string"==typeof t&&(t.indexOf("/")>0||4!==t.split(".").length)&&(t=new e(t)),t instanceof e?this.contains(t.base)&&this.contains(t.broadcast||t.last):(a(t)&this.maskLong)>>>0==(this.netLong&this.maskLong)>>>0},e.prototype.next=function(t){return null==t&&(t=1),new e(l(this.netLong+this.size*t),this.mask)},e.prototype.forEach=function(e){var t,n,r;for(r=a(this.first),n=a(this.last),t=0;r<=n;)e(l(r),r,t),t++,r++},e.prototype.toString=function(){return this.base+"/"+this.bitmask},e}(),t.ip2long=a,t.long2ip=l,t.Netmask=e}).call(this)},526:(e,t)=>{"use strict";t.byteLength=function(e){var t=a(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,o=a(e),s=o[0],l=o[1],c=new i(function(e,t,n){return 3*(t+n)/4-n}(0,s,l)),u=0,d=l>0?s-4:s;for(n=0;n<d;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],c[u++]=t>>16&255,c[u++]=t>>8&255,c[u++]=255&t;return 2===l&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,c[u++]=255&t),1===l&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,c[u++]=t>>8&255,c[u++]=255&t),c},t.fromByteArray=function(e){for(var t,r=e.length,i=r%3,o=[],s=16383,a=0,l=r-i;a<l;a+=s)o.push(c(e,a,a+s>l?l:a+s));return 1===i?(t=e[r-1],o.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],o.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),o.join("")};for(var n=[],r=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)n[s]=o[s],r[o.charCodeAt(s)]=s;function a(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function l(e){return n[e>>18&63]+n[e>>12&63]+n[e>>6&63]+n[63&e]}function c(e,t,n){for(var r,i=[],o=t;o<n;o+=3)r=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),i.push(l(r));return i.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},540:(e,t,n)=>{"use strict";e.exports=n(287)},544:(e,t,n)=>{"use strict";const r=n(939);t.PP=r.EventIterator,r.EventIterator},606:e=>{var t,n,r=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function s(e){if(t===setTimeout)return setTimeout(e,0);if((t===i||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:i}catch(e){t=i}try{n="function"==typeof clearTimeout?clearTimeout:o}catch(e){n=o}}();var a,l=[],c=!1,u=-1;function d(){c&&a&&(c=!1,a.length?l=a.concat(l):u=-1,l.length&&h())}function h(){if(!c){var e=s(d);c=!0;for(var t=l.length;t;){for(a=l,l=[];++u<t;)a&&a[u].run();u=-1,t=l.length}a=null,c=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===o||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{return n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function p(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new f(e,t)),1!==l.length||c||s(h)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=p,r.addListener=p,r.once=p,r.off=p,r.removeListener=p,r.removeAllListeners=p,r.emit=p,r.prependListener=p,r.prependOnceListener=p,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},668:(e,t,n)=>{"use strict";const r=n(526),i=n(251),o="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.hp=l,t.IS=50;const s=2147483647;function a(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');const t=new Uint8Array(e);return Object.setPrototypeOf(t,l.prototype),t}function l(e,t,n){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return d(e)}return c(e,t,n)}function c(e,t,n){if("string"==typeof e)return function(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!l.isEncoding(t))throw new TypeError("Unknown encoding: "+t);const n=0|g(e,t);let r=a(n);const i=r.write(e,t);return i!==n&&(r=r.slice(0,i)),r}(e,t);if(ArrayBuffer.isView(e))return function(e){if(Y(e,Uint8Array)){const t=new Uint8Array(e);return f(t.buffer,t.byteOffset,t.byteLength)}return h(e)}(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(Y(e,ArrayBuffer)||e&&Y(e.buffer,ArrayBuffer))return f(e,t,n);if("undefined"!=typeof SharedArrayBuffer&&(Y(e,SharedArrayBuffer)||e&&Y(e.buffer,SharedArrayBuffer)))return f(e,t,n);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return l.from(r,t,n);const i=function(e){if(l.isBuffer(e)){const t=0|p(e.length),n=a(t);return 0===n.length||e.copy(n,0,0,t),n}return void 0!==e.length?"number"!=typeof e.length||Q(e.length)?a(0):h(e):"Buffer"===e.type&&Array.isArray(e.data)?h(e.data):void 0}(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return l.from(e[Symbol.toPrimitive]("string"),t,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function u(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function d(e){return u(e),a(e<0?0:0|p(e))}function h(e){const t=e.length<0?0:0|p(e.length),n=a(t);for(let r=0;r<t;r+=1)n[r]=255&e[r];return n}function f(e,t,n){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(n||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===t&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,t):new Uint8Array(e,t,n),Object.setPrototypeOf(r,l.prototype),r}function p(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function g(e,t){if(l.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||Y(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);const n=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===n)return 0;let i=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return j(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return W(e).length;default:if(i)return r?-1:j(e).length;t=(""+t).toLowerCase(),i=!0}}function m(e,t,n){let r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return C(this,t,n);case"utf8":case"utf-8":return I(this,t,n);case"ascii":return x(this,t,n);case"latin1":case"binary":return T(this,t,n);case"base64":return R(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function y(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}function w(e,t,n,r,i){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),Q(n=+n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=l.from(t,r)),l.isBuffer(t))return 0===t.length?-1:b(e,t,n,r,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):b(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function b(e,t,n,r,i){let o,s=1,a=e.length,l=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;s=2,a/=2,l/=2,n/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){let r=-1;for(o=n;o<a;o++)if(c(e,o)===c(t,-1===r?0:o-r)){if(-1===r&&(r=o),o-r+1===l)return r*s}else-1!==r&&(o-=o-r),r=-1}else for(n+l>a&&(n=a-l),o=n;o>=0;o--){let n=!0;for(let r=0;r<l;r++)if(c(e,o+r)!==c(t,r)){n=!1;break}if(n)return o}return-1}function v(e,t,n,r){n=Number(n)||0;const i=e.length-n;r?(r=Number(r))>i&&(r=i):r=i;const o=t.length;let s;for(r>o/2&&(r=o/2),s=0;s<r;++s){const r=parseInt(t.substr(2*s,2),16);if(Q(r))return s;e[n+s]=r}return s}function E(e,t,n,r){return G(j(t,e.length-n),e,n,r)}function S(e,t,n,r){return G(function(e){const t=[];for(let n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function k(e,t,n,r){return G(W(t),e,n,r)}function _(e,t,n,r){return G(function(e,t){let n,r,i;const o=[];for(let s=0;s<e.length&&!((t-=2)<0);++s)n=e.charCodeAt(s),r=n>>8,i=n%256,o.push(i),o.push(r);return o}(t,e.length-n),e,n,r)}function R(e,t,n){return 0===t&&n===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,n))}function I(e,t,n){n=Math.min(e.length,n);const r=[];let i=t;for(;i<n;){const t=e[i];let o=null,s=t>239?4:t>223?3:t>191?2:1;if(i+s<=n){let n,r,a,l;switch(s){case 1:t<128&&(o=t);break;case 2:n=e[i+1],128==(192&n)&&(l=(31&t)<<6|63&n,l>127&&(o=l));break;case 3:n=e[i+1],r=e[i+2],128==(192&n)&&128==(192&r)&&(l=(15&t)<<12|(63&n)<<6|63&r,l>2047&&(l<55296||l>57343)&&(o=l));break;case 4:n=e[i+1],r=e[i+2],a=e[i+3],128==(192&n)&&128==(192&r)&&128==(192&a)&&(l=(15&t)<<18|(63&n)<<12|(63&r)<<6|63&a,l>65535&&l<1114112&&(o=l))}}null===o?(o=65533,s=1):o>65535&&(o-=65536,r.push(o>>>10&1023|55296),o=56320|1023&o),r.push(o),i+=s}return function(e){const t=e.length;if(t<=A)return String.fromCharCode.apply(String,e);let n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=A));return n}(r)}l.TYPED_ARRAY_SUPPORT=function(){try{const e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),l.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(l.prototype,"parent",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.buffer}}),Object.defineProperty(l.prototype,"offset",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.byteOffset}}),l.poolSize=8192,l.from=function(e,t,n){return c(e,t,n)},Object.setPrototypeOf(l.prototype,Uint8Array.prototype),Object.setPrototypeOf(l,Uint8Array),l.alloc=function(e,t,n){return function(e,t,n){return u(e),e<=0?a(e):void 0!==t?"string"==typeof n?a(e).fill(t,n):a(e).fill(t):a(e)}(e,t,n)},l.allocUnsafe=function(e){return d(e)},l.allocUnsafeSlow=function(e){return d(e)},l.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==l.prototype},l.compare=function(e,t){if(Y(e,Uint8Array)&&(e=l.from(e,e.offset,e.byteLength)),Y(t,Uint8Array)&&(t=l.from(t,t.offset,t.byteLength)),!l.isBuffer(e)||!l.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let n=e.length,r=t.length;for(let i=0,o=Math.min(n,r);i<o;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},l.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return l.alloc(0);let n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;const r=l.allocUnsafe(t);let i=0;for(n=0;n<e.length;++n){let t=e[n];if(Y(t,Uint8Array))i+t.length>r.length?(l.isBuffer(t)||(t=l.from(t)),t.copy(r,i)):Uint8Array.prototype.set.call(r,t,i);else{if(!l.isBuffer(t))throw new TypeError('"list" argument must be an Array of Buffers');t.copy(r,i)}i+=t.length}return r},l.byteLength=g,l.prototype._isBuffer=!0,l.prototype.swap16=function(){const e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)y(this,t,t+1);return this},l.prototype.swap32=function(){const e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)y(this,t,t+3),y(this,t+1,t+2);return this},l.prototype.swap64=function(){const e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)y(this,t,t+7),y(this,t+1,t+6),y(this,t+2,t+5),y(this,t+3,t+4);return this},l.prototype.toString=function(){const e=this.length;return 0===e?"":0===arguments.length?I(this,0,e):m.apply(this,arguments)},l.prototype.toLocaleString=l.prototype.toString,l.prototype.equals=function(e){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===l.compare(this,e)},l.prototype.inspect=function(){let e="";const n=t.IS;return e=this.toString("hex",0,n).replace(/(.{2})/g,"$1 ").trim(),this.length>n&&(e+=" ... "),"<Buffer "+e+">"},o&&(l.prototype[o]=l.prototype.inspect),l.prototype.compare=function(e,t,n,r,i){if(Y(e,Uint8Array)&&(e=l.from(e,e.offset,e.byteLength)),!l.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),t<0||n>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(this===e)return 0;let o=(i>>>=0)-(r>>>=0),s=(n>>>=0)-(t>>>=0);const a=Math.min(o,s),c=this.slice(r,i),u=e.slice(t,n);for(let e=0;e<a;++e)if(c[e]!==u[e]){o=c[e],s=u[e];break}return o<s?-1:s<o?1:0},l.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},l.prototype.indexOf=function(e,t,n){return w(this,e,t,n,!0)},l.prototype.lastIndexOf=function(e,t,n){return w(this,e,t,n,!1)},l.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(n)?(n>>>=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}const i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let o=!1;for(;;)switch(r){case"hex":return v(this,e,t,n);case"utf8":case"utf-8":return E(this,e,t,n);case"ascii":case"latin1":case"binary":return S(this,e,t,n);case"base64":return k(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _(this,e,t,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const A=4096;function x(e,t,n){let r="";n=Math.min(e.length,n);for(let i=t;i<n;++i)r+=String.fromCharCode(127&e[i]);return r}function T(e,t,n){let r="";n=Math.min(e.length,n);for(let i=t;i<n;++i)r+=String.fromCharCode(e[i]);return r}function C(e,t,n){const r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);let i="";for(let r=t;r<n;++r)i+=X[e[r]];return i}function N(e,t,n){const r=e.slice(t,n);let i="";for(let e=0;e<r.length-1;e+=2)i+=String.fromCharCode(r[e]+256*r[e+1]);return i}function D(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function P(e,t,n,r,i,o){if(!l.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function L(e,t,n,r,i){$(t,r,i,e,n,7);let o=Number(t&BigInt(4294967295));e[n++]=o,o>>=8,e[n++]=o,o>>=8,e[n++]=o,o>>=8,e[n++]=o;let s=Number(t>>BigInt(32)&BigInt(4294967295));return e[n++]=s,s>>=8,e[n++]=s,s>>=8,e[n++]=s,s>>=8,e[n++]=s,n}function B(e,t,n,r,i){$(t,r,i,e,n,7);let o=Number(t&BigInt(4294967295));e[n+7]=o,o>>=8,e[n+6]=o,o>>=8,e[n+5]=o,o>>=8,e[n+4]=o;let s=Number(t>>BigInt(32)&BigInt(4294967295));return e[n+3]=s,s>>=8,e[n+2]=s,s>>=8,e[n+1]=s,s>>=8,e[n]=s,n+8}function O(e,t,n,r,i,o){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function M(e,t,n,r,o){return t=+t,n>>>=0,o||O(e,0,n,4),i.write(e,t,n,r,23,4),n+4}function U(e,t,n,r,o){return t=+t,n>>>=0,o||O(e,0,n,8),i.write(e,t,n,r,52,8),n+8}l.prototype.slice=function(e,t){const n=this.length;(e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e);const r=this.subarray(e,t);return Object.setPrototypeOf(r,l.prototype),r},l.prototype.readUintLE=l.prototype.readUIntLE=function(e,t,n){e>>>=0,t>>>=0,n||D(e,t,this.length);let r=this[e],i=1,o=0;for(;++o<t&&(i*=256);)r+=this[e+o]*i;return r},l.prototype.readUintBE=l.prototype.readUIntBE=function(e,t,n){e>>>=0,t>>>=0,n||D(e,t,this.length);let r=this[e+--t],i=1;for(;t>0&&(i*=256);)r+=this[e+--t]*i;return r},l.prototype.readUint8=l.prototype.readUInt8=function(e,t){return e>>>=0,t||D(e,1,this.length),this[e]},l.prototype.readUint16LE=l.prototype.readUInt16LE=function(e,t){return e>>>=0,t||D(e,2,this.length),this[e]|this[e+1]<<8},l.prototype.readUint16BE=l.prototype.readUInt16BE=function(e,t){return e>>>=0,t||D(e,2,this.length),this[e]<<8|this[e+1]},l.prototype.readUint32LE=l.prototype.readUInt32LE=function(e,t){return e>>>=0,t||D(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},l.prototype.readUint32BE=l.prototype.readUInt32BE=function(e,t){return e>>>=0,t||D(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},l.prototype.readBigUInt64LE=Z(function(e){H(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||K(e,this.length-8);const r=t+256*this[++e]+65536*this[++e]+this[++e]*2**24,i=this[++e]+256*this[++e]+65536*this[++e]+n*2**24;return BigInt(r)+(BigInt(i)<<BigInt(32))}),l.prototype.readBigUInt64BE=Z(function(e){H(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||K(e,this.length-8);const r=t*2**24+65536*this[++e]+256*this[++e]+this[++e],i=this[++e]*2**24+65536*this[++e]+256*this[++e]+n;return(BigInt(r)<<BigInt(32))+BigInt(i)}),l.prototype.readIntLE=function(e,t,n){e>>>=0,t>>>=0,n||D(e,t,this.length);let r=this[e],i=1,o=0;for(;++o<t&&(i*=256);)r+=this[e+o]*i;return i*=128,r>=i&&(r-=Math.pow(2,8*t)),r},l.prototype.readIntBE=function(e,t,n){e>>>=0,t>>>=0,n||D(e,t,this.length);let r=t,i=1,o=this[e+--r];for(;r>0&&(i*=256);)o+=this[e+--r]*i;return i*=128,o>=i&&(o-=Math.pow(2,8*t)),o},l.prototype.readInt8=function(e,t){return e>>>=0,t||D(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},l.prototype.readInt16LE=function(e,t){e>>>=0,t||D(e,2,this.length);const n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt16BE=function(e,t){e>>>=0,t||D(e,2,this.length);const n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt32LE=function(e,t){return e>>>=0,t||D(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},l.prototype.readInt32BE=function(e,t){return e>>>=0,t||D(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},l.prototype.readBigInt64LE=Z(function(e){H(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||K(e,this.length-8);const r=this[e+4]+256*this[e+5]+65536*this[e+6]+(n<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+256*this[++e]+65536*this[++e]+this[++e]*2**24)}),l.prototype.readBigInt64BE=Z(function(e){H(e>>>=0,"offset");const t=this[e],n=this[e+7];void 0!==t&&void 0!==n||K(e,this.length-8);const r=(t<<24)+65536*this[++e]+256*this[++e]+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+65536*this[++e]+256*this[++e]+n)}),l.prototype.readFloatLE=function(e,t){return e>>>=0,t||D(e,4,this.length),i.read(this,e,!0,23,4)},l.prototype.readFloatBE=function(e,t){return e>>>=0,t||D(e,4,this.length),i.read(this,e,!1,23,4)},l.prototype.readDoubleLE=function(e,t){return e>>>=0,t||D(e,8,this.length),i.read(this,e,!0,52,8)},l.prototype.readDoubleBE=function(e,t){return e>>>=0,t||D(e,8,this.length),i.read(this,e,!1,52,8)},l.prototype.writeUintLE=l.prototype.writeUIntLE=function(e,t,n,r){e=+e,t>>>=0,n>>>=0,r||P(this,e,t,n,Math.pow(2,8*n)-1,0);let i=1,o=0;for(this[t]=255&e;++o<n&&(i*=256);)this[t+o]=e/i&255;return t+n},l.prototype.writeUintBE=l.prototype.writeUIntBE=function(e,t,n,r){e=+e,t>>>=0,n>>>=0,r||P(this,e,t,n,Math.pow(2,8*n)-1,0);let i=n-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+n},l.prototype.writeUint8=l.prototype.writeUInt8=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,1,255,0),this[t]=255&e,t+1},l.prototype.writeUint16LE=l.prototype.writeUInt16LE=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},l.prototype.writeUint16BE=l.prototype.writeUInt16BE=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},l.prototype.writeUint32LE=l.prototype.writeUInt32LE=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},l.prototype.writeUint32BE=l.prototype.writeUInt32BE=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},l.prototype.writeBigUInt64LE=Z(function(e,t=0){return L(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeBigUInt64BE=Z(function(e,t=0){return B(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))}),l.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*n-1);P(this,e,t,n,r-1,-r)}let i=0,o=1,s=0;for(this[t]=255&e;++i<n&&(o*=256);)e<0&&0===s&&0!==this[t+i-1]&&(s=1),this[t+i]=(e/o|0)-s&255;return t+n},l.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t>>>=0,!r){const r=Math.pow(2,8*n-1);P(this,e,t,n,r-1,-r)}let i=n-1,o=1,s=0;for(this[t+i]=255&e;--i>=0&&(o*=256);)e<0&&0===s&&0!==this[t+i+1]&&(s=1),this[t+i]=(e/o|0)-s&255;return t+n},l.prototype.writeInt8=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},l.prototype.writeInt16LE=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},l.prototype.writeInt16BE=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},l.prototype.writeInt32LE=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},l.prototype.writeInt32BE=function(e,t,n){return e=+e,t>>>=0,n||P(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},l.prototype.writeBigInt64LE=Z(function(e,t=0){return L(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),l.prototype.writeBigInt64BE=Z(function(e,t=0){return B(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),l.prototype.writeFloatLE=function(e,t,n){return M(this,e,t,!0,n)},l.prototype.writeFloatBE=function(e,t,n){return M(this,e,t,!1,n)},l.prototype.writeDoubleLE=function(e,t,n){return U(this,e,t,!0,n)},l.prototype.writeDoubleBE=function(e,t,n){return U(this,e,t,!1,n)},l.prototype.copy=function(e,t,n,r){if(!l.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);const i=r-n;return this===e&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(t,n,r):Uint8Array.prototype.set.call(e,this.subarray(n,r),t),i},l.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!l.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===e.length){const t=e.charCodeAt(0);("utf8"===r&&t<128||"latin1"===r)&&(e=t)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;let i;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(i=t;i<n;++i)this[i]=e;else{const o=l.isBuffer(e)?e:l.from(e,r),s=o.length;if(0===s)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<n-t;++i)this[i+t]=o[i%s]}return this};const F={};function z(e,t,n){F[e]=class extends n{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(e){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:e,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}function V(e){let t="",n=e.length;const r="-"===e[0]?1:0;for(;n>=r+4;n-=3)t=`_${e.slice(n-3,n)}${t}`;return`${e.slice(0,n)}${t}`}function $(e,t,n,r,i,o){if(e>n||e<t){const r="bigint"==typeof t?"n":"";let i;throw i=o>3?0===t||t===BigInt(0)?`>= 0${r} and < 2${r} ** ${8*(o+1)}${r}`:`>= -(2${r} ** ${8*(o+1)-1}${r}) and < 2 ** ${8*(o+1)-1}${r}`:`>= ${t}${r} and <= ${n}${r}`,new F.ERR_OUT_OF_RANGE("value",i,e)}!function(e,t,n){H(t,"offset"),void 0!==e[t]&&void 0!==e[t+n]||K(t,e.length-(n+1))}(r,i,o)}function H(e,t){if("number"!=typeof e)throw new F.ERR_INVALID_ARG_TYPE(t,"number",e)}function K(e,t,n){if(Math.floor(e)!==e)throw H(e,n),new F.ERR_OUT_OF_RANGE(n||"offset","an integer",e);if(t<0)throw new F.ERR_BUFFER_OUT_OF_BOUNDS;throw new F.ERR_OUT_OF_RANGE(n||"offset",`>= ${n?1:0} and <= ${t}`,e)}z("ERR_BUFFER_OUT_OF_BOUNDS",function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),z("ERR_INVALID_ARG_TYPE",function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`},TypeError),z("ERR_OUT_OF_RANGE",function(e,t,n){let r=`The value of "${e}" is out of range.`,i=n;return Number.isInteger(n)&&Math.abs(n)>2**32?i=V(String(n)):"bigint"==typeof n&&(i=String(n),(n>BigInt(2)**BigInt(32)||n<-(BigInt(2)**BigInt(32)))&&(i=V(i)),i+="n"),r+=` It must be ${t}. Received ${i}`,r},RangeError);const q=/[^+/0-9A-Za-z-_]/g;function j(e,t){let n;t=t||1/0;const r=e.length;let i=null;const o=[];for(let s=0;s<r;++s){if(n=e.charCodeAt(s),n>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function W(e){return r.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(q,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function G(e,t,n,r){let i;for(i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function Y(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function Q(e){return e!=e}const X=function(){const e="0123456789abcdef",t=new Array(256);for(let n=0;n<16;++n){const r=16*n;for(let i=0;i<16;++i)t[r+i]=e[n]+e[i]}return t}();function Z(e){return"undefined"==typeof BigInt?J:e}function J(){throw new Error("BigInt not supported")}},669:e=>{"use strict";function t(e,t){return e+n(t)}function n(e){let t=e;return t-=t>>1&1431655765,t=(858993459&t)+(t>>2&858993459),16843009*(t+(t>>4)&252645135)>>24}function r(e,t){return e[0]-t[0]}function i(e){return e[1]}e.exports=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let n=this._internalPositionFor(e,!1);if(void 0===t)-1!==n&&(this._unsetInternalPos(n),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let r=!1;-1===n?(n=this._data.length,this._setBit(e),this._changedData=!0):r=!0,this._setInternalPos(n,e,t,r),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();const t=this._internalPositionFor(e,!0);if(-1!==t)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){const e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,n=new Array(this.length);for(;t<this.length;)n[t]=e(this.get(t),t,this),t++;return n}reduce(e,t){let n=0,r=t;for(;n<this.length;)r=e(r,this.get(n),n),n++;return r}find(e){let t,n,r=0;for(;r<this.length&&!t;)n=this.get(r),t=e(n),r++;return t?n:void 0}_internalPositionFor(e,r){const i=this._bytePosFor(e,r);if(i>=this._bitArrays.length)return-1;const o=this._bitArrays[i],s=e-7*i;return(o&1<<s)>0?this._bitArrays.slice(0,i).reduce(t,0)+n(o&~(4294967295<<s+1))-1:-1}_bytePosFor(e,t){const n=Math.floor(e/7),r=n+1;for(;!t&&this._bitArrays.length<r;)this._bitArrays.push(0);return n}_setBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-7*t}_unsetBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-7*t)}_setInternalPos(e,t,n,r){const i=this._data,o=[t,n];if(r)this._sortData(),i[e]=o;else{if(i.length)if(i[i.length-1][0]>=t)i.push(o);else if(i[0][0]<=t)i.unshift(o);else{const e=Math.round(i.length/2);this._data=i.slice(0,e).concat(o).concat(i.slice(e))}else this._data.push(o);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(r),this._changedData=!1}bitField(){const e=[];let t,n=8,r=0,i=0;const o=this._bitArrays.slice();for(;o.length||r;){0===r&&(t=o.shift(),r=7);const s=Math.min(r,n);i|=(t&~(255<<s))<<8-n,t>>>=s,r-=s,n-=s,n&&(r||o.length)||(e.push(i),i=0,n=8)}for(var s=e.length-1;s>0&&0===e[s];s--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(i)}}},743:(e,t,n)=>{"use strict";var r=n(45),i=n(446);e.exports=r.bind(null,i)},797:e=>{e.exports=function e(r,i){var o,s=0,a=0,l=i=i||0,c=r.length;do{if(l>=c||a>49)throw e.bytes=0,new RangeError("Could not decode varint");o=r[l++],s+=a<28?(o&n)<<a:(o&n)*Math.pow(2,a),a+=7}while(o>=t);return e.bytes=l-i,s};var t=128,n=127},848:(e,t,n)=>{"use strict";e.exports=n(20)},864:function(e,t,n){"use strict";const r=n(368),{hasOwnProperty:i}=Object.prototype,{propertyIsEnumerable:o}=Object,s=(e,t,n)=>Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0}),a=this,l={concatArrays:!1,ignoreUndefined:!1},c=e=>{const t=[];for(const n in e)i.call(e,n)&&t.push(n);if(Object.getOwnPropertySymbols){const n=Object.getOwnPropertySymbols(e);for(const r of n)o.call(e,r)&&t.push(r)}return t};function u(e){return Array.isArray(e)?function(e){const t=e.slice(0,0);return c(e).forEach(n=>{s(t,n,u(e[n]))}),t}(e):r(e)?function(e){const t=null===Object.getPrototypeOf(e)?Object.create(null):{};return c(e).forEach(n=>{s(t,n,u(e[n]))}),t}(e):e}const d=(e,t,n,r)=>(n.forEach(n=>{void 0===t[n]&&r.ignoreUndefined||(n in e&&e[n]!==Object.getPrototypeOf(e)?s(e,n,f(e[n],t[n],r)):s(e,n,u(t[n])))}),e),h=(e,t,n)=>{let r=e.slice(0,0),o=0;return[e,t].forEach(t=>{const a=[];for(let n=0;n<t.length;n++)i.call(t,n)&&(a.push(String(n)),s(r,o++,t===e?t[n]:u(t[n])));r=d(r,t,c(t).filter(e=>!a.includes(e)),n)}),r};function f(e,t,n){return n.concatArrays&&Array.isArray(e)&&Array.isArray(t)?h(e,t,n):r(t)&&r(e)?d(e,t,c(t),n):u(t)}e.exports=function(...e){const t=f(u(l),this!==a&&this||{},l);let n={_:{}};for(const i of e)if(void 0!==i){if(!r(i))throw new TypeError("`"+i+"` is not an Option Object");n=f(n,{_:i},t)}return n._}},866:(e,t,n)=>{var r=n(606);e.exports=function(){return"undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type||!(void 0===r||"object"!=typeof r.versions||!r.versions.electron)||"object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron")>=0}},867:e=>{var t=Math.pow(2,7),n=Math.pow(2,14),r=Math.pow(2,21),i=Math.pow(2,28),o=Math.pow(2,35),s=Math.pow(2,42),a=Math.pow(2,49),l=Math.pow(2,56),c=Math.pow(2,63);e.exports=function(e){return e<t?1:e<n?2:e<r?3:e<i?4:e<o?5:e<s?6:e<a?7:e<l?8:e<c?9:10}},877:e=>{e.exports=function e(i,o,s){if(Number.MAX_SAFE_INTEGER&&i>Number.MAX_SAFE_INTEGER)throw e.bytes=0,new RangeError("Could not encode varint");o=o||[];for(var a=s=s||0;i>=r;)o[s++]=255&i|t,i/=128;for(;i&n;)o[s++]=255&i|t,i>>>=7;return o[s]=0|i,e.bytes=s-a+1,o};var t=128,n=-128,r=Math.pow(2,31)},932:(e,t,n)=>{"use strict";var r=n(540),i=n(982);function o(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var s=new Set,a={};function l(e,t){c(e,t),c(e+"Capture",t)}function c(e,t){for(a[e]=t,e=0;e<t.length;e++)s.add(t[e])}var u=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),d=Object.prototype.hasOwnProperty,h=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,f={},p={};function g(e,t,n,r,i,o,s){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=r,this.attributeNamespace=i,this.mustUseProperty=n,this.propertyName=e,this.type=t,this.sanitizeURL=o,this.removeEmptyString=s}var m={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(e){m[e]=new g(e,0,!1,e,null,!1,!1)}),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(e){var t=e[0];m[t]=new g(t,1,!1,e[1],null,!1,!1)}),["contentEditable","draggable","spellCheck","value"].forEach(function(e){m[e]=new g(e,2,!1,e.toLowerCase(),null,!1,!1)}),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(e){m[e]=new g(e,2,!1,e,null,!1,!1)}),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(e){m[e]=new g(e,3,!1,e.toLowerCase(),null,!1,!1)}),["checked","multiple","muted","selected"].forEach(function(e){m[e]=new g(e,3,!0,e,null,!1,!1)}),["capture","download"].forEach(function(e){m[e]=new g(e,4,!1,e,null,!1,!1)}),["cols","rows","size","span"].forEach(function(e){m[e]=new g(e,6,!1,e,null,!1,!1)}),["rowSpan","start"].forEach(function(e){m[e]=new g(e,5,!1,e.toLowerCase(),null,!1,!1)});var y=/[\-:]([a-z])/g;function w(e){return e[1].toUpperCase()}function b(e,t,n,r){var i=m.hasOwnProperty(t)?m[t]:null;(null!==i?0!==i.type:r||!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&(function(e,t,n,r){if(null==t||function(e,t,n,r){if(null!==n&&0===n.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!r&&(null!==n?!n.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,n,r))return!0;if(r)return!1;if(null!==n)switch(n.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,n,i,r)&&(n=null),r||null===i?function(e){return!!d.call(p,e)||!d.call(f,e)&&(h.test(e)?p[e]=!0:(f[e]=!0,!1))}(t)&&(null===n?e.removeAttribute(t):e.setAttribute(t,""+n)):i.mustUseProperty?e[i.propertyName]=null===n?3!==i.type&&"":n:(t=i.attributeName,r=i.attributeNamespace,null===n?e.removeAttribute(t):(n=3===(i=i.type)||4===i&&!0===n?"":""+n,r?e.setAttributeNS(r,t,n):e.setAttribute(t,n))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(e){var t=e.replace(y,w);m[t]=new g(t,1,!1,e,null,!1,!1)}),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(e){var t=e.replace(y,w);m[t]=new g(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)}),["xml:base","xml:lang","xml:space"].forEach(function(e){var t=e.replace(y,w);m[t]=new g(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)}),["tabIndex","crossOrigin"].forEach(function(e){m[e]=new g(e,1,!1,e.toLowerCase(),null,!1,!1)}),m.xlinkHref=new g("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach(function(e){m[e]=new g(e,1,!1,e.toLowerCase(),null,!0,!0)});var v=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,E=Symbol.for("react.element"),S=Symbol.for("react.portal"),k=Symbol.for("react.fragment"),_=Symbol.for("react.strict_mode"),R=Symbol.for("react.profiler"),I=Symbol.for("react.provider"),A=Symbol.for("react.context"),x=Symbol.for("react.forward_ref"),T=Symbol.for("react.suspense"),C=Symbol.for("react.suspense_list"),N=Symbol.for("react.memo"),D=Symbol.for("react.lazy");Symbol.for("react.scope"),Symbol.for("react.debug_trace_mode");var P=Symbol.for("react.offscreen");Symbol.for("react.legacy_hidden"),Symbol.for("react.cache"),Symbol.for("react.tracing_marker");var L=Symbol.iterator;function B(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=L&&e[L]||e["@@iterator"])?e:null}var O,M=Object.assign;function U(e){if(void 0===O)try{throw Error()}catch(e){var t=e.stack.trim().match(/\n( *(at )?)/);O=t&&t[1]||""}return"\n"+O+e}var F=!1;function z(e,t){if(!e||F)return"";F=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(e){var r=e}Reflect.construct(e,[],t)}else{try{t.call()}catch(e){r=e}e.call(t.prototype)}else{try{throw Error()}catch(e){r=e}e()}}catch(t){if(t&&r&&"string"==typeof t.stack){for(var i=t.stack.split("\n"),o=r.stack.split("\n"),s=i.length-1,a=o.length-1;1<=s&&0<=a&&i[s]!==o[a];)a--;for(;1<=s&&0<=a;s--,a--)if(i[s]!==o[a]){if(1!==s||1!==a)do{if(s--,0>--a||i[s]!==o[a]){var l="\n"+i[s].replace(" at new "," at ");return e.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",e.displayName)),l}}while(1<=s&&0<=a);break}}}finally{F=!1,Error.prepareStackTrace=n}return(e=e?e.displayName||e.name:"")?U(e):""}function V(e){switch(e.tag){case 5:return U(e.type);case 16:return U("Lazy");case 13:return U("Suspense");case 19:return U("SuspenseList");case 0:case 2:case 15:return z(e.type,!1);case 11:return z(e.type.render,!1);case 1:return z(e.type,!0);default:return""}}function $(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case k:return"Fragment";case S:return"Portal";case R:return"Profiler";case _:return"StrictMode";case T:return"Suspense";case C:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case A:return(e.displayName||"Context")+".Consumer";case I:return(e._context.displayName||"Context")+".Provider";case x:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case N:return null!==(t=e.displayName||null)?t:$(e.type)||"Memo";case D:t=e._payload,e=e._init;try{return $(e(t))}catch(e){}}return null}function H(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return $(t);case 8:return t===_?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof t)return t.displayName||t.name||null;if("string"==typeof t)return t}return null}function K(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function q(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function j(e){e._valueTracker||(e._valueTracker=function(e){var t=q(e)?"checked":"value",n=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),r=""+e[t];if(!e.hasOwnProperty(t)&&void 0!==n&&"function"==typeof n.get&&"function"==typeof n.set){var i=n.get,o=n.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return i.call(this)},set:function(e){r=""+e,o.call(this,e)}}),Object.defineProperty(e,t,{enumerable:n.enumerable}),{getValue:function(){return r},setValue:function(e){r=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function W(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var n=t.getValue(),r="";return e&&(r=q(e)?e.checked?"true":"false":e.value),(e=r)!==n&&(t.setValue(e),!0)}function G(e){if(void 0===(e=e||("undefined"!=typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function Y(e,t){var n=t.checked;return M({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=n?n:e._wrapperState.initialChecked})}function Q(e,t){var n=null==t.defaultValue?"":t.defaultValue,r=null!=t.checked?t.checked:t.defaultChecked;n=K(null!=t.value?t.value:n),e._wrapperState={initialChecked:r,initialValue:n,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function X(e,t){null!=(t=t.checked)&&b(e,"checked",t,!1)}function Z(e,t){X(e,t);var n=K(t.value),r=t.type;if(null!=n)"number"===r?(0===n&&""===e.value||e.value!=n)&&(e.value=""+n):e.value!==""+n&&(e.value=""+n);else if("submit"===r||"reset"===r)return void e.removeAttribute("value");t.hasOwnProperty("value")?ee(e,t.type,n):t.hasOwnProperty("defaultValue")&&ee(e,t.type,K(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function J(e,t,n){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var r=t.type;if(!("submit"!==r&&"reset"!==r||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,n||t===e.value||(e.value=t),e.defaultValue=t}""!==(n=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==n&&(e.name=n)}function ee(e,t,n){"number"===t&&G(e.ownerDocument)===e||(null==n?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+n&&(e.defaultValue=""+n))}var te=Array.isArray;function ne(e,t,n,r){if(e=e.options,t){t={};for(var i=0;i<n.length;i++)t["$"+n[i]]=!0;for(n=0;n<e.length;n++)i=t.hasOwnProperty("$"+e[n].value),e[n].selected!==i&&(e[n].selected=i),i&&r&&(e[n].defaultSelected=!0)}else{for(n=""+K(n),t=null,i=0;i<e.length;i++){if(e[i].value===n)return e[i].selected=!0,void(r&&(e[i].defaultSelected=!0));null!==t||e[i].disabled||(t=e[i])}null!==t&&(t.selected=!0)}}function re(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(o(91));return M({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function ie(e,t){var n=t.value;if(null==n){if(n=t.children,t=t.defaultValue,null!=n){if(null!=t)throw Error(o(92));if(te(n)){if(1<n.length)throw Error(o(93));n=n[0]}t=n}null==t&&(t=""),n=t}e._wrapperState={initialValue:K(n)}}function oe(e,t){var n=K(t.value),r=K(t.defaultValue);null!=n&&((n=""+n)!==e.value&&(e.value=n),null==t.defaultValue&&e.defaultValue!==n&&(e.defaultValue=n)),null!=r&&(e.defaultValue=""+r)}function se(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}function ae(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function le(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?ae(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var ce,ue,de=(ue=function(e,t){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=t;else{for((ce=ce||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=ce.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,n,r){MSApp.execUnsafeLocalFunction(function(){return ue(e,t)})}:ue);function he(e,t){if(t){var n=e.firstChild;if(n&&n===e.lastChild&&3===n.nodeType)return void(n.nodeValue=t)}e.textContent=t}var fe={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},pe=["Webkit","ms","Moz","O"];function ge(e,t,n){return null==t||"boolean"==typeof t||""===t?"":n||"number"!=typeof t||0===t||fe.hasOwnProperty(e)&&fe[e]?(""+t).trim():t+"px"}function me(e,t){for(var n in e=e.style,t)if(t.hasOwnProperty(n)){var r=0===n.indexOf("--"),i=ge(n,t[n],r);"float"===n&&(n="cssFloat"),r?e.setProperty(n,i):e[n]=i}}Object.keys(fe).forEach(function(e){pe.forEach(function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),fe[t]=fe[e]})});var ye=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function we(e,t){if(t){if(ye[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(o(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(o(60));if("object"!=typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(o(61))}if(null!=t.style&&"object"!=typeof t.style)throw Error(o(62))}}function be(e,t){if(-1===e.indexOf("-"))return"string"==typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var ve=null;function Ee(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var Se=null,ke=null,_e=null;function Re(e){if(e=bi(e)){if("function"!=typeof Se)throw Error(o(280));var t=e.stateNode;t&&(t=Ei(t),Se(e.stateNode,e.type,t))}}function Ie(e){ke?_e?_e.push(e):_e=[e]:ke=e}function Ae(){if(ke){var e=ke,t=_e;if(_e=ke=null,Re(e),t)for(e=0;e<t.length;e++)Re(t[e])}}function xe(e,t){return e(t)}function Te(){}var Ce=!1;function Ne(e,t,n){if(Ce)return e(t,n);Ce=!0;try{return xe(e,t,n)}finally{Ce=!1,(null!==ke||null!==_e)&&(Te(),Ae())}}function De(e,t){var n=e.stateNode;if(null===n)return null;var r=Ei(n);if(null===r)return null;n=r[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(r=!r.disabled)||(r=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!r;break e;default:e=!1}if(e)return null;if(n&&"function"!=typeof n)throw Error(o(231,t,typeof n));return n}var Pe=!1;if(u)try{var Le={};Object.defineProperty(Le,"passive",{get:function(){Pe=!0}}),window.addEventListener("test",Le,Le),window.removeEventListener("test",Le,Le)}catch(ue){Pe=!1}function Be(e,t,n,r,i,o,s,a,l){var c=Array.prototype.slice.call(arguments,3);try{t.apply(n,c)}catch(e){this.onError(e)}}var Oe=!1,Me=null,Ue=!1,Fe=null,ze={onError:function(e){Oe=!0,Me=e}};function Ve(e,t,n,r,i,o,s,a,l){Oe=!1,Me=null,Be.apply(ze,arguments)}function $e(e){var t=e,n=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{!!(4098&(t=e).flags)&&(n=t.return),e=t.return}while(e)}return 3===t.tag?n:null}function He(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&null!==(e=e.alternate)&&(t=e.memoizedState),null!==t)return t.dehydrated}return null}function Ke(e){if($e(e)!==e)throw Error(o(188))}function qe(e){return null!==(e=function(e){var t=e.alternate;if(!t){if(null===(t=$e(e)))throw Error(o(188));return t!==e?null:e}for(var n=e,r=t;;){var i=n.return;if(null===i)break;var s=i.alternate;if(null===s){if(null!==(r=i.return)){n=r;continue}break}if(i.child===s.child){for(s=i.child;s;){if(s===n)return Ke(i),e;if(s===r)return Ke(i),t;s=s.sibling}throw Error(o(188))}if(n.return!==r.return)n=i,r=s;else{for(var a=!1,l=i.child;l;){if(l===n){a=!0,n=i,r=s;break}if(l===r){a=!0,r=i,n=s;break}l=l.sibling}if(!a){for(l=s.child;l;){if(l===n){a=!0,n=s,r=i;break}if(l===r){a=!0,r=s,n=i;break}l=l.sibling}if(!a)throw Error(o(189))}}if(n.alternate!==r)throw Error(o(190))}if(3!==n.tag)throw Error(o(188));return n.stateNode.current===n?e:t}(e))?je(e):null}function je(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=je(e);if(null!==t)return t;e=e.sibling}return null}var We=i.unstable_scheduleCallback,Ge=i.unstable_cancelCallback,Ye=i.unstable_shouldYield,Qe=i.unstable_requestPaint,Xe=i.unstable_now,Ze=i.unstable_getCurrentPriorityLevel,Je=i.unstable_ImmediatePriority,et=i.unstable_UserBlockingPriority,tt=i.unstable_NormalPriority,nt=i.unstable_LowPriority,rt=i.unstable_IdlePriority,it=null,ot=null,st=Math.clz32?Math.clz32:function(e){return 0===(e>>>=0)?32:31-(at(e)/lt|0)|0},at=Math.log,lt=Math.LN2,ct=64,ut=4194304;function dt(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function ht(e,t){var n=e.pendingLanes;if(0===n)return 0;var r=0,i=e.suspendedLanes,o=e.pingedLanes,s=268435455&n;if(0!==s){var a=s&~i;0!==a?r=dt(a):0!==(o&=s)&&(r=dt(o))}else 0!==(s=n&~i)?r=dt(s):0!==o&&(r=dt(o));if(0===r)return 0;if(0!==t&&t!==r&&0===(t&i)&&((i=r&-r)>=(o=t&-t)||16===i&&4194240&o))return t;if(4&r&&(r|=16&n),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=r;0<t;)i=1<<(n=31-st(t)),r|=e[n],t&=~i;return r}function ft(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function pt(e){return 0!=(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function gt(){var e=ct;return!(4194240&(ct<<=1))&&(ct=64),e}function mt(e){for(var t=[],n=0;31>n;n++)t.push(e);return t}function yt(e,t,n){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-st(t)]=n}function wt(e,t){var n=e.entangledLanes|=t;for(e=e.entanglements;n;){var r=31-st(n),i=1<<r;i&t|e[r]&t&&(e[r]|=t),n&=~i}}var bt=0;function vt(e){return 1<(e&=-e)?4<e?268435455&e?16:536870912:4:1}var Et,St,kt,_t,Rt,It=!1,At=[],xt=null,Tt=null,Ct=null,Nt=new Map,Dt=new Map,Pt=[],Lt="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Bt(e,t){switch(e){case"focusin":case"focusout":xt=null;break;case"dragenter":case"dragleave":Tt=null;break;case"mouseover":case"mouseout":Ct=null;break;case"pointerover":case"pointerout":Nt.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":Dt.delete(t.pointerId)}}function Ot(e,t,n,r,i,o){return null===e||e.nativeEvent!==o?(e={blockedOn:t,domEventName:n,eventSystemFlags:r,nativeEvent:o,targetContainers:[i]},null!==t&&null!==(t=bi(t))&&St(t),e):(e.eventSystemFlags|=r,t=e.targetContainers,null!==i&&-1===t.indexOf(i)&&t.push(i),e)}function Mt(e){var t=wi(e.target);if(null!==t){var n=$e(t);if(null!==n)if(13===(t=n.tag)){if(null!==(t=He(n)))return e.blockedOn=t,void Rt(e.priority,function(){kt(n)})}else if(3===t&&n.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===n.tag?n.stateNode.containerInfo:null)}e.blockedOn=null}function Ut(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var n=Yt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==n)return null!==(t=bi(n))&&St(t),e.blockedOn=n,!1;var r=new(n=e.nativeEvent).constructor(n.type,n);ve=r,n.target.dispatchEvent(r),ve=null,t.shift()}return!0}function Ft(e,t,n){Ut(e)&&n.delete(t)}function zt(){It=!1,null!==xt&&Ut(xt)&&(xt=null),null!==Tt&&Ut(Tt)&&(Tt=null),null!==Ct&&Ut(Ct)&&(Ct=null),Nt.forEach(Ft),Dt.forEach(Ft)}function Vt(e,t){e.blockedOn===t&&(e.blockedOn=null,It||(It=!0,i.unstable_scheduleCallback(i.unstable_NormalPriority,zt)))}function $t(e){function t(t){return Vt(t,e)}if(0<At.length){Vt(At[0],e);for(var n=1;n<At.length;n++){var r=At[n];r.blockedOn===e&&(r.blockedOn=null)}}for(null!==xt&&Vt(xt,e),null!==Tt&&Vt(Tt,e),null!==Ct&&Vt(Ct,e),Nt.forEach(t),Dt.forEach(t),n=0;n<Pt.length;n++)(r=Pt[n]).blockedOn===e&&(r.blockedOn=null);for(;0<Pt.length&&null===(n=Pt[0]).blockedOn;)Mt(n),null===n.blockedOn&&Pt.shift()}var Ht=v.ReactCurrentBatchConfig,Kt=!0;function qt(e,t,n,r){var i=bt,o=Ht.transition;Ht.transition=null;try{bt=1,Wt(e,t,n,r)}finally{bt=i,Ht.transition=o}}function jt(e,t,n,r){var i=bt,o=Ht.transition;Ht.transition=null;try{bt=4,Wt(e,t,n,r)}finally{bt=i,Ht.transition=o}}function Wt(e,t,n,r){if(Kt){var i=Yt(e,t,n,r);if(null===i)Kr(e,t,r,Gt,n),Bt(e,r);else if(function(e,t,n,r,i){switch(t){case"focusin":return xt=Ot(xt,e,t,n,r,i),!0;case"dragenter":return Tt=Ot(Tt,e,t,n,r,i),!0;case"mouseover":return Ct=Ot(Ct,e,t,n,r,i),!0;case"pointerover":var o=i.pointerId;return Nt.set(o,Ot(Nt.get(o)||null,e,t,n,r,i)),!0;case"gotpointercapture":return o=i.pointerId,Dt.set(o,Ot(Dt.get(o)||null,e,t,n,r,i)),!0}return!1}(i,e,t,n,r))r.stopPropagation();else if(Bt(e,r),4&t&&-1<Lt.indexOf(e)){for(;null!==i;){var o=bi(i);if(null!==o&&Et(o),null===(o=Yt(e,t,n,r))&&Kr(e,t,r,Gt,n),o===i)break;i=o}null!==i&&r.stopPropagation()}else Kr(e,t,r,null,n)}}var Gt=null;function Yt(e,t,n,r){if(Gt=null,null!==(e=wi(e=Ee(r))))if(null===(t=$e(e)))e=null;else if(13===(n=t.tag)){if(null!==(e=He(t)))return e;e=null}else if(3===n){if(t.stateNode.current.memoizedState.isDehydrated)return 3===t.tag?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return Gt=e,null}function Qt(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Ze()){case Je:return 1;case et:return 4;case tt:case nt:return 16;case rt:return 536870912;default:return 16}default:return 16}}var Xt=null,Zt=null,Jt=null;function en(){if(Jt)return Jt;var e,t,n=Zt,r=n.length,i="value"in Xt?Xt.value:Xt.textContent,o=i.length;for(e=0;e<r&&n[e]===i[e];e++);var s=r-e;for(t=1;t<=s&&n[r-t]===i[o-t];t++);return Jt=i.slice(e,1<t?1-t:void 0)}function tn(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function nn(){return!0}function rn(){return!1}function on(e){function t(t,n,r,i,o){for(var s in this._reactName=t,this._targetInst=r,this.type=n,this.nativeEvent=i,this.target=o,this.currentTarget=null,e)e.hasOwnProperty(s)&&(t=e[s],this[s]=t?t(i):i[s]);return this.isDefaultPrevented=(null!=i.defaultPrevented?i.defaultPrevented:!1===i.returnValue)?nn:rn,this.isPropagationStopped=rn,this}return M(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!=typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=nn)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!=typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=nn)},persist:function(){},isPersistent:nn}),t}var sn,an,ln,cn={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},un=on(cn),dn=M({},cn,{view:0,detail:0}),hn=on(dn),fn=M({},dn,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Rn,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==ln&&(ln&&"mousemove"===e.type?(sn=e.screenX-ln.screenX,an=e.screenY-ln.screenY):an=sn=0,ln=e),sn)},movementY:function(e){return"movementY"in e?e.movementY:an}}),pn=on(fn),gn=on(M({},fn,{dataTransfer:0})),mn=on(M({},dn,{relatedTarget:0})),yn=on(M({},cn,{animationName:0,elapsedTime:0,pseudoElement:0})),wn=M({},cn,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),bn=on(wn),vn=on(M({},cn,{data:0})),En={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Sn={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},kn={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function _n(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=kn[e])&&!!t[e]}function Rn(){return _n}var In=M({},dn,{key:function(e){if(e.key){var t=En[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=tn(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?Sn[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Rn,charCode:function(e){return"keypress"===e.type?tn(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?tn(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),An=on(In),xn=on(M({},fn,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),Tn=on(M({},dn,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Rn})),Cn=on(M({},cn,{propertyName:0,elapsedTime:0,pseudoElement:0})),Nn=M({},fn,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),Dn=on(Nn),Pn=[9,13,27,32],Ln=u&&"CompositionEvent"in window,Bn=null;u&&"documentMode"in document&&(Bn=document.documentMode);var On=u&&"TextEvent"in window&&!Bn,Mn=u&&(!Ln||Bn&&8<Bn&&11>=Bn),Un=String.fromCharCode(32),Fn=!1;function zn(e,t){switch(e){case"keyup":return-1!==Pn.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Vn(e){return"object"==typeof(e=e.detail)&&"data"in e?e.data:null}var $n=!1,Hn={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Kn(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Hn[e.type]:"textarea"===t}function qn(e,t,n,r){Ie(r),0<(t=jr(t,"onChange")).length&&(n=new un("onChange","change",null,n,r),e.push({event:n,listeners:t}))}var jn=null,Wn=null;function Gn(e){Ur(e,0)}function Yn(e){if(W(vi(e)))return e}function Qn(e,t){if("change"===e)return t}var Xn=!1;if(u){var Zn;if(u){var Jn="oninput"in document;if(!Jn){var er=document.createElement("div");er.setAttribute("oninput","return;"),Jn="function"==typeof er.oninput}Zn=Jn}else Zn=!1;Xn=Zn&&(!document.documentMode||9<document.documentMode)}function tr(){jn&&(jn.detachEvent("onpropertychange",nr),Wn=jn=null)}function nr(e){if("value"===e.propertyName&&Yn(Wn)){var t=[];qn(t,Wn,e,Ee(e)),Ne(Gn,t)}}function rr(e,t,n){"focusin"===e?(tr(),Wn=n,(jn=t).attachEvent("onpropertychange",nr)):"focusout"===e&&tr()}function ir(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return Yn(Wn)}function or(e,t){if("click"===e)return Yn(t)}function sr(e,t){if("input"===e||"change"===e)return Yn(t)}var ar="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t};function lr(e,t){if(ar(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(r=0;r<n.length;r++){var i=n[r];if(!d.call(t,i)||!ar(e[i],t[i]))return!1}return!0}function cr(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function ur(e,t){var n,r=cr(e);for(e=0;r;){if(3===r.nodeType){if(n=e+r.textContent.length,e<=t&&n>=t)return{node:r,offset:t-e};e=n}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=cr(r)}}function dr(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?dr(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function hr(){for(var e=window,t=G();t instanceof e.HTMLIFrameElement;){try{var n="string"==typeof t.contentWindow.location.href}catch(e){n=!1}if(!n)break;t=G((e=t.contentWindow).document)}return t}function fr(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}function pr(e){var t=hr(),n=e.focusedElem,r=e.selectionRange;if(t!==n&&n&&n.ownerDocument&&dr(n.ownerDocument.documentElement,n)){if(null!==r&&fr(n))if(t=r.start,void 0===(e=r.end)&&(e=t),"selectionStart"in n)n.selectionStart=t,n.selectionEnd=Math.min(e,n.value.length);else if((e=(t=n.ownerDocument||document)&&t.defaultView||window).getSelection){e=e.getSelection();var i=n.textContent.length,o=Math.min(r.start,i);r=void 0===r.end?o:Math.min(r.end,i),!e.extend&&o>r&&(i=r,r=o,o=i),i=ur(n,o);var s=ur(n,r);i&&s&&(1!==e.rangeCount||e.anchorNode!==i.node||e.anchorOffset!==i.offset||e.focusNode!==s.node||e.focusOffset!==s.offset)&&((t=t.createRange()).setStart(i.node,i.offset),e.removeAllRanges(),o>r?(e.addRange(t),e.extend(s.node,s.offset)):(t.setEnd(s.node,s.offset),e.addRange(t)))}for(t=[],e=n;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"==typeof n.focus&&n.focus(),n=0;n<t.length;n++)(e=t[n]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var gr=u&&"documentMode"in document&&11>=document.documentMode,mr=null,yr=null,wr=null,br=!1;function vr(e,t,n){var r=n.window===n?n.document:9===n.nodeType?n:n.ownerDocument;br||null==mr||mr!==G(r)||(r="selectionStart"in(r=mr)&&fr(r)?{start:r.selectionStart,end:r.selectionEnd}:{anchorNode:(r=(r.ownerDocument&&r.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:r.anchorOffset,focusNode:r.focusNode,focusOffset:r.focusOffset},wr&&lr(wr,r)||(wr=r,0<(r=jr(yr,"onSelect")).length&&(t=new un("onSelect","select",null,t,n),e.push({event:t,listeners:r}),t.target=mr)))}function Er(e,t){var n={};return n[e.toLowerCase()]=t.toLowerCase(),n["Webkit"+e]="webkit"+t,n["Moz"+e]="moz"+t,n}var Sr={animationend:Er("Animation","AnimationEnd"),animationiteration:Er("Animation","AnimationIteration"),animationstart:Er("Animation","AnimationStart"),transitionend:Er("Transition","TransitionEnd")},kr={},_r={};function Rr(e){if(kr[e])return kr[e];if(!Sr[e])return e;var t,n=Sr[e];for(t in n)if(n.hasOwnProperty(t)&&t in _r)return kr[e]=n[t];return e}u&&(_r=document.createElement("div").style,"AnimationEvent"in window||(delete Sr.animationend.animation,delete Sr.animationiteration.animation,delete Sr.animationstart.animation),"TransitionEvent"in window||delete Sr.transitionend.transition);var Ir=Rr("animationend"),Ar=Rr("animationiteration"),xr=Rr("animationstart"),Tr=Rr("transitionend"),Cr=new Map,Nr="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Dr(e,t){Cr.set(e,t),l(t,[e])}for(var Pr=0;Pr<Nr.length;Pr++){var Lr=Nr[Pr];Dr(Lr.toLowerCase(),"on"+(Lr[0].toUpperCase()+Lr.slice(1)))}Dr(Ir,"onAnimationEnd"),Dr(Ar,"onAnimationIteration"),Dr(xr,"onAnimationStart"),Dr("dblclick","onDoubleClick"),Dr("focusin","onFocus"),Dr("focusout","onBlur"),Dr(Tr,"onTransitionEnd"),c("onMouseEnter",["mouseout","mouseover"]),c("onMouseLeave",["mouseout","mouseover"]),c("onPointerEnter",["pointerout","pointerover"]),c("onPointerLeave",["pointerout","pointerover"]),l("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),l("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),l("onBeforeInput",["compositionend","keypress","textInput","paste"]),l("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),l("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),l("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Br="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Or=new Set("cancel close invalid load scroll toggle".split(" ").concat(Br));function Mr(e,t,n){var r=e.type||"unknown-event";e.currentTarget=n,function(e,t,n,r,i,s,a,l,c){if(Ve.apply(this,arguments),Oe){if(!Oe)throw Error(o(198));var u=Me;Oe=!1,Me=null,Ue||(Ue=!0,Fe=u)}}(r,t,void 0,e),e.currentTarget=null}function Ur(e,t){t=!!(4&t);for(var n=0;n<e.length;n++){var r=e[n],i=r.event;r=r.listeners;e:{var o=void 0;if(t)for(var s=r.length-1;0<=s;s--){var a=r[s],l=a.instance,c=a.currentTarget;if(a=a.listener,l!==o&&i.isPropagationStopped())break e;Mr(i,a,c),o=l}else for(s=0;s<r.length;s++){if(l=(a=r[s]).instance,c=a.currentTarget,a=a.listener,l!==o&&i.isPropagationStopped())break e;Mr(i,a,c),o=l}}}if(Ue)throw e=Fe,Ue=!1,Fe=null,e}function Fr(e,t){var n=t[gi];void 0===n&&(n=t[gi]=new Set);var r=e+"__bubble";n.has(r)||(Hr(t,e,2,!1),n.add(r))}function zr(e,t,n){var r=0;t&&(r|=4),Hr(n,e,r,t)}var Vr="_reactListening"+Math.random().toString(36).slice(2);function $r(e){if(!e[Vr]){e[Vr]=!0,s.forEach(function(t){"selectionchange"!==t&&(Or.has(t)||zr(t,!1,e),zr(t,!0,e))});var t=9===e.nodeType?e:e.ownerDocument;null===t||t[Vr]||(t[Vr]=!0,zr("selectionchange",!1,t))}}function Hr(e,t,n,r){switch(Qt(t)){case 1:var i=qt;break;case 4:i=jt;break;default:i=Wt}n=i.bind(null,t,n,e),i=void 0,!Pe||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(i=!0),r?void 0!==i?e.addEventListener(t,n,{capture:!0,passive:i}):e.addEventListener(t,n,!0):void 0!==i?e.addEventListener(t,n,{passive:i}):e.addEventListener(t,n,!1)}function Kr(e,t,n,r,i){var o=r;if(!(1&t||2&t||null===r))e:for(;;){if(null===r)return;var s=r.tag;if(3===s||4===s){var a=r.stateNode.containerInfo;if(a===i||8===a.nodeType&&a.parentNode===i)break;if(4===s)for(s=r.return;null!==s;){var l=s.tag;if((3===l||4===l)&&((l=s.stateNode.containerInfo)===i||8===l.nodeType&&l.parentNode===i))return;s=s.return}for(;null!==a;){if(null===(s=wi(a)))return;if(5===(l=s.tag)||6===l){r=o=s;continue e}a=a.parentNode}}r=r.return}Ne(function(){var r=o,i=Ee(n),s=[];e:{var a=Cr.get(e);if(void 0!==a){var l=un,c=e;switch(e){case"keypress":if(0===tn(n))break e;case"keydown":case"keyup":l=An;break;case"focusin":c="focus",l=mn;break;case"focusout":c="blur",l=mn;break;case"beforeblur":case"afterblur":l=mn;break;case"click":if(2===n.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":l=pn;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":l=gn;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":l=Tn;break;case Ir:case Ar:case xr:l=yn;break;case Tr:l=Cn;break;case"scroll":l=hn;break;case"wheel":l=Dn;break;case"copy":case"cut":case"paste":l=bn;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":l=xn}var u=!!(4&t),d=!u&&"scroll"===e,h=u?null!==a?a+"Capture":null:a;u=[];for(var f,p=r;null!==p;){var g=(f=p).stateNode;if(5===f.tag&&null!==g&&(f=g,null!==h&&null!=(g=De(p,h))&&u.push(qr(p,g,f))),d)break;p=p.return}0<u.length&&(a=new l(a,c,null,n,i),s.push({event:a,listeners:u}))}}if(!(7&t)){if(l="mouseout"===e||"pointerout"===e,(!(a="mouseover"===e||"pointerover"===e)||n===ve||!(c=n.relatedTarget||n.fromElement)||!wi(c)&&!c[pi])&&(l||a)&&(a=i.window===i?i:(a=i.ownerDocument)?a.defaultView||a.parentWindow:window,l?(l=r,null!==(c=(c=n.relatedTarget||n.toElement)?wi(c):null)&&(c!==(d=$e(c))||5!==c.tag&&6!==c.tag)&&(c=null)):(l=null,c=r),l!==c)){if(u=pn,g="onMouseLeave",h="onMouseEnter",p="mouse","pointerout"!==e&&"pointerover"!==e||(u=xn,g="onPointerLeave",h="onPointerEnter",p="pointer"),d=null==l?a:vi(l),f=null==c?a:vi(c),(a=new u(g,p+"leave",l,n,i)).target=d,a.relatedTarget=f,g=null,wi(i)===r&&((u=new u(h,p+"enter",c,n,i)).target=f,u.relatedTarget=d,g=u),d=g,l&&c)e:{for(h=c,p=0,f=u=l;f;f=Wr(f))p++;for(f=0,g=h;g;g=Wr(g))f++;for(;0<p-f;)u=Wr(u),p--;for(;0<f-p;)h=Wr(h),f--;for(;p--;){if(u===h||null!==h&&u===h.alternate)break e;u=Wr(u),h=Wr(h)}u=null}else u=null;null!==l&&Gr(s,a,l,u,!1),null!==c&&null!==d&&Gr(s,d,c,u,!0)}if("select"===(l=(a=r?vi(r):window).nodeName&&a.nodeName.toLowerCase())||"input"===l&&"file"===a.type)var m=Qn;else if(Kn(a))if(Xn)m=sr;else{m=ir;var y=rr}else(l=a.nodeName)&&"input"===l.toLowerCase()&&("checkbox"===a.type||"radio"===a.type)&&(m=or);switch(m&&(m=m(e,r))?qn(s,m,n,i):(y&&y(e,a,r),"focusout"===e&&(y=a._wrapperState)&&y.controlled&&"number"===a.type&&ee(a,"number",a.value)),y=r?vi(r):window,e){case"focusin":(Kn(y)||"true"===y.contentEditable)&&(mr=y,yr=r,wr=null);break;case"focusout":wr=yr=mr=null;break;case"mousedown":br=!0;break;case"contextmenu":case"mouseup":case"dragend":br=!1,vr(s,n,i);break;case"selectionchange":if(gr)break;case"keydown":case"keyup":vr(s,n,i)}var w;if(Ln)e:{switch(e){case"compositionstart":var b="onCompositionStart";break e;case"compositionend":b="onCompositionEnd";break e;case"compositionupdate":b="onCompositionUpdate";break e}b=void 0}else $n?zn(e,n)&&(b="onCompositionEnd"):"keydown"===e&&229===n.keyCode&&(b="onCompositionStart");b&&(Mn&&"ko"!==n.locale&&($n||"onCompositionStart"!==b?"onCompositionEnd"===b&&$n&&(w=en()):(Zt="value"in(Xt=i)?Xt.value:Xt.textContent,$n=!0)),0<(y=jr(r,b)).length&&(b=new vn(b,e,null,n,i),s.push({event:b,listeners:y}),(w||null!==(w=Vn(n)))&&(b.data=w))),(w=On?function(e,t){switch(e){case"compositionend":return Vn(t);case"keypress":return 32!==t.which?null:(Fn=!0,Un);case"textInput":return(e=t.data)===Un&&Fn?null:e;default:return null}}(e,n):function(e,t){if($n)return"compositionend"===e||!Ln&&zn(e,t)?(e=en(),Jt=Zt=Xt=null,$n=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return Mn&&"ko"!==t.locale?null:t.data}}(e,n))&&0<(r=jr(r,"onBeforeInput")).length&&(i=new vn("onBeforeInput","beforeinput",null,n,i),s.push({event:i,listeners:r}),i.data=w)}Ur(s,t)})}function qr(e,t,n){return{instance:e,listener:t,currentTarget:n}}function jr(e,t){for(var n=t+"Capture",r=[];null!==e;){var i=e,o=i.stateNode;5===i.tag&&null!==o&&(i=o,null!=(o=De(e,n))&&r.unshift(qr(e,o,i)),null!=(o=De(e,t))&&r.push(qr(e,o,i))),e=e.return}return r}function Wr(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function Gr(e,t,n,r,i){for(var o=t._reactName,s=[];null!==n&&n!==r;){var a=n,l=a.alternate,c=a.stateNode;if(null!==l&&l===r)break;5===a.tag&&null!==c&&(a=c,i?null!=(l=De(n,o))&&s.unshift(qr(n,l,a)):i||null!=(l=De(n,o))&&s.push(qr(n,l,a))),n=n.return}0!==s.length&&e.push({event:t,listeners:s})}var Yr=/\r\n?/g,Qr=/\u0000|\uFFFD/g;function Xr(e){return("string"==typeof e?e:""+e).replace(Yr,"\n").replace(Qr,"")}function Zr(e,t,n){if(t=Xr(t),Xr(e)!==t&&n)throw Error(o(425))}function Jr(){}var ei=null,ti=null;function ni(e,t){return"textarea"===e||"noscript"===e||"string"==typeof t.children||"number"==typeof t.children||"object"==typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var ri="function"==typeof setTimeout?setTimeout:void 0,ii="function"==typeof clearTimeout?clearTimeout:void 0,oi="function"==typeof Promise?Promise:void 0,si="function"==typeof queueMicrotask?queueMicrotask:void 0!==oi?function(e){return oi.resolve(null).then(e).catch(ai)}:ri;function ai(e){setTimeout(function(){throw e})}function li(e,t){var n=t,r=0;do{var i=n.nextSibling;if(e.removeChild(n),i&&8===i.nodeType)if("/$"===(n=i.data)){if(0===r)return e.removeChild(i),void $t(t);r--}else"$"!==n&&"$?"!==n&&"$!"!==n||r++;n=i}while(n);$t(t)}function ci(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break;if(8===t){if("$"===(t=e.data)||"$!"===t||"$?"===t)break;if("/$"===t)return null}}return e}function ui(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var n=e.data;if("$"===n||"$!"===n||"$?"===n){if(0===t)return e;t--}else"/$"===n&&t++}e=e.previousSibling}return null}var di=Math.random().toString(36).slice(2),hi="__reactFiber$"+di,fi="__reactProps$"+di,pi="__reactContainer$"+di,gi="__reactEvents$"+di,mi="__reactListeners$"+di,yi="__reactHandles$"+di;function wi(e){var t=e[hi];if(t)return t;for(var n=e.parentNode;n;){if(t=n[pi]||n[hi]){if(n=t.alternate,null!==t.child||null!==n&&null!==n.child)for(e=ui(e);null!==e;){if(n=e[hi])return n;e=ui(e)}return t}n=(e=n).parentNode}return null}function bi(e){return!(e=e[hi]||e[pi])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function vi(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(o(33))}function Ei(e){return e[fi]||null}var Si=[],ki=-1;function _i(e){return{current:e}}function Ri(e){0>ki||(e.current=Si[ki],Si[ki]=null,ki--)}function Ii(e,t){ki++,Si[ki]=e.current,e.current=t}var Ai={},xi=_i(Ai),Ti=_i(!1),Ci=Ai;function Ni(e,t){var n=e.type.contextTypes;if(!n)return Ai;var r=e.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===t)return r.__reactInternalMemoizedMaskedChildContext;var i,o={};for(i in n)o[i]=t[i];return r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=o),o}function Di(e){return null!=e.childContextTypes}function Pi(){Ri(Ti),Ri(xi)}function Li(e,t,n){if(xi.current!==Ai)throw Error(o(168));Ii(xi,t),Ii(Ti,n)}function Bi(e,t,n){var r=e.stateNode;if(t=t.childContextTypes,"function"!=typeof r.getChildContext)return n;for(var i in r=r.getChildContext())if(!(i in t))throw Error(o(108,H(e)||"Unknown",i));return M({},n,r)}function Oi(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||Ai,Ci=xi.current,Ii(xi,e),Ii(Ti,Ti.current),!0}function Mi(e,t,n){var r=e.stateNode;if(!r)throw Error(o(169));n?(e=Bi(e,t,Ci),r.__reactInternalMemoizedMergedChildContext=e,Ri(Ti),Ri(xi),Ii(xi,e)):Ri(Ti),Ii(Ti,n)}var Ui=null,Fi=!1,zi=!1;function Vi(e){null===Ui?Ui=[e]:Ui.push(e)}function $i(){if(!zi&&null!==Ui){zi=!0;var e=0,t=bt;try{var n=Ui;for(bt=1;e<n.length;e++){var r=n[e];do{r=r(!0)}while(null!==r)}Ui=null,Fi=!1}catch(t){throw null!==Ui&&(Ui=Ui.slice(e+1)),We(Je,$i),t}finally{bt=t,zi=!1}}return null}var Hi=[],Ki=0,qi=null,ji=0,Wi=[],Gi=0,Yi=null,Qi=1,Xi="";function Zi(e,t){Hi[Ki++]=ji,Hi[Ki++]=qi,qi=e,ji=t}function Ji(e,t,n){Wi[Gi++]=Qi,Wi[Gi++]=Xi,Wi[Gi++]=Yi,Yi=e;var r=Qi;e=Xi;var i=32-st(r)-1;r&=~(1<<i),n+=1;var o=32-st(t)+i;if(30<o){var s=i-i%5;o=(r&(1<<s)-1).toString(32),r>>=s,i-=s,Qi=1<<32-st(t)+i|n<<i|r,Xi=o+e}else Qi=1<<o|n<<i|r,Xi=e}function eo(e){null!==e.return&&(Zi(e,1),Ji(e,1,0))}function to(e){for(;e===qi;)qi=Hi[--Ki],Hi[Ki]=null,ji=Hi[--Ki],Hi[Ki]=null;for(;e===Yi;)Yi=Wi[--Gi],Wi[Gi]=null,Xi=Wi[--Gi],Wi[Gi]=null,Qi=Wi[--Gi],Wi[Gi]=null}var no=null,ro=null,io=!1,oo=null;function so(e,t){var n=Nc(5,null,null,0);n.elementType="DELETED",n.stateNode=t,n.return=e,null===(t=e.deletions)?(e.deletions=[n],e.flags|=16):t.push(n)}function ao(e,t){switch(e.tag){case 5:var n=e.type;return null!==(t=1!==t.nodeType||n.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,no=e,ro=ci(t.firstChild),!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,no=e,ro=null,!0);case 13:return null!==(t=8!==t.nodeType?null:t)&&(n=null!==Yi?{id:Qi,overflow:Xi}:null,e.memoizedState={dehydrated:t,treeContext:n,retryLane:1073741824},(n=Nc(18,null,null,0)).stateNode=t,n.return=e,e.child=n,no=e,ro=null,!0);default:return!1}}function lo(e){return!(!(1&e.mode)||128&e.flags)}function co(e){if(io){var t=ro;if(t){var n=t;if(!ao(e,t)){if(lo(e))throw Error(o(418));t=ci(n.nextSibling);var r=no;t&&ao(e,t)?so(r,n):(e.flags=-4097&e.flags|2,io=!1,no=e)}}else{if(lo(e))throw Error(o(418));e.flags=-4097&e.flags|2,io=!1,no=e}}}function uo(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;no=e}function ho(e){if(e!==no)return!1;if(!io)return uo(e),io=!0,!1;var t;if((t=3!==e.tag)&&!(t=5!==e.tag)&&(t="head"!==(t=e.type)&&"body"!==t&&!ni(e.type,e.memoizedProps)),t&&(t=ro)){if(lo(e))throw fo(),Error(o(418));for(;t;)so(e,t),t=ci(t.nextSibling)}if(uo(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(o(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var n=e.data;if("/$"===n){if(0===t){ro=ci(e.nextSibling);break e}t--}else"$"!==n&&"$!"!==n&&"$?"!==n||t++}e=e.nextSibling}ro=null}}else ro=no?ci(e.stateNode.nextSibling):null;return!0}function fo(){for(var e=ro;e;)e=ci(e.nextSibling)}function po(){ro=no=null,io=!1}function go(e){null===oo?oo=[e]:oo.push(e)}var mo=v.ReactCurrentBatchConfig;function yo(e,t,n){if(null!==(e=n.ref)&&"function"!=typeof e&&"object"!=typeof e){if(n._owner){if(n=n._owner){if(1!==n.tag)throw Error(o(309));var r=n.stateNode}if(!r)throw Error(o(147,e));var i=r,s=""+e;return null!==t&&null!==t.ref&&"function"==typeof t.ref&&t.ref._stringRef===s?t.ref:(t=function(e){var t=i.refs;null===e?delete t[s]:t[s]=e},t._stringRef=s,t)}if("string"!=typeof e)throw Error(o(284));if(!n._owner)throw Error(o(290,e))}return e}function wo(e,t){throw e=Object.prototype.toString.call(t),Error(o(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function bo(e){return(0,e._init)(e._payload)}function vo(e){function t(t,n){if(e){var r=t.deletions;null===r?(t.deletions=[n],t.flags|=16):r.push(n)}}function n(n,r){if(!e)return null;for(;null!==r;)t(n,r),r=r.sibling;return null}function r(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function i(e,t){return(e=Pc(e,t)).index=0,e.sibling=null,e}function s(t,n,r){return t.index=r,e?null!==(r=t.alternate)?(r=r.index)<n?(t.flags|=2,n):r:(t.flags|=2,n):(t.flags|=1048576,n)}function a(t){return e&&null===t.alternate&&(t.flags|=2),t}function l(e,t,n,r){return null===t||6!==t.tag?((t=Mc(n,e.mode,r)).return=e,t):((t=i(t,n)).return=e,t)}function c(e,t,n,r){var o=n.type;return o===k?d(e,t,n.props.children,r,n.key):null!==t&&(t.elementType===o||"object"==typeof o&&null!==o&&o.$$typeof===D&&bo(o)===t.type)?((r=i(t,n.props)).ref=yo(e,t,n),r.return=e,r):((r=Lc(n.type,n.key,n.props,null,e.mode,r)).ref=yo(e,t,n),r.return=e,r)}function u(e,t,n,r){return null===t||4!==t.tag||t.stateNode.containerInfo!==n.containerInfo||t.stateNode.implementation!==n.implementation?((t=Uc(n,e.mode,r)).return=e,t):((t=i(t,n.children||[])).return=e,t)}function d(e,t,n,r,o){return null===t||7!==t.tag?((t=Bc(n,e.mode,r,o)).return=e,t):((t=i(t,n)).return=e,t)}function h(e,t,n){if("string"==typeof t&&""!==t||"number"==typeof t)return(t=Mc(""+t,e.mode,n)).return=e,t;if("object"==typeof t&&null!==t){switch(t.$$typeof){case E:return(n=Lc(t.type,t.key,t.props,null,e.mode,n)).ref=yo(e,null,t),n.return=e,n;case S:return(t=Uc(t,e.mode,n)).return=e,t;case D:return h(e,(0,t._init)(t._payload),n)}if(te(t)||B(t))return(t=Bc(t,e.mode,n,null)).return=e,t;wo(e,t)}return null}function f(e,t,n,r){var i=null!==t?t.key:null;if("string"==typeof n&&""!==n||"number"==typeof n)return null!==i?null:l(e,t,""+n,r);if("object"==typeof n&&null!==n){switch(n.$$typeof){case E:return n.key===i?c(e,t,n,r):null;case S:return n.key===i?u(e,t,n,r):null;case D:return f(e,t,(i=n._init)(n._payload),r)}if(te(n)||B(n))return null!==i?null:d(e,t,n,r,null);wo(e,n)}return null}function p(e,t,n,r,i){if("string"==typeof r&&""!==r||"number"==typeof r)return l(t,e=e.get(n)||null,""+r,i);if("object"==typeof r&&null!==r){switch(r.$$typeof){case E:return c(t,e=e.get(null===r.key?n:r.key)||null,r,i);case S:return u(t,e=e.get(null===r.key?n:r.key)||null,r,i);case D:return p(e,t,n,(0,r._init)(r._payload),i)}if(te(r)||B(r))return d(t,e=e.get(n)||null,r,i,null);wo(t,r)}return null}function g(i,o,a,l){for(var c=null,u=null,d=o,g=o=0,m=null;null!==d&&g<a.length;g++){d.index>g?(m=d,d=null):m=d.sibling;var y=f(i,d,a[g],l);if(null===y){null===d&&(d=m);break}e&&d&&null===y.alternate&&t(i,d),o=s(y,o,g),null===u?c=y:u.sibling=y,u=y,d=m}if(g===a.length)return n(i,d),io&&Zi(i,g),c;if(null===d){for(;g<a.length;g++)null!==(d=h(i,a[g],l))&&(o=s(d,o,g),null===u?c=d:u.sibling=d,u=d);return io&&Zi(i,g),c}for(d=r(i,d);g<a.length;g++)null!==(m=p(d,i,g,a[g],l))&&(e&&null!==m.alternate&&d.delete(null===m.key?g:m.key),o=s(m,o,g),null===u?c=m:u.sibling=m,u=m);return e&&d.forEach(function(e){return t(i,e)}),io&&Zi(i,g),c}function m(i,a,l,c){var u=B(l);if("function"!=typeof u)throw Error(o(150));if(null==(l=u.call(l)))throw Error(o(151));for(var d=u=null,g=a,m=a=0,y=null,w=l.next();null!==g&&!w.done;m++,w=l.next()){g.index>m?(y=g,g=null):y=g.sibling;var b=f(i,g,w.value,c);if(null===b){null===g&&(g=y);break}e&&g&&null===b.alternate&&t(i,g),a=s(b,a,m),null===d?u=b:d.sibling=b,d=b,g=y}if(w.done)return n(i,g),io&&Zi(i,m),u;if(null===g){for(;!w.done;m++,w=l.next())null!==(w=h(i,w.value,c))&&(a=s(w,a,m),null===d?u=w:d.sibling=w,d=w);return io&&Zi(i,m),u}for(g=r(i,g);!w.done;m++,w=l.next())null!==(w=p(g,i,m,w.value,c))&&(e&&null!==w.alternate&&g.delete(null===w.key?m:w.key),a=s(w,a,m),null===d?u=w:d.sibling=w,d=w);return e&&g.forEach(function(e){return t(i,e)}),io&&Zi(i,m),u}return function e(r,o,s,l){if("object"==typeof s&&null!==s&&s.type===k&&null===s.key&&(s=s.props.children),"object"==typeof s&&null!==s){switch(s.$$typeof){case E:e:{for(var c=s.key,u=o;null!==u;){if(u.key===c){if((c=s.type)===k){if(7===u.tag){n(r,u.sibling),(o=i(u,s.props.children)).return=r,r=o;break e}}else if(u.elementType===c||"object"==typeof c&&null!==c&&c.$$typeof===D&&bo(c)===u.type){n(r,u.sibling),(o=i(u,s.props)).ref=yo(r,u,s),o.return=r,r=o;break e}n(r,u);break}t(r,u),u=u.sibling}s.type===k?((o=Bc(s.props.children,r.mode,l,s.key)).return=r,r=o):((l=Lc(s.type,s.key,s.props,null,r.mode,l)).ref=yo(r,o,s),l.return=r,r=l)}return a(r);case S:e:{for(u=s.key;null!==o;){if(o.key===u){if(4===o.tag&&o.stateNode.containerInfo===s.containerInfo&&o.stateNode.implementation===s.implementation){n(r,o.sibling),(o=i(o,s.children||[])).return=r,r=o;break e}n(r,o);break}t(r,o),o=o.sibling}(o=Uc(s,r.mode,l)).return=r,r=o}return a(r);case D:return e(r,o,(u=s._init)(s._payload),l)}if(te(s))return g(r,o,s,l);if(B(s))return m(r,o,s,l);wo(r,s)}return"string"==typeof s&&""!==s||"number"==typeof s?(s=""+s,null!==o&&6===o.tag?(n(r,o.sibling),(o=i(o,s)).return=r,r=o):(n(r,o),(o=Mc(s,r.mode,l)).return=r,r=o),a(r)):n(r,o)}}var Eo=vo(!0),So=vo(!1),ko=_i(null),_o=null,Ro=null,Io=null;function Ao(){Io=Ro=_o=null}function xo(e){var t=ko.current;Ri(ko),e._currentValue=t}function To(e,t,n){for(;null!==e;){var r=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==r&&(r.childLanes|=t)):null!==r&&(r.childLanes&t)!==t&&(r.childLanes|=t),e===n)break;e=e.return}}function Co(e,t){_o=e,Io=Ro=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!==(e.lanes&t)&&(ba=!0),e.firstContext=null)}function No(e){var t=e._currentValue;if(Io!==e)if(e={context:e,memoizedValue:t,next:null},null===Ro){if(null===_o)throw Error(o(308));Ro=e,_o.dependencies={lanes:0,firstContext:e}}else Ro=Ro.next=e;return t}var Do=null;function Po(e){null===Do?Do=[e]:Do.push(e)}function Lo(e,t,n,r){var i=t.interleaved;return null===i?(n.next=n,Po(t)):(n.next=i.next,i.next=n),t.interleaved=n,Bo(e,r)}function Bo(e,t){e.lanes|=t;var n=e.alternate;for(null!==n&&(n.lanes|=t),n=e,e=e.return;null!==e;)e.childLanes|=t,null!==(n=e.alternate)&&(n.childLanes|=t),n=e,e=e.return;return 3===n.tag?n.stateNode:null}var Oo=!1;function Mo(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Uo(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Fo(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function zo(e,t,n){var r=e.updateQueue;if(null===r)return null;if(r=r.shared,2&xl){var i=r.pending;return null===i?t.next=t:(t.next=i.next,i.next=t),r.pending=t,Bo(e,n)}return null===(i=r.interleaved)?(t.next=t,Po(r)):(t.next=i.next,i.next=t),r.interleaved=t,Bo(e,n)}function Vo(e,t,n){if(null!==(t=t.updateQueue)&&(t=t.shared,4194240&n)){var r=t.lanes;n|=r&=e.pendingLanes,t.lanes=n,wt(e,n)}}function $o(e,t){var n=e.updateQueue,r=e.alternate;if(null!==r&&n===(r=r.updateQueue)){var i=null,o=null;if(null!==(n=n.firstBaseUpdate)){do{var s={eventTime:n.eventTime,lane:n.lane,tag:n.tag,payload:n.payload,callback:n.callback,next:null};null===o?i=o=s:o=o.next=s,n=n.next}while(null!==n);null===o?i=o=t:o=o.next=t}else i=o=t;return n={baseState:r.baseState,firstBaseUpdate:i,lastBaseUpdate:o,shared:r.shared,effects:r.effects},void(e.updateQueue=n)}null===(e=n.lastBaseUpdate)?n.firstBaseUpdate=t:e.next=t,n.lastBaseUpdate=t}function Ho(e,t,n,r){var i=e.updateQueue;Oo=!1;var o=i.firstBaseUpdate,s=i.lastBaseUpdate,a=i.shared.pending;if(null!==a){i.shared.pending=null;var l=a,c=l.next;l.next=null,null===s?o=c:s.next=c,s=l;var u=e.alternate;null!==u&&(a=(u=u.updateQueue).lastBaseUpdate)!==s&&(null===a?u.firstBaseUpdate=c:a.next=c,u.lastBaseUpdate=l)}if(null!==o){var d=i.baseState;for(s=0,u=c=l=null,a=o;;){var h=a.lane,f=a.eventTime;if((r&h)===h){null!==u&&(u=u.next={eventTime:f,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var p=e,g=a;switch(h=t,f=n,g.tag){case 1:if("function"==typeof(p=g.payload)){d=p.call(f,d,h);break e}d=p;break e;case 3:p.flags=-65537&p.flags|128;case 0:if(null==(h="function"==typeof(p=g.payload)?p.call(f,d,h):p))break e;d=M({},d,h);break e;case 2:Oo=!0}}null!==a.callback&&0!==a.lane&&(e.flags|=64,null===(h=i.effects)?i.effects=[a]:h.push(a))}else f={eventTime:f,lane:h,tag:a.tag,payload:a.payload,callback:a.callback,next:null},null===u?(c=u=f,l=d):u=u.next=f,s|=h;if(null===(a=a.next)){if(null===(a=i.shared.pending))break;a=(h=a).next,h.next=null,i.lastBaseUpdate=h,i.shared.pending=null}}if(null===u&&(l=d),i.baseState=l,i.firstBaseUpdate=c,i.lastBaseUpdate=u,null!==(t=i.shared.interleaved)){i=t;do{s|=i.lane,i=i.next}while(i!==t)}else null===o&&(i.shared.lanes=0);Ol|=s,e.lanes=s,e.memoizedState=d}}function Ko(e,t,n){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var r=e[t],i=r.callback;if(null!==i){if(r.callback=null,r=n,"function"!=typeof i)throw Error(o(191,i));i.call(r)}}}var qo={},jo=_i(qo),Wo=_i(qo),Go=_i(qo);function Yo(e){if(e===qo)throw Error(o(174));return e}function Qo(e,t){switch(Ii(Go,t),Ii(Wo,e),Ii(jo,qo),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:le(null,"");break;default:t=le(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}Ri(jo),Ii(jo,t)}function Xo(){Ri(jo),Ri(Wo),Ri(Go)}function Zo(e){Yo(Go.current);var t=Yo(jo.current),n=le(t,e.type);t!==n&&(Ii(Wo,e),Ii(jo,n))}function Jo(e){Wo.current===e&&(Ri(jo),Ri(Wo))}var es=_i(0);function ts(e){for(var t=e;null!==t;){if(13===t.tag){var n=t.memoizedState;if(null!==n&&(null===(n=n.dehydrated)||"$?"===n.data||"$!"===n.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(128&t.flags)return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var ns=[];function rs(){for(var e=0;e<ns.length;e++)ns[e]._workInProgressVersionPrimary=null;ns.length=0}var is=v.ReactCurrentDispatcher,os=v.ReactCurrentBatchConfig,ss=0,as=null,ls=null,cs=null,us=!1,ds=!1,hs=0,fs=0;function ps(){throw Error(o(321))}function gs(e,t){if(null===t)return!1;for(var n=0;n<t.length&&n<e.length;n++)if(!ar(e[n],t[n]))return!1;return!0}function ms(e,t,n,r,i,s){if(ss=s,as=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,is.current=null===e||null===e.memoizedState?Js:ea,e=n(r,i),ds){s=0;do{if(ds=!1,hs=0,25<=s)throw Error(o(301));s+=1,cs=ls=null,t.updateQueue=null,is.current=ta,e=n(r,i)}while(ds)}if(is.current=Zs,t=null!==ls&&null!==ls.next,ss=0,cs=ls=as=null,us=!1,t)throw Error(o(300));return e}function ys(){var e=0!==hs;return hs=0,e}function ws(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===cs?as.memoizedState=cs=e:cs=cs.next=e,cs}function bs(){if(null===ls){var e=as.alternate;e=null!==e?e.memoizedState:null}else e=ls.next;var t=null===cs?as.memoizedState:cs.next;if(null!==t)cs=t,ls=e;else{if(null===e)throw Error(o(310));e={memoizedState:(ls=e).memoizedState,baseState:ls.baseState,baseQueue:ls.baseQueue,queue:ls.queue,next:null},null===cs?as.memoizedState=cs=e:cs=cs.next=e}return cs}function vs(e,t){return"function"==typeof t?t(e):t}function Es(e){var t=bs(),n=t.queue;if(null===n)throw Error(o(311));n.lastRenderedReducer=e;var r=ls,i=r.baseQueue,s=n.pending;if(null!==s){if(null!==i){var a=i.next;i.next=s.next,s.next=a}r.baseQueue=i=s,n.pending=null}if(null!==i){s=i.next,r=r.baseState;var l=a=null,c=null,u=s;do{var d=u.lane;if((ss&d)===d)null!==c&&(c=c.next={lane:0,action:u.action,hasEagerState:u.hasEagerState,eagerState:u.eagerState,next:null}),r=u.hasEagerState?u.eagerState:e(r,u.action);else{var h={lane:d,action:u.action,hasEagerState:u.hasEagerState,eagerState:u.eagerState,next:null};null===c?(l=c=h,a=r):c=c.next=h,as.lanes|=d,Ol|=d}u=u.next}while(null!==u&&u!==s);null===c?a=r:c.next=l,ar(r,t.memoizedState)||(ba=!0),t.memoizedState=r,t.baseState=a,t.baseQueue=c,n.lastRenderedState=r}if(null!==(e=n.interleaved)){i=e;do{s=i.lane,as.lanes|=s,Ol|=s,i=i.next}while(i!==e)}else null===i&&(n.lanes=0);return[t.memoizedState,n.dispatch]}function Ss(e){var t=bs(),n=t.queue;if(null===n)throw Error(o(311));n.lastRenderedReducer=e;var r=n.dispatch,i=n.pending,s=t.memoizedState;if(null!==i){n.pending=null;var a=i=i.next;do{s=e(s,a.action),a=a.next}while(a!==i);ar(s,t.memoizedState)||(ba=!0),t.memoizedState=s,null===t.baseQueue&&(t.baseState=s),n.lastRenderedState=s}return[s,r]}function ks(){}function _s(e,t){var n=as,r=bs(),i=t(),s=!ar(r.memoizedState,i);if(s&&(r.memoizedState=i,ba=!0),r=r.queue,Os(As.bind(null,n,r,e),[e]),r.getSnapshot!==t||s||null!==cs&&1&cs.memoizedState.tag){if(n.flags|=2048,Ns(9,Is.bind(null,n,r,i,t),void 0,null),null===Tl)throw Error(o(349));30&ss||Rs(n,t,i)}return i}function Rs(e,t,n){e.flags|=16384,e={getSnapshot:t,value:n},null===(t=as.updateQueue)?(t={lastEffect:null,stores:null},as.updateQueue=t,t.stores=[e]):null===(n=t.stores)?t.stores=[e]:n.push(e)}function Is(e,t,n,r){t.value=n,t.getSnapshot=r,xs(t)&&Ts(e)}function As(e,t,n){return n(function(){xs(t)&&Ts(e)})}function xs(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!ar(e,n)}catch(e){return!0}}function Ts(e){var t=Bo(e,1);null!==t&&nc(t,e,1,-1)}function Cs(e){var t=ws();return"function"==typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:vs,lastRenderedState:e},t.queue=e,e=e.dispatch=Gs.bind(null,as,e),[t.memoizedState,e]}function Ns(e,t,n,r){return e={tag:e,create:t,destroy:n,deps:r,next:null},null===(t=as.updateQueue)?(t={lastEffect:null,stores:null},as.updateQueue=t,t.lastEffect=e.next=e):null===(n=t.lastEffect)?t.lastEffect=e.next=e:(r=n.next,n.next=e,e.next=r,t.lastEffect=e),e}function Ds(){return bs().memoizedState}function Ps(e,t,n,r){var i=ws();as.flags|=e,i.memoizedState=Ns(1|t,n,void 0,void 0===r?null:r)}function Ls(e,t,n,r){var i=bs();r=void 0===r?null:r;var o=void 0;if(null!==ls){var s=ls.memoizedState;if(o=s.destroy,null!==r&&gs(r,s.deps))return void(i.memoizedState=Ns(t,n,o,r))}as.flags|=e,i.memoizedState=Ns(1|t,n,o,r)}function Bs(e,t){return Ps(8390656,8,e,t)}function Os(e,t){return Ls(2048,8,e,t)}function Ms(e,t){return Ls(4,2,e,t)}function Us(e,t){return Ls(4,4,e,t)}function Fs(e,t){return"function"==typeof t?(e=e(),t(e),function(){t(null)}):null!=t?(e=e(),t.current=e,function(){t.current=null}):void 0}function zs(e,t,n){return n=null!=n?n.concat([e]):null,Ls(4,4,Fs.bind(null,t,e),n)}function Vs(){}function $s(e,t){var n=bs();t=void 0===t?null:t;var r=n.memoizedState;return null!==r&&null!==t&&gs(t,r[1])?r[0]:(n.memoizedState=[e,t],e)}function Hs(e,t){var n=bs();t=void 0===t?null:t;var r=n.memoizedState;return null!==r&&null!==t&&gs(t,r[1])?r[0]:(e=e(),n.memoizedState=[e,t],e)}function Ks(e,t,n){return 21&ss?(ar(n,t)||(n=gt(),as.lanes|=n,Ol|=n,e.baseState=!0),t):(e.baseState&&(e.baseState=!1,ba=!0),e.memoizedState=n)}function qs(e,t){var n=bt;bt=0!==n&&4>n?n:4,e(!0);var r=os.transition;os.transition={};try{e(!1),t()}finally{bt=n,os.transition=r}}function js(){return bs().memoizedState}function Ws(e,t,n){var r=tc(e);n={lane:r,action:n,hasEagerState:!1,eagerState:null,next:null},Ys(e)?Qs(t,n):null!==(n=Lo(e,t,n,r))&&(nc(n,e,r,ec()),Xs(n,t,r))}function Gs(e,t,n){var r=tc(e),i={lane:r,action:n,hasEagerState:!1,eagerState:null,next:null};if(Ys(e))Qs(t,i);else{var o=e.alternate;if(0===e.lanes&&(null===o||0===o.lanes)&&null!==(o=t.lastRenderedReducer))try{var s=t.lastRenderedState,a=o(s,n);if(i.hasEagerState=!0,i.eagerState=a,ar(a,s)){var l=t.interleaved;return null===l?(i.next=i,Po(t)):(i.next=l.next,l.next=i),void(t.interleaved=i)}}catch(e){}null!==(n=Lo(e,t,i,r))&&(nc(n,e,r,i=ec()),Xs(n,t,r))}}function Ys(e){var t=e.alternate;return e===as||null!==t&&t===as}function Qs(e,t){ds=us=!0;var n=e.pending;null===n?t.next=t:(t.next=n.next,n.next=t),e.pending=t}function Xs(e,t,n){if(4194240&n){var r=t.lanes;n|=r&=e.pendingLanes,t.lanes=n,wt(e,n)}}var Zs={readContext:No,useCallback:ps,useContext:ps,useEffect:ps,useImperativeHandle:ps,useInsertionEffect:ps,useLayoutEffect:ps,useMemo:ps,useReducer:ps,useRef:ps,useState:ps,useDebugValue:ps,useDeferredValue:ps,useTransition:ps,useMutableSource:ps,useSyncExternalStore:ps,useId:ps,unstable_isNewReconciler:!1},Js={readContext:No,useCallback:function(e,t){return ws().memoizedState=[e,void 0===t?null:t],e},useContext:No,useEffect:Bs,useImperativeHandle:function(e,t,n){return n=null!=n?n.concat([e]):null,Ps(4194308,4,Fs.bind(null,t,e),n)},useLayoutEffect:function(e,t){return Ps(4194308,4,e,t)},useInsertionEffect:function(e,t){return Ps(4,2,e,t)},useMemo:function(e,t){var n=ws();return t=void 0===t?null:t,e=e(),n.memoizedState=[e,t],e},useReducer:function(e,t,n){var r=ws();return t=void 0!==n?n(t):t,r.memoizedState=r.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},r.queue=e,e=e.dispatch=Ws.bind(null,as,e),[r.memoizedState,e]},useRef:function(e){return e={current:e},ws().memoizedState=e},useState:Cs,useDebugValue:Vs,useDeferredValue:function(e){return ws().memoizedState=e},useTransition:function(){var e=Cs(!1),t=e[0];return e=qs.bind(null,e[1]),ws().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,n){var r=as,i=ws();if(io){if(void 0===n)throw Error(o(407));n=n()}else{if(n=t(),null===Tl)throw Error(o(349));30&ss||Rs(r,t,n)}i.memoizedState=n;var s={value:n,getSnapshot:t};return i.queue=s,Bs(As.bind(null,r,s,e),[e]),r.flags|=2048,Ns(9,Is.bind(null,r,s,n,t),void 0,null),n},useId:function(){var e=ws(),t=Tl.identifierPrefix;if(io){var n=Xi;t=":"+t+"R"+(n=(Qi&~(1<<32-st(Qi)-1)).toString(32)+n),0<(n=hs++)&&(t+="H"+n.toString(32)),t+=":"}else t=":"+t+"r"+(n=fs++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},ea={readContext:No,useCallback:$s,useContext:No,useEffect:Os,useImperativeHandle:zs,useInsertionEffect:Ms,useLayoutEffect:Us,useMemo:Hs,useReducer:Es,useRef:Ds,useState:function(){return Es(vs)},useDebugValue:Vs,useDeferredValue:function(e){return Ks(bs(),ls.memoizedState,e)},useTransition:function(){return[Es(vs)[0],bs().memoizedState]},useMutableSource:ks,useSyncExternalStore:_s,useId:js,unstable_isNewReconciler:!1},ta={readContext:No,useCallback:$s,useContext:No,useEffect:Os,useImperativeHandle:zs,useInsertionEffect:Ms,useLayoutEffect:Us,useMemo:Hs,useReducer:Ss,useRef:Ds,useState:function(){return Ss(vs)},useDebugValue:Vs,useDeferredValue:function(e){var t=bs();return null===ls?t.memoizedState=e:Ks(t,ls.memoizedState,e)},useTransition:function(){return[Ss(vs)[0],bs().memoizedState]},useMutableSource:ks,useSyncExternalStore:_s,useId:js,unstable_isNewReconciler:!1};function na(e,t){if(e&&e.defaultProps){for(var n in t=M({},t),e=e.defaultProps)void 0===t[n]&&(t[n]=e[n]);return t}return t}function ra(e,t,n,r){n=null==(n=n(r,t=e.memoizedState))?t:M({},t,n),e.memoizedState=n,0===e.lanes&&(e.updateQueue.baseState=n)}var ia={isMounted:function(e){return!!(e=e._reactInternals)&&$e(e)===e},enqueueSetState:function(e,t,n){e=e._reactInternals;var r=ec(),i=tc(e),o=Fo(r,i);o.payload=t,null!=n&&(o.callback=n),null!==(t=zo(e,o,i))&&(nc(t,e,i,r),Vo(t,e,i))},enqueueReplaceState:function(e,t,n){e=e._reactInternals;var r=ec(),i=tc(e),o=Fo(r,i);o.tag=1,o.payload=t,null!=n&&(o.callback=n),null!==(t=zo(e,o,i))&&(nc(t,e,i,r),Vo(t,e,i))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var n=ec(),r=tc(e),i=Fo(n,r);i.tag=2,null!=t&&(i.callback=t),null!==(t=zo(e,i,r))&&(nc(t,e,r,n),Vo(t,e,r))}};function oa(e,t,n,r,i,o,s){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(r,o,s):!(t.prototype&&t.prototype.isPureReactComponent&&lr(n,r)&&lr(i,o))}function sa(e,t,n){var r=!1,i=Ai,o=t.contextType;return"object"==typeof o&&null!==o?o=No(o):(i=Di(t)?Ci:xi.current,o=(r=null!=(r=t.contextTypes))?Ni(e,i):Ai),t=new t(n,o),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=ia,e.stateNode=t,t._reactInternals=e,r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=i,e.__reactInternalMemoizedMaskedChildContext=o),t}function aa(e,t,n,r){e=t.state,"function"==typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(n,r),"function"==typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(n,r),t.state!==e&&ia.enqueueReplaceState(t,t.state,null)}function la(e,t,n,r){var i=e.stateNode;i.props=n,i.state=e.memoizedState,i.refs={},Mo(e);var o=t.contextType;"object"==typeof o&&null!==o?i.context=No(o):(o=Di(t)?Ci:xi.current,i.context=Ni(e,o)),i.state=e.memoizedState,"function"==typeof(o=t.getDerivedStateFromProps)&&(ra(e,t,o,n),i.state=e.memoizedState),"function"==typeof t.getDerivedStateFromProps||"function"==typeof i.getSnapshotBeforeUpdate||"function"!=typeof i.UNSAFE_componentWillMount&&"function"!=typeof i.componentWillMount||(t=i.state,"function"==typeof i.componentWillMount&&i.componentWillMount(),"function"==typeof i.UNSAFE_componentWillMount&&i.UNSAFE_componentWillMount(),t!==i.state&&ia.enqueueReplaceState(i,i.state,null),Ho(e,n,i,r),i.state=e.memoizedState),"function"==typeof i.componentDidMount&&(e.flags|=4194308)}function ca(e,t){try{var n="",r=t;do{n+=V(r),r=r.return}while(r);var i=n}catch(e){i="\nError generating stack: "+e.message+"\n"+e.stack}return{value:e,source:t,stack:i,digest:null}}function ua(e,t,n){return{value:e,source:null,stack:null!=n?n:null,digest:null!=t?t:null}}function da(e,t){try{console.error(t.value)}catch(e){setTimeout(function(){throw e})}}var ha="function"==typeof WeakMap?WeakMap:Map;function fa(e,t,n){(n=Fo(-1,n)).tag=3,n.payload={element:null};var r=t.value;return n.callback=function(){Kl||(Kl=!0,ql=r),da(0,t)},n}function pa(e,t,n){(n=Fo(-1,n)).tag=3;var r=e.type.getDerivedStateFromError;if("function"==typeof r){var i=t.value;n.payload=function(){return r(i)},n.callback=function(){da(0,t)}}var o=e.stateNode;return null!==o&&"function"==typeof o.componentDidCatch&&(n.callback=function(){da(0,t),"function"!=typeof r&&(null===jl?jl=new Set([this]):jl.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),n}function ga(e,t,n){var r=e.pingCache;if(null===r){r=e.pingCache=new ha;var i=new Set;r.set(t,i)}else void 0===(i=r.get(t))&&(i=new Set,r.set(t,i));i.has(n)||(i.add(n),e=Rc.bind(null,e,t,n),t.then(e,e))}function ma(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function ya(e,t,n,r,i){return 1&e.mode?(e.flags|=65536,e.lanes=i,e):(e===t?e.flags|=65536:(e.flags|=128,n.flags|=131072,n.flags&=-52805,1===n.tag&&(null===n.alternate?n.tag=17:((t=Fo(-1,1)).tag=2,zo(n,t,1))),n.lanes|=1),e)}var wa=v.ReactCurrentOwner,ba=!1;function va(e,t,n,r){t.child=null===e?So(t,null,n,r):Eo(t,e.child,n,r)}function Ea(e,t,n,r,i){n=n.render;var o=t.ref;return Co(t,i),r=ms(e,t,n,r,o,i),n=ys(),null===e||ba?(io&&n&&eo(t),t.flags|=1,va(e,t,r,i),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~i,Ka(e,t,i))}function Sa(e,t,n,r,i){if(null===e){var o=n.type;return"function"!=typeof o||Dc(o)||void 0!==o.defaultProps||null!==n.compare||void 0!==n.defaultProps?((e=Lc(n.type,null,r,t,t.mode,i)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=o,ka(e,t,o,r,i))}if(o=e.child,0===(e.lanes&i)){var s=o.memoizedProps;if((n=null!==(n=n.compare)?n:lr)(s,r)&&e.ref===t.ref)return Ka(e,t,i)}return t.flags|=1,(e=Pc(o,r)).ref=t.ref,e.return=t,t.child=e}function ka(e,t,n,r,i){if(null!==e){var o=e.memoizedProps;if(lr(o,r)&&e.ref===t.ref){if(ba=!1,t.pendingProps=r=o,0===(e.lanes&i))return t.lanes=e.lanes,Ka(e,t,i);131072&e.flags&&(ba=!0)}}return Ia(e,t,n,r,i)}function _a(e,t,n){var r=t.pendingProps,i=r.children,o=null!==e?e.memoizedState:null;if("hidden"===r.mode)if(1&t.mode){if(!(1073741824&n))return e=null!==o?o.baseLanes|n:n,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,Ii(Pl,Dl),Dl|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},r=null!==o?o.baseLanes:n,Ii(Pl,Dl),Dl|=r}else t.memoizedState={baseLanes:0,cachePool:null,transitions:null},Ii(Pl,Dl),Dl|=n;else null!==o?(r=o.baseLanes|n,t.memoizedState=null):r=n,Ii(Pl,Dl),Dl|=r;return va(e,t,i,n),t.child}function Ra(e,t){var n=t.ref;(null===e&&null!==n||null!==e&&e.ref!==n)&&(t.flags|=512,t.flags|=2097152)}function Ia(e,t,n,r,i){var o=Di(n)?Ci:xi.current;return o=Ni(t,o),Co(t,i),n=ms(e,t,n,r,o,i),r=ys(),null===e||ba?(io&&r&&eo(t),t.flags|=1,va(e,t,n,i),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~i,Ka(e,t,i))}function Aa(e,t,n,r,i){if(Di(n)){var o=!0;Oi(t)}else o=!1;if(Co(t,i),null===t.stateNode)Ha(e,t),sa(t,n,r),la(t,n,r,i),r=!0;else if(null===e){var s=t.stateNode,a=t.memoizedProps;s.props=a;var l=s.context,c=n.contextType;c="object"==typeof c&&null!==c?No(c):Ni(t,c=Di(n)?Ci:xi.current);var u=n.getDerivedStateFromProps,d="function"==typeof u||"function"==typeof s.getSnapshotBeforeUpdate;d||"function"!=typeof s.UNSAFE_componentWillReceiveProps&&"function"!=typeof s.componentWillReceiveProps||(a!==r||l!==c)&&aa(t,s,r,c),Oo=!1;var h=t.memoizedState;s.state=h,Ho(t,r,s,i),l=t.memoizedState,a!==r||h!==l||Ti.current||Oo?("function"==typeof u&&(ra(t,n,u,r),l=t.memoizedState),(a=Oo||oa(t,n,a,r,h,l,c))?(d||"function"!=typeof s.UNSAFE_componentWillMount&&"function"!=typeof s.componentWillMount||("function"==typeof s.componentWillMount&&s.componentWillMount(),"function"==typeof s.UNSAFE_componentWillMount&&s.UNSAFE_componentWillMount()),"function"==typeof s.componentDidMount&&(t.flags|=4194308)):("function"==typeof s.componentDidMount&&(t.flags|=4194308),t.memoizedProps=r,t.memoizedState=l),s.props=r,s.state=l,s.context=c,r=a):("function"==typeof s.componentDidMount&&(t.flags|=4194308),r=!1)}else{s=t.stateNode,Uo(e,t),a=t.memoizedProps,c=t.type===t.elementType?a:na(t.type,a),s.props=c,d=t.pendingProps,h=s.context,l="object"==typeof(l=n.contextType)&&null!==l?No(l):Ni(t,l=Di(n)?Ci:xi.current);var f=n.getDerivedStateFromProps;(u="function"==typeof f||"function"==typeof s.getSnapshotBeforeUpdate)||"function"!=typeof s.UNSAFE_componentWillReceiveProps&&"function"!=typeof s.componentWillReceiveProps||(a!==d||h!==l)&&aa(t,s,r,l),Oo=!1,h=t.memoizedState,s.state=h,Ho(t,r,s,i);var p=t.memoizedState;a!==d||h!==p||Ti.current||Oo?("function"==typeof f&&(ra(t,n,f,r),p=t.memoizedState),(c=Oo||oa(t,n,c,r,h,p,l)||!1)?(u||"function"!=typeof s.UNSAFE_componentWillUpdate&&"function"!=typeof s.componentWillUpdate||("function"==typeof s.componentWillUpdate&&s.componentWillUpdate(r,p,l),"function"==typeof s.UNSAFE_componentWillUpdate&&s.UNSAFE_componentWillUpdate(r,p,l)),"function"==typeof s.componentDidUpdate&&(t.flags|=4),"function"==typeof s.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!=typeof s.componentDidUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!=typeof s.getSnapshotBeforeUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),t.memoizedProps=r,t.memoizedState=p),s.props=r,s.state=p,s.context=l,r=c):("function"!=typeof s.componentDidUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!=typeof s.getSnapshotBeforeUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),r=!1)}return xa(e,t,n,r,o,i)}function xa(e,t,n,r,i,o){Ra(e,t);var s=!!(128&t.flags);if(!r&&!s)return i&&Mi(t,n,!1),Ka(e,t,o);r=t.stateNode,wa.current=t;var a=s&&"function"!=typeof n.getDerivedStateFromError?null:r.render();return t.flags|=1,null!==e&&s?(t.child=Eo(t,e.child,null,o),t.child=Eo(t,null,a,o)):va(e,t,a,o),t.memoizedState=r.state,i&&Mi(t,n,!0),t.child}function Ta(e){var t=e.stateNode;t.pendingContext?Li(0,t.pendingContext,t.pendingContext!==t.context):t.context&&Li(0,t.context,!1),Qo(e,t.containerInfo)}function Ca(e,t,n,r,i){return po(),go(i),t.flags|=256,va(e,t,n,r),t.child}var Na,Da,Pa,La,Ba={dehydrated:null,treeContext:null,retryLane:0};function Oa(e){return{baseLanes:e,cachePool:null,transitions:null}}function Ma(e,t,n){var r,i=t.pendingProps,s=es.current,a=!1,l=!!(128&t.flags);if((r=l)||(r=(null===e||null!==e.memoizedState)&&!!(2&s)),r?(a=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(s|=1),Ii(es,1&s),null===e)return co(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(1&t.mode?"$!"===e.data?t.lanes=8:t.lanes=1073741824:t.lanes=1,null):(l=i.children,e=i.fallback,a?(i=t.mode,a=t.child,l={mode:"hidden",children:l},1&i||null===a?a=Oc(l,i,0,null):(a.childLanes=0,a.pendingProps=l),e=Bc(e,i,n,null),a.return=t,e.return=t,a.sibling=e,t.child=a,t.child.memoizedState=Oa(n),t.memoizedState=Ba,e):Ua(t,l));if(null!==(s=e.memoizedState)&&null!==(r=s.dehydrated))return function(e,t,n,r,i,s,a){if(n)return 256&t.flags?(t.flags&=-257,Fa(e,t,a,r=ua(Error(o(422))))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(s=r.fallback,i=t.mode,r=Oc({mode:"visible",children:r.children},i,0,null),(s=Bc(s,i,a,null)).flags|=2,r.return=t,s.return=t,r.sibling=s,t.child=r,1&t.mode&&Eo(t,e.child,null,a),t.child.memoizedState=Oa(a),t.memoizedState=Ba,s);if(!(1&t.mode))return Fa(e,t,a,null);if("$!"===i.data){if(r=i.nextSibling&&i.nextSibling.dataset)var l=r.dgst;return r=l,Fa(e,t,a,r=ua(s=Error(o(419)),r,void 0))}if(l=0!==(a&e.childLanes),ba||l){if(null!==(r=Tl)){switch(a&-a){case 4:i=2;break;case 16:i=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:i=32;break;case 536870912:i=268435456;break;default:i=0}0!==(i=0!==(i&(r.suspendedLanes|a))?0:i)&&i!==s.retryLane&&(s.retryLane=i,Bo(e,i),nc(r,e,i,-1))}return gc(),Fa(e,t,a,r=ua(Error(o(421))))}return"$?"===i.data?(t.flags|=128,t.child=e.child,t=Ac.bind(null,e),i._reactRetry=t,null):(e=s.treeContext,ro=ci(i.nextSibling),no=t,io=!0,oo=null,null!==e&&(Wi[Gi++]=Qi,Wi[Gi++]=Xi,Wi[Gi++]=Yi,Qi=e.id,Xi=e.overflow,Yi=t),(t=Ua(t,r.children)).flags|=4096,t)}(e,t,l,i,r,s,n);if(a){a=i.fallback,l=t.mode,r=(s=e.child).sibling;var c={mode:"hidden",children:i.children};return 1&l||t.child===s?(i=Pc(s,c)).subtreeFlags=14680064&s.subtreeFlags:((i=t.child).childLanes=0,i.pendingProps=c,t.deletions=null),null!==r?a=Pc(r,a):(a=Bc(a,l,n,null)).flags|=2,a.return=t,i.return=t,i.sibling=a,t.child=i,i=a,a=t.child,l=null===(l=e.child.memoizedState)?Oa(n):{baseLanes:l.baseLanes|n,cachePool:null,transitions:l.transitions},a.memoizedState=l,a.childLanes=e.childLanes&~n,t.memoizedState=Ba,i}return e=(a=e.child).sibling,i=Pc(a,{mode:"visible",children:i.children}),!(1&t.mode)&&(i.lanes=n),i.return=t,i.sibling=null,null!==e&&(null===(n=t.deletions)?(t.deletions=[e],t.flags|=16):n.push(e)),t.child=i,t.memoizedState=null,i}function Ua(e,t){return(t=Oc({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function Fa(e,t,n,r){return null!==r&&go(r),Eo(t,e.child,null,n),(e=Ua(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function za(e,t,n){e.lanes|=t;var r=e.alternate;null!==r&&(r.lanes|=t),To(e.return,t,n)}function Va(e,t,n,r,i){var o=e.memoizedState;null===o?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:r,tail:n,tailMode:i}:(o.isBackwards=t,o.rendering=null,o.renderingStartTime=0,o.last=r,o.tail=n,o.tailMode=i)}function $a(e,t,n){var r=t.pendingProps,i=r.revealOrder,o=r.tail;if(va(e,t,r.children,n),2&(r=es.current))r=1&r|2,t.flags|=128;else{if(null!==e&&128&e.flags)e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&za(e,n,t);else if(19===e.tag)za(e,n,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}r&=1}if(Ii(es,r),1&t.mode)switch(i){case"forwards":for(n=t.child,i=null;null!==n;)null!==(e=n.alternate)&&null===ts(e)&&(i=n),n=n.sibling;null===(n=i)?(i=t.child,t.child=null):(i=n.sibling,n.sibling=null),Va(t,!1,i,n,o);break;case"backwards":for(n=null,i=t.child,t.child=null;null!==i;){if(null!==(e=i.alternate)&&null===ts(e)){t.child=i;break}e=i.sibling,i.sibling=n,n=i,i=e}Va(t,!0,n,null,o);break;case"together":Va(t,!1,null,null,void 0);break;default:t.memoizedState=null}else t.memoizedState=null;return t.child}function Ha(e,t){!(1&t.mode)&&null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2)}function Ka(e,t,n){if(null!==e&&(t.dependencies=e.dependencies),Ol|=t.lanes,0===(n&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(o(153));if(null!==t.child){for(n=Pc(e=t.child,e.pendingProps),t.child=n,n.return=t;null!==e.sibling;)e=e.sibling,(n=n.sibling=Pc(e,e.pendingProps)).return=t;n.sibling=null}return t.child}function qa(e,t){if(!io)switch(e.tailMode){case"hidden":t=e.tail;for(var n=null;null!==t;)null!==t.alternate&&(n=t),t=t.sibling;null===n?e.tail=null:n.sibling=null;break;case"collapsed":n=e.tail;for(var r=null;null!==n;)null!==n.alternate&&(r=n),n=n.sibling;null===r?t||null===e.tail?e.tail=null:e.tail.sibling=null:r.sibling=null}}function ja(e){var t=null!==e.alternate&&e.alternate.child===e.child,n=0,r=0;if(t)for(var i=e.child;null!==i;)n|=i.lanes|i.childLanes,r|=14680064&i.subtreeFlags,r|=14680064&i.flags,i.return=e,i=i.sibling;else for(i=e.child;null!==i;)n|=i.lanes|i.childLanes,r|=i.subtreeFlags,r|=i.flags,i.return=e,i=i.sibling;return e.subtreeFlags|=r,e.childLanes=n,t}function Wa(e,t,n){var r=t.pendingProps;switch(to(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return ja(t),null;case 1:case 17:return Di(t.type)&&Pi(),ja(t),null;case 3:return r=t.stateNode,Xo(),Ri(Ti),Ri(xi),rs(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),null!==e&&null!==e.child||(ho(t)?t.flags|=4:null===e||e.memoizedState.isDehydrated&&!(256&t.flags)||(t.flags|=1024,null!==oo&&(sc(oo),oo=null))),Da(e,t),ja(t),null;case 5:Jo(t);var i=Yo(Go.current);if(n=t.type,null!==e&&null!=t.stateNode)Pa(e,t,n,r,i),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!r){if(null===t.stateNode)throw Error(o(166));return ja(t),null}if(e=Yo(jo.current),ho(t)){r=t.stateNode,n=t.type;var s=t.memoizedProps;switch(r[hi]=t,r[fi]=s,e=!!(1&t.mode),n){case"dialog":Fr("cancel",r),Fr("close",r);break;case"iframe":case"object":case"embed":Fr("load",r);break;case"video":case"audio":for(i=0;i<Br.length;i++)Fr(Br[i],r);break;case"source":Fr("error",r);break;case"img":case"image":case"link":Fr("error",r),Fr("load",r);break;case"details":Fr("toggle",r);break;case"input":Q(r,s),Fr("invalid",r);break;case"select":r._wrapperState={wasMultiple:!!s.multiple},Fr("invalid",r);break;case"textarea":ie(r,s),Fr("invalid",r)}for(var l in we(n,s),i=null,s)if(s.hasOwnProperty(l)){var c=s[l];"children"===l?"string"==typeof c?r.textContent!==c&&(!0!==s.suppressHydrationWarning&&Zr(r.textContent,c,e),i=["children",c]):"number"==typeof c&&r.textContent!==""+c&&(!0!==s.suppressHydrationWarning&&Zr(r.textContent,c,e),i=["children",""+c]):a.hasOwnProperty(l)&&null!=c&&"onScroll"===l&&Fr("scroll",r)}switch(n){case"input":j(r),J(r,s,!0);break;case"textarea":j(r),se(r);break;case"select":case"option":break;default:"function"==typeof s.onClick&&(r.onclick=Jr)}r=i,t.updateQueue=r,null!==r&&(t.flags|=4)}else{l=9===i.nodeType?i:i.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=ae(n)),"http://www.w3.org/1999/xhtml"===e?"script"===n?((e=l.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"==typeof r.is?e=l.createElement(n,{is:r.is}):(e=l.createElement(n),"select"===n&&(l=e,r.multiple?l.multiple=!0:r.size&&(l.size=r.size))):e=l.createElementNS(e,n),e[hi]=t,e[fi]=r,Na(e,t,!1,!1),t.stateNode=e;e:{switch(l=be(n,r),n){case"dialog":Fr("cancel",e),Fr("close",e),i=r;break;case"iframe":case"object":case"embed":Fr("load",e),i=r;break;case"video":case"audio":for(i=0;i<Br.length;i++)Fr(Br[i],e);i=r;break;case"source":Fr("error",e),i=r;break;case"img":case"image":case"link":Fr("error",e),Fr("load",e),i=r;break;case"details":Fr("toggle",e),i=r;break;case"input":Q(e,r),i=Y(e,r),Fr("invalid",e);break;case"option":default:i=r;break;case"select":e._wrapperState={wasMultiple:!!r.multiple},i=M({},r,{value:void 0}),Fr("invalid",e);break;case"textarea":ie(e,r),i=re(e,r),Fr("invalid",e)}for(s in we(n,i),c=i)if(c.hasOwnProperty(s)){var u=c[s];"style"===s?me(e,u):"dangerouslySetInnerHTML"===s?null!=(u=u?u.__html:void 0)&&de(e,u):"children"===s?"string"==typeof u?("textarea"!==n||""!==u)&&he(e,u):"number"==typeof u&&he(e,""+u):"suppressContentEditableWarning"!==s&&"suppressHydrationWarning"!==s&&"autoFocus"!==s&&(a.hasOwnProperty(s)?null!=u&&"onScroll"===s&&Fr("scroll",e):null!=u&&b(e,s,u,l))}switch(n){case"input":j(e),J(e,r,!1);break;case"textarea":j(e),se(e);break;case"option":null!=r.value&&e.setAttribute("value",""+K(r.value));break;case"select":e.multiple=!!r.multiple,null!=(s=r.value)?ne(e,!!r.multiple,s,!1):null!=r.defaultValue&&ne(e,!!r.multiple,r.defaultValue,!0);break;default:"function"==typeof i.onClick&&(e.onclick=Jr)}switch(n){case"button":case"input":case"select":case"textarea":r=!!r.autoFocus;break e;case"img":r=!0;break e;default:r=!1}}r&&(t.flags|=4)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return ja(t),null;case 6:if(e&&null!=t.stateNode)La(e,t,e.memoizedProps,r);else{if("string"!=typeof r&&null===t.stateNode)throw Error(o(166));if(n=Yo(Go.current),Yo(jo.current),ho(t)){if(r=t.stateNode,n=t.memoizedProps,r[hi]=t,(s=r.nodeValue!==n)&&null!==(e=no))switch(e.tag){case 3:Zr(r.nodeValue,n,!!(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&Zr(r.nodeValue,n,!!(1&e.mode))}s&&(t.flags|=4)}else(r=(9===n.nodeType?n:n.ownerDocument).createTextNode(r))[hi]=t,t.stateNode=r}return ja(t),null;case 13:if(Ri(es),r=t.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(io&&null!==ro&&1&t.mode&&!(128&t.flags))fo(),po(),t.flags|=98560,s=!1;else if(s=ho(t),null!==r&&null!==r.dehydrated){if(null===e){if(!s)throw Error(o(318));if(!(s=null!==(s=t.memoizedState)?s.dehydrated:null))throw Error(o(317));s[hi]=t}else po(),!(128&t.flags)&&(t.memoizedState=null),t.flags|=4;ja(t),s=!1}else null!==oo&&(sc(oo),oo=null),s=!0;if(!s)return 65536&t.flags?t:null}return 128&t.flags?(t.lanes=n,t):((r=null!==r)!=(null!==e&&null!==e.memoizedState)&&r&&(t.child.flags|=8192,1&t.mode&&(null===e||1&es.current?0===Ll&&(Ll=3):gc())),null!==t.updateQueue&&(t.flags|=4),ja(t),null);case 4:return Xo(),Da(e,t),null===e&&$r(t.stateNode.containerInfo),ja(t),null;case 10:return xo(t.type._context),ja(t),null;case 19:if(Ri(es),null===(s=t.memoizedState))return ja(t),null;if(r=!!(128&t.flags),null===(l=s.rendering))if(r)qa(s,!1);else{if(0!==Ll||null!==e&&128&e.flags)for(e=t.child;null!==e;){if(null!==(l=ts(e))){for(t.flags|=128,qa(s,!1),null!==(r=l.updateQueue)&&(t.updateQueue=r,t.flags|=4),t.subtreeFlags=0,r=n,n=t.child;null!==n;)e=r,(s=n).flags&=14680066,null===(l=s.alternate)?(s.childLanes=0,s.lanes=e,s.child=null,s.subtreeFlags=0,s.memoizedProps=null,s.memoizedState=null,s.updateQueue=null,s.dependencies=null,s.stateNode=null):(s.childLanes=l.childLanes,s.lanes=l.lanes,s.child=l.child,s.subtreeFlags=0,s.deletions=null,s.memoizedProps=l.memoizedProps,s.memoizedState=l.memoizedState,s.updateQueue=l.updateQueue,s.type=l.type,e=l.dependencies,s.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),n=n.sibling;return Ii(es,1&es.current|2),t.child}e=e.sibling}null!==s.tail&&Xe()>$l&&(t.flags|=128,r=!0,qa(s,!1),t.lanes=4194304)}else{if(!r)if(null!==(e=ts(l))){if(t.flags|=128,r=!0,null!==(n=e.updateQueue)&&(t.updateQueue=n,t.flags|=4),qa(s,!0),null===s.tail&&"hidden"===s.tailMode&&!l.alternate&&!io)return ja(t),null}else 2*Xe()-s.renderingStartTime>$l&&1073741824!==n&&(t.flags|=128,r=!0,qa(s,!1),t.lanes=4194304);s.isBackwards?(l.sibling=t.child,t.child=l):(null!==(n=s.last)?n.sibling=l:t.child=l,s.last=l)}return null!==s.tail?(t=s.tail,s.rendering=t,s.tail=t.sibling,s.renderingStartTime=Xe(),t.sibling=null,n=es.current,Ii(es,r?1&n|2:1&n),t):(ja(t),null);case 22:case 23:return dc(),r=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==r&&(t.flags|=8192),r&&1&t.mode?!!(1073741824&Dl)&&(ja(t),6&t.subtreeFlags&&(t.flags|=8192)):ja(t),null;case 24:case 25:return null}throw Error(o(156,t.tag))}function Ga(e,t){switch(to(t),t.tag){case 1:return Di(t.type)&&Pi(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return Xo(),Ri(Ti),Ri(xi),rs(),65536&(e=t.flags)&&!(128&e)?(t.flags=-65537&e|128,t):null;case 5:return Jo(t),null;case 13:if(Ri(es),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(o(340));po()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return Ri(es),null;case 4:return Xo(),null;case 10:return xo(t.type._context),null;case 22:case 23:return dc(),null;default:return null}}Na=function(e,t){for(var n=t.child;null!==n;){if(5===n.tag||6===n.tag)e.appendChild(n.stateNode);else if(4!==n.tag&&null!==n.child){n.child.return=n,n=n.child;continue}if(n===t)break;for(;null===n.sibling;){if(null===n.return||n.return===t)return;n=n.return}n.sibling.return=n.return,n=n.sibling}},Da=function(){},Pa=function(e,t,n,r){var i=e.memoizedProps;if(i!==r){e=t.stateNode,Yo(jo.current);var o,s=null;switch(n){case"input":i=Y(e,i),r=Y(e,r),s=[];break;case"select":i=M({},i,{value:void 0}),r=M({},r,{value:void 0}),s=[];break;case"textarea":i=re(e,i),r=re(e,r),s=[];break;default:"function"!=typeof i.onClick&&"function"==typeof r.onClick&&(e.onclick=Jr)}for(u in we(n,r),n=null,i)if(!r.hasOwnProperty(u)&&i.hasOwnProperty(u)&&null!=i[u])if("style"===u){var l=i[u];for(o in l)l.hasOwnProperty(o)&&(n||(n={}),n[o]="")}else"dangerouslySetInnerHTML"!==u&&"children"!==u&&"suppressContentEditableWarning"!==u&&"suppressHydrationWarning"!==u&&"autoFocus"!==u&&(a.hasOwnProperty(u)?s||(s=[]):(s=s||[]).push(u,null));for(u in r){var c=r[u];if(l=null!=i?i[u]:void 0,r.hasOwnProperty(u)&&c!==l&&(null!=c||null!=l))if("style"===u)if(l){for(o in l)!l.hasOwnProperty(o)||c&&c.hasOwnProperty(o)||(n||(n={}),n[o]="");for(o in c)c.hasOwnProperty(o)&&l[o]!==c[o]&&(n||(n={}),n[o]=c[o])}else n||(s||(s=[]),s.push(u,n)),n=c;else"dangerouslySetInnerHTML"===u?(c=c?c.__html:void 0,l=l?l.__html:void 0,null!=c&&l!==c&&(s=s||[]).push(u,c)):"children"===u?"string"!=typeof c&&"number"!=typeof c||(s=s||[]).push(u,""+c):"suppressContentEditableWarning"!==u&&"suppressHydrationWarning"!==u&&(a.hasOwnProperty(u)?(null!=c&&"onScroll"===u&&Fr("scroll",e),s||l===c||(s=[])):(s=s||[]).push(u,c))}n&&(s=s||[]).push("style",n);var u=s;(t.updateQueue=u)&&(t.flags|=4)}},La=function(e,t,n,r){n!==r&&(t.flags|=4)};var Ya=!1,Qa=!1,Xa="function"==typeof WeakSet?WeakSet:Set,Za=null;function Ja(e,t){var n=e.ref;if(null!==n)if("function"==typeof n)try{n(null)}catch(n){_c(e,t,n)}else n.current=null}function el(e,t,n){try{n()}catch(n){_c(e,t,n)}}var tl=!1;function nl(e,t,n){var r=t.updateQueue;if(null!==(r=null!==r?r.lastEffect:null)){var i=r=r.next;do{if((i.tag&e)===e){var o=i.destroy;i.destroy=void 0,void 0!==o&&el(t,n,o)}i=i.next}while(i!==r)}}function rl(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var n=t=t.next;do{if((n.tag&e)===e){var r=n.create;n.destroy=r()}n=n.next}while(n!==t)}}function il(e){var t=e.ref;if(null!==t){var n=e.stateNode;e.tag,e=n,"function"==typeof t?t(e):t.current=e}}function ol(e){var t=e.alternate;null!==t&&(e.alternate=null,ol(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&null!==(t=e.stateNode)&&(delete t[hi],delete t[fi],delete t[gi],delete t[mi],delete t[yi]),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function sl(e){return 5===e.tag||3===e.tag||4===e.tag}function al(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||sl(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function ll(e,t,n){var r=e.tag;if(5===r||6===r)e=e.stateNode,t?8===n.nodeType?n.parentNode.insertBefore(e,t):n.insertBefore(e,t):(8===n.nodeType?(t=n.parentNode).insertBefore(e,n):(t=n).appendChild(e),null!=(n=n._reactRootContainer)||null!==t.onclick||(t.onclick=Jr));else if(4!==r&&null!==(e=e.child))for(ll(e,t,n),e=e.sibling;null!==e;)ll(e,t,n),e=e.sibling}function cl(e,t,n){var r=e.tag;if(5===r||6===r)e=e.stateNode,t?n.insertBefore(e,t):n.appendChild(e);else if(4!==r&&null!==(e=e.child))for(cl(e,t,n),e=e.sibling;null!==e;)cl(e,t,n),e=e.sibling}var ul=null,dl=!1;function hl(e,t,n){for(n=n.child;null!==n;)fl(e,t,n),n=n.sibling}function fl(e,t,n){if(ot&&"function"==typeof ot.onCommitFiberUnmount)try{ot.onCommitFiberUnmount(it,n)}catch(e){}switch(n.tag){case 5:Qa||Ja(n,t);case 6:var r=ul,i=dl;ul=null,hl(e,t,n),dl=i,null!==(ul=r)&&(dl?(e=ul,n=n.stateNode,8===e.nodeType?e.parentNode.removeChild(n):e.removeChild(n)):ul.removeChild(n.stateNode));break;case 18:null!==ul&&(dl?(e=ul,n=n.stateNode,8===e.nodeType?li(e.parentNode,n):1===e.nodeType&&li(e,n),$t(e)):li(ul,n.stateNode));break;case 4:r=ul,i=dl,ul=n.stateNode.containerInfo,dl=!0,hl(e,t,n),ul=r,dl=i;break;case 0:case 11:case 14:case 15:if(!Qa&&null!==(r=n.updateQueue)&&null!==(r=r.lastEffect)){i=r=r.next;do{var o=i,s=o.destroy;o=o.tag,void 0!==s&&(2&o||4&o)&&el(n,t,s),i=i.next}while(i!==r)}hl(e,t,n);break;case 1:if(!Qa&&(Ja(n,t),"function"==typeof(r=n.stateNode).componentWillUnmount))try{r.props=n.memoizedProps,r.state=n.memoizedState,r.componentWillUnmount()}catch(e){_c(n,t,e)}hl(e,t,n);break;case 21:hl(e,t,n);break;case 22:1&n.mode?(Qa=(r=Qa)||null!==n.memoizedState,hl(e,t,n),Qa=r):hl(e,t,n);break;default:hl(e,t,n)}}function pl(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var n=e.stateNode;null===n&&(n=e.stateNode=new Xa),t.forEach(function(t){var r=xc.bind(null,e,t);n.has(t)||(n.add(t),t.then(r,r))})}}function gl(e,t){var n=t.deletions;if(null!==n)for(var r=0;r<n.length;r++){var i=n[r];try{var s=e,a=t,l=a;e:for(;null!==l;){switch(l.tag){case 5:ul=l.stateNode,dl=!1;break e;case 3:case 4:ul=l.stateNode.containerInfo,dl=!0;break e}l=l.return}if(null===ul)throw Error(o(160));fl(s,a,i),ul=null,dl=!1;var c=i.alternate;null!==c&&(c.return=null),i.return=null}catch(e){_c(i,t,e)}}if(12854&t.subtreeFlags)for(t=t.child;null!==t;)ml(t,e),t=t.sibling}function ml(e,t){var n=e.alternate,r=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(gl(t,e),yl(e),4&r){try{nl(3,e,e.return),rl(3,e)}catch(t){_c(e,e.return,t)}try{nl(5,e,e.return)}catch(t){_c(e,e.return,t)}}break;case 1:gl(t,e),yl(e),512&r&&null!==n&&Ja(n,n.return);break;case 5:if(gl(t,e),yl(e),512&r&&null!==n&&Ja(n,n.return),32&e.flags){var i=e.stateNode;try{he(i,"")}catch(t){_c(e,e.return,t)}}if(4&r&&null!=(i=e.stateNode)){var s=e.memoizedProps,a=null!==n?n.memoizedProps:s,l=e.type,c=e.updateQueue;if(e.updateQueue=null,null!==c)try{"input"===l&&"radio"===s.type&&null!=s.name&&X(i,s),be(l,a);var u=be(l,s);for(a=0;a<c.length;a+=2){var d=c[a],h=c[a+1];"style"===d?me(i,h):"dangerouslySetInnerHTML"===d?de(i,h):"children"===d?he(i,h):b(i,d,h,u)}switch(l){case"input":Z(i,s);break;case"textarea":oe(i,s);break;case"select":var f=i._wrapperState.wasMultiple;i._wrapperState.wasMultiple=!!s.multiple;var p=s.value;null!=p?ne(i,!!s.multiple,p,!1):f!==!!s.multiple&&(null!=s.defaultValue?ne(i,!!s.multiple,s.defaultValue,!0):ne(i,!!s.multiple,s.multiple?[]:"",!1))}i[fi]=s}catch(t){_c(e,e.return,t)}}break;case 6:if(gl(t,e),yl(e),4&r){if(null===e.stateNode)throw Error(o(162));i=e.stateNode,s=e.memoizedProps;try{i.nodeValue=s}catch(t){_c(e,e.return,t)}}break;case 3:if(gl(t,e),yl(e),4&r&&null!==n&&n.memoizedState.isDehydrated)try{$t(t.containerInfo)}catch(t){_c(e,e.return,t)}break;case 4:default:gl(t,e),yl(e);break;case 13:gl(t,e),yl(e),8192&(i=e.child).flags&&(s=null!==i.memoizedState,i.stateNode.isHidden=s,!s||null!==i.alternate&&null!==i.alternate.memoizedState||(Vl=Xe())),4&r&&pl(e);break;case 22:if(d=null!==n&&null!==n.memoizedState,1&e.mode?(Qa=(u=Qa)||d,gl(t,e),Qa=u):gl(t,e),yl(e),8192&r){if(u=null!==e.memoizedState,(e.stateNode.isHidden=u)&&!d&&1&e.mode)for(Za=e,d=e.child;null!==d;){for(h=Za=d;null!==Za;){switch(p=(f=Za).child,f.tag){case 0:case 11:case 14:case 15:nl(4,f,f.return);break;case 1:Ja(f,f.return);var g=f.stateNode;if("function"==typeof g.componentWillUnmount){r=f,n=f.return;try{t=r,g.props=t.memoizedProps,g.state=t.memoizedState,g.componentWillUnmount()}catch(e){_c(r,n,e)}}break;case 5:Ja(f,f.return);break;case 22:if(null!==f.memoizedState){El(h);continue}}null!==p?(p.return=f,Za=p):El(h)}d=d.sibling}e:for(d=null,h=e;;){if(5===h.tag){if(null===d){d=h;try{i=h.stateNode,u?"function"==typeof(s=i.style).setProperty?s.setProperty("display","none","important"):s.display="none":(l=h.stateNode,a=null!=(c=h.memoizedProps.style)&&c.hasOwnProperty("display")?c.display:null,l.style.display=ge("display",a))}catch(t){_c(e,e.return,t)}}}else if(6===h.tag){if(null===d)try{h.stateNode.nodeValue=u?"":h.memoizedProps}catch(t){_c(e,e.return,t)}}else if((22!==h.tag&&23!==h.tag||null===h.memoizedState||h===e)&&null!==h.child){h.child.return=h,h=h.child;continue}if(h===e)break e;for(;null===h.sibling;){if(null===h.return||h.return===e)break e;d===h&&(d=null),h=h.return}d===h&&(d=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:gl(t,e),yl(e),4&r&&pl(e);case 21:}}function yl(e){var t=e.flags;if(2&t){try{e:{for(var n=e.return;null!==n;){if(sl(n)){var r=n;break e}n=n.return}throw Error(o(160))}switch(r.tag){case 5:var i=r.stateNode;32&r.flags&&(he(i,""),r.flags&=-33),cl(e,al(e),i);break;case 3:case 4:var s=r.stateNode.containerInfo;ll(e,al(e),s);break;default:throw Error(o(161))}}catch(t){_c(e,e.return,t)}e.flags&=-3}4096&t&&(e.flags&=-4097)}function wl(e,t,n){Za=e,bl(e,t,n)}function bl(e,t,n){for(var r=!!(1&e.mode);null!==Za;){var i=Za,o=i.child;if(22===i.tag&&r){var s=null!==i.memoizedState||Ya;if(!s){var a=i.alternate,l=null!==a&&null!==a.memoizedState||Qa;a=Ya;var c=Qa;if(Ya=s,(Qa=l)&&!c)for(Za=i;null!==Za;)l=(s=Za).child,22===s.tag&&null!==s.memoizedState?Sl(i):null!==l?(l.return=s,Za=l):Sl(i);for(;null!==o;)Za=o,bl(o,t,n),o=o.sibling;Za=i,Ya=a,Qa=c}vl(e)}else 8772&i.subtreeFlags&&null!==o?(o.return=i,Za=o):vl(e)}}function vl(e){for(;null!==Za;){var t=Za;if(8772&t.flags){var n=t.alternate;try{if(8772&t.flags)switch(t.tag){case 0:case 11:case 15:Qa||rl(5,t);break;case 1:var r=t.stateNode;if(4&t.flags&&!Qa)if(null===n)r.componentDidMount();else{var i=t.elementType===t.type?n.memoizedProps:na(t.type,n.memoizedProps);r.componentDidUpdate(i,n.memoizedState,r.__reactInternalSnapshotBeforeUpdate)}var s=t.updateQueue;null!==s&&Ko(t,s,r);break;case 3:var a=t.updateQueue;if(null!==a){if(n=null,null!==t.child)switch(t.child.tag){case 5:case 1:n=t.child.stateNode}Ko(t,a,n)}break;case 5:var l=t.stateNode;if(null===n&&4&t.flags){n=l;var c=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":c.autoFocus&&n.focus();break;case"img":c.src&&(n.src=c.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===t.memoizedState){var u=t.alternate;if(null!==u){var d=u.memoizedState;if(null!==d){var h=d.dehydrated;null!==h&&$t(h)}}}break;default:throw Error(o(163))}Qa||512&t.flags&&il(t)}catch(e){_c(t,t.return,e)}}if(t===e){Za=null;break}if(null!==(n=t.sibling)){n.return=t.return,Za=n;break}Za=t.return}}function El(e){for(;null!==Za;){var t=Za;if(t===e){Za=null;break}var n=t.sibling;if(null!==n){n.return=t.return,Za=n;break}Za=t.return}}function Sl(e){for(;null!==Za;){var t=Za;try{switch(t.tag){case 0:case 11:case 15:var n=t.return;try{rl(4,t)}catch(e){_c(t,n,e)}break;case 1:var r=t.stateNode;if("function"==typeof r.componentDidMount){var i=t.return;try{r.componentDidMount()}catch(e){_c(t,i,e)}}var o=t.return;try{il(t)}catch(e){_c(t,o,e)}break;case 5:var s=t.return;try{il(t)}catch(e){_c(t,s,e)}}}catch(e){_c(t,t.return,e)}if(t===e){Za=null;break}var a=t.sibling;if(null!==a){a.return=t.return,Za=a;break}Za=t.return}}var kl,_l=Math.ceil,Rl=v.ReactCurrentDispatcher,Il=v.ReactCurrentOwner,Al=v.ReactCurrentBatchConfig,xl=0,Tl=null,Cl=null,Nl=0,Dl=0,Pl=_i(0),Ll=0,Bl=null,Ol=0,Ml=0,Ul=0,Fl=null,zl=null,Vl=0,$l=1/0,Hl=null,Kl=!1,ql=null,jl=null,Wl=!1,Gl=null,Yl=0,Ql=0,Xl=null,Zl=-1,Jl=0;function ec(){return 6&xl?Xe():-1!==Zl?Zl:Zl=Xe()}function tc(e){return 1&e.mode?2&xl&&0!==Nl?Nl&-Nl:null!==mo.transition?(0===Jl&&(Jl=gt()),Jl):0!==(e=bt)?e:e=void 0===(e=window.event)?16:Qt(e.type):1}function nc(e,t,n,r){if(50<Ql)throw Ql=0,Xl=null,Error(o(185));yt(e,n,r),2&xl&&e===Tl||(e===Tl&&(!(2&xl)&&(Ml|=n),4===Ll&&ac(e,Nl)),rc(e,r),1===n&&0===xl&&!(1&t.mode)&&($l=Xe()+500,Fi&&$i()))}function rc(e,t){var n=e.callbackNode;!function(e,t){for(var n=e.suspendedLanes,r=e.pingedLanes,i=e.expirationTimes,o=e.pendingLanes;0<o;){var s=31-st(o),a=1<<s,l=i[s];-1===l?0!==(a&n)&&0===(a&r)||(i[s]=ft(a,t)):l<=t&&(e.expiredLanes|=a),o&=~a}}(e,t);var r=ht(e,e===Tl?Nl:0);if(0===r)null!==n&&Ge(n),e.callbackNode=null,e.callbackPriority=0;else if(t=r&-r,e.callbackPriority!==t){if(null!=n&&Ge(n),1===t)0===e.tag?function(e){Fi=!0,Vi(e)}(lc.bind(null,e)):Vi(lc.bind(null,e)),si(function(){!(6&xl)&&$i()}),n=null;else{switch(vt(r)){case 1:n=Je;break;case 4:n=et;break;case 16:default:n=tt;break;case 536870912:n=rt}n=Tc(n,ic.bind(null,e))}e.callbackPriority=t,e.callbackNode=n}}function ic(e,t){if(Zl=-1,Jl=0,6&xl)throw Error(o(327));var n=e.callbackNode;if(Sc()&&e.callbackNode!==n)return null;var r=ht(e,e===Tl?Nl:0);if(0===r)return null;if(30&r||0!==(r&e.expiredLanes)||t)t=mc(e,r);else{t=r;var i=xl;xl|=2;var s=pc();for(Tl===e&&Nl===t||(Hl=null,$l=Xe()+500,hc(e,t));;)try{wc();break}catch(t){fc(e,t)}Ao(),Rl.current=s,xl=i,null!==Cl?t=0:(Tl=null,Nl=0,t=Ll)}if(0!==t){if(2===t&&0!==(i=pt(e))&&(r=i,t=oc(e,i)),1===t)throw n=Bl,hc(e,0),ac(e,r),rc(e,Xe()),n;if(6===t)ac(e,r);else{if(i=e.current.alternate,!(30&r||function(e){for(var t=e;;){if(16384&t.flags){var n=t.updateQueue;if(null!==n&&null!==(n=n.stores))for(var r=0;r<n.length;r++){var i=n[r],o=i.getSnapshot;i=i.value;try{if(!ar(o(),i))return!1}catch(e){return!1}}}if(n=t.child,16384&t.subtreeFlags&&null!==n)n.return=t,t=n;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(i)||(t=mc(e,r),2===t&&(s=pt(e),0!==s&&(r=s,t=oc(e,s))),1!==t)))throw n=Bl,hc(e,0),ac(e,r),rc(e,Xe()),n;switch(e.finishedWork=i,e.finishedLanes=r,t){case 0:case 1:throw Error(o(345));case 2:case 5:Ec(e,zl,Hl);break;case 3:if(ac(e,r),(130023424&r)===r&&10<(t=Vl+500-Xe())){if(0!==ht(e,0))break;if(((i=e.suspendedLanes)&r)!==r){ec(),e.pingedLanes|=e.suspendedLanes&i;break}e.timeoutHandle=ri(Ec.bind(null,e,zl,Hl),t);break}Ec(e,zl,Hl);break;case 4:if(ac(e,r),(4194240&r)===r)break;for(t=e.eventTimes,i=-1;0<r;){var a=31-st(r);s=1<<a,(a=t[a])>i&&(i=a),r&=~s}if(r=i,10<(r=(120>(r=Xe()-r)?120:480>r?480:1080>r?1080:1920>r?1920:3e3>r?3e3:4320>r?4320:1960*_l(r/1960))-r)){e.timeoutHandle=ri(Ec.bind(null,e,zl,Hl),r);break}Ec(e,zl,Hl);break;default:throw Error(o(329))}}}return rc(e,Xe()),e.callbackNode===n?ic.bind(null,e):null}function oc(e,t){var n=Fl;return e.current.memoizedState.isDehydrated&&(hc(e,t).flags|=256),2!==(e=mc(e,t))&&(t=zl,zl=n,null!==t&&sc(t)),e}function sc(e){null===zl?zl=e:zl.push.apply(zl,e)}function ac(e,t){for(t&=~Ul,t&=~Ml,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var n=31-st(t),r=1<<n;e[n]=-1,t&=~r}}function lc(e){if(6&xl)throw Error(o(327));Sc();var t=ht(e,0);if(!(1&t))return rc(e,Xe()),null;var n=mc(e,t);if(0!==e.tag&&2===n){var r=pt(e);0!==r&&(t=r,n=oc(e,r))}if(1===n)throw n=Bl,hc(e,0),ac(e,t),rc(e,Xe()),n;if(6===n)throw Error(o(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,Ec(e,zl,Hl),rc(e,Xe()),null}function cc(e,t){var n=xl;xl|=1;try{return e(t)}finally{0===(xl=n)&&($l=Xe()+500,Fi&&$i())}}function uc(e){null!==Gl&&0===Gl.tag&&!(6&xl)&&Sc();var t=xl;xl|=1;var n=Al.transition,r=bt;try{if(Al.transition=null,bt=1,e)return e()}finally{bt=r,Al.transition=n,!(6&(xl=t))&&$i()}}function dc(){Dl=Pl.current,Ri(Pl)}function hc(e,t){e.finishedWork=null,e.finishedLanes=0;var n=e.timeoutHandle;if(-1!==n&&(e.timeoutHandle=-1,ii(n)),null!==Cl)for(n=Cl.return;null!==n;){var r=n;switch(to(r),r.tag){case 1:null!=(r=r.type.childContextTypes)&&Pi();break;case 3:Xo(),Ri(Ti),Ri(xi),rs();break;case 5:Jo(r);break;case 4:Xo();break;case 13:case 19:Ri(es);break;case 10:xo(r.type._context);break;case 22:case 23:dc()}n=n.return}if(Tl=e,Cl=e=Pc(e.current,null),Nl=Dl=t,Ll=0,Bl=null,Ul=Ml=Ol=0,zl=Fl=null,null!==Do){for(t=0;t<Do.length;t++)if(null!==(r=(n=Do[t]).interleaved)){n.interleaved=null;var i=r.next,o=n.pending;if(null!==o){var s=o.next;o.next=i,r.next=s}n.pending=r}Do=null}return e}function fc(e,t){for(;;){var n=Cl;try{if(Ao(),is.current=Zs,us){for(var r=as.memoizedState;null!==r;){var i=r.queue;null!==i&&(i.pending=null),r=r.next}us=!1}if(ss=0,cs=ls=as=null,ds=!1,hs=0,Il.current=null,null===n||null===n.return){Ll=1,Bl=t,Cl=null;break}e:{var s=e,a=n.return,l=n,c=t;if(t=Nl,l.flags|=32768,null!==c&&"object"==typeof c&&"function"==typeof c.then){var u=c,d=l,h=d.tag;if(!(1&d.mode||0!==h&&11!==h&&15!==h)){var f=d.alternate;f?(d.updateQueue=f.updateQueue,d.memoizedState=f.memoizedState,d.lanes=f.lanes):(d.updateQueue=null,d.memoizedState=null)}var p=ma(a);if(null!==p){p.flags&=-257,ya(p,a,l,0,t),1&p.mode&&ga(s,u,t),c=u;var g=(t=p).updateQueue;if(null===g){var m=new Set;m.add(c),t.updateQueue=m}else g.add(c);break e}if(!(1&t)){ga(s,u,t),gc();break e}c=Error(o(426))}else if(io&&1&l.mode){var y=ma(a);if(null!==y){!(65536&y.flags)&&(y.flags|=256),ya(y,a,l,0,t),go(ca(c,l));break e}}s=c=ca(c,l),4!==Ll&&(Ll=2),null===Fl?Fl=[s]:Fl.push(s),s=a;do{switch(s.tag){case 3:s.flags|=65536,t&=-t,s.lanes|=t,$o(s,fa(0,c,t));break e;case 1:l=c;var w=s.type,b=s.stateNode;if(!(128&s.flags||"function"!=typeof w.getDerivedStateFromError&&(null===b||"function"!=typeof b.componentDidCatch||null!==jl&&jl.has(b)))){s.flags|=65536,t&=-t,s.lanes|=t,$o(s,pa(s,l,t));break e}}s=s.return}while(null!==s)}vc(n)}catch(e){t=e,Cl===n&&null!==n&&(Cl=n=n.return);continue}break}}function pc(){var e=Rl.current;return Rl.current=Zs,null===e?Zs:e}function gc(){0!==Ll&&3!==Ll&&2!==Ll||(Ll=4),null===Tl||!(268435455&Ol)&&!(268435455&Ml)||ac(Tl,Nl)}function mc(e,t){var n=xl;xl|=2;var r=pc();for(Tl===e&&Nl===t||(Hl=null,hc(e,t));;)try{yc();break}catch(t){fc(e,t)}if(Ao(),xl=n,Rl.current=r,null!==Cl)throw Error(o(261));return Tl=null,Nl=0,Ll}function yc(){for(;null!==Cl;)bc(Cl)}function wc(){for(;null!==Cl&&!Ye();)bc(Cl)}function bc(e){var t=kl(e.alternate,e,Dl);e.memoizedProps=e.pendingProps,null===t?vc(e):Cl=t,Il.current=null}function vc(e){var t=e;do{var n=t.alternate;if(e=t.return,32768&t.flags){if(null!==(n=Ga(n,t)))return n.flags&=32767,void(Cl=n);if(null===e)return Ll=6,void(Cl=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}else if(null!==(n=Wa(n,t,Dl)))return void(Cl=n);if(null!==(t=t.sibling))return void(Cl=t);Cl=t=e}while(null!==t);0===Ll&&(Ll=5)}function Ec(e,t,n){var r=bt,i=Al.transition;try{Al.transition=null,bt=1,function(e,t,n,r){do{Sc()}while(null!==Gl);if(6&xl)throw Error(o(327));n=e.finishedWork;var i=e.finishedLanes;if(null===n)return null;if(e.finishedWork=null,e.finishedLanes=0,n===e.current)throw Error(o(177));e.callbackNode=null,e.callbackPriority=0;var s=n.lanes|n.childLanes;if(function(e,t){var n=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var r=e.eventTimes;for(e=e.expirationTimes;0<n;){var i=31-st(n),o=1<<i;t[i]=0,r[i]=-1,e[i]=-1,n&=~o}}(e,s),e===Tl&&(Cl=Tl=null,Nl=0),!(2064&n.subtreeFlags)&&!(2064&n.flags)||Wl||(Wl=!0,Tc(tt,function(){return Sc(),null})),s=!!(15990&n.flags),15990&n.subtreeFlags||s){s=Al.transition,Al.transition=null;var a=bt;bt=1;var l=xl;xl|=4,Il.current=null,function(e,t){if(ei=Kt,fr(e=hr())){if("selectionStart"in e)var n={start:e.selectionStart,end:e.selectionEnd};else e:{var r=(n=(n=e.ownerDocument)&&n.defaultView||window).getSelection&&n.getSelection();if(r&&0!==r.rangeCount){n=r.anchorNode;var i=r.anchorOffset,s=r.focusNode;r=r.focusOffset;try{n.nodeType,s.nodeType}catch(e){n=null;break e}var a=0,l=-1,c=-1,u=0,d=0,h=e,f=null;t:for(;;){for(var p;h!==n||0!==i&&3!==h.nodeType||(l=a+i),h!==s||0!==r&&3!==h.nodeType||(c=a+r),3===h.nodeType&&(a+=h.nodeValue.length),null!==(p=h.firstChild);)f=h,h=p;for(;;){if(h===e)break t;if(f===n&&++u===i&&(l=a),f===s&&++d===r&&(c=a),null!==(p=h.nextSibling))break;f=(h=f).parentNode}h=p}n=-1===l||-1===c?null:{start:l,end:c}}else n=null}n=n||{start:0,end:0}}else n=null;for(ti={focusedElem:e,selectionRange:n},Kt=!1,Za=t;null!==Za;)if(e=(t=Za).child,1028&t.subtreeFlags&&null!==e)e.return=t,Za=e;else for(;null!==Za;){t=Za;try{var g=t.alternate;if(1024&t.flags)switch(t.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==g){var m=g.memoizedProps,y=g.memoizedState,w=t.stateNode,b=w.getSnapshotBeforeUpdate(t.elementType===t.type?m:na(t.type,m),y);w.__reactInternalSnapshotBeforeUpdate=b}break;case 3:var v=t.stateNode.containerInfo;1===v.nodeType?v.textContent="":9===v.nodeType&&v.documentElement&&v.removeChild(v.documentElement);break;default:throw Error(o(163))}}catch(e){_c(t,t.return,e)}if(null!==(e=t.sibling)){e.return=t.return,Za=e;break}Za=t.return}g=tl,tl=!1}(e,n),ml(n,e),pr(ti),Kt=!!ei,ti=ei=null,e.current=n,wl(n,e,i),Qe(),xl=l,bt=a,Al.transition=s}else e.current=n;if(Wl&&(Wl=!1,Gl=e,Yl=i),0===(s=e.pendingLanes)&&(jl=null),function(e){if(ot&&"function"==typeof ot.onCommitFiberRoot)try{ot.onCommitFiberRoot(it,e,void 0,!(128&~e.current.flags))}catch(e){}}(n.stateNode),rc(e,Xe()),null!==t)for(r=e.onRecoverableError,n=0;n<t.length;n++)r((i=t[n]).value,{componentStack:i.stack,digest:i.digest});if(Kl)throw Kl=!1,e=ql,ql=null,e;!!(1&Yl)&&0!==e.tag&&Sc(),1&(s=e.pendingLanes)?e===Xl?Ql++:(Ql=0,Xl=e):Ql=0,$i()}(e,t,n,r)}finally{Al.transition=i,bt=r}return null}function Sc(){if(null!==Gl){var e=vt(Yl),t=Al.transition,n=bt;try{if(Al.transition=null,bt=16>e?16:e,null===Gl)var r=!1;else{if(e=Gl,Gl=null,Yl=0,6&xl)throw Error(o(331));var i=xl;for(xl|=4,Za=e.current;null!==Za;){var s=Za,a=s.child;if(16&Za.flags){var l=s.deletions;if(null!==l){for(var c=0;c<l.length;c++){var u=l[c];for(Za=u;null!==Za;){var d=Za;switch(d.tag){case 0:case 11:case 15:nl(8,d,s)}var h=d.child;if(null!==h)h.return=d,Za=h;else for(;null!==Za;){var f=(d=Za).sibling,p=d.return;if(ol(d),d===u){Za=null;break}if(null!==f){f.return=p,Za=f;break}Za=p}}}var g=s.alternate;if(null!==g){var m=g.child;if(null!==m){g.child=null;do{var y=m.sibling;m.sibling=null,m=y}while(null!==m)}}Za=s}}if(2064&s.subtreeFlags&&null!==a)a.return=s,Za=a;else e:for(;null!==Za;){if(2048&(s=Za).flags)switch(s.tag){case 0:case 11:case 15:nl(9,s,s.return)}var w=s.sibling;if(null!==w){w.return=s.return,Za=w;break e}Za=s.return}}var b=e.current;for(Za=b;null!==Za;){var v=(a=Za).child;if(2064&a.subtreeFlags&&null!==v)v.return=a,Za=v;else e:for(a=b;null!==Za;){if(2048&(l=Za).flags)try{switch(l.tag){case 0:case 11:case 15:rl(9,l)}}catch(e){_c(l,l.return,e)}if(l===a){Za=null;break e}var E=l.sibling;if(null!==E){E.return=l.return,Za=E;break e}Za=l.return}}if(xl=i,$i(),ot&&"function"==typeof ot.onPostCommitFiberRoot)try{ot.onPostCommitFiberRoot(it,e)}catch(e){}r=!0}return r}finally{bt=n,Al.transition=t}}return!1}function kc(e,t,n){e=zo(e,t=fa(0,t=ca(n,t),1),1),t=ec(),null!==e&&(yt(e,1,t),rc(e,t))}function _c(e,t,n){if(3===e.tag)kc(e,e,n);else for(;null!==t;){if(3===t.tag){kc(t,e,n);break}if(1===t.tag){var r=t.stateNode;if("function"==typeof t.type.getDerivedStateFromError||"function"==typeof r.componentDidCatch&&(null===jl||!jl.has(r))){t=zo(t,e=pa(t,e=ca(n,e),1),1),e=ec(),null!==t&&(yt(t,1,e),rc(t,e));break}}t=t.return}}function Rc(e,t,n){var r=e.pingCache;null!==r&&r.delete(t),t=ec(),e.pingedLanes|=e.suspendedLanes&n,Tl===e&&(Nl&n)===n&&(4===Ll||3===Ll&&(130023424&Nl)===Nl&&500>Xe()-Vl?hc(e,0):Ul|=n),rc(e,t)}function Ic(e,t){0===t&&(1&e.mode?(t=ut,!(130023424&(ut<<=1))&&(ut=4194304)):t=1);var n=ec();null!==(e=Bo(e,t))&&(yt(e,t,n),rc(e,n))}function Ac(e){var t=e.memoizedState,n=0;null!==t&&(n=t.retryLane),Ic(e,n)}function xc(e,t){var n=0;switch(e.tag){case 13:var r=e.stateNode,i=e.memoizedState;null!==i&&(n=i.retryLane);break;case 19:r=e.stateNode;break;default:throw Error(o(314))}null!==r&&r.delete(t),Ic(e,n)}function Tc(e,t){return We(e,t)}function Cc(e,t,n,r){this.tag=e,this.key=n,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=r,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Nc(e,t,n,r){return new Cc(e,t,n,r)}function Dc(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Pc(e,t){var n=e.alternate;return null===n?((n=Nc(e.tag,t,e.key,e.mode)).elementType=e.elementType,n.type=e.type,n.stateNode=e.stateNode,n.alternate=e,e.alternate=n):(n.pendingProps=t,n.type=e.type,n.flags=0,n.subtreeFlags=0,n.deletions=null),n.flags=14680064&e.flags,n.childLanes=e.childLanes,n.lanes=e.lanes,n.child=e.child,n.memoizedProps=e.memoizedProps,n.memoizedState=e.memoizedState,n.updateQueue=e.updateQueue,t=e.dependencies,n.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},n.sibling=e.sibling,n.index=e.index,n.ref=e.ref,n}function Lc(e,t,n,r,i,s){var a=2;if(r=e,"function"==typeof e)Dc(e)&&(a=1);else if("string"==typeof e)a=5;else e:switch(e){case k:return Bc(n.children,i,s,t);case _:a=8,i|=8;break;case R:return(e=Nc(12,n,t,2|i)).elementType=R,e.lanes=s,e;case T:return(e=Nc(13,n,t,i)).elementType=T,e.lanes=s,e;case C:return(e=Nc(19,n,t,i)).elementType=C,e.lanes=s,e;case P:return Oc(n,i,s,t);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case I:a=10;break e;case A:a=9;break e;case x:a=11;break e;case N:a=14;break e;case D:a=16,r=null;break e}throw Error(o(130,null==e?e:typeof e,""))}return(t=Nc(a,n,t,i)).elementType=e,t.type=r,t.lanes=s,t}function Bc(e,t,n,r){return(e=Nc(7,e,r,t)).lanes=n,e}function Oc(e,t,n,r){return(e=Nc(22,e,r,t)).elementType=P,e.lanes=n,e.stateNode={isHidden:!1},e}function Mc(e,t,n){return(e=Nc(6,e,null,t)).lanes=n,e}function Uc(e,t,n){return(t=Nc(4,null!==e.children?e.children:[],e.key,t)).lanes=n,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function Fc(e,t,n,r,i){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=mt(0),this.expirationTimes=mt(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=mt(0),this.identifierPrefix=r,this.onRecoverableError=i,this.mutableSourceEagerHydrationData=null}function zc(e,t,n,r,i,o,s,a,l){return e=new Fc(e,t,n,a,l),1===t?(t=1,!0===o&&(t|=8)):t=0,o=Nc(3,null,null,t),e.current=o,o.stateNode=e,o.memoizedState={element:r,isDehydrated:n,cache:null,transitions:null,pendingSuspenseBoundaries:null},Mo(o),e}function Vc(e){if(!e)return Ai;e:{if($e(e=e._reactInternals)!==e||1!==e.tag)throw Error(o(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(Di(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(o(171))}if(1===e.tag){var n=e.type;if(Di(n))return Bi(e,n,t)}return t}function $c(e,t,n,r,i,o,s,a,l){return(e=zc(n,r,!0,e,0,o,0,a,l)).context=Vc(null),n=e.current,(o=Fo(r=ec(),i=tc(n))).callback=null!=t?t:null,zo(n,o,i),e.current.lanes=i,yt(e,i,r),rc(e,r),e}function Hc(e,t,n,r){var i=t.current,o=ec(),s=tc(i);return n=Vc(n),null===t.context?t.context=n:t.pendingContext=n,(t=Fo(o,s)).payload={element:e},null!==(r=void 0===r?null:r)&&(t.callback=r),null!==(e=zo(i,t,s))&&(nc(e,i,s,o),Vo(e,i,s)),s}function Kc(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function qc(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var n=e.retryLane;e.retryLane=0!==n&&n<t?n:t}}function jc(e,t){qc(e,t),(e=e.alternate)&&qc(e,t)}kl=function(e,t,n){if(null!==e)if(e.memoizedProps!==t.pendingProps||Ti.current)ba=!0;else{if(0===(e.lanes&n)&&!(128&t.flags))return ba=!1,function(e,t,n){switch(t.tag){case 3:Ta(t),po();break;case 5:Zo(t);break;case 1:Di(t.type)&&Oi(t);break;case 4:Qo(t,t.stateNode.containerInfo);break;case 10:var r=t.type._context,i=t.memoizedProps.value;Ii(ko,r._currentValue),r._currentValue=i;break;case 13:if(null!==(r=t.memoizedState))return null!==r.dehydrated?(Ii(es,1&es.current),t.flags|=128,null):0!==(n&t.child.childLanes)?Ma(e,t,n):(Ii(es,1&es.current),null!==(e=Ka(e,t,n))?e.sibling:null);Ii(es,1&es.current);break;case 19:if(r=0!==(n&t.childLanes),128&e.flags){if(r)return $a(e,t,n);t.flags|=128}if(null!==(i=t.memoizedState)&&(i.rendering=null,i.tail=null,i.lastEffect=null),Ii(es,es.current),r)break;return null;case 22:case 23:return t.lanes=0,_a(e,t,n)}return Ka(e,t,n)}(e,t,n);ba=!!(131072&e.flags)}else ba=!1,io&&1048576&t.flags&&Ji(t,ji,t.index);switch(t.lanes=0,t.tag){case 2:var r=t.type;Ha(e,t),e=t.pendingProps;var i=Ni(t,xi.current);Co(t,n),i=ms(null,t,r,e,i,n);var s=ys();return t.flags|=1,"object"==typeof i&&null!==i&&"function"==typeof i.render&&void 0===i.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,Di(r)?(s=!0,Oi(t)):s=!1,t.memoizedState=null!==i.state&&void 0!==i.state?i.state:null,Mo(t),i.updater=ia,t.stateNode=i,i._reactInternals=t,la(t,r,e,n),t=xa(null,t,r,!0,s,n)):(t.tag=0,io&&s&&eo(t),va(null,t,i,n),t=t.child),t;case 16:r=t.elementType;e:{switch(Ha(e,t),e=t.pendingProps,r=(i=r._init)(r._payload),t.type=r,i=t.tag=function(e){if("function"==typeof e)return Dc(e)?1:0;if(null!=e){if((e=e.$$typeof)===x)return 11;if(e===N)return 14}return 2}(r),e=na(r,e),i){case 0:t=Ia(null,t,r,e,n);break e;case 1:t=Aa(null,t,r,e,n);break e;case 11:t=Ea(null,t,r,e,n);break e;case 14:t=Sa(null,t,r,na(r.type,e),n);break e}throw Error(o(306,r,""))}return t;case 0:return r=t.type,i=t.pendingProps,Ia(e,t,r,i=t.elementType===r?i:na(r,i),n);case 1:return r=t.type,i=t.pendingProps,Aa(e,t,r,i=t.elementType===r?i:na(r,i),n);case 3:e:{if(Ta(t),null===e)throw Error(o(387));r=t.pendingProps,i=(s=t.memoizedState).element,Uo(e,t),Ho(t,r,null,n);var a=t.memoizedState;if(r=a.element,s.isDehydrated){if(s={element:r,isDehydrated:!1,cache:a.cache,pendingSuspenseBoundaries:a.pendingSuspenseBoundaries,transitions:a.transitions},t.updateQueue.baseState=s,t.memoizedState=s,256&t.flags){t=Ca(e,t,r,n,i=ca(Error(o(423)),t));break e}if(r!==i){t=Ca(e,t,r,n,i=ca(Error(o(424)),t));break e}for(ro=ci(t.stateNode.containerInfo.firstChild),no=t,io=!0,oo=null,n=So(t,null,r,n),t.child=n;n;)n.flags=-3&n.flags|4096,n=n.sibling}else{if(po(),r===i){t=Ka(e,t,n);break e}va(e,t,r,n)}t=t.child}return t;case 5:return Zo(t),null===e&&co(t),r=t.type,i=t.pendingProps,s=null!==e?e.memoizedProps:null,a=i.children,ni(r,i)?a=null:null!==s&&ni(r,s)&&(t.flags|=32),Ra(e,t),va(e,t,a,n),t.child;case 6:return null===e&&co(t),null;case 13:return Ma(e,t,n);case 4:return Qo(t,t.stateNode.containerInfo),r=t.pendingProps,null===e?t.child=Eo(t,null,r,n):va(e,t,r,n),t.child;case 11:return r=t.type,i=t.pendingProps,Ea(e,t,r,i=t.elementType===r?i:na(r,i),n);case 7:return va(e,t,t.pendingProps,n),t.child;case 8:case 12:return va(e,t,t.pendingProps.children,n),t.child;case 10:e:{if(r=t.type._context,i=t.pendingProps,s=t.memoizedProps,a=i.value,Ii(ko,r._currentValue),r._currentValue=a,null!==s)if(ar(s.value,a)){if(s.children===i.children&&!Ti.current){t=Ka(e,t,n);break e}}else for(null!==(s=t.child)&&(s.return=t);null!==s;){var l=s.dependencies;if(null!==l){a=s.child;for(var c=l.firstContext;null!==c;){if(c.context===r){if(1===s.tag){(c=Fo(-1,n&-n)).tag=2;var u=s.updateQueue;if(null!==u){var d=(u=u.shared).pending;null===d?c.next=c:(c.next=d.next,d.next=c),u.pending=c}}s.lanes|=n,null!==(c=s.alternate)&&(c.lanes|=n),To(s.return,n,t),l.lanes|=n;break}c=c.next}}else if(10===s.tag)a=s.type===t.type?null:s.child;else if(18===s.tag){if(null===(a=s.return))throw Error(o(341));a.lanes|=n,null!==(l=a.alternate)&&(l.lanes|=n),To(a,n,t),a=s.sibling}else a=s.child;if(null!==a)a.return=s;else for(a=s;null!==a;){if(a===t){a=null;break}if(null!==(s=a.sibling)){s.return=a.return,a=s;break}a=a.return}s=a}va(e,t,i.children,n),t=t.child}return t;case 9:return i=t.type,r=t.pendingProps.children,Co(t,n),r=r(i=No(i)),t.flags|=1,va(e,t,r,n),t.child;case 14:return i=na(r=t.type,t.pendingProps),Sa(e,t,r,i=na(r.type,i),n);case 15:return ka(e,t,t.type,t.pendingProps,n);case 17:return r=t.type,i=t.pendingProps,i=t.elementType===r?i:na(r,i),Ha(e,t),t.tag=1,Di(r)?(e=!0,Oi(t)):e=!1,Co(t,n),sa(t,r,i),la(t,r,i,n),xa(null,t,r,!0,e,n);case 19:return $a(e,t,n);case 22:return _a(e,t,n)}throw Error(o(156,t.tag))};var Wc="function"==typeof reportError?reportError:function(e){console.error(e)};function Gc(e){this._internalRoot=e}function Yc(e){this._internalRoot=e}function Qc(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function Xc(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function Zc(){}function Jc(e,t,n,r,i){var o=n._reactRootContainer;if(o){var s=o;if("function"==typeof i){var a=i;i=function(){var e=Kc(s);a.call(e)}}Hc(t,s,e,i)}else s=function(e,t,n,r,i){if(i){if("function"==typeof r){var o=r;r=function(){var e=Kc(s);o.call(e)}}var s=$c(t,r,e,0,null,!1,0,"",Zc);return e._reactRootContainer=s,e[pi]=s.current,$r(8===e.nodeType?e.parentNode:e),uc(),s}for(;i=e.lastChild;)e.removeChild(i);if("function"==typeof r){var a=r;r=function(){var e=Kc(l);a.call(e)}}var l=zc(e,0,!1,null,0,!1,0,"",Zc);return e._reactRootContainer=l,e[pi]=l.current,$r(8===e.nodeType?e.parentNode:e),uc(function(){Hc(t,l,n,r)}),l}(n,t,e,i,r);return Kc(s)}Yc.prototype.render=Gc.prototype.render=function(e){var t=this._internalRoot;if(null===t)throw Error(o(409));Hc(e,t,null,null)},Yc.prototype.unmount=Gc.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var t=e.containerInfo;uc(function(){Hc(null,e,null,null)}),t[pi]=null}},Yc.prototype.unstable_scheduleHydration=function(e){if(e){var t=_t();e={blockedOn:null,target:e,priority:t};for(var n=0;n<Pt.length&&0!==t&&t<Pt[n].priority;n++);Pt.splice(n,0,e),0===n&&Mt(e)}},Et=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var n=dt(t.pendingLanes);0!==n&&(wt(t,1|n),rc(t,Xe()),!(6&xl)&&($l=Xe()+500,$i()))}break;case 13:uc(function(){var t=Bo(e,1);if(null!==t){var n=ec();nc(t,e,1,n)}}),jc(e,1)}},St=function(e){if(13===e.tag){var t=Bo(e,134217728);null!==t&&nc(t,e,134217728,ec()),jc(e,134217728)}},kt=function(e){if(13===e.tag){var t=tc(e),n=Bo(e,t);null!==n&&nc(n,e,t,ec()),jc(e,t)}},_t=function(){return bt},Rt=function(e,t){var n=bt;try{return bt=e,t()}finally{bt=n}},Se=function(e,t,n){switch(t){case"input":if(Z(e,n),t=n.name,"radio"===n.type&&null!=t){for(n=e;n.parentNode;)n=n.parentNode;for(n=n.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<n.length;t++){var r=n[t];if(r!==e&&r.form===e.form){var i=Ei(r);if(!i)throw Error(o(90));W(r),Z(r,i)}}}break;case"textarea":oe(e,n);break;case"select":null!=(t=n.value)&&ne(e,!!n.multiple,t,!1)}},xe=cc,Te=uc;var eu={usingClientEntryPoint:!1,Events:[bi,vi,Ei,Ie,Ae,cc]},tu={findFiberByHostInstance:wi,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},nu={bundleType:tu.bundleType,version:tu.version,rendererPackageName:tu.rendererPackageName,rendererConfig:tu.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:v.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=qe(e))?null:e.stateNode},findFiberByHostInstance:tu.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var ru=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!ru.isDisabled&&ru.supportsFiber)try{it=ru.inject(nu),ot=ru}catch(ue){}}t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=eu,t.createPortal=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Qc(t))throw Error(o(200));return function(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:S,key:null==r?null:""+r,children:e,containerInfo:t,implementation:n}}(e,t,null,n)},t.createRoot=function(e,t){if(!Qc(e))throw Error(o(299));var n=!1,r="",i=Wc;return null!=t&&(!0===t.unstable_strictMode&&(n=!0),void 0!==t.identifierPrefix&&(r=t.identifierPrefix),void 0!==t.onRecoverableError&&(i=t.onRecoverableError)),t=zc(e,1,!1,null,0,n,0,r,i),e[pi]=t.current,$r(8===e.nodeType?e.parentNode:e),new Gc(t)},t.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"==typeof e.render)throw Error(o(188));throw e=Object.keys(e).join(","),Error(o(268,e))}return null===(e=qe(t))?null:e.stateNode},t.flushSync=function(e){return uc(e)},t.hydrate=function(e,t,n){if(!Xc(t))throw Error(o(200));return Jc(null,e,t,!0,n)},t.hydrateRoot=function(e,t,n){if(!Qc(e))throw Error(o(405));var r=null!=n&&n.hydratedSources||null,i=!1,s="",a=Wc;if(null!=n&&(!0===n.unstable_strictMode&&(i=!0),void 0!==n.identifierPrefix&&(s=n.identifierPrefix),void 0!==n.onRecoverableError&&(a=n.onRecoverableError)),t=$c(t,null,e,1,null!=n?n:null,i,0,s,a),e[pi]=t.current,$r(e),r)for(e=0;e<r.length;e++)i=(i=(n=r[e])._getVersion)(n._source),null==t.mutableSourceEagerHydrationData?t.mutableSourceEagerHydrationData=[n,i]:t.mutableSourceEagerHydrationData.push(n,i);return new Yc(t)},t.render=function(e,t,n){if(!Xc(t))throw Error(o(200));return Jc(null,e,t,!1,n)},t.unmountComponentAtNode=function(e){if(!Xc(e))throw Error(o(40));return!!e._reactRootContainer&&(uc(function(){Jc(null,null,e,!1,function(){e._reactRootContainer=null,e[pi]=null})}),!0)},t.unstable_batchedUpdates=cc,t.unstable_renderSubtreeIntoContainer=function(e,t,n,r){if(!Xc(n))throw Error(o(200));if(null==e||void 0===e._reactInternals)throw Error(o(38));return Jc(e,t,n,!1,r)},t.version="18.3.1-next-f1338f8080-20240426"},939:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const e=this.pullQueue.shift();e&&e.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),void 0!==this.highWaterMark&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(void 0!==this.lowWaterMark&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((e,t)=>{this.pullQueue.push({resolve:e,reject:t})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class r{constructor(e,{highWaterMark:t=100,lowWaterMark:r=1}={}){const i=new n;i.highWaterMark=t,i.lowWaterMark=r,i.removeCallback=e({push:e=>i.push(e),stop:()=>i.stop(),fail:e=>i.fail(e),on:(e,t)=>{i.eventHandlers[e]=t}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}}t.EventIterator=r,t.default=r},961:(e,t,n)=>{"use strict";!function e(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(e){console.error(e)}}(),e.exports=n(932)},982:(e,t,n)=>{"use strict";e.exports=n(463)}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e={};n.r(e),n.d(e,{base10:()=>yt});var t={};n.r(t),n.d(t,{base16:()=>wt,base16upper:()=>bt});var r={};n.r(r),n.d(r,{base2:()=>vt});var i={};n.r(i),n.d(i,{base256emoji:()=>_t});var o={};n.r(o),n.d(o,{base32:()=>Rt,base32hex:()=>Tt,base32hexpad:()=>Nt,base32hexpadupper:()=>Dt,base32hexupper:()=>Ct,base32pad:()=>At,base32padupper:()=>xt,base32upper:()=>It,base32z:()=>Pt});var s={};n.r(s),n.d(s,{base36:()=>Lt,base36upper:()=>Bt});var a={};n.r(a),n.d(a,{base58btc:()=>Ot,base58flickr:()=>Mt});var l={};n.r(l),n.d(l,{base64:()=>Ut,base64pad:()=>Ft,base64url:()=>zt,base64urlpad:()=>Vt});var c={};n.r(c),n.d(c,{base8:()=>$t});var u={};n.r(u),n.d(u,{identity:()=>Ht});var d={};n.r(d),n.d(d,{code:()=>Wt,decode:()=>Yt,encode:()=>Gt,name:()=>jt});var h={};n.r(h),n.d(h,{code:()=>Xt,decode:()=>Jt,encode:()=>Zt,name:()=>Qt});var f={};n.r(f),n.d(f,{identity:()=>kn});var p={};n.r(p),n.d(p,{sha256:()=>xn,sha512:()=>Tn});var g={};n.r(g),n.d(g,{abortedError:()=>Ws,closeFailedError:()=>Vs,deleteFailedError:()=>Ks,getFailedError:()=>Hs,hasFailedError:()=>qs,notFoundError:()=>js,openFailedError:()=>zs,putFailedError:()=>$s});var m={};n.r(m),n.d(m,{code:()=>Du,createLink:()=>Cu,createNode:()=>Tu,decode:()=>Lu,encode:()=>Pu,name:()=>Nu,prepare:()=>Au,validate:()=>xu});var y={};n.r(y),n.d(y,{Ed25519PrivateKey:()=>jf,Ed25519PublicKey:()=>qf,generateKeyPair:()=>Yf,generateKeyPairFromSeed:()=>Qf,unmarshalEd25519PrivateKey:()=>Wf,unmarshalEd25519PublicKey:()=>Gf});var w={};n.r(w),n.d(w,{MAX_RSA_KEY_SIZE:()=>fm,RsaPrivateKey:()=>gm,RsaPublicKey:()=>pm,fromJwk:()=>wm,generateKeyPair:()=>bm,unmarshalRsaPrivateKey:()=>mm,unmarshalRsaPublicKey:()=>ym});var b={};n.r(b),n.d(b,{Secp256k1PrivateKey:()=>$m,Secp256k1PublicKey:()=>Vm,generateKeyPair:()=>qm,unmarshalSecp256k1PrivateKey:()=>Hm,unmarshalSecp256k1PublicKey:()=>Km});var v=n(848),E=n(540),S=n(338);const k=(e,...t)=>{};function _(e){const t=new globalThis.AbortController;function n(){t.abort();for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",n)}for(const t of e){if(!0===t?.aborted){n();break}null!=t?.addEventListener&&t.addEventListener("abort",n)}const r=t.signal;return r.clear=function(){for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",n)},r}class R extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return null==t?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let r=this.#e.get(e);null==r&&(r=[],this.#e.set(e,r)),r.push({callback:t,once:(!0!==n&&!1!==n&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let r=this.#e.get(e);null!=r&&(r=r.filter(({callback:e})=>e!==t),this.#e.set(e,r))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return null==n||(n=n.filter(({once:e})=>!e),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new I(e,t))}}const I=globalThis.CustomEvent;class A extends Error{code;type;constructor(e="The operation was aborted"){super(e),this.name="AbortError",this.code=A.code,this.type=A.type}static code="ABORT_ERR";static type="aborted"}class x extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}}class T extends AggregateError{code;props;constructor(e,t,n,r){super(e,t),this.code=n,this.name=r?.name??"AggregateCodeError",this.props=r??{}}}Error,Error,Error;const C="ERR_TIMEOUT",N="ERR_INVALID_MESSAGE";function D(){const e={};return e.promise=new Promise((t,n)=>{e.resolve=t,e.reject=n}),e}class P{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class L{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new P(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=e?.byteLength?e.byteLength:1}push(e){if(null!=e?.value&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new P(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(void 0===e&&null!=this.tail.next){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return null!=e?.value&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}class B extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}}function O(e={}){return function(e,t){let n,r,i,o=(t=t??{}).onEnd,s=new L,a=D();const l=e=>null!=r?r(e):(s.push(e),n),c=e=>{if(i)return n;if(!0!==t?.objectMode&&null==e?.byteLength)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},u=e=>i?n:(i=!0,null!=e?(e=>(s=new L,null!=r?r({error:e}):(s.push({error:e}),n)))(e):l({done:!0}));if(n={[Symbol.asyncIterator](){return this},next:async()=>{try{return s.isEmpty()?i?{done:!0}:await new Promise((t,i)=>{r=o=>{r=null,s.push(o);try{t(e(s))}catch(e){i(e)}return n}}):e(s)}finally{s.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=D()})}},return:()=>(s=new L,u(),{done:!0}),throw:e=>(u(e),{done:!0}),push:c,end:u,get readableLength(){return s.size},onEmpty:async e=>{const t=e?.signal;if(t?.throwIfAborted(),s.isEmpty())return;let n,r;null!=t&&(n=new Promise((e,n)=>{r=()=>{n(new B)},t.addEventListener("abort",r)}));try{await Promise.race([a.promise,n])}finally{null!=r&&null!=t&&t?.removeEventListener("abort",r)}}},null==o)return n;const d=n;return n={[Symbol.asyncIterator](){return this},next:()=>d.next(),throw:e=>(d.throw(e),null!=o&&(o(e),o=void 0),{done:!0}),return:()=>(d.return(),null!=o&&(o(),o=void 0),{done:!0}),push:c,end:e=>(d.end(e),null!=o&&(o(e),o=void 0),n),get readableLength(){return d.readableLength},onEmpty:e=>d.onEmpty(e)},n}(e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}},e)}class M extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}}async function U(e,t,n,r){const i=new M(r?.errorMessage);null!=r?.errorCode&&(i.code=r.errorCode);const o=r?.errorEvent??"error";return!0===n?.aborted?Promise.reject(i):new Promise((s,a)=>{function l(){z(n,"abort",d),z(e,t,c),z(e,o,u)}const c=e=>{try{if(!1===r?.filter?.(e))return}catch(e){return l(),void a(e)}l(),s(e)},u=e=>{l(),e instanceof Error?a(e):a(e.detail??r?.error??new Error(`The "${r?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},d=()=>{l(),a(i)};F(n,"abort",d),F(e,t,c),F(e,o,u)})}function F(e,t,n){null!=e&&(V(e)?e.addEventListener(t,n):e.addListener(t,n))}function z(e,t,n){null!=e&&(V(e)?e.removeEventListener(t,n):e.removeListener(t,n))}function V(e){return"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}class $ extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}}async function H(e,t,n){if(null==t)return e;if(t.aborted)return e.catch(()=>{}),Promise.reject(new $(n?.errorMessage,n?.errorCode,n?.errorName));let r;const i=new $(n?.errorMessage,n?.errorCode,n?.errorName);try{return await Promise.race([e,new Promise((e,n)=>{r=()=>{n(i)},t.addEventListener("abort",r)})])}finally{null!=r&&t.removeEventListener("abort",r)}}class K{deferred;signal;constructor(e){this.signal=e,this.deferred=D(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new A)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}class q{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((e,t)=>e&&!0===t.signal?.aborted,!0)&&(this.controller.abort(new A),this.cleanup())}async join(e={}){const t=new K(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await H(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}class j extends R{concurrency;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.pending=0,null!=e.metricName&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(0===this.size)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),0===this.running&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}async add(e,t){t?.signal?.throwIfAborted();const n=new q(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(e=>(this.safeDispatchEvent("completed",{detail:e}),this.safeDispatchEvent("success",{detail:{job:n,result:e}}),e)).catch(e=>{if("queued"===n.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===n){this.queue.splice(e,1);break}throw this.safeDispatchEvent("error",{detail:e}),this.safeDispatchEvent("failure",{detail:{job:n,error:e}}),e})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new A)}),this.clear()}async onEmpty(e){0!==this.size&&await U(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await U(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await U(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=O({objectMode:!0}),n=e=>{null!=e?this.abort():this.clear(),t.end(e)},r=e=>{null!=e.detail&&t.push(e.detail)},i=e=>{n(e.detail)},o=()=>{n()},s=()=>{n(new x("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",r),this.addEventListener("error",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",s);try{yield*t}finally{this.removeEventListener("completed",r),this.removeEventListener("error",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",s),n()}}}class W extends j{has(e){return null!=this.find(e)}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}const G=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{for await(const t of e);})();for(const t of e);};function Y(e=0){return new Uint8Array(e)}function Q(e=0){return new Uint8Array(e)}const X=Math.pow(2,7),Z=Math.pow(2,14),J=Math.pow(2,21),ee=Math.pow(2,28),te=Math.pow(2,35),ne=Math.pow(2,42),re=Math.pow(2,49),ie=128,oe=127;function se(e){if(e<X)return 1;if(e<Z)return 2;if(e<J)return 3;if(e<ee)return 4;if(e<te)return 5;if(e<ne)return 6;if(e<re)return 7;if(null!=Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function ae(e,t,n=0){switch(se(e)){case 8:t[n++]=255&e|ie,e/=128;case 7:t[n++]=255&e|ie,e/=128;case 6:t[n++]=255&e|ie,e/=128;case 5:t[n++]=255&e|ie,e/=128;case 4:t[n++]=255&e|ie,e>>>=7;case 3:t[n++]=255&e|ie,e>>>=7;case 2:t[n++]=255&e|ie,e>>>=7;case 1:t[n++]=255&e,e>>>=7;break;default:throw new Error("unreachable")}return t}function le(e,t){let n=e[t],r=0;if(r+=n&oe,n<ie)return r;if(n=e[t+1],r+=(n&oe)<<7,n<ie)return r;if(n=e[t+2],r+=(n&oe)<<14,n<ie)return r;if(n=e[t+3],r+=(n&oe)<<21,n<ie)return r;if(n=e[t+4],r+=(n&oe)*ee,n<ie)return r;if(n=e[t+5],r+=(n&oe)*te,n<ie)return r;if(n=e[t+6],r+=(n&oe)*ne,n<ie)return r;if(n=e[t+7],r+=(n&oe)*re,n<ie)return r;throw new RangeError("Could not decode varint")}function ce(e,t,n=0){return null==t&&(t=Q(se(e))),t instanceof Uint8Array?ae(e,t,n):function(e,t,n=0){switch(se(e)){case 8:t.set(n++,255&e|ie),e/=128;case 7:t.set(n++,255&e|ie),e/=128;case 6:t.set(n++,255&e|ie),e/=128;case 5:t.set(n++,255&e|ie),e/=128;case 4:t.set(n++,255&e|ie),e>>>=7;case 3:t.set(n++,255&e|ie),e>>>=7;case 2:t.set(n++,255&e|ie),e>>>=7;case 1:t.set(n++,255&e),e>>>=7;break;default:throw new Error("unreachable")}return t}(e,t,n)}function ue(e,t=0){return e instanceof Uint8Array?le(e,t):function(e,t){let n=e.get(t),r=0;if(r+=n&oe,n<ie)return r;if(n=e.get(t+1),r+=(n&oe)<<7,n<ie)return r;if(n=e.get(t+2),r+=(n&oe)<<14,n<ie)return r;if(n=e.get(t+3),r+=(n&oe)<<21,n<ie)return r;if(n=e.get(t+4),r+=(n&oe)*ee,n<ie)return r;if(n=e.get(t+5),r+=(n&oe)*te,n<ie)return r;if(n=e.get(t+6),r+=(n&oe)*ne,n<ie)return r;if(n=e.get(t+7),r+=(n&oe)*re,n<ie)return r;throw new RangeError("Could not decode varint")}(e,t)}function de(e,t){null==t&&(t=e.reduce((e,t)=>e+t.length,0));const n=Q(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return n}function he(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}const fe=Symbol.for("@achingbrain/uint8arraylist");function pe(e,t){if(null==t||t<0)throw new RangeError("index is out of bounds");let n=0;for(const r of e){const e=n+r.byteLength;if(t<e)return{buf:r,index:t-n};n=e}throw new RangeError("index is out of bounds")}function ge(e){return Boolean(e?.[fe])}class me{bufs;length;[fe]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else{if(!ge(n))throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");t+=n.byteLength,this.bufs.push(...n.bufs)}this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else{if(!ge(n))throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");t+=n.byteLength,this.bufs.unshift(...n.bufs)}this.length+=t}get(e){const t=pe(this.bufs,e);return t.buf[t.index]}set(e,t){const n=pe(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else{if(!ge(e))throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList");for(let n=0;n<e.length;n++)this.set(t+n,e.get(n))}}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength)return this.bufs=[],void(this.length=0);for(;this.bufs.length>0;){if(!(e>=this.bufs[0].byteLength)){this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift()}}}slice(e,t){const{bufs:n,length:r}=this._subList(e,t);return de(n,r)}subarray(e,t){const{bufs:n,length:r}=this._subList(e,t);return 1===n.length?n[0]:de(n,r)}sublist(e,t){const{bufs:n,length:r}=this._subList(e,t),i=new me;return i.length=r,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(0===e&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let r=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],s=r,a=s+o.byteLength;if(r=a,e>=a)continue;const l=e>=s&&e<a,c=t>s&&t<=a;if(l&&c){if(e===s&&t===a){n.push(o);break}const r=e-s;n.push(o.subarray(r,r+(t-e)));break}if(l){if(0===e){n.push(o);continue}n.push(o.subarray(e-s))}else{if(c){if(t===a){n.push(o);break}n.push(o.subarray(0,t-s));break}n.push(o)}}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!(ge(e)||e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;const r=n.byteLength;if(0===r)throw new TypeError("search must be at least 1 byte long");const i=new Int32Array(256);for(let e=0;e<256;e++)i[e]=-1;for(let e=0;e<r;e++)i[n[e]]=e;const o=i,s=this.byteLength-n.byteLength,a=n.byteLength-1;let l;for(let e=t;e<=s;e+=l){l=0;for(let t=a;t>=0;t--){const r=this.get(e+t);if(n[t]!==r){l=Math.max(1,t-o[r]);break}}if(0===l)return e}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=Q(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const r=Y(2);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt16(0,t,n),this.write(r,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const r=Y(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt32(0,t,n),this.write(r,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const r=Y(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setBigInt64(0,t,n),this.write(r,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=Q(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const r=Y(2);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint16(0,t,n),this.write(r,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const r=Y(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint32(0,t,n),this.write(r,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const r=Y(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setBigUint64(0,t,n),this.write(r,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const r=Y(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setFloat32(0,t,n),this.write(r,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const r=Y(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setFloat64(0,t,n),this.write(r,e)}equals(e){if(null==e)return!1;if(!(e instanceof me))return!1;if(e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!he(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new me;return n.bufs=e,null==t&&(t=e.reduce((e,t)=>e+t.byteLength,0)),n.length=t,n}}function ye(e){return null!=e[Symbol.asyncIterator]}const we=e=>{const t=se(e),n=Q(t);return ce(e,n),we.bytes=t,n};function be(e,t){const n=(t=t??{}).lengthEncoder??we;function*r(e){const t=n(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return ye(e)?async function*(){for await(const t of e)yield*r(t)}():function*(){for(const t of e)yield*r(t)}()}we.bytes=0,be.single=(e,t)=>{const n=(t=t??{}).lengthEncoder??we;return new me(n(e.byteLength),e)};class ve extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class Ee extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class Se extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}class ke extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}var _e;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(_e||(_e={}));const Re=e=>{const t=ue(e);return Re.bytes=se(t),t};function Ie(e,t){const n=new me;let r=_e.LENGTH,i=-1;const o=t?.lengthDecoder??Re,s=t?.maxLengthLength??8,a=t?.maxDataLength??4194304;function*l(){for(;n.byteLength>0;){if(r===_e.LENGTH)try{if(i=o(n),i<0)throw new ve("Invalid message length");if(i>a)throw new Ee("Message length too long");const e=o.bytes;n.consume(e),null!=t?.onLength&&t.onLength(i),r=_e.DATA}catch(e){if(e instanceof RangeError){if(n.byteLength>s)throw new Se("Message length length too long");break}throw e}if(r===_e.DATA){if(n.byteLength<i)break;const e=n.sublist(0,i);n.consume(i),null!=t?.onData&&t.onData(e),yield e,r=_e.LENGTH}}}return ye(e)?async function*(){for await(const t of e)n.append(t),yield*l();if(n.byteLength>0)throw new ke("Unexpected end of input")}():function*(){for(const t of e)n.append(t),yield*l();if(n.byteLength>0)throw new ke("Unexpected end of input")}()}Re.bytes=0,Ie.fromReader=(e,t)=>{let n=1;return Ie(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{n=1}}(),{...t??{},onLength:e=>{n=e}})};const Ae=function(e){const[t,n]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>t.next(),push:e=>{r.push(e)},next:()=>r.length>0?{done:!1,value:r.shift()}:t.next(),[n](){return this}}},xe=function(e,t){let n=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const r of e)yield t(r,n++)}();const r=Ae(e),{value:i,done:o}=r.next();if(!0===o)return function*(){}();const s=t(i,n++);if("function"==typeof s.then)return async function*(){yield await s;for(const e of r)yield t(e,n++)}();const a=t;return function*(){yield s;for(const e of r)yield a(e,n++)}()};class Te{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=D(),this.haveNext=D()}[Symbol.asyncIterator](){return this}async next(){if(null==this.nextResult&&await this.haveNext.promise,null==this.nextResult)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=D(),e}async throw(e){return this.ended=!0,this.error=e,null!=e&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){null!=e?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(null!=e&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;null!=this.nextResult;)await this.readNext.promise;null!=e?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=D(),await H(this.readNext.promise,t?.signal,t)}}function Ce(e){return null!=e[Symbol.asyncIterator]}const Ne=function(...e){const t=[];for(const n of e)Ce(n)||t.push(n);return t.length===e.length?function*(e){for(const t of e)yield*t}(t):async function*(e){const t=new AbortController,n=new Te;(async function(e,t,n){try{await Promise.all(e.map(async e=>{for await(const r of e)await t.push(r,{signal:n}),n.throwIfAborted()})),await t.end(void 0,{signal:n})}catch(e){await t.end(e,{signal:n}).catch(()=>{})}})(e,n,t.signal).catch(()=>{});try{yield*n}finally{t.abort()}}(e)};function De(e,...t){if(null==e)throw new Error("Empty pipeline");if(Oe(e)){const t=e;e=()=>t.source}else if(Be(e)||Le(e)){const t=e;e=()=>t}const n=[e,...t];if(n.length>1&&Oe(n[n.length-1])&&(n[n.length-1]=n[n.length-1].sink),n.length>2)for(let e=1;e<n.length-1;e++)Oe(n[e])&&(n[e]=Me(n[e]));return Pe(...n)}const Pe=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},Le=e=>null!=e?.[Symbol.asyncIterator],Be=e=>null!=e?.[Symbol.iterator],Oe=e=>null!=e&&null!=e.sink&&null!=e.source,Me=e=>t=>{const n=e.sink(t);if(null!=n?.then){const t=O({objectMode:!0});let r;n.then(()=>{t.end()},e=>{t.end(e)});const i=e.source;if(Le(i))r=async function*(){yield*i,t.end()};else{if(!Be(i))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*i,t.end()}}return Ne(t,r())}return e.source},Ue=function(e,t){return null!=e[Symbol.asyncIterator]?async function*(){let n=0;if(!(t<1))for await(const r of e)if(yield r,n++,n===t)return}():function*(){let n=0;if(!(t<1))for(const r of e)if(yield r,n++,n===t)return}()};class Fe extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}const ze="/ipfs/bitswap/1.2.0",Ve=4194304,$e=Ve,He=new Float32Array([-0]),Ke=new Uint8Array(He.buffer);function qe(e,t,n){He[0]=e,t[n]=Ke[0],t[n+1]=Ke[1],t[n+2]=Ke[2],t[n+3]=Ke[3]}const je=new Float64Array([-0]),We=new Uint8Array(je.buffer);function Ge(e,t,n){je[0]=e,t[n]=We[0],t[n+1]=We[1],t[n+2]=We[2],t[n+3]=We[3],t[n+4]=We[4],t[n+5]=We[5],t[n+6]=We[6],t[n+7]=We[7]}const Ye=BigInt(Number.MAX_SAFE_INTEGER),Qe=BigInt(Number.MIN_SAFE_INTEGER);class Xe{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}toNumber(e=!1){if(!e&&this.hi>>>31>0){const e=1+~this.lo>>>0;let t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(e+4294967296*t)}return this.lo+4294967296*this.hi}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31!=0){const e=1+~this.lo>>>0;let t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(BigInt(e)+(BigInt(t)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return 0===n?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(0n===e)return Ze;if(e<Ye&&e>Qe)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,r=e-(n<<32n);return t&&(n=0n|~n,r=0n|~r,++r>Je&&(r=0n,++n>Je&&(n=0n))),new Xe(Number(r),Number(n))}static fromNumber(e){if(0===e)return Ze;const t=e<0;t&&(e=-e);let n=e>>>0,r=(e-n)/4294967296>>>0;return t&&(r=~r>>>0,n=~n>>>0,++n>4294967295&&(n=0,++r>4294967295&&(r=0))),new Xe(n,r)}static from(e){return"number"==typeof e?Xe.fromNumber(e):"bigint"==typeof e?Xe.fromBigInt(e):"string"==typeof e?Xe.fromBigInt(BigInt(e)):null!=e.low||null!=e.high?new Xe(e.low>>>0,e.high>>>0):Ze}}const Ze=new Xe(0,0);Ze.toBigInt=function(){return 0n},Ze.zzEncode=Ze.zzDecode=function(){return this},Ze.length=function(){return 1};const Je=4294967296n;function et(e,t,n){const r=n;let i,o;for(let r=0;r<e.length;++r)i=e.charCodeAt(r),i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&56320==(64512&(o=e.charCodeAt(r+1)))?(i=65536+((1023&i)<<10)+(1023&o),++r,t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128);return n-r}function tt(e,t){return RangeError(`index out of range: ${e.pos} + ${t??1} > ${e.len}`)}function nt(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}class rt{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return e;if((this.pos+=5)>this.len)throw this.pos=this.len,tt(this,10);return e}int32(){return 0|this.uint32()}sint32(){const e=this.uint32();return e>>>1^-(1&e)}bool(){return 0!==this.uint32()}fixed32(){if(this.pos+4>this.len)throw tt(this,4);return nt(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw tt(this,4);return 0|nt(this.buf,this.pos+=4)}float(){if(this.pos+4>this.len)throw tt(this,4);const e=function(e,t){return Ke[0]=e[t],Ke[1]=e[t+1],Ke[2]=e[t+2],Ke[3]=e[t+3],He[0]}(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw tt(this,4);const e=function(e,t){return We[0]=e[t],We[1]=e[t+1],We[2]=e[t+2],We[3]=e[t+3],We[4]=e[t+4],We[5]=e[t+5],We[6]=e[t+6],We[7]=e[t+7],je[0]}(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw tt(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return function(e,t,n){if(n-t<1)return"";let r;const i=[];let o,s=0;for(;t<n;)o=e[t++],o<128?i[s++]=o:o>191&&o<224?i[s++]=(31&o)<<6|63&e[t++]:o>239&&o<365?(o=((7&o)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,i[s++]=55296+(o>>10),i[s++]=56320+(1023&o)):i[s++]=(15&o)<<12|(63&e[t++])<<6|63&e[t++],s>8191&&((r??(r=[])).push(String.fromCharCode.apply(String,i)),s=0);return null!=r?(s>0&&r.push(String.fromCharCode.apply(String,i.slice(0,s))),r.join("")):String.fromCharCode.apply(String,i.slice(0,s))}(e,0,e.length)}skip(e){if("number"==typeof e){if(this.pos+e>this.len)throw tt(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw tt(this)}while(128&this.buf[this.pos++]);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new Xe(0,0);let t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw tt(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw tt(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw tt(this,8);const e=nt(this.buf,this.pos+=4),t=nt(this.buf,this.pos+=4);return new Xe(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=le(this.buf,this.pos);return this.pos+=se(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function it(e,t,n){const r=function(e){return new rt(e instanceof Uint8Array?e:e.subarray())}(e);return t.decode(r,void 0,n)}const ot=new Uint8Array(0);function st(e){const t=e.match(/../g);return null!=t?new Uint8Array(t.map(e=>parseInt(e,16))):ot}function at(e){if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")}const lt=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,l=e.charAt(0),c=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function d(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===l;)r++,t++;for(var o=(e.length-t)*c+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var d=0,h=o-1;(0!==u||d<i)&&-1!==h;h--,d++)u+=a*s[h]>>>0,s[h]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=d,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,c=new Uint8Array(s);i!==o;){for(var d=t[i],h=0,f=s-1;(0!==d||h<r)&&-1!==f;f--,h++)d+=256*c[f]>>>0,c[f]=d%a>>>0,d=d/a>>>0;if(0!==d)throw new Error("Non-zero carry");r=h,i++}for(var p=s-r;p!==s&&0===c[p];)p++;for(var g=l.repeat(n);p<s;++p)g+=e.charAt(c[p]);return g},decodeUnsafe:d,decode:function(e){var n=d(e);if(n)return n;throw new Error(`Non-${t} character`)}}};class ct{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class ut{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const r=t.codePointAt(0);if(void 0===r)throw new Error("Invalid prefix character");this.prefixCodePoint=r,this.baseDecode=n}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return ht(this,e)}}class dt{decoders;constructor(e){this.decoders=e}or(e){return ht(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(null!=n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function ht(e,t){return new dt({...e.decoders??{[e.prefix]:e},...t.decoders??{[t.prefix]:t}})}class ft{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new ct(e,t,n),this.decoder=new ut(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function pt({name:e,prefix:t,encode:n,decode:r}){return new ft(e,t,n,r)}function gt({name:e,prefix:t,alphabet:n}){const{encode:r,decode:i}=lt(n,e);return pt({prefix:t,name:e,encode:r,decode:e=>at(i(e))})}function mt({name:e,prefix:t,bitsPerChar:n,alphabet:r}){const i=function(e){const t={};for(let n=0;n<e.length;++n)t[e[n]]=n;return t}(r);return pt({prefix:t,name:e,encode:e=>function(e,t,n){const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let r=0;r<e.length;++r)for(a=a<<8|e[r],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(0!==s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o}(e,r,n),decode:t=>function(e,t,n,r){let i=e.length;for(;"="===e[i-1];)--i;const o=new Uint8Array(i*n/8|0);let s=0,a=0,l=0;for(let c=0;c<i;++c){const i=t[e[c]];if(void 0===i)throw new SyntaxError(`Non-${r} character`);a=a<<n|i,s+=n,s>=8&&(s-=8,o[l++]=255&a>>s)}if(s>=n||255&a<<8-s)throw new SyntaxError("Unexpected end of data");return o}(t,i,n,e)})}const yt=gt({prefix:"9",name:"base10",alphabet:"0123456789"}),wt=mt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),bt=mt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),vt=mt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Et=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),St=Et.reduce((e,t,n)=>(e[n]=t,e),[]),kt=Et.reduce((e,t,n)=>{const r=t.codePointAt(0);if(null==r)throw new Error(`Invalid character: ${t}`);return e[r]=n,e},[]),_t=pt({prefix:"🚀",name:"base256emoji",encode:function(e){return e.reduce((e,t)=>e+St[t],"")},decode:function(e){const t=[];for(const n of e){const e=n.codePointAt(0);if(null==e)throw new Error(`Invalid character: ${n}`);const r=kt[e];if(null==r)throw new Error(`Non-base256emoji character: ${n}`);t.push(r)}return new Uint8Array(t)}}),Rt=mt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),It=mt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),At=mt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),xt=mt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Tt=mt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Ct=mt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Nt=mt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Dt=mt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Pt=mt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Lt=gt({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Bt=gt({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Ot=gt({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Mt=gt({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Ut=mt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Ft=mt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),zt=mt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Vt=mt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),$t=mt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Ht=pt({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>function(e){return(new TextEncoder).encode(e)}(e)}),Kt=new TextEncoder,qt=new TextDecoder,jt="json",Wt=512;function Gt(e){return Kt.encode(JSON.stringify(e))}function Yt(e){return JSON.parse(qt.decode(e))}const Qt="raw",Xt=85;function Zt(e){return at(e)}function Jt(e){return at(e)}var en=128,tn=-128,nn=Math.pow(2,31),rn=128,on=127,sn=Math.pow(2,7),an=Math.pow(2,14),ln=Math.pow(2,21),cn=Math.pow(2,28),un=Math.pow(2,35),dn=Math.pow(2,42),hn=Math.pow(2,49),fn=Math.pow(2,56),pn=Math.pow(2,63);const gn={encode:function e(t,n,r){n=n||[];for(var i=r=r||0;t>=nn;)n[r++]=255&t|en,t/=128;for(;t&tn;)n[r++]=255&t|en,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},decode:function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&on)<<o:(r&on)*Math.pow(2,o),o+=7}while(r>=rn);return e.bytes=s-n,i},encodingLength:function(e){return e<sn?1:e<an?2:e<ln?3:e<cn?4:e<un?5:e<dn?6:e<hn?7:e<fn?8:e<pn?9:10}};function mn(e,t=0){return[gn.decode(e,t),gn.decode.bytes]}function yn(e,t,n=0){return gn.encode(e,t,n),t}function wn(e){return gn.encodingLength(e)}function bn(e,t){const n=t.byteLength,r=wn(e),i=r+wn(n),o=new Uint8Array(i+n);return yn(e,o,0),yn(n,o,r),o.set(t,i),new En(e,n,t,o)}function vn(e){const t=at(e),[n,r]=mn(t),[i,o]=mn(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new En(n,i,s,t)}class En{code;size;digest;bytes;constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const Sn=at,kn={code:0,name:"identity",encode:Sn,digest:function(e,t){if(null!=t?.truncate&&t.truncate!==e.byteLength){if(t.truncate<0||t.truncate>e.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${e.byteLength}`);e=e.subarray(0,t.truncate)}return bn(0,Sn(e))}};function _n({name:e,code:t,encode:n,minDigestLength:r,maxDigestLength:i}){return new Rn(e,t,n,r,i)}class Rn{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,r,i){this.name=e,this.code=t,this.encode=n,this.minDigestLength=r??20,this.maxDigestLength=i}digest(e,t){if(null!=t?.truncate){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(null!=this.maxDigestLength&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?In(n,this.code,t?.truncate):n.then(e=>In(e,this.code,t?.truncate))}throw Error("Unknown type, must be binary type")}}function In(e,t,n){if(null!=n&&n!==e.byteLength){if(n>e.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${e.byteLength}`);e=e.subarray(0,n)}return bn(t,e)}function An(e){return async t=>new Uint8Array(await crypto.subtle.digest(e,t))}const xn=_n({name:"sha2-256",code:18,encode:An("SHA-256")}),Tn=_n({name:"sha2-512",code:19,encode:An("SHA-512")});function Cn(e,t){const{bytes:n,version:r}=e;return 0===r?function(e,t,n){const{prefix:r}=n;if(r!==Ot.prefix)throw Error(`Cannot string encode V0 in ${n.name} encoding`);const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i}(n,Dn(e),t??Ot.encoder):function(e,t,n){const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i}(n,Dn(e),t??Rt.encoder)}const Nn=new WeakMap;function Dn(e){const t=Nn.get(e);if(null==t){const t=new Map;return Nn.set(e,t),t}return t}class Pn{code;version;multihash;bytes;"/";constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ln)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Bn)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Pn.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=bn(e,t);return Pn.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Pn.equals(this,e)}static equals(e,t){const n=t;return null!=n&&e.code===n.code&&e.version===n.version&&function(e,t){if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0}(e.bytes,n.bytes)}}(e.multihash,n.multihash)}toString(e){return Cn(this,e)}toJSON(){return{"/":Cn(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(null==e)return null;const t=e;if(t instanceof Pn)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new Pn(e,n,r,i??On(e,n,r.bytes))}if(!0===t[Mn]){const{version:e,multihash:n,code:r}=t,i=vn(n);return Pn.create(e,r,i)}return null}static create(e,t,n){if("number"!=typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==Ln)throw new Error(`Version 0 CID must use dag-pb (code: ${Ln}) block encoding`);return new Pn(e,t,n,n.bytes);case 1:{const r=On(e,t,n.bytes);return new Pn(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return Pn.create(0,Ln,e)}static createV1(e,t){return Pn.create(1,e,t)}static decode(e){const[t,n]=Pn.decodeFirst(e);if(0!==n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Pn.inspectBytes(e),n=t.size-t.multihashSize,r=at(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new En(t.multihashCode,t.digestSize,i,r);return[0===t.version?Pn.createV0(o):Pn.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=mn(e.subarray(t));return t+=r,n};let r=n(),i=Ln;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError(`Invalid CID version ${r}`);const o=t,s=n(),a=n(),l=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:l-o,size:l}}static parse(e,t){const[n,r]=function(e,t){switch(e[0]){case"Q":{const n=t??Ot;return[Ot.prefix,n.decode(`${Ot.prefix}${e}`)]}case Ot.prefix:{const n=t??Ot;return[Ot.prefix,n.decode(e)]}case Rt.prefix:{const n=t??Rt;return[Rt.prefix,n.decode(e)]}case Lt.prefix:{const n=t??Lt;return[Lt.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}}(e,t),i=Pn.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return Dn(i).set(n,e),i}}const Ln=112,Bn=18;function On(e,t,n){const r=wn(e),i=r+wn(t),o=new Uint8Array(i+n.byteLength);return yn(e,o,0),yn(t,o,r),o.set(n,i),o}const Mn=Symbol.for("@ipld/js-cid/CID"),Un={...u,...r,...c,...e,...t,...o,...s,...a,...l,...i};function Fn(e,t,n,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:n},decoder:{decode:r}}}const zn=Fn("utf8","u",e=>"u"+new TextDecoder("utf8").decode(e),e=>(new TextEncoder).encode(e.substring(1))),Vn=Fn("ascii","a",e=>{let t="a";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t},e=>{const t=Q((e=e.substring(1)).length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}),$n={utf8:zn,"utf-8":zn,hex:Un.base16,latin1:Vn,ascii:Vn,binary:Vn,...Un};function Hn(e,t="utf8"){const n=$n[t];if(null==n)throw new Error(`Unsupported encoding "${t}"`);return n.decoder.decode(`${n.prefix}${e}`)}class Kn{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function qn(){}class jn{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const Wn=function(){const e=8192;let t,n=e;return function(r){if(r<1||r>4096)return Q(r);n+r>e&&(t=Q(e),n=0);const i=t.subarray(n,n+=r);return 7&n&&(n=1+(7|n)),i}}();class Gn{len;head;tail;states;constructor(){this.len=0,this.head=new Kn(qn,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Kn(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new Xn((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Zn,10,Xe.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=Xe.fromBigInt(e);return this._push(Zn,t.length(),t)}uint64Number(e){return this._push(ae,se(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=Xe.fromBigInt(e).zzEncode();return this._push(Zn,t.length(),t)}sint64Number(e){const t=Xe.fromNumber(e).zzEncode();return this._push(Zn,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(Yn,1,e?1:0)}fixed32(e){return this._push(Jn,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=Xe.fromBigInt(e);return this._push(Jn,4,t.lo)._push(Jn,4,t.hi)}fixed64Number(e){const t=Xe.fromNumber(e);return this._push(Jn,4,t.lo)._push(Jn,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(qe,4,e)}double(e){return this._push(Ge,8,e)}bytes(e){const t=e.length>>>0;return 0===t?this._push(Yn,1,0):this.uint32(t)._push(er,t,e)}string(e){const t=function(e){let t=0,n=0;for(let r=0;r<e.length;++r)n=e.charCodeAt(r),n<128?t+=1:n<2048?t+=2:55296==(64512&n)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t}(e);return 0!==t?this.uint32(t)._push(et,t,e):this._push(Yn,1,0)}fork(){return this.states=new jn(this),this.head=this.tail=new Kn(qn,0,0),this.len=0,this}reset(){return null!=this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Kn(qn,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),0!==n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=(n=this.len,null!=globalThis.Buffer?Q(n):Wn(n));var n;let r=0;for(;null!=e;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t}}function Yn(e,t,n){t[n]=255&e}function Qn(e,t,n){for(;e>127;)t[n++]=127&e|128,e>>>=7;t[n]=e}class Xn extends Kn{next;constructor(e,t){super(Qn,e,t),this.next=void 0}}function Zn(e,t,n){for(;0!==e.hi;)t[n++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[n++]=127&e.lo|128,e.lo=e.lo>>>7;t[n++]=e.lo}function Jn(e,t,n){t[n]=255&e,t[n+1]=e>>>8&255,t[n+2]=e>>>16&255,t[n+3]=e>>>24}function er(e,t,n){t.set(e,n)}function tr(e,t,n){t.set(e,n)}function nr(e,t,n){e.length<40?et(e,t,n):null!=t.utf8Write?t.utf8Write(e,n):t.set(Hn(e),n)}function rr(e,t){const n=new Gn;return t.encode(e,n,{lengthDelimited:!1}),n.finish()}var ir,or,sr,ar,lr,cr,ur,dr,hr,fr;function pr(e,t,n,r){return{name:e,type:t,encode:n,decode:r}}function gr(e){function t(t){if(null==e[t.toString()])throw new Error("Invalid enum value");return e[t]}return pr("enum",ir.VARINT,function(e,n){const r=t(e);n.int32(r)},function(e){return t(e.int32())})}function mr(e,t){return pr("message",ir.LENGTH_DELIMITED,e,t)}null!=globalThis.Buffer&&(Gn.prototype.bytes=function(e){const t=e.length>>>0;return this.uint32(t),t>0&&this._push(tr,t,e),this},Gn.prototype.string=function(e){const t=globalThis.Buffer.byteLength(e);return this.uint32(t),t>0&&this._push(nr,t,e),this}),function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(ir||(ir={}));class yr extends Error{code;constructor(e,t){super(e),this.code=t}}function wr(e,t,n,r,i,o){let s=0,a=!1;for(let l=n;l<e.length;l++){const n=e[l],c=o(n);if(c>4193664)throw new x("Cannot send block as after encoding it is over the max message size","ERR_BLOCK_TOO_LARGE");const u=i+c;if(u>r){a=!0;break}t.push(n),s++,i=u}return{hasMore:a,added:s,newSize:i}}function br(e){return Sr(3,cr.encode(e))}function vr(e){return Sr(4,hr.encode(e))}function Er(e){return Sr(1,ar.encode(e))}function Sr(e,t){return se(e)+se(t.byteLength)+t.byteLength}!function(e){e.WantBlock="WantBlock",e.WantHave="WantHave"}(or||(or={})),function(e){e[e.WantBlock=0]="WantBlock",e[e.WantHave=1]="WantHave"}(sr||(sr={})),function(e){e.codec=()=>gr(sr)}(or||(or={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.cid&&e.cid.byteLength>0&&(t.uint32(10),t.bytes(e.cid)),null!=e.priority&&0!==e.priority&&(t.uint32(16),t.int32(e.priority)),null!=e.cancel&&(t.uint32(24),t.bool(e.cancel)),null!=e.wantType&&(t.uint32(32),or.codec().encode(e.wantType,t)),null!=e.sendDontHave&&(t.uint32(40),t.bool(e.sendDontHave)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={cid:Y(0),priority:0},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.cid=e.bytes();break;case 2:r.priority=e.int32();break;case 3:r.cancel=e.bool();break;case 4:r.wantType=or.codec().decode(e);break;case 5:r.sendDontHave=e.bool();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(ar||(ar={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.entries)for(const n of e.entries)t.uint32(10),ar.codec().encode(n,t);null!=e.full&&(t.uint32(16),t.bool(e.full)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={entries:[]},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:if(null!=n.limits?.entries&&r.entries.length===n.limits.entries)throw new yr('decode error - map field "entries" had too many elements',"ERR_MAX_LENGTH");r.entries.push(ar.codec().decode(e,e.uint32(),{limits:n.limits?.entries$}));break;case 2:r.full=e.bool();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(lr||(lr={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.prefix&&e.prefix.byteLength>0&&(t.uint32(10),t.bytes(e.prefix)),null!=e.data&&e.data.byteLength>0&&(t.uint32(18),t.bytes(e.data)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={prefix:Y(0),data:Y(0)},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.prefix=e.bytes();break;case 2:r.data=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(cr||(cr={})),function(e){e.HaveBlock="HaveBlock",e.DontHaveBlock="DontHaveBlock"}(ur||(ur={})),function(e){e[e.HaveBlock=0]="HaveBlock",e[e.DontHaveBlock=1]="DontHaveBlock"}(dr||(dr={})),function(e){e.codec=()=>gr(dr)}(ur||(ur={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.cid&&e.cid.byteLength>0&&(t.uint32(10),t.bytes(e.cid)),null!=e.type&&0!==dr[e.type]&&(t.uint32(16),ur.codec().encode(e.type,t)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={cid:Y(0),type:ur.HaveBlock},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.cid=e.bytes();break;case 2:r.type=ur.codec().decode(e);break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(hr||(hr={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.wantlist&&(t.uint32(10),lr.codec().encode(e.wantlist,t)),null!=e.blocks)for(const n of e.blocks)t.uint32(26),cr.codec().encode(n,t);if(null!=e.blockPresences)for(const n of e.blockPresences)t.uint32(34),hr.codec().encode(n,t);null!=e.pendingBytes&&0!==e.pendingBytes&&(t.uint32(40),t.int32(e.pendingBytes)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={blocks:[],blockPresences:[],pendingBytes:0},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.wantlist=lr.codec().decode(e,e.uint32(),{limits:n.limits?.wantlist});break;case 3:if(null!=n.limits?.blocks&&r.blocks.length===n.limits.blocks)throw new yr('decode error - map field "blocks" had too many elements',"ERR_MAX_LENGTH");r.blocks.push(cr.codec().decode(e,e.uint32(),{limits:n.limits?.blocks$}));break;case 4:if(null!=n.limits?.blockPresences&&r.blockPresences.length===n.limits.blockPresences)throw new yr('decode error - map field "blockPresences" had too many elements',"ERR_MAX_LENGTH");r.blockPresences.push(hr.codec().decode(e,e.uint32(),{limits:n.limits?.blockPresences$}));break;case 5:r.pendingBytes=e.int32();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(fr||(fr={}));class kr extends R{log;libp2p;routing;protocols;running;maxInboundStreams;maxOutboundStreams;messageReceiveTimeout;registrarIds;metrics;sendQueue;runOnTransientConnections;maxOutgoingMessageSize;maxIncomingMessageSize;constructor(e,t={}){super(),this.log=e.logger.forComponent("helia:bitswap:network"),this.libp2p=e.libp2p,this.routing=e.routing,this.protocols=t.protocols??[ze],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=t.maxInboundStreams??1024,this.maxOutboundStreams=t.maxOutboundStreams??1024,this.messageReceiveTimeout=t.messageReceiveTimeout??5e3,this.runOnTransientConnections=t.runOnTransientConnections??!1,this.maxIncomingMessageSize=t.maxIncomingMessageSize??Ve,this.maxOutgoingMessageSize=t.maxOutgoingMessageSize??t.maxIncomingMessageSize??$e,this.metrics={blocksSent:e.metrics?.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:e.metrics?.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new W({concurrency:t.messageSendConcurrency??50,metrics:e.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",e=>{this.log.error("error sending wantlist to peer",e.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnections});const e={onConnect:e=>{this.safeDispatchEvent("peer:connected",{detail:e})},onDisconnect:e=>{this.safeDispatchEvent("peer:disconnected",{detail:e})}};this.registrarIds=[];for(const t of this.protocols)this.registrarIds.push(await this.libp2p.register(t,e));this.libp2p.getConnections().forEach(e=>{this.safeDispatchEvent("peer:connected",{detail:e.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),null!=this.registrarIds){for(const e of this.registrarIds)this.libp2p.unregister(e);this.registrarIds=[]}}_onStream(e){if(!this.running)return;const{stream:t,connection:n}=e;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",t.protocol,n.remotePeer);const e=()=>{"open"===t.status?t.abort(new x(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`,"ERR_TIMEOUT")):this.log("stream aborted with status %s",t.status)};let r=AbortSignal.timeout(this.messageReceiveTimeout);r.addEventListener("abort",e),await t.closeWrite(),await De(t,e=>Ie(e,{maxDataLength:this.maxIncomingMessageSize}),async i=>{for await(const o of i)try{const i=fr.decode(o);this.log("incoming new bitswap %s message from %p on stream",t.protocol,n.remotePeer,t.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:n.remotePeer,message:i}}),r.removeEventListener("abort",e),r=AbortSignal.timeout(this.messageReceiveTimeout),k(),r.addEventListener("abort",e)}catch(e){this.log.error("error reading incoming bitswap message from %p on stream",n.remotePeer,t.id,e),t.abort(e);break}})}).catch(e=>{this.log.error("error handling incoming stream from %p",n.remotePeer,e),t.abort(e)})}async*findProviders(e,t){t?.onProgress?.(new Fe("bitswap:network:find-providers",e));for await(const n of this.routing.findProviders(e,t))await this.libp2p.isDialable(n.multiaddrs,{runOnTransientConnection:this.runOnTransientConnections})&&(yield n)}async findAndConnect(e,t){await G(xe(Ue(this.findProviders(e,t),t?.maxProviders??3),async e=>this.connectTo(e.id,t))).catch(e=>{this.log.error(e)})}async sendMessage(e,t,n){if(!this.running)throw new Error("network isn't running");const r=this.sendQueue.queue.find(t=>e.equals(t.options.peerId)&&"queued"===t.status);if(null!=r)return r.options.message=function(e,t){for(const[n,r]of t.wantlist.entries()){const t=e.wantlist.get(n);null!=t&&(t.priority>r.priority&&(r.priority=t.priority),r.cancel=r.cancel??t.cancel,r.wantType=r.wantType??t.wantType,r.sendDontHave=r.sendDontHave??t.sendDontHave),e.wantlist.set(n,r)}for(const[n,r]of t.blockPresences.entries())e.blockPresences.set(n,r);for(const[n,r]of t.blocks.entries())e.blocks.set(n,r);return t.full&&!e.full&&(e.full=!0),e}(r.options.message,t),void await r.join({signal:n?.signal});await this.sendQueue.add(async t=>{const n=t?.message;if(null==n)throw new x("No message to send","ERR_NO_MESSAGE");this.log("sendMessage to %p",e),t?.onProgress?.(new Fe("bitswap:network:send-wantlist",e));const r=await this.libp2p.dialProtocol(e,ze,t);await r.closeRead();try{await De(function*(e,t){const n=[...e.wantlist.values()],r=[...e.blockPresences.values()],i=[...e.blocks.values()];let o=0,s=0,a=0,l=!1;for(;;){const c={wantlist:{full:e.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let u=fr.encode(c).byteLength,{added:d,hasMore:h,newSize:f}=wr(i,c.blocks,a,t,u,br);a+=d,u=f;const p=h;({added:d,hasMore:h,newSize:f}=wr(r,c.blockPresences,s,t,u,vr)),s+=d,u=f;const g=h;if(({added:d,hasMore:h,newSize:f}=wr(n,c.wantlist.entries,o,t,u,Er)),o+=d,u=f,l=!p&&!g&&!h,l||(c.wantlist.full=!1),yield fr.encode(c),l)break}}(n,this.maxOutgoingMessageSize),e=>be(e),r),await r.close(t)}catch(n){t?.onProgress?.(new Fe("bitswap:network:send-wantlist:error",{peer:e,error:n})),this.log.error("error sending message to %p",e,n),r.abort(n)}this._updateSentStats(n.blocks)},{peerId:e,signal:n?.signal,message:t})}async connectTo(e,t){if(!this.running)throw new x("Network isn't running","ERR_NOT_STARTED");t?.onProgress?.(new Fe("bitswap:network:dial",e));const[n]=await Promise.all([this.libp2p.dial(e,t),U(this.libp2p,"peer:identify",t?.signal,{filter:t=>{if(!t.detail.peerId.equals(e))return!1;if(t.detail.protocols.includes(ze))return!0;throw new x(`${e} did not support ${ze}`,"ERR_BITSWAP_UNSUPPORTED_BY_PEER")}})]);return n}_updateSentStats(e){let t=0;for(const n of e.values())t+=n.data.byteLength;this.metrics.dataSent?.increment(t),this.metrics.blocksSent?.increment(e.size)}}const _r=Symbol.for("@libp2p/peer-id");function Rr(e){return null!=e&&Boolean(e[_r])}function Ir(e,t="utf8"){const n=$n[t];if(null==n)throw new Error(`Unsupported encoding "${t}"`);return n.encoder.encode(e).substring(1)}const Ar=Symbol.for("nodejs.util.inspect.custom"),xr=Object.values(Un).map(e=>e.decoder).reduce((e,t)=>e.or(t),Un.identity.decoder);class Tr{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[_r]=!0;toString(){return null==this.string&&(this.string=Ot.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return Pn.createV1(114,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return he(this.multihash.bytes,e);if("string"==typeof e)return Br(e).equals(this);if(null!=e?.multihash?.bytes)return he(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[Ar](){return`PeerId(${this.toString()})`}}class Cr extends Tr{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class Nr extends Tr{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}}class Dr extends Tr{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}}const Pr=2336;class Lr{type="url";multihash;privateKey;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=kn.digest(Hn(this.url))}[Ar](){return`PeerId(${this.url})`}[_r]=!0;toString(){return this.toCID().toString()}toCID(){return Pn.createV1(Pr,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Ir(e)),e.toString()===this.toString())}}function Br(e,t){if(t=t??xr,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=vn(Ot.decode(`z${e}`));return e.startsWith("12D")?new Nr({multihash:t}):e.startsWith("16U")?new Dr({multihash:t}):new Cr({multihash:t})}return Or(xr.decode(e))}function Or(e){try{const t=vn(e);if(t.code===kn.code){if(36===t.digest.length)return new Nr({multihash:t});if(37===t.digest.length)return new Dr({multihash:t})}if(t.code===xn.code)return new Cr({multihash:t})}catch{return function(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&e.code!==Pr)throw new Error("Supplied PeerID CID is invalid");if(e.code===Pr){const t=Ir(e.multihash.digest);return new Lr(new URL(t))}const t=e.multihash;if(t.code===xn.code)return new Cr({multihash:e.multihash});if(t.code===kn.code){if(36===t.digest.length)return new Nr({multihash:e.multihash});if(37===t.digest.length)return new Dr({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(Pn.decode(e))}throw new Error("Supplied PeerID CID is invalid")}async function Mr(e,t){return 36===e.length?new Nr({multihash:bn(kn.code,e),privateKey:t}):37===e.length?new Dr({multihash:bn(kn.code,e),privateKey:t}):new Cr({multihash:await xn.digest(e),publicKey:e,privateKey:t})}function Ur(e,t){const n={[Symbol.iterator]:()=>n,next:()=>{const n=e.next(),r=n.value;return!0===n.done||null==r?{done:!0,value:void 0}:{done:!1,value:t(r)}}};return n}class Fr{map;constructor(e){if(this.map=new Map,null!=e)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Ur(this.map.entries(),e=>[Br(e[0]),e[1]])}forEach(e){this.map.forEach((t,n)=>{e(t,Br(n),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return Ur(this.map.keys(),e=>Br(e))}values(){return this.map.values()}get size(){return this.map.size}}class zr extends Fr{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Vr(e){const{name:t,metrics:n}=e;let r;return r=null!=n?new zr({name:t,metrics:n}):new Fr,r}class $r{full;pendingBytes;wantlist;blocks;blockPresences;constructor(e=!1,t=0){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const n=Ut.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){const n=Ut.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){const n=Ut.encode(e.multihash.bytes);this.blocks.set(n,t)}}function Hr(e){return function(e){let t=new Uint8Array(e.reduce((e,t)=>e+se(t),0)),n=0;for(const r of e)t=ce(r,t,n),n+=se(r);return t}([e.version,e.code,e.multihash.code,e.multihash.digest.byteLength])}class Kr{peerId;blockstore;network;wants;exchangeCount;bytesSent;bytesReceived;lastExchange;maxSizeReplaceHasWithBlock;log;constructor(e,t){this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??1024}sentBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=(new Date).getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new $r,n=new Set;for(const[r,i]of this.wants.entries())try{const o=await this.blockstore.get(i.cid,e);i.wantType===or.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",i.cid),n.add(r),t.addBlock(i.cid,{data:o,prefix:Hr(i.cid)})):(this.log("sending have for %c",i.cid),t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:ur.HaveBlock})):(this.log("sending block for %c",i.cid),n.add(r),t.addBlock(i.cid,{data:o,prefix:Hr(i.cid)}))}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e;if(this.log("do not have block for %c",i.cid),!i.sendDontHave)continue;if(!0===i.sentDontHave)continue;i.sentDontHave=!0,t.addBlockPresence(i.cid,{cid:i.cid.bytes,type:ur.DontHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((e,t)=>e+t.data.byteLength,0));for(const e of n)this.wants.delete(e)}}}class qr{blockstore;network;ledgerMap;maxSizeReplaceHasWithBlock;log;logger;constructor(e,t={}){this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=Vr({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",e=>{this.receiveMessage(e.detail.peer,e.detail.message).catch(t=>{this.log.error("error receiving bitswap message from %p",e.detail.peer,t)})}),this.network.addEventListener("peer:disconnected",e=>{this.peerDisconnected(e.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(null!=t)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(null!=t)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){let n=this.ledgerMap.get(e);if(null==n&&(n=new Kr({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(t.blocks?.reduce((e,t)=>e+t.data.byteLength,0)??0),null!=t.wantlist){!0===t.wantlist.full&&n.wants.clear();for(const r of t.wantlist.entries){const t=Pn.decode(r.cid),i=Ir(t.multihash.bytes,"base64");!0===r.cancel?(this.log("peer %p cancelled want of block for %c",e,t),n.wants.delete(i)):(r.wantType===or.WantHave?this.log("peer %p wanted block presence for %c",e,t):this.log("peer %p wanted block for %c",e,t),n.wants.set(i,{cid:t,priority:r.priority,wantType:r.wantType??or.WantBlock,sendDontHave:r.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){const n=Ir(e.multihash.bytes,"base64"),r=[];for(const e of this.ledgerMap.values())e.wants.has(n)&&r.push(e);await Promise.all(r.map(async e=>e.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}const jr="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0;function Wr(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name}function Gr(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function Yr(e,...t){if(!Wr(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error("Uint8Array expected of length "+t+", got length="+e.length)}function Qr(e){if("function"!=typeof e||"function"!=typeof e.create)throw new Error("Hash should be wrapped by utils.createHasher");Gr(e.outputLen),Gr(e.blockLen)}function Xr(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Zr(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function Jr(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function ei(e,t){return e<<32-t|e>>>t}function ti(e,t){return e<<t|e>>>32-t>>>0}const ni=(()=>"function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex)(),ri=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function ii(e){if(Yr(e),ni)return e.toHex();let t="";for(let n=0;n<e.length;n++)t+=ri[e[n]];return t}function oi(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-55:e>=97&&e<=102?e-87:void 0}function si(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);if(ni)return Uint8Array.fromHex(e);const t=e.length,n=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(n);for(let t=0,i=0;t<n;t++,i+=2){const n=oi(e.charCodeAt(i)),o=oi(e.charCodeAt(i+1));if(void 0===n||void 0===o){const t=e[i]+e[i+1];throw new Error('hex string expected, got non-hex character "'+t+'" at index '+i)}r[t]=16*n+o}return r}const ai=async()=>{};async function li(e,t,n){let r=Date.now();for(let i=0;i<e;i++){n(i);const e=Date.now()-r;e>=0&&e<t||(await ai(),r+=e)}}function ci(e){if("string"!=typeof e)throw new Error("string expected");return new Uint8Array((new TextEncoder).encode(e))}function ui(e){return"string"==typeof e&&(e=ci(e)),Yr(e),e}function di(e){return"string"==typeof e&&(e=ci(e)),Yr(e),e}function hi(...e){let t=0;for(let n=0;n<e.length;n++){const r=e[n];Yr(r),t+=r.length}const n=new Uint8Array(t);for(let t=0,r=0;t<e.length;t++){const i=e[t];n.set(i,r),r+=i.length}return n}class fi{}function pi(e){const t=t=>e().update(ui(t)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function gi(e=32){if(jr&&"function"==typeof jr.getRandomValues)return jr.getRandomValues(new Uint8Array(e));if(jr&&"function"==typeof jr.randomBytes)return Uint8Array.from(jr.randomBytes(e));throw new Error("crypto.getRandomValues must be defined")}function mi(e){if(isNaN(e)||e<=0)throw new x("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return gi(e)}var yi=n(437);const wi=Math.LN2*Math.LN2;class bi{static create(e,t=.005){const n=function(e,t=.005){const n=Math.round(-1*e*Math.log(t)/wi);return{bits:n,hashes:Math.round(n/e*Math.LN2)}}(e,t);return new bi(n)}seeds;bits;buffer;constructor(e={}){null!=e.seeds?this.seeds=e.seeds:this.seeds=function(e){let t,n;const r=[];for(let i=0;i<e;i++)for(t=new me(mi(4)),r[i]=t.getUint32(0,!0),n=0;n<i;n++)if(r[i]===r[n]){i--;break}return r}(e.hashes??8),this.bits=e.bits??1024,this.buffer=Y(Math.ceil(this.bits/8))}add(e){"string"==typeof e&&(e=Hn(e));for(let t=0;t<this.seeds.length;t++){const n=yi.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(n)}}has(e){"string"==typeof e&&(e=Hn(e));for(let t=0;t<this.seeds.length;t++){const n=yi.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(n))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,n=e;for(;n>7;)t++,n-=8;let r=this.buffer[t];r|=1<<n,this.buffer[t]=r}getbit(e){let t=0,n=e;for(;n>7;)t++,n-=8;return!!(this.buffer[t]&1<<n)}}class vi extends R{intialPeerSearchComplete;requests;name;log;logger;minProviders;maxProviders;providers;evictionFilter;constructor(e,t){super(),this.name=t.name,this.logger=e.logger,this.log=e.logger.forComponent(this.name),this.requests=new Map,this.minProviders=t.minProviders??1,this.maxProviders=t.maxProviders??5,this.providers=[],this.evictionFilter=bi.create(this.maxProviders)}async retrieve(e,t={}){const n=Ut.encode(e.multihash.bytes),r=this.requests.get(n);if(null!=r)return this.log("join existing request for %c",e),r;const i=D();if(this.requests.set(n,i.promise),0===this.providers.length){let n=!1;null==this.intialPeerSearchComplete&&(n=!0,this.log=this.logger.forComponent(`${this.name}:${e}`),this.intialPeerSearchComplete=this.findProviders(e,this.minProviders,t)),await this.intialPeerSearchComplete,n&&this.log("found initial session peers for %c",e)}let o=!1;const s=new j({concurrency:this.maxProviders});s.addEventListener("error",()=>{}),s.addEventListener("failure",e=>{this.log.error("error querying provider %o, evicting from session",e.detail.job.options.provider,e.detail.error),this.evict(e.detail.job.options.provider)}),s.addEventListener("success",e=>{o=!0,i.resolve(e.detail.result)}),s.addEventListener("idle",()=>{o||!0===t.signal?.aborted||Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",e);for(let e=0;e<this.minProviders&&0!==this.providers.length;e++){const e=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(e)}await this.findProviders(e,this.minProviders,t),this.log("found new providers re-retrieving %c",e),this.requests.delete(n),i.resolve(await this.retrieve(e,t))}).catch(t=>{this.log.error("could not find new providers for %c",e,t),i.reject(t)})});const a=n=>{s.add(async()=>this.queryProvider(e,n.detail,t),{provider:n.detail}).catch(n=>{!0!==t.signal?.aborted&&this.log.error("error retrieving session block for %c",e,n)})};this.addEventListener("provider",a),Promise.all([...this.providers].map(async n=>s.add(async()=>this.queryProvider(e,n,t),{provider:n}))).catch(n=>{!0!==t.signal?.aborted&&this.log.error("error retrieving session block for %c",e,n)});try{return await i.promise}finally{this.removeEventListener("provider",a),s.clear(),this.requests.delete(n)}}evict(e){this.evictionFilter.add(this.toEvictionKey(e));const t=this.providers.findIndex(t=>this.equals(t,e));-1!==t&&this.providers.splice(t,1)}isEvicted(e){return this.evictionFilter.has(this.toEvictionKey(e))}hasProvider(e){return null!=this.providers.find(t=>this.equals(t,e))||!!this.isEvicted(e)}async findProviders(e,t,n){const r=D();let i=0;return Promise.resolve().then(async()=>{this.log("finding %d-%d new provider(s) for %c",t,this.maxProviders,e);for await(const o of this.findNewProviders(e,n)){if(i===this.maxProviders||!0===n.signal?.aborted)break;if(!this.hasProvider(o)&&(this.log("found %d/%d new providers",i,this.maxProviders),this.providers.push(o),this.safeDispatchEvent("provider",{detail:o}),i++,i===t&&(this.log("session is ready"),r.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",i);break}}if(this.log("found %d/%d new session peers",i,this.maxProviders),i<t)throw new x(`Found ${i} of ${t} ${this.name} providers for ${e}`,"ERR_INSUFFICIENT_PROVIDERS_FOUND")}).catch(t=>{this.log.error("error searching routing for potential session peers for %c",e,t.errors??t),r.reject(t)}),r.promise}}class Ei extends vi{wantList;network;constructor(e,t){super(e,{...t,name:"helia:bitswap:session"}),this.wantList=e.wantList,this.network=e.network}async queryProvider(e,t,n){this.log("sending WANT-BLOCK for %c to %p",e,t);const r=await this.wantList.wantSessionBlock(e,t,n);if(this.log("%p %s %c",t,r.has?"has":"does not have",e),r.has&&null!=r.block)return r.block;throw new Error("Provider did not have block")}async*findNewProviders(e,t={}){for await(const n of this.network.findProviders(e,t))yield n.id}toEvictionKey(e){return e.toBytes()}equals(e,t){return e.equals(t)}}class Si{blocksReceived;duplicateBlocksReceived;dataReceived;duplicateDataReceived;constructor(e){this.blocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=e.metrics?.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=e.metrics?.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){const n={global:e};null!=t&&(n[t.toString()]=e),this.blocksReceived?.increment(n)}updateDuplicateBlocksReceived(e=1,t){const n={global:e};null!=t&&(n[t.toString()]=e),this.duplicateBlocksReceived?.increment(n)}updateDataReceived(e,t){const n={global:e};null!=t&&(n[t.toString()]=e),this.dataReceived?.increment(n)}updateDuplicateDataReceived(e,t){const n={global:e};null!=t&&(n[t.toString()]=e),this.duplicateDataReceived?.increment(n)}}class ki extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function _i(e){const{name:t,metrics:n}=e;let r;return r=null!=n?new ki({name:t,metrics:n}):new Map,r}const Ri=function(e){if(!(e instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const t=[];for(;e.length>0;){const n=ue(e);t.push(n),e=e.slice(se(n))}return t};class Ii extends R{peers;wants;network;log;sendMessagesDelay;sendMessagesTimeout;hashLoader;sendingMessages;constructor(e,t={}){super(),this.peers=Vr({name:"helia_bitswap_peers",metrics:e.metrics}),this.wants=_i({name:"helia_bitswap_wantlist",metrics:e.metrics}),this.network=e.network,this.sendMessagesDelay=t.sendMessagesDelay??10,this.log=e.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=t.hashLoader,this.network.addEventListener("bitswap:message",e=>{this.receiveMessage(e.detail.peer,e.detail.message).catch(t=>{this.log.error("error receiving bitswap message from %p",e.detail.peer,t)})}),this.network.addEventListener("peer:connected",e=>{this.peerConnected(e.detail).catch(t=>{this.log.error("error processing newly connected bitswap peer %p",e.detail,t)})}),this.network.addEventListener("peer:disconnected",e=>{this.peerDisconnected(e.detail)})}async addEntry(e,t){const n=Ir(e.multihash.bytes,"base64");let r=this.wants.get(n);null==r&&(r={cid:e,priority:t.priority??1,wantType:t.wantType??or.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(n,r)),r.wantType===or.WantHave&&t.wantType===or.WantBlock&&(r.wantType=or.WantBlock),await this.sendMessagesDebounced();try{return t.wantType===or.WantBlock?(await U(this,"block",t?.signal,{filter:t=>he(e.multihash.digest,t.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await U(this,"presence",t?.signal,{filter:t=>he(e.multihash.digest,t.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{!0===t.signal?.aborted&&(this.log("want for %c was aborted, cancelling want",e),r.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){await(this.sendingMessages?.promise),clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(e=>{this.log("error sending messages to peers",e)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=D(),await Promise.all([...this.peers.entries()].map(async([e,t])=>{const n=new Set,r=new $r;for(const[e,i]of this.wants.entries())t.has(e)||i.cancel||(n.add(e),r.addWantlistEntry(i.cid,{cid:i.cid.bytes,priority:i.priority,wantType:i.wantType,cancel:i.cancel,sendDontHave:i.sendDontHave}));if(0!==r.wantlist.size)try{await this.network.sendMessage(e,r);for(const e of n)t.add(e)}catch(e){this.log.error("error sending full wantlist to new peer",e)}})).catch(e=>{this.log.error("error sending messages",e)});for(const[e,t]of this.wants)if(t.cancel){this.wants.delete(e);for(const t of this.peers.values())t.delete(e)}this.sendingMessages.resolve()}has(e){const t=Ir(e.multihash.bytes,"base64");return this.wants.has(t)}async wantSessionPresence(e,t,n={}){const r=new $r;return r.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:or.WantHave,priority:1}),await this.network.sendMessage(t,r),(await U(this,"presence",n.signal,{filter:n=>t.equals(n.detail.sender)&&he(e.multihash.digest,n.detail.cid.multihash.digest)})).detail}async wantBlock(e,t={}){return this.addEntry(e,{...t,wantType:or.WantBlock})}async wantSessionBlock(e,t,n={}){const r=new $r;return r.addWantlistEntry(e,{cid:e.bytes,sendDontHave:!0,wantType:or.WantBlock,priority:1}),await this.network.sendMessage(t,r),(await U(this,"presence",n.signal,{filter:n=>t.equals(n.detail.sender)&&he(e.multihash.digest,n.detail.cid.multihash.digest)})).detail}async receivedBlock(e,t){const n=Ir(e.multihash.bytes,"base64"),r=this.wants.get(n);null!=r&&(r.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(e,t){this.log("received message from %p with %d blocks",e,t.blocks.length);let n=!1;for(const r of t.blocks){if(null==r.prefix||null==r.data)continue;const t=Ri(r.prefix),i=t[0],o=t[1],s=t[2],a=s===xn.code?xn:await(this.hashLoader?.getHasher(s));if(null==a){this.log.error("unknown hash algorithm",s);continue}let l=a.digest(r.data);null!=l.then&&(l=await l);const c=Pn.create(0===i?0:1,o,l);this.log("received block from %p for %c",e,c),this.safeDispatchEvent("block",{detail:{sender:e,cid:c,block:r.data}}),this.safeDispatchEvent("presence",{detail:{sender:e,cid:c,has:!0,block:r.data}});const u=Ir(c.multihash.bytes,"base64"),d=this.wants.get(u);null!=d&&(d.cancel=!0,n=!0)}for(const{cid:n,type:r}of t.blockPresences){const t=Pn.decode(n);this.log("received %s from %p for %c",r,e,t),this.safeDispatchEvent("presence",{detail:{sender:e,cid:t,has:r===ur.HaveBlock}})}n&&await this.sendMessagesDebounced()}async peerConnected(e){const t=new Set,n=new $r(!0);for(const[e,r]of this.wants.entries())r.cancel||(t.add(e),n.addWantlistEntry(r.cid,{cid:r.cid.bytes,priority:1,wantType:or.WantBlock,cancel:!1,sendDontHave:!1}));if(0!==n.wantlist.size)try{await this.network.sendMessage(e,n),this.peers.set(e,t)}catch(t){this.log.error("error sending full wantlist to new peer %p",e,t)}else this.peers.set(e,t)}peerDisconnected(e){this.peers.delete(e)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class Ai{log;logger;stats;network;blockstore;peerWantLists;wantList;constructor(e,t={}){this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.stats=new Si(e),this.network=new kr(e,t),this.peerWantLists=new qr({...e,network:this.network},t),this.wantList=new Ii({...e,network:this.network},t)}createSession(e={}){return t={wantList:this.wantList,network:this.network,logger:this.logger},new Ei(t,e);var t}async want(e,t={}){const n=new AbortController,r=_([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:r}).catch(t=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,t)});try{return(await this.wantList.wantBlock(e,{...t,signal:r})).block}finally{n.abort(),r.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}class xi{bitswap;started;constructor(e,t={}){const{hashers:n}=e;this.bitswap=((e,t={})=>new Ai(e,t))(e,{hashLoader:{getHasher:async e=>{let t;if(t="string"==typeof e?Object.values(n).find(t=>t.name===e):n[e],null!=t)return t;throw new Error(`Could not load hasher for code/name "${e}"`)}},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(e,t,n)=>{await this.bitswap.notify(e,t,n)},retrieve:async(e,n)=>t.retrieve(e,n)}}}function Ti(e={}){return t=>new xi(t,e)}const Ci=new class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return void 0===n&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&void 0===this.readGivenChar(e)))return n()})}readNumber(e,t,n,r){return this.readAtomically(()=>{let i=0,o=0;const s=this.peekChar();if(void 0===s)return;const a="0"===s,l=2**(8*r)-1;for(;;){const n=this.readAtomically(()=>{const t=this.readChar();if(void 0===t)return;const n=Number.parseInt(t,e);return Number.isNaN(n)?void 0:n});if(void 0===n)break;if(i*=e,i+=n,i>l)return;if(o+=1,void 0!==t&&o>t)return}return 0===o||!n&&a&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(void 0===n)return;e[t]=n}return e})}readIPv6Addr(){const e=e=>{for(let t=0;t<e.length/2;t++){const n=2*t;if(t<e.length-3){const r=this.readSeparator(":",t,()=>this.readIPv4Addr());if(void 0!==r)return e[n]=r[0],e[n+1]=r[1],e[n+2]=r[2],e[n+3]=r[3],[n+4,!0]}const r=this.readSeparator(":",t,()=>this.readNumber(16,4,!0,2));if(void 0===r)return[n,!1];e[n]=r>>8,e[n+1]=255&r}return[e.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,r]=e(t);if(16===n)return t;if(r)return;if(void 0===this.readGivenChar(":"))return;if(void 0===this.readGivenChar(":"))return;const i=new Uint8Array(14),o=16-(n+2),[s]=e(i.subarray(0,o));return t.set(i.subarray(0,s),16-s),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};function Ni(e){return Boolean(function(e){if(!(e.length>15))return Ci.new(e).parseWith(()=>Ci.readIPv4Addr())}(e))}function Di(e){return Boolean(function(e){if(e.includes("%")&&(e=e.split("%")[0]),!(e.length>45))return Ci.new(e).parseWith(()=>Ci.readIPv6Addr())}(e))}var Pi=n(507);const Li=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map(e=>new Pi.Netmask(e));function Bi(e){for(const t of Li)if(t.contains(e))return!0;return!1}function Oi(e){return Ni(e)?Bi(e):/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(e)?function(e){const t=e.split(":");if(t.length<2)return!1;const n=t[t.length-1].padStart(4,"0"),r=t[t.length-2].padStart(4,"0");return Bi(`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}`)}(e):/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)?function(e){const t=e.split(":");return Bi(t[t.length-1])}(e):Di(e)?function(e){return/^::$/.test(e)||/^::1$/.test(e)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(e)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(e)||/^ff([0-9a-fA-F]{2,2}):/i.test(e)}(e):void 0}const Mi=e=>({match:t=>!(t.length<1)&&!!e(t[0])&&t.slice(1),pattern:"fn"}),Ui=e=>({match:t=>Mi(t=>t===e).match(t),pattern:e}),Fi=()=>({match:e=>Mi(e=>"string"==typeof e).match(e),pattern:"{string}"}),zi=()=>({match:e=>Mi(e=>!isNaN(parseInt(e))).match(e),pattern:"{number}"}),Vi=()=>({match:e=>{if(e.length<2)return!1;if("p2p"!==e[0]&&"ipfs"!==e[0])return!1;if(!e[1].startsWith("Q")&&!e[1].startsWith("1"))return!1;try{Ot.decode(`z${e[1]}`)}catch(e){return!1}return e.slice(2)},pattern:"/p2p/{peerid}"}),$i=()=>({match:e=>{if(e.length<2)return!1;if("certhash"!==e[0])return!1;try{zt.decode(e[1])}catch{return!1}return e.slice(2)},pattern:"/certhash/{certhash}"}),Hi=e=>({match:t=>{const n=e.match(t);return!1===n?t:n},pattern:`optional(${e.pattern})`}),Ki=(...e)=>({match:t=>{let n;for(const r of e){const e=r.match(t);!1!==e&&(null==n||e.length<n.length)&&(n=e)}return null!=n&&n},pattern:`or(${e.map(e=>e.pattern).join(", ")})`}),qi=(...e)=>({match:t=>{for(const n of e){const e=n.match(t);if(!1===e)return!1;t=e}return t},pattern:`and(${e.map(e=>e.pattern).join(", ")})`});function ji(...e){function t(t){let n=(e=>e.toString().split("/").slice(1))(t);for(const t of e){const e=t.match(n);if(!1===e)return!1;n=e}return n}return{matchers:e,matches:function(e){return!1!==t(e)},exactMatch:function(e){const n=t(e);return!1!==n&&0===n.length}}}ji(Vi());const Wi=qi(Ui("dns4"),Fi()),Gi=qi(Ui("dns6"),Fi()),Yi=qi(Ui("dnsaddr"),Fi()),Qi=qi(Ui("dns"),Fi()),Xi=(ji(Wi,Hi(Vi())),ji(Gi,Hi(Vi())),ji(Yi,Hi(Vi())),ji(Ki(Qi,Yi,Wi,Gi),Hi(Vi()))),Zi=qi(Ui("ip4"),Mi(Ni)),Ji=qi(Ui("ip6"),Mi(Di)),eo=Ki(Zi,Ji),to=Ki(eo,Qi,Wi,Gi,Yi),no=ji(Ki(eo,qi(Ki(Qi,Yi,Wi,Gi),Hi(Vi())))),ro=(ji(Zi),ji(Ji),ji(eo)),io=qi(to,Ui("tcp"),zi()),oo=qi(to,Ui("udp"),zi()),so=(ji(qi(io,Hi(Vi()))),ji(oo),qi(oo,Ui("quic"),Hi(Vi()))),ao=qi(oo,Ui("quic-v1"),Hi(Vi())),lo=Ki(so,ao),co=(ji(so),ji(ao),Ki(to,io,oo,so,ao)),uo=Ki(qi(co,Ui("ws"),Hi(Vi()))),ho=(ji(uo),Ki(qi(co,Ui("wss"),Hi(Vi())),qi(co,Ui("tls"),Hi(qi(Ui("sni"),Fi())),Ui("ws"),Hi(Vi())))),fo=(ji(ho),qi(oo,Ui("webrtc-direct"),Hi($i()),Hi($i()),Hi(Vi()))),po=ji(fo),go=qi(ao,Ui("webtransport"),Hi($i()),Hi($i()),Hi(Vi())),mo=ji(go),yo=Ki(uo,ho,qi(io,Hi(Vi())),qi(lo,Hi(Vi())),qi(to,Hi(Vi())),fo,go,Vi()),wo=(ji(yo),ji(qi(yo,Ui("p2p-circuit"),Vi()))),bo=ji(Ki(qi(yo,Ui("p2p-circuit"),Ui("webrtc"),Hi(Vi())),qi(yo,Ui("webrtc"),Hi(Vi())),qi(Ui("webrtc"),Hi(Vi())))),vo=ji(Ki(qi(to,Ui("tcp"),zi(),Ui("http"),Hi(Vi())),qi(to,Ui("http"),Hi(Vi())))),Eo=ji(Ki(qi(to,Ui("tcp"),Ki(qi(Ui("443"),Ui("http")),qi(zi(),Ui("https")),qi(zi(),Ui("tls"),Ui("http"))),Hi(Vi())),qi(to,Ui("tls"),Ui("http"),Hi(Vi())),qi(to,Ui("https"),Hi(Vi()))));ji(Ki(qi(Ui("memory"),Fi(),Hi(Vi())))),ji(Ki(qi(Ui("unix"),Fi(),Hi(Vi()))));class So extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class ko extends Error{static name="ValidationError";name="ValidationError"}class _o extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class Ro extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}function Io(e){return t=>Ir(t,e)}function Ao(e){return t=>Hn(t,e)}function xo(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function To(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function Co(e){const t=e.subarray(0,e.length-2),n=e.subarray(e.length-2);return`${Ir(t,"base32")}:${xo(n)}`}const No=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,n)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new So("Invalid byte value in IP address");t[n]=r}),t},Do=Object.values(Un).map(e=>e.decoder),Po=function(){let e=Do[0].or(Do[1]);return Do.slice(2).forEach(t=>e=e.or(t)),e}(),Lo=function(...e){return t=>{for(const n of e)n(t)}}(function(e){if(parseInt(e).toString()!==e)throw new ko("Value must be an integer")},function(e){if(e<0)throw new ko("Value must be a positive integer, or zero")},e=>{if(e>65535)throw new ko("Value must be smaller than or equal to 65535")});const Bo=-1,Oo=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new Ro(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},Mo=[{code:4,name:"ip4",size:32,valueToBytes:No,bytesToValue:function(e){if(4!==e.byteLength)throw new So("IPv4 address was incorrect length");const t=[];for(let n=0;n<e.byteLength;n++)t.push(e[n]);return t.join(".")},validate:e=>{if(!Ni(e))throw new ko(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:To,bytesToValue:xo,validate:Lo},{code:273,name:"udp",size:16,valueToBytes:To,bytesToValue:xo,validate:Lo},{code:33,name:"dccp",size:16,valueToBytes:To,bytesToValue:xo,validate:Lo},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const n=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<n.length;r++){let e;Ni(n[r])&&(e=No(n[r]),n[r]=Ir(e.subarray(0,2),"base16")),null!=e&&++r<8&&n.splice(r,0,Ir(e.subarray(2,4),"base16"))}if(""===n[0])for(;n.length<8;)n.unshift("0");else if(""===n[n.length-1])for(;n.length<8;)n.push("0");else if(n.length<8){for(r=0;r<n.length&&""!==n[r];r++);const e=[r,1];for(r=9-n.length;r>0;r--)e.push("0");n.splice.apply(n,e)}const i=new Uint8Array(t+16);for(r=0;r<n.length;r++){""===n[r]&&(n[r]="0");const e=parseInt(n[r],16);if(isNaN(e)||e<0||e>65535)throw new So("Invalid byte value in IP address");i[t++]=e>>8&255,i[t++]=255&e}return i},bytesToValue:function(e){if(16!==e.byteLength)throw new So("IPv6 address was incorrect length");const t=[];for(let n=0;n<e.byteLength;n+=2){const r=e[n],i=e[n+1],o=`${r.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;t.push(o)}const n=t.join(":");try{const e=new URL(`http://[${n}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new So(`Invalid IPv6 address "${n}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new So(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!Di(e))throw new ko(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:Bo},{code:43,name:"ipcidr",size:8,bytesToValue:Io("base10"),valueToBytes:Ao("base10")},{code:53,name:"dns",size:Bo,resolvable:!0},{code:54,name:"dns4",size:Bo,resolvable:!0},{code:55,name:"dns6",size:Bo,resolvable:!0},{code:56,name:"dnsaddr",size:Bo,resolvable:!0},{code:132,name:"sctp",size:16,valueToBytes:To,bytesToValue:xo,validate:Lo},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Bo,path:!0,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:Bo,bytesToValue:Io("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?Ao("base58btc")(e):Pn.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:Co,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const n=Hn(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const i=To(r);return de([n,i],n.length+i.length)}},{code:445,name:"onion3",size:296,bytesToValue:Co,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const n=Rt.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const i=To(r);return de([n,i],n.length+i.length)}},{code:446,name:"garlic64",size:Bo},{code:447,name:"garlic32",size:Bo},{code:448,name:"tls"},{code:449,name:"sni",size:Bo},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:Bo,bytesToValue:(Uo=zt,e=>Uo.encoder.encode(e)),valueToBytes:function(e){return Po.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:Bo,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Bo}];var Uo;function Fo(e,t,n){return null==e.size||0===e.size?0:e.size>0?e.size/8:ue(t,n)}Mo.forEach(e=>{Oo.addProtocol(e)});const zo=Symbol.for("nodejs.util.inspect.custom"),Vo=Symbol.for("@multiformats/multiaddr"),$o=[53,54,55,56];class Ho extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}class Ko{[Vo]=!0;#t;#n;#r;constructor(e="/",t={}){this.#t=function(e){if(null==e&&(e="/"),jo(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let n=0;for(;n<e.length;){const r=ue(e,n),i=Oo.getProtocol(r),o=se(r),s=Fo(i,e,n+o);let a=0;s>0&&i.size===Bo&&(a=se(s));const l=o+a+s,c={code:r,name:i.name,bytes:e.subarray(n,n+l)};if(s>0){const t=n+o+a,r=e.subarray(t,t+s);c.value=i.bytesToValue?.(r)??Ir(r)}t.push(c),n+=l}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new So('String multiaddr must start with "/"');const t=[];let n="protocol",r="",i="";for(let o=1;o<e.length;o++){const s=e.charAt(o);"/"!==s&&("protocol"===n?i+=e.charAt(o):r+=e.charAt(o));const a=o===e.length-1;if("/"===s||a){const e=Oo.getProtocol(i);if("protocol"===n){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",i="",n="protocol";continue}if(a)throw new So(`Component ${i} was missing value`);n="value"}else if("value"===n){const o={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new So(`Component ${i} was missing value`);o.value=e.stringToValue?.(r)??r}t.push(o),r="",i="",n="protocol"}}}if(""!==i&&""!==r)throw new So("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new So("Must be a string, Uint8Array, Component[], or another Multiaddr")}(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=Oo.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#r&&(this.#r=function(e){let t=0;const n=[];for(const r of e){if(null==r.bytes){const e=Oo.getProtocol(r.code),t=se(r.code);let n,i=0,o=0;null!=r.value&&(n=e.valueToBytes?.(r.value)??Hn(r.value),i=n.byteLength,e.size===Bo&&(o=se(i)));const s=new Uint8Array(t+o+i);let a=0;ae(r.code,s,a),a+=t,null!=n&&(e.size===Bo&&(ae(i,s,a),a+=o),s.set(n,a)),r.bytes=s}n.push(r.bytes),t+=r.bytes.byteLength}return de(n,t)}(this.#t)),this.#r}toString(){return null==this.#n&&(this.#n=`/${this.#t.flatMap(e=>{if(null==e.value)return e.name;const t=Oo.getProtocol(e.code);if(null==t)throw new So(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#n}toJSON(){return this.toString()}toOptions(){let e,t,n,r,i="";for(const{code:o,name:s,value:a}of this.#t)42===o&&(i=`%${a??""}`),$o.includes(o)&&(t="tcp",r=443,n=`${a??""}${i}`,e=55===o?6:4),6!==o&&273!==o||(t="tcp"===s?"tcp":"udp",r=parseInt(a??"")),4!==o&&41!==o||(t="tcp",n=`${a??""}${i}`,e=41===o?6:4);if(null==e||null==t||null==n||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:r}}getComponents(){return[...this.#t]}protos(){return this.#t.map(({code:e,value:t})=>{const n=Oo.getProtocol(e);return{code:e,size:n.size??0,name:n.name,resolvable:Boolean(n.resolvable),path:Boolean(n.path)}})}protoCodes(){return this.#t.map(({code:e})=>e)}protoNames(){return this.#t.map(({name:e})=>e)}tuples(){return this.#t.map(({code:e,value:t})=>{if(null==t)return[e];const n=Oo.getProtocol(e),r=[e];return null!=t&&r.push(n.valueToBytes?.(t)??Hn(t)),r})}stringTuples(){return this.#t.map(({code:e,value:t})=>null==t?[e]:[e,t])}encapsulate(e){const t=new Ko(e);return new Ko([...this.#t,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),r=n.lastIndexOf(t);if(r<0)throw new _o(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Ko(n.slice(0,r),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#t.length-1;n>-1;n--)if(this.#t[n].code===e){t=n;break}return new Ko(this.#t.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#t.forEach(({code:t,value:n})=>{421===t&&e.push([t,n]),290===t&&(e=[])});const t=e.pop();if(null!=t?.[1]){const e=t[1];return"Q"===e[0]||"1"===e[0]?Ir(Ot.decode(`z${e}`),"base58btc"):Ir(Pn.parse(e).multihash.bytes,"base58btc")}return null}catch(e){return null}}getPath(){for(const e of this.#t)if(Oo.getProtocol(e.code).path)return e.value??null;return null}equals(e){return he(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(e=>e.resolvable);if(null==t)return[this];const n=qo.get(t.name);if(null==n)throw new Ho(`no available resolver for ${t.name}`);return(await n(this,e)).map(e=>Wo(e))}nodeAddress(){const e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(2!==this.#t.length||4!==this.#t[0].code&&41!==this.#t[0].code||6!==this.#t[1].code&&273!==this.#t[1].code)}[zo](){return`Multiaddr(${this.toString()})`}}parseInt("0xFFFF",16),new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);const qo=new Map;function jo(e){return Boolean(e?.[Vo])}function Wo(e){return new Ko(e)}function Go(e){const t=Oo.getProtocol(e);return{code:t.code,size:t.size??0,name:t.name,resolvable:Boolean(t.resolvable),path:Boolean(t.path)}}const Yo=[Go("tcp").code,Go("dns").code,Go("dnsaddr").code,Go("dns4").code,Go("dns6").code];function Qo(e){return Zo("sni",e)?.[1]}function Xo(e){const t=Zo("tcp",e)?.[1];return null==t?"":`:${t}`}function Zo(e,t){let n;try{n=Go(e).code}catch(e){return}for(const[e,r]of t)if(e===n&&null!=r)return[e,r]}function Jo(e){return e.some(([e,t])=>e===Go("tls").code)}function es(e,t,n){const r=ts[Go(e).name];if(null==r)throw new Error(`Can't interpret protocol ${Go(e).name}`);const i=r(t,n);return e===Go("ip6").code?`[${i}]`:i}const ts={ip4:(e,t)=>e,ip6:(e,t)=>0===t.length?e:`[${e}]`,tcp:(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return`tcp://${es(n[0],n[1]??"",t)}:${e}`},udp:(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return`udp://${es(n[0],n[1]??"",t)}:${e}`},dnsaddr:(e,t)=>e,dns4:(e,t)=>e,dns6:(e,t)=>e,dns:(e,t)=>e,ipfs:(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return`${es(n[0],n[1]??"",t)}/ipfs/${e}`},p2p:(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return`${es(n[0],n[1]??"",t)}/p2p/${e}`},http:(e,t)=>{const n=Jo(t),r=Qo(t),i=Xo(t);if(n&&null!=r)return`https://${r}${i}`;const o=n?"https://":"http://",s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");let a=es(s[0],s[1]??"",t);return a=a.replace("tcp://",""),`${o}${a}`},"http-path":(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return`${es(n[0],n[1]??"",t)}/${decodeURIComponent(e)}`},tls:(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return es(n[0],n[1]??"",t)},sni:(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return es(n[0],n[1]??"",t)},https:(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");let r=es(n[0],n[1]??"",t);return r=r.replace("tcp://",""),`https://${r}`},ws:(e,t)=>{const n=Jo(t),r=Qo(t),i=Xo(t);if(n&&null!=r)return`wss://${r}${i}`;const o=n?"wss://":"ws://",s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");let a=es(s[0],s[1]??"",t);return a=a.replace("tcp://",""),`${o}${a}`},wss:(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");let r=es(n[0],n[1]??"",t);return r=r.replace("tcp://",""),`wss://${r}`},"p2p-websocket-star":(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return`${es(n[0],n[1]??"",t)}/p2p-websocket-star`},"p2p-webrtc-star":(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return`${es(n[0],n[1]??"",t)}/p2p-webrtc-star`},"p2p-webrtc-direct":(e,t)=>{const n=t.pop();if(null==n)throw new Error("Unexpected end of multiaddr");return`${es(n[0],n[1]??"",t)}/p2p-webrtc-direct`}};function ns(e,t){const n=Wo(e).stringTuples(),r=n.pop();if(null==r)throw new Error("Unexpected end of multiaddr");const i=Go(r[0]),o=ts[i.name];if(null==o)throw new Error(`No interpreter found for ${i.name}`);let s=o(r[1]??"",n);return!1!==t?.assumeHttp&&Yo.includes(r[0])&&(s=s.replace(/^.*:\/\//,""),s="443"===r[1]?`https://${s}`:`http://${s}`),(s.startsWith("http://")||s.startsWith("https://")||s.startsWith("ws://")||s.startsWith("wss://"))&&(s=new URL(s).toString(),s.endsWith("/")&&(s=s.substring(0,s.length-1))),s}class rs{url;#i=0;#o=0;#s=0;#a=0;#l=new Map;log;constructor(e,t){this.url=e instanceof URL?e:new URL(e),this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}#c(e){const t=e.multihash.bytes;return Ut.encode(t)}async getRawBlock(e,t){const n=new URL(this.url.toString());if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",!0===t?.aborted)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const r=this.#c(e),i=new AbortController,o=()=>{i.abort()};t?.addEventListener("abort",o);try{let t=this.#l.get(r);return null==t&&(this.#i++,t=fetch(n.toString(),{signal:i.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"}).then(async t=>{if(this.log("GET %s %d",n,t.status),!t.ok)throw this.#o++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return this.#a++,new Uint8Array(await t.arrayBuffer())}),this.#l.set(r,t)),await t}catch(n){if(!0===t?.aborted)throw new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`);throw this.#o++,new Error(`unable to fetch raw block for CID ${e}`)}finally{t?.removeEventListener("abort",o),this.#l.delete(r)}}reliability(){return 0===this.#i?1:this.#s>0?-1/0:this.#a/(this.#i+3*this.#o)}incrementInvalidBlocks(){this.#s++}getStats(){return{attempts:this.#i,errors:this.#o,invalidBlocks:this.#s,successes:this.#a,pendingResponses:this.#l.size}}}function is(e,t,n){return e.filter(e=>{if(Eo.matches(e)||t&&vo.matches(e))return!!n||!!Xi.matches(e)||!1===Oi(e.toOptions().host);if(!t&&n){const{host:t}=e.toOptions();if("127.0.0.1"===t||"localhost"===t||t.endsWith(".localhost"))return!0}return!1})}async function*os(e,t,n,r,i,o){for await(const s of t.findProviders(e,o)){const e=is(s.multiaddrs,r,i);if(0===e.length)continue;const t=ns(e[0]);yield new rs(t,n)}}class ss extends vi{routing;allowInsecure;allowLocal;constructor(e,t){super(e,{...t,name:"helia:trustless-gateway:session"}),this.routing=e.routing,this.allowInsecure=t.allowInsecure??ls,this.allowLocal=t.allowLocal??cs}async queryProvider(e,t,n){this.log("fetching BLOCK for %c from %s",e,t.url);const r=await t.getRawBlock(e,n.signal);return this.log.trace("got block for %c from %s",e,t.url),await(n.validateFn?.(r)),r}async*findNewProviders(e,t={}){yield*os(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,t)}toEvictionKey(e){return e.url.toString()}equals(e,t){return e.url.toString()===t.url.toString()}}class as{allowInsecure;allowLocal;routing;log;logger;constructor(e,t={}){this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??ls,this.allowLocal=t.allowLocal??cs}async retrieve(e,t={}){const n=[];for await(const r of os(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,t)){this.log("getting block for %c from %s",e,r.url);try{const n=await r.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,r.url);try{await(t.validateFn?.(n))}catch(t){this.log.error("failed to validate block for %c from %s",e,r.url,t);continue}return n}catch(i){if(this.log.error("failed to get block for %c from %s",e,r.url,i),i instanceof Error?n.push(i):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${r.url}`)),!0===t.signal?.aborted){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,r.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return t={logger:this.logger,routing:this.routing},n={...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure},new ss(t,n);var t,n}}const ls=!1,cs=!1;function us(e={}){return t=>new as(t,e)}class ds{libp2p;constructor(e){this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function hs(e){return new ds(e)}const fs="[a-fA-F\\d:]",ps=e=>e&&e.includeBoundaries?`(?:(?<=\\s|^)(?=${fs})|(?<=${fs})(?=\\s|$))`:"",gs="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",ms="[a-fA-F\\d]{1,4}",ys=`\n(?:\n(?:${ms}:){7}(?:${ms}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8\n(?:${ms}:){6}(?:${gs}|:${ms}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4\n(?:${ms}:){5}(?::${gs}|(?::${ms}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4\n(?:${ms}:){4}(?:(?::${ms}){0,1}:${gs}|(?::${ms}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4\n(?:${ms}:){3}(?:(?::${ms}){0,2}:${gs}|(?::${ms}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4\n(?:${ms}:){2}(?:(?::${ms}){0,3}:${gs}|(?::${ms}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4\n(?:${ms}:){1}(?:(?::${ms}){0,4}:${gs}|(?::${ms}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4\n(?::(?:(?::${ms}){0,5}:${gs}|(?::${ms}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4\n)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1\n`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),ws=new RegExp(`(?:^${gs}$)|(?:^${ys}$)`),bs=new RegExp(`^${gs}$`),vs=new RegExp(`^${ys}$`),Es=e=>e&&e.exact?ws:new RegExp(`(?:${ps(e)}${gs}${ps(e)})|(?:${ps(e)}${ys}${ps(e)})`,"g");Es.v4=e=>e&&e.exact?bs:new RegExp(`${ps(e)}${gs}${ps(e)}`,"g"),Es.v6=e=>e&&e.exact?vs:new RegExp(`${ps(e)}${ys}${ps(e)}`,"g");const Ss=Es,{toString:ks}=Object.prototype,_s={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function Rs(e,t,{timeout:n}={}){try{return function(e){const t=(...t)=>e(...t);return Object.defineProperty(t,"name",{value:`functionTimeout(${e.name||"<anonymous>"})`,configurable:!0}),t}(()=>function(e,t={}){if(n=e,"[object RegExp]"!==ks.call(n))throw new TypeError("Expected a RegExp instance");var n;const r=Object.keys(_s).map(n=>("boolean"==typeof t[n]?t[n]:e[n])?_s[n]:"").join(""),i=new RegExp(t.source||e.source,r);return i.lastIndex="number"==typeof t.lastIndex?t.lastIndex:e.lastIndex,i}(e).test(t))()}catch(e){throw e}}const Is={timeout:400};function As(e){return!(e.length>45)&&Rs(Ss.v6({exact:!0}),e,Is)}const xs={http:"80",https:"443",ws:"80",wss:"443"},Ts=["http","https","ws","wss"];function Cs(e,t){const n=(t=t??{}).defaultDnsType??"dns4",{scheme:r,hostname:i,port:o,path:s}=function(e){const[t]=e.split(":");Ts.includes(t)||(e="http"+e.substring(t.length));let n,{protocol:r,hostname:i,port:o,pathname:s,search:a}=new URL(e);if(null==o||""===o){const e=function(e){if(null!=e&&""!==e&&null!=xs[e])return xs[e]}(t);null!=e&&(o=e),null==e&&"http:"===r&&(o="80")}return null!=s&&""!==s&&"/"!==s&&(s.startsWith("/")&&(s=s.substring(1)),n=s),null!=a&&""!==a&&(n=n??"",n+=a),{scheme:t,hostname:i,port:o,path:n}}(e),a=[Ns(i,n),Ds(o,r),Ps(r)];null!=s&&a.push(function(e){if(null!=e&&""!==e)return["http-path",encodeURIComponent(e)]}(s));const l="/"+a.filter(e=>Boolean(e)).reduce((e,t)=>e.concat(t),[]).join("/");return Wo(l)}function Ns(e,t){if(null!=e&&""!==e){if(function(e){return!(e.length>15)&&Rs(Ss.v4({exact:!0}),e,Is)}(e))return["ip4",e];if(As(e))return["ip6",e];if("["===e[0]){const t=e.substring(1,e.length-1);if(As(t))return["ip6",t]}return[t,e]}}function Ds(e,t){if(null!=e&&""!==e)return"udp"===t?["udp",e]:["tcp",e]}function Ps(e){if(null==e.match(/^tcp$|^udp$/))return[e]}const Ls=["https://trustless-gateway.link","https://4everland.io"],Bs=Symbol.for("nodejs.util.inspect.custom");class Os{type="url";multihash;privateKey;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=kn.digest(Hn(this.url))}[Bs](){return`PeerId(${this.url})`}[_r]=!0;toString(){return this.toCID().toString()}toCID(){return Pn.createV1(2336,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Ir(e)),e.toString()===this.toString())}}class Ms{gateways;constructor(e={}){this.gateways=(e.gateways??Ls).map(e=>function(e){return e=e.toString(),{id:new Os(new URL(e)),multiaddrs:[Cs(e)]}}(e))}async*findProviders(e,t){yield*this.gateways.toSorted(()=>Math.random()>.5?1:-1).map(e=>({...e,protocols:["transport-ipfs-gateway-http"]}))}}function Us(e={}){return new Ms(e)}var Fs=n(310);function zs(e){return e=e??new Error("Open failed"),Fs(e,"ERR_OPEN_FAILED")}function Vs(e){return e=e??new Error("Close failed"),Fs(e,"ERR_CLOSE_FAILED")}function $s(e){return e=e??new Error("Put failed"),Fs(e,"ERR_PUT_FAILED")}function Hs(e){return e=e??new Error("Get failed"),Fs(e,"ERR_GET_FAILED")}function Ks(e){return e=e??new Error("Delete failed"),Fs(e,"ERR_DELETE_FAILED")}function qs(e){return e=e??new Error("Has failed"),Fs(e,"ERR_HAS_FAILED")}function js(e){return e=e??new Error("Not Found"),Fs(e,"ERR_NOT_FOUND")}function Ws(e){return e=e??new Error("Aborted"),Fs(e,"ERR_ABORTED")}class Gs{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:n,block:r}of e)await this.put(n,r,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}}class Ys extends Gs{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(Rt.encode(e.multihash.bytes),t),e}get(e){const t=this.data.get(Rt.encode(e.multihash.bytes));if(null==t)throw js();return t}has(e){return this.data.has(Rt.encode(e.multihash.bytes))}async delete(e){this.data.delete(Rt.encode(e.multihash.bytes))}async*getAll(){for(const[e,t]of this.data.entries())yield{cid:Pn.createV1(Xt,vn(Rt.decode(e))),block:t}}}const Qs=1e3,Xs=60*Qs,Zs=60*Xs,Js=24*Zs,ea=7*Js,ta=365.25*Js,na=ta/12;var ra=function(e,t){if("string"==typeof e)return ia(e);if("number"==typeof e)return function(e,t){if("number"!=typeof e||!Number.isFinite(e))throw Error("Value provided to ms.format() must be of type number.");return t?.long?sa(e):oa(e)}(e,t);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(e)}`)};function ia(e){if("string"!=typeof e||0===e.length||e.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(e)}`);let t=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(e);if(!t?.groups)return NaN;let{value:n,unit:r="ms"}=t.groups,i=parseFloat(n),o=r.toLowerCase();switch(o){case"years":case"year":case"yrs":case"yr":case"y":return i*ta;case"months":case"month":case"mo":return i*na;case"weeks":case"week":case"w":return i*ea;case"days":case"day":case"d":return i*Js;case"hours":case"hour":case"hrs":case"hr":case"h":return i*Zs;case"minutes":case"minute":case"mins":case"min":case"m":return i*Xs;case"seconds":case"second":case"secs":case"sec":case"s":return i*Qs;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:throw Error(`Unknown unit "${o}" provided to ms.parse(). value=${JSON.stringify(e)}`)}}function oa(e){let t=Math.abs(e);return t>=ta?`${Math.round(e/ta)}y`:t>=na?`${Math.round(e/na)}mo`:t>=ea?`${Math.round(e/ea)}w`:t>=Js?`${Math.round(e/Js)}d`:t>=Zs?`${Math.round(e/Zs)}h`:t>=Xs?`${Math.round(e/Xs)}m`:t>=Qs?`${Math.round(e/Qs)}s`:`${e}ms`}function sa(e){let t=Math.abs(e);return t>=ta?aa(e,t,ta,"year"):t>=na?aa(e,t,na,"month"):t>=ea?aa(e,t,ea,"week"):t>=Js?aa(e,t,Js,"day"):t>=Zs?aa(e,t,Zs,"hour"):t>=Xs?aa(e,t,Xs,"minute"):t>=Qs?aa(e,t,Qs,"second"):`${e} ms`}function aa(e,t,n,r){let i=t>=1.5*n;return`${Math.round(e/n)} ${r}${i?"s":""}`}const la=function(){try{return localStorage}catch(e){}}(),ca=console.debug??console.log??(()=>{}),ua=function(e){function t(e){let r,i,o,s=null;function a(...e){if(!a.enabled)return;const n=a,i=Number(new Date),o=i-(r||i);n.diff=o,n.prev=r,n.curr=i,r=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(r,i)=>{if("%%"===r)return"%";s++;const o=t.formatters[i];if("function"==typeof o){const t=e[s];r=o.call(n,t),e.splice(s,1),s--}return r}),t.formatArgs.call(n,e),(n.log||t.log).apply(n,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==s?s:(i!==t.namespaces&&(i=t.namespaces,o=t.enabled(e)),o),set:e=>{s=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,n){const r=t(this.namespace+(void 0===n?":":n)+e);return r.log=this.log,r}function r(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack??e.message:e},t.disable=function(){const e=[...t.names.map(r),...t.skips.map(r).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),i=r.length;for(n=0;n<i;n++)r[n]&&("-"===(e=r[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=ra,t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(n=>{t[n]=e[n]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.setupFormatters(t.formatters),t.enable(t.load()),t}({formatArgs:function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+ra(this.diff),!this.useColors)return;const t="color: "+this.color;e.splice(1,0,t,"color: inherit");let n=0,r=0;e[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(n++,"%c"===e&&(r=n))}),e.splice(r,0,t)},save:function(e){try{e?la?.setItem("debug",e):la?.removeItem("debug")}catch(e){}},load:function(){let e;try{e=la?.getItem("debug")}catch(e){}return!e&&void 0!==globalThis.process&&"env"in globalThis.process&&(e=globalThis.process.env.DEBUG),e},useColors:function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||null==navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement?.style?.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&null!=navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/))},setupFormatters:function(e){e.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},colors:["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],storage:la,log:ca}),da=ua;function ha(){return{forComponent:e=>fa(e)}}function fa(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}(`${e}:trace`);return da.enabled(`${e}:trace`)&&null!=da.names.map(e=>e.toString()).find(e=>e.includes(":trace"))&&(t=da(`${e}:trace`)),Object.assign(da(e),{error:da(`${e}:error`),trace:t})}da.formatters.b=e=>null==e?"undefined":Ot.baseEncode(e),da.formatters.t=e=>null==e?"undefined":Rt.baseEncode(e),da.formatters.m=e=>null==e?"undefined":Ut.baseEncode(e),da.formatters.p=e=>null==e?"undefined":e.toString(),da.formatters.c=e=>null==e?"undefined":e.toString(),da.formatters.k=e=>null==e?"undefined":e.toString(),da.formatters.a=e=>null==e?"undefined":e.toString();const pa=function(e,t){let n=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const r of e)await t(r,n++)&&(yield r)}();const r=Ae(e),{value:i,done:o}=r.next();if(!0===o)return function*(){}();const s=t(i,n++);if("function"==typeof s.then)return async function*(){await s&&(yield i);for(const e of r)await t(e,n++)&&(yield e)}();const a=t;return function*(){!0===s&&(yield i);for(const e of r)a(e,n++)&&(yield e)}()};fa("blockstore:core:tiered");const ga={...g};const ma="/",ya=(new TextEncoder).encode(ma),wa=ya[0];class ba{_buf;constructor(e,t){if("string"==typeof e)this._buf=Hn(e);else{if(!(e instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=e}if(null==t&&(t=!0),t&&this.clean(),0===this._buf.byteLength||this._buf[0]!==wa)throw new Error("Invalid key")}toString(e="utf8"){return Ir(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new ba(e.join(ma))}static random(){return new ba(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||"string"==typeof e?new ba(e):"function"==typeof e.uint8Array?new ba(e.uint8Array()):null}clean(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=ya),this._buf[0]!==wa){const e=new Uint8Array(this._buf.byteLength+1);e.fill(wa,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===wa;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let e=0;e<t.length;e++){if(n.length<e+1)return!1;const r=t[e],i=n[e];if(r<i)return!0;if(r>i)return!1}return t.length<n.length}reverse(){return ba.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(ma).slice(1)}type(){return function(e){const t=e.split(":");return t.length<2?"":t.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(e){const t=e.split(":");return t[t.length-1]}(this.baseNamespace())}instance(e){return new ba(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(ma)||(e+=ma),e+=this.type(),new ba(e)}parent(){const e=this.list();return 1===e.length?new ba(ma):new ba(e.slice(0,-1).join(ma))}child(e){return this.toString()===ma?e:e.toString()===ma?this:new ba(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}isTopLevel(){return 1===this.list().length}concat(...e){return ba.withNamespaces([...this.namespaces(),...(t=e.map(e=>e.namespaces()),[].concat(...t))]);var t}}const va=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{const t=[];for await(const n of e)t.push(n);return t})();const t=[];for(const n of e)t.push(n);return t},Ea=function(e,t){return null!=e[Symbol.asyncIterator]?async function*(){const n=await va(e);yield*n.sort(t)}():function*(){const n=va(e);yield*n.sort(t)}()};class Sa{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:r}of e)await this.put(n,r,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(t,n){e.push({key:t,value:n})},delete(e){t.push(e)},commit:async n=>{await G(this.putMany(e,n)),e=[],await G(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(null!=e.prefix){const t=e.prefix;n=pa(n,e=>e.key.toString().startsWith(t))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((e,t)=>pa(e,t),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((e,t)=>Ea(e,t),n)),null!=e.offset){let t=0;const r=e.offset;n=pa(n,()=>t++>=r)}return null!=e.limit&&(n=Ue(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(null!=e.prefix){const t=e.prefix;n=pa(n,e=>e.toString().startsWith(t))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((e,t)=>pa(e,t),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((e,t)=>Ea(e,t),n)),null!=e.offset){const t=e.offset;let r=0;n=pa(n,()=>r++>=t)}return null!=e.limit&&(n=Ue(n,e.limit)),n}}class ka extends Sa{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){const t=this.data.get(e.toString());if(null==t)throw n=n??new Error("Not Found"),Fs(n,"ERR_NOT_FOUND");var n;return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(const[e,t]of this.data.entries())yield{key:new ba(e),value:t}}*_allKeys(){for(const e of this.data.keys())yield new ba(e)}}new ba("SHARDING"),fa("datastore:core:tiered");const _a=Symbol.for("@libp2p/content-routing"),Ra=Symbol.for("@libp2p/peer-routing");function Ia(e){return null!=e&&"function"==typeof e.start&&"function"==typeof e.stop}async function Aa(...e){const t=[];for(const n of e)Ia(n)&&t.push(n);await Promise.all(t.map(async e=>{null!=e.beforeStart&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{null!=e.afterStart&&await e.afterStart()}))}async function xa(...e){const t=[];for(const n of e)Ia(n)&&t.push(n);await Promise.all(t.map(async e=>{null!=e.beforeStop&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{null!=e.afterStop&&await e.afterStop()}))}var Ta=n(228);class Ca extends Error{constructor(e){super(e),this.name="TimeoutError"}}class Na extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const Da=e=>void 0===globalThis.DOMException?new Na(e):new DOMException(e),Pa=e=>{const t=void 0===e.reason?Da("This operation was aborted."):e.reason;return t instanceof Error?t:Da(t)};function La(e,t){const{milliseconds:n,fallback:r,message:i,customTimers:o={setTimeout,clearTimeout}}=t;let s,a;const l=new Promise((l,c)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(t.signal){const{signal:e}=t;e.aborted&&c(Pa(e)),a=()=>{c(Pa(e))},e.addEventListener("abort",a,{once:!0})}if(n===Number.POSITIVE_INFINITY)return void e.then(l,c);const u=new Ca;s=o.setTimeout.call(void 0,()=>{if(r)try{l(r())}catch(e){c(e)}else"function"==typeof e.cancel&&e.cancel(),!1===i?l():i instanceof Error?c(i):(u.message=i??`Promise timed out after ${n} milliseconds`,c(u))},n),(async()=>{try{l(await e)}catch(e){c(e)}})()}).finally(()=>{l.clear(),a&&t.signal&&t.signal.removeEventListener("abort",a)});return l.clear=()=>{o.clearTimeout.call(void 0,s),s=void 0},l}class Ba{#u=[];enqueue(e,t){const n={priority:(t={priority:0,...t}).priority,id:t.id,run:e};if(0===this.size||this.#u[this.size-1].priority>=t.priority)return void this.#u.push(n);const r=function(e,t,n){let r=0,i=e.length;for(;i>0;){const o=Math.trunc(i/2);let s=r+o;n(e[s],t)<=0?(r=++s,i-=o+1):i=o}return r}(this.#u,n,(e,t)=>t.priority-e.priority);this.#u.splice(r,0,n)}setPriority(e,t){const n=this.#u.findIndex(t=>t.id===e);if(-1===n)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[r]=this.#u.splice(n,1);this.enqueue(r.run,{priority:t,id:e})}dequeue(){const e=this.#u.shift();return e?.run}filter(e){return this.#u.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this.#u.length}}class Oa extends Ta{#d;#h;#f=0;#p;#g;#m=0;#y;#w;#u;#b;#v=0;#E;#S;#k;#_=1n;timeout;constructor(e){if(super(),!("number"==typeof(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Ba,...e}).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#d=e.carryoverConcurrencyCount,this.#h=e.intervalCap===Number.POSITIVE_INFINITY||0===e.interval,this.#p=e.intervalCap,this.#g=e.interval,this.#u=new e.queueClass,this.#b=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#k=!0===e.throwOnTimeout,this.#S=!1===e.autoStart}get#R(){return this.#h||this.#f<this.#p}get#I(){return this.#v<this.#E}#A(){this.#v--,this.#x(),this.emit("next")}#T(){this.#C(),this.#N(),this.#w=void 0}get#D(){const e=Date.now();if(void 0===this.#y){const t=this.#m-e;if(!(t<0))return void 0===this.#w&&(this.#w=setTimeout(()=>{this.#T()},t)),!0;this.#f=this.#d?this.#v:0}return!1}#x(){if(0===this.#u.size)return this.#y&&clearInterval(this.#y),this.#y=void 0,this.emit("empty"),0===this.#v&&this.emit("idle"),!1;if(!this.#S){const e=!this.#D;if(this.#R&&this.#I){const t=this.#u.dequeue();return!!t&&(this.emit("active"),t(),e&&this.#N(),!0)}}return!1}#N(){this.#h||void 0!==this.#y||(this.#y=setInterval(()=>{this.#C()},this.#g),this.#m=Date.now()+this.#g)}#C(){0===this.#f&&0===this.#v&&this.#y&&(clearInterval(this.#y),this.#y=void 0),this.#f=this.#d?this.#v:0,this.#P()}#P(){for(;this.#x(););}get concurrency(){return this.#E}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#E=e,this.#P()}async#L(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(e.reason)},{once:!0})})}setPriority(e,t){this.#u.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#_++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#k,...t},new Promise((n,r)=>{this.#u.enqueue(async()=>{this.#v++;try{t.signal?.throwIfAborted(),this.#f++;let r=e({signal:t.signal});t.timeout&&(r=La(Promise.resolve(r),{milliseconds:t.timeout})),t.signal&&(r=Promise.race([r,this.#L(t.signal)]));const i=await r;n(i),this.emit("completed",i)}catch(e){if(e instanceof Ca&&!t.throwOnTimeout)return void n();r(e),this.emit("error",e)}finally{this.#A()}},t),this.emit("add"),this.#x()})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this.#S?(this.#S=!1,this.#P(),this):this}pause(){this.#S=!0}clear(){this.#u=new this.#b}async onEmpty(){0!==this.#u.size&&await this.#B("empty")}async onSizeLessThan(e){this.#u.size<e||await this.#B("next",()=>this.#u.size<e)}async onIdle(){0===this.#v&&0===this.#u.size||await this.#B("idle")}async#B(e,t){return new Promise(n=>{const r=()=>{t&&!t()||(this.off(e,r),n())};this.on(e,r)})}get size(){return this.#u.size}sizeBy(e){return this.#u.filter(e).length}get pending(){return this.#v}get isPaused(){return this.#S}}function Ma(e){const t=[za.A];return null==e?t:Array.isArray(e)?0===e.length?t:e:[e]}function Ua(e){return{Status:e.Status??0,TC:e.TC??e.flag_tc??!1,RD:e.RD??e.flag_rd??!1,RA:e.RA??e.flag_ra??!1,AD:e.AD??e.flag_ad??!1,CD:e.CD??e.flag_cd??!1,Question:(e.Question??e.questions??[]).map(e=>({name:e.name,type:za[e.type]})),Answer:(e.Answer??e.answers??[]).map(e=>({name:e.name,type:za[e.type],TTL:e.TTL??e.ttl??60,data:e.data instanceof Uint8Array?Ir(e.data):e.data}))}}function Fa(e,t={}){const n=new Oa({concurrency:t.queryConcurrency??4});return async(t,r={})=>{const i=new URLSearchParams;i.set("name",t),Ma(r.types).forEach(e=>{i.append("type",za[e])}),r.onProgress?.(new Fe("dns:query",t));const o=await n.add(async()=>{const t=await fetch(`${e}?${i}`,{headers:{accept:"application/dns-json"},signal:r?.signal});if(200!==t.status)throw new Error(`Unexpected HTTP status: ${t.status} - ${t.statusText}`);const n=Ua(await t.json());return r.onProgress?.(new Fe("dns:response",n)),n},{signal:r.signal});if(null==o)throw new Error("No DNS response received");return o}}var za,Va=n(194);class $a{lru;constructor(e){this.lru=Va(e)}get(e,t){let n=!0;const r=[];for(const i of t){const t=this.getAnswers(e,i);if(0===t.length){n=!1;break}r.push(...t)}if(n)return Ua({answers:r})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,r=this.lru.get(n);if(null!=r){const e=r.filter(e=>e.expires>Date.now()).map(({expires:e,value:t})=>({...t,TTL:Math.round((e-Date.now())/1e3),type:za[t.type]}));return 0===e.length&&this.lru.remove(n),e}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,r=this.lru.get(n)??[];r.push({expires:Date.now()+1e3*(t.TTL??60),value:t}),this.lru.set(n,r)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}class Ha{resolvers;cache;constructor(e){var t;this.resolvers={},this.cache=(t=e.cacheSize??1e3,new $a(t)),Object.entries(e.resolvers??{}).forEach(([e,t])=>{Array.isArray(t)||(t=[t]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=t}),null==this.resolvers["."]&&(this.resolvers["."]=[Fa("https://cloudflare-dns.com/dns-query"),Fa("https://dns.google/resolve")])}async query(e,t={}){const n=Ma(t.types),r=!1!==t.cached?this.cache.get(e,n):void 0;if(null!=r)return t.onProgress?.(new Fe("dns:cache",r)),r;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),s=[];for(const r of o){if(!0===t.signal?.aborted)break;try{const i=await r(e,{...t,types:n});for(const t of i.Answer)this.cache.add(e,t);return i}catch(e){s.push(e),t.onProgress?.(new Fe("dns:error",e))}}if(1===s.length)throw s[0];throw new AggregateError(s,`DNS lookup of ${e} ${n} failed`)}}function Ka(e={}){return new Ha(e)}!function(e){e[e.A=1]="A",e[e.CNAME=5]="CNAME",e[e.TXT=16]="TXT",e[e.AAAA=28]="AAAA"}(za||(za={}));const qa=["string","number","bigint","symbol"],ja=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];class Wa{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}Wa.uint=new Wa(0,"uint",!0),Wa.negint=new Wa(1,"negint",!0),Wa.bytes=new Wa(2,"bytes",!0),Wa.string=new Wa(3,"string",!0),Wa.array=new Wa(4,"array",!1),Wa.map=new Wa(5,"map",!1),Wa.tag=new Wa(6,"tag",!1),Wa.float=new Wa(7,"float",!0),Wa.false=new Wa(7,"false",!0),Wa.true=new Wa(7,"true",!0),Wa.null=new Wa(7,"null",!0),Wa.undefined=new Wa(7,"undefined",!0),Wa.break=new Wa(7,"break",!0);class Ga{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const Ya=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&"function"==typeof globalThis.Buffer.isBuffer,Qa=new TextDecoder,Xa=new TextEncoder;function Za(e){return Ya&&globalThis.Buffer.isBuffer(e)}function Ja(e){return e instanceof Uint8Array?Za(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e:Uint8Array.from(e)}const el=Ya?(e,t,n)=>n-t>64?globalThis.Buffer.from(e.subarray(t,n)).toString("utf8"):al(e,t,n):(e,t,n)=>n-t>64?Qa.decode(e.subarray(t,n)):al(e,t,n),tl=Ya?e=>e.length>64?globalThis.Buffer.from(e):sl(e):e=>e.length>64?Xa.encode(e):sl(e),nl=e=>Uint8Array.from(e),rl=Ya?(e,t,n)=>Za(e)?new Uint8Array(e.subarray(t,n)):e.slice(t,n):(e,t,n)=>e.slice(t,n),il=Ya?(e,t)=>(e=e.map(e=>e instanceof Uint8Array?e:globalThis.Buffer.from(e)),Ja(globalThis.Buffer.concat(e,t))):(e,t)=>{const n=new Uint8Array(t);let r=0;for(let t of e)r+t.length>n.length&&(t=t.subarray(0,n.length-r)),n.set(t,r),r+=t.length;return n},ol=Ya?e=>globalThis.Buffer.allocUnsafe(e):e=>new Uint8Array(e);function sl(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t}function al(e,t,n){const r=[];for(;t<n;){const i=e[t];let o=null,s=i>239?4:i>223?3:i>191?2:1;if(t+s<=n){let n,r,a,l;switch(s){case 1:i<128&&(o=i);break;case 2:n=e[t+1],128==(192&n)&&(l=(31&i)<<6|63&n,l>127&&(o=l));break;case 3:n=e[t+1],r=e[t+2],128==(192&n)&&128==(192&r)&&(l=(15&i)<<12|(63&n)<<6|63&r,l>2047&&(l<55296||l>57343)&&(o=l));break;case 4:n=e[t+1],r=e[t+2],a=e[t+3],128==(192&n)&&128==(192&r)&&128==(192&a)&&(l=(15&i)<<18|(63&n)<<12|(63&r)<<6|63&a,l>65535&&l<1114112&&(o=l))}}null===o?(o=65533,s=1):o>65535&&(o-=65536,r.push(o>>>10&1023|55296),o=56320|1023&o),r.push(o),t+=s}return cl(r)}const ll=4096;function cl(e){const t=e.length;if(t<=ll)return String.fromCharCode.apply(String,e);let n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=ll));return n}class ul{constructor(e=256){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),null!==this._initReuseChunk&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const n=t.length-(this.maxCursor-this.cursor)-1;t.set(e,n)}else{if(t){const e=t.length-(this.maxCursor-this.cursor)-1;e<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,e),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=ol(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,null===this._initReuseChunk&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(1===this.chunks.length){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=rl(n,0,this.cursor)}else t=il(this.chunks,this.cursor);return e&&this.reset(),t}}const dl="CBOR decode error:",hl="CBOR encode error:",fl=[];function pl(e,t,n){if(e.length-t<n)throw new Error(`${dl} not enough data for type`)}fl[23]=1,fl[24]=2,fl[25]=3,fl[26]=5,fl[27]=9;const gl=[24,256,65536,4294967296,BigInt("18446744073709551616")];function ml(e,t,n){pl(e,t,1);const r=e[t];if(!0===n.strict&&r<gl[0])throw new Error(`${dl} integer encoded in more bytes than necessary (strict decode)`);return r}function yl(e,t,n){pl(e,t,2);const r=e[t]<<8|e[t+1];if(!0===n.strict&&r<gl[1])throw new Error(`${dl} integer encoded in more bytes than necessary (strict decode)`);return r}function wl(e,t,n){pl(e,t,4);const r=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];if(!0===n.strict&&r<gl[2])throw new Error(`${dl} integer encoded in more bytes than necessary (strict decode)`);return r}function bl(e,t,n){pl(e,t,8);const r=16777216*e[t]+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3],i=16777216*e[t+4]+(e[t+5]<<16)+(e[t+6]<<8)+e[t+7],o=(BigInt(r)<<BigInt(32))+BigInt(i);if(!0===n.strict&&o<gl[3])throw new Error(`${dl} integer encoded in more bytes than necessary (strict decode)`);if(o<=Number.MAX_SAFE_INTEGER)return Number(o);if(!0===n.allowBigInt)return o;throw new Error(`${dl} integers outside of the safe integer range are not supported`)}function vl(e,t){return El(e,0,t.value)}function El(e,t,n){if(n<gl[0]){const r=Number(n);e.push([t|r])}else if(n<gl[1]){const r=Number(n);e.push([24|t,r])}else if(n<gl[2]){const r=Number(n);e.push([25|t,r>>>8,255&r])}else if(n<gl[3]){const r=Number(n);e.push([26|t,r>>>24&255,r>>>16&255,r>>>8&255,255&r])}else{const r=BigInt(n);if(!(r<gl[4]))throw new Error(`${dl} encountered BigInt larger than allowable range`);{const n=[27|t,0,0,0,0,0,0,0];let i=Number(r&BigInt(4294967295)),o=Number(r>>BigInt(32)&BigInt(4294967295));n[8]=255&i,i>>=8,n[7]=255&i,i>>=8,n[6]=255&i,i>>=8,n[5]=255&i,n[4]=255&o,o>>=8,n[3]=255&o,o>>=8,n[2]=255&o,o>>=8,n[1]=255&o,e.push(n)}}}vl.encodedSize=function(e){return El.encodedSize(e.value)},El.encodedSize=function(e){return e<gl[0]?1:e<gl[1]?2:e<gl[2]?3:e<gl[3]?5:9},vl.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};const Sl=BigInt(-1),kl=BigInt(1);function _l(e,t){const n=t.value,r="bigint"==typeof n?n*Sl-kl:-1*n-1;El(e,t.type.majorEncoded,r)}function Rl(e,t,n,r){pl(e,t,n+r);const i=rl(e,t+n,t+n+r);return new Ga(Wa.bytes,i,n+r)}function Il(e,t,n,r){return Rl(e,t,1,n)}function Al(e){return void 0===e.encodedBytes&&(e.encodedBytes=e.type===Wa.string?tl(e.value):e.value),e.encodedBytes}function xl(e,t){const n=Al(t);El(e,t.type.majorEncoded,n.length),e.push(n)}function Tl(e,t,n,r,i){const o=n+r;pl(e,t,o);const s=new Ga(Wa.string,el(e,t+n,t+o),o);return!0===i.retainStringBytes&&(s.byteValue=rl(e,t+n,t+o)),s}function Cl(e,t,n,r){return Tl(e,t,1,n,r)}_l.encodedSize=function(e){const t=e.value,n="bigint"==typeof t?t*Sl-kl:-1*t-1;return n<gl[0]?1:n<gl[1]?2:n<gl[2]?3:n<gl[3]?5:9},_l.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0},xl.encodedSize=function(e){const t=Al(e);return El.encodedSize(t.length)+t.length},xl.compareTokens=function(e,t){return n=Al(e),r=Al(t),n.length<r.length?-1:n.length>r.length?1:function(e,t){if(Za(e)&&Za(t))return e.compare(t);for(let n=0;n<e.length;n++)if(e[n]!==t[n])return e[n]<t[n]?-1:1;return 0}(n,r);var n,r};const Nl=xl;function Dl(e,t,n,r){return new Ga(Wa.array,r,n)}function Pl(e,t,n,r){return Dl(0,0,1,n)}function Ll(e,t){El(e,Wa.array.majorEncoded,t.value)}function Bl(e,t,n,r){return new Ga(Wa.map,r,n)}function Ol(e,t,n,r){return Bl(0,0,1,n)}function Ml(e,t){El(e,Wa.map.majorEncoded,t.value)}function Ul(e,t,n,r){return new Ga(Wa.tag,n,1)}function Fl(e,t){El(e,Wa.tag.majorEncoded,t.value)}function zl(e,t,n){if(n){if(!1===n.allowNaN&&Number.isNaN(e))throw new Error(`${dl} NaN values are not supported`);if(!1===n.allowInfinity&&(e===1/0||e===-1/0))throw new Error(`${dl} Infinity values are not supported`)}return new Ga(Wa.float,e,t)}function Vl(e,t,n){const r=t.value;if(!1===r)e.push([20|Wa.float.majorEncoded]);else if(!0===r)e.push([21|Wa.float.majorEncoded]);else if(null===r)e.push([22|Wa.float.majorEncoded]);else if(void 0===r)e.push([23|Wa.float.majorEncoded]);else{let t,o=!1;n&&!0===n.float64||(ql(r),t=jl(Kl,1),r===t||Number.isNaN(r)?(Kl[0]=249,e.push(Kl.slice(0,3)),o=!0):(Wl(r),t=Gl(Kl,1),r===t&&(Kl[0]=250,e.push(Kl.slice(0,5)),o=!0))),o||(i=r,Hl.setFloat64(0,i,!1),t=Yl(Kl,1),Kl[0]=251,e.push(Kl.slice(0,9)))}var i}Ll.compareTokens=vl.compareTokens,Ll.encodedSize=function(e){return El.encodedSize(e.value)},Ml.compareTokens=vl.compareTokens,Ml.encodedSize=function(e){return El.encodedSize(e.value)},Fl.compareTokens=vl.compareTokens,Fl.encodedSize=function(e){return El.encodedSize(e.value)},Vl.encodedSize=function(e,t){const n=e.value;if(!1===n||!0===n||null==n)return 1;if(!t||!0!==t.float64){ql(n);let e=jl(Kl,1);if(n===e||Number.isNaN(n))return 3;if(Wl(n),e=Gl(Kl,1),n===e)return 5}return 9};const $l=new ArrayBuffer(9),Hl=new DataView($l,1),Kl=new Uint8Array($l,0);function ql(e){if(e===1/0)Hl.setUint16(0,31744,!1);else if(e===-1/0)Hl.setUint16(0,64512,!1);else if(Number.isNaN(e))Hl.setUint16(0,32256,!1);else{Hl.setFloat32(0,e);const t=Hl.getUint32(0),n=(2139095040&t)>>23,r=8388607&t;if(255===n)Hl.setUint16(0,31744,!1);else if(0===n)Hl.setUint16(0,(2147483648&e)>>16|r>>13,!1);else{const e=n-127;e<-24?Hl.setUint16(0,0):e<-14?Hl.setUint16(0,(2147483648&t)>>16|1<<24+e,!1):Hl.setUint16(0,(2147483648&t)>>16|e+15<<10|r>>13,!1)}}}function jl(e,t){if(e.length-t<2)throw new Error(`${dl} not enough data for float16`);const n=(e[t]<<8)+e[t+1];if(31744===n)return 1/0;if(64512===n)return-1/0;if(32256===n)return NaN;const r=n>>10&31,i=1023&n;let o;return o=0===r?i*2**-24:31!==r?(i+1024)*2**(r-25):0===i?1/0:NaN,32768&n?-o:o}function Wl(e){Hl.setFloat32(0,e,!1)}function Gl(e,t){if(e.length-t<4)throw new Error(`${dl} not enough data for float32`);const n=(e.byteOffset||0)+t;return new DataView(e.buffer,n,4).getFloat32(0,!1)}function Yl(e,t){if(e.length-t<8)throw new Error(`${dl} not enough data for float64`);const n=(e.byteOffset||0)+t;return new DataView(e.buffer,n,8).getFloat64(0,!1)}function Ql(e,t,n){throw new Error(`${dl} encountered invalid minor (${n}) for major ${e[t]>>>5}`)}function Xl(e){return()=>{throw new Error(`${dl} ${e}`)}}Vl.compareTokens=vl.compareTokens;const Zl=[];for(let e=0;e<=23;e++)Zl[e]=Ql;Zl[24]=function(e,t,n,r){return new Ga(Wa.uint,ml(e,t+1,r),2)},Zl[25]=function(e,t,n,r){return new Ga(Wa.uint,yl(e,t+1,r),3)},Zl[26]=function(e,t,n,r){return new Ga(Wa.uint,wl(e,t+1,r),5)},Zl[27]=function(e,t,n,r){return new Ga(Wa.uint,bl(e,t+1,r),9)},Zl[28]=Ql,Zl[29]=Ql,Zl[30]=Ql,Zl[31]=Ql;for(let e=32;e<=55;e++)Zl[e]=Ql;Zl[56]=function(e,t,n,r){return new Ga(Wa.negint,-1-ml(e,t+1,r),2)},Zl[57]=function(e,t,n,r){return new Ga(Wa.negint,-1-yl(e,t+1,r),3)},Zl[58]=function(e,t,n,r){return new Ga(Wa.negint,-1-wl(e,t+1,r),5)},Zl[59]=function(e,t,n,r){const i=bl(e,t+1,r);if("bigint"!=typeof i){const e=-1-i;if(e>=Number.MIN_SAFE_INTEGER)return new Ga(Wa.negint,e,9)}if(!0!==r.allowBigInt)throw new Error(`${dl} integers outside of the safe integer range are not supported`);return new Ga(Wa.negint,Sl-BigInt(i),9)},Zl[60]=Ql,Zl[61]=Ql,Zl[62]=Ql,Zl[63]=Ql;for(let e=64;e<=87;e++)Zl[e]=Il;Zl[88]=function(e,t,n,r){return Rl(e,t,2,ml(e,t+1,r))},Zl[89]=function(e,t,n,r){return Rl(e,t,3,yl(e,t+1,r))},Zl[90]=function(e,t,n,r){return Rl(e,t,5,wl(e,t+1,r))},Zl[91]=function(e,t,n,r){const i=bl(e,t+1,r);if("bigint"==typeof i)throw new Error(`${dl} 64-bit integer bytes lengths not supported`);return Rl(e,t,9,i)},Zl[92]=Ql,Zl[93]=Ql,Zl[94]=Ql,Zl[95]=Xl("indefinite length bytes/strings are not supported");for(let e=96;e<=119;e++)Zl[e]=Cl;Zl[120]=function(e,t,n,r){return Tl(e,t,2,ml(e,t+1,r),r)},Zl[121]=function(e,t,n,r){return Tl(e,t,3,yl(e,t+1,r),r)},Zl[122]=function(e,t,n,r){return Tl(e,t,5,wl(e,t+1,r),r)},Zl[123]=function(e,t,n,r){const i=bl(e,t+1,r);if("bigint"==typeof i)throw new Error(`${dl} 64-bit integer string lengths not supported`);return Tl(e,t,9,i,r)},Zl[124]=Ql,Zl[125]=Ql,Zl[126]=Ql,Zl[127]=Xl("indefinite length bytes/strings are not supported");for(let e=128;e<=151;e++)Zl[e]=Pl;Zl[152]=function(e,t,n,r){return Dl(0,0,2,ml(e,t+1,r))},Zl[153]=function(e,t,n,r){return Dl(0,0,3,yl(e,t+1,r))},Zl[154]=function(e,t,n,r){return Dl(0,0,5,wl(e,t+1,r))},Zl[155]=function(e,t,n,r){const i=bl(e,t+1,r);if("bigint"==typeof i)throw new Error(`${dl} 64-bit integer array lengths not supported`);return Dl(0,0,9,i)},Zl[156]=Ql,Zl[157]=Ql,Zl[158]=Ql,Zl[159]=function(e,t,n,r){if(!1===r.allowIndefinite)throw new Error(`${dl} indefinite length items not allowed`);return Dl(0,0,1,1/0)};for(let e=160;e<=183;e++)Zl[e]=Ol;Zl[184]=function(e,t,n,r){return Bl(0,0,2,ml(e,t+1,r))},Zl[185]=function(e,t,n,r){return Bl(0,0,3,yl(e,t+1,r))},Zl[186]=function(e,t,n,r){return Bl(0,0,5,wl(e,t+1,r))},Zl[187]=function(e,t,n,r){const i=bl(e,t+1,r);if("bigint"==typeof i)throw new Error(`${dl} 64-bit integer map lengths not supported`);return Bl(0,0,9,i)},Zl[188]=Ql,Zl[189]=Ql,Zl[190]=Ql,Zl[191]=function(e,t,n,r){if(!1===r.allowIndefinite)throw new Error(`${dl} indefinite length items not allowed`);return Bl(0,0,1,1/0)};for(let e=192;e<=215;e++)Zl[e]=Ul;Zl[216]=function(e,t,n,r){return new Ga(Wa.tag,ml(e,t+1,r),2)},Zl[217]=function(e,t,n,r){return new Ga(Wa.tag,yl(e,t+1,r),3)},Zl[218]=function(e,t,n,r){return new Ga(Wa.tag,wl(e,t+1,r),5)},Zl[219]=function(e,t,n,r){return new Ga(Wa.tag,bl(e,t+1,r),9)},Zl[220]=Ql,Zl[221]=Ql,Zl[222]=Ql,Zl[223]=Ql;for(let e=224;e<=243;e++)Zl[e]=Xl("simple values are not supported");Zl[244]=Ql,Zl[245]=Ql,Zl[246]=Ql,Zl[247]=function(e,t,n,r){if(!1===r.allowUndefined)throw new Error(`${dl} undefined values are not supported`);return!0===r.coerceUndefinedToNull?new Ga(Wa.null,null,1):new Ga(Wa.undefined,void 0,1)},Zl[248]=Xl("simple values are not supported"),Zl[249]=function(e,t,n,r){return zl(jl(e,t+1),3,r)},Zl[250]=function(e,t,n,r){return zl(Gl(e,t+1),5,r)},Zl[251]=function(e,t,n,r){return zl(Yl(e,t+1),9,r)},Zl[252]=Ql,Zl[253]=Ql,Zl[254]=Ql,Zl[255]=function(e,t,n,r){if(!1===r.allowIndefinite)throw new Error(`${dl} indefinite length items not allowed`);return new Ga(Wa.break,void 0,1)};const Jl=[];for(let e=0;e<24;e++)Jl[e]=new Ga(Wa.uint,e,1);for(let e=-1;e>=-24;e--)Jl[31-e]=new Ga(Wa.negint,e,1);Jl[64]=new Ga(Wa.bytes,new Uint8Array(0),1),Jl[96]=new Ga(Wa.string,"",1),Jl[128]=new Ga(Wa.array,0,1),Jl[160]=new Ga(Wa.map,0,1),Jl[244]=new Ga(Wa.false,!1,1),Jl[245]=new Ga(Wa.true,!0,1),Jl[246]=new Ga(Wa.null,null,1);const ec={float64:!1,mapSorter:function(e,t){const n=Array.isArray(e[0])?e[0][0]:e[0],r=Array.isArray(t[0])?t[0][0]:t[0];if(n.type!==r.type)return n.type.compare(r.type);const i=n.type.major,o=nc[i].compareTokens(n,r);return 0===o&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),o},quickEncodeToken:function(e){switch(e.type){case Wa.false:return nl([244]);case Wa.true:return nl([245]);case Wa.null:return nl([246]);case Wa.bytes:return e.value.length?void 0:nl([64]);case Wa.string:return""===e.value?nl([96]):void 0;case Wa.array:return 0===e.value?nl([128]):void 0;case Wa.map:return 0===e.value?nl([160]):void 0;case Wa.uint:return e.value<24?nl([Number(e.value)]):void 0;case Wa.negint:if(e.value>=-24)return nl([31-Number(e.value)])}}};function tc(){const e=[];return e[Wa.uint.major]=vl,e[Wa.negint.major]=_l,e[Wa.bytes.major]=xl,e[Wa.string.major]=Nl,e[Wa.array.major]=Ll,e[Wa.map.major]=Ml,e[Wa.tag.major]=Fl,e[Wa.float.major]=Vl,e}const nc=tc(),rc=new ul;class ic{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do{if(t.obj===e)return!0}while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${hl} object contains circular references`);return new ic(t,e)}}const oc={null:new Ga(Wa.null,null),undefined:new Ga(Wa.undefined,void 0),true:new Ga(Wa.true,!0),false:new Ga(Wa.false,!1),emptyArray:new Ga(Wa.array,0),emptyMap:new Ga(Wa.map,0)},sc={number:(e,t,n,r)=>Number.isInteger(e)&&Number.isSafeInteger(e)?new Ga(e>=0?Wa.uint:Wa.negint,e):new Ga(Wa.float,e),bigint:(e,t,n,r)=>e>=BigInt(0)?new Ga(Wa.uint,e):new Ga(Wa.negint,e),Uint8Array:(e,t,n,r)=>new Ga(Wa.bytes,e),string:(e,t,n,r)=>new Ga(Wa.string,e),boolean:(e,t,n,r)=>e?oc.true:oc.false,null:(e,t,n,r)=>oc.null,undefined:(e,t,n,r)=>oc.undefined,ArrayBuffer:(e,t,n,r)=>new Ga(Wa.bytes,new Uint8Array(e)),DataView:(e,t,n,r)=>new Ga(Wa.bytes,new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),Array(e,t,n,r){if(!e.length)return!0===n.addBreakTokens?[oc.emptyArray,new Ga(Wa.break)]:oc.emptyArray;r=ic.createCheck(r,e);const i=[];let o=0;for(const t of e)i[o++]=ac(t,n,r);return n.addBreakTokens?[new Ga(Wa.array,e.length),i,new Ga(Wa.break)]:[new Ga(Wa.array,e.length),i]},Object(e,t,n,r){const i="Object"!==t,o=i?e.keys():Object.keys(e),s=i?e.size:o.length;if(!s)return!0===n.addBreakTokens?[oc.emptyMap,new Ga(Wa.break)]:oc.emptyMap;r=ic.createCheck(r,e);const a=[];let l=0;for(const t of o)a[l++]=[ac(t,n,r),ac(i?e.get(t):e[t],n,r)];return function(e,t){t.mapSorter&&e.sort(t.mapSorter)}(a,n),n.addBreakTokens?[new Ga(Wa.map,s),a,new Ga(Wa.break)]:[new Ga(Wa.map,s),a]}};sc.Map=sc.Object,sc.Buffer=sc.Uint8Array;for(const e of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))sc[`${e}Array`]=sc.DataView;function ac(e,t={},n){const r=function(e){if(null===e)return"null";if(void 0===e)return"undefined";if(!0===e||!1===e)return"boolean";const t=typeof e;if(qa.includes(t))return t;if("function"===t)return"Function";if(Array.isArray(e))return"Array";if(function(e){return e&&e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer.call(null,e)}(e))return"Buffer";return function(e){const t=Object.prototype.toString.call(e).slice(8,-1);if(ja.includes(t))return t}(e)||"Object"}(e),i=t&&t.typeEncoders&&t.typeEncoders[r]||sc[r];if("function"==typeof i){const o=i(e,r,t,n);if(null!=o)return o}const o=sc[r];if(!o)throw new Error(`${hl} unsupported type: ${r}`);return o(e,r,t,n)}function lc(e,t,n,r){if(Array.isArray(t))for(const i of t)lc(e,i,n,r);else n[t.type.major](e,t,r)}function cc(e,t,n){const r=ac(e,n);if(!Array.isArray(r)&&n.quickEncodeToken){const e=n.quickEncodeToken(r);if(e)return e;const i=t[r.type.major];if(i.encodedSize){const e=i.encodedSize(r,n),t=new ul(e);if(i(t,r,n),1!==t.chunks.length)throw new Error(`Unexpected error: pre-calculated length for ${r} was wrong`);return Ja(t.chunks[0])}}return rc.reset(),lc(rc,r,t,n),rc.toBytes(!0)}function uc(e,t){return t=Object.assign({},ec,t),cc(e,nc,t)}const dc={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class hc{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=Jl[e];if(void 0===t){const n=Zl[e];if(!n)throw new Error(`${dl} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const r=31&e;t=n(this.data,this._pos,r,this.options)}return this._pos+=t.encodedLength,t}}const fc=Symbol.for("DONE"),pc=Symbol.for("BREAK");function gc(e,t){if(e.done())return fc;const n=e.next();if(n.type===Wa.break)return pc;if(n.type.terminal)return n.value;if(n.type===Wa.array)return function(e,t,n){const r=[];for(let i=0;i<e.value;i++){const o=gc(t,n);if(o===pc){if(e.value===1/0)break;throw new Error(`${dl} got unexpected break to lengthed array`)}if(o===fc)throw new Error(`${dl} found array but not enough entries (got ${i}, expected ${e.value})`);r[i]=o}return r}(n,e,t);if(n.type===Wa.map)return function(e,t,n){const r=!0===n.useMaps,i=r?void 0:{},o=r?new Map:void 0;for(let s=0;s<e.value;s++){const a=gc(t,n);if(a===pc){if(e.value===1/0)break;throw new Error(`${dl} got unexpected break to lengthed map`)}if(a===fc)throw new Error(`${dl} found map but not enough entries (got ${s} [no key], expected ${e.value})`);if(!0!==r&&"string"!=typeof a)throw new Error(`${dl} non-string keys not supported (got ${typeof a})`);if(!0===n.rejectDuplicateMapKeys&&(r&&o.has(a)||!r&&a in i))throw new Error(`${dl} found repeat map key "${a}"`);const l=gc(t,n);if(l===fc)throw new Error(`${dl} found map but not enough entries (got ${s} [no value], expected ${e.value})`);r?o.set(a,l):i[a]=l}return r?o:i}(n,e,t);if(n.type===Wa.tag){if(t.tags&&"function"==typeof t.tags[n.value]){const r=gc(e,t);return t.tags[n.value](r)}throw new Error(`${dl} tag not supported (${n.value})`)}throw new Error("unsupported")}function mc(e,t){const[n,r]=function(e,t){if(!(e instanceof Uint8Array))throw new Error(`${dl} data to decode must be a Uint8Array`);const n=(t=Object.assign({},dc,t)).tokenizer||new hc(e,t),r=gc(n,t);if(r===fc)throw new Error(`${dl} did not find any content to decode`);if(r===pc)throw new Error(`${dl} got unexpected break`);return[r,e.subarray(n.pos())]}(e,t);if(r.length>0)throw new Error(`${dl} too many terminals, data makes no sense`);return n}const yc="/pin/",wc="/pinned-block/",bc=Lt;function vc(e){return 0===e.version&&(e=e.toV1()),new ba(`${yc}${e.toString(bc)}`)}class Ec{datastore;blockstore;dagWalkers;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.dagWalkers=n}async*add(e,t={}){const n=vc(e);if(await this.datastore.has(n))throw new Error("Already pinned");const r=Math.round(t.depth??1/0);if(r<0)throw new Error("Depth must be greater than or equal to 0");const i=new j({concurrency:1});for await(const n of this.#O(e,i,{...t,depth:r}))await this.#M(n,t=>null==t.pinnedBy.find(t=>he(t,e.bytes))&&(t.pinCount++,t.pinnedBy.push(e.bytes),!0),t),yield n;const o={depth:r,metadata:t.metadata??{}};await this.datastore.put(n,uc(o),t)}async*#O(e,t,n){if(-1===n.depth)return;const r=this.dagWalkers[e.code];if(null==r)throw new Error(`No dag walker found for cid codec ${e.code}`);const i=await this.blockstore.get(e,n);yield e;for await(const e of r.walk(i))yield*await t.add(async()=>this.#O(e,t,{...n,depth:n.depth-1}))}async#M(e,t,n){const r=new ba(`${wc}${bc.encode(e.multihash.bytes)}`);let i={pinCount:0,pinnedBy:[]};try{i=mc(await this.datastore.get(r,n))}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}t(i)&&(0===i.pinCount&&await this.datastore.has(r)?await this.datastore.delete(r):(await this.datastore.put(r,uc(i),n),n.onProgress?.(new Fe("helia:pin:add",e))))}async*rm(e,t={}){const n=vc(e),r=mc(await this.datastore.get(n,t));await this.datastore.delete(n,t);const i=new j({concurrency:1});for await(const n of this.#O(e,i,{...t,depth:r.depth}))await this.#M(n,t=>(t.pinCount--,t.pinnedBy=t.pinnedBy.filter(t=>he(t,e.bytes)),!0),{...t,depth:r.depth}),yield n}async*ls(e={}){for await(const{key:t,value:n}of this.datastore.query({prefix:yc+(null!=e.cid?`${e.cid.toString(Lt)}`:"")},e)){const e=Pn.parse(t.toString().substring(5),Lt),r=mc(n);yield{cid:e,...r}}}async isPinned(e,t={}){const n=new ba(`${wc}${bc.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}}class Sc{log;routers;providerLookupConcurrency;constructor(e,t){this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??5}async start(){await Aa(...this.routers)}async stop(){await xa(...this.routers)}async*findProviders(e,t={}){if(0===this.routers.length)throw new x("No content routers available","ERR_NO_ROUTERS_AVAILABLE");const n=new W({concurrency:this.providerLookupConcurrency});n.addEventListener("error",()=>{});for await(const r of Ne(n.toGenerator(),...kc(this.routers,"findProviders").map(n=>n.findProviders(e,t))))if(null!=r){if(0===r.multiaddrs.length){if(null!=n.find(r.id))continue;n.add(async()=>{try{const e=await this.findPeer(r.id,t);return 0===e.multiaddrs.length?null:e}catch(e){return this.log.error("could not load multiaddrs for peer %p",r.id,e),null}},{peerId:r.id,signal:t.signal}).catch(e=>{this.log.error("could not load multiaddrs for peer %p",r.id,e)})}yield r}}async provide(e,t={}){if(0===this.routers.length)throw new x("No content routers available","ERR_NO_ROUTERS_AVAILABLE");await Promise.all(kc(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async put(e,t,n){await Promise.all(kc(this.routers,"put").map(async r=>{await r.put(e,t,n)}))}async get(e,t){return Promise.any(kc(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(0===this.routers.length)throw new x("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");const n=this,r=Ne(...kc(this.routers,"findPeer").map(r=>async function*(){try{yield await r.findPeer(e,t)}catch(e){n.log.error(e)}}()));for await(const e of r)if(null!=e)return e;throw new x("Could not find peer in routing","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){if(0===this.routers.length)throw new x("No peer routers available","ERR_NO_ROUTERS_AVAILABLE");for await(const n of Ne(...kc(this.routers,"getClosestPeers").map(n=>n.getClosestPeers(e,t))))null!=n&&(yield n)}}function kc(e,t){return e.filter(e=>null!=e[t])}class _c extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return null==t?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let r=this.#e.get(e);null==r&&(r=[],this.#e.set(e,r)),r.push({callback:t,once:(!0!==n&&!1!==n&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let r=this.#e.get(e);null!=r&&(r=r.filter(({callback:e})=>e!==t),this.#e.set(e,r))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return null==n||(n=n.filter(({once:e})=>!e),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}class Rc extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class Ic{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new M)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}class Ac{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((e,t)=>e&&!0===t.signal?.aborted,!0)&&(this.controller.abort(new M),this.cleanup())}async join(e={}){const t=new Ic(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await H(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}function xc(e,t){let n;const r=function(){clearTimeout(n),n=setTimeout(function(){n=void 0,e()},t)};return r.start=()=>{},r.stop=()=>{clearTimeout(n)},r}class Tc extends _c{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=xc(this.emitEmpty.bind(this),1),this.emitIdle=xc(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){0===this.size&&this.safeDispatchEvent("empty")}emitIdle(){0===this.running&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(0===this.size)return this.emitEmpty(),0===this.running&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}start(){!1===this.autoStart&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Rc;const n=new Ac(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(e=>(this.safeDispatchEvent("success",{detail:{job:n,result:e}}),e)).catch(e=>{if("queued"===n.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===n){this.queue.splice(e,1);break}throw this.safeDispatchEvent("failure",{detail:{job:n,error:e}}),e})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new M)}),this.clear()}async onEmpty(e){0!==this.size&&await U(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await U(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await U(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=O({objectMode:!0}),n=e=>{null!=e?this.abort():this.clear(),t.end(e)},r=e=>{null!=e.detail&&t.push(e.detail.result)},i=e=>{n(e.detail.error)},o=()=>{n()},s=()=>{n(new M("Queue aborted"))};this.addEventListener("success",r),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",s);try{yield*t}finally{this.removeEventListener("success",r),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",s),n()}}}const Cc="lock:worker:request-read",Nc="lock:worker:abort-read-request",Dc="lock:worker:release-read",Pc="lock:master:grant-read",Lc="lock:master:error-read",Bc="lock:worker:request-write",Oc="lock:worker:abort-write-request",Mc="lock:worker:release-write",Uc="lock:master:grant-write",Fc="lock:master:error-write",zc="lock:worker:finalize",Vc="mortice",$c={singleProcess:!1},Hc=(e,t,n,r,i,o,s,a,l)=>c=>{if(null==c.data)return;const u={type:c.data.type,name:c.data.name,identifier:c.data.identifier};u.type===i&&e.safeDispatchEvent(n,{detail:{name:u.name,identifier:u.identifier,handler:async()=>{t.postMessage({type:l,name:u.name,identifier:u.identifier}),await new Promise(e=>{const n=r=>{if(null==r?.data)return;const i=r.data.type,o=(r.data.name,r.data.identifier);i===a&&o===u.identifier&&(t.removeEventListener("message",n),e())};t.addEventListener("message",n)})},onError:e=>{t.postMessage({type:s,name:u.name,identifier:u.identifier,error:{message:e.message,name:e.name,stack:e.stack}})}}}),u.type===o&&e.safeDispatchEvent(r,{detail:{name:u.name,identifier:u.identifier}}),u.type===zc&&e.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})};class Kc{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(Vc)}readLock(e){return this.sendRequest(Cc,Nc,Pc,Lc,Dc,e)}writeLock(e){return this.sendRequest(Bc,Oc,Uc,Fc,Mc,e)}finalize(){this.channel.postMessage({type:zc,name:this.name}),this.channel.close()}async sendRequest(e,t,n,r,i,o){o?.signal?.throwIfAborted();const s=((e=10)=>Math.random().toString().substring(2,e+2))();return this.channel.postMessage({type:e,identifier:s,name:this.name}),new Promise((e,a)=>{const l=()=>{this.channel.postMessage({type:t,identifier:s,name:this.name})};o?.signal?.addEventListener("abort",l,{once:!0});const c=t=>{if(t.data?.identifier===s&&(t.data?.type===n&&(this.channel.removeEventListener("message",c),o?.signal?.removeEventListener("abort",l),e(()=>{this.channel.postMessage({type:i,identifier:s,name:this.name})})),t.data.type===r)){this.channel.removeEventListener("message",c),o?.signal?.removeEventListener("abort",l);const e=new Error;null!=t.data.error&&(e.message=t.data.error.message,e.name=t.data.error.name,e.stack=t.data.error.stack),a(e)}};this.channel.addEventListener("message",c)})}}const qc=new Map;let jc;function Wc(e){return"function"==typeof e?.readLock&&"function"==typeof e?.writeLock}function Gc(e){if(null==jc&&(jc=(e=>{if(e=Object.assign({},$c,e),Boolean(globalThis.document)||e.singleProcess){const e=new BroadcastChannel(Vc),t=new _c;return e.addEventListener("message",Hc(t,e,"requestReadLock","abortReadLockRequest",Cc,Nc,Lc,Dc,Pc)),e.addEventListener("message",Hc(t,e,"requestWriteLock","abortWriteLockRequest",Bc,Oc,Fc,Mc,Uc)),t}return new Kc(e.name)})(e),!Wc(jc))){const e=jc;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,r=t.detail.identifier,i=qc.get(n);if(null==i)return;const o=new AbortController,s=e=>{e.detail.name===n&&e.detail.identifier===r&&o.abort()};e.addEventListener("abortReadLockRequest",s),i.readLock({signal:o.signal}).then(async e=>{await t.detail.handler().finally(()=>{e()})}).catch(e=>{t.detail.onError(e)}).finally(()=>{e.removeEventListener("abortReadLockRequest",s)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,r=t.detail.identifier,i=qc.get(n);if(null==i)return;const o=new AbortController,s=e=>{e.detail.name===n&&e.detail.identifier===r&&o.abort()};e.addEventListener("abortWriteLockRequest",s),i.writeLock({signal:o.signal}).then(async e=>{await t.detail.handler().finally(()=>{e()})}).catch(e=>{t.detail.onError(e)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",s)})}),e.addEventListener("finalizeRequest",e=>{const t=e.detail.name,n=qc.get(t);null!=n&&n.finalize()})}return jc}async function Yc(e,t){let n,r;const i=new Promise((e,t)=>{n=e,r=t}),o=()=>{r(new M)};return t?.signal?.addEventListener("abort",o,{once:!0}),e.add(async()=>{await new Promise(e=>{n(()=>{t?.signal?.removeEventListener("abort",o),e()})})},{signal:t?.signal}).catch(e=>{r(e)}),i}const Qc={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function Xc(e){const t=Object.assign({},Qc,e);return((e,t)=>{let n=qc.get(e);if(null!=n)return n;const r=Gc(t);if(Wc(r))return n=r,qc.set(e,n),n;const i=new Tc({concurrency:1});let o;return n={async readLock(e){if(null!=o)return Yc(o,e);o=new Tc({concurrency:t.concurrency,autoStart:!1});const n=o,r=Yc(o,e);return i.add(async()=>{n.start(),await n.onIdle().then(()=>{o===n&&(o=null)})}),r},writeLock:async e=>(o=null,Yc(i,e)),finalize:()=>{qc.delete(e)},queue:i},qc.set(e,n),!0===t.autoFinalize&&i.addEventListener("idle",()=>{n.finalize()},{once:!0}),n})(t.name,t)}class Zc{lock;child;pins;started;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=Xc({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await Aa(this.child),this.started=!0}async stop(){await xa(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){n?.signal?.throwIfAborted();const r=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{r()}}async*putMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.writeLock();try{const n=this;yield*this.child.deleteMany(async function*(){for await(const t of e){if(await n.pins.isPinned(t))throw new Error("CID was pinned");yield t}}(),t)}finally{n()}}async has(e,t={}){t?.signal?.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){e?.signal?.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){return t?.signal?.throwIfAborted(),this.child.createSession(e,t)}}const Jc={float64:!0,typeEncoders:{Map:function(e){for(const t of e.keys())if("string"!=typeof t||0===t.length)throw new Error("Non-string Map keys are not supported by the IPLD Data Model and cannot be encoded");return null},Object:function(e){if(e.asCID!==e&&e["/"]!==e.bytes)return null;const t=Pn.asCID(e);if(!t)return null;const n=new Uint8Array(t.bytes.byteLength+1);return n.set(t.bytes,1),[new Ga(Wa.tag,42),new Ga(Wa.bytes,n)]},undefined:function(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")},number:function(e){if(Number.isNaN(e))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(e===1/0||e===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}}},eu={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};eu.tags[42]=function(e){if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return Pn.decode(e.subarray(1))},eu.tags.slice();const tu=113,nu=e=>mc(function(e){return e instanceof ArrayBuffer?new Uint8Array(e,0,e.byteLength):e}(e),eu);Wa.uint.major,Wa.negint.major,Wa.bytes.major,Wa.string.major,Wa.array.major,Wa.map.major,Wa.tag.major,Wa.float.major;class ru{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;32===e||9===e||13===e||10===e;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${dl} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${dl} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,n=!1;const r=e=>{for(;!this.done();){const t=this.ch();if(!e.includes(t))break;this._pos++}};if(45===this.ch()&&(t=!0,this._pos++),48===this.ch()){if(this._pos++,46!==this.ch())return new Ga(Wa.uint,0,this._pos-e);this._pos++,n=!0}if(r([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${dl} unexpected token at position ${this._pos}`);if(!this.done()&&46===this.ch()){if(n)throw new Error(`${dl} unexpected token at position ${this._pos}`);n=!0,this._pos++,r([48,49,50,51,52,53,54,55,56,57])}this.done()||101!==this.ch()&&69!==this.ch()||(n=!0,this._pos++,this.done()||43!==this.ch()&&45!==this.ch()||this._pos++,r([48,49,50,51,52,53,54,55,56,57]));const i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(i);return n?new Ga(Wa.float,o,this._pos-e):!0!==this.options.allowBigInt||Number.isSafeInteger(o)?new Ga(o>=0?Wa.uint:Wa.negint,o,this._pos-e):new Ga(o>=0?Wa.uint:Wa.negint,BigInt(i),this._pos-e)}parseString(){if(34!==this.ch())throw new Error(`${dl} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let e=this._pos,t=0;e<this.data.length&&t<65536;e++,t++){const n=this.data[e];if(92===n||n<32||n>=128)break;if(34===n){const n=String.fromCharCode.apply(null,this.data.subarray(this._pos,e));return this._pos=e+1,new Ga(Wa.string,n,t)}}const e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${dl} unexpected end of unicode escape sequence at position ${this._pos}`);let e=0;for(let t=0;t<4;t++){let t=this.ch();if(t>=48&&t<=57)t-=48;else if(t>=97&&t<=102)t=t-97+10;else{if(!(t>=65&&t<=70))throw new Error(`${dl} unexpected unicode escape character at position ${this._pos}`);t=t-65+10}e=16*e+t,this._pos++}return e},r=()=>{const e=this.ch();let n,r,i,o,s=null,a=e>239?4:e>223?3:e>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${dl} unexpected unicode sequence at position ${this._pos}`);switch(a){case 1:e<128&&(s=e);break;case 2:n=this.data[this._pos+1],128==(192&n)&&(o=(31&e)<<6|63&n,o>127&&(s=o));break;case 3:n=this.data[this._pos+1],r=this.data[this._pos+2],128==(192&n)&&128==(192&r)&&(o=(15&e)<<12|(63&n)<<6|63&r,o>2047&&(o<55296||o>57343)&&(s=o));break;case 4:n=this.data[this._pos+1],r=this.data[this._pos+2],i=this.data[this._pos+3],128==(192&n)&&128==(192&r)&&128==(192&i)&&(o=(15&e)<<18|(63&n)<<12|(63&r)<<6|63&i,o>65535&&o<1114112&&(s=o))}null===s?(s=65533,a=1):s>65535&&(s-=65536,t.push(s>>>10&1023|55296),s=56320|1023&s),t.push(s),this._pos+=a};for(;!this.done();){const i=this.ch();let o;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${dl} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${dl} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new Ga(Wa.string,cl(t),this._pos-e);default:if(i<32)throw new Error(`${dl} invalid control character at position ${this._pos}`);i<128?(t.push(i),this._pos++):r()}}throw new Error(`${dl} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new Ga(Wa.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new Ga(Wa.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new Ga(Wa.null,null,4);case 102:return this.expect([102,97,108,115,101]),new Ga(Wa.false,!1,5);case 116:return this.expect([116,114,117,101]),new Ga(Wa.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${dl} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":if(this.modeStack.pop(),93===this.ch())return this._pos++,this.skipWhitespace(),new Ga(Wa.break,void 0,1);if(44!==this.ch())throw new Error(`${dl} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue();case"array-start":return this.modeStack.pop(),93===this.ch()?(this._pos++,this.skipWhitespace(),new Ga(Wa.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(125===this.ch())return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new Ga(Wa.break,void 0,1);if(44!==this.ch())throw new Error(`${dl} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),125===this.ch())return this._pos++,this.skipWhitespace(),new Ga(Wa.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),58!==this.ch())throw new Error(`${dl} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${dl} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function iu(e,t){return mc(e,t=Object.assign({tokenizer:new ru(e,t)},t))}class ou extends ru{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return 0===this.tokenBuffer.length&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===Wa.map){const e=this._next();if(e.type===Wa.string&&"/"===e.value){const e=this._next();if(e.type===Wa.string){if(this._next().type!==Wa.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(e),new Ga(Wa.tag,42,0)}if(e.type===Wa.map){const e=this._next();if(e.type===Wa.string&&"bytes"===e.value){const e=this._next();if(e.type===Wa.string){for(let e=0;e<2;e++)if(this._next().type!==Wa.break)throw new Error("Invalid encoded Bytes form");const t=Ut.decode(`m${e.value}`);return new Ga(Wa.bytes,t,e.value.length)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}return e}}const su={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};su.tags[42]=Pn.parse;const au=297,lu=(new TextDecoder,new TextEncoder,new TextDecoder);function cu(e,t){let n=0;for(let r=0;;r+=7){if(r>=64)throw new Error("protobuf: varint overflow");if(t>=e.length)throw new Error("protobuf: unexpected end of data");const i=e[t++];if(n+=r<28?(127&i)<<r:(127&i)*2**r,i<128)break}return[n,t]}function uu(e,t){let n;[n,t]=cu(e,t);const r=t+n;if(n<0||r<0)throw new Error("protobuf: invalid length");if(r>e.length)throw new Error("protobuf: unexpected end of data");return[e.subarray(t,r),r]}function du(e,t){let n;return[n,t]=cu(e,t),[7&n,n>>3,t]}function hu(e){const t={},n=e.length;let r=0;for(;r<n;){let n,i;if([n,i,r]=du(e,r),1===i){if(t.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(2!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Hash`);if(void 0!==t.Name)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[t.Hash,r]=uu(e,r)}else if(2===i){if(void 0!==t.Name)throw new Error("protobuf: (PBLink) duplicate Name section");if(2!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Name`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let i;[i,r]=uu(e,r),t.Name=lu.decode(i)}else{if(3!==i)throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`);if(void 0!==t.Tsize)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(0!==n)throw new Error(`protobuf: (PBLink) wrong wireType (${n}) for Tsize`);[t.Tsize,r]=cu(e,r)}}if(r>n)throw new Error("protobuf: (PBLink) unexpected end of data");return t}const fu=new TextEncoder,pu=2**32,gu=2**31;function mu(e,t){let n=t.length;if("number"==typeof e.Tsize){if(e.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(e.Tsize))throw new Error("Tsize too large for encoding");n=wu(t,n,e.Tsize)-1,t[n]=24}if("string"==typeof e.Name){const r=fu.encode(e.Name);n-=r.length,t.set(r,n),n=wu(t,n,r.length)-1,t[n]=18}return e.Hash&&(n-=e.Hash.length,t.set(e.Hash,n),n=wu(t,n,e.Hash.length)-1,t[n]=10),t.length-n}function yu(e){let t=0;if(e.Hash){const n=e.Hash.length;t+=1+n+bu(n)}if("string"==typeof e.Name){const n=fu.encode(e.Name).length;t+=1+n+bu(n)}return"number"==typeof e.Tsize&&(t+=1+bu(e.Tsize)),t}function wu(e,t,n){const r=t-=bu(n);for(;n>=gu;)e[t++]=127&n|128,n/=128;for(;n>=128;)e[t++]=127&n|128,n>>>=7;return e[t]=n,r}function bu(e){return e%2==0&&e++,Math.floor((function(e){let t=0;return e>=pu&&(e=Math.floor(e/pu),t=32),e>=65536&&(e>>>=16,t+=16),e>=256&&(e>>>=8,t+=8),t+vu[e]}(e)+6)/7)}const vu=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],Eu=["Data","Links"],Su=["Hash","Name","Tsize"],ku=new TextEncoder;function _u(e,t){if(e===t)return 0;const n=e.Name?ku.encode(e.Name):[],r=t.Name?ku.encode(t.Name):[];let i=n.length,o=r.length;for(let e=0,t=Math.min(i,o);e<t;++e)if(n[e]!==r[e]){i=n[e],o=r[e];break}return i<o?-1:o<i?1:0}function Ru(e,t){return!Object.keys(e).some(e=>!t.includes(e))}function Iu(e){if("object"==typeof e.asCID){const t=Pn.asCID(e);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if("object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");const t={};if(e.Hash){let n=Pn.asCID(e.Hash);try{n||("string"==typeof e.Hash?n=Pn.parse(e.Hash):e.Hash instanceof Uint8Array&&(n=Pn.decode(e.Hash)))}catch(e){throw new TypeError(`Invalid DAG-PB form: ${e.message}`)}n&&(t.Hash=n)}if(!t.Hash)throw new TypeError("Invalid DAG-PB form");return"string"==typeof e.Name&&(t.Name=e.Name),"number"==typeof e.Tsize&&(t.Tsize=e.Tsize),t}function Au(e){if((e instanceof Uint8Array||"string"==typeof e)&&(e={Data:e}),"object"!=typeof e||Array.isArray(e))throw new TypeError("Invalid DAG-PB form");const t={};if(void 0!==e.Data)if("string"==typeof e.Data)t.Data=ku.encode(e.Data);else{if(!(e.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form");t.Data=e.Data}if(void 0!==e.Links){if(!Array.isArray(e.Links))throw new TypeError("Invalid DAG-PB form");t.Links=e.Links.map(Iu),t.Links.sort(_u)}else t.Links=[];return t}function xu(e){if(!e||"object"!=typeof e||Array.isArray(e)||e instanceof Uint8Array||e["/"]&&e["/"]===e.bytes)throw new TypeError("Invalid DAG-PB form");if(!Ru(e,Eu))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(void 0!==e.Data&&!(e.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(e.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let t=0;t<e.Links.length;t++){const n=e.Links[t];if(!n||"object"!=typeof n||Array.isArray(n)||n instanceof Uint8Array||n["/"]&&n["/"]===n.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!Ru(n,Su))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(void 0===n.Hash)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(null==n.Hash||!n.Hash["/"]||n.Hash["/"]!==n.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(void 0!==n.Name&&"string"!=typeof n.Name)throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(void 0!==n.Tsize){if("number"!=typeof n.Tsize||n.Tsize%1!=0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(n.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(t>0&&-1===_u(n,e.Links[t-1]))throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function Tu(e,t=[]){return Au({Data:e,Links:t})}function Cu(e,t,n){return Iu({Hash:n,Name:e,Tsize:t})}const Nu="dag-pb",Du=112;function Pu(e){xu(e);const t={};return e.Links&&(t.Links=e.Links.map(e=>{const t={};return e.Hash&&(t.Hash=e.Hash.bytes),void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t})),e.Data&&(t.Data=e.Data),function(e){const t=function(e){let t=0;if(e.Data){const n=e.Data.length;t+=1+n+bu(n)}if(e.Links)for(const n of e.Links){const e=yu(n);t+=1+e+bu(e)}return t}(e),n=new Uint8Array(t);let r=t;if(e.Data&&(r-=e.Data.length,n.set(e.Data,r),r=wu(n,r,e.Data.length)-1,n[r]=10),e.Links)for(let t=e.Links.length-1;t>=0;t--){const i=mu(e.Links[t],n.subarray(0,r));r-=i,r=wu(n,r,i)-1,n[r]=18}return n}(t)}function Lu(e){const t=function(e){const t=e.length;let n,r,i=0,o=!1;for(;i<t;){let t,s;if([t,s,i]=du(e,i),2!==t)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${t}`);if(1===s){if(r)throw new Error("protobuf: (PBNode) duplicate Data section");[r,i]=uu(e,i),n&&(o=!0)}else{if(2!==s)throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${s}`);{if(o)throw new Error("protobuf: (PBNode) duplicate Links section");let t;n||(n=[]),[t,i]=uu(e,i),n.push(hu(t))}}}if(i>t)throw new Error("protobuf: (PBNode) unexpected end of data");const s={};return r&&(s.Data=r),s.Links=n||[],s}(function(e){return e instanceof ArrayBuffer?new Uint8Array(e,0,e.byteLength):e}(e)),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(e=>{const t={};try{t.Hash=Pn.decode(e.Hash)}catch{}if(!t.Hash)throw new Error("Invalid Hash field found in link, expected CID");return void 0!==e.Name&&(t.Name=e.Name),void 0!==e.Tsize&&(t.Tsize=e.Tsize),t})),n}const Bu={codec:Du,*walk(e){const t=Lu(e);yield*t.Links.map(e=>e.Hash)}},Ou={codec:Xt,*walk(){}},Mu={codec:113,*walk(e){const t=[],n=[];n[42]=e=>{if(0!==e[0])throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");const n=Pn.decode(e.subarray(1));return t.push(n),n},mc(e,{tags:n}),yield*t}};class Uu extends ru{tokenBuffer;constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return 0===this.tokenBuffer.length&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===Wa.map){const e=this._next();if(e.type===Wa.string&&"/"===e.value){const e=this._next();if(e.type===Wa.string){if(this._next().type!==Wa.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(e),new Ga(Wa.tag,42,0)}if(e.type===Wa.map){const e=this._next();if(e.type===Wa.string&&"bytes"===e.value){const e=this._next();if(e.type===Wa.string){for(let e=0;e<2;e++)if(this._next().type!==Wa.break)throw new Error("Invalid encoded Bytes form");const t=Ut.decode(`m${e.value}`);return new Ga(Wa.bytes,t,e.value.length)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}this.tokenBuffer.push(e)}return e}}const Fu={codec:297,*walk(e){const t=[],n=[];n[42]=e=>{const n=Pn.parse(e);return t.push(n),n},iu(e,{tags:n,tokenizer:new Uu(e,{tags:n,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*t}},zu={codec:Wt,*walk(){}},Vu=new ba("/version");class $u extends Gs{child;constructor(e){super(),this.child=e}put(e,t){return 0===e.multihash.code||null==this.child?e:this.child.put(e,t)}get(e){if(0===e.multihash.code)return e.multihash.digest;if(null==this.child)throw ga.notFoundError();return this.child.get(e)}has(e){return 0===e.multihash.code||null!=this.child&&this.child.has(e)}delete(e){if(0!==e.code)return null!=this.child?this.child.delete(e):void 0}getAll(e){return null!=this.child?this.child.getAll(e):[]}}function Hu(e){return null!=e?.then}const Ku=function(e,t){let n=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const r of e){const e=t(r,n++);Hu(e)&&await e,yield r}}();const r=Ae(e),{value:i,done:o}=r.next();if(!0===o)return function*(){}();const s=t(i,n++);if("function"==typeof s?.then)return async function*(){yield i;for(const e of r){const r=t(e,n++);Hu(r)&&await r,yield e}}();const a=t;return function*(){yield i;for(const e of r)a(e,n++),yield e}()};class qu{child;hashers;log;logger;components;constructor(e){this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new $u(e.blockstore),this.hashers=e.hashers??{}}async put(e,t,n={}){return await this.child.has(e,n)?(n.onProgress?.(new Fe("blocks:put:duplicate",e)),e):(n.onProgress?.(new Fe("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async r=>r.announce?.(e,t,n))),n.onProgress?.(new Fe("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){const n=pa(e,async({cid:e})=>{const n=await this.child.has(e,t);return n&&t.onProgress?.(new Fe("blocks:put-many:duplicate",e)),!n}),r=Ku(n,async({cid:e,block:n})=>{t.onProgress?.(new Fe("blocks:put-many:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async r=>r.announce?.(e,n,t)))});t.onProgress?.(new Fe("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(r,t)}async get(e,t={}){if(!0!==t.offline&&!await this.child.has(e,t)){t.onProgress?.(new Fe("blocks:get:providers:get",e));const n=await Qu(e,this.components.blockBrokers,this.hashers[e.multihash.code],{...t,log:this.log});return t.onProgress?.(new Fe("blocks:get:blockstore:put",e)),await this.child.put(e,n,t),t.onProgress?.(new Fe("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async r=>r.announce?.(e,n,t))),n}return t.onProgress?.(new Fe("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new Fe("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Ku(e,async e=>{if(!0!==t.offline&&!await this.child.has(e,t)){t.onProgress?.(new Fe("blocks:get-many:providers:get",e));const n=await Qu(e,this.components.blockBrokers,this.hashers[e.multihash.code],{...t,log:this.log});t.onProgress?.(new Fe("blocks:get-many:blockstore:put",e)),await this.child.put(e,n,t),t.onProgress?.(new Fe("blocks:get-many:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async r=>r.announce?.(e,n,t)))}}))}async delete(e,t={}){t.onProgress?.(new Fe("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new Fe("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const t of e)yield t}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new Fe("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class ju extends qu{started;constructor(e){super(e),this.started=!1}isStarted(){return this.started}async start(){await Aa(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await xa(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(e,t){const n=this.components.blockBrokers.map(e=>null==e.createSession?e:e.createSession(t));return new Wu({blockstore:this.child,blockBrokers:n,hashers:this.hashers,logger:this.logger},{root:e})}}class Wu extends qu{closeController;constructor(e,t){super(e),this.closeController=new AbortController,this.closeController.signal,this.log=e.logger.forComponent(`helia:session-storage:${t.root}`)}close(){this.closeController.abort()}async put(e,t,n={}){const r=_([this.closeController.signal,n.signal]);try{return await super.put(e,t,{...n,signal:r})}finally{r.clear()}}async*putMany(e,t={}){const n=_([this.closeController.signal,t.signal]);try{yield*super.putMany(e,{...t,signal:n})}finally{n.clear()}}async get(e,t={}){const n=_([this.closeController.signal,t.signal]);try{return await super.get(e,{...t,signal:n})}finally{n.clear()}}async*getMany(e,t={}){const n=_([this.closeController.signal,t.signal]);try{yield*super.getMany(e,{...t,signal:n})}finally{n.clear()}}async delete(e,t={}){const n=_([this.closeController.signal,t.signal]);try{await super.delete(e,{...t,signal:n})}finally{n.clear()}}async*deleteMany(e,t={}){const n=_([this.closeController.signal,t.signal]);try{yield*super.deleteMany(e,{...t,signal:n})}finally{n.clear()}}async has(e,t={}){const n=_([this.closeController.signal,t.signal]);try{return await super.has(e,{...t,signal:n})}finally{n.clear()}}async*getAll(e={}){const t=_([this.closeController.signal,e.signal]);try{yield*super.getAll({...e,signal:t})}finally{t.clear()}}}function Gu(e){return"function"==typeof e.retrieve}const Yu=(e,t)=>{if(null==t)throw new x(`No hasher configured for multihash code 0x${e.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`,"ERR_UNKNOWN_HASH_ALG");return async n=>{if(!he((await t.digest(n)).digest,e.multihash.digest))throw new x("Hash of downloaded block did not match multihash from passed CID","ERR_HASH_MISMATCH")}};async function Qu(e,t,n,r){const i=Yu(e,n),o=new AbortController,s=_([o.signal,r.signal]);o.signal;const a=[];for(const e of t)Gu(e)&&a.push(e);try{return await Promise.any(a.map(async t=>{try{let n=!1;const o=await t.retrieve(e,{...r,signal:s,validateFn:async e=>{await i(e),n=!0}});return n||await i(o),o}catch(t){throw r.log.error("could not retrieve verified block for %c",e,t),t}}))}finally{o.abort(),s.clear()}}class Xu{blockstore;datastore;pins;logger;routing;dagWalkers;hashers;dns;metrics;log;constructor(e){this.logger=e.logger??ha(),this.log=this.logger.forComponent("helia"),this.hashers=function(e=[]){const t={};return[xn,Tn,kn,...e].forEach(e=>{t[e.code]=e}),t}(e.hashers),this.dagWalkers=function(e=[]){const t={};return[Bu,Ou,Mu,Fu,zu,...e].forEach(e=>{t[e.codec]=e}),t}(e.dagWalkers),this.dns=e.dns??Ka(),this.metrics=e.metrics;const t={blockstore:e.blockstore,datastore:e.datastore,hashers:this.hashers,dagWalkers:this.dagWalkers,logger:this.logger,blockBrokers:[],dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new Sc(t,{routers:(e.routers??[]).flatMap(e=>{const t=[e];return null!=e[_a]&&t.push(e[_a]),null!=e[Ra]&&t.push(e[Ra]),t}),providerLookupConcurrency:e.providerLookupConcurrency});const n=new ju(t);this.pins=new Ec(e.datastore,n,this.dagWalkers),this.blockstore=new Zc(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(e=>e(t))}async start(){await async function(e){if(!await e.has(Vu))return void await e.put(Vu,Hn("1"));const t=Ir(await e.get(Vu));if(1!==parseInt(t,10))throw new Error("Unknown datastore version, a datastore migration may be required")}(this.datastore),await Aa(this.blockstore,this.datastore,this.routing)}async stop(){await xa(this.blockstore,this.datastore,this.routing)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const t=this,n=this.blockstore.unwrap();this.log("gc start"),await G(n.deleteMany(async function*(){for await(const{cid:r}of n.getAll())try{if(await t.pins.isPinned(r,e))continue;yield r,e.onProgress?.(new Fe("helia:gc:deleted",r))}catch(n){t.log.error("Error during gc",n),e.onProgress?.(new Fe("helia:gc:error",n))}}()))}finally{t()}this.log("gc finished")}}class Zu extends Xu{libp2p;constructor(e){super({...e,components:{libp2p:e.libp2p}}),this.libp2p=e.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}class Ju extends fi{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Qr(e);const n=ui(t);if(this.iHash=e.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,i=new Uint8Array(r);i.set(n.length>r?e.create().update(n).digest():n);for(let e=0;e<i.length;e++)i[e]^=54;this.iHash.update(i),this.oHash=e.create();for(let e=0;e<i.length;e++)i[e]^=106;this.oHash.update(i),Zr(i)}update(e){return Xr(this),this.iHash.update(e),this}digestInto(e){Xr(this),Yr(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:r,destroyed:i,blockLen:o,outputLen:s}=this;return e.finished=r,e.destroyed=i,e.blockLen=o,e.outputLen=s,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const ed=(e,t,n)=>new Ju(e,t).update(n).digest();function td(e,t,n,r){Qr(e);const i=function(e,t){if(void 0!==t&&"[object Object]"!=={}.toString.call(t))throw new Error("options should be object or undefined");return Object.assign({dkLen:32,asyncTick:10},t)}(0,r),{c:o,dkLen:s,asyncTick:a}=i;if(Gr(o),Gr(s),Gr(a),o<1)throw new Error("iterations (c) should be >= 1");const l=di(t),c=di(n),u=new Uint8Array(s),d=ed.create(e,l),h=d._cloneInto().update(c);return{c:o,dkLen:s,asyncTick:a,DK:u,PRF:d,PRFSalt:h}}function nd(e,t,n,r,i){return e.destroy(),t.destroy(),r&&r.destroy(),Zr(i),n}async function rd(e,t,n,r){const{c:i,dkLen:o,asyncTick:s,DK:a,PRF:l,PRFSalt:c}=td(e,t,n,r);let u;const d=new Uint8Array(4),h=Jr(d),f=new Uint8Array(l.outputLen);for(let e=1,t=0;t<o;e++,t+=l.outputLen){const n=a.subarray(t,t+l.outputLen);h.setInt32(0,e,!1),(u=c._cloneInto(u)).update(d).digestInto(f),n.set(f.subarray(0,n.length)),await li(i-1,s,()=>{l._cloneInto(u).update(f).digestInto(f);for(let e=0;e<n.length;e++)n[e]^=f[e]})}return nd(l,c,a,u,f)}function id(e,t,n){return e&t^~e&n}function od(e,t,n){return e&t^e&n^t&n}ed.create=(e,t)=>new Ju(e,t);class sd extends fi{constructor(e,t,n,r){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=r,this.buffer=new Uint8Array(e),this.view=Jr(this.buffer)}update(e){Xr(this),Yr(e=ui(e));const{view:t,buffer:n,blockLen:r}=this,i=e.length;for(let o=0;o<i;){const s=Math.min(r-this.pos,i-o);if(s===r){const t=Jr(e);for(;r<=i-o;o+=r)this.process(t,o);continue}n.set(e.subarray(o,o+s),this.pos),this.pos+=s,o+=s,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Xr(this),function(e,t){Yr(e);const n=t.outputLen;if(e.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:r,isLE:i}=this;let{pos:o}=this;t[o++]=128,Zr(this.buffer.subarray(o)),this.padOffset>r-o&&(this.process(n,0),o=0);for(let e=o;e<r;e++)t[e]=0;!function(e,t,n,r){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,n,r);const i=BigInt(32),o=BigInt(4294967295),s=Number(n>>i&o),a=Number(n&o),l=r?4:0,c=r?0:4;e.setUint32(t+l,s,r),e.setUint32(t+c,a,r)}(n,r-8,BigInt(8*this.length),i),this.process(n,0);const s=Jr(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=a/4,c=this.get();if(l>c.length)throw new Error("_sha2: outputLen bigger than state");for(let e=0;e<l;e++)s.setUint32(4*e,c[e],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:r,finished:i,destroyed:o,pos:s}=this;return e.destroyed=o,e.finished=i,e.length=r,e.pos=s,r%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const ad=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ld=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),cd=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),ud=new Uint32Array(80);class dd extends sd{constructor(){super(64,20,8,!1),this.A=0|cd[0],this.B=0|cd[1],this.C=0|cd[2],this.D=0|cd[3],this.E=0|cd[4]}get(){const{A:e,B:t,C:n,D:r,E:i}=this;return[e,t,n,r,i]}set(e,t,n,r,i){this.A=0|e,this.B=0|t,this.C=0|n,this.D=0|r,this.E=0|i}process(e,t){for(let n=0;n<16;n++,t+=4)ud[n]=e.getUint32(t,!1);for(let e=16;e<80;e++)ud[e]=ti(ud[e-3]^ud[e-8]^ud[e-14]^ud[e-16],1);let{A:n,B:r,C:i,D:o,E:s}=this;for(let e=0;e<80;e++){let t,a;e<20?(t=id(r,i,o),a=1518500249):e<40?(t=r^i^o,a=1859775393):e<60?(t=od(r,i,o),a=2400959708):(t=r^i^o,a=3395469782);const l=ti(n,5)+t+s+a+ud[e]|0;s=o,o=i,i=ti(r,30),r=n,n=l}n=n+this.A|0,r=r+this.B|0,i=i+this.C|0,o=o+this.D|0,s=s+this.E|0,this.set(n,r,i,o,s)}roundClean(){Zr(ud)}destroy(){this.set(0,0,0,0,0),Zr(this.buffer)}}const hd=pi(()=>new dd),fd=BigInt(2**32-1),pd=BigInt(32);function gd(e,t=!1){return t?{h:Number(e&fd),l:Number(e>>pd&fd)}:{h:0|Number(e>>pd&fd),l:0|Number(e&fd)}}const md=(e,t,n)=>e>>>n,yd=(e,t,n)=>e<<32-n|t>>>n,wd=(e,t,n)=>e>>>n|t<<32-n,bd=(e,t,n)=>e<<32-n|t>>>n,vd=(e,t,n)=>e<<64-n|t>>>n-32,Ed=(e,t,n)=>e>>>n-32|t<<64-n;function Sd(e,t,n,r){const i=(t>>>0)+(r>>>0);return{h:e+n+(i/2**32|0)|0,l:0|i}}const kd=(e,t,n)=>(e>>>0)+(t>>>0)+(n>>>0),_d=(e,t,n,r)=>t+n+r+(e/2**32|0)|0,Rd=(e,t,n,r)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0),Id=(e,t,n,r,i)=>t+n+r+i+(e/2**32|0)|0,Ad=(e,t,n,r,i)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0)+(i>>>0),xd=(e,t,n,r,i,o)=>t+n+r+i+o+(e/2**32|0)|0,Td=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Cd=new Uint32Array(64);class Nd extends sd{constructor(e=32){super(64,e,8,!1),this.A=0|ad[0],this.B=0|ad[1],this.C=0|ad[2],this.D=0|ad[3],this.E=0|ad[4],this.F=0|ad[5],this.G=0|ad[6],this.H=0|ad[7]}get(){const{A:e,B:t,C:n,D:r,E:i,F:o,G:s,H:a}=this;return[e,t,n,r,i,o,s,a]}set(e,t,n,r,i,o,s,a){this.A=0|e,this.B=0|t,this.C=0|n,this.D=0|r,this.E=0|i,this.F=0|o,this.G=0|s,this.H=0|a}process(e,t){for(let n=0;n<16;n++,t+=4)Cd[n]=e.getUint32(t,!1);for(let e=16;e<64;e++){const t=Cd[e-15],n=Cd[e-2],r=ei(t,7)^ei(t,18)^t>>>3,i=ei(n,17)^ei(n,19)^n>>>10;Cd[e]=i+Cd[e-7]+r+Cd[e-16]|0}let{A:n,B:r,C:i,D:o,E:s,F:a,G:l,H:c}=this;for(let e=0;e<64;e++){const t=c+(ei(s,6)^ei(s,11)^ei(s,25))+id(s,a,l)+Td[e]+Cd[e]|0,u=(ei(n,2)^ei(n,13)^ei(n,22))+od(n,r,i)|0;c=l,l=a,a=s,s=o+t|0,o=i,i=r,r=n,n=t+u|0}n=n+this.A|0,r=r+this.B|0,i=i+this.C|0,o=o+this.D|0,s=s+this.E|0,a=a+this.F|0,l=l+this.G|0,c=c+this.H|0,this.set(n,r,i,o,s,a,l,c)}roundClean(){Zr(Cd)}destroy(){this.set(0,0,0,0,0,0,0,0),Zr(this.buffer)}}const Dd=(()=>function(e,t=!1){const n=e.length;let r=new Uint32Array(n),i=new Uint32Array(n);for(let o=0;o<n;o++){const{h:n,l:s}=gd(e[o],t);[r[o],i[o]]=[n,s]}return[r,i]}(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(e=>BigInt(e))))(),Pd=(()=>Dd[0])(),Ld=(()=>Dd[1])(),Bd=new Uint32Array(80),Od=new Uint32Array(80);class Md extends sd{constructor(e=64){super(128,e,16,!1),this.Ah=0|ld[0],this.Al=0|ld[1],this.Bh=0|ld[2],this.Bl=0|ld[3],this.Ch=0|ld[4],this.Cl=0|ld[5],this.Dh=0|ld[6],this.Dl=0|ld[7],this.Eh=0|ld[8],this.El=0|ld[9],this.Fh=0|ld[10],this.Fl=0|ld[11],this.Gh=0|ld[12],this.Gl=0|ld[13],this.Hh=0|ld[14],this.Hl=0|ld[15]}get(){const{Ah:e,Al:t,Bh:n,Bl:r,Ch:i,Cl:o,Dh:s,Dl:a,Eh:l,El:c,Fh:u,Fl:d,Gh:h,Gl:f,Hh:p,Hl:g}=this;return[e,t,n,r,i,o,s,a,l,c,u,d,h,f,p,g]}set(e,t,n,r,i,o,s,a,l,c,u,d,h,f,p,g){this.Ah=0|e,this.Al=0|t,this.Bh=0|n,this.Bl=0|r,this.Ch=0|i,this.Cl=0|o,this.Dh=0|s,this.Dl=0|a,this.Eh=0|l,this.El=0|c,this.Fh=0|u,this.Fl=0|d,this.Gh=0|h,this.Gl=0|f,this.Hh=0|p,this.Hl=0|g}process(e,t){for(let n=0;n<16;n++,t+=4)Bd[n]=e.getUint32(t),Od[n]=e.getUint32(t+=4);for(let e=16;e<80;e++){const t=0|Bd[e-15],n=0|Od[e-15],r=wd(t,n,1)^wd(t,n,8)^md(t,0,7),i=bd(t,n,1)^bd(t,n,8)^yd(t,n,7),o=0|Bd[e-2],s=0|Od[e-2],a=wd(o,s,19)^vd(o,s,61)^md(o,0,6),l=bd(o,s,19)^Ed(o,s,61)^yd(o,s,6),c=Rd(i,l,Od[e-7],Od[e-16]),u=Id(c,r,a,Bd[e-7],Bd[e-16]);Bd[e]=0|u,Od[e]=0|c}let{Ah:n,Al:r,Bh:i,Bl:o,Ch:s,Cl:a,Dh:l,Dl:c,Eh:u,El:d,Fh:h,Fl:f,Gh:p,Gl:g,Hh:m,Hl:y}=this;for(let e=0;e<80;e++){const t=wd(u,d,14)^wd(u,d,18)^vd(u,d,41),w=bd(u,d,14)^bd(u,d,18)^Ed(u,d,41),b=u&h^~u&p,v=Ad(y,w,d&f^~d&g,Ld[e],Od[e]),E=xd(v,m,t,b,Pd[e],Bd[e]),S=0|v,k=wd(n,r,28)^vd(n,r,34)^vd(n,r,39),_=bd(n,r,28)^Ed(n,r,34)^Ed(n,r,39),R=n&i^n&s^i&s,I=r&o^r&a^o&a;m=0|p,y=0|g,p=0|h,g=0|f,h=0|u,f=0|d,({h:u,l:d}=Sd(0|l,0|c,0|E,0|S)),l=0|s,c=0|a,s=0|i,a=0|o,i=0|n,o=0|r;const A=kd(S,_,I);n=_d(A,E,k,R),r=0|A}({h:n,l:r}=Sd(0|this.Ah,0|this.Al,0|n,0|r)),({h:i,l:o}=Sd(0|this.Bh,0|this.Bl,0|i,0|o)),({h:s,l:a}=Sd(0|this.Ch,0|this.Cl,0|s,0|a)),({h:l,l:c}=Sd(0|this.Dh,0|this.Dl,0|l,0|c)),({h:u,l:d}=Sd(0|this.Eh,0|this.El,0|u,0|d)),({h,l:f}=Sd(0|this.Fh,0|this.Fl,0|h,0|f)),({h:p,l:g}=Sd(0|this.Gh,0|this.Gl,0|p,0|g)),({h:m,l:y}=Sd(0|this.Hh,0|this.Hl,0|m,0|y)),this.set(n,r,i,o,s,a,l,c,u,d,h,f,p,g,m,y)}roundClean(){Zr(Bd,Od)}destroy(){Zr(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const Ud=pi(()=>new Nd),Fd=pi(()=>new Md),zd=Ud,Vd=Fd,$d={sha1:hd,"sha2-256":zd,"sha2-512":Vd};function Hd(e,t,n,r,i){if("sha1"!==i&&"sha2-256"!==i&&"sha2-512"!==i){const e=Object.keys($d).join(" / ");throw new x(`Hash '${i}' is unknown or not supported. Must be ${e}`,"ERR_UNSUPPORTED_HASH_TYPE")}const o=function(e,t,n,r){const{c:i,dkLen:o,DK:s,PRF:a,PRFSalt:l}=td(e,t,n,r);let c;const u=new Uint8Array(4),d=Jr(u),h=new Uint8Array(a.outputLen);for(let e=1,t=0;t<o;e++,t+=a.outputLen){const n=s.subarray(t,t+a.outputLen);d.setInt32(0,e,!1),(c=l._cloneInto(c)).update(u).digestInto(h),n.set(h.subarray(0,n.length));for(let e=1;e<i;e++){a._cloneInto(c).update(h).digestInto(h);for(let e=0;e<n.length;e++)n[e]^=h[e]}}return nd(a,l,s,c,h)}($d[i],e,t,{c:n,dkLen:r});return Ut.encode(o).substring(1)}function Kd(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally}const qd=BigInt(0),jd=BigInt(1);function Wd(e,t=""){if("boolean"!=typeof e)throw new Error((t&&`"${t}"`)+"expected boolean, got type="+typeof e);return e}function Gd(e,t,n=""){const r=Wr(e),i=e?.length,o=void 0!==t;if(!r||o&&i!==t)throw new Error((n&&`"${n}" `)+"expected Uint8Array"+(o?` of length ${t}`:"")+", got "+(r?`length=${i}`:"type="+typeof e));return e}function Yd(e){const t=e.toString(16);return 1&t.length?"0"+t:t}function Qd(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);return""===e?qd:BigInt("0x"+e)}function Xd(e){return Qd(ii(e))}function Zd(e){return Yr(e),Qd(ii(Uint8Array.from(e).reverse()))}function Jd(e,t){return si(e.toString(16).padStart(2*t,"0"))}function eh(e,t){return Jd(e,t).reverse()}function th(e,t,n){let r;if("string"==typeof t)try{r=si(t)}catch(t){throw new Error(e+" must be hex string or Uint8Array, cause: "+t)}else{if(!Wr(t))throw new Error(e+" must be hex string or Uint8Array");r=Uint8Array.from(t)}const i=r.length;if("number"==typeof n&&i!==n)throw new Error(e+" of length "+n+" expected, got "+i);return r}function nh(e){return Uint8Array.from(e)}const rh=e=>"bigint"==typeof e&&qd<=e;function ih(e,t,n,r){if(!function(e,t,n){return rh(e)&&rh(t)&&rh(n)&&t<=e&&e<n}(t,n,r))throw new Error("expected valid "+e+": "+n+" <= n < "+r+", got "+t)}function oh(e){let t;for(t=0;e>qd;e>>=jd,t+=1);return t}const sh=e=>(jd<<BigInt(e))-jd;function ah(e,t,n={}){if(!e||"object"!=typeof e)throw new Error("expected valid options object");function r(t,n,r){const i=e[t];if(r&&void 0===i)return;const o=typeof i;if(o!==n||null===i)throw new Error(`param "${t}" is invalid: expected ${n}, got ${o}`)}Object.entries(t).forEach(([e,t])=>r(e,t,!1)),Object.entries(n).forEach(([e,t])=>r(e,t,!0))}const lh=()=>{throw new Error("not implemented")};function ch(e){const t=new WeakMap;return(n,...r)=>{const i=t.get(n);if(void 0!==i)return i;const o=e(n,...r);return t.set(n,o),o}}const uh=BigInt(0),dh=BigInt(1),hh=BigInt(2),fh=BigInt(3),ph=BigInt(4),gh=BigInt(5),mh=BigInt(7),yh=BigInt(8),wh=BigInt(9),bh=BigInt(16);function vh(e,t){const n=e%t;return n>=uh?n:t+n}function Eh(e,t,n){let r=e;for(;t-- >uh;)r*=r,r%=n;return r}function Sh(e,t){if(e===uh)throw new Error("invert: expected non-zero number");if(t<=uh)throw new Error("invert: expected positive modulus, got "+t);let n=vh(e,t),r=t,i=uh,o=dh,s=dh,a=uh;for(;n!==uh;){const e=r/n,t=r%n,l=i-s*e,c=o-a*e;r=n,n=t,i=s,o=a,s=l,a=c}if(r!==dh)throw new Error("invert: does not exist");return vh(i,t)}function kh(e,t,n){if(!e.eql(e.sqr(t),n))throw new Error("Cannot find square root")}function _h(e,t){const n=(e.ORDER+dh)/ph,r=e.pow(t,n);return kh(e,r,t),r}function Rh(e,t){const n=(e.ORDER-gh)/yh,r=e.mul(t,hh),i=e.pow(r,n),o=e.mul(t,i),s=e.mul(e.mul(o,hh),i),a=e.mul(o,e.sub(s,e.ONE));return kh(e,a,t),a}function Ih(e){if(e<fh)throw new Error("sqrt is not defined for small field");let t=e-dh,n=0;for(;t%hh===uh;)t/=hh,n++;let r=hh;const i=Dh(e);for(;1===Ch(i,r);)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(1===n)return _h;let o=i.pow(r,t);const s=(t+dh)/hh;return function(e,r){if(e.is0(r))return r;if(1!==Ch(e,r))throw new Error("Cannot find square root");let i=n,a=e.mul(e.ONE,o),l=e.pow(r,t),c=e.pow(r,s);for(;!e.eql(l,e.ONE);){if(e.is0(l))return e.ZERO;let t=1,n=e.sqr(l);for(;!e.eql(n,e.ONE);)if(t++,n=e.sqr(n),t===i)throw new Error("Cannot find square root");const r=dh<<BigInt(i-t-1),o=e.pow(a,r);i=t,a=e.sqr(o),l=e.mul(l,a),c=e.mul(c,o)}return c}}const Ah=(e,t)=>(vh(e,t)&dh)===dh,xh=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Th(e,t,n=!1){const r=new Array(t.length).fill(n?e.ZERO:void 0),i=t.reduce((t,n,i)=>e.is0(n)?t:(r[i]=t,e.mul(t,n)),e.ONE),o=e.inv(i);return t.reduceRight((t,n,i)=>e.is0(n)?t:(r[i]=e.mul(t,r[i]),e.mul(t,n)),o),r}function Ch(e,t){const n=(e.ORDER-dh)/hh,r=e.pow(t,n),i=e.eql(r,e.ONE),o=e.eql(r,e.ZERO),s=e.eql(r,e.neg(e.ONE));if(!i&&!o&&!s)throw new Error("invalid Legendre symbol result");return i?1:o?0:-1}function Nh(e,t){void 0!==t&&Gr(t);const n=void 0!==t?t:e.toString(2).length;return{nBitLength:n,nByteLength:Math.ceil(n/8)}}function Dh(e,t,n=!1,r={}){if(e<=uh)throw new Error("invalid field: expected ORDER > 0, got "+e);let i,o,s,a=!1;if("object"==typeof t&&null!=t){if(r.sqrt||n)throw new Error("cannot specify opts in two arguments");const e=t;e.BITS&&(i=e.BITS),e.sqrt&&(o=e.sqrt),"boolean"==typeof e.isLE&&(n=e.isLE),"boolean"==typeof e.modFromBytes&&(a=e.modFromBytes),s=e.allowedLengths}else"number"==typeof t&&(i=t),r.sqrt&&(o=r.sqrt);const{nBitLength:l,nByteLength:c}=Nh(e,i);if(c>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let u;const d=Object.freeze({ORDER:e,isLE:n,BITS:l,BYTES:c,MASK:sh(l),ZERO:uh,ONE:dh,allowedLengths:s,create:t=>vh(t,e),isValid:t=>{if("bigint"!=typeof t)throw new Error("invalid field element: expected bigint, got "+typeof t);return uh<=t&&t<e},is0:e=>e===uh,isValidNot0:e=>!d.is0(e)&&d.isValid(e),isOdd:e=>(e&dh)===dh,neg:t=>vh(-t,e),eql:(e,t)=>e===t,sqr:t=>vh(t*t,e),add:(t,n)=>vh(t+n,e),sub:(t,n)=>vh(t-n,e),mul:(t,n)=>vh(t*n,e),pow:(e,t)=>function(e,t,n){if(n<uh)throw new Error("invalid exponent, negatives unsupported");if(n===uh)return e.ONE;if(n===dh)return t;let r=e.ONE,i=t;for(;n>uh;)n&dh&&(r=e.mul(r,i)),i=e.sqr(i),n>>=dh;return r}(d,e,t),div:(t,n)=>vh(t*Sh(n,e),e),sqrN:e=>e*e,addN:(e,t)=>e+t,subN:(e,t)=>e-t,mulN:(e,t)=>e*t,inv:t=>Sh(t,e),sqrt:o||(t=>{return u||(u=(n=e)%ph===fh?_h:n%yh===gh?Rh:n%bh===wh?function(e){const t=Dh(e),n=Ih(e),r=n(t,t.neg(t.ONE)),i=n(t,r),o=n(t,t.neg(r)),s=(e+mh)/bh;return(e,t)=>{let n=e.pow(t,s),a=e.mul(n,r);const l=e.mul(n,i),c=e.mul(n,o),u=e.eql(e.sqr(a),t),d=e.eql(e.sqr(l),t);n=e.cmov(n,a,u),a=e.cmov(c,l,d);const h=e.eql(e.sqr(a),t),f=e.cmov(n,a,h);return kh(e,f,t),f}}(n):Ih(n)),u(d,t);var n}),toBytes:e=>n?eh(e,c):Jd(e,c),fromBytes:(t,r=!0)=>{if(s){if(!s.includes(t.length)||t.length>c)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+t.length);const e=new Uint8Array(c);e.set(t,n?0:e.length-t.length),t=e}if(t.length!==c)throw new Error("Field.fromBytes: expected "+c+" bytes, got "+t.length);let i=n?Zd(t):Xd(t);if(a&&(i=vh(i,e)),!r&&!d.isValid(i))throw new Error("invalid field element: outside of range 0..ORDER");return i},invertBatch:e=>Th(d,e),cmov:(e,t,n)=>n?t:e});return Object.freeze(d)}function Ph(e){if("bigint"!=typeof e)throw new Error("field order must be bigint");const t=e.toString(2).length;return Math.ceil(t/8)}function Lh(e){const t=Ph(e);return t+Math.ceil(t/2)}const Bh=BigInt(0),Oh=BigInt(1);function Mh(e,t){const n=t.negate();return e?n:t}function Uh(e,t){const n=Th(e.Fp,t.map(e=>e.Z));return t.map((t,r)=>e.fromAffine(t.toAffine(n[r])))}function Fh(e,t){if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+e)}function zh(e,t){Fh(e,t);const n=2**e;return{windows:Math.ceil(t/e)+1,windowSize:2**(e-1),mask:sh(e),maxNumber:n,shiftBy:BigInt(e)}}function Vh(e,t,n){const{windowSize:r,mask:i,maxNumber:o,shiftBy:s}=n;let a=Number(e&i),l=e>>s;a>r&&(a-=o,l+=Oh);const c=t*r;return{nextN:l,offset:c+Math.abs(a)-1,isZero:0===a,isNeg:a<0,isNegF:t%2!=0,offsetF:c}}const $h=new WeakMap,Hh=new WeakMap;function Kh(e){return Hh.get(e)||1}function qh(e){if(e!==Bh)throw new Error("invalid wNAF")}class jh{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let r=e;for(;t>Bh;)t&Oh&&(n=n.add(r)),r=r.double(),t>>=Oh;return n}precomputeWindow(e,t){const{windows:n,windowSize:r}=zh(t,this.bits),i=[];let o=e,s=o;for(let e=0;e<n;e++){s=o,i.push(s);for(let e=1;e<r;e++)s=s.add(o),i.push(s);o=s.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let r=this.ZERO,i=this.BASE;const o=zh(e,this.bits);for(let e=0;e<o.windows;e++){const{nextN:s,offset:a,isZero:l,isNeg:c,isNegF:u,offsetF:d}=Vh(n,e,o);n=s,l?i=i.add(Mh(u,t[d])):r=r.add(Mh(c,t[a]))}return qh(n),{p:r,f:i}}wNAFUnsafe(e,t,n,r=this.ZERO){const i=zh(e,this.bits);for(let e=0;e<i.windows&&n!==Bh;e++){const{nextN:o,offset:s,isZero:a,isNeg:l}=Vh(n,e,i);if(n=o,!a){const e=t[s];r=r.add(l?e.negate():e)}}return qh(n),r}getPrecomputes(e,t,n){let r=$h.get(t);return r||(r=this.precomputeWindow(t,e),1!==e&&("function"==typeof n&&(r=n(r)),$h.set(t,r))),r}cached(e,t,n){const r=Kh(e);return this.wNAF(r,this.getPrecomputes(r,e,n),t)}unsafe(e,t,n,r){const i=Kh(e);return 1===i?this._unsafeLadder(e,t,r):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,r)}createCache(e,t){Fh(t,this.bits),Hh.set(e,t),$h.delete(e)}hasCache(e){return 1!==Kh(e)}}function Wh(e,t,n,r){(function(e,t){if(!Array.isArray(e))throw new Error("array expected");e.forEach((e,n)=>{if(!(e instanceof t))throw new Error("invalid point at index "+n)})})(n,e),function(e,t){if(!Array.isArray(e))throw new Error("array of scalars expected");e.forEach((e,n)=>{if(!t.isValid(e))throw new Error("invalid scalar at index "+n)})}(r,t);const i=n.length,o=r.length;if(i!==o)throw new Error("arrays of points and scalars must have equal length");const s=e.ZERO,a=oh(BigInt(i));let l=1;a>12?l=a-3:a>4?l=a-2:a>0&&(l=2);const c=sh(l),u=new Array(Number(c)+1).fill(s);let d=s;for(let e=Math.floor((t.BITS-1)/l)*l;e>=0;e-=l){u.fill(s);for(let t=0;t<o;t++){const i=r[t],o=Number(i>>BigInt(e)&c);u[o]=u[o].add(n[t])}let t=s;for(let e=u.length-1,n=s;e>0;e--)n=n.add(u[e]),t=t.add(n);if(d=d.add(t),0!==e)for(let e=0;e<l;e++)d=d.double()}return d}function Gh(e,t,n){if(t){if(t.ORDER!==e)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return function(e){ah(e,xh.reduce((e,t)=>(e[t]="function",e),{ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"}))}(t),t}return Dh(e,{isLE:n})}function Yh(e,t,n={},r){if(void 0===r&&(r="edwards"===e),!t||"object"!=typeof t)throw new Error(`expected valid ${e} CURVE object`);for(const e of["p","n","h"]){const n=t[e];if(!("bigint"==typeof n&&n>Bh))throw new Error(`CURVE.${e} must be positive bigint`)}const i=Gh(t.p,n.Fp,r),o=Gh(t.n,n.Fn,r),s=["Gx","Gy","a","weierstrass"===e?"b":"d"];for(const e of s)if(!i.isValid(t[e]))throw new Error(`CURVE.${e} must be valid field element of CURVE.Fp`);return{CURVE:t=Object.freeze(Object.assign({},t)),Fp:i,Fn:o}}const Qh=BigInt(0),Xh=BigInt(1),Zh=BigInt(2),Jh=BigInt(8);class ef{constructor(e){this.ep=e}static fromBytes(e){lh()}static fromHex(e){lh()}get x(){return this.toAffine().x}get y(){return this.toAffine().y}clearCofactor(){return this}assertValidity(){this.ep.assertValidity()}toAffine(e){return this.ep.toAffine(e)}toHex(){return ii(this.toBytes())}toString(){return this.toHex()}isTorsionFree(){return!0}isSmallOrder(){return!1}add(e){return this.assertSame(e),this.init(this.ep.add(e.ep))}subtract(e){return this.assertSame(e),this.init(this.ep.subtract(e.ep))}multiply(e){return this.init(this.ep.multiply(e))}multiplyUnsafe(e){return this.init(this.ep.multiplyUnsafe(e))}double(){return this.init(this.ep.double())}negate(){return this.init(this.ep.negate())}precompute(e,t){return this.init(this.ep.precompute(e,t))}toRawBytes(){return this.toBytes()}}function tf(e){const{CURVE:t,curveOpts:n,hash:r,eddsaOpts:i}=function(e){const t={a:e.a,d:e.d,p:e.Fp.ORDER,n:e.n,h:e.h,Gx:e.Gx,Gy:e.Gy},n={Fp:e.Fp,Fn:Dh(t.n,e.nBitLength,!0),uvRatio:e.uvRatio},r={randomBytes:e.randomBytes,adjustScalarBytes:e.adjustScalarBytes,domain:e.domain,prehash:e.prehash,mapToCurve:e.mapToCurve};return{CURVE:t,curveOpts:n,hash:e.hash,eddsaOpts:r}}(e),o=function(e,t={}){const n=Yh("edwards",e,t,t.FpFnLE),{Fp:r,Fn:i}=n;let o=n.CURVE;const{h:s}=o;ah(t,{},{uvRatio:"function"});const a=Zh<<BigInt(8*i.BYTES)-Xh,l=e=>r.create(e),c=t.uvRatio||((e,t)=>{try{return{isValid:!0,value:r.sqrt(r.div(e,t))}}catch(e){return{isValid:!1,value:Qh}}});if(!function(e,t,n,r){const i=e.sqr(n),o=e.sqr(r),s=e.add(e.mul(t.a,i),o),a=e.add(e.ONE,e.mul(t.d,e.mul(i,o)));return e.eql(s,a)}(r,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function u(e,t,n=!1){return ih("coordinate "+e,t,n?Xh:Qh,a),t}function d(e){if(!(e instanceof p))throw new Error("ExtendedPoint expected")}const h=ch((e,t)=>{const{X:n,Y:i,Z:o}=e,s=e.is0();null==t&&(t=s?Jh:r.inv(o));const a=l(n*t),c=l(i*t),u=r.mul(o,t);if(s)return{x:Qh,y:Xh};if(u!==Xh)throw new Error("invZ was invalid");return{x:a,y:c}}),f=ch(e=>{const{a:t,d:n}=o;if(e.is0())throw new Error("bad point: ZERO");const{X:r,Y:i,Z:s,T:a}=e,c=l(r*r),u=l(i*i),d=l(s*s),h=l(d*d),f=l(c*t);if(l(d*l(f+u))!==l(h+l(n*l(c*u))))throw new Error("bad point: equation left != right (1)");if(l(r*i)!==l(s*a))throw new Error("bad point: equation left != right (2)");return!0});class p{constructor(e,t,n,r){this.X=u("x",e),this.Y=u("y",t),this.Z=u("z",n,!0),this.T=u("t",r),Object.freeze(this)}static CURVE(){return o}static fromAffine(e){if(e instanceof p)throw new Error("extended point not allowed");const{x:t,y:n}=e||{};return u("x",t),u("y",n),new p(t,n,Xh,l(t*n))}static fromBytes(e,t=!1){const n=r.BYTES,{a:i,d:s}=o;e=nh(Gd(e,n,"point")),Wd(t,"zip215");const u=nh(e),d=e[n-1];u[n-1]=-129&d;const h=Zd(u),f=t?a:r.ORDER;ih("point.y",h,Qh,f);const g=l(h*h),m=l(g-Xh),y=l(s*g-i);let{isValid:w,value:b}=c(m,y);if(!w)throw new Error("bad point: invalid y coordinate");const v=(b&Xh)===Xh,E=!!(128&d);if(!t&&b===Qh&&E)throw new Error("bad point: x=0 and x_0=1");return E!==v&&(b=l(-b)),p.fromAffine({x:b,y:h})}static fromHex(e,t=!1){return p.fromBytes(th("point",e),t)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(e=8,t=!0){return g.createCache(this,e),t||this.multiply(Zh),this}assertValidity(){f(this)}equals(e){d(e);const{X:t,Y:n,Z:r}=this,{X:i,Y:o,Z:s}=e,a=l(t*s),c=l(i*r),u=l(n*s),h=l(o*r);return a===c&&u===h}is0(){return this.equals(p.ZERO)}negate(){return new p(l(-this.X),this.Y,this.Z,l(-this.T))}double(){const{a:e}=o,{X:t,Y:n,Z:r}=this,i=l(t*t),s=l(n*n),a=l(Zh*l(r*r)),c=l(e*i),u=t+n,d=l(l(u*u)-i-s),h=c+s,f=h-a,g=c-s,m=l(d*f),y=l(h*g),w=l(d*g),b=l(f*h);return new p(m,y,b,w)}add(e){d(e);const{a:t,d:n}=o,{X:r,Y:i,Z:s,T:a}=this,{X:c,Y:u,Z:h,T:f}=e,g=l(r*c),m=l(i*u),y=l(a*n*f),w=l(s*h),b=l((r+i)*(c+u)-g-m),v=w-y,E=w+y,S=l(m-t*g),k=l(b*v),_=l(E*S),R=l(b*S),I=l(v*E);return new p(k,_,I,R)}subtract(e){return this.add(e.negate())}multiply(e){if(!i.isValidNot0(e))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:t,f:n}=g.cached(this,e,e=>Uh(p,e));return Uh(p,[t,n])[0]}multiplyUnsafe(e,t=p.ZERO){if(!i.isValid(e))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return e===Qh?p.ZERO:this.is0()||e===Xh?this:g.unsafe(this,e,e=>Uh(p,e),t)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}isTorsionFree(){return g.unsafe(this,o.n).is0()}toAffine(e){return h(this,e)}clearCofactor(){return s===Xh?this:this.multiplyUnsafe(s)}toBytes(){const{x:e,y:t}=this.toAffine(),n=r.toBytes(t);return n[n.length-1]|=e&Xh?128:0,n}toHex(){return ii(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(e){return Uh(p,e)}static msm(e,t){return Wh(p,i,e,t)}_setWindowSize(e){this.precompute(e)}toRawBytes(){return this.toBytes()}}p.BASE=new p(o.Gx,o.Gy,Xh,l(o.Gx*o.Gy)),p.ZERO=new p(Qh,Xh,Xh,Qh),p.Fp=r,p.Fn=i;const g=new jh(p,i.BITS);return p.BASE.precompute(8),p}(t,n);return function(e,t){const n=t.Point;return Object.assign({},t,{ExtendedPoint:n,CURVE:e,nBitLength:n.Fn.BITS,nByteLength:n.Fn.BYTES})}(e,function(e,t,n={}){if("function"!=typeof t)throw new Error('"hash" function param is required');ah(n,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:r}=n,{BASE:i,Fp:o,Fn:s}=e,a=n.randomBytes||gi,l=n.adjustScalarBytes||(e=>e),c=n.domain||((e,t,n)=>{if(Wd(n,"phflag"),t.length||n)throw new Error("Contexts/pre-hash are not supported");return e});function u(e){return s.create(Zd(e))}function d(e){const{head:n,prefix:r,scalar:o}=function(e){const n=m.secretKey;e=th("private key",e,n);const r=th("hashed private key",t(e),2*n),i=l(r.slice(0,n));return{head:i,prefix:r.slice(n,2*n),scalar:u(i)}}(e),s=i.multiply(o),a=s.toBytes();return{head:n,prefix:r,scalar:o,point:s,pointBytes:a}}function h(e){return d(e).pointBytes}function f(e=Uint8Array.of(),...n){const i=hi(...n);return u(t(c(i,th("context",e),!!r)))}const p={zip215:!0},g=o.BYTES,m={secretKey:g,publicKey:g,signature:2*g,seed:g};function y(e=a(m.seed)){return Gd(e,m.seed,"seed")}const w={getExtendedPublicKey:d,randomSecretKey:y,isValidSecretKey:function(e){return Wr(e)&&e.length===s.BYTES},isValidPublicKey:function(t,n){try{return!!e.fromBytes(t,n)}catch(e){return!1}},toMontgomery(t){const{y:n}=e.fromBytes(t),r=m.publicKey,i=32===r;if(!i&&57!==r)throw new Error("only defined for 25519 and 448");const s=i?o.div(Xh+n,Xh-n):o.div(n-Xh,n+Xh);return o.toBytes(s)},toMontgomerySecret(e){const n=m.secretKey;Gd(e,n);const r=t(e.subarray(0,n));return l(r).subarray(0,n)},randomPrivateKey:y,precompute:(t=8,n=e.BASE)=>n.precompute(t,!1)};return Object.freeze({keygen:function(e){const t=w.randomSecretKey(e);return{secretKey:t,publicKey:h(t)}},getPublicKey:h,sign:function(e,t,n={}){e=th("message",e),r&&(e=r(e));const{prefix:o,scalar:a,pointBytes:l}=d(t),c=f(n.context,o,e),u=i.multiply(c).toBytes(),h=f(n.context,u,l,e),p=s.create(c+h*a);if(!s.isValid(p))throw new Error("sign failed: invalid s");return Gd(hi(u,s.toBytes(p)),m.signature,"result")},verify:function(t,n,o,s=p){const{context:a,zip215:l}=s,c=m.signature;t=th("signature",t,c),n=th("message",n),o=th("publicKey",o,m.publicKey),void 0!==l&&Wd(l,"zip215"),r&&(n=r(n));const u=c/2,d=t.subarray(0,u),h=Zd(t.subarray(u,c));let g,y,w;try{g=e.fromBytes(o,l),y=e.fromBytes(d,l),w=i.multiplyUnsafe(h)}catch(e){return!1}if(!l&&g.isSmallOrder())return!1;const b=f(a,y.toBytes(),g.toBytes(),n);return y.add(g.multiplyUnsafe(b)).subtract(w).clearCofactor().is0()},utils:w,Point:e,lengths:m})}(o,r,i))}ci("HashToScalar-");const nf=BigInt(0),rf=BigInt(1),of=BigInt(2);const sf=BigInt(0),af=BigInt(1),lf=BigInt(2),cf=BigInt(3),uf=BigInt(5),df=BigInt(8),hf=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),ff=(()=>({p:hf,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:df,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")}))();function pf(e){const t=BigInt(10),n=BigInt(20),r=BigInt(40),i=BigInt(80),o=hf,s=e*e%o*e%o,a=Eh(s,lf,o)*s%o,l=Eh(a,af,o)*e%o,c=Eh(l,uf,o)*l%o,u=Eh(c,t,o)*c%o,d=Eh(u,n,o)*u%o,h=Eh(d,r,o)*d%o,f=Eh(h,i,o)*h%o,p=Eh(f,i,o)*h%o,g=Eh(p,t,o)*c%o;return{pow_p_5_8:Eh(g,lf,o)*e%o,b2:s}}function gf(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}const mf=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function yf(e,t){const n=hf,r=vh(t*t*t,n),i=vh(r*r*t,n);let o=vh(e*r*pf(e*i).pow_p_5_8,n);const s=vh(t*o*o,n),a=o,l=vh(o*mf,n),c=s===e,u=s===vh(-e,n),d=s===vh(-e*mf,n);return c&&(o=a),(u||d)&&(o=l),Ah(o,n)&&(o=vh(-o,n)),{isValid:c||u,value:o}}const wf=(()=>Dh(ff.p,{isLE:!0}))(),bf=(()=>Dh(ff.n,{isLE:!0}))(),vf=(()=>({...ff,Fp:wf,hash:Fd,adjustScalarBytes:gf,uvRatio:yf}))(),Ef=(()=>tf(vf))(),Sf=(()=>{const e=wf.ORDER;return function(e){const t=(ah(n=e,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...n}));var n;const{P:r,type:i,adjustScalarBytes:o,powPminus2:s,randomBytes:a}=t,l="x25519"===i;if(!l&&"x448"!==i)throw new Error("invalid type");const c=a||gi,u=l?255:448,d=l?32:56,h=l?BigInt(9):BigInt(5),f=l?BigInt(121665):BigInt(39081),p=l?of**BigInt(254):of**BigInt(447),g=l?BigInt(8)*of**BigInt(251)-rf:BigInt(4)*of**BigInt(445)-rf,m=p+g+rf,y=e=>vh(e,r),w=b(h);function b(e){return eh(y(e),d)}function v(e,t){const n=function(e,t){ih("u",e,nf,r),ih("scalar",t,p,m);const n=t,i=e;let o=rf,a=nf,l=e,c=rf,d=nf;for(let e=BigInt(u-1);e>=nf;e--){const t=n>>e&rf;d^=t,({x_2:o,x_3:l}=S(d,o,l)),({x_2:a,x_3:c}=S(d,a,c)),d=t;const r=o+a,s=y(r*r),u=o-a,h=y(u*u),p=s-h,g=l+c,m=y((l-c)*r),w=y(g*u),b=m+w,v=m-w;l=y(b*b),c=y(i*y(v*v)),o=y(s*h),a=y(p*(s+y(f*p)))}({x_2:o,x_3:l}=S(d,o,l)),({x_2:a,x_3:c}=S(d,a,c));const h=s(a);return y(o*h)}(function(e){const t=th("u coordinate",e,d);return l&&(t[31]&=127),y(Zd(t))}(t),function(e){return Zd(o(th("scalar",e,d)))}(e));if(n===nf)throw new Error("invalid private or public key received");return b(n)}function E(e){return v(e,w)}function S(e,t,n){const r=y(e*(t-n));return{x_2:t=y(t-r),x_3:n=y(n+r)}}const k={secretKey:d,publicKey:d,seed:d},_=(e=c(d))=>(Yr(e,k.seed),e);return{keygen:function(e){const t=_(e);return{secretKey:t,publicKey:E(t)}},getSharedSecret:(e,t)=>v(e,t),getPublicKey:e=>E(e),scalarMult:v,scalarMultBase:E,utils:{randomSecretKey:_,randomPrivateKey:_},GuBytes:w.slice(),lengths:k}}({P:e,type:"x25519",powPminus2:t=>{const{pow_p_5_8:n,b2:r}=pf(t);return vh(Eh(n,cf,e)*r,e)},adjustScalarBytes:gf})})(),kf=mf,_f=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),Rf=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),If=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),Af=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952"),xf=e=>yf(af,e),Tf=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),Cf=e=>Ef.Point.Fp.create(Zd(e)&Tf);function Nf(e){const{d:t}=ff,n=hf,r=e=>wf.create(e),i=r(kf*e*e),o=r((i+af)*If);let s=BigInt(-1);const a=r((s-t*i)*r(i+t));let{isValid:l,value:c}=yf(o,a),u=r(c*e);Ah(u,n)||(u=r(-u)),l||(c=u),l||(s=i);const d=r(s*(i-af)*Af-a),h=c*c,f=r((c+c)*a),p=r(d*_f),g=r(af-h),m=r(af+h);return new Ef.Point(r(f*m),r(g*p),r(p*m),r(f*g))}class Df extends ef{constructor(e){super(e)}static fromAffine(e){return new Df(Ef.Point.fromAffine(e))}assertSame(e){if(!(e instanceof Df))throw new Error("RistrettoPoint expected")}init(e){return new Df(e)}static hashToCurve(e){return function(e){Yr(e,64);const t=Nf(Cf(e.subarray(0,32))),n=Nf(Cf(e.subarray(32,64)));return new Df(t.add(n))}(th("ristrettoHash",e,64))}static fromBytes(e){Yr(e,32);const{a:t,d:n}=ff,r=hf,i=e=>wf.create(e),o=Cf(e);if(!function(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e[r]^t[r];return 0===n}(wf.toBytes(o),e)||Ah(o,r))throw new Error("invalid ristretto255 encoding 1");const s=i(o*o),a=i(af+t*s),l=i(af-t*s),c=i(a*a),u=i(l*l),d=i(t*n*c-u),{isValid:h,value:f}=xf(i(d*u)),p=i(f*l),g=i(f*p*d);let m=i((o+o)*p);Ah(m,r)&&(m=i(-m));const y=i(a*g),w=i(m*y);if(!h||Ah(w,r)||y===sf)throw new Error("invalid ristretto255 encoding 2");return new Df(new Ef.Point(m,y,af,w))}static fromHex(e){return Df.fromBytes(th("ristrettoHex",e,32))}static msm(e,t){return Wh(Df,Ef.Point.Fn,e,t)}toBytes(){let{X:e,Y:t,Z:n,T:r}=this.ep;const i=hf,o=e=>wf.create(e),s=o(o(n+t)*o(n-t)),a=o(e*t),l=o(a*a),{value:c}=xf(o(s*l)),u=o(c*s),d=o(c*a),h=o(u*d*r);let f;if(Ah(r*h,i)){let n=o(t*kf),r=o(e*kf);e=n,t=r,f=o(u*Rf)}else f=d;Ah(e*h,i)&&(t=o(-t));let p=o((n-t)*f);return Ah(p,i)&&(p=o(-p)),wf.toBytes(p)}equals(e){this.assertSame(e);const{X:t,Y:n}=this.ep,{X:r,Y:i}=e.ep,o=e=>wf.create(e),s=o(t*i)===o(n*r),a=o(n*i)===o(t*r);return s||a}is0(){return this.equals(Df.ZERO)}}Df.BASE=(()=>new Df(Ef.Point.BASE))(),Df.ZERO=(()=>new Df(Ef.Point.ZERO))(),Df.Fp=(()=>wf)(),Df.Fn=(()=>bf)();const Pf=32,Lf=64,Bf=32;function Of(e,t){const n=new Uint8Array(Lf);for(let r=0;r<Bf;r++)n[r]=e[r],n[Bf+r]=t[r];return n}const Mf={get(e=globalThis){const t=e.crypto;if(null==t?.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return t}},Uf={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Ff(e){const t=e?.algorithm??"AES-GCM";let n=e?.keyLength??16;const r=e?.nonceLength??12,i=e?.digest??"SHA-256",o=e?.saltLength??16,s=e?.iterations??32767,a=Mf.get();return n*=8,{encrypt:async function(e,l){const c=a.getRandomValues(new Uint8Array(o)),u=a.getRandomValues(new Uint8Array(r)),d={name:t,iv:u};let h;if("string"==typeof l&&(l=Hn(l)),0===l.length){h=await a.subtle.importKey("jwk",Uf,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:c,iterations:s,hash:{name:i}},r=await a.subtle.importKey("raw",l,{name:"PBKDF2"},!1,["deriveKey"]);h=await a.subtle.deriveKey(e,r,{name:t,length:n},!0,["encrypt"])}catch{h=await a.subtle.importKey("jwk",Uf,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:c,iterations:s,hash:{name:i}},r=await a.subtle.importKey("raw",l,{name:"PBKDF2"},!1,["deriveKey"]);h=await a.subtle.deriveKey(e,r,{name:t,length:n},!0,["encrypt"])}const f=await a.subtle.encrypt(d,h,e);return de([c,d.iv,new Uint8Array(f)])},decrypt:async function(e,l){const c=e.subarray(0,o),u=e.subarray(o,o+r),d=e.subarray(o+r),h={name:t,iv:u};let f;if("string"==typeof l&&(l=Hn(l)),0===l.length)try{const e={name:"PBKDF2",salt:c,iterations:s,hash:{name:i}},r=await a.subtle.importKey("raw",l,{name:"PBKDF2"},!1,["deriveKey"]);f=await a.subtle.deriveKey(e,r,{name:t,length:n},!0,["decrypt"])}catch{f=await a.subtle.importKey("jwk",Uf,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:c,iterations:s,hash:{name:i}},r=await a.subtle.importKey("raw",l,{name:"PBKDF2"},!1,["deriveKey"]);f=await a.subtle.deriveKey(e,r,{name:t,length:n},!0,["decrypt"])}const p=await a.subtle.decrypt(h,f,d);return new Uint8Array(p)}}}async function zf(e,t){const n=Ff(),r=await n.encrypt(e,t);return Ut.encode(r)}var Vf,$f,Hf,Kf;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(Vf||(Vf={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}($f||($f={})),function(e){e.codec=()=>gr($f)}(Vf||(Vf={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),Vf.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=Vf.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(Hf||(Hf={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),Vf.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=Vf.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(Kf||(Kf={}));class qf{_key;constructor(e){this._key=Xf(e,Pf)}verify(e,t){return function(e,t,n){return Ef.verify(t,n instanceof Uint8Array?n:n.subarray(),e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return Hf.encode({Type:Vf.Ed25519,Data:this.marshal()}).subarray()}equals(e){return he(this.bytes,e.bytes)}hash(){const e=xn.digest(this.bytes);return Kd(e)?e.then(({bytes:e})=>e):e.bytes}}class jf{_key;_publicKey;constructor(e,t){this._key=Xf(e,Lf),this._publicKey=Xf(t,Pf)}sign(e){return function(e,t){const n=e.subarray(0,Bf);return Ef.sign(t instanceof Uint8Array?t:t.subarray(),n)}(this._key,e)}get public(){return new qf(this._publicKey)}marshal(){return this._key}get bytes(){return Kf.encode({Type:Vf.Ed25519,Data:this.marshal()}).subarray()}equals(e){return he(this.bytes,e.bytes)}async hash(){const e=xn.digest(this.bytes);let t;return Kd(e)?({bytes:t}=await e):t=e.bytes,t}async id(){const e=kn.digest(this.public.bytes);return Ot.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if("libp2p-key"===t)return zf(this.bytes,e);throw new x(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function Wf(e){if(e.length>Lf){const t=(e=Xf(e,Lf+Pf)).subarray(0,Lf),n=e.subarray(Lf,e.length);return new jf(t,n)}const t=(e=Xf(e,Lf)).subarray(0,Lf),n=e.subarray(Pf);return new jf(t,n)}function Gf(e){return e=Xf(e,Pf),new qf(e)}async function Yf(){const{privateKey:e,publicKey:t}=function(){const e=Ef.utils.randomPrivateKey(),t=Ef.getPublicKey(e);return{privateKey:Of(e,t),publicKey:t}}();return new jf(e,t)}async function Qf(e){const{privateKey:t,publicKey:n}=function(e){if(e.length!==Bf)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=Ef.getPublicKey(t);return{privateKey:Of(t,n),publicKey:n}}(e);return new jf(t,n)}function Xf(e,t){if((e=Uint8Array.from(e??[])).length!==t)throw new x(`Key must be a Uint8Array of length ${t}, got ${e.length}`,"ERR_INVALID_KEY_TYPE");return e}async function Zf(e){const t=[await Mf.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await ep(e)],n=await Jf({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function Jf(e){if(null==e.privateKey||null==e.publicKey)throw new x("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Mf.get().subtle.exportKey("jwk",e.privateKey),Mf.get().subtle.exportKey("jwk",e.publicKey)])}async function ep(e){return Mf.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function tp(e){if("RSA"!==e.kty)throw new x("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new x("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*Hn(e.n,"base64url").length}var np=n(152);function rp(e,t){let n=0;if(1===e.length)return e[0];for(let r=e.length-1;r>=0;r--)n+=e[e.length-1-r]*Math.pow(2,t*r);return n}function ip(e,t,n=-1){const r=n;let i=e,o=0,s=Math.pow(2,t);for(let n=1;n<8;n++){if(e<s){let e;if(r<0)e=new ArrayBuffer(n),o=n;else{if(r<n)return new ArrayBuffer(0);e=new ArrayBuffer(r),o=r}const s=new Uint8Array(e);for(let e=n-1;e>=0;e--){const n=Math.pow(2,e*t);s[o-e-1]=Math.floor(i/n),i-=s[o-e-1]*n}return e}s*=Math.pow(2,t)}return new ArrayBuffer(0)}function op(...e){let t=0,n=0;for(const n of e)t+=n.length;const r=new ArrayBuffer(t),i=new Uint8Array(r);for(const t of e)i.set(t,n),n+=t.length;return i}function sp(){const e=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const t=255===e[0]&&128&e[1],n=0===e[0]&&!(128&e[1]);(t||n)&&this.warnings.push("Needlessly long format")}const t=new ArrayBuffer(this.valueHex.byteLength),n=new Uint8Array(t);for(let e=0;e<this.valueHex.byteLength;e++)n[e]=0;n[0]=128&e[0];const r=rp(n,8),i=new ArrayBuffer(this.valueHex.byteLength),o=new Uint8Array(i);for(let t=0;t<this.valueHex.byteLength;t++)o[t]=e[t];return o[0]&=127,rp(o,8)-r}function ap(e,t){const n=e.toString(10);if(t<n.length)return"";const r=t-n.length,i=new Array(r);for(let e=0;e<r;e++)i[e]="0";return i.join("").concat(n)}function lp(){if("undefined"==typeof BigInt)throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function cp(e){let t=0,n=0;for(let n=0;n<e.length;n++)t+=e[n].byteLength;const r=new Uint8Array(t);for(let t=0;t<e.length;t++){const i=e[t];r.set(new Uint8Array(i),n),n+=i.byteLength}return r.buffer}function up(e,t,n,r){return t instanceof Uint8Array?t.byteLength?n<0?(e.error="Wrong parameter: inputOffset less than zero",!1):r<0?(e.error="Wrong parameter: inputLength less than zero",!1):!(t.byteLength-n-r<0&&(e.error="End of input reached before message was fully decoded (inconsistent offset and length values)",1)):(e.error="Wrong parameter: inputBuffer has zero length",!1):(e.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}Math.log(2);class dp{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return cp(this.items)}}const hp=[new Uint8Array([1])],fp="0123456789",pp=new ArrayBuffer(0),gp=new Uint8Array(0),mp="EndOfContent",yp="OCTET STRING",wp="BIT STRING";function bp(e){var t;return(t=class extends e{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(e){this.valueHexView=new Uint8Array(e)}constructor(...e){var t;super(...e);const n=e[0]||{};this.isHexOnly=null!==(t=n.isHexOnly)&&void 0!==t&&t,this.valueHexView=n.valueHex?np._H.toUint8Array(n.valueHex):gp}fromBER(e,t,n){const r=e instanceof ArrayBuffer?new Uint8Array(e):e;if(!up(this,r,t,n))return-1;const i=t+n;return this.valueHexView=r.subarray(t,i),this.valueHexView.length?(this.blockLength=n,i):(this.warnings.push("Zero buffer length"),t)}toBER(e=!1){return this.isHexOnly?e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",pp)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:np.U$.ToHex(this.valueHexView)}}}).NAME="hexBlock",t}class vp{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t="",warnings:n=[],valueBeforeDecode:r=gp}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=np._H.toUint8Array(r)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:np.U$.ToHex(this.valueBeforeDecodeView)}}}vp.NAME="baseBlock";class Ep extends vp{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Ep.NAME="valueBlock";class Sp extends(bp(vp)){constructor({idBlock:e={}}={}){var t,n,r,i;super(),e?(this.isHexOnly=null!==(t=e.isHexOnly)&&void 0!==t&&t,this.valueHexView=e.valueHex?np._H.toUint8Array(e.valueHex):gp,this.tagClass=null!==(n=e.tagClass)&&void 0!==n?n:-1,this.tagNumber=null!==(r=e.tagNumber)&&void 0!==r?r:-1,this.isConstructed=null!==(i=e.isConstructed)&&void 0!==i&&i):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",pp}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const n=new Uint8Array(1);if(!e){let e=this.tagNumber;e&=31,t|=e,n[0]=t}return n.buffer}if(!this.isHexOnly){const n=ip(this.tagNumber,7),r=new Uint8Array(n),i=n.byteLength,o=new Uint8Array(i+1);if(o[0]=31|t,!e){for(let e=0;e<i-1;e++)o[e+1]=128|r[e];o[i]=r[i-1]}return o.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=31|t,!e){const e=this.valueHexView;for(let t=0;t<e.length-1;t++)n[t+1]=128|e[t];n[this.valueHexView.byteLength]=e[e.length-1]}return n.buffer}fromBER(e,t,n){const r=np._H.toUint8Array(e);if(!up(this,r,t,n))return-1;const i=r.subarray(t,t+n);if(0===i.length)return this.error="Zero buffer length",-1;switch(192&i[0]){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=!(32&~i[0]),this.isHexOnly=!1;const o=31&i[0];if(31!==o)this.tagNumber=o,this.blockLength=1;else{let e=1,t=this.valueHexView=new Uint8Array(255),n=255;for(;128&i[e];){if(t[e-1]=127&i[e],e++,e>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(e===n){n+=255;const e=new Uint8Array(n);for(let n=0;n<t.length;n++)e[n]=t[n];t=this.valueHexView=new Uint8Array(n)}}this.blockLength=e+1,t[e-1]=127&i[e];const r=new Uint8Array(e);for(let n=0;n<e;n++)r[n]=t[n];t=this.valueHexView=new Uint8Array(e),t.set(r),this.blockLength<=9?this.tagNumber=rp(t,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(1===this.tagClass&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}Sp.NAME="identificationBlock";class kp extends vp{constructor({lenBlock:e={}}={}){var t,n,r;super(),this.isIndefiniteForm=null!==(t=e.isIndefiniteForm)&&void 0!==t&&t,this.longFormUsed=null!==(n=e.longFormUsed)&&void 0!==n&&n,this.length=null!==(r=e.length)&&void 0!==r?r:0}fromBER(e,t,n){const r=np._H.toUint8Array(e);if(!up(this,r,t,n))return-1;const i=r.subarray(t,t+n);if(0===i.length)return this.error="Zero buffer length",-1;if(255===i[0])return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=128===i[0],this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(128&i[0]),!1===this.longFormUsed)return this.length=i[0],this.blockLength=1,t+this.blockLength;const o=127&i[0];if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const s=t+1,a=r.subarray(s,s+o);return 0===a[o-1]&&this.warnings.push("Needlessly long encoded length"),this.length=rp(a,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),!1===e&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const r=ip(this.length,8);if(r.byteLength>127)return this.error="Too big length",pp;if(t=new ArrayBuffer(r.byteLength+1),e)return t;const i=new Uint8Array(r);n=new Uint8Array(t),n[0]=128|r.byteLength;for(let e=0;e<r.byteLength;e++)n[e+1]=i[e];return t}return t=new ArrayBuffer(1),!1===e&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}kp.NAME="lengthBlock";const _p={};class Rp extends vp{constructor({name:e="",optional:t=!1,primitiveSchema:n,...r}={},i){super(r),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new Sp(r),this.lenBlock=new kp(r),this.valueBlock=i?new i(r):new Ep(r)}fromBER(e,t,n){const r=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return-1===r?(this.error=this.valueBlock.error,r):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),r)}toBER(e,t){const n=t||new dp;t||Ip(this);const r=this.idBlock.toBER(e);if(n.write(r),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const t=this.valueBlock.toBER(e);this.lenBlock.length=t.byteLength;const r=this.lenBlock.toBER(e);n.write(r),n.write(t)}return t?pp:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return"ascii"===e?this.onAsciiEncoding():np.U$.ToHex(this.toBER())}onAsciiEncoding(){return`${this.constructor.NAME} : ${np.U$.ToHex(this.valueBlock.valueBeforeDecodeView)}`}isEqual(e){return this===e||e instanceof this.constructor&&function(e,t){if(e.byteLength!==t.byteLength)return!1;const n=new Uint8Array(e),r=new Uint8Array(t);for(let e=0;e<n.length;e++)if(n[e]!==r[e])return!1;return!0}(this.toBER(),e.toBER())}}function Ip(e){var t;if(e instanceof _p.Constructed)for(const t of e.valueBlock.value)Ip(t)&&(e.lenBlock.isIndefiniteForm=!0);return!!(null===(t=e.lenBlock)||void 0===t?void 0:t.isIndefiniteForm)}Rp.NAME="BaseBlock";class Ap extends Rp{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e="",...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const r=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return-1===r?(this.error=this.valueBlock.error,r):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),r)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}Ap.NAME="BaseStringBlock";class xp extends(bp(Ep)){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}var Tp,Cp,Np,Dp,Pp,Lp,Bp,Op,Mp,Up,Fp,zp,Vp,$p,Hp,Kp,qp,jp,Wp,Gp,Yp,Qp,Xp,Zp,Jp,eg,tg,ng,rg,ig,og,sg,ag;xp.NAME="PrimitiveValueBlock";class lg extends Rp{constructor(e={}){super(e,xp),this.idBlock.isConstructed=!1}}function cg(e,t=0,n=e.length){const r=t;let i=new Rp({},Ep);const o=new vp;if(!up(o,e,t,n))return i.error=o.error,{offset:-1,result:i};if(!e.subarray(t,t+n).length)return i.error="Zero buffer length",{offset:-1,result:i};let s=i.idBlock.fromBER(e,t,n);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),-1===s)return i.error=i.idBlock.error,{offset:-1,result:i};if(t=s,n-=i.idBlock.blockLength,s=i.lenBlock.fromBER(e,t,n),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),-1===s)return i.error=i.lenBlock.error,{offset:-1,result:i};if(t=s,n-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let a=Rp;if(1===i.idBlock.tagClass){if(i.idBlock.tagNumber>=37&&!1===i.idBlock.isHexOnly)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};a=_p.EndOfContent;break;case 1:a=_p.Boolean;break;case 2:a=_p.Integer;break;case 3:a=_p.BitString;break;case 4:a=_p.OctetString;break;case 5:a=_p.Null;break;case 6:a=_p.ObjectIdentifier;break;case 10:a=_p.Enumerated;break;case 12:a=_p.Utf8String;break;case 13:a=_p.RelativeObjectIdentifier;break;case 14:a=_p.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:a=_p.Sequence;break;case 17:a=_p.Set;break;case 18:a=_p.NumericString;break;case 19:a=_p.PrintableString;break;case 20:a=_p.TeletexString;break;case 21:a=_p.VideotexString;break;case 22:a=_p.IA5String;break;case 23:a=_p.UTCTime;break;case 24:a=_p.GeneralizedTime;break;case 25:a=_p.GraphicString;break;case 26:a=_p.VisibleString;break;case 27:a=_p.GeneralString;break;case 28:a=_p.UniversalString;break;case 29:a=_p.CharacterString;break;case 30:a=_p.BmpString;break;case 31:a=_p.DATE;break;case 32:a=_p.TimeOfDay;break;case 33:a=_p.DateTime;break;case 34:a=_p.Duration;break;default:{const e=i.idBlock.isConstructed?new _p.Constructed:new _p.Primitive;e.idBlock=i.idBlock,e.lenBlock=i.lenBlock,e.warnings=i.warnings,i=e}}}else a=i.idBlock.isConstructed?_p.Constructed:_p.Primitive;return i=function(e,t){if(e instanceof t)return e;const n=new t;return n.idBlock=e.idBlock,n.lenBlock=e.lenBlock,n.warnings=e.warnings,n.valueBeforeDecodeView=e.valueBeforeDecodeView,n}(i,a),s=i.fromBER(e,t,i.lenBlock.isIndefiniteForm?n:i.lenBlock.length),i.valueBeforeDecodeView=e.subarray(r,r+i.blockLength),{offset:s,result:i}}function ug(e){if(!e.byteLength){const e=new Rp({},Ep);return e.error="Input buffer has zero length",{offset:-1,result:e}}return cg(np._H.toUint8Array(e).slice(),0,e.byteLength)}function dg(e,t){return e?1:t}Tp=lg,_p.Primitive=Tp,lg.NAME="PRIMITIVE";class hg extends Ep{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const r=np._H.toUint8Array(e);if(!up(this,r,t,n))return-1;if(this.valueBeforeDecodeView=r.subarray(t,t+n),0===this.valueBeforeDecodeView.length)return this.warnings.push("Zero buffer length"),t;let i=t;for(;dg(this.isIndefiniteForm,n)>0;){const e=cg(r,i,n);if(-1===e.offset)return this.error=e.result.error,this.warnings.concat(e.result.warnings),-1;if(i=e.offset,this.blockLength+=e.result.blockLength,n-=e.result.blockLength,this.value.push(e.result),this.isIndefiniteForm&&e.result.constructor.NAME===mp)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===mp?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const n=t||new dp;for(let t=0;t<this.value.length;t++)this.value[t].toBER(e,n);return t?pp:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}hg.NAME="ConstructedValueBlock";class fg extends Rp{constructor(e={}){super(e,hg),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const r=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return-1===r?(this.error=this.valueBlock.error,r):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),r)}onAsciiEncoding(){const e=[];for(const t of this.valueBlock.value)e.push(t.toString("ascii").split("\n").map(e=>`  ${e}`).join("\n"));const t=3===this.idBlock.tagClass?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :\n${e.join("\n")}`:`${t} :`}}Cp=fg,_p.Constructed=Cp,fg.NAME="CONSTRUCTED";class pg extends Ep{fromBER(e,t,n){return t}toBER(e){return pp}}pg.override="EndOfContentValueBlock";class gg extends Rp{constructor(e={}){super(e,pg),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}Np=gg,_p.EndOfContent=Np,gg.NAME=mp;class mg extends Rp{constructor(e={}){super(e,Ep),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const e=new Uint8Array(n);e[0]=5,e[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}Dp=mg,_p.Null=Dp,mg.NAME="NULL";class yg extends(bp(Ep)){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=np._H.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const r=np._H.toUint8Array(e);return up(this,r,t,n)?(this.valueHexView=r.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,sp.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}yg.NAME="BooleanValueBlock";class wg extends Rp{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,yg),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}}Pp=wg,_p.Boolean=Pp,wg.NAME="BOOLEAN";class bg extends(bp(hg)){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let r=0;if(this.isConstructed){if(this.isHexOnly=!1,r=hg.prototype.fromBER.call(this,e,t,n),-1===r)return r;for(let e=0;e<this.value.length;e++){const t=this.value[e].constructor.NAME;if(t===mp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(t!==yp)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,r=super.fromBER(e,t,n),this.blockLength=n;return r}toBER(e,t){return this.isConstructed?hg.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}bg.NAME="OctetStringValueBlock";class vg extends Rp{constructor({idBlock:e={},lenBlock:t={},...n}={}){var r,i;null!==(r=n.isConstructed)&&void 0!==r||(n.isConstructed=!!(null===(i=n.value)||void 0===i?void 0:i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},bg),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,0===n)return 0===this.idBlock.error.length&&(this.blockLength+=this.idBlock.blockLength),0===this.lenBlock.error.length&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const r=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(r.byteLength){const e=cg(r,0,r.byteLength);-1!==e.offset&&e.offset===n&&(this.valueBlock.value=[e.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){return this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length?fg.prototype.onAsciiEncoding.call(this):`${this.constructor.NAME} : ${np.U$.ToHex(this.valueBlock.valueHexView)}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof Lp&&e.push(t.valueBlock.valueHexView);return np._H.concat(e)}}Lp=vg,_p.OctetString=Lp,vg.NAME=yp;class Eg extends(bp(hg)){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let r=-1;if(this.isConstructed){if(r=hg.prototype.fromBER.call(this,e,t,n),-1===r)return r;for(const e of this.value){const t=e.constructor.NAME;if(t===mp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(t!==wp)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const n=e.valueBlock;if(this.unusedBits>0&&n.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=n.unusedBits}return r}const i=np._H.toUint8Array(e);if(!up(this,i,t,n))return-1;const o=i.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const e=o.subarray(1);try{if(e.byteLength){const t=cg(e,0,e.byteLength);-1!==t.offset&&t.offset===n-1&&(this.value=[t.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return hg.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return pp;const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}Eg.NAME="BitStringValueBlock";class Sg extends Rp{constructor({idBlock:e={},lenBlock:t={},...n}={}){var r,i;null!==(r=n.isConstructed)&&void 0!==r||(n.isConstructed=!!(null===(i=n.value)||void 0===i?void 0:i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},Eg),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return fg.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const n of t)e.push(n.toString(2).padStart(8,"0"));const n=e.join("");return`${this.constructor.NAME} : ${n.substring(0,n.length-this.valueBlock.unusedBits)}`}}}function kg(e,t){const n=new Uint8Array([0]),r=new Uint8Array(e),i=new Uint8Array(t);let o=r.slice(0);const s=o.length-1,a=i.slice(0),l=a.length-1;let c=0,u=0;for(let e=l<s?s:l;e>=0;e--,u++)c=1==u<a.length?o[s-u]+a[l-u]+n[0]:o[s-u]+n[0],n[0]=c/10,1==u>=o.length?o=op(new Uint8Array([c%10]),o):o[s-u]=c%10;return n[0]>0&&(o=op(n,o)),o}function _g(e){if(e>=hp.length)for(let t=hp.length;t<=e;t++){const e=new Uint8Array([0]);let n=hp[t-1].slice(0);for(let t=n.length-1;t>=0;t--){const r=new Uint8Array([(n[t]<<1)+e[0]]);e[0]=r[0]/10,n[t]=r[0]%10}e[0]>0&&(n=op(e,n)),hp.push(n)}return hp[e]}function Rg(e,t){let n=0;const r=new Uint8Array(e),i=new Uint8Array(t),o=r.slice(0),s=o.length-1,a=i.slice(0),l=a.length-1;let c,u=0;for(let e=l;e>=0;e--,u++)c=o[s-u]-a[l-u]-n,1==c<0?(n=1,o[s-u]=c+10):(n=0,o[s-u]=c);if(n>0)for(let e=s-l+1;e>=0;e--,u++){if(c=o[s-u]-n,!(c<0)){n=0,o[s-u]=c;break}n=1,o[s-u]=c+10}return o.slice()}Bp=Sg,_p.BitString=Bp,Sg.NAME=wp;class Ig extends(bp(Ep)){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=sp.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),void 0!==e&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(function(e){const t=e<0?-1*e:e;let n=128;for(let r=1;r<8;r++){if(t<=n){if(e<0){const e=ip(n-t,8,r);return new Uint8Array(e)[0]|=128,e}let i=ip(t,8,r),o=new Uint8Array(i);if(128&o[0]){const e=i.slice(0),t=new Uint8Array(e);i=new ArrayBuffer(i.byteLength+1),o=new Uint8Array(i);for(let n=0;n<e.byteLength;n++)o[n+1]=t[n];o[0]=0}return i}n*=Math.pow(2,8)}return new ArrayBuffer(0)}(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,r=0){const i=this.fromBER(e,t,n);if(-1===i)return i;const o=this.valueHexView;return 0===o[0]&&128&o[1]?this.valueHexView=o.subarray(1):0!==r&&o.length<r&&(r-o.length>1&&(r=o.length+1),this.valueHexView=o.subarray(r-o.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case!!(128&t[0]):{const e=new Uint8Array(this.valueHexView.length+1);e[0]=0,e.set(t,1),this.valueHexView=e}break;case 0===t[0]&&!(128&t[1]):this.valueHexView=this.valueHexView.subarray(1)}return this.toBER(e)}fromBER(e,t,n){const r=super.fromBER(e,t,n);return-1===r||this.setValueHex(),r}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=8*this.valueHexView.length-1;let t,n=new Uint8Array(8*this.valueHexView.length/3),r=0;const i=this.valueHexView;let o="",s=!1;for(let s=i.byteLength-1;s>=0;s--){t=i[s];for(let i=0;i<8;i++)1&~t||(r===e?(n=Rg(_g(r),n),o="-"):n=kg(n,_g(r))),r++,t>>=1}for(let e=0;e<n.length;e++)n[e]&&(s=!0),s&&(o+=fp.charAt(n[e]));return!1===s&&(o+=fp.charAt(0)),o}}Op=Ig,Ig.NAME="IntegerValueBlock",Object.defineProperty(Op.prototype,"valueHex",{set:function(e){this.valueHexView=new Uint8Array(e),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});class Ag extends Rp{constructor(e={}){super(e,Ig),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return lp(),BigInt(this.valueBlock.toString())}static fromBigInt(e){lp();const t=BigInt(e),n=new dp,r=t.toString(16).replace(/^-/,""),i=new Uint8Array(np.U$.FromHex(r));if(t<0){const e=new Uint8Array(i.length+(128&i[0]?1:0));e[0]|=128;const r=BigInt(`0x${np.U$.ToHex(e)}`)+t,o=np._H.toUint8Array(np.U$.FromHex(r.toString(16)));o[0]|=128,n.write(o)}else 128&i[0]&&n.write(new Uint8Array([0])),n.write(i);return new Mp({valueHex:n.final()})}convertToDER(){const e=new Mp({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new Mp({valueHex:0===this.valueBlock.valueHexView[0]?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}Mp=Ag,_p.Integer=Mp,Ag.NAME="INTEGER";class xg extends Ag{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}Up=xg,_p.Enumerated=Up,xg.NAME="ENUMERATED";class Tg extends(bp(Ep)){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const r=np._H.toUint8Array(e);if(!up(this,r,t,n))return-1;const i=r.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let e=0;e<n&&(this.valueHexView[e]=127&i[e],this.blockLength++,128&i[e]);e++);const o=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength;e++)o[e]=this.valueHexView[e];return this.valueHexView=o,128&i[this.blockLength-1]?(this.error="End of input reached before message was fully decoded",-1):(0===this.valueHexView[0]&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=rp(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){lp();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let e=0;e<n.length;e++)n[e]=parseInt(t.slice(7*e,7*e+7),2)+(e+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const t=this.valueHexView,n=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength-1;e++)n[e]=128|t[e];return n[this.blockLength-1]=t[this.blockLength-1],n.buffer}const t=ip(this.valueDec,7);if(0===t.byteLength)return this.error="Error during encoding SID value",pp;const n=new Uint8Array(t.byteLength);if(!e){const e=new Uint8Array(t),r=t.byteLength-1;for(let t=0;t<r;t++)n[t]=128|e[t];n[r]=e[r]}return n}toString(){let e="";if(this.isHexOnly)e=np.U$.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}Tg.NAME="sidBlock";class Cg extends Ep{constructor({value:e="",...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let r=t;for(;n>0;){const t=new Tg;if(r=t.fromBER(e,r,n),-1===r)return this.blockLength=0,this.error=t.error,r;0===this.value.length&&(t.isFirstSid=!0),this.blockLength+=t.blockLength,n-=t.blockLength,this.value.push(t)}return r}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const r=this.value[n].toBER(e);if(0===r.byteLength)return this.error=this.value[n].error,pp;t.push(r)}return cp(t)}fromString(e){this.value=[];let t=0,n=0,r="",i=!1;do{if(n=e.indexOf(".",t),r=-1===n?e.substring(t):e.substring(t,n),t=n+1,i){const e=this.value[0];let t=0;switch(e.valueDec){case 0:break;case 1:t=40;break;case 2:t=80;break;default:return void(this.value=[])}const n=parseInt(r,10);if(isNaN(n))return;e.valueDec=n+t,i=!1}else{const e=new Tg;if(r>Number.MAX_SAFE_INTEGER){lp();const t=BigInt(r);e.valueBigInt=t}else if(e.valueDec=parseInt(r,10),isNaN(e.valueDec))return;this.value.length||(e.isFirstSid=!0,i=!0),this.value.push(e)}}while(-1!==n)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let r=this.value[n].toString();0!==n&&(e=`${e}.`),t?(r=`{${r}}`,this.value[n].isFirstSid?e=`2.{${r} - 80}`:e+=r):e+=r}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}Cg.NAME="ObjectIdentifierValueBlock";class Ng extends Rp{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Cg),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Fp=Ng,_p.ObjectIdentifier=Fp,Ng.NAME="OBJECT IDENTIFIER";class Dg extends(bp(vp)){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(0===n)return t;const r=np._H.toUint8Array(e);if(!up(this,r,t,n))return-1;const i=r.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let e=0;e<n&&(this.valueHexView[e]=127&i[e],this.blockLength++,128&i[e]);e++);const o=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength;e++)o[e]=this.valueHexView[e];return this.valueHexView=o,128&i[this.blockLength-1]?(this.error="End of input reached before message was fully decoded",-1):(0===this.valueHexView[0]&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=rp(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const t=this.valueHexView,n=new Uint8Array(this.blockLength);for(let e=0;e<this.blockLength-1;e++)n[e]=128|t[e];return n[this.blockLength-1]=t[this.blockLength-1],n.buffer}const t=ip(this.valueDec,7);if(0===t.byteLength)return this.error="Error during encoding SID value",pp;const n=new Uint8Array(t.byteLength);if(!e){const e=new Uint8Array(t),r=t.byteLength-1;for(let t=0;t<r;t++)n[t]=128|e[t];n[r]=e[r]}return n.buffer}toString(){let e="";return e=this.isHexOnly?np.U$.ToHex(this.valueHexView):this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}Dg.NAME="relativeSidBlock";class Pg extends Ep{constructor({value:e="",...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let r=t;for(;n>0;){const t=new Dg;if(r=t.fromBER(e,r,n),-1===r)return this.blockLength=0,this.error=t.error,r;this.blockLength+=t.blockLength,n-=t.blockLength,this.value.push(t)}return r}toBER(e,t){const n=[];for(let t=0;t<this.value.length;t++){const r=this.value[t].toBER(e);if(0===r.byteLength)return this.error=this.value[t].error,pp;n.push(r)}return cp(n)}fromString(e){this.value=[];let t=0,n=0,r="";do{n=e.indexOf(".",t),r=-1===n?e.substring(t):e.substring(t,n),t=n+1;const i=new Dg;if(i.valueDec=parseInt(r,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(-1!==n);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let r=this.value[n].toString();0!==n&&(e=`${e}.`),t?(r=`{${r}}`,e+=r):e+=r}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}Pg.NAME="RelativeObjectIdentifierValueBlock";class Lg extends Rp{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Pg),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}zp=Lg,_p.RelativeObjectIdentifier=zp,Lg.NAME="RelativeObjectIdentifier";class Bg extends fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}Vp=Bg,_p.Sequence=Vp,Bg.NAME="SEQUENCE";class Og extends fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}}$p=Og,_p.Set=$p,Og.NAME="SET";class Mg extends(bp(Ep)){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=""}toJSON(){return{...super.toJSON(),value:this.value}}}Mg.NAME="StringValueBlock";class Ug extends Mg{}Ug.NAME="SimpleStringValueBlock";class Fg extends Ap{constructor({...e}={}){super(e,Ug)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,np._H.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let r=0;r<t;r++)n[r]=e.charCodeAt(r);this.valueBlock.value=e}}Fg.NAME="SIMPLE STRING";class zg extends Fg{fromBuffer(e){this.valueBlock.valueHexView=np._H.toUint8Array(e);try{this.valueBlock.value=np.U$.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=np.U$.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(np.U$.FromUtf8String(e)),this.valueBlock.value=e}}zg.NAME="Utf8StringValueBlock";class Vg extends zg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}Hp=Vg,_p.Utf8String=Hp,Vg.NAME="UTF8String";class $g extends Fg{fromBuffer(e){this.valueBlock.value=np.U$.ToUtf16String(e),this.valueBlock.valueHexView=np._H.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(np.U$.FromUtf16String(e))}}$g.NAME="BmpStringValueBlock";class Hg extends $g{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}Kp=Hg,_p.BmpString=Kp,Hg.NAME="BMPString";class Kg extends Fg{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let e=0;e<n.length;e+=4)n[e]=n[e+3],n[e+1]=n[e+2],n[e+2]=0,n[e+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(4*t);for(let r=0;r<t;r++){const t=ip(e.charCodeAt(r),8),i=new Uint8Array(t);if(i.length>4)continue;const o=4-i.length;for(let e=i.length-1;e>=0;e--)n[4*r+e+o]=i[e]}this.valueBlock.value=e}}Kg.NAME="UniversalStringValueBlock";class qg extends Kg{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}qp=qg,_p.UniversalString=qp,qg.NAME="UniversalString";class jg extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}jp=jg,_p.NumericString=jp,jg.NAME="NumericString";class Wg extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}Wp=Wg,_p.PrintableString=Wp,Wg.NAME="PrintableString";class Gg extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}Gp=Gg,_p.TeletexString=Gp,Gg.NAME="TeletexString";class Yg extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}Yp=Yg,_p.VideotexString=Yp,Yg.NAME="VideotexString";class Qg extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}Qp=Qg,_p.IA5String=Qp,Qg.NAME="IA5String";class Xg extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}Xp=Xg,_p.GraphicString=Xp,Xg.NAME="GraphicString";class Zg extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}Zp=Zg,_p.VisibleString=Zp,Zg.NAME="VisibleString";class Jg extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}Jp=Jg,_p.GeneralString=Jp,Jg.NAME="GeneralString";class em extends Fg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}eg=em,_p.CharacterString=eg,em.NAME="CharacterString";class tm extends Zg{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let t=0;t<e.length;t++)this.valueBlock.valueHexView[t]=e.charCodeAt(t)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,np._H.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const t=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/gi.exec(e);if(null===t)return void(this.error="Wrong input string for conversion");const n=parseInt(t[1],10);this.year=n>=50?1900+n:2e3+n,this.month=parseInt(t[2],10),this.day=parseInt(t[3],10),this.hour=parseInt(t[4],10),this.minute=parseInt(t[5],10),this.second=parseInt(t[6],10)}toString(e="iso"){if("iso"===e){const e=new Array(7);return e[0]=ap(this.year<2e3?this.year-1900:this.year-2e3,2),e[1]=ap(this.month,2),e[2]=ap(this.day,2),e[3]=ap(this.hour,2),e[4]=ap(this.minute,2),e[5]=ap(this.second,2),e[6]="Z",e.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}tg=tm,_p.UTCTime=tg,tm.NAME="UTCTime";class nm extends tm{constructor(e={}){var t;super(e),null!==(t=this.millisecond)&&void 0!==t||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t,n=!1,r="",i="",o=0,s=0,a=0;if("Z"===e[e.length-1])r=e.substring(0,e.length-1),n=!0;else{const t=new Number(e[e.length-1]);if(isNaN(t.valueOf()))throw new Error("Wrong input string for conversion");r=e}if(n){if(-1!==r.indexOf("+"))throw new Error("Wrong input string for conversion");if(-1!==r.indexOf("-"))throw new Error("Wrong input string for conversion")}else{let e=1,t=r.indexOf("+"),n="";if(-1===t&&(t=r.indexOf("-"),e=-1),-1!==t){if(n=r.substring(t+1),r=r.substring(0,t),2!==n.length&&4!==n.length)throw new Error("Wrong input string for conversion");let i=parseInt(n.substring(0,2),10);if(isNaN(i.valueOf()))throw new Error("Wrong input string for conversion");if(s=e*i,4===n.length){if(i=parseInt(n.substring(2,4),10),isNaN(i.valueOf()))throw new Error("Wrong input string for conversion");a=e*i}}}let l=r.indexOf(".");if(-1===l&&(l=r.indexOf(",")),-1!==l){const e=new Number(`0${r.substring(l)}`);if(isNaN(e.valueOf()))throw new Error("Wrong input string for conversion");o=e.valueOf(),i=r.substring(0,l)}else i=r;switch(!0){case 8===i.length:if(t=/(\d{4})(\d{2})(\d{2})/gi,-1!==l)throw new Error("Wrong input string for conversion");break;case 10===i.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})/gi,-1!==l){let e=60*o;this.minute=Math.floor(e),e=60*(e-this.minute),this.second=Math.floor(e),e=1e3*(e-this.second),this.millisecond=Math.floor(e)}break;case 12===i.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/gi,-1!==l){let e=60*o;this.second=Math.floor(e),e=1e3*(e-this.second),this.millisecond=Math.floor(e)}break;case 14===i.length:if(t=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/gi,-1!==l){const e=1e3*o;this.millisecond=Math.floor(e)}break;default:throw new Error("Wrong input string for conversion")}const c=t.exec(i);if(null===c)throw new Error("Wrong input string for conversion");for(let e=1;e<c.length;e++)switch(e){case 1:this.year=parseInt(c[e],10);break;case 2:this.month=parseInt(c[e],10);break;case 3:this.day=parseInt(c[e],10);break;case 4:this.hour=parseInt(c[e],10)+s;break;case 5:this.minute=parseInt(c[e],10)+a;break;case 6:this.second=parseInt(c[e],10);break;default:throw new Error("Wrong input string for conversion")}if(!1===n){const e=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=e.getUTCFullYear(),this.month=e.getUTCMonth(),this.day=e.getUTCDay(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds(),this.millisecond=e.getUTCMilliseconds()}}toString(e="iso"){if("iso"===e){const e=[];return e.push(ap(this.year,4)),e.push(ap(this.month,2)),e.push(ap(this.day,2)),e.push(ap(this.hour,2)),e.push(ap(this.minute,2)),e.push(ap(this.second,2)),0!==this.millisecond&&(e.push("."),e.push(ap(this.millisecond,3))),e.push("Z"),e.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}ng=nm,_p.GeneralizedTime=ng,nm.NAME="GeneralizedTime";class rm extends Vg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}rg=rm,_p.DATE=rg,rm.NAME="DATE";class im extends Vg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}ig=im,_p.TimeOfDay=ig,im.NAME="TimeOfDay";class om extends Vg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}og=om,_p.DateTime=og,om.NAME="DateTime";class sm extends Vg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}sg=sm,_p.Duration=sg,sm.NAME="Duration";class am extends Vg{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}function lm(e){let t=e.toString(16);t.length%2>0&&(t=`0${t}`);const n=t.length/2,r=new Uint8Array(n);let i=0,o=0;for(;i<n;)r[i]=parseInt(t.slice(o,o+2),16),i+=1,o+=2;return r}function cm(e){const t=[];return e.forEach(function(e){let n=e.toString(16);n.length%2>0&&(n=`0${n}`),t.push(n)}),BigInt("0x"+t.join(""))}ag=am,_p.TIME=ag,am.NAME="TIME";const um=1e4;function dm(e){return hm(e.valueBlock.value[2].getValue())}function hm(e){return new Uint8Array(e,0,e.byteLength)}const fm=8192;class pm{_key;constructor(e){this._key=e}verify(e,t){return async function(e,t,n){const r=await Mf.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Mf.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n instanceof Uint8Array?n:n.subarray())}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new x("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new Bg({value:[new Bg({value:[new Ng({value:"1.2.840.113549.1.1.1"}),new mg]}),new Sg({valueHex:new Bg({value:[Ag.fromBigInt(cm(Hn(e.n,"base64url"))),Ag.fromBigInt(cm(Hn(e.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}(this._key)}get bytes(){return Hf.encode({Type:Vf.RSA,Data:this.marshal()}).subarray()}equals(e){return he(this.bytes,e.bytes)}hash(){const e=xn.digest(this.bytes);return Kd(e)?e.then(({bytes:e})=>e):e.bytes}}class gm{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return mi(16)}sign(e){return async function(e,t){const n=await Mf.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await Mf.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new x("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new pm(this._publicKey)}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new x("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new Bg({value:[new Ag({value:0}),Ag.fromBigInt(cm(Hn(e.n,"base64url"))),Ag.fromBigInt(cm(Hn(e.e,"base64url"))),Ag.fromBigInt(cm(Hn(e.d,"base64url"))),Ag.fromBigInt(cm(Hn(e.p,"base64url"))),Ag.fromBigInt(cm(Hn(e.q,"base64url"))),Ag.fromBigInt(cm(Hn(e.dp,"base64url"))),Ag.fromBigInt(cm(Hn(e.dq,"base64url"))),Ag.fromBigInt(cm(Hn(e.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}(this._key)}get bytes(){return Kf.encode({Type:Vf.RSA,Data:this.marshal()}).subarray()}equals(e){return he(this.bytes,e.bytes)}hash(){const e=xn.digest(this.bytes);return Kd(e)?e.then(({bytes:e})=>e):e.bytes}async id(){return Ir(await this.public.hash(),"base58btc")}async export(e,t="pkcs-8"){if("pkcs-8"===t)return async function(e,t){const n=Mf.get(),r=new Bg({value:[new Ag({value:0}),new Bg({value:[new Ng({value:"1.2.840.113549.1.1.1"}),new mg]}),new vg({valueHex:e.marshal()})]}).toBER(),i=new Uint8Array(r,0,r.byteLength),o=mi(16),s=await rd(Vd,t,o,{c:um,dkLen:32}),a=mi(16),l=await n.subtle.importKey("raw",s,"AES-CBC",!1,["encrypt"]),c=await n.subtle.encrypt({name:"AES-CBC",iv:a},l,i),u=new Bg({value:[new vg({valueHex:o}),new Ag({value:um}),new Ag({value:32}),new Bg({value:[new Ng({value:"1.2.840.113549.2.11"}),new mg]})]}),d=new Bg({value:[new Ng({value:"1.2.840.113549.1.5.13"}),new Bg({value:[new Bg({value:[new Ng({value:"1.2.840.113549.1.5.12"}),u]}),new Bg({value:[new Ng({value:"2.16.840.1.101.3.4.1.42"}),new vg({valueHex:a})]})]})]}),h=new Bg({value:[d,new vg({valueHex:c})]}).toBER();return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...Ir(new Uint8Array(h,0,h.byteLength),"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join("\n")}(this,e);if("libp2p-key"===t)return zf(this.bytes,e);throw new x(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}async function mm(e){const t=function(e){const{result:t}=ug(e),n=t.valueBlock.value;return{n:Ir(lm(n[1].toBigInt()),"base64url"),e:Ir(lm(n[2].toBigInt()),"base64url"),d:Ir(lm(n[3].toBigInt()),"base64url"),p:Ir(lm(n[4].toBigInt()),"base64url"),q:Ir(lm(n[5].toBigInt()),"base64url"),dp:Ir(lm(n[6].toBigInt()),"base64url"),dq:Ir(lm(n[7].toBigInt()),"base64url"),qi:Ir(lm(n[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}(e);if(tp(t)>fm)throw new x("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await Zf(t);return new gm(n.privateKey,n.publicKey)}function ym(e){const t=function(e){const{result:t}=ug(e),n=t.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:Ir(lm(n[0].toBigInt()),"base64url"),e:Ir(lm(n[1].toBigInt()),"base64url")}}(e);if(tp(t)>fm)throw new x("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new pm(t)}async function wm(e){if(tp(e)>fm)throw new x("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await Zf(e);return new gm(t.privateKey,t.publicKey)}async function bm(e){if(e>fm)throw new x("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await Mf.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await Jf(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new gm(t.privateKey,t.publicKey)}const vm=(e,t)=>(e+(e>=0?t:-t)/Am)/t;function Em(e){if(!["compact","recovered","der"].includes(e))throw new Error('Signature format must be "compact", "recovered", or "der"');return e}function Sm(e,t){const n={};for(let r of Object.keys(t))n[r]=void 0===e[r]?t[r]:e[r];return Wd(n.lowS,"lowS"),Wd(n.prehash,"prehash"),void 0!==n.format&&Em(n.format),n}class km extends Error{constructor(e=""){super(e)}}const _m={Err:km,_tlv:{encode:(e,t)=>{const{Err:n}=_m;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(1&t.length)throw new n("tlv.encode: unpadded data");const r=t.length/2,i=Yd(r);if(i.length/2&128)throw new n("tlv.encode: long form length too big");const o=r>127?Yd(i.length/2|128):"";return Yd(e)+o+i+t},decode(e,t){const{Err:n}=_m;let r=0;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(t.length<2||t[r++]!==e)throw new n("tlv.decode: wrong tlv");const i=t[r++];let o=0;if(128&i){const e=127&i;if(!e)throw new n("tlv.decode(long): indefinite length not supported");if(e>4)throw new n("tlv.decode(long): byte length is too big");const s=t.subarray(r,r+e);if(s.length!==e)throw new n("tlv.decode: length bytes not complete");if(0===s[0])throw new n("tlv.decode(long): zero leftmost byte");for(const e of s)o=o<<8|e;if(r+=e,o<128)throw new n("tlv.decode(long): not minimal encoding")}else o=i;const s=t.subarray(r,r+o);if(s.length!==o)throw new n("tlv.decode: wrong value length");return{v:s,l:t.subarray(r+o)}}},_int:{encode(e){const{Err:t}=_m;if(e<Rm)throw new t("integer: negative integers are not allowed");let n=Yd(e);if(8&Number.parseInt(n[0],16)&&(n="00"+n),1&n.length)throw new t("unexpected DER parsing assertion: unpadded hex");return n},decode(e){const{Err:t}=_m;if(128&e[0])throw new t("invalid signature integer: negative");if(0===e[0]&&!(128&e[1]))throw new t("invalid signature integer: unnecessary leading zero");return Xd(e)}},toSig(e){const{Err:t,_int:n,_tlv:r}=_m,i=th("signature",e),{v:o,l:s}=r.decode(48,i);if(s.length)throw new t("invalid signature: left bytes after parsing");const{v:a,l}=r.decode(2,o),{v:c,l:u}=r.decode(2,l);if(u.length)throw new t("invalid signature: left bytes after parsing");return{r:n.decode(a),s:n.decode(c)}},hexFromSig(e){const{_tlv:t,_int:n}=_m,r=t.encode(2,n.encode(e.r))+t.encode(2,n.encode(e.s));return t.encode(48,r)}},Rm=BigInt(0),Im=BigInt(1),Am=BigInt(2),xm=BigInt(3),Tm=BigInt(4);function Cm(e,t){const{BYTES:n}=e;let r;if("bigint"==typeof t)r=t;else{let i=th("private key",t);try{r=e.fromBytes(i)}catch(e){throw new Error(`invalid private key: expected ui8a of size ${n}, got ${typeof t}`)}}if(!e.isValidNot0(r))throw new Error("invalid private key: out of range [1..N-1]");return r}function Nm(e){return Uint8Array.of(e?2:3)}function Dm(e,t){return{secretKey:t.BYTES,publicKey:1+e.BYTES,publicKeyUncompressed:1+2*e.BYTES,publicKeyHasPrefix:!0,signature:2*t.BYTES}}function Pm(e,t,n={}){Qr(t),ah(n,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const r=n.randomBytes||gi,i=n.hmac||((e,...n)=>ed(t,e,hi(...n))),{Fp:o,Fn:s}=e,{ORDER:a,BITS:l}=s,{keygen:c,getPublicKey:u,getSharedSecret:d,utils:h,lengths:f}=function(e,t={}){const{Fn:n}=e,r=t.randomBytes||gi,i=Object.assign(Dm(e.Fp,n),{seed:Lh(n.ORDER)});function o(e){try{return!!Cm(n,e)}catch(e){return!1}}function s(e=r(i.seed)){return function(e,t,n=!1){const r=e.length,i=Ph(t),o=Lh(t);if(r<16||r<o||r>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+r);const s=vh(n?Zd(e):Xd(e),t-dh)+dh;return n?eh(s,i):Jd(s,i)}(Gd(e,i.seed,"seed"),n.ORDER)}function a(t,r=!0){return e.BASE.multiply(Cm(n,t)).toBytes(r)}function l(t){if("bigint"==typeof t)return!1;if(t instanceof e)return!0;const{secretKey:r,publicKey:o,publicKeyUncompressed:s}=i;if(n.allowedLengths||r===o)return;const a=th("key",t).length;return a===o||a===s}const c={isValidSecretKey:o,isValidPublicKey:function(t,n){const{publicKey:r,publicKeyUncompressed:o}=i;try{const i=t.length;return!(!0===n&&i!==r||!1===n&&i!==o||!e.fromBytes(t))}catch(e){return!1}},randomSecretKey:s,isValidPrivateKey:o,randomPrivateKey:s,normPrivateKeyToScalar:e=>Cm(n,e),precompute:(t=8,n=e.BASE)=>n.precompute(t,!1)};return Object.freeze({getPublicKey:a,getSharedSecret:function(t,r,i=!0){if(!0===l(t))throw new Error("first arg must be private key");if(!1===l(r))throw new Error("second arg must be public key");const o=Cm(n,t);return e.fromHex(r).multiply(o).toBytes(i)},keygen:function(e){const t=s(e);return{secretKey:t,publicKey:a(t)}},Point:e,utils:c,lengths:i})}(e,n),p={prehash:!1,lowS:"boolean"==typeof n.lowS&&n.lowS,format:void 0,extraEntropy:!1},g="compact";function m(e){return e>a>>Im}function y(e,t){if(!s.isValidNot0(t))throw new Error(`invalid signature ${e}: out of range 1..Point.Fn.ORDER`);return t}class w{constructor(e,t,n){this.r=y("r",e),this.s=y("s",t),null!=n&&(this.recovery=n),Object.freeze(this)}static fromBytes(e,t=g){let n;if(function(e,t){Em(t);const n=f.signature;Gd(e,"compact"===t?n:"recovered"===t?n+1:void 0,`${t} signature`)}(e,t),"der"===t){const{r:t,s:n}=_m.toSig(Gd(e));return new w(t,n)}"recovered"===t&&(n=e[0],t="compact",e=e.subarray(1));const r=s.BYTES,i=e.subarray(0,r),o=e.subarray(r,2*r);return new w(s.fromBytes(i),s.fromBytes(o),n)}static fromHex(e,t){return this.fromBytes(si(e),t)}addRecoveryBit(e){return new w(this.r,this.s,e)}recoverPublicKey(t){const n=o.ORDER,{r,s:i,recovery:l}=this;if(null==l||![0,1,2,3].includes(l))throw new Error("recovery id invalid");if(a*Am<n&&l>1)throw new Error("recovery id is ambiguous for h>1 curve");const c=2===l||3===l?r+a:r;if(!o.isValid(c))throw new Error("recovery id 2 or 3 invalid");const u=o.toBytes(c),d=e.fromBytes(hi(Nm(!(1&l)),u)),h=s.inv(c),f=v(th("msgHash",t)),p=s.create(-f*h),g=s.create(i*h),m=e.BASE.multiplyUnsafe(p).add(d.multiplyUnsafe(g));if(m.is0())throw new Error("point at infinify");return m.assertValidity(),m}hasHighS(){return m(this.s)}toBytes(e=g){if(Em(e),"der"===e)return si(_m.hexFromSig(this));const t=s.toBytes(this.r),n=s.toBytes(this.s);if("recovered"===e){if(null==this.recovery)throw new Error("recovery bit must be present");return hi(Uint8Array.of(this.recovery),t,n)}return hi(t,n)}toHex(e){return ii(this.toBytes(e))}assertValidity(){}static fromCompact(e){return w.fromBytes(th("sig",e),"compact")}static fromDER(e){return w.fromBytes(th("sig",e),"der")}normalizeS(){return this.hasHighS()?new w(this.r,s.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return ii(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return ii(this.toBytes("compact"))}}const b=n.bits2int||function(e){if(e.length>8192)throw new Error("input is too large");const t=Xd(e),n=8*e.length-l;return n>0?t>>BigInt(n):t},v=n.bits2int_modN||function(e){return s.create(b(e))},E=sh(l);function S(e){return ih("num < 2^"+l,e,Rm,E),s.toBytes(e)}function k(e,n){return Gd(e,void 0,"message"),n?Gd(t(e),void 0,"prehashed message"):e}return Object.freeze({keygen:c,getPublicKey:u,getSharedSecret:d,utils:h,lengths:f,Point:e,sign:function(n,o,a={}){n=th("message",n);const{seed:l,k2sig:c}=function(t,n,i){if(["recovered","canonical"].some(e=>e in i))throw new Error("sign() legacy options not supported");const{lowS:o,prehash:a,extraEntropy:l}=Sm(i,p);t=k(t,a);const c=v(t),u=Cm(s,n),d=[S(u),S(c)];if(null!=l&&!1!==l){const e=!0===l?r(f.secretKey):l;d.push(th("extraEntropy",e))}const h=hi(...d),g=c;return{seed:h,k2sig:function(t){const n=b(t);if(!s.isValidNot0(n))return;const r=s.inv(n),i=e.BASE.multiply(n).toAffine(),a=s.create(i.x);if(a===Rm)return;const l=s.create(r*s.create(g+a*u));if(l===Rm)return;let c=(i.x===a?0:2)|Number(i.y&Im),d=l;return o&&m(l)&&(d=s.neg(l),c^=1),new w(a,d,c)}}}(n,o,a),u=function(e,t,n){if("number"!=typeof e||e<2)throw new Error("hashLen must be a number");if("number"!=typeof t||t<2)throw new Error("qByteLen must be a number");if("function"!=typeof n)throw new Error("hmacFn must be a function");const r=e=>new Uint8Array(e),i=e=>Uint8Array.of(e);let o=r(e),s=r(e),a=0;const l=()=>{o.fill(1),s.fill(0),a=0},c=(...e)=>n(s,o,...e),u=(e=r(0))=>{s=c(i(0),e),o=c(),0!==e.length&&(s=c(i(1),e),o=c())},d=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let e=0;const n=[];for(;e<t;){o=c();const t=o.slice();n.push(t),e+=o.length}return hi(...n)};return(e,t)=>{let n;for(l(),u(e);!(n=t(d()));)u();return l(),n}}(t.outputLen,s.BYTES,i);return u(l,c)},verify:function(t,n,r,i={}){const{lowS:o,prehash:a,format:l}=Sm(i,p);if(r=th("publicKey",r),n=k(th("message",n),a),"strict"in i)throw new Error("options.strict was renamed to lowS");const c=void 0===l?function(e){let t;const n="string"==typeof e||Wr(e),r=!n&&null!==e&&"object"==typeof e&&"bigint"==typeof e.r&&"bigint"==typeof e.s;if(!n&&!r)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(r)t=new w(e.r,e.s);else if(n){try{t=w.fromBytes(th("sig",e),"der")}catch(e){if(!(e instanceof _m.Err))throw e}if(!t)try{t=w.fromBytes(th("sig",e),"compact")}catch(e){return!1}}return t||!1}(t):w.fromBytes(th("sig",t),l);if(!1===c)return!1;try{const t=e.fromBytes(r);if(o&&c.hasHighS())return!1;const{r:i,s:a}=c,l=v(n),u=s.inv(a),d=s.create(l*u),h=s.create(i*u),f=e.BASE.multiplyUnsafe(d).add(t.multiplyUnsafe(h));return!f.is0()&&s.create(f.x)===i}catch(e){return!1}},recoverPublicKey:function(e,t,n={}){const{prehash:r}=Sm(n,p);return t=k(t,r),w.fromBytes(e,"recovered").recoverPublicKey(t).toBytes()},Signature:w,hash:t})}function Lm(e){const{CURVE:t,curveOpts:n,hash:r,ecdsaOpts:i}=function(e){const{CURVE:t,curveOpts:n}=function(e){const t={a:e.a,b:e.b,p:e.Fp.ORDER,n:e.n,h:e.h,Gx:e.Gx,Gy:e.Gy},n=e.Fp;let r=e.allowedPrivateKeyLengths?Array.from(new Set(e.allowedPrivateKeyLengths.map(e=>Math.ceil(e/2)))):void 0;return{CURVE:t,curveOpts:{Fp:n,Fn:Dh(t.n,{BITS:e.nBitLength,allowedLengths:r,modFromBytes:e.wrapPrivateKey}),allowInfinityPoint:e.allowInfinityPoint,endo:e.endo,isTorsionFree:e.isTorsionFree,clearCofactor:e.clearCofactor,fromBytes:e.fromBytes,toBytes:e.toBytes}}}(e),r={hmac:e.hmac,randomBytes:e.randomBytes,lowS:e.lowS,bits2int:e.bits2int,bits2int_modN:e.bits2int_modN};return{CURVE:t,curveOpts:n,hash:e.hash,ecdsaOpts:r}}(e);return function(e,t){const n=t.Point;return Object.assign({},t,{ProjectivePoint:n,CURVE:Object.assign({},e,Nh(n.Fn.ORDER,n.Fn.BITS))})}(e,Pm(function(e,t={}){const n=Yh("weierstrass",e,t),{Fp:r,Fn:i}=n;let o=n.CURVE;const{h:s,n:a}=o;ah(t,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=t;if(l&&(!r.is0(o.a)||"bigint"!=typeof l.beta||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const c=Dm(r,i);function u(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}const d=t.toBytes||function(e,t,n){const{x:i,y:o}=t.toAffine(),s=r.toBytes(i);return Wd(n,"isCompressed"),n?(u(),hi(Nm(!r.isOdd(o)),s)):hi(Uint8Array.of(4),s,r.toBytes(o))},h=t.fromBytes||function(e){Gd(e,void 0,"Point");const{publicKey:t,publicKeyUncompressed:n}=c,i=e.length,o=e[0],s=e.subarray(1);if(i!==t||2!==o&&3!==o){if(i===n&&4===o){const e=r.BYTES,t=r.fromBytes(s.subarray(0,e)),n=r.fromBytes(s.subarray(e,2*e));if(!p(t,n))throw new Error("bad point: is not on curve");return{x:t,y:n}}throw new Error(`bad point: got length ${i}, expected compressed=${t} or uncompressed=${n}`)}{const e=r.fromBytes(s);if(!r.isValid(e))throw new Error("bad point: is not on curve, wrong x");const t=f(e);let n;try{n=r.sqrt(t)}catch(e){const t=e instanceof Error?": "+e.message:"";throw new Error("bad point: is not on curve, sqrt error"+t)}return u(),!(1&~o)!==r.isOdd(n)&&(n=r.neg(n)),{x:e,y:n}}};function f(e){const t=r.sqr(e),n=r.mul(t,e);return r.add(r.add(n,r.mul(e,o.a)),o.b)}function p(e,t){const n=r.sqr(t),i=f(e);return r.eql(n,i)}if(!p(o.Gx,o.Gy))throw new Error("bad curve params: generator point");const g=r.mul(r.pow(o.a,xm),Tm),m=r.mul(r.sqr(o.b),BigInt(27));if(r.is0(r.add(g,m)))throw new Error("bad curve params: a or b");function y(e,t,n=!1){if(!r.isValid(t)||n&&r.is0(t))throw new Error(`bad point coordinate ${e}`);return t}function w(e){if(!(e instanceof k))throw new Error("ProjectivePoint expected")}function b(e){if(!l||!l.basises)throw new Error("no endo");return function(e,t,n){const[[r,i],[o,s]]=t,a=vm(s*e,n),l=vm(-i*e,n);let c=e-a*r-l*o,u=-a*i-l*s;const d=c<Rm,h=u<Rm;d&&(c=-c),h&&(u=-u);const f=sh(Math.ceil(oh(n)/2))+Im;if(c<Rm||c>=f||u<Rm||u>=f)throw new Error("splitScalar (endomorphism): failed, k="+e);return{k1neg:d,k1:c,k2neg:h,k2:u}}(e,l.basises,i.ORDER)}const v=ch((e,t)=>{const{X:n,Y:i,Z:o}=e;if(r.eql(o,r.ONE))return{x:n,y:i};const s=e.is0();null==t&&(t=s?r.ONE:r.inv(o));const a=r.mul(n,t),l=r.mul(i,t),c=r.mul(o,t);if(s)return{x:r.ZERO,y:r.ZERO};if(!r.eql(c,r.ONE))throw new Error("invZ was invalid");return{x:a,y:l}}),E=ch(e=>{if(e.is0()){if(t.allowInfinityPoint&&!r.is0(e.Y))return;throw new Error("bad point: ZERO")}const{x:n,y:i}=e.toAffine();if(!r.isValid(n)||!r.isValid(i))throw new Error("bad point: x or y not field elements");if(!p(n,i))throw new Error("bad point: equation left != right");if(!e.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function S(e,t,n,i,o){return n=new k(r.mul(n.X,e),n.Y,n.Z),t=Mh(i,t),n=Mh(o,n),t.add(n)}class k{constructor(e,t,n){this.X=y("x",e),this.Y=y("y",t,!0),this.Z=y("z",n),Object.freeze(this)}static CURVE(){return o}static fromAffine(e){const{x:t,y:n}=e||{};if(!e||!r.isValid(t)||!r.isValid(n))throw new Error("invalid affine point");if(e instanceof k)throw new Error("projective point not allowed");return r.is0(t)&&r.is0(n)?k.ZERO:new k(t,n,r.ONE)}static fromBytes(e){const t=k.fromAffine(h(Gd(e,void 0,"point")));return t.assertValidity(),t}static fromHex(e){return k.fromBytes(th("pointHex",e))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(e=8,t=!0){return R.createCache(this,e),t||this.multiply(xm),this}assertValidity(){E(this)}hasEvenY(){const{y:e}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(e)}equals(e){w(e);const{X:t,Y:n,Z:i}=this,{X:o,Y:s,Z:a}=e,l=r.eql(r.mul(t,a),r.mul(o,i)),c=r.eql(r.mul(n,a),r.mul(s,i));return l&&c}negate(){return new k(this.X,r.neg(this.Y),this.Z)}double(){const{a:e,b:t}=o,n=r.mul(t,xm),{X:i,Y:s,Z:a}=this;let l=r.ZERO,c=r.ZERO,u=r.ZERO,d=r.mul(i,i),h=r.mul(s,s),f=r.mul(a,a),p=r.mul(i,s);return p=r.add(p,p),u=r.mul(i,a),u=r.add(u,u),l=r.mul(e,u),c=r.mul(n,f),c=r.add(l,c),l=r.sub(h,c),c=r.add(h,c),c=r.mul(l,c),l=r.mul(p,l),u=r.mul(n,u),f=r.mul(e,f),p=r.sub(d,f),p=r.mul(e,p),p=r.add(p,u),u=r.add(d,d),d=r.add(u,d),d=r.add(d,f),d=r.mul(d,p),c=r.add(c,d),f=r.mul(s,a),f=r.add(f,f),d=r.mul(f,p),l=r.sub(l,d),u=r.mul(f,h),u=r.add(u,u),u=r.add(u,u),new k(l,c,u)}add(e){w(e);const{X:t,Y:n,Z:i}=this,{X:s,Y:a,Z:l}=e;let c=r.ZERO,u=r.ZERO,d=r.ZERO;const h=o.a,f=r.mul(o.b,xm);let p=r.mul(t,s),g=r.mul(n,a),m=r.mul(i,l),y=r.add(t,n),b=r.add(s,a);y=r.mul(y,b),b=r.add(p,g),y=r.sub(y,b),b=r.add(t,i);let v=r.add(s,l);return b=r.mul(b,v),v=r.add(p,m),b=r.sub(b,v),v=r.add(n,i),c=r.add(a,l),v=r.mul(v,c),c=r.add(g,m),v=r.sub(v,c),d=r.mul(h,b),c=r.mul(f,m),d=r.add(c,d),c=r.sub(g,d),d=r.add(g,d),u=r.mul(c,d),g=r.add(p,p),g=r.add(g,p),m=r.mul(h,m),b=r.mul(f,b),g=r.add(g,m),m=r.sub(p,m),m=r.mul(h,m),b=r.add(b,m),p=r.mul(g,b),u=r.add(u,p),p=r.mul(v,b),c=r.mul(y,c),c=r.sub(c,p),p=r.mul(y,g),d=r.mul(v,d),d=r.add(d,p),new k(c,u,d)}subtract(e){return this.add(e.negate())}is0(){return this.equals(k.ZERO)}multiply(e){const{endo:n}=t;if(!i.isValidNot0(e))throw new Error("invalid scalar: out of range");let r,o;const s=e=>R.cached(this,e,e=>Uh(k,e));if(n){const{k1neg:t,k1:i,k2neg:a,k2:l}=b(e),{p:c,f:u}=s(i),{p:d,f:h}=s(l);o=u.add(h),r=S(n.beta,c,d,t,a)}else{const{p:t,f:n}=s(e);r=t,o=n}return Uh(k,[r,o])[0]}multiplyUnsafe(e){const{endo:n}=t,r=this;if(!i.isValid(e))throw new Error("invalid scalar: out of range");if(e===Rm||r.is0())return k.ZERO;if(e===Im)return r;if(R.hasCache(this))return this.multiply(e);if(n){const{k1neg:t,k1:i,k2neg:o,k2:s}=b(e),{p1:a,p2:l}=function(e,t,n,r){let i=t,o=e.ZERO,s=e.ZERO;for(;n>Bh||r>Bh;)n&Oh&&(o=o.add(i)),r&Oh&&(s=s.add(i)),i=i.double(),n>>=Oh,r>>=Oh;return{p1:o,p2:s}}(k,r,i,s);return S(n.beta,a,l,t,o)}return R.unsafe(r,e)}multiplyAndAddUnsafe(e,t,n){const r=this.multiplyUnsafe(t).add(e.multiplyUnsafe(n));return r.is0()?void 0:r}toAffine(e){return v(this,e)}isTorsionFree(){const{isTorsionFree:e}=t;return s===Im||(e?e(k,this):R.unsafe(this,a).is0())}clearCofactor(){const{clearCofactor:e}=t;return s===Im?this:e?e(k,this):this.multiplyUnsafe(s)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}toBytes(e=!0){return Wd(e,"isCompressed"),this.assertValidity(),d(k,this,e)}toHex(e=!0){return ii(this.toBytes(e))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(e=!0){return this.toBytes(e)}_setWindowSize(e){this.precompute(e)}static normalizeZ(e){return Uh(k,e)}static msm(e,t){return Wh(k,i,e,t)}static fromPrivateKey(e){return k.BASE.multiply(Cm(i,e))}}k.BASE=new k(o.Gx,o.Gy,r.ONE),k.ZERO=new k(r.ZERO,r.ONE,r.ZERO),k.Fp=r,k.Fn=i;const _=i.BITS,R=new jh(k,t.endo?Math.ceil(_/2):_);return k.BASE.precompute(8),k}(t,n),r,i))}const Bm={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Om={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Mm=BigInt(2),Um=Dh(Bm.p,{sqrt:function(e){const t=Bm.p,n=BigInt(3),r=BigInt(6),i=BigInt(11),o=BigInt(22),s=BigInt(23),a=BigInt(44),l=BigInt(88),c=e*e*e%t,u=c*c*e%t,d=Eh(u,n,t)*u%t,h=Eh(d,n,t)*u%t,f=Eh(h,Mm,t)*c%t,p=Eh(f,i,t)*f%t,g=Eh(p,o,t)*p%t,m=Eh(g,a,t)*g%t,y=Eh(m,l,t)*m%t,w=Eh(y,a,t)*g%t,b=Eh(w,n,t)*u%t,v=Eh(b,s,t)*p%t,E=Eh(v,r,t)*c%t,S=Eh(E,Mm,t);if(!Um.eql(Um.sqr(S),e))throw new Error("Cannot find square root");return S}}),Fm=function(e,t){const n=t=>Lm({...e,hash:t});return{...n(t),create:n}}({...Bm,Fp:Um,lowS:!0,endo:Om},Ud);function zm(e){try{Fm.ProjectivePoint.fromHex(e)}catch(e){throw new x(String(e),"ERR_INVALID_PUBLIC_KEY")}}class Vm{_key;constructor(e){zm(e),this._key=e}verify(e,t){return function(e,t,n){const r=xn.digest(n instanceof Uint8Array?n:n.subarray());if(Kd(r))return r.then(({digest:n})=>Fm.verify(t,n,e)).catch(e=>{throw new x(String(e),"ERR_INVALID_INPUT")});try{return Fm.verify(t,r.digest,e)}catch(e){throw new x(String(e),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Fm.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return Hf.encode({Type:Vf.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return he(this.bytes,e.bytes)}async hash(){const e=xn.digest(this.bytes);let t;return Kd(e)?({bytes:t}=await e):t=e.bytes,t}}class $m{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??function(e){try{return Fm.getPublicKey(e,!0)}catch(e){throw new x(String(e),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Fm.getPublicKey(e,!0)}catch(e){throw new x(String(e),"ERR_INVALID_PRIVATE_KEY")}}(this._key),zm(this._publicKey)}sign(e){return function(e,t){const n=xn.digest(t instanceof Uint8Array?t:t.subarray());if(Kd(n))return n.then(({digest:t})=>Fm.sign(t,e).toDERRawBytes()).catch(e=>{throw new x(String(e),"ERR_INVALID_INPUT")});try{return Fm.sign(n.digest,e).toDERRawBytes()}catch(e){throw new x(String(e),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new Vm(this._publicKey)}marshal(){return this._key}get bytes(){return Kf.encode({Type:Vf.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return he(this.bytes,e.bytes)}hash(){const e=xn.digest(this.bytes);return Kd(e)?e.then(({bytes:e})=>e):e.bytes}async id(){return Ir(await this.public.hash(),"base58btc")}async export(e,t="libp2p-key"){if("libp2p-key"===t)return zf(this.bytes,e);throw new x(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function Hm(e){return new $m(e)}function Km(e){return new Vm(e)}async function qm(){const e=Fm.utils.randomPrivateKey();return new $m(e)}const jm={rsa:w,ed25519:y,secp256k1:b};function Wm(e){const t=Object.keys(jm).join(" / ");return new x(`invalid or unsupported key type ${e}. Must be ${t}`,"ERR_UNSUPPORTED_KEY_TYPE")}function Gm(e){if("rsa"===(e=e.toLowerCase())||"ed25519"===e||"secp256k1"===e)return jm[e];throw Wm(e)}async function Ym(e,t){return Gm(e).generateKeyPair(t??2048)}function Qm(e){const t=Hf.decode(e),n=t.Data??new Uint8Array;switch(t.Type){case Vf.RSA:return jm.rsa.unmarshalRsaPublicKey(n);case Vf.Ed25519:return jm.ed25519.unmarshalEd25519PublicKey(n);case Vf.Secp256k1:return jm.secp256k1.unmarshalSecp256k1PublicKey(n);default:throw Wm(t.Type??"unknown")}}function Xm(e,t){return Gm(t=(t??"rsa").toLowerCase()),e.bytes}async function Zm(e){const t=Kf.decode(e),n=t.Data??new Uint8Array;switch(t.Type){case Vf.RSA:return jm.rsa.unmarshalRsaPrivateKey(n);case Vf.Ed25519:return jm.ed25519.unmarshalEd25519PrivateKey(n);case Vf.Secp256k1:return jm.secp256k1.unmarshalSecp256k1PrivateKey(n);default:throw Wm(t.Type??"RSA")}}async function Jm(e,t){try{const n=await async function(e,t){const n=Ut.decode(e);return Ff().decrypt(n,t)}(e,t);return await Zm(n)}catch(e){}if(!e.includes("BEGIN"))throw new x("Encrypted key was not a libp2p-key or a PEM file","ERR_INVALID_IMPORT_FORMAT");return async function(e,t){const n=Mf.get();let r;if(e.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=Hn(e.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=ug(i),{iv:s,salt:a,iterations:l,keySize:c,cipherText:u}=function(e){const t=e.valueBlock.value[0];if("OBJECT IDENTIFIER : 1.2.840.113549.1.5.13"!==t.valueBlock.value[0].toString())throw new x("Only pkcs5PBES2 encrypted private keys are supported","ERR_INVALID_PARAMS");const n=t.valueBlock.value[1].valueBlock.value[0];if("OBJECT IDENTIFIER : 1.2.840.113549.1.5.12"!==n.valueBlock.value[0].toString())throw new x("Only pkcs5PBKDF2 key derivation functions are supported","ERR_INVALID_PARAMS");const r=n.valueBlock.value[1],i=hm(r.valueBlock.value[0].getValue());let o=um,s=32;if(3===r.valueBlock.value.length)o=Number(r.valueBlock.value[1].toBigInt()),s=Number(r.valueBlock.value[2].toBigInt());else if(2===r.valueBlock.value.length)throw new x("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key","ERR_INVALID_PARAMS");const a=t.valueBlock.value[1].valueBlock.value[1],l=a.valueBlock.value[0].toString();if("OBJECT IDENTIFIER : 1.2.840.113549.3.7"===l);else if("OBJECT IDENTIFIER : 1.3.14.3.2.7"===l);else if("OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"===l);else if("OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"===l);else if("OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42"!==l)throw new x("Only AES-CBC encryption schemes are supported","ERR_INVALID_PARAMS");const c=hm(a.valueBlock.value[1].getValue());return{cipherText:hm(e.valueBlock.value[1].getValue()),salt:i,iterations:o,keySize:s,iv:c}}(o),d=await rd(Vd,t,a,{c:l,dkLen:c}),h=await n.subtle.importKey("raw",d,"AES-CBC",!1,["decrypt"]),f=hm(await n.subtle.decrypt({name:"AES-CBC",iv:s},h,u)),{result:p}=ug(f);r=dm(p)}else{if(!e.includes("-----BEGIN PRIVATE KEY-----"))throw new x("Could not parse private key from PEM data","ERR_INVALID_PARAMETERS");{const t=Hn(e.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:n}=ug(t);r=dm(n)}}return mm(r)}(e,t)}const ey=Symbol.for("@libp2p/service-capabilities"),ty=Symbol.for("@libp2p/service-dependencies"),ny=n(864);var ry,iy=n(424);!function(e){e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"}(ry||(ry={}));const oy="/info/",sy=new WeakMap,ay={dek:{keyLength:64,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function ly(e){return null!=e&&"string"==typeof e&&e===iy(e.trim())&&e.length>0}async function cy(){const e=800*Math.random()+200;await new Promise(t=>setTimeout(t,e))}function uy(e){return new ba("/pkcs8/"+e)}function dy(e){return new ba(oy+e)}class hy{components;init;log;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=ny(ay,t),null!=this.init.pass&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(null!=this.init.dek?.keyLength&&this.init.dek.keyLength<14)throw new Error("dek.keyLength must be least 14 bytes");if(null!=this.init.dek?.salt?.length&&this.init.dek.salt.length<16)throw new Error("dek.saltLength must be least 16 bytes");if(null!=this.init.dek?.iterationCount&&this.init.dek.iterationCount<1e3)throw new Error("dek.iterationCount must be least 1000");const n=null!=this.init.pass&&null!=this.init.dek?.salt?Hd(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";sy.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[ey]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},ay),t=3*Math.ceil(16/3);return e.dek.salt=Ir(mi(t),"base64"),e}static get options(){return ay}async createKey(e,t,n=2048){if(!ly(e)||"self"===e)throw await cy(),new x("Invalid key name",ry.ERR_INVALID_KEY_NAME);if("string"!=typeof t)throw await cy(),new x("Invalid key type",ry.ERR_INVALID_KEY_TYPE);const r=uy(e);if(await this.components.datastore.has(r))throw await cy(),new x("Key name already exists",ry.ERR_KEY_ALREADY_EXISTS);if("rsa"===t.toLowerCase()&&(!Number.isSafeInteger(n)||n<2048))throw await cy(),new x("Invalid RSA key size",ry.ERR_INVALID_KEY_SIZE);let i;try{const o=await Ym(t,n),s=await o.id(),a=sy.get(this);if(null==a)throw new x("dek missing",ry.ERR_INVALID_PARAMETERS);const l=a.dek,c=await o.export(l);i={name:e,id:s};const u=this.components.datastore.batch();u.put(r,Hn(c)),u.put(dy(e),Hn(JSON.stringify(i))),await u.commit()}catch(e){throw await cy(),e}return i}async listKeys(){const e={prefix:oy},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(Ir(n.value)));return t}async findKeyById(e){try{const t=(await this.listKeys()).find(t=>t.id===e);if(null==t)throw new x(`Key with id '${e}' does not exist.`,ry.ERR_KEY_NOT_FOUND);return t}catch(e){throw await cy(),e}}async findKeyByName(e){if(!ly(e))throw await cy(),new x(`Invalid key name '${e}'`,ry.ERR_INVALID_KEY_NAME);const t=dy(e);try{const e=await this.components.datastore.get(t);return JSON.parse(Ir(e))}catch(t){throw await cy(),this.log.error(t),new x(`Key '${e}' does not exist.`,ry.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!ly(e)||"self"===e)throw await cy(),new x(`Invalid key name '${e}'`,ry.ERR_INVALID_KEY_NAME);const t=uy(e),n=await this.findKeyByName(e),r=this.components.datastore.batch();return r.delete(t),r.delete(dy(e)),await r.commit(),n}async renameKey(e,t){if(!ly(e)||"self"===e)throw await cy(),new x(`Invalid old key name '${e}'`,ry.ERR_OLD_KEY_NAME_INVALID);if(!ly(t)||"self"===t)throw await cy(),new x(`Invalid new key name '${t}'`,ry.ERR_NEW_KEY_NAME_INVALID);const n=uy(e),r=uy(t),i=dy(e),o=dy(t);if(await this.components.datastore.has(r))throw await cy(),new x(`Key '${t}' already exists`,ry.ERR_KEY_ALREADY_EXISTS);try{const e=await this.components.datastore.get(n),s=await this.components.datastore.get(i),a=JSON.parse(Ir(s));a.name=t;const l=this.components.datastore.batch();return l.put(r,e),l.put(o,Hn(JSON.stringify(a))),l.delete(n),l.delete(i),await l.commit(),a}catch(e){throw await cy(),e}}async exportKey(e,t){if(!ly(e))throw await cy(),new x(`Invalid key name '${e}'`,ry.ERR_INVALID_KEY_NAME);if(null==t)throw await cy(),new x("Password is required",ry.ERR_PASSWORD_REQUIRED);const n=uy(e);try{const e=Ir(await this.components.datastore.get(n)),r=sy.get(this);if(null==r)throw new x("dek missing",ry.ERR_INVALID_PARAMETERS);const i=r.dek,o=await Jm(e,i);return await o.export(t)}catch(e){throw await cy(),e}}async exportPeerId(e){const t="temporary-password",n=await this.exportKey(e,t),r=await Jm(n,t);return Mr(r.public.bytes,r.bytes)}async importKey(e,t,n){if(!ly(e)||"self"===e)throw await cy(),new x(`Invalid key name '${e}'`,ry.ERR_INVALID_KEY_NAME);if(null==t)throw await cy(),new x("PEM encoded key is required",ry.ERR_PEM_REQUIRED);const r=uy(e);if(await this.components.datastore.has(r))throw await cy(),new x(`Key '${e}' already exists`,ry.ERR_KEY_ALREADY_EXISTS);let i,o;try{i=await Jm(t,n)}catch(e){throw await cy(),new x("Cannot read the key, most likely the password is wrong",ry.ERR_CANNOT_READ_KEY)}try{o=await i.id();const e=sy.get(this);if(null==e)throw new x("dek missing",ry.ERR_INVALID_PARAMETERS);const n=e.dek;t=await i.export(n)}catch(e){throw await cy(),e}const s={name:e,id:o},a=this.components.datastore.batch();return a.put(r,Hn(t)),a.put(dy(e),Hn(JSON.stringify(s))),await a.commit(),s}async importPeer(e,t){try{if(!ly(e))throw new x(`Invalid key name '${e}'`,ry.ERR_INVALID_KEY_NAME);if(null==t)throw new x("PeerId is required",ry.ERR_MISSING_PRIVATE_KEY);if(null==t.privateKey)throw new x("PeerId.privKey is required",ry.ERR_MISSING_PRIVATE_KEY);const n=await Zm(t.privateKey),r=uy(e);if(await this.components.datastore.has(r))throw await cy(),new x(`Key '${e}' already exists`,ry.ERR_KEY_ALREADY_EXISTS);const i=sy.get(this);if(null==i)throw new x("dek missing",ry.ERR_INVALID_PARAMETERS);const o=i.dek,s=await n.export(o),a={name:e,id:t.toString()},l=this.components.datastore.batch();return l.put(r,Hn(s)),l.put(dy(e),Hn(JSON.stringify(a))),await l.commit(),a}catch(e){throw await cy(),e}}async getPrivateKey(e){if(!ly(e))throw await cy(),new x(`Invalid key name '${e}'`,ry.ERR_INVALID_KEY_NAME);try{const t=uy(e);return Ir(await this.components.datastore.get(t))}catch(t){throw await cy(),this.log.error(t),new x(`Key '${e}' does not exist.`,ry.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if("string"!=typeof e)throw await cy(),new x(`Invalid old pass type '${typeof e}'`,ry.ERR_INVALID_OLD_PASS_TYPE);if("string"!=typeof t)throw await cy(),new x(`Invalid new pass type '${typeof t}'`,ry.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await cy(),new x(`Invalid pass length ${t.length}`,ry.ERR_INVALID_PASS_LENGTH);this.log("recreating keychain");const n=sy.get(this);if(null==n)throw new x("dek missing",ry.ERR_INVALID_PARAMETERS);const r=n.dek;this.init.pass=t;const i=null!=t&&null!=this.init.dek?.salt?Hd(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";sy.set(this,{dek:i});const o=await this.listKeys();for(const e of o){const t=Ir(await this.components.datastore.get(uy(e.name))),n=await Jm(t,r),o=i.toString(),s=await n.export(o),a=this.components.datastore.batch(),l={name:e.name,id:e.id};a.put(uy(e.name),Hn(s)),a.put(dy(e.name),Hn(JSON.stringify(l))),await a.commit()}this.log("keychain reconstructed")}}function fy(e={}){return t=>new hy(t,e)}const py=Symbol.for("@libp2p/peer-discovery");class gy{set;constructor(e){if(this.set=new Set,null!=e)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Ur(this.set.entries(),e=>{const t=Br(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=Br(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Ur(this.set.values(),e=>Br(e))}intersection(e){const t=new gy;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new gy;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new gy;for(const n of e)t.add(n);for(const e of this)t.add(e);return t}}var my;!function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.publicKey=e.bytes();break;case 2:n.payloadType=e.bytes();break;case 3:n.payload=e.bytes();break;case 5:n.signature=e.bytes();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(my||(my={}));class yy{static createFromProtobuf=async e=>{const t=my.decode(e),n=await Mr(t.publicKey);return new yy({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t)=>{if(null==t.privateKey)throw new Error("Missing private key");const n=e.domain,r=e.codec,i=e.marshal(),o=wy(n,r,i),s=await Zm(t.privateKey),a=await s.sign(o.subarray());return new yy({peerId:t,payloadType:r,payload:i,signature:a})};static openAndCertify=async(e,t)=>{const n=await yy.createFromProtobuf(e);if(!await n.validate(t))throw new x("envelope signature is not valid for the given domain","ERR_SIGNATURE_NOT_VALID");return n};peerId;payloadType;payload;signature;marshaled;constructor(e){const{peerId:t,payloadType:n,payload:r,signature:i}=e;this.peerId=t,this.payloadType=n,this.payload=r,this.signature=i}marshal(){if(null==this.peerId.publicKey)throw new Error("Missing public key");return null==this.marshaled&&(this.marshaled=my.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return he(this.marshal(),e.marshal())}async validate(e){const t=wy(e,this.payloadType,this.payload);if(null==this.peerId.publicKey)throw new Error("Missing public key");return Qm(this.peerId.publicKey).verify(t.subarray(),this.signature)}}const wy=(e,t,n)=>{const r=Hn(e),i=ce(r.byteLength),o=ce(t.length),s=ce(n.length);return new me(i,r,o,t,s,n)},by=Uint8Array.from([3,1]);var vy;!function(e){let t,n;!function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();t>>>3==1?n.multiaddr=e.bytes():e.skipType(7&t)}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(t=e.AddressInfo||(e.AddressInfo={})),e.codec=()=>(null==n&&(n=mr((t,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=t.peerId&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),null!=t.seq&&0n!==t.seq&&(n.uint32(16),n.uint64(t.seq)),null!=t.addresses)for(const r of t.addresses)n.uint32(26),e.AddressInfo.codec().encode(r,n);!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.peerId=t.bytes();break;case 2:r.seq=t.uint64();break;case 3:r.addresses.push(e.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(7&n)}}return r})),n),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(vy||(vy={}));class Ey{static createFromProtobuf=e=>{const t=vy.decode(e),n=Or(t.peerId),r=(t.addresses??[]).map(e=>Wo(e.multiaddr)),i=t.seq;return new Ey({peerId:n,multiaddrs:r,seqNumber:i})};static DOMAIN="libp2p-peer-record";static CODEC=by;peerId;multiaddrs;seqNumber;domain=Ey.DOMAIN;codec=Ey.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:r}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=r??BigInt(Date.now())}marshal(){return null==this.marshaled&&(this.marshaled=vy.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return e instanceof Ey&&!!this.peerId.equals(e.peerId)&&this.seqNumber===e.seqNumber&&!!function(e,t){const n=(e,t)=>e.toString().localeCompare(t.toString());return e.length===t.length&&(t.sort(n),e.sort(n).every((e,n)=>t[n].equals(e)))}(this.multiaddrs,e.multiaddrs)}}const Sy="ERR_INVALID_PARAMETERS";var ky,_y,Ry;function Iy(e,t){const n=ky.decode(t);null!=n.publicKey&&null==e.publicKey&&(e=function(e){if("RSA"===e.type)return new Cr(e);if("Ed25519"===e.type)return new Nr(e);if("secp256k1"===e.type)return new Dr(e);throw new x("Not a PeerId","ERR_INVALID_PARAMETERS")}({...e,publicKey:e.publicKey}));const r=new Map,i=BigInt(Date.now());for(const[e,t]of n.tags.entries())null!=t.expiry&&t.expiry<i||r.set(e,t);return{...n,id:e,addresses:n.addresses.map(({multiaddr:e,isCertified:t})=>({multiaddr:Wo(e),isCertified:t??!1})),metadata:n.metadata,peerRecordEnvelope:n.peerRecordEnvelope??void 0,tags:r}}!function(e){let t,n,r;!function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={key:"",value:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=e.bytes();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(t=e.Peer$metadataEntry||(e.Peer$metadataEntry={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&(t.uint32(18),Ry.codec().encode(e.value,t)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={key:""},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=Ry.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(n=e.Peer$tagsEntry||(e.Peer$tagsEntry={})),e.codec=()=>(null==r&&(r=mr((t,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=t.addresses)for(const e of t.addresses)n.uint32(10),_y.codec().encode(e,n);if(null!=t.protocols)for(const e of t.protocols)n.uint32(18),n.string(e);if(null!=t.publicKey&&(n.uint32(34),n.bytes(t.publicKey)),null!=t.peerRecordEnvelope&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),null!=t.metadata&&0!==t.metadata.size)for(const[r,i]of t.metadata.entries())n.uint32(50),e.Peer$metadataEntry.codec().encode({key:r,value:i},n);if(null!=t.tags&&0!==t.tags.size)for(const[r,i]of t.tags.entries())n.uint32(58),e.Peer$tagsEntry.codec().encode({key:r,value:i},n);!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.addresses.push(_y.codec().decode(t,t.uint32()));break;case 2:r.protocols.push(t.string());break;case 4:r.publicKey=t.bytes();break;case 5:r.peerRecordEnvelope=t.bytes();break;case 6:{const n=e.Peer$metadataEntry.codec().decode(t,t.uint32());r.metadata.set(n.key,n.value);break}case 7:{const n=e.Peer$tagsEntry.codec().decode(t,t.uint32());r.tags.set(n.key,n.value);break}default:t.skipType(7&n)}}return r})),r),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(ky||(ky={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.multiaddr=e.bytes();break;case 2:n.isCertified=e.bool();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(_y||(_y={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.value&&0!==e.value&&(t.uint32(8),t.uint32(e.value)),null!=e.expiry&&(t.uint32(16),t.uint64(e.expiry)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={value:0},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.value=e.uint32();break;case 2:n.expiry=e.uint64();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(Ry||(Ry={}));const Ay="/peers/";function xy(e){if(!Rr(e)||null==e.type)throw new x("Invalid PeerId",Sy);const t=e.toCID().toString();return new ba(`${Ay}${t}`)}async function Ty(e,t,n){const r=new Map;for(const i of n){if(null==i)continue;if(i.multiaddr instanceof Uint8Array&&(i.multiaddr=Wo(i.multiaddr)),!jo(i.multiaddr))throw new x("Multiaddr was invalid",Sy);if(!await t(e,i.multiaddr))continue;const n=i.isCertified??!1,o=i.multiaddr.toString(),s=r.get(o);null!=s?i.isCertified=s.isCertified||n:r.set(o,{multiaddr:i.multiaddr,isCertified:n})}return[...r.values()].sort((e,t)=>e.multiaddr.toString().localeCompare(t.multiaddr.toString())).map(({isCertified:e,multiaddr:t})=>({isCertified:e,multiaddr:t.bytes}))}async function Cy(e,t,n,r){if(null==t)throw new x("Invalid PeerData",Sy);if(null!=t.publicKey&&null!=e.publicKey&&!he(t.publicKey,e.publicKey))throw new x("publicKey bytes do not match peer id publicKey bytes",Sy);const i=r.existingPeer;if(null!=i&&!e.equals(i.id))throw new x("peer id did not match existing peer id",Sy);let o=i?.addresses??[],s=new Set(i?.protocols??[]),a=i?.metadata??new Map,l=i?.tags??new Map,c=i?.peerRecordEnvelope;if("patch"===n&&(null==t.multiaddrs&&null==t.addresses||(o=[],null!=t.multiaddrs&&o.push(...t.multiaddrs.map(e=>({isCertified:!1,multiaddr:e}))),null!=t.addresses&&o.push(...t.addresses)),null!=t.protocols&&(s=new Set(t.protocols)),null!=t.metadata&&(a=Ny(t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata),{validate:Dy})),null!=t.tags&&(l=Ny(t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),{validate:Py,map:Ly})),null!=t.peerRecordEnvelope&&(c=t.peerRecordEnvelope)),"merge"===n){if(null!=t.multiaddrs&&o.push(...t.multiaddrs.map(e=>({isCertified:!1,multiaddr:e}))),null!=t.addresses&&o.push(...t.addresses),null!=t.protocols&&(s=new Set([...s,...t.protocols])),null!=t.metadata){const e=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[t,n]of e)null==n?a.delete(t):a.set(t,n);a=Ny([...a.entries()],{validate:Dy})}if(null!=t.tags){const e=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),n=new Map(l);for(const[t,r]of e)null==r?n.delete(t):n.set(t,r);l=Ny([...n.entries()],{validate:Py,map:Ly})}null!=t.peerRecordEnvelope&&(c=t.peerRecordEnvelope)}const u={addresses:await Ty(e,r.addressFilter??(async()=>!0),o),protocols:[...s.values()].sort((e,t)=>e.localeCompare(t)),metadata:a,tags:l,publicKey:i?.id.publicKey??t.publicKey??e.publicKey,peerRecordEnvelope:c};return"RSA"!==e.type&&delete u.publicKey,u}function Ny(e,t){const n=new Map;for(const[n,r]of e)null!=r&&t.validate(n,r);for(const[r,i]of e.sort(([e],[t])=>e.localeCompare(t)))null!=i&&n.set(r,t.map?.(r,i)??i);return n}function Dy(e,t){if("string"!=typeof e)throw new x("Metadata key must be a string",Sy);if(!(t instanceof Uint8Array))throw new x("Metadata value must be a Uint8Array",Sy)}function Py(e,t){if("string"!=typeof e)throw new x("Tag name must be a string",Sy);if(null!=t.value){if(parseInt(`${t.value}`,10)!==t.value)throw new x("Tag value must be an integer",Sy);if(t.value<0||t.value>100)throw new x("Tag value must be between 0-100",Sy)}if(null!=t.ttl){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new x("Tag ttl must be an integer",Sy);if(t.ttl<0)throw new x("Tag ttl must be between greater than 0",Sy)}}function Ly(e,t){let n;return null!=t.expiry&&(n=t.expiry),null!=t.ttl&&(n=BigInt(Date.now()+Number(t.ttl))),{value:t.value??0,expiry:n}}function By(e,t,n){const r=e.toString().split("/")[2],i=Or(Rt.decode(r)),o=n.get(i);if(null!=o)return o;const s=Iy(i,t);return n.set(i,s),s}class Oy{peerId;datastore;lock;addressFilter;constructor(e,t={}){this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=Xc({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(xy(e))}async delete(e){if(this.peerId.equals(e))throw new x("Cannot delete self peer",Sy);await this.datastore.delete(xy(e))}async load(e){return Iy(e,await this.datastore.get(xy(e)))}async save(e,t){const{existingBuf:n,existingPeer:r}=await this.#U(e),i=await Cy(e,t,"patch",{addressFilter:this.addressFilter});return this.#F(e,i,n,r)}async patch(e,t){const{existingBuf:n,existingPeer:r}=await this.#U(e),i=await Cy(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:r});return this.#F(e,i,n,r)}async merge(e,t){const{existingBuf:n,existingPeer:r}=await this.#U(e),i=await Cy(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:r});return this.#F(e,i,n,r)}async*all(e){const t=new Fr;for await(const{key:n,value:r}of this.datastore.query(function(e,t){return null==e?{}:{prefix:Ay,filters:(e.filters??[]).map(e=>({key:n,value:r})=>e(By(n,r,t))),orders:(e.orders??[]).map(e=>(n,r)=>e(By(n.key,n.value,t),By(r.key,r.value,t)))}}(e??{},t))){const e=By(n,r,t);e.id.equals(this.peerId)||(yield e)}}async#U(e){try{const t=await this.datastore.get(xy(e));return{existingBuf:t,existingPeer:Iy(e,t)}}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return{}}async#F(e,t,n,r){const i=ky.encode(t);return null!=n&&he(i,n)?{peer:Iy(e,i),previous:r,updated:!1}:(await this.datastore.put(xy(e),i),{peer:Iy(e,i),previous:r,updated:!0})}}class My{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new Oy(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){this.log.trace("forEach await read lock");const n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const n of this.store.all(t))e(n)}finally{this.log.trace("forEach release read lock"),n()}}async all(e){this.log.trace("all await read lock");const t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await va(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");const t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");const t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");const t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");const n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const n=await this.store.save(e,t);return this.#z(e,n),n.peer}finally{this.log.trace("save release write lock"),n()}}async patch(e,t){this.log.trace("patch await write lock");const n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const n=await this.store.patch(e,t);return this.#z(e,n),n.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(e,t){this.log.trace("merge await write lock");const n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const n=await this.store.merge(e,t);return this.#z(e,n),n.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){const n=await yy.openAndCertify(e,Ey.DOMAIN);if(!1===t?.equals(n.peerId))return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,n.peerId),!1;const r=Ey.createFromProtobuf(n.payload);let i;try{i=await this.get(n.peerId)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=i?.peerRecordEnvelope){const e=await yy.createFromProtobuf(i.peerRecordEnvelope),t=Ey.createFromProtobuf(e.payload);if(t.seqNumber>=r.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,r.seqNumber),!1}return await this.patch(r.peerId,{peerRecordEnvelope:e,addresses:r.multiaddrs.map(e=>({isCertified:!0,multiaddr:e}))}),!0}#z(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}const Uy=e=>e;function Fy(e,t){const n=e.getPeerId();return null!=n&&Br(n).equals(t)&&(e=e.decapsulate(Wo(`/p2p/${t.toString()}`))),e}class zy{log;components;listen;announce;observed;announceFilter;constructor(e,t={}){const{listen:n=[],announce:r=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(e=>e.toString()),this.announce=new Set(r.map(e=>e.toString())),this.observed=new Map,this.announceFilter=t.announceFilter??Uy,this._updatePeerStoreAddresses=function(e){let t;return function(){clearTimeout(t),t=setTimeout(function(){t=void 0,e()},1e3)}}(this._updatePeerStoreAddresses.bind(this)),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter(([e,t])=>t.confident).map(([e])=>Wo(e))).map(e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(e=>{this.log.error("error updating addresses",e)})}getListenAddrs(){return Array.from(this.listen).map(e=>Wo(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>Wo(e))}getObservedAddrs(){return Array.from(this.observed).map(([e])=>Wo(e))}addObservedAddr(e){const t=(e=Fy(e,this.components.peerId)).toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){const t=(e=Fy(e,this.components.peerId)).toString(),n=(this.observed.get(t)??{confident:!1}).confident;this.observed.set(t,{confident:!0}),n||this._updatePeerStoreAddresses()}removeObservedAddr(e){const t=(e=Fy(e,this.components.peerId)).toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map(e=>e.toString());0===e.length&&(e=this.components.transportManager.getAddrs().map(e=>e.toString())),e=e.concat(Array.from(this.observed).filter(([e,t])=>t.confident).map(([e])=>e));const t=new Set(e);return this.announceFilter(Array.from(t).map(e=>Wo(e))).map(e=>!0===e.protos().pop()?.path||e.getPeerId()===this.components.peerId.toString()?e:e.encapsulate(`/p2p/${this.components.peerId.toString()}`))}}class Vy{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;null==this.components.logger&&(this.components.logger=ha())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(e=>Ia(e)).map(async t=>{await(t[e]?.())}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const $y=["metrics","connectionProtector","dns"],Hy=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Ky(e){return Array.isArray(e?.[ey])?e[ey]:[]}function qy(e){return Array.isArray(e?.[ty])?e[ty]:[]}function jy(e){return e?.[Symbol.toStringTag]??e?.toString()??"unknown"}function Wy(e={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{const t=e.stringTuples();return(4===t[0][0]||41===t[0][0])&&Boolean(Oi(`${t[0][1]}`))},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...e}}const Gy=Symbol.for("@libp2p/transport");var Yy;function Qy(e){try{const{address:t}=e.nodeAddress();return Boolean(Oi(t))}catch{return!0}}function Xy(e,t){const n=function(e,t){const n=Qy(e.multiaddr),r=Qy(t.multiaddr);return n&&!r?1:!n&&r?-1:0}(e,t);if(0!==n)return n;const r=function(e,t){const n=wo.exactMatch(e.multiaddr),r=wo.exactMatch(t.multiaddr);return n&&!r?1:!n&&r?-1:0}(e,t);if(0!==r)return r;const i=function(e,t){return e.isCertified&&!t.isCertified?-1:!e.isCertified&&t.isCertified?1:0}(e,t);return i}!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(Yy||(Yy={}));const Zy=-1,Jy={},ew={};[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Zy,"ip6zone"],[43,8,"ipcidr"],[53,Zy,"dns",!0],[54,Zy,"dns4",!0],[55,Zy,"dns6",!0],[56,Zy,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Zy,"unix",!1,!0],[421,Zy,"ipfs"],[421,Zy,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Zy,"garlic64"],[448,0,"tls"],[449,Zy,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Zy,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,Zy,"http-path"],[777,Zy,"memory"]].forEach(e=>{const t=function(e,t,n,r,i){return{code:e,size:t,name:n,resolvable:Boolean(r),path:Boolean(i)}}(...e);ew[t.code]=t,Jy[t.name]=t});const{code:tw}=function(e){if(null!=Jy[e])return Jy[e];throw new Error(`no protocol with name: ${e}`)}("dnsaddr");class nw extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const rw=async function(e,t={}){const n=t.maxRecursiveDepth??32;if(0===n)throw new nw("Max recursive depth reached");const[,r]=e.stringTuples().find(([e])=>e===tw)??[],i=t?.dns??Ka(),o=await i.query(`_dnsaddr.${r}`,{signal:t?.signal,types:[za.TXT]}),s=e.getPeerId(),a=[];for(const e of o.Answer){const r=e.data.replace(/["']/g,"").trim().split("=")[1];if(null==r)continue;if(null!=s&&!r.includes(s))continue;const i=Wo(r);if(r.startsWith("/dnsaddr")){const e=await i.resolve({...t,maxRecursiveDepth:n-1});a.push(...e.map(e=>e.toString()))}else a.push(i.toString())}return a};var iw,ow;!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(iw||(iw={})),function(e){e.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",e.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",e.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",e.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",e.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",e.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",e.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",e.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",e.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",e.ERR_DIALED_SELF="ERR_DIALED_SELF",e.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",e.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",e.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",e.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",e.ERR_INVALID_KEY="ERR_INVALID_KEY",e.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_PEER="ERR_INVALID_PEER",e.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",e.ERR_NOT_FOUND="ERR_NOT_FOUND",e.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",e.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",e.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",e.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",e.ERR_FIND_SELF="ERR_FIND_SELF",e.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",e.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",e.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",e.ERR_INVALID_CMS="ERR_INVALID_CMS",e.ERR_MISSING_KEYS="ERR_MISSING_KEYS",e.ERR_NO_KEY="ERR_NO_KEY",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",e.ERR_INVALID_RECORD="ERR_INVALID_RECORD",e.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",e.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",e.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"}(ow||(ow={}));const sw={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:e=>e},connectionManager:{resolvers:{dnsaddr:rw},addressSorter:Xy},transportManager:{faultTolerance:Yy.FATAL_ALL}},aw=()=>{const e=new Error("Delay aborted");return e.name="AbortError",e},lw=new WeakMap,cw=function({clearTimeout:e,setTimeout:t}={}){return(n,{value:r,signal:i}={})=>{if(i?.aborted)return Promise.reject(aw());let o,s,a;const l=e??clearTimeout,c=()=>{l(o),a(aw())},u=new Promise((e,l)=>{s=()=>{i&&i.removeEventListener("abort",c),e(r)},a=l,o=(t??setTimeout)(s,n)});return i&&i.addEventListener("abort",c,{once:!0}),lw.set(u,()=>{l(o),o=null,s()}),u}}();class uw{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??1e3*this.duration/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new dw}async consume(e,t=1,n={}){const r=this.getKey(e),i=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(r,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(r,o.consumedPoints,this.blockDuration)),new x("Rate limit exceeded","ERR_RATE_LIMIT_EXCEEDED",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let e=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));e<this.execEvenlyMinDelayMs&&(e=o.consumedPoints*this.execEvenlyMinDelayMs),await cw(e)}return o}penalty(e,t=1,n={}){const r=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(r,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const r=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(r,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=1e3*t,r=this.points+1;return this.memoryStorage.set(this.getKey(e),r,t),{remainingPoints:0,msBeforeNext:0===n?-1:n,consumedPoints:r,isFirstInDuration:!1}}set(e,t,n=0){const r=1e3*(n>=0?n:this.duration);return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:0===r?-1:r,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return null!=t&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return null!=e?.customDuration&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class dw{storage;constructor(){this.storage=new Map}incrby(e,t,n){const r=this.storage.get(e);if(null!=r){const i=null!=r.expiresAt?r.expiresAt.getTime()-(new Date).getTime():-1;return null==r.expiresAt||i>0?(r.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:r.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const r=1e3*n,i=this.storage.get(e);null!=i&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:r>0?new Date(Date.now()+r):void 0};return this.storage.set(e,o),r>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},r),null!=o.timeoutId.unref&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:0===r?-1:r,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(null!=t)return{remainingPoints:0,msBeforeNext:null!=t.expiresAt?t.expiresAt.getTime()-(new Date).getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return null!=t&&(null!=t.timeoutId&&clearTimeout(t.timeoutId),this.storage.delete(e),!0)}}function hw(e){if(Rr(e))return{peerId:e,multiaddrs:[]};let t;if(Array.isArray(e)||(e=[e]),e.length>0){const n=e[0].getPeerId();t=null==n?void 0:Br(n),e.forEach(e=>{if(!jo(e))throw new x("Invalid Multiaddr",ow.ERR_INVALID_MULTIADDR);const n=e.getPeerId();if(null==n){if(null!=t)throw new x("Multiaddrs must all have the same peer id or have no peer id",ow.ERR_INVALID_PARAMETERS)}else{const e=Br(n);if(!0!==t?.equals(e))throw new x("Multiaddrs must all have the same peer id or have no peer id",ow.ERR_INVALID_PARAMETERS)}})}return{peerId:t,multiaddrs:e}}const fw=42e4,pw="last-dial-failure",gw=5,mw=100,yw=25,ww=0,bw=5e3,vw=fw,Ew=10;class Sw{connectionManager;peerStore;queue;minConnections;autoDialPriority;autoDialIntervalMs;autoDialMaxQueueLength;autoDialPeerRetryThresholdMs;autoDialDiscoveredPeersDebounce;autoDialInterval;started;running;log;constructor(e,t){let n;this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=t.minConnections??gw,this.autoDialPriority=t.autoDialPriority??ww,this.autoDialIntervalMs=t.autoDialInterval??bw,this.autoDialMaxQueueLength=t.maxQueueLength??mw,this.autoDialPeerRetryThresholdMs=t.autoDialPeerRetryThreshold??vw,this.autoDialDiscoveredPeersDebounce=t.autoDialDiscoveredPeersDebounce??Ew,this.log=e.logger.forComponent("libp2p:connection-manager:auto-dial"),this.started=!1,this.running=!1,this.queue=new W({concurrency:t.autoDialConcurrency??yw,metricName:"libp2p_autodial_queue",metrics:e.metrics}),this.queue.addEventListener("error",e=>{this.log.error("error during auto-dial",e.detail)}),e.events.addEventListener("connection:close",()=>{this.autoDial().catch(e=>{this.log.error(e)})}),e.events.addEventListener("peer:discovery",()=>{clearTimeout(n),n=setTimeout(()=>{this.autoDial().catch(e=>{this.log.error(e)})},this.autoDialDiscoveredPeersDebounce)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.autoDial().catch(e=>{this.log.error("error while autodialing",e)})}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started||this.running)return;const e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections)return void(this.minConnections>0&&this.log.trace("have enough connections %d/%d",t,this.minConnections));if(this.queue.size>this.autoDialMaxQueueLength)return this.log("not enough connections %d/%d but auto dial queue is full",t,this.minConnections),void this.sheduleNextAutodial();this.running=!0,this.log("not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);const n=new gy(this.connectionManager.getDialQueue().map(e=>e.peerId).filter(Boolean)),r=await this.peerStore.all({filters:[t=>0===t.addresses.length?(this.log.trace("not autodialing %p because they have no addresses",t.id),!1):e.has(t.id)?(this.log.trace("not autodialing %p because they are already connected",t.id),!1):n.has(t.id)?(this.log.trace("not autodialing %p because they are already being dialed",t.id),!1):!this.queue.has(t.id)||(this.log.trace("not autodialing %p because they are already being autodialed",t.id),!1)]}),i=r.sort(()=>Math.random()>.5?1:-1),o=new Fr;for(const e of i)o.has(e.id)||o.set(e.id,[...e.tags.values()].reduce((e,t)=>e+t.value,0));const s=i.sort((e,t)=>{const n=o.get(e.id)??0,r=o.get(t.id)??0;return n>r?-1:n<r?1:0}),a=s.filter(e=>{const t=e.metadata.get(pw);if(null==t)return!0;const n=parseInt(Ir(t));return!!isNaN(n)||Date.now()-n>this.autoDialPeerRetryThresholdMs});this.log("selected %d/%d peers to dial",a.length,r.length);for(const e of a)this.queue.add(async()=>{const t=this.connectionManager.getConnectionsMap().size;if(t>=this.minConnections)return this.log("got enough connections now %d/%d",t,this.minConnections),void this.queue.clear();this.log("connecting to a peerStore stored peer %p",e.id),await this.connectionManager.openConnection(e.id,{priority:this.autoDialPriority})},{peerId:e.id}).catch(e=>{this.log.error("could not connect to peerStore stored peer",e)});this.running=!1,this.sheduleNextAutodial()}sheduleNextAutodial(){this.started&&(this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(e=>{this.log.error("error while autodialing",e)})},this.autoDialIntervalMs))}}const kw=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"],_w={maxConnections:100,allow:[]};class Rw{maxConnections;connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??_w.maxConnections,this.allow=t.allow??_w.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),e.events.addEventListener("connection:open",()=>{this.maybePruneConnections().catch(e=>{this.log.error(e)})})}async maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length;if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;const n=new Fr;for(const t of e){const e=t.remotePeer;if(!n.has(e)){n.set(e,0);try{const t=await this.peerStore.get(e);n.set(e,[...t.tags.values()].reduce((e,t)=>e+t.value,0))}catch(e){"ERR_NOT_FOUND"!==e.code&&this.log.error("error loading peer tags",e)}}}const r=this.sortConnections(e,n),i=Math.max(t-this.maxConnections,0),o=[];for(const e of r)if(this.log("too many connections open - closing a connection to %p",e.remotePeer),this.allow.some(t=>e.remoteAddr.toString().startsWith(t.toString()))||o.push(e),o.length===i)break;await Promise.all(o.map(async e=>{await async function(e,t){const n=e?.streams?.map(e=>e.protocol)??[],r=t?.closableProtocols??kw;if(!(n.filter(e=>null!=e&&!r.includes(e)).length>0))try{await(e?.close(t))}catch(t){e?.abort(t)}}(e,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(e,t){return e.sort((e,t)=>{const n=e.timeline.open,r=t.timeline.open;return n<r?1:n>r?-1:0}).sort((e,t)=>"outbound"===e.direction&&"inbound"===t.direction?1:"inbound"===e.direction&&"outbound"===t.direction?-1:0).sort((e,t)=>e.streams.length>t.streams.length?1:e.streams.length<t.streams.length?-1:0).sort((e,n)=>{const r=t.get(e.remotePeer)??0,i=t.get(n.remotePeer)??0;return r>i?1:r<i?-1:0})}}class Iw extends j{constructor(e={}){super({...e,sort:(e,t)=>e.options.priority>t.options.priority?-1:e.options.priority<t.options.priority?1:0})}}const Aw={addressSorter:Xy,maxParallelDials:50,maxDialQueueLength:500,maxPeerAddrsToDial:25,dialTimeout:5e3,resolvers:{dnsaddr:rw}};class xw{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter??Aw.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Aw.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Aw.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Aw.dialTimeout,this.connections=t.connections??new Fr,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[e,n]of Object.entries(t.resolvers??{}))qo.set(e,n);this.queue=new Iw({concurrency:t.maxParallelDials??Aw.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",e=>{this.log.error("error in dial queue",e.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:r}=hw(e),i=Array.from(this.connections.values()).flat().find(e=>!0!==t.force&&(!!e.remotePeer.equals(n)||r.find(t=>t.equals(e.remoteAddr))));if(null!=i)return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new Fe("dial-queue:already-connected")),i;const o=this.queue.queue.find(e=>{if(!0===n?.equals(e.options.peerId))return!0;const t=e.options.multiaddrs;if(null==t)return!1;for(const e of r)if(t.has(e.toString()))return!0;return!1});if(null!=o){this.log("joining existing dial target for %p",n);for(const e of r)o.options.multiaddrs.add(e.toString());return t.onProgress?.(new Fe("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new x("Dial queue is full","ERR_DIAL_QUEUE_FULL");return this.log("creating dial target for %p",n,r.map(e=>e.toString())),t.onProgress?.(new Fe("dial-queue:add-to-dial-queue")),this.queue.add(async e=>{e?.onProgress?.(new Fe("dial-queue:start-dial"));const t=this.createDialAbortController(e?.signal);let r;try{r=await this.calculateMultiaddrs(n,e?.multiaddrs,{...e,signal:t}),e?.onProgress?.(new Fe("dial-queue:calculated-addresses",r)),r.map(({multiaddr:e})=>e.toString()).forEach(t=>{e?.multiaddrs.add(t)})}catch(e){throw t.clear(),e}try{let i=0;const o=[];for(const s of r){if(i===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",i,n),new x("Peer had more than maxPeerAddrsToDial",ow.ERR_TOO_MANY_ADDRESSES);i++;try{const n=await this.components.transportManager.dial(s.multiaddr,{...e,signal:t});return this.log("dial to %a succeeded",s.multiaddr),n}catch(e){if(this.log.error("dial failed to %a",s.multiaddr,e),null!=n)try{await this.components.peerStore.patch(n,{metadata:{[pw]:Hn(Date.now().toString())}})}catch(e){this.log.error("could not update last dial failure key for %p",n,e)}if(t.aborted)throw new x(e.message,C);o.push(e)}}if(1===o.length)throw o[0];throw new T(o,"All multiaddr dials failed",ow.ERR_TRANSPORT_DIAL_FAILED)}finally{t.clear()}},{peerId:n,priority:t.priority??Tw,multiaddrs:new Set(r.map(e=>e.toString())),signal:t.signal,onProgress:t.onProgress})}createDialAbortController(e){return _([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e])}async calculateMultiaddrs(e,t=new Set,n={}){const r=[...t].map(e=>({multiaddr:Wo(e),isCertified:!1}));if(null!=e){if(this.components.peerId.equals(e))throw new x("Tried to dial self",ow.ERR_DIALED_SELF);if(!0===await(this.components.connectionGater.denyDialPeer?.(e)))throw new x("The dial request is blocked by gater.allowDialPeer",ow.ERR_PEER_DIAL_INTERCEPTED);if(0===r.length){this.log("loading multiaddrs for %p",e);try{const t=await this.components.peerStore.get(e);r.push(...t.addresses),this.log("loaded multiaddrs for %p",e,r.map(({multiaddr:e})=>e.toString()))}catch(e){if(e.code!==ow.ERR_NOT_FOUND)throw e}}if(0===r.length){this.log("looking up multiaddrs for %p in the peer routing",e);try{const t=await this.components.peerRouting.findPeer(e);this.log("found multiaddrs for %p in the peer routing",e,r.map(({multiaddr:e})=>e.toString())),r.push(...t.multiaddrs.map(e=>({multiaddr:e,isCertified:!1})))}catch(t){t.code!==ow.ERR_NO_ROUTERS_AVAILABLE&&this.log.error("looking up multiaddrs for %p in the peer routing failed",e,t)}}}let i=(await Promise.all(r.map(async e=>{const t=await async function(e,t){let n=!1;for(const t of qo.keys())if(n=e.protoNames().includes(t),n)break;if(!n)return[e];const r=await e.resolve(t);return t.log("resolved %s to",e,r.map(e=>e.toString())),r}(e.multiaddr,{dns:this.components.dns,...n,log:this.log});return 1===t.length&&t[0].equals(e.multiaddr)?e:t.map(e=>({multiaddr:e,isCertified:!1}))}))).flat();if(null!=e){const t=`/p2p/${e.toString()}`;i=i.map(e=>{const n=e.multiaddr.protos().pop();return!0===n?.path?e:null==e.multiaddr.getPeerId()?{multiaddr:e.multiaddr.encapsulate(t),isCertified:e.isCertified}:e})}const o=i.filter(t=>{if(null==this.components.transportManager.dialTransportForMultiaddr(t.multiaddr))return!1;const n=t.multiaddr.getPeerId();return null==e||null==n||e.equals(n)}),s=new Map;for(const e of o){const t=e.multiaddr.toString(),n=s.get(t);null==n?s.set(t,e):n.isCertified=n.isCertified||e.isCertified||!1}const a=[...s.values()];if(0===a.length)throw new x("The dial request has no valid addresses",ow.ERR_NO_VALID_ADDRESSES);const l=[];for(const e of a)null!=this.components.connectionGater.denyDialMultiaddr&&await this.components.connectionGater.denyDialMultiaddr(e.multiaddr)||l.push(e);const c=l.sort(this.addressSorter);if(0===c.length)throw new x("The connection gater denied all addresses in the dial request",ow.ERR_NO_VALID_ADDRESSES);return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:e})=>e.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",c.map(({multiaddr:e})=>e.toString())),c}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(e=>e.toString())),t);return!1!==t.runOnTransientConnection||null!=n.find(e=>!wo.matches(e.multiaddr))}catch(e){this.log.trace("error calculating if multiaddr(s) were dialable",e)}return!1}}const Tw=50,Cw=5,Nw=100,Dw=5,Pw=10,Lw=25,Bw=0,Ow=100,Mw=fw,Uw=10;class Fw{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;maxConnections;dialQueue;autoDial;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;constructor(e,t={}){this.maxConnections=t.maxConnections??Nw;const n=t.minConnections??Cw;if(this.maxConnections<n)throw new x("Connection Manager maxConnections must be greater than minConnections",ow.ERR_INVALID_PARAMETERS);this.connections=new Fr,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(t.allow??[]).map(e=>Wo(e)),this.deny=(t.deny??[]).map(e=>Wo(e)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Pw,this.inboundConnectionRateLimiter=new uw({points:t.inboundConnectionThreshold??Dw,duration:1}),this.autoDial=new Sw({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{minConnections:n,autoDialConcurrency:t.autoDialConcurrency??Lw,autoDialPriority:t.autoDialPriority??Bw,autoDialPeerRetryThreshold:t.autoDialPeerRetryThreshold??Mw,autoDialDiscoveredPeersDebounce:t.autoDialDiscoveredPeersDebounce??Uw,maxQueueLength:t.autoDialMaxQueueLength??Ow}),this.connectionPruner=new Rw({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new xw(e,{addressSorter:t.addressSorter??Xy,maxParallelDials:t.maxParallelDials??50,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??5e3,resolvers:t.resolvers??{dnsaddr:rw},connections:this.connections})}[Symbol.toStringTag]="@libp2p/connection-manager";isStarted(){return this.started}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)"inbound"===n.direction?e.inbound++:e.outbound++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const t of n.streams){const n=`${t.direction} ${t.protocol??"unnegotiated"}`;e[n]=(e[n]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t){const t={};for(const e of n.streams){const n=`${e.direction} ${e.protocol??"unnegotiated"}`;t[n]=(t[n]??0)+1}for(const[n,r]of Object.entries(t))e[n]=e[n]??[],e[n].push(r)}const t={};for(let[n,r]of Object.entries(e)){r=r.sort((e,t)=>e-t);const e=Math.floor(.9*r.length);t[n]=r[e]}return t}}),this.dialQueue.start(),this.autoDial.start(),this.started=!0,this.log("started")}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[e=>e.tags.has("keep-alive")]});await Promise.all(e.map(async e=>{await this.openConnection(e.id).catch(e=>{this.log.error(e)})}))}).catch(e=>{this.log.error(e)}),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(e){this.log.error(e)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}onConnect(e){this._onConnect(e).catch(e=>{this.log.error(e)})}async _onConnect(e){const{detail:t}=e;if(!this.started)return void await t.close();const n=t.remotePeer,r=this.connections.get(n);let i=!1;null!=r?r.push(t):(i=!0,this.connections.set(n,[t])),null!=n.publicKey&&"RSA"===n.type&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer;let r=this.connections.get(n);null!=r&&r.length>1?(r=r.filter(e=>e.id!==t.id),this.connections.set(n,r)):null!=r&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(null!=e)return this.connections.get(e)??[];let t=[];for(const e of this.connections.values())t=t.concat(e);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.isStarted())throw new x("Not started",ow.ERR_NODE_NOT_STARTED);t.signal?.throwIfAborted();const{peerId:n}=hw(e);if(null!=n&&!0!==t.force){this.log("dial %p",n);const e=this.getConnections(n).find(e=>!e.transient);if(null!=e)return this.log("had an existing non-transient connection to %p",n),t.onProgress?.(new Fe("dial-queue:already-connected")),e}const r=await this.dialQueue.dial(e,{...t,priority:t.priority??Tw});let i=this.connections.get(r.remotePeer);null==i&&(i=[],this.connections.set(r.remotePeer,i));let o=!1;for(const e of i)e.id===r.id&&(o=!0);return o||i.push(r),r}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async e=>{try{await e.close(t)}catch(t){e.abort(t)}}))}async acceptIncomingConnection(e){if(this.deny.some(t=>e.remoteAddr.toString().startsWith(t.toString())))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(t=>e.remoteAddr.toString().startsWith(t.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,t),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(e=>Wo(e))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class zw{movingAverage;variance;deviation;forecast;timespan;previousTime;constructor(e){this.timespan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timespan)}push(e,t=Date.now()){if(null!=this.previousTime){const n=this.alpha(t,this.previousTime),r=e-this.movingAverage,i=n*r;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+r*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*r}else this.movingAverage=e;this.previousTime=t}}class Vw{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;constructor(e={}){this.success=new zw(e.interval??5e3),this.failure=new zw(e.interval??5e3),this.next=new zw(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??2,this.timeoutMultiplier=e.timeoutMultiplier??1.2,this.minTimeout=e.minTimeout??2e3,null!=e.metricName&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){const t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),n=AbortSignal.timeout(t),r=_([e.signal,n]);return r.start=Date.now(),r.timeout=t,r}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class $w{readNext;haveNext;ended;nextResult;constructor(){this.ended=!1,this.readNext=D(),this.haveNext=D()}[Symbol.asyncIterator](){return this}async next(){if(null==this.nextResult&&await this.haveNext.promise,null==this.nextResult)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=D(),e}async throw(e){return this.ended=!0,null!=e&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){null!=e?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(null!=e&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;null!=this.nextResult;)await this.readNext.promise;null!=e?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=D(),await H(this.readNext.promise,t?.signal,t)}}class Hw extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}class Kw extends Error{code;constructor(e,t){super(e),this.code=t}}class qw extends Kw{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted",this.name="AbortError"}}function jw(e,t){const n=new $w;e.sink(n).catch(async e=>{await n.end(e)}),e.sink=async e=>{for await(const t of e)await n.push(t);await n.end()};let r=e.source;null!=e.source[Symbol.iterator]?r=e.source[Symbol.iterator]():null!=e.source[Symbol.asyncIterator]&&(r=e.source[Symbol.asyncIterator]());const i=new me,o={read:async(e,t)=>{let n;t?.signal?.throwIfAborted();const o=new Promise((e,r)=>{n=()=>{r(new qw("Read aborted"))},t?.signal?.addEventListener("abort",n)});try{if(null==e){const{done:e,value:t}=await Promise.race([r.next(),o]);return!0===e?new me:t}for(;i.byteLength<e;){const{value:e,done:t}=await Promise.race([r.next(),o]);if(!0===t)throw new Hw("unexpected end of input");i.append(e)}const t=i.sublist(0,e);return i.consume(e),t}finally{null!=n&&t?.signal?.removeEventListener("abort",n)}},write:async(e,t)=>{t?.signal?.throwIfAborted(),e instanceof Uint8Array?await n.push(e,t):await n.push(e.subarray(),t)},unwrap:()=>{if(i.byteLength>0){const n=e.source;e.source=async function*(){!1===t?.yieldBytes?yield i:yield*i,yield*n}()}return e}};return o}class Ww{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??1e4,this.timeout=new Vw({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[ey]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),r=jw(await e.newStream(this.protocol,{signal:n,runOnTransientConnection:!0}));t=Date.now(),await Promise.all([r.write(mi(32),{signal:n}),r.read(32,{signal:n})]),e.rtt=Date.now()-t,await r.unwrap().close({signal:n})}catch(n){if("ERR_UNSUPPORTED_PROTOCOL"!==n.code)throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat, aborting connection",t),e.abort(t)})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),null!=this.heartbeatInterval&&clearInterval(this.heartbeatInterval)}}class Gw{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(0===this.routers.length)throw new x("No content routers available",ow.ERR_NO_ROUTERS_AVAILABLE);const n=this,r=new gy;for await(const i of Ne(...n.routers.map(n=>n.findProviders(e,t))))null!=i&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),r.has(i.id)||(r.add(i.id),yield i))}async provide(e,t={}){if(0===this.routers.length)throw new x("No content routers available",ow.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async n=>{await n.provide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new x(iw.NOT_STARTED_YET,ow.ERR_NODE_NOT_STARTED);await Promise.all(this.routers.map(async r=>{await r.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new x(iw.NOT_STARTED_YET,ow.ERR_NODE_NOT_STARTED);return Promise.any(this.routers.map(async n=>n.get(e,t)))}}class Yw{fp;h;seed;constructor(e,t,n,r=2){if(r>64)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,n),o=Y(r);for(let e=0;e<o.length;e++)o[e]=i[e];0===o.length&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array&&he(this.fp,e.fp)}}function Qw(e,t){return Math.floor(Math.random()*(t-e))+e}class Xw{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Yw))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Yw))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(null==this.contents[t])return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Yw))throw new TypeError("Invalid Fingerprint");const t=Qw(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof Yw))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(t=>e.equals(t));return t>-1&&(this.contents[t]=null,!0)}}const Zw={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Jw={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},eb=new globalThis.TextEncoder;const tb={hash:e=>Number(function(e,{size:t=32,utf8Buffer:n}={}){if(!Zw[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if("string"==typeof e){if(n)return function(e,t,n){if(0===n.length)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=Zw[t];let i=Jw[t],o=e;for(;o.length>0;){const e=eb.encodeInto(o,n);o=o.slice(e.read);for(let o=0;o<e.written;o++)i^=BigInt(n[o]),i=BigInt.asUintN(t,i*r)}return i}(e,t,n);e=eb.encode(e)}return function(e,t){const n=Zw[t];let r=Jw[t];for(let i=0;i<e.length;i++)r^=BigInt(e[i]),r=BigInt.asUintN(t,r*n);return r}(e,t)}(e,{size:32})),hashV:(e,t)=>function(e){let t=e.toString(16);return t.length%2==1&&(t=`0${t}`),Hn(t,"base16")}(tb.hash(e,t))};class nb{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??tb,this.seed=e.seed??Qw(0,Math.pow(2,10))}add(e){"string"==typeof e&&(e=Hn(e));const t=new Yw(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,r=(n^t.hash())%this.filterSize;if(null==this.buckets[n]&&(this.buckets[n]=new Xw(this.bucketSize)),null==this.buckets[r]&&(this.buckets[r]=new Xw(this.bucketSize)),this.buckets[n].add(t)||this.buckets[r].add(t))return this.count++,!0;const i=[n,r];let o=i[Qw(0,i.length-1)];null==this.buckets[o]&&(this.buckets[o]=new Xw(this.bucketSize));for(let e=0;e<500;e++){const e=this.buckets[o].swap(t);if(null!=e&&(o=(o^e.hash())%this.filterSize,null==this.buckets[o]&&(this.buckets[o]=new Xw(this.bucketSize)),this.buckets[o].add(e)))return this.count++,!0}return!1}has(e){"string"==typeof e&&(e=Hn(e));const t=new Yw(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[n]?.has(t)??!1;if(r)return r;const i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){"string"==typeof e&&(e=Hn(e));const t=new Yw(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[n]?.remove(t)??!1;if(r)return this.count--,r;const i=(n^t.hash())%this.filterSize,o=this.buckets[i]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(this.count/this.filterSize*100)<=90}}const rb={1:.5,2:.84,4:.95,8:.98};function ib(e,t=.001){const n=function(e=.001){return e>.002?2:e>1e-5?4:8}(t),r=rb[n];return{filterSize:Math.round(e/r),bucketSize:n,fingerprintSize:Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*n)),64)}}class ob{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??tb,this.seed=e.seed??Qw(0,Math.pow(2,10)),this.filterSeries=[new nb({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if("string"==typeof e&&(e=Hn(e)),this.has(e))return!0;let t=this.filterSeries.find(e=>e.reliable);if(null==t){const e=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new nb({filterSize:e,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){"string"==typeof e&&(e=Hn(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){"string"==typeof e&&(e=Hn(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function sb(e,t=.001,n){return new ob({...ib(e,t),...n??{}})}const ab=globalThis.CustomEvent??Event;async function*lb(e,t={}){let n=t.concurrency??1/0;n<1&&(n=1/0);const r=t.ordered??!1,i=new EventTarget,o=[];let s,a=D(),l=D(),c=!1,u=!1;function d(){return r?o[0]?.done:Boolean(o.find(e=>e.done))}function*h(){for(;o.length>0&&o[0].done;){const e=o[0];if(o.shift(),!e.ok)throw u=!0,a.resolve(),e.err;yield e.value,a.resolve()}}function*f(){for(;d();)for(let e=0;e<o.length;e++)if(o[e].done){const t=o[e];if(o.splice(e,1),e--,!t.ok)throw u=!0,a.resolve(),t.err;yield t.value,a.resolve()}}for(i.addEventListener("task-complete",()=>{l.resolve()}),Promise.resolve().then(async()=>{try{for await(const t of e){if(o.length===n&&(a=D(),await a.promise),u)break;const e={done:!1};o.push(e),t().then(t=>{e.done=!0,e.ok=!0,e.value=t,i.dispatchEvent(new ab("task-complete"))},t=>{e.done=!0,e.err=t,i.dispatchEvent(new ab("task-complete"))})}c=!0,i.dispatchEvent(new ab("task-complete"))}catch(e){s=e,i.dispatchEvent(new ab("task-complete"))}});;){if(d()||(l=D(),await l.promise),null!=s)throw s;if(r?yield*h():yield*f(),null!=s)throw s;if(c&&0===o.length)break}}class cb{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[]}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(0===this.routers.length)throw new x("No peer routers available",ow.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.peerId.toString())throw new x("Should not try to find self",ow.ERR_FIND_SELF);const n=this,r=Ne(...this.routers.map(r=>async function*(){try{yield await r.findPeer(e,t)}catch(e){n.log.error(e)}}()));for await(const e of r)if(null!=e)return e.multiaddrs.length>0&&await this.peerStore.merge(e.id,{multiaddrs:e.multiaddrs}),e;throw new x(iw.NOT_FOUND,ow.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){if(0===this.routers.length)throw new x("No peer routers available",ow.ERR_NO_ROUTERS_AVAILABLE);const n=this,r=sb(1024);for await(const i of lb(async function*(){const r=Ne(...n.routers.map(n=>n.getClosestPeers(e,t)));for await(let e of r)yield async()=>{if(0===e.multiaddrs.length)try{e=await n.findPeer(e.id,{...t,useCache:!1})}catch(e){return void n.log.error("could not find peer multiaddrs",e)}return e}}()))null!=i&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),r.has(i.id.toBytes())||(r.add(i.id.toBytes()),yield i))}}class ub extends R{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=_([this.shutdownController.signal,e?.signal]);try{for(;;){this.needNext?.resolve(),this.needNext=D();const e=await U(this,"walk:peer",t,{errorEvent:"walk:error"});yield e.detail}}finally{t.clear(),this.walkers--,0===this.walkers&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=_([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const t=mi(32);let r=Date.now();for await(const i of this.peerRouting.getClosestPeers(t,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",i.id,Date.now()-r,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:i}),1===this.walkers&&null!=this.needNext&&(this.log("wait for need next"),await H(this.needNext.promise,e)),r=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",t,this.walkers,n)}catch(e){this.log.error("randomwalk errored",e),this.safeDispatchEvent("walk:error",{detail:e})}this.log("no walkers left, ended walk")}).catch(e=>{this.log.error("randomwalk errored",e)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}class db{log;topologies;handlers;components;constructor(e){this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(null==t)throw new x(`No handler registered for protocol ${e}`,ow.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw new x(`Handler already registered for protocol ${e}`,ow.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const r=ny.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},n);this.handlers.set(e,{handler:t,options:r}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(e=>{this.handlers.delete(e)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(null==t)throw new x("invalid topology",ow.ERR_INVALID_PARAMETERS);const n=`${(1e9*Math.random()).toString(36)}${Date.now()}`;let r=this.topologies.get(e);return null==r&&(r=new Map,this.topologies.set(e,r)),r.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),0===n.size&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then(e=>{for(const n of e.protocols){const e=this.topologies.get(n);if(null!=e)for(const n of e.values())!1!==n.filter?.has(t)&&(n.filter?.remove(t),n.onDisconnect?.(t))}}).catch(e=>{e.code!==ow.ERR_NOT_FOUND&&this.log.error("could not inform topologies of disconnecting peer %p",t,e)})}_onPeerUpdate(e){const{peer:t,previous:n}=e.detail,r=(n?.protocols??[]).filter(e=>!t.protocols.includes(e));for(const e of r){const n=this.topologies.get(e);if(null!=n)for(const e of n.values())!1!==e.filter?.has(t.id)&&(e.filter?.remove(t.id),e.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,r=e.detail.peerId;for(const e of t){const t=this.topologies.get(e);if(null!=t)for(const e of t.values())n.transient&&!0!==e.notifyOnTransient||!0!==e.filter?.has(r)&&(e.filter?.add(r),e.onConnect?.(r,n))}}}class hb{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=_i({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Yy.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(null==t)throw new x("Transport must have a valid tag",ow.ERR_INVALID_KEY);if(this.transports.has(t))throw new x(`There is already a transport with the tag ${t}`,ow.ERR_DUPLICATE_TRANSPORT);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const t=n.pop();null!=t&&e.push(t.close())}await Promise.all(e),this.log("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(null==n)throw new x(`No transport available for address ${String(e)}`,ow.ERR_TRANSPORT_UNAVAILABLE);t?.onProgress?.(new Fe("transport-manager:selected-transport",n[Symbol.toStringTag]));try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(e){throw null==e.code&&(e.code=ow.ERR_TRANSPORT_DIAL_FAILED),e}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new x("Not started",ow.ERR_NODE_NOT_STARTED);if(null==e||0===e.length)return void this.log("no addresses were provided for listening, this node is dial only");const t=[];for(const[n,r]of this.transports.entries()){const i=r.listenFilter(e),o=[];for(const e of i){this.log("creating listener for %s on %a",n,e);const t=r.createListener({upgrader:this.components.upgrader});let i=this.listeners.get(n)??[];null==i&&(i=[],this.listeners.set(n,i)),i.push(t),t.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:t})}),t.addEventListener("close",()=>{const e=i.findIndex(e=>e===t);i.splice(e,1),this.components.events.safeDispatchEvent("transport:close",{detail:t})}),o.push(t.listen(e))}if(0===o.length){t.push(n);continue}const s=(await Promise.allSettled(o)).find(e=>"fulfilled"===e.status);if(null==s&&this.faultTolerance!==Yy.NO_FATAL)throw new x(`Transport (${n}) could not listen on any available address`,ow.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const e=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===Yy.FATAL_ALL)throw new x(e,ow.ERR_NO_VALID_ADDRESSES);this.log(`libp2p in dial mode only: ${e}`)}}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const e=t.pop();null!=e&&n.push(e.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}class fb extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class pb extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class gb extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function mb(e,t={}){const n=jw(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=se(t.maxDataLength));const r=t?.lengthDecoder??ue,i=t?.lengthEncoder??ce,o={read:async e=>{let i=-1;const o=new me;for(;;){o.append(await n.read(1,e));try{i=r(o)}catch(e){if(e instanceof RangeError)continue;throw e}if(i<0)throw new fb("Invalid message length");if(null!=t?.maxLengthLength&&o.byteLength>t.maxLengthLength)throw new gb("message length length too long");if(i>-1)break}if(null!=t?.maxDataLength&&i>t.maxDataLength)throw new pb("message length too long");return n.read(i,e)},write:async(e,t)=>{await n.write(new me(i(e.byteLength),e),t)},writeV:async(e,t)=>{const r=new me(...e.flatMap(e=>[i(e.byteLength),e]));await n.write(r,t)},unwrap:()=>n.unwrap()};return o}const yb="/multistream/1.0.0",wb=1024,bb=Hn("\n");async function vb(e,t,n){await e.write(t,n)}async function Eb(e,t){const n=await async function(e,t){const n=await e.read(t);if(0===n.byteLength||n.get(n.byteLength-1)!==bb[0])throw t.log.error("Invalid mss message - missing newline",n),new x("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return n.sublist(0,-1)}(e,t);return Ir(n.subarray())}async function Sb(e,t,n){t=Array.isArray(t)?t:[t],n.log.trace("handle: available protocols %s",t);const r=mb(e,{...n,maxDataLength:wb,maxLengthLength:2});for(;;){n.log.trace("handle: reading incoming string");const e=await Eb(r,n);if(n.log.trace('handle: read "%s"',e),e!==yb){if(t.includes(e))return n.log.trace('handle: respond with "%s" for "%s"',e,e),await vb(r,Hn(`${e}\n`),n),n.log.trace('handle: responded with "%s" for "%s"',e,e),{stream:r.unwrap(),protocol:e};if("ls"===e){const i=new me(...t.map(e=>be.single(Hn(`${e}\n`))),Hn("\n"));n.log.trace('handle: respond with "%s" for %s',t,e),await vb(r,i,n),n.log.trace('handle: responded with "%s" for %s',t,e);continue}n.log('handle: respond with "na" for "%s"',e),await vb(r,Hn("na\n"),n),n.log('handle: responded with "na" for "%s"',e)}else n.log.trace('handle: respond with "%s" for "%s"',yb,e),await vb(r,Hn(`${yb}\n`),n),n.log.trace('handle: responded with "%s" for "%s"',yb,e)}}async function kb(e,t,n){if(1===(t=Array.isArray(t)?[...t]:[t]).length&&!1===n.negotiateFully)return function(e,t,n){const r=e.sink.bind(e),i=e.source;let o=!1,s=!1;const a=D();let l=!1,c=!1;const u=D();let d=!1,h=!1;const f=D(),p=mb({sink:r,source:i},{...n,maxDataLength:wb});async function g(){if(s)return n.log.trace("optimistic: already negotiating %s stream",t),void await a.promise;s=!0;try{l||(n.log.trace("optimistic: doing send protocol for %s stream",t),await async function(){if(c)await u.promise;else{c=!0;try{n.log.trace('optimistic: write ["%s", "%s", data] in source',yb,t),await p.writeV([Hn(`${yb}\n`),Hn(`${t}\n`)]),n.log.trace('optimistic: wrote ["%s", "%s", data] in source',yb,t)}finally{l=!0,c=!1,u.resolve()}}}()),d||(n.log.trace("optimistic: doing read protocol for %s stream",t),await async function(){if(h)await f.promise;else{h=!0;try{n.log.trace("optimistic: reading multistream select header");let e=await Eb(p,n);if(n.log.trace('optimistic: read multistream select header "%s"',e),e===yb&&(e=await Eb(p,n)),n.log.trace('optimistic: read protocol "%s", expecting "%s"',e,t),e!==t)throw new x("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{d=!0,h=!1,f.resolve()}}}())}finally{s=!1,o=!0,a.resolve()}}if(e.sink=async e=>{const{sink:r}=p.unwrap();await r(async function*(){let r=!1;for await(const i of e){if(c&&await u.promise,l)yield i;else{c=!0,n.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',yb,t,i.byteLength);const e=`${t}\n`;yield new me(Uint8Array.from([19]),Hn(`${yb}\n`),ce(e.length),Hn(e),i).subarray(),n.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',yb,t,i.byteLength),l=!0,c=!1,u.resolve(),g().catch(e=>{n.log.error("could not finish optimistic protocol negotiation of %s",t,e)})}r=!0}r||await g()}())},e.source=async function*(){await g(),n.log.trace('optimistic: reading data from "%s" stream',t),yield*p.unwrap().source}(),null!=e.closeRead){const t=e.closeRead.bind(e);e.closeRead=async e=>{o||await g().catch(e=>{n.log.error("could not negotiate protocol before close read",e)}),await t(e)}}if(null!=e.closeWrite){const t=e.closeWrite.bind(e);e.closeWrite=async e=>{o||await g().catch(e=>{n.log.error("could not negotiate protocol before close write",e)}),await t(e)}}if(null!=e.close){const t=e.close.bind(e);e.close=async e=>{const n=[];c&&n.push(u.promise),h&&n.push(f.promise),n.length>0?await H(Promise.all(n),e?.signal):(o=!0,s=!1,a.resolve()),await t(e)}}return{stream:e,protocol:t}}(e,t[0],n);const r=mb(e,{...n,maxDataLength:wb}),i=t.shift();if(null==i)throw new Error("At least one protocol must be specified");n.log.trace('select: write ["%s", "%s"]',yb,i);const o=Hn(`${yb}\n`),s=Hn(`${i}\n`);await async function(e,t,n){await e.writeV(t,n)}(r,[o,s],n),n.log.trace("select: reading multistream-select header");let a=await Eb(r,n);if(n.log.trace('select: read "%s"',a),a===yb&&(n.log.trace("select: reading protocol response"),a=await Eb(r,n),n.log.trace('select: read "%s"',a)),a===i)return{stream:r.unwrap(),protocol:i};for(const e of t){n.log.trace('select: write "%s"',e),await vb(r,Hn(`${e}\n`),n),n.log.trace("select: reading protocol response");const t=await Eb(r,n);if(n.log.trace('select: read "%s" for "%s"',t,e),t===e)return{stream:r.unwrap(),protocol:e}}throw new x("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}const _b=Symbol.for("@libp2p/connection");class Rb{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;transient;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:n,newStream:r,close:i,abort:o,getStreams:s}=e;this.id=`${parseInt(String(1e9*Math.random())).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=e.transient??!1,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),null==this.remoteAddr.getPeerId()&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=r,this._close=i,this._abort=o,this._getStreams=s,this.tags=[]}[Symbol.toStringTag]="Connection";[_b]=!0;get streams(){return this._getStreams()}async newStream(e,t){if("closing"===this.status)throw new x("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if("closed"===this.status)throw new x("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&!0!==t?.runOnTransientConnection)throw new x("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if("closed"!==this.status&&"closing"!==this.status){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",null==e.signal){const t=AbortSignal.timeout(500);e={...e,signal:t}}try{this.log.trace("closing all streams"),await Promise.all(this.streams.map(async t=>t.close(e))),this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(e){this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach(t=>{t.abort(e)}),this.log.error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}}function Ib(e,t,n){let r=0;return n.streams.forEach(n=>{n.direction===t&&n.protocol===e&&r++}),r}class Ab{components;connectionEncryption;muxers;inboundUpgradeTimeout;events;constructor(e,t){this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(e=>{this.connectionEncryption.set(e.protocol,e)}),this.muxers=new Map,t.muxers.forEach(e=>{this.muxers.set(e.protocol,e)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??2e3,this.events=e.events}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,t,n){const r=this.components.connectionGater[n];if(void 0!==r&&await r(e,t))throw new x(`The multiaddr connection is blocked by gater.${n}`,ow.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new x("connection denied",ow.ERR_CONNECTION_DENIED);let n,r,i,o,s;const a=AbortSignal.timeout(this.inboundUpgradeTimeout),l=()=>{e.abort(new x("inbound upgrade timeout",C))};a.addEventListener("abort",l,{once:!0});try{if(!0===await(this.components.connectionGater.denyInboundConnection?.(e)))throw new x("The multiaddr connection is blocked by gater.acceptConnection",ow.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),e.log("starting the inbound connection upgrade");let a=e;if(!0!==t?.skipProtection){const t=this.components.connectionProtector;null!=t&&(e.log("protecting the inbound connection"),a=await t.protect(e))}try{if(n=a,!0!==t?.skipEncryption){t?.onProgress?.(new Fe("upgrader:encrypt-inbound-connection")),({conn:n,remotePeer:r,protocol:s}=await this._encryptInbound(a));const e={...a,...n};await this.shouldBlockConnection(r,e,"denyInboundEncryptedConnection")}else{const t=e.remoteAddr.getPeerId();if(null==t)throw new x("inbound connection that skipped encryption must have a peer id",ow.ERR_INVALID_MULTIADDR);const n=Br(t);s="native",r=n}if(i=n,null!=t?.muxerFactory)o=t.muxerFactory;else if(this.muxers.size>0){t?.onProgress?.(new Fe("upgrader:multiplex-inbound-connection"));const e=await this._multiplexInbound({...a,...n},this.muxers);o=e.muxerFactory,i=e.stream}}catch(t){throw e.log.error("failed to upgrade inbound connection",t),t}return await this.shouldBlockConnection(r,e,"denyInboundUpgradedConnection"),e.log("successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:s,direction:"inbound",maConn:e,upgradedConn:i,muxerFactory:o,remotePeer:r,transient:t?.transient})}finally{a.removeEventListener("abort",l),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){const n=e.remoteAddr.getPeerId();let r,i,o,s,a,l;null!=n&&(r=Br(n),await this.shouldBlockConnection(r,e,"denyOutboundConnection")),this.components.metrics?.trackMultiaddrConnection(e),e.log("starting the outbound connection upgrade");let c=e;if(!0!==t?.skipProtection){const t=this.components.connectionProtector;null!=t&&(c=await t.protect(e))}try{if(i=c,!0!==t?.skipEncryption){({conn:i,remotePeer:o,protocol:a}=await this._encryptOutbound(c,r));const e={...c,...i};await this.shouldBlockConnection(o,e,"denyOutboundEncryptedConnection")}else{if(null==r)throw new x("Encryption was skipped but no peer id was passed",ow.ERR_INVALID_PEER);a="native",o=r}if(s=i,null!=t?.muxerFactory)l=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexOutbound({...c,...i},this.muxers);l=e.muxerFactory,s=e.stream}}catch(t){throw e.log.error("failed to upgrade outbound connection",t),await e.close(t),t}return await this.shouldBlockConnection(o,e,"denyOutboundUpgradedConnection"),e.log("successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:a,direction:"outbound",maConn:e,upgradedConn:s,muxerFactory:l,remotePeer:o,transient:t?.transient})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:r,upgradedConn:i,remotePeer:o,muxerFactory:s,transient:a}=e;let l,c,u;null!=s&&(l=s.createStreamMuxer({direction:n,onIncomingStream:e=>{null!=u&&Promise.resolve().then(async()=>{const t=this.components.registrar.getProtocols(),{stream:n,protocol:r}=await Sb(e,t,{log:e.log,yieldBytes:!1});if(null==u)return;u.log("incoming stream opened on %s",r);const i=function(e,t){try{const{options:n}=t.getHandler(e);return n.maxInboundStreams}catch(e){if(e.code!==ow.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return 32}(r,this.components.registrar);if(Ib(r,"inbound",u)===i){const t=new x(`Too many inbound protocol streams for protocol "${r}" - limit ${i}`,ow.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw e.abort(t),t}e.source=n.source,e.sink=n.sink,e.protocol=r,null!=n.closeWrite&&(e.closeWrite=n.closeWrite),null!=n.closeRead&&(e.closeRead=n.closeRead),null!=n.close&&(e.close=n.close),await this.components.peerStore.merge(o,{protocols:[r]}),this.components.metrics?.trackProtocolStream(e,u),this._onStream({connection:u,stream:e,protocol:r})}).catch(async t=>{u.log.error("error handling incoming stream id %s",e.id,t.message,t.code,t.stack),null==e.timeline.close&&await e.close()})}}),c=async(e,t={})=>{if(null==l)throw new x("Stream is not multiplexed",ow.ERR_MUXER_UNAVAILABLE);u.log("starting new stream for protocols %s",e);const n=await l.newStream();u.log.trace("started new stream %s for protocols %s",n.id,e);try{if(null==t.signal){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const r=AbortSignal.timeout(3e4);t={...t,signal:r}}n.log.trace("selecting protocol from protocols %s",e);const{stream:r,protocol:i}=await kb(n,e,{...t,log:n.log,yieldBytes:!0});n.log("selected protocol %s",i);const s=function(e,t,n={}){try{const{options:n}=t.getHandler(e);if(null!=n.maxOutboundStreams)return n.maxOutboundStreams}catch(e){if(e.code!==ow.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return n.maxOutboundStreams??64}(i,this.components.registrar,t),a=Ib(i,"outbound",u);if(a>=s){const e=new x(`Too many outbound protocol streams for protocol "${i}" - ${a}/${s}`,ow.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw n.abort(e),e}return await this.components.peerStore.merge(o,{protocols:[i]}),n.source=r.source,n.sink=r.sink,n.protocol=i,null!=r.closeWrite&&(n.closeWrite=r.closeWrite),null!=r.closeRead&&(n.closeRead=r.closeRead),null!=r.close&&(n.close=r.close),this.components.metrics?.trackProtocolStream(n,u),n}catch(t){if(u.log.error("could not create new stream for protocols %s",e,t),null==n.timeline.close&&n.abort(t),null!=t.code)throw t;throw new x(String(t),ow.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(e=>{u.log.error("error piping data through muxer",e)}));const d=r.timeline;var h;return r.timeline=new Proxy(d,{set:(...e)=>(null!=u&&"close"===e[1]&&null!=e[2]&&null==d.close&&(async()=>{try{"open"===u.status&&await u.close()}catch(e){u.log.error("error closing connection after timeline close",e)}finally{this.events.safeDispatchEvent("connection:close",{detail:u})}})().catch(e=>{u.log.error("error thrown while dispatching connection:close event",e)}),Reflect.set(...e))}),r.timeline.upgraded=Date.now(),h={remoteAddr:r.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:r.timeline,multiplexer:l?.protocol,encryption:t,transient:a,logger:this.components.logger,newStream:c??(()=>{throw new x("connection is not multiplexed",ow.ERR_CONNECTION_NOT_MULTIPLEXED)}),getStreams:()=>null!=l?l.streams:[],close:async e=>{null!=l&&(u.log.trace("close muxer"),await l.close(e)),u.log.trace("close maconn"),await r.close(e),u.log.trace("closed maconn")},abort:e=>{r.abort(e),null!=l&&l.abort(e)}},u=new Rb(h),this.events.safeDispatchEvent("connection:open",{detail:u}),u}_onStream(e){const{connection:t,stream:n,protocol:r}=e,{handler:i,options:o}=this.components.registrar.getHandler(r);if(t.transient&&!0!==o.runOnTransientConnection)throw new x("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");i({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());e.log("handling inbound crypto protocol selection",t);try{const{stream:n,protocol:r}=await Sb(e,t,{log:e.log}),i=this.connectionEncryption.get(r);if(null==i)throw new Error(`no crypto module found for ${r}`);return e.log("encrypting inbound connection using",r),{...await i.secureInbound(this.components.peerId,n),protocol:r}}catch(t){throw e.log.error("encrypting inbound connection failed",t),new x(t.message,ow.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());e.log("selecting outbound crypto protocol",n);try{e.log.trace("selecting encrypter from %s",n);const{stream:r,protocol:i}=await kb(e,n,{log:e.log,yieldBytes:!0}),o=this.connectionEncryption.get(i);if(null==o)throw new Error(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %p using %s",t,o),{...await o.secureOutbound(this.components.peerId,r,t),protocol:i}}catch(n){throw e.log.error("encrypting outbound connection to %p failed",t,n),new x(n.message,ow.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());e.log("outbound selecting muxer %s",n);try{e.log.trace("selecting stream muxer from %s",n);const{stream:r,protocol:i}=await kb(e,n,{log:e.log,yieldBytes:!0});return e.log("selected %s as muxer protocol",i),{stream:r,muxerFactory:t.get(i)}}catch(t){throw e.log.error("error multiplexing outbound connection",t),new x(String(t),ow.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());e.log("inbound handling muxers %s",n);try{const{stream:r,protocol:i}=await Sb(e,n,{log:e.log});return{stream:r,muxerFactory:t.get(i)}}catch(t){throw e.log.error("error multiplexing inbound connection",t),new x(String(t),ow.ERR_MUXER_UNAVAILABLE)}}}const xb="1.9.4",Tb="libp2p";class Cb extends R{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new R,n=t.dispatchEvent.bind(t);t.dispatchEvent=e=>{const t=n(e),r=this.dispatchEvent(new I(e.type,{detail:e.detail}));return t||r},this.peerId=e.peerId,this.logger=e.logger??ha(),this.log=this.logger.forComponent("libp2p"),this.services={};const r=this.components=function(e={}){const t=new Vy(e);return new Proxy(t,{get(e,n,r){if("string"==typeof n&&!Hy.includes(n)){const e=t.components[n];if(null==e&&!$y.includes(n))throw new x(`${n} not set`,"ERR_SERVICE_MISSING");return e}return Reflect.get(e,n,r)},set:(e,n,r)=>("string"==typeof n?t.components[n]=r:Reflect.set(e,n,r),!0)})}({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:e.nodeInfo??{name:Tb,version:xb},logger:this.logger,events:t,datastore:e.datastore??new ka,connectionGater:Wy(e.connectionGater),dns:e.dns});this.peerStore=this.configureComponent("peerStore",new My(r,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),null!=e.metrics&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),r.events.addEventListener("peer:update",e=>{if(null==e.detail.previous){const t={id:e.detail.peer.id,multiaddrs:e.detail.peer.addresses.map(e=>e.multiaddr)};r.events.safeDispatchEvent("peer:discovery",{detail:t})}}),null!=e.connectionProtector&&this.configureComponent("connectionProtector",e.connectionProtector(r)),this.components.upgrader=new Ab(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((e,t)=>this.configureComponent(`connection-encryption-${t}`,e(this.components))),muxers:(e.streamMuxers??[]).map((e,t)=>this.configureComponent(`stream-muxers-${t}`,e(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout}),this.configureComponent("transportManager",new hb(this.components,e.transportManager)),this.configureComponent("connectionManager",new Fw(this.components,e.connectionManager)),!1!==e.connectionMonitor?.enabled&&this.configureComponent("connectionMonitor",new Ww(this.components,e.connectionMonitor)),this.configureComponent("registrar",new db(this.components)),this.configureComponent("addressManager",new zy(this.components,e.addresses));const i=(e.peerRouters??[]).map((e,t)=>this.configureComponent(`peer-router-${t}`,e(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new cb(this.components,{routers:i}));const o=(e.contentRouters??[]).map((e,t)=>this.configureComponent(`content-router-${t}`,e(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new Gw(this.components,{routers:o})),this.configureComponent("randomWalk",new ub(this.components)),(e.peerDiscovery??[]).forEach((e,t)=>{this.configureComponent(`peer-discovery-${t}`,e(this.components)).addEventListener("peer",e=>{this.#V(e)})}),e.transports?.forEach((e,t)=>{this.components.transportManager.add(this.configureComponent(`transport-${t}`,e(this.components)))}),null!=e.services)for(const t of Object.keys(e.services)){const n=(0,e.services[t])(this.components);null!=n?(this.services[t]=n,this.configureComponent(t,n),null!=n[_a]&&(this.log("registering service %s for content routing",t),o.push(n[_a])),null!=n[Ra]&&(this.log("registering service %s for peer routing",t),i.push(n[Ra])),null!=n[py]&&(this.log("registering service %s for peer discovery",t),n[py].addEventListener?.("peer",e=>{this.#V(e)}))):this.log.error("service factory %s returned null or undefined instance",t)}!function(e){const t={};for(const n of Object.values(e.components))for(const e of Ky(n))t[e]=!0;for(const n of Object.values(e.components))for(const e of qy(n))if(!0!==t[e])throw new x(`Service "${jy(n)}" required capability "${e}" but it was not provided by any component, you may need to add additional configuration when creating your node.`,"ERR_UNMET_SERVICE_DEPENDENCIES")}(r)}configureComponent(e,t){return null==t&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if("stopped"===this.status){this.status="starting",this.log("libp2p is starting");try{await(this.components.beforeStart?.()),await this.components.start(),await(this.components.afterStart?.()),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){"started"===this.status&&(this.log("libp2p is stopping"),this.status="stopping",await(this.components.beforeStop?.()),await this.components.stop(),await(this.components.afterStop?.()),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new gy;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(null==t)throw new x("no protocols were provided to open a stream",ow.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(0===(t=Array.isArray(t)?t:[t]).length)throw new x("no protocols were provided to open a stream",ow.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){jo(e)&&(e=Br(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),null!=e.publicKey)return e.publicKey;try{const t=await this.peerStore.get(e);if(null!=t.id.publicKey)return t.id.publicKey}catch(e){if(e.code!==ow.ERR_NOT_FOUND)throw e}const n=de([Hn("/pk/"),e.multihash.digest]),r=await this.contentRouting.get(n,t);return Qm(r),await this.peerStore.patch(e,{publicKey:r}),r}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async e=>{await this.components.registrar.handle(e,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async e=>{await this.components.registrar.unhandle(e)}))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#V(e){const{detail:t}=e;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(e=>{this.log.error(e)}):this.log.error(new Error(ow.ERR_DISCOVERED_SELF))}}async function Nb(e={}){const t=e.peerId??=await(async()=>{const e=await Ym("Ed25519"),t=await async function(e){return Mr(Xm(e.public),(t=e,Gm(n=(n??"rsa").toLowerCase()),t.bytes));var t,n}(e);if("Ed25519"===t.type)return t;throw new Error(`Generated unexpected PeerId type "${t.type}"`)})();if(null==t.privateKey)throw new x("peer id was missing private key","ERR_MISSING_PRIVATE_KEY");return e.privateKey??=await Zm(t.privateKey),new Cb(await async function(e){const t=ny(sw,e);if(null===t.connectionProtector&&null!=globalThis.process?.env?.LIBP2P_FORCE_PNET)throw new x(iw.ERR_PROTECTOR_REQUIRED,ow.ERR_PROTECTOR_REQUIRED);if(null!=t.privateKey&&!(await Mr(t.privateKey.public.bytes,t.privateKey.bytes)).equals(t.peerId))throw new x("Private key doesn't match peer id",ow.ERR_INVALID_KEY);return t}(e))}function Db(){const e=D();let t=!1;return{sink:async n=>{if(t)throw new Error("already piped");t=!0,e.resolve(n)},source:async function*(){const t=await e.promise;yield*t}()}}const Pb=65535,Lb=Boolean(globalThis.process?.env?.DUMP_SESSION_KEYS);function Bb(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function Ob(e){if("boolean"!=typeof e)throw new Error(`boolean expected, not ${e}`)}function Mb(e){return e instanceof Uint8Array||null!=e&&"object"==typeof e&&"Uint8Array"===e.constructor.name}function Ub(e,...t){if(!Mb(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function Fb(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}const zb=e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4));if(68!==new Uint8Array(new Uint32Array([287454020]).buffer)[0])throw new Error("Non little-endian hardware is not supported");function Vb(e){if("string"==typeof e)e=function(e){if("string"!=typeof e)throw new Error("string expected, got "+typeof e);return new Uint8Array((new TextEncoder).encode(e))}(e);else{if(!Mb(e))throw new Error("Uint8Array expected, got "+typeof e);e=Kb(e)}return e}const $b=(e,t)=>(Object.assign(t,e),t);function Hb(e,t,n,r){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,n,r);const i=BigInt(32),o=BigInt(4294967295),s=Number(n>>i&o),a=Number(n&o),l=r?4:0,c=r?0:4;e.setUint32(t+l,s,r),e.setUint32(t+c,a,r)}function Kb(e){return Uint8Array.from(e)}function qb(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}const jb=e=>Uint8Array.from(e.split("").map(e=>e.charCodeAt(0))),Wb=jb("expand 16-byte k"),Gb=jb("expand 32-byte k"),Yb=zb(Wb),Qb=zb(Gb);function Xb(e,t){return e<<t|e>>>32-t}function Zb(e){return e.byteOffset%4==0}Qb.slice();const Jb=2**32-1,ev=new Uint32Array;function tv(e,t){const{allowShortKeys:n,extendNonceFn:r,counterLength:i,counterRight:o,rounds:s}=function(e,t){if(null==t||"object"!=typeof t)throw new Error("options must be defined");return Object.assign({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t)}(0,t);if("function"!=typeof e)throw new Error("core must be a function");return Bb(i),Bb(s),Ob(o),Ob(n),(t,a,l,c,u=0)=>{Ub(t),Ub(a),Ub(l);const d=l.length;if(void 0===c&&(c=new Uint8Array(d)),Ub(c),Bb(u),u<0||u>=Jb)throw new Error("arx: counter overflow");if(c.length<d)throw new Error(`arx: output (${c.length}) is shorter than data (${d})`);const h=[];let f,p,g=t.length;if(32===g)h.push(f=Kb(t)),p=Qb;else{if(16!==g||!n)throw new Error(`arx: invalid 32-byte key, got length=${g}`);f=new Uint8Array(32),f.set(t),f.set(t,16),p=Yb,h.push(f)}Zb(a)||h.push(a=Kb(a));const m=zb(f);if(r){if(24!==a.length)throw new Error("arx: extended nonce must be 24 bytes");r(p,m,zb(a.subarray(0,16)),m),a=a.subarray(16)}const y=16-i;if(y!==a.length)throw new Error(`arx: nonce must be ${y} or 16 bytes`);if(12!==y){const e=new Uint8Array(12);e.set(a,o?0:12-a.length),a=e,h.push(a)}const w=zb(a);return function(e,t,n,r,i,o,s,a){const l=i.length,c=new Uint8Array(64),u=zb(c),d=Zb(i)&&Zb(o),h=d?zb(i):ev,f=d?zb(o):ev;for(let p=0;p<l;s++){if(e(t,n,r,u,s,a),s>=Jb)throw new Error("arx: counter overflow");const g=Math.min(64,l-p);if(d&&64===g){const e=p/4;if(p%4!=0)throw new Error("arx: invalid block position");for(let t,n=0;n<16;n++)t=e+n,f[t]=h[t]^u[n];p+=64;continue}for(let e,t=0;t<g;t++)e=p+t,o[e]=i[e]^c[t];p+=g}}(e,p,m,w,l,c,u,s),qb(...h),c}}const nv=(e,t)=>255&e[t++]|(255&e[t++])<<8;class rv{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,Ub(e=Vb(e),32);const t=nv(e,0),n=nv(e,2),r=nv(e,4),i=nv(e,6),o=nv(e,8),s=nv(e,10),a=nv(e,12),l=nv(e,14);this.r[0]=8191&t,this.r[1]=8191&(t>>>13|n<<3),this.r[2]=7939&(n>>>10|r<<6),this.r[3]=8191&(r>>>7|i<<9),this.r[4]=255&(i>>>4|o<<12),this.r[5]=o>>>1&8190,this.r[6]=8191&(o>>>14|s<<2),this.r[7]=8065&(s>>>11|a<<5),this.r[8]=8191&(a>>>8|l<<8),this.r[9]=l>>>5&127;for(let t=0;t<8;t++)this.pad[t]=nv(e,16+2*t)}process(e,t,n=!1){const r=n?0:2048,{h:i,r:o}=this,s=o[0],a=o[1],l=o[2],c=o[3],u=o[4],d=o[5],h=o[6],f=o[7],p=o[8],g=o[9],m=nv(e,t+0),y=nv(e,t+2),w=nv(e,t+4),b=nv(e,t+6),v=nv(e,t+8),E=nv(e,t+10),S=nv(e,t+12),k=nv(e,t+14);let _=i[0]+(8191&m),R=i[1]+(8191&(m>>>13|y<<3)),I=i[2]+(8191&(y>>>10|w<<6)),A=i[3]+(8191&(w>>>7|b<<9)),x=i[4]+(8191&(b>>>4|v<<12)),T=i[5]+(v>>>1&8191),C=i[6]+(8191&(v>>>14|E<<2)),N=i[7]+(8191&(E>>>11|S<<5)),D=i[8]+(8191&(S>>>8|k<<8)),P=i[9]+(k>>>5|r),L=0,B=L+_*s+R*(5*g)+I*(5*p)+A*(5*f)+x*(5*h);L=B>>>13,B&=8191,B+=T*(5*d)+C*(5*u)+N*(5*c)+D*(5*l)+P*(5*a),L+=B>>>13,B&=8191;let O=L+_*a+R*s+I*(5*g)+A*(5*p)+x*(5*f);L=O>>>13,O&=8191,O+=T*(5*h)+C*(5*d)+N*(5*u)+D*(5*c)+P*(5*l),L+=O>>>13,O&=8191;let M=L+_*l+R*a+I*s+A*(5*g)+x*(5*p);L=M>>>13,M&=8191,M+=T*(5*f)+C*(5*h)+N*(5*d)+D*(5*u)+P*(5*c),L+=M>>>13,M&=8191;let U=L+_*c+R*l+I*a+A*s+x*(5*g);L=U>>>13,U&=8191,U+=T*(5*p)+C*(5*f)+N*(5*h)+D*(5*d)+P*(5*u),L+=U>>>13,U&=8191;let F=L+_*u+R*c+I*l+A*a+x*s;L=F>>>13,F&=8191,F+=T*(5*g)+C*(5*p)+N*(5*f)+D*(5*h)+P*(5*d),L+=F>>>13,F&=8191;let z=L+_*d+R*u+I*c+A*l+x*a;L=z>>>13,z&=8191,z+=T*s+C*(5*g)+N*(5*p)+D*(5*f)+P*(5*h),L+=z>>>13,z&=8191;let V=L+_*h+R*d+I*u+A*c+x*l;L=V>>>13,V&=8191,V+=T*a+C*s+N*(5*g)+D*(5*p)+P*(5*f),L+=V>>>13,V&=8191;let $=L+_*f+R*h+I*d+A*u+x*c;L=$>>>13,$&=8191,$+=T*l+C*a+N*s+D*(5*g)+P*(5*p),L+=$>>>13,$&=8191;let H=L+_*p+R*f+I*h+A*d+x*u;L=H>>>13,H&=8191,H+=T*c+C*l+N*a+D*s+P*(5*g),L+=H>>>13,H&=8191;let K=L+_*g+R*p+I*f+A*h+x*d;L=K>>>13,K&=8191,K+=T*u+C*c+N*l+D*a+P*s,L+=K>>>13,K&=8191,L=(L<<2)+L|0,L=L+B|0,B=8191&L,L>>>=13,O+=L,i[0]=B,i[1]=O,i[2]=M,i[3]=U,i[4]=F,i[5]=z,i[6]=V,i[7]=$,i[8]=H,i[9]=K}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let r=e[1]>>>13;e[1]&=8191;for(let t=2;t<10;t++)e[t]+=r,r=e[t]>>>13,e[t]&=8191;e[0]+=5*r,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,n[0]=e[0]+5,r=n[0]>>>13,n[0]&=8191;for(let t=1;t<10;t++)n[t]=e[t]+r,r=n[t]>>>13,n[t]&=8191;n[9]-=8192;let i=(1^r)-1;for(let e=0;e<10;e++)n[e]&=i;i=~i;for(let t=0;t<10;t++)e[t]=e[t]&i|n[t];e[0]=65535&(e[0]|e[1]<<13),e[1]=65535&(e[1]>>>3|e[2]<<10),e[2]=65535&(e[2]>>>6|e[3]<<7),e[3]=65535&(e[3]>>>9|e[4]<<4),e[4]=65535&(e[4]>>>12|e[5]<<1|e[6]<<14),e[5]=65535&(e[6]>>>2|e[7]<<11),e[6]=65535&(e[7]>>>5|e[8]<<8),e[7]=65535&(e[8]>>>8|e[9]<<5);let o=e[0]+t[0];e[0]=65535&o;for(let n=1;n<8;n++)o=(e[n]+t[n]|0)+(o>>>16)|0,e[n]=65535&o;qb(n)}update(e){Fb(this);const{buffer:t,blockLen:n}=this,r=(e=Vb(e)).length;for(let i=0;i<r;){const o=Math.min(n-this.pos,r-i);if(o!==n)t.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0);else for(;n<=r-i;i+=n)this.process(e,i)}return this}destroy(){qb(this.h,this.r,this.buffer,this.pad)}digestInto(e){Fb(this),function(e,t){Ub(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:r}=this;if(r){for(t[r++]=1;r<16;r++)t[r]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let t=0;t<8;t++)e[i++]=n[t]>>>0,e[i++]=n[t]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}const iv=function(e){const t=(t,n)=>e(n).update(Vb(t)).digest(),n=e(new Uint8Array(32));return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=t=>e(t),t}(e=>new rv(e));function ov(e,t,n,r,i,o=20){let s=e[0],a=e[1],l=e[2],c=e[3],u=t[0],d=t[1],h=t[2],f=t[3],p=t[4],g=t[5],m=t[6],y=t[7],w=i,b=n[0],v=n[1],E=n[2],S=s,k=a,_=l,R=c,I=u,A=d,x=h,T=f,C=p,N=g,D=m,P=y,L=w,B=b,O=v,M=E;for(let e=0;e<o;e+=2)S=S+I|0,L=Xb(L^S,16),C=C+L|0,I=Xb(I^C,12),S=S+I|0,L=Xb(L^S,8),C=C+L|0,I=Xb(I^C,7),k=k+A|0,B=Xb(B^k,16),N=N+B|0,A=Xb(A^N,12),k=k+A|0,B=Xb(B^k,8),N=N+B|0,A=Xb(A^N,7),_=_+x|0,O=Xb(O^_,16),D=D+O|0,x=Xb(x^D,12),_=_+x|0,O=Xb(O^_,8),D=D+O|0,x=Xb(x^D,7),R=R+T|0,M=Xb(M^R,16),P=P+M|0,T=Xb(T^P,12),R=R+T|0,M=Xb(M^R,8),P=P+M|0,T=Xb(T^P,7),S=S+A|0,M=Xb(M^S,16),D=D+M|0,A=Xb(A^D,12),S=S+A|0,M=Xb(M^S,8),D=D+M|0,A=Xb(A^D,7),k=k+x|0,L=Xb(L^k,16),P=P+L|0,x=Xb(x^P,12),k=k+x|0,L=Xb(L^k,8),P=P+L|0,x=Xb(x^P,7),_=_+T|0,B=Xb(B^_,16),C=C+B|0,T=Xb(T^C,12),_=_+T|0,B=Xb(B^_,8),C=C+B|0,T=Xb(T^C,7),R=R+I|0,O=Xb(O^R,16),N=N+O|0,I=Xb(I^N,12),R=R+I|0,O=Xb(O^R,8),N=N+O|0,I=Xb(I^N,7);let U=0;r[U++]=s+S|0,r[U++]=a+k|0,r[U++]=l+_|0,r[U++]=c+R|0,r[U++]=u+I|0,r[U++]=d+A|0,r[U++]=h+x|0,r[U++]=f+T|0,r[U++]=p+C|0,r[U++]=g+N|0,r[U++]=m+D|0,r[U++]=y+P|0,r[U++]=w+L|0,r[U++]=b+B|0,r[U++]=v+O|0,r[U++]=E+M|0}const sv=tv(ov,{counterRight:!1,counterLength:4,allowShortKeys:!1}),av=tv(ov,{counterRight:!1,counterLength:8,extendNonceFn:function(e,t,n,r){let i=e[0],o=e[1],s=e[2],a=e[3],l=t[0],c=t[1],u=t[2],d=t[3],h=t[4],f=t[5],p=t[6],g=t[7],m=n[0],y=n[1],w=n[2],b=n[3];for(let e=0;e<20;e+=2)i=i+l|0,m=Xb(m^i,16),h=h+m|0,l=Xb(l^h,12),i=i+l|0,m=Xb(m^i,8),h=h+m|0,l=Xb(l^h,7),o=o+c|0,y=Xb(y^o,16),f=f+y|0,c=Xb(c^f,12),o=o+c|0,y=Xb(y^o,8),f=f+y|0,c=Xb(c^f,7),s=s+u|0,w=Xb(w^s,16),p=p+w|0,u=Xb(u^p,12),s=s+u|0,w=Xb(w^s,8),p=p+w|0,u=Xb(u^p,7),a=a+d|0,b=Xb(b^a,16),g=g+b|0,d=Xb(d^g,12),a=a+d|0,b=Xb(b^a,8),g=g+b|0,d=Xb(d^g,7),i=i+c|0,b=Xb(b^i,16),p=p+b|0,c=Xb(c^p,12),i=i+c|0,b=Xb(b^i,8),p=p+b|0,c=Xb(c^p,7),o=o+u|0,m=Xb(m^o,16),g=g+m|0,u=Xb(u^g,12),o=o+u|0,m=Xb(m^o,8),g=g+m|0,u=Xb(u^g,7),s=s+d|0,y=Xb(y^s,16),h=h+y|0,d=Xb(d^h,12),s=s+d|0,y=Xb(y^s,8),h=h+y|0,d=Xb(d^h,7),a=a+l|0,w=Xb(w^a,16),f=f+w|0,l=Xb(l^f,12),a=a+l|0,w=Xb(w^a,8),f=f+w|0,l=Xb(l^f,7);let v=0;r[v++]=i,r[v++]=o,r[v++]=s,r[v++]=a,r[v++]=m,r[v++]=y,r[v++]=w,r[v++]=b},allowShortKeys:!1}),lv=new Uint8Array(16),cv=(e,t)=>{e.update(t);const n=t.length%16;n&&e.update(lv.subarray(n))},uv=new Uint8Array(32);function dv(e,t,n,r,i){const o=e(t,n,uv),s=iv.create(o);i&&cv(s,i),cv(s,r);const a=new Uint8Array(16),l=(c=a,new DataView(c.buffer,c.byteOffset,c.byteLength));var c;Hb(l,0,BigInt(i?i.length:0),!0),Hb(l,8,BigInt(r.length),!0),s.update(a);const u=s.digest();return qb(o,a),u}const hv=e=>(t,n,r)=>(Ub(t,32),Ub(n),{encrypt(i,o){const s=i.length,a=s+16;o?Ub(o,a):o=new Uint8Array(a),e(t,n,i,o,1);const l=dv(e,t,n,o.subarray(0,-16),r);return o.set(l,s),qb(l),o},decrypt(i,o){const s=i.length,a=s-16;if(s<16)throw new Error("encrypted data must be at least 16 bytes");o?Ub(o,a):o=new Uint8Array(a);const l=i.subarray(0,-16),c=i.subarray(-16),u=dv(e,t,n,l,r);if(!function(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e[r]^t[r];return 0===n}(c,u))throw new Error("invalid tag");return e(t,n,l,o,1),qb(u),o}}),fv=$b({blockSize:64,nonceLength:12,tagLength:16},hv(sv));hv(av);const pv=Uint8Array.from([0]),gv=Uint8Array.of();const mv={hashSHA256:e=>zd(e.subarray()),getHKDF(e,t){const n=function(e,t,n){return Qr(e),void 0===n&&(n=new Uint8Array(e.outputLen)),ed(e,ui(n),ui(t))}(zd,t,e),r=function(e,t,n,r=32){Qr(e),Gr(r);const i=e.outputLen;if(r>255*i)throw new Error("Length should be <= 255*HashLen");const o=Math.ceil(r/i);void 0===n&&(n=gv);const s=new Uint8Array(o*i),a=ed.create(e,t),l=a._cloneInto(),c=new Uint8Array(a.outputLen);for(let e=0;e<o;e++)pv[0]=e+1,l.update(0===e?gv:c).update(n).update(pv).digestInto(c),s.set(c,i*e),a._cloneInto(l);return a.destroy(),l.destroy(),Zr(c,pv),s.slice(0,r)}(zd,n,void 0,96);return[r.subarray(0,32),r.subarray(32,64),r.subarray(64,96)]},generateX25519KeyPair(){const e=Sf.utils.randomPrivateKey();return{publicKey:Sf.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:Sf.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>Sf.getSharedSecret(e.subarray(),t.subarray()),chaCha20Poly1305Encrypt:(e,t,n,r)=>fv(r,t,n).encrypt(e.subarray()),chaCha20Poly1305Decrypt:(e,t,n,r,i)=>fv(r,t,n).decrypt(e.subarray(),i)},yv=e=>{const t=Q(2);return t[0]=e>>8,t[1]=e,t};yv.bytes=2;const wv=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");if(e instanceof Uint8Array){let t=0;return t+=e[0]<<8,t+=e[1],t}return e.getUint16(0)};function bv(e,t){t.enabled&&Lb&&(e?(t(`LOCAL_STATIC_PUBLIC_KEY ${Ir(e.publicKey,"hex")}`),t(`LOCAL_STATIC_PRIVATE_KEY ${Ir(e.privateKey,"hex")}`)):t("Missing local static keys."))}function vv(e,t){t.enabled&&Lb&&(e?(t(`LOCAL_PUBLIC_EPHEMERAL_KEY ${Ir(e.publicKey,"hex")}`),t(`LOCAL_PRIVATE_EPHEMERAL_KEY ${Ir(e.privateKey,"hex")}`)):t("Missing local ephemeral keys."))}function Ev(e,t){t.enabled&&Lb&&t(e?`REMOTE_EPHEMERAL_PUBLIC_KEY ${Ir(e.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function Sv(e,t,n){n.enabled&&Lb&&(n(`CIPHER_STATE_1 ${e.n.getUint64()} ${e.k&&Ir(e.k,"hex")}`),n(`CIPHER_STATE_2 ${t.n.getUint64()} ${t.k&&Ir(t.k,"hex")}`))}wv.bytes=2;class kv extends Error{code;constructor(e="Unexpected Peer"){super(e),this.code=kv.code}static code="ERR_UNEXPECTED_PEER"}class _v extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=_v.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}class Rv{n;bytes;view;constructor(e=0){this.n=e,this.bytes=Y(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}const Iv=Y(0);class Av{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new Rv(n)}hasKey(){return Boolean(this.k)}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const r=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),r}}class xv{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const n=Hn(t,"utf-8");this.h=function(e,t){if(t.length<=32){const e=Y(32);return e.set(t),e}return e.hash(t)}(e,n),this.ck=this.h,this.cs=new Av(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new Av(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new me(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,Iv);return[new Av(this.crypto,e),new Av(this.crypto,t)]}}class Tv{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:n,prologue:r,initiator:i,s:o,e:s,rs:a,re:l}=e;this.crypto=t,this.ss=new xv(t,n),this.ss.mixHash(r),this.initiator=i,this.s=o,this.e=s,this.rs=a,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const r=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(r),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class Cv extends Tv{writeMessageA(e){return new me(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new me(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new me(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(e){throw new _v(`handshake stage 0 validation fail: ${e.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(e){throw new _v(`handshake stage 1 validation fail: ${e.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(e){throw new _v(`handshake stage 2 validation fail: ${e.message}`)}}}var Nv,Dv;async function Pv(e,t,n){const r=await e.sign(Bv(t));return Dv.encode({identityKey:e.public.bytes,identitySig:r,extensions:n})}async function Lv(e,t,n){try{const r=Dv.decode(e);if(n){const e=n.subarray();if(!he(e,r.identityKey))throw new Error(`Payload identity key ${Ir(r.identityKey,"hex")} does not match expected remote identity key ${Ir(e,"hex")}`)}if(!t)throw new Error("Remote static does not exist");const i=Bv(t),o=Qm(r.identityKey);if(!await o.verify(i,r.identitySig))throw new Error("Invalid payload signature");return r}catch(e){throw new kv(e.message)}}function Bv(e){const t=Hn("noise-libp2p-static-key:");return e instanceof Uint8Array?de([t,e],t.length+e.length):(e.prepend(t),e)}!function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes)for(const n of e.webtransportCerthashes)t.uint32(10),t.bytes(n);!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={webtransportCerthashes:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();t>>>3==1?n.webtransportCerthashes.push(e.bytes()):e.skipType(7&t)}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(Nv||(Nv={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.identityKey&&e.identityKey.byteLength>0&&(t.uint32(10),t.bytes(e.identityKey)),null!=e.identitySig&&e.identitySig.byteLength>0&&(t.uint32(18),t.bytes(e.identitySig)),null!=e.extensions&&(t.uint32(34),Nv.codec().encode(e.extensions,t)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={identityKey:Y(0),identitySig:Y(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.identityKey=e.bytes();break;case 2:n.identitySig=e.bytes();break;case 4:n.extensions=Nv.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(Dv||(Dv={}));class Ov{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){const{staticNoiseKey:n,extensions:r,crypto:i,prologueBytes:o}=t,{metrics:s}=e;this.components=e;const a=i??mv;this.crypto=function(e){return{generateKeypair:e.generateX25519KeyPair,dh:(t,n)=>e.generateX25519SharedKey(t.privateKey,n).subarray(0,32),encrypt:e.chaCha20Poly1305Encrypt,decrypt:e.chaCha20Poly1305Decrypt,hash:e.hashSHA256,hkdf:e.getHKDF}}(a),this.extensions=r,this.metrics=s?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(s):void 0,this.staticKey=n?a.generateX25519KeyPairFromSeed(n):a.generateX25519KeyPair(),this.prologue=o??Y(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[ey]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(...e){const{localPeer:t,connection:n,remotePeer:r,signal:i}=this.parseArgs(e),o=mb(n,{lengthEncoder:yv,lengthDecoder:wv,maxDataLength:Pb});if(!t.privateKey)throw new x("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const s=await Zm(t.privateKey),a=r?.publicKey,l=await this.performHandshakeInitiator(o,s,a,{signal:i}),c=await this.createSecureConnection(o,l);return n.source=c.source,n.sink=c.sink,{conn:n,remoteExtensions:l.payload.extensions,remotePeer:await Mr(l.payload.identityKey)}}async secureInbound(...e){const{localPeer:t,connection:n,remotePeer:r,signal:i}=this.parseArgs(e),o=mb(n,{lengthEncoder:yv,lengthDecoder:wv,maxDataLength:Pb});if(!t.privateKey)throw new x("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const s=await Zm(t.privateKey),a=r?.publicKey,l=await this.performHandshakeResponder(o,s,a,{signal:i}),c=await this.createSecureConnection(o,l);return n.source=c.source,n.sink=c.sink,{conn:n,remoteExtensions:l.payload.extensions,remotePeer:await Mr(l.payload.identityKey)}}async performHandshakeInitiator(e,t,n,r){let i;try{i=await async function(e,t){const{log:n,connection:r,crypto:i,privateKey:o,prologue:s,s:a,remoteIdentityKey:l,extensions:c}=e,u=await Pv(o,a.publicKey,c),d=new Cv({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:s,s:a});bv(d.s,n),n.trace("Stage 0 - Initiator starting to send first message."),await r.write(d.writeMessageA(Iv),t),n.trace("Stage 0 - Initiator finished sending first message."),vv(d.e,n),n.trace("Stage 1 - Initiator waiting to receive first message from responder...");const h=d.readMessageB(await r.read(t));var f,p;n.trace("Stage 1 - Initiator received the message."),Ev(d.re,n),f=d.rs,(p=n).enabled&&Lb&&p(f?`REMOTE_STATIC_PUBLIC_KEY ${Ir(f.subarray(),"hex")}`:"Missing remote static public key."),n.trace("Initiator going to check remote's signature...");const g=await Lv(h,d.rs,l);n.trace("All good with the signature!"),n.trace("Stage 2 - Initiator sending third handshake message."),await r.write(d.writeMessageC(u),t),n.trace("Stage 2 - Initiator sent message with signed payload.");const[m,y]=d.ss.split();return Sv(m,y,n),{payload:g,encrypt:e=>m.encryptWithAd(Iv,e),decrypt:(e,t)=>y.decryptWithAd(Iv,e,t)}}({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},r),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return i}async performHandshakeResponder(e,t,n,r){let i;try{i=await async function(e,t){const{log:n,connection:r,crypto:i,privateKey:o,prologue:s,s:a,remoteIdentityKey:l,extensions:c}=e,u=await Pv(o,a.publicKey,c),d=new Cv({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:s,s:a});bv(d.s,n),n.trace("Stage 0 - Responder waiting to receive first message."),d.readMessageA(await r.read(t)),n.trace("Stage 0 - Responder received first message."),Ev(d.re,n),n.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await r.write(d.writeMessageB(u),t),n.trace("Stage 1 - Responder sent the second handshake message with signed payload."),vv(d.e,n),n.trace("Stage 2 - Responder waiting for third handshake message...");const h=d.readMessageC(await r.read(t));n.trace("Stage 2 - Responder received the message, finished handshake.");const f=await Lv(h,d.rs,l),[p,g]=d.ss.split();return Sv(p,g,n),{payload:f,encrypt:e=>g.encryptWithAd(Iv,e),decrypt:(e,t)=>p.decryptWithAd(Iv,e,t)}}({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},r),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return i}async createSecureConnection(e,t){const[n,r]=function(){const e=Db(),t=Db();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}(),i=e.unwrap();return await De(n,function(e,t){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=65519){let i,o=n+65519;o>r.length&&(o=r.length),i=r instanceof Uint8Array?e.encrypt(r.subarray(n,o)):e.encrypt(r.sublist(n,o)),t?.encryptedPackets.increment(),yield new me(yv(i.byteLength),i)}}}(t,this.metrics),i,e=>Ie(e,{lengthDecoder:wv}),function(e,t){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=Pb){let i=n+Pb;if(i>r.length&&(i=r.length),i-16<n)throw new Error("Invalid chunk");const o=r.sublist(n,i),s=r.subarray(n,i-16);try{const n=e.decrypt(o,s);t?.decryptedPackets.increment(),yield n}catch(e){throw t?.decryptErrors.increment(),e}}}}(t,this.metrics),n),r}parseArgs(e){return Rr(e[0])?{localPeer:e[0],connection:e[1],remotePeer:e[2]}:{localPeer:this.components.peerId,connection:e[0],remotePeer:e[1]?.remotePeer,signal:e[1]?.signal}}}function Mv(e={}){return t=>new Ov(t,e)}function Uv(e){if(null!=e){if("function"==typeof e[Symbol.iterator])return e[Symbol.iterator]();if("function"==typeof e[Symbol.asyncIterator])return e[Symbol.asyncIterator]();if("function"==typeof e.next)return e}throw new Error("argument is not an iterator or iterable")}const Fv="ERR_INVALID_FRAME",zv="ERR_UNREQUESTED_PING",Vv="ERR_NOT_MATCHING_PING",$v="ERR_STREAM_ALREADY_EXISTS",Hv="ERR_DECODE_INVALID_VERSION",Kv="ERR_BOTH_CLIENTS",qv="ERR_RECV_WINDOW_EXCEEDED",jv=new Set([Fv,zv,Vv,$v,Hv,Kv,qv]),Wv="ERR_INVALID_CONFIG",Gv="ERR_MUXER_LOCAL_CLOSED",Yv="ERR_MUXER_REMOTE_CLOSED",Qv=262144,Xv={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Qv,maxStreamWindowSize:16777216,maxMessageSize:65536};var Zv,Jv,eE;!function(e){e[e.Data=0]="Data",e[e.WindowUpdate=1]="WindowUpdate",e[e.Ping=2]="Ping",e[e.GoAway=3]="GoAway"}(Zv||(Zv={})),function(e){e[e.SYN=1]="SYN",e[e.ACK=2]="ACK",e[e.FIN=4]="FIN",e[e.RST=8]="RST"}(Jv||(Jv={})),Object.values(Jv).filter(e=>"string"!=typeof e),function(e){e[e.NormalTermination=0]="NormalTermination",e[e.ProtocolError=1]="ProtocolError",e[e.InternalError=2]="InternalError"}(eE||(eE={}));const tE=2**24;class nE{source;buffer;frameInProgress;constructor(e){this.source=function(e){if(void 0!==e[Symbol.iterator]){const t=e[Symbol.iterator]();return t.return=void 0,{[Symbol.iterator]:()=>t}}if(void 0!==e[Symbol.asyncIterator]){const t=e[Symbol.asyncIterator]();return t.return=void 0,{[Symbol.asyncIterator]:()=>t}}throw new Error("a source must be either an iterable or an async iterable")}(e),this.buffer=new me,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const e=this.readHeader();if(void 0===e)break;const{type:t,length:n}=e;t===Zv.Data?(this.frameInProgress=!0,yield{header:e,readData:this.readBytes.bind(this,n)}):yield{header:e}}}readHeader(){if(this.frameInProgress)throw new x("decoding frame already in progress","ERR_DECODE_IN_PROGRESS");if(this.buffer.length<12)return;const e=function(e){if(0!==e[0])throw new x("Invalid frame version",Hv);return{type:e[1],flag:(e[2]<<8)+e[3],streamID:e[4]*tE+(e[5]<<16)+(e[6]<<8)+e[7],length:e[8]*tE+(e[9]<<16)+(e[10]<<8)+e[11]}}(this.buffer.subarray(0,12));return this.buffer.consume(12),e}async readBytes(e){if(this.buffer.length<e)for await(const t of this.source)if(this.buffer.append(t),this.buffer.length>=e)break;const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}}function rE(e){const t=new Uint8Array(12);return t[1]=e.type,t[2]=e.flag>>>8,t[3]=e.flag,t[4]=e.streamID>>>24,t[5]=e.streamID>>>16,t[6]=e.streamID>>>8,t[7]=e.streamID,t[8]=e.length>>>24,t[9]=e.length>>>16,t[10]=e.length>>>8,t[11]=e.length,t}function iE(e,t){const n=Uv(e).return?.();var r;null!=(r=n)&&"function"==typeof r.then&&"function"==typeof r.catch&&"function"==typeof r.finally&&n.catch(e=>{t.error("could not cause iterator to return",e)})}function oE(e){return null!=e&&"function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally}class sE{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=D(),this.closed=D(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??5e3,this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=O({onEnd:e=>{null!=e?this.log.trace("source ended with error",e):this.log.trace("source ended"),this.onSourceEnd(e)}}),this.sink=this.sink.bind(this)}async sink(e){if("ready"!==this.writeStatus)throw new x(`writable end state is "${this.writeStatus}" not "ready"`,"ERR_SINK_INVALID_STATE");try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if("outbound"===this.direction){const e=this.sendNewStream(t);oE(e)&&await e}const n=()=>{iE(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let n of e){n=n instanceof Uint8Array?new me(n):n;const e=this.sendData(n,t);oE(e)&&(this.sendingData=D(),await e,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),"writing"===this.writeStatus&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(e){throw this.log.trace("sink ended with error, calling abort with error",e),this.abort(e),e}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){null==this.timeline.closeRead&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",null!=e&&null==this.endErr&&(this.endErr=e),this.onCloseRead?.(),null!=this.timeline.closeWrite?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),"aborted"!==this.status&&"reset"!==this.status&&(this.status="closed"),null!=this.onEnd&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){null==this.timeline.closeWrite&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",null!=e&&null==this.endErr&&(this.endErr=e),this.onCloseWrite?.(),null!=this.timeline.closeRead?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),"aborted"!==this.status&&"reset"!==this.status&&(this.status="closed"),null!=this.onEnd&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await H(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if("closing"===this.readStatus||"closed"===this.readStatus)return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing","reset"!==this.status&&"aborted"!==this.status&&null==this.timeline.closeRead&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),"ready"===t&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){"closing"!==this.writeStatus&&"closed"!==this.writeStatus&&(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),"ready"===this.writeStatus&&(this.log.trace("sink was never sunk, sink an empty array"),await H(this.sink([]),e.signal)),"writing"===this.writeStatus&&(null!=this.sendingData&&await H(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await H(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if("closed"===this.status||"aborted"===this.status||"reset"===this.status)return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();oE(t)&&t.catch(e=>{this.log.error("error sending reset message",e)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if("closed"===this.status||"aborted"===this.status||"reset"===this.status)return;const e=new x("stream reset","ERR_STREAM_RESET");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){"writing"===this.writeStatus&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){"closing"!==this.readStatus&&"closed"!==this.readStatus&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){"closing"!==this.readStatus&&"closed"!==this.readStatus?(this.log.trace("remote close write"),this._closeSource()):this.log("received remote close write but local source is already closed")}remoteCloseRead(){"closing"!==this.writeStatus&&"closed"!==this.writeStatus?(this.log.trace("remote close read"),this._closeSink()):this.log("received remote close read but local sink is already closed")}destroy(){"closed"!==this.status&&"aborted"!==this.status&&"reset"!==this.status?(this.log.trace("stream destroyed"),this._closeSinkAndSource()):this.log("received destroy but we are already closed")}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var aE;!function(e){e[e.Init=0]="Init",e[e.SYNSent=1]="SYNSent",e[e.SYNReceived=2]="SYNReceived",e[e.Established=3]="Established",e[e.Finished=4]="Finished"}(aE||(aE={}));class lE extends sE{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=aE.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Qv,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=Ku(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();0!==e.byteLength;){if(0===this.sendWindowCapacity&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),"closed"===this.status||"aborted"===this.status||"reset"===this.status))return void this.log?.trace("%s while waiting for send window capacity",this.status);const n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-12,e.length),r=this.getSendFlags();this.sendFrame({type:Zv.Data,flag:r,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:Zv.WindowUpdate,flag:Jv.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Jv.FIN;this.sendFrame({type:Zv.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n;const r=()=>{"open"===this.status||"closing"===this.status?n(new x("stream aborted","ERR_STREAM_ABORT")):t()};e.signal?.addEventListener("abort",r);try{await new Promise((e,r)=>{this.sendWindowCapacityUpdate=()=>{e()},n=r,t=e})}finally{e.signal?.removeEventListener("abort",r)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,0===t&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new x("receive window exceeded",qv,{available:this.recvWindowCapacity,recv:e.length});const n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&Jv.ACK)===Jv.ACK&&this.state===aE.SYNSent&&(this.state=aE.Established),(e&Jv.FIN)===Jv.FIN&&this.remoteCloseWrite(),(e&Jv.RST)===Jv.RST&&this.reset()}getSendFlags(){switch(this.state){case aE.Init:return this.state=aE.SYNSent,Jv.SYN;case aE.SYNReceived:return this.state=aE.Established,Jv.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(0===e&&n>-1&&t-this.epochStart<4*n&&(this.recvWindow=Math.min(2*this.recvWindow,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&0===e)return;const r=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Zv.WindowUpdate,flag:e,streamID:this._id,length:r})}}const cE="/yamux/1.0.0";class uE{protocol=cE;_components;_init;constructor(e,t={}){this._components=e,this._init=t}createStreamMuxer(e){return new dE(this._components,{...this._init,...e})}}class dE{protocol=cE;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client="outbound"===t.direction,this.config={...Xv,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),function(e){if(e.keepAliveInterval<=0)throw new x("keep-alive interval must be positive",Wv);if(e.maxInboundStreams<0)throw new x("max inbound streams must be larger or equal 0",Wv);if(e.maxOutboundStreams<0)throw new x("max outbound streams must be larger or equal 0",Wv);if(e.initialStreamWindowSize<Qv)throw new x("InitialStreamWindowSize must be larger or equal 256 kB",Wv);if(e.maxStreamWindowSize<e.initialStreamWindowSize)throw new x("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Wv);if(e.maxStreamWindowSize>2**32-1)throw new x("MaxStreamWindowSize must be less than equal MAX_UINT32",Wv);if(e.maxMessageSize<1024)throw new x("MaxMessageSize must be greater than a kilobyte",Wv)}(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=O({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(e=>{e.destroy()})}}),this.sink=async e=>{const t=()=>{const t=Uv(e);if(null!=t.return){const e=t.return();null!=(n=e)&&"function"==typeof n.then&&e.catch(e=>{this.log?.("could not cause sink source to return",e)})}var n};let n,r;try{const r=new nE(e);try{this.closeController.signal.addEventListener("abort",t);for await(const e of r.emitFrames())await this.handleFrame(e.header,e.readData)}finally{this.closeController.signal.removeEventListener("abort",t)}n=eE.NormalTermination}catch(e){const t=e.code;jv.has(t)?(this.log?.error("protocol error in sink",e),n=eE.ProtocolError):(this.log?.error("internal error in sink",e),n=eE.InternalError),r=e}this.log?.trace("muxer sink ended"),null!=r?this.abort(r,n):await this.close({reason:n})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(e=>this.log?.error("keepalive error: %s",e)),this.ping().catch(e=>this.log?.error("ping error: %s",e))}get streams(){return Array.from(this._streams.values())}newStream(e){if(void 0!==this.remoteGoAway)throw new x("muxer closed remotely",Yv);if(void 0!==this.localGoAway)throw new x("muxer closed locally",Gv);const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new x("max outbound streams exceeded","ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED");this.log?.trace("new outgoing stream id=%s",t);const n=this._newStream(t,e,aE.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(void 0!==this.remoteGoAway)throw new x("muxer closed remotely",Yv);if(void 0!==this.localGoAway)throw new x("muxer closed locally",Gv);if(void 0===this.activePing){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((t,n)=>{const r=()=>{n(new x("muxer closed locally",Gv))};this.closeController.signal.addEventListener("abort",r,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",r),t()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;const t=e?.reason??eE.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),null==e.signal){const t=AbortSignal.timeout(500);e={...e,signal:t}}try{await Promise.all([...this._streams.values()].map(async t=>t.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(e){this.abort(e)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??eE.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(const t of this._streams.values())t.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,r){if(null!=this._streams.get(e))throw new x("Stream already exists",$v,{id:e});const i=new lE({id:e.toString(),name:t,state:n,direction:r,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${r}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2==0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){const e=new Promise((e,t)=>{this.closeController.signal.addEventListener("abort",t,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(e=>{t=setTimeout(e,this.config.keepAliveInterval)})]),this.ping().catch(e=>this.log?.error("ping error: %s",e))}catch(e){return void clearInterval(t)}}}async handleFrame(e,t){const{streamID:n,type:r,length:i}=e;if(this.log?.trace("received frame %o",e),0===n)switch(r){case Zv.Ping:return void this.handlePing(e);case Zv.GoAway:return void this.handleGoAway(i);default:throw new x("Invalid frame type",Fv,{header:e})}else switch(e.type){case Zv.Data:case Zv.WindowUpdate:return void await this.handleStreamMessage(e,t);default:throw new x("Invalid frame type",Fv,{header:e})}}handlePing(e){if(e.flag===Jv.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Jv.ACK);else{if(e.flag!==Jv.ACK)throw new x("Invalid frame flag",Fv,{header:e});this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length)}}handlePingResponse(e){if(void 0===this.activePing)throw new x("ping not requested",zv);if(this.activePing.id!==e)throw new x("ping doesn't match our id",Vv);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",eE[e]??"unknown"),this.remoteGoAway=e;for(const e of this._streams.values())e.reset();this._closeMuxer()}async handleStreamMessage(e,t){const{streamID:n,flag:r,type:i}=e;(r&Jv.SYN)===Jv.SYN&&this.incomingStream(n);const o=this._streams.get(n);if(void 0!==o)switch(i){case Zv.WindowUpdate:return void o.handleWindowUpdate(e);case Zv.Data:if(void 0===t)throw new Error("unreachable");return void await o.handleData(e,t);default:throw new Error("unreachable")}else if(i===Zv.Data){if(this.log?.("discarding data for stream id=%s",n),void 0===t)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",n)}incomingStream(e){if(this.client!==(e%2==0))throw new x("both endpoints are clients",Kv);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),void 0!==this.localGoAway)return void this.sendFrame({type:Zv.WindowUpdate,flag:Jv.RST,streamID:e,length:0});if(this.numInboundStreams>=this.config.maxInboundStreams)return this.log?.("maxIncomingStreams exceeded, forcing stream reset"),void this.sendFrame({type:Zv.WindowUpdate,flag:Jv.RST,streamID:e,length:0});const t=this._newStream(e,void 0,aE.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===Zv.Data){if(void 0===t)throw new x("invalid frame",Fv);this.source.push(new me(rE(e),t))}else this.source.push(rE(e))}sendPing(e,t=Jv.SYN){t===Jv.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:Zv.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=eE.NormalTermination){this.log?.("sending GoAway reason=%s",eE[e]),this.localGoAway=e,this.sendFrame({type:Zv.GoAway,flag:0,streamID:0,length:e})}}function hE(e={}){return t=>new uE(t,e)}async function*fE(e,t={}){const n=e.getReader();try{for(;;){const e=await n.read();if(e.done)return;yield e.value}}finally{!0!==t.preventCancel&&await n.cancel(),n.releaseLock()}}const pE="ERR_UNRECOGNIZED_VALIDITY",gE="ERR_SIGNATURE_VERIFICATION",mE="ERR_UNDEFINED_PARAMETER";var yE;!function(e){let t,n,r;!function(e){e.EOL="EOL"}(t=e.ValidityType||(e.ValidityType={})),function(e){e[e.EOL=0]="EOL"}(n||(n={})),function(e){e.codec=()=>gr(n)}(t=e.ValidityType||(e.ValidityType={})),e.codec=()=>(null==r&&(r=mr((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.value&&(n.uint32(10),n.bytes(t.value)),null!=t.signatureV1&&(n.uint32(18),n.bytes(t.signatureV1)),null!=t.validityType&&(n.uint32(24),e.ValidityType.codec().encode(t.validityType,n)),null!=t.validity&&(n.uint32(34),n.bytes(t.validity)),null!=t.sequence&&(n.uint32(40),n.uint64(t.sequence)),null!=t.ttl&&(n.uint32(48),n.uint64(t.ttl)),null!=t.pubKey&&(n.uint32(58),n.bytes(t.pubKey)),null!=t.signatureV2&&(n.uint32(66),n.bytes(t.signatureV2)),null!=t.data&&(n.uint32(74),n.bytes(t.data)),!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.value=t.bytes();break;case 2:r.signatureV1=t.bytes();break;case 3:r.validityType=e.ValidityType.codec().decode(t);break;case 4:r.validity=t.bytes();break;case 5:r.sequence=t.uint64();break;case 6:r.ttl=t.uint64();break;case 7:r.pubKey=t.bytes();break;case 8:r.signatureV2=t.bytes();break;case 9:r.data=t.bytes();break;default:t.skipType(7&n)}}return r})),r),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(yE||(yE={}));const wE=fa("ipns:utils"),bE=Hn("/ipns/"),vE=e=>"signatureV1"in e?yE.encode({value:Hn(e.value),signatureV1:e.signatureV1,validityType:e.validityType,validity:Hn(e.validity),sequence:e.sequence,ttl:e.ttl,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data}):yE.encode({pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data});function EE(e){const t=yE.decode(e);if(null!=t.sequence&&(t.sequence=BigInt(t.sequence)),null!=t.ttl&&(t.ttl=BigInt(t.ttl)),null==t.signatureV2||null==t.data)throw Fs(new Error("missing data or signatureV2"),gE);const n=SE(t.data),r=kE(n.Value),i=Ir(n.Validity);if(null!=t.value&&null!=t.signatureV1)return _E(t),{value:r,validityType:yE.ValidityType.EOL,validity:i,sequence:n.Sequence,ttl:n.TTL,pubKey:t.pubKey,signatureV1:t.signatureV1,signatureV2:t.signatureV2,data:t.data};if(null!=t.signatureV2)return{value:r,validityType:yE.ValidityType.EOL,validity:i,sequence:n.Sequence,ttl:n.TTL,pubKey:t.pubKey,signatureV2:t.signatureV2,data:t.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}const SE=e=>{const t=mc(e);if(0!==t.ValidityType)throw Fs(new Error("Unknown validity type"),pE);return t.ValidityType=yE.ValidityType.EOL,Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t},kE=e=>{if(null!=e){if(Rr(e))return`/ipns/${e.toCID().toString(Lt)}`;if(e instanceof Uint8Array){const t=Ir(e);t.startsWith("/")&&(e=t)}const t=e.toString().trim();if(t.startsWith("/")&&t.length>1)return t;const n=Pn.asCID(e);if(null!=n)return 114===n.code?`/ipns/${n.toString(Lt)}`:`/ipfs/${n.toV1().toString()}`;try{return e instanceof Uint8Array?`/ipfs/${Pn.decode(e).toV1().toString()}`:`/ipfs/${Pn.parse(t).toV1().toString()}`}catch{}}throw Fs(new Error("Value must be a valid content path starting with /"),"ERR_INVALID_VALUE")},_E=e=>{if(null==e.data)throw Fs(new Error("Record data is missing"),"ERR_INVALID_RECORD_DATA");const t=SE(e.data);if(!he(t.Value,e.value??new Uint8Array(0)))throw Fs(new Error('Field "value" did not match between protobuf and CBOR'),gE);if(!he(t.Validity,e.validity??new Uint8Array(0)))throw Fs(new Error('Field "validity" did not match between protobuf and CBOR'),gE);if(t.ValidityType!==e.validityType)throw Fs(new Error('Field "validityType" did not match between protobuf and CBOR'),gE);if(t.Sequence!==e.sequence)throw Fs(new Error('Field "sequence" did not match between protobuf and CBOR'),gE);if(t.TTL!==e.ttl)throw Fs(new Error('Field "ttl" did not match between protobuf and CBOR'),gE)};var RE=n(454);const IE=fa("ipns:validator");async function AE(e,t){if(t.byteLength>10240)throw Fs(new Error("record too large"),"ERR_RECORD_TOO_LARGE");const n=(e=>Or(e.slice(bE.length)))(e),r=EE(t),i=await(async(e,t)=>{if(null==t||null==e){const e=new Error("one or more of the provided parameters are not defined");throw wE.error(e),Fs(e,mE)}let n;if(null!=t.pubKey){try{n=Qm(t.pubKey)}catch(e){throw wE.error(e),e}if(!(await Mr(t.pubKey)).equals(e))throw Fs(new Error("Embedded public key did not match PeerID"),"ERR_INVALID_EMBEDDED_KEY")}else null!=e.publicKey&&(n=Qm(e.publicKey));if(null!=n)return n;throw Fs(new Error("no public key is available"),mE)})(n,r);await(async(e,t)=>{const n=EE(t);let r;try{const t=(i=n.data,de([Hn("ipns-signature:"),i]));r=await e.verify(t,n.signatureV2)}catch(e){r=!1}var i;if(!r)throw IE.error("record signature verification failed"),Fs(new Error("record signature verification failed"),gE);if(n.validityType===yE.ValidityType.EOL){if(RE.fromString(n.validity).toDate().getTime()<Date.now())throw IE.error("record has expired"),Fs(new Error("record has expired"),"ERR_IPNS_EXPIRED_RECORD")}else if(null!=n.validityType)throw IE.error("unrecognized validity type"),Fs(new Error("unrecognized validity type"),pE);IE("ipns record for %s is valid",n.value)})(i,t)}class xE extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MESSAGE_LENGTH"}async function*TE(e,t={}){const n=/\r?\n/,r=new TextDecoder("utf8");let i="";for await(let o of e){if("string"==typeof o&&(o=(new TextEncoder).encode(o)),ge(o)&&(o=o.subarray()),i+=r.decode(o,{stream:!0}),i.length>(t?.maxMessageLength??i.length))throw new xE("Incoming message too long");const e=i.split(n);i=e.pop()??"";for(let t=0;t<e.length;t++)yield JSON.parse(e[t])}i+=r.decode(),""!==i&&(yield JSON.parse(i))}const CE=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{for await(const t of e)return t})();for(const t of e)return t},NE=Hn("/ipns/");function DE(e){return he(e.subarray(0,NE.byteLength),NE)}const PE=e=>Or(e.slice(NE.length));class LE{client;constructor(e){this.client=e}async*findProviders(e,t={}){yield*xe(this.client.getProviders(e,t),e=>({id:e.ID,multiaddrs:e.Addrs??[]}))}async provide(){}async put(e,t,n){if(!DE(e))return;const r=PE(e),i=EE(t);await this.client.putIPNS(r,i,n)}async get(e,t){if(!DE(e))throw new x("Not found","ERR_NOT_FOUND");const n=PE(e);try{const e=await this.client.getIPNS(n,t);return vE(e)}catch(e){if("ERR_BAD_RESPONSE"===e.code)throw new x("Not found","ERR_NOT_FOUND");throw e}}}class BE{client;constructor(e){this.client=e}async findPeer(e,t={}){const n=await CE(this.client.getPeers(e,t));if(null!=n)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new x("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){}}const OE=fa("delegated-routing-v1-http-api-client");class ME{started;httpQueue;shutDownController;clientUrl;timeout;contentRouting;peerRouting;constructor(e,t={}){this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new Oa({concurrency:t.concurrentRequests??4}),this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??3e4,this.contentRouting=new LE(this),this.peerRouting=new BE(this)}get[_a](){return this.contentRouting}get[Ra](){return this.peerRouting}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*getProviders(e,t={}){OE("getProviders starts: %c",e);const n=AbortSignal.timeout(this.timeout),r=_([this.shutDownController.signal,n,t.signal]),i=D(),o=D();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const t=`${this.clientUrl}routing/v1/providers/${e.toString()}`,n={headers:{Accept:"application/x-ndjson"},signal:r},o=await fetch(t,n);if(404===o.status)throw new x("No matching records found.","ERR_NOT_FOUND");if(422===o.status)throw new x("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==o.body)throw new x("Routing response had no body","ERR_BAD_RESPONSE");if("application/json"===o.headers.get("Content-Type")){const e=await o.json();for(const t of e.Providers){const e=this.#$(t);null!=e&&(yield e)}}else for await(const e of TE(fE(o.body))){const t=this.#$(e);null!=t&&(yield t)}}catch(e){OE.error("getProviders errored:",e)}finally{r.clear(),o.resolve(),OE("getProviders finished: %c",e)}}async*getPeers(e,t={}){OE("getPeers starts: %c",e);const n=AbortSignal.timeout(this.timeout),r=_([this.shutDownController.signal,n,t.signal]),i=D(),o=D();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const t=`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`,n={headers:{Accept:"application/x-ndjson"},signal:r},o=await fetch(t,n);if(404===o.status)throw new x("No matching records found.","ERR_NOT_FOUND");if(422===o.status)throw new x("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==o.body)throw new x("Routing response had no body","ERR_BAD_RESPONSE");if("application/json"===o.headers.get("Content-Type")){const e=await o.json();for(const t of e.Peers){const e=this.#$(t);null!=e&&(yield e)}}else for await(const e of TE(fE(o.body))){const t=this.#$(e);null!=t&&(yield t)}}catch(e){OE.error("getPeers errored:",e)}finally{r.clear(),o.resolve(),OE("getPeers finished: %c",e)}}async getIPNS(e,t={}){OE("getIPNS starts: %c",e);const n=AbortSignal.timeout(this.timeout),r=_([this.shutDownController.signal,n,t.signal]),i=D(),o=D();this.httpQueue.add(async()=>(i.resolve(),o.promise));const s=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;try{await i.promise;const n={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:r},o=await fetch(s,n);if(OE("getIPNS GET %s %d",s,o.status),404===o.status)throw new x("No matching records found.","ERR_NOT_FOUND");if(422===o.status)throw new x("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(null==o.body)throw new x("GET ipns response had no body","ERR_BAD_RESPONSE");const a=await o.arrayBuffer(),l=new Uint8Array(a,0,a.byteLength);return!1!==t.validate&&await AE((e=>de([bE,e.toBytes()]))(e),l),EE(l)}catch(e){throw OE.error("getIPNS GET %s error:",s,e),e}finally{r.clear(),o.resolve(),OE("getIPNS finished: %c",e)}}async putIPNS(e,t,n={}){OE("putIPNS starts: %c",e);const r=AbortSignal.timeout(this.timeout),i=_([this.shutDownController.signal,r,n.signal]),o=D(),s=D();this.httpQueue.add(async()=>(o.resolve(),s.promise));const a=`${this.clientUrl}routing/v1/ipns/${e.toCID().toString()}`;try{await o.promise;const e={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:vE(t),signal:i},n=await fetch(a,e);if(OE("putIPNS PUT %s %d",a,n.status),200!==n.status)throw new x("PUT ipns response had status other than 200","ERR_BAD_RESPONSE")}catch(e){throw OE.error("putIPNS PUT %s error:",a,e.stack),e}finally{i.clear(),s.resolve(),OE("putIPNS finished: %c",e)}}#$(e){try{const t=[],n=e.Addrs?.map(Wo)??[];return null!=e.Protocols&&t.push(...e.Protocols),null!=e.Protocol&&(t.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:Br(e.ID),Addrs:n,Protocols:t}}catch(e){OE.error("could not conform record to peer schema",e)}}}var UE;!function(e){let t,n,r,i,o,s,a,l;!function(e){e.DIAL="DIAL",e.DIAL_RESPONSE="DIAL_RESPONSE"}(t=e.MessageType||(e.MessageType={})),function(e){e[e.DIAL=0]="DIAL",e[e.DIAL_RESPONSE=1]="DIAL_RESPONSE"}(n||(n={})),function(e){e.codec=()=>gr(n)}(t=e.MessageType||(e.MessageType={})),function(e){e.OK="OK",e.E_DIAL_ERROR="E_DIAL_ERROR",e.E_DIAL_REFUSED="E_DIAL_REFUSED",e.E_BAD_REQUEST="E_BAD_REQUEST",e.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(r=e.ResponseStatus||(e.ResponseStatus={})),function(e){e[e.OK=0]="OK",e[e.E_DIAL_ERROR=100]="E_DIAL_ERROR",e[e.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",e[e.E_BAD_REQUEST=200]="E_BAD_REQUEST",e[e.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"}(i||(i={})),function(e){e.codec=()=>gr(i)}(r=e.ResponseStatus||(e.ResponseStatus={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const n of e.addrs)t.uint32(18),t.bytes(n);!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={addrs:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.id=e.bytes();break;case 2:n.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(o=e.PeerInfo||(e.PeerInfo={})),function(t){let n;t.codec=()=>(null==n&&(n=mr((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.peer&&(n.uint32(10),e.PeerInfo.codec().encode(t.peer,n)),!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();n>>>3==1?r.peer=e.PeerInfo.codec().decode(t,t.uint32()):t.skipType(7&n)}return r})),n),t.encode=e=>rr(e,t.codec()),t.decode=e=>it(e,t.codec())}(s=e.Dial||(e.Dial={})),function(t){let n;t.codec=()=>(null==n&&(n=mr((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.status&&(n.uint32(8),e.ResponseStatus.codec().encode(t.status,n)),null!=t.statusText&&(n.uint32(18),n.string(t.statusText)),null!=t.addr&&(n.uint32(26),n.bytes(t.addr)),!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.status=e.ResponseStatus.codec().decode(t);break;case 2:r.statusText=t.string();break;case 3:r.addr=t.bytes();break;default:t.skipType(7&n)}}return r})),n),t.encode=e=>rr(e,t.codec()),t.decode=e=>it(e,t.codec())}(a=e.DialResponse||(e.DialResponse={})),e.codec=()=>(null==l&&(l=mr((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.MessageType.codec().encode(t.type,n)),null!=t.dial&&(n.uint32(18),e.Dial.codec().encode(t.dial,n)),null!=t.dialResponse&&(n.uint32(26),e.DialResponse.codec().encode(t.dialResponse,n)),!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.MessageType.codec().decode(t);break;case 2:r.dial=e.Dial.codec().decode(t,t.uint32());break;case 3:r.dialResponse=e.DialResponse.codec().decode(t,t.uint32());break;default:t.skipType(7&n)}}return r})),l),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(UE||(UE={}));class FE{components;startupDelay;refreshInterval;protocol;timeout;maxInboundStreams;maxOutboundStreams;verifyAddressTimeout;started;log;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:autonat"),this.started=!1,this.protocol=`/${t.protocolPrefix??"libp2p"}/autonat/1.0.0`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.startupDelay=t.startupDelay??5e3,this.refreshInterval=t.refreshInterval??6e4,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}[Symbol.toStringTag]="@libp2p/autonat";isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(e=>{this.log.error("error handling incoming autonat stream",e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),clearTimeout(this.verifyAddressTimeout),this.started=!1}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),n=()=>{e.stream.abort(new x("handleIncomingAutonatStream timeout",C))};t.addEventListener("abort",n,{once:!0});try{const n=this;await De(e.stream,e=>Ie(e),async function*(r){const i=await CE(r);if(null==i)return n.log("no message received"),void(yield UE.encode({type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}}));let o;try{o=UE.decode(i)}catch(e){return n.log.error("could not decode message",e),void(yield UE.encode({type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}}))}yield UE.encode(await n.handleAutonatMessage(o,e.connection,{signal:t}))},e=>be(e),e.stream)}catch(e){this.log.error("error handling incoming autonat stream",e)}finally{t.removeEventListener("abort",n)}}_verifyExternalAddresses(){this.verifyExternalAddresses().catch(e=>{this.log.error("error verifying external address",e)})}async handleAutonatMessage(e,t,n){const r=this.components.addressManager.getAddresses().map(e=>e.toOptions().host),i=e.dial;if(null==i)return this.log.error("dial was missing from message"),{type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const s=i.peer;if(null==s?.id)return this.log.error("PeerId missing from message"),{type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{o=Or(s.id)}catch(e){return this.log.error("invalid PeerId",e),{type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const a=s.addrs.map(e=>Wo(e)).filter(e=>{const n=e.toOptions().host===t.remoteAddr.toOptions().host;return this.log.trace("request to dial %a was sent from %a is same host %s",e,t.remoteAddr,n),n}).filter(e=>{const t=e.toOptions().host,n=!Oi(t);return this.log.trace("host %s was public %s",t,n),n}).filter(e=>{const t=e.toOptions().host,n=!r.includes(t);return this.log.trace("host %s was not our host %s",t,n),n}).filter(e=>{const t=Boolean(this.components.transportManager.dialTransportForMultiaddr(e));return this.log.trace("transport for %a is supported %s",e,t),t}).map(e=>(null==e.getPeerId()&&(e=e.encapsulate(`/p2p/${o.toString()}`)),e));if(0===a.length)return this.log("no valid multiaddrs for %p in message",o),{type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",a.map(e=>e.toString()).join(", "),o);let l="",c=a[0];for await(const e of a){let t;c=e;try{if(t=await this.components.connectionManager.openConnection(e,n),!t.remoteAddr.equals(e))throw this.log.error("tried to dial %a but dialed %a",e,t.remoteAddr),new Error("Unexpected remote address");return this.log("Success %p",o),{type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.OK,addr:t.remoteAddr.decapsulateCode(Go("p2p").code).bytes}}}catch(e){this.log("could not dial %p",o,e),l=e.message}finally{null!=t&&await t.close()}}return{type:UE.MessageType.DIAL_RESPONSE,dialResponse:{status:UE.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:c.bytes}}}async verifyExternalAddresses(){if(clearTimeout(this.verifyAddressTimeout),!this.isStarted())return;const e=this.components.addressManager,t=e.getObservedAddrs().filter(e=>!Oi(e.toOptions().host));if(0===t.length)return this.log("no public addresses found, not requesting verification"),void(this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval));const n=AbortSignal.timeout(this.timeout),r=this;try{this.log("verify multiaddrs %s",t.map(e=>e.toString()).join(", "));const i=UE.encode({type:UE.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:t.map(e=>e.bytes)}}}),o={},s=[],a=async e=>{let t=()=>{};try{this.log("asking %p to verify multiaddr",e.id);const o=await r.components.connectionManager.openConnection(e.id,{signal:n}),a=await o.newStream(this.protocol,{signal:n});t=()=>{a.abort(new x("verifyAddress timeout",C))},n.addEventListener("abort",t,{once:!0});const l=await De([i],e=>be(e),a,e=>Ie(e),async e=>CE(e));if(null==l)return void this.log("no response received from %p",o.remotePeer);const c=UE.decode(l);if(c.type!==UE.MessageType.DIAL_RESPONSE||null==c.dialResponse)return void this.log("invalid autonat response from %p",o.remotePeer);if(c.dialResponse.status===UE.ResponseStatus.OK){const e=o.remoteAddr.toOptions();let t;if(4===e.family)t=e.host.split(".")[0];else{if(6!==e.family)return void this.log('remote address "%s" was not IP4 or IP6?',e.host);t=e.host.split(":")[0]}if(s.includes(t))return void this.log("already have response from network segment %d - %s",t,e.host);s.push(t)}return c.dialResponse}catch(e){this.log.error("error asking remote to verify multiaddr",e)}finally{n.removeEventListener("abort",t)}};for await(const r of lb(xe(this.components.randomWalk.walk({signal:n}),e=>async()=>a(e)),{concurrency:4}))try{if(null==r)continue;const n=null==r.addr?t[0]:Wo(r.addr);if(this.log("autonat response for %a is %s",n,r.status),r.status===UE.ResponseStatus.E_BAD_REQUEST)continue;if(r.status===UE.ResponseStatus.E_DIAL_REFUSED)continue;if(null==r.addr&&t.length>1)continue;if(!t.some(e=>e.equals(n))){this.log("peer reported %a as %s but it was not in our observed address list",n,r.status);continue}const i=n.toString();if(null==o[i]&&(o[i]={success:0,failure:0}),r.status===UE.ResponseStatus.OK?o[i].success++:r.status===UE.ResponseStatus.E_DIAL_ERROR&&o[i].failure++,4===o[i].success)return this.log("%a is externally dialable",n),void e.confirmObservedAddr(n);if(4===o[i].failure)return this.log("%a is not externally dialable",n),void e.removeObservedAddr(n)}catch(e){this.log.error("could not verify external address",e)}}finally{this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval)}}}function zE(e={}){return t=>new FE(t,e)}const VE=wS("dns4"),$E=wS("dns6"),HE=wS("dnsaddr"),KE=yS(wS("dns"),HE,VE,$E),qE=yS(wS("ip4"),wS("ip6")),jE=yS(mS(qE,wS("tcp")),mS(KE,wS("tcp"))),WE=mS(qE,wS("udp")),GE=mS(WE,wS("utp")),YE=mS(WE,wS("quic")),QE=mS(WE,wS("quic-v1")),XE=yS(mS(jE,wS("ws")),mS(KE,wS("ws"))),ZE=yS(mS(XE,wS("p2p")),XE),JE=yS(mS(jE,wS("wss")),mS(KE,wS("wss")),mS(jE,wS("tls"),wS("ws")),mS(KE,wS("tls"),wS("ws"))),eS=yS(mS(JE,wS("p2p")),JE),tS=yS(mS(jE,wS("http")),mS(qE,wS("http")),mS(KE,wS("http"))),nS=yS(mS(jE,wS("https")),mS(qE,wS("https")),mS(KE,wS("https"))),rS=mS(WE,wS("webrtc-direct"),wS("certhash")),iS=yS(mS(rS,wS("p2p")),rS),oS=mS(QE,wS("webtransport"),wS("certhash"),wS("certhash")),sS=yS(mS(oS,wS("p2p")),oS),aS=yS(mS(ZE,wS("p2p-webrtc-star"),wS("p2p")),mS(eS,wS("p2p-webrtc-star"),wS("p2p")),mS(ZE,wS("p2p-webrtc-star")),mS(eS,wS("p2p-webrtc-star"))),lS=(yS(mS(ZE,wS("p2p-websocket-star"),wS("p2p")),mS(eS,wS("p2p-websocket-star"),wS("p2p")),mS(ZE,wS("p2p-websocket-star")),mS(eS,wS("p2p-websocket-star"))),yS(mS(tS,wS("p2p-webrtc-direct"),wS("p2p")),mS(nS,wS("p2p-webrtc-direct"),wS("p2p")),mS(tS,wS("p2p-webrtc-direct")),mS(nS,wS("p2p-webrtc-direct")))),cS=yS(XE,JE,tS,nS,aS,lS,jE,GE,YE,KE,iS,sS),uS=(yS(mS(cS,wS("p2p-stardust"),wS("p2p")),mS(cS,wS("p2p-stardust"))),yS(mS(cS,wS("p2p")),aS,lS,iS,sS,wS("p2p"))),dS=yS(mS(uS,wS("p2p-circuit"),uS),mS(uS,wS("p2p-circuit")),mS(wS("p2p-circuit"),uS),mS(cS,wS("p2p-circuit")),mS(wS("p2p-circuit"),cS),wS("p2p-circuit")),hS=()=>yS(mS(dS,hS),dS),fS=hS(),pS=yS(mS(fS,uS,fS),mS(uS,fS),mS(fS,uS),fS,uS);function gS(e){return function(t){let n;try{n=Wo(t)}catch(e){return!1}const r=e(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function mS(...e){function t(t){if(t.length<e.length)return null;let n=t;return e.some(e=>(n="function"==typeof e?e().partialMatch(t):e.partialMatch(t),Array.isArray(n)&&(t=n),null===n)),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:gS(t),partialMatch:t}}function yS(...e){function t(t){let n=null;return e.some(e=>{const r="function"==typeof e?e().partialMatch(t):e.partialMatch(t);return null!=r&&(n=r,!0)}),n}return{toString:function(){return"{ "+e.join(" ")+" }"},input:e,matches:gS(t),partialMatch:t}}function wS(e){const t=e;return{toString:function(){return t},matches:function(e){let n;try{n=Wo(e)}catch(e){return!1}const r=n.protoNames();return 1===r.length&&r[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}yS(mS(fS,wS("webrtc"),wS("p2p")),mS(fS,wS("webrtc")),mS(cS,wS("webrtc"),wS("p2p")),mS(cS,wS("webrtc")),wS("webrtc"));class bS extends R{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(null==t.list||0===t.list.length)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??1e3,this.list=[];for(const e of t.list){if(!pS.matches(e)){this.log.error("Invalid multiaddr");continue}const t=Wo(e),n=t.getPeerId();if(null==n){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const r={id:Br(n),multiaddrs:[t]};this.list.push(r)}this._init=t}[py]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[ey]=["@libp2p/peer-discovery"];isStarted(){return Boolean(this.timer)}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(null!=this.timer)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??"bootstrap"]:{value:this._init.tagValue??50,ttl:this._init.tagTTL??12e4}}}),null==this.timer)return;this.safeDispatchEvent("peer",{detail:e})}}stop(){null!=this.timer&&clearTimeout(this.timer),this.timer=void 0}}function vS(e){return t=>new bS(t,e)}class ES{filter;constructor(e,t){this.filter=sb(e,t)}has(e){return this.filter.has(e.toBytes())}add(e){this.filter.add(e.toBytes())}remove(e){this.filter.remove?.(e.toBytes())}}function SS(e,t=.001){return new ES(e,t)}function kS(e){const{stream:t,remoteAddr:n,logger:r}=e,i=r.forComponent("libp2p:stream:converter");let o=!1,s=!1;const a=t.close.bind(t);t.close=async e=>{await a(e),d(!0)};const l=t.abort.bind(t);t.abort=e=>{l(e),d(!0)};const c=t.sink.bind(t);t.sink=async e=>{try{await c(e)}catch(e){"aborted"!==e.type&&i.error("%s error in sink",n,e)}finally{s=!0,d()}};const u={log:i,sink:t.sink,source:async function*(){try{for await(const e of t.source)e instanceof Uint8Array?yield e:yield*e}finally{o=!0,d()}}(),remoteAddr:n,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function d(e){!0===e&&(o=!0,s=!0),o&&s&&null==u.timeline.close&&(u.timeline.close=Date.now())}return u}function _S(e,t){const n=mb(e,t),r={read:async(e,t)=>{const r=await n.read(t);return e.decode(r)},write:async(e,t,r)=>{await n.write(t.encode(e),r)},writeV:async(e,t,r)=>{await n.writeV(e.map(e=>t.encode(e)),r)},pb:e=>({read:async t=>r.read(e,t),write:async(t,n)=>r.write(t,e,n),writeV:async(t,n)=>r.writeV(t,e,n),unwrap:()=>r}),unwrap:()=>n.unwrap()};return r}const RS="circuit-relay-relay",IS=(BigInt(1<<17),"/libp2p/circuit/relay/0.2.0/hop"),AS="/libp2p/circuit/relay/0.2.0/stop",xS="ERR_RELAYED_DIAL";var TS,CS,NS,DS,PS,LS,BS,OS;!function(e){let t,n,r;!function(e){e.RESERVE="RESERVE",e.CONNECT="CONNECT",e.STATUS="STATUS"}(t=e.Type||(e.Type={})),function(e){e[e.RESERVE=0]="RESERVE",e[e.CONNECT=1]="CONNECT",e[e.STATUS=2]="STATUS"}(n||(n={})),function(e){e.codec=()=>gr(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=mr((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),NS.codec().encode(t.peer,n)),null!=t.reservation&&(n.uint32(26),DS.codec().encode(t.reservation,n)),null!=t.limit&&(n.uint32(34),PS.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(40),LS.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()},(t,n,r={})=>{const i={},o=null==n?t.len:t.pos+n;for(;t.pos<o;){const n=t.uint32();switch(n>>>3){case 1:i.type=e.Type.codec().decode(t);break;case 2:i.peer=NS.codec().decode(t,t.uint32(),{limits:r.limits?.peer});break;case 3:i.reservation=DS.codec().decode(t,t.uint32(),{limits:r.limits?.reservation});break;case 4:i.limit=PS.codec().decode(t,t.uint32(),{limits:r.limits?.limit});break;case 5:i.status=LS.codec().decode(t);break;default:t.skipType(7&n)}}return i})),r),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(TS||(TS={})),function(e){let t,n,r;!function(e){e.CONNECT="CONNECT",e.STATUS="STATUS"}(t=e.Type||(e.Type={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.STATUS=1]="STATUS"}(n||(n={})),function(e){e.codec=()=>gr(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=mr((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),NS.codec().encode(t.peer,n)),null!=t.limit&&(n.uint32(26),PS.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(32),LS.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()},(t,n,r={})=>{const i={},o=null==n?t.len:t.pos+n;for(;t.pos<o;){const n=t.uint32();switch(n>>>3){case 1:i.type=e.Type.codec().decode(t);break;case 2:i.peer=NS.codec().decode(t,t.uint32(),{limits:r.limits?.peer});break;case 3:i.limit=PS.codec().decode(t,t.uint32(),{limits:r.limits?.limit});break;case 4:i.status=LS.codec().decode(t);break;default:t.skipType(7&n)}}return i})),r),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(CS||(CS={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const n of e.addrs)t.uint32(18),t.bytes(n);!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={id:Y(0),addrs:[]},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.id=e.bytes();break;case 2:if(null!=n.limits?.addrs&&r.addrs.length===n.limits.addrs)throw new yr('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");r.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(NS||(NS={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.expire&&0n!==e.expire&&(t.uint32(8),t.uint64(e.expire)),null!=e.addrs)for(const n of e.addrs)t.uint32(18),t.bytes(n);null!=e.voucher&&(t.uint32(26),t.bytes(e.voucher)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={expire:0n,addrs:[]},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.expire=e.uint64();break;case 2:if(null!=n.limits?.addrs&&r.addrs.length===n.limits.addrs)throw new yr('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");r.addrs.push(e.bytes());break;case 3:r.voucher=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(DS||(DS={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.duration&&(t.uint32(8),t.uint32(e.duration)),null!=e.data&&(t.uint32(16),t.uint64(e.data)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.duration=e.uint32();break;case 2:r.data=e.uint64();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(PS||(PS={})),function(e){e.UNUSED="UNUSED",e.OK="OK",e.RESERVATION_REFUSED="RESERVATION_REFUSED",e.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONNECTION_FAILED="CONNECTION_FAILED",e.NO_RESERVATION="NO_RESERVATION",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE",e.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"}(LS||(LS={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.OK=100]="OK",e[e.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",e[e.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",e[e.PERMISSION_DENIED=202]="PERMISSION_DENIED",e[e.CONNECTION_FAILED=203]="CONNECTION_FAILED",e[e.NO_RESERVATION=204]="NO_RESERVATION",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",e[e.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"}(BS||(BS={})),function(e){e.codec=()=>gr(BS)}(LS||(LS={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.relay&&e.relay.byteLength>0&&(t.uint32(10),t.bytes(e.relay)),null!=e.peer&&e.peer.byteLength>0&&(t.uint32(18),t.bytes(e.peer)),null!=e.expiration&&0n!==e.expiration&&(t.uint32(24),t.uint64(e.expiration)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={relay:Y(0),peer:Y(0),expiration:0n},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.relay=e.bytes();break;case 2:r.peer=e.bytes();break;case 3:r.expiration=e.uint64();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(OS||(OS={}));class MS extends R{peerStore;registrar;connectionManager;randomWalk;started;running;topologyId;log;discoveryController;filter;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(IS,{filter:this.filter,onConnect:e=>{this.log("discovered relay %p",e),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.discoveryController?.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.peerStore.all({filters:[e=>e.protocols.includes(IS)],orders:[()=>Math.random()<.5?1:-1]});for(const t of e)this.log.trace("found relay peer %p in peer store",t.id),this.safeDispatchEvent("relay:discover",{detail:t.id});this.log("found %d relay peers in peer store",e.length);const t=new W({concurrency:5});this.log("start random walk");for await(const e of this.randomWalk.walk({signal:this.discoveryController.signal}))this.log.trace("found random peer %p",e.id),t.has(e.id)?this.log.trace("random peer %p was already in queue",e.id):this.connectionManager.getConnections(e.id)?.length>0?this.log.trace("random peer %p was already connected",e.id):await this.connectionManager.isDialable(e.multiaddrs)?(this.log.trace("wait for space in queue for %p",e.id),await H(t.onSizeLessThan(10),this.discoveryController.signal),this.log("adding random peer %p to dial queue (length: %d)",e.id,t.size),t.add(async()=>{const t=_([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(e.id,{signal:t})}finally{t.clear()}},{peerId:e.id,signal:this.discoveryController.signal}).catch(t=>{this.log.error("error opening connection to random peer %p",e.id,t)})):this.log.trace("random peer %p was not dialable",e.id,e.multiaddrs.map(e=>e.toString()));await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort()}}class US extends R{connectionManager;relayStore;listeningAddrs;log;constructor(e){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new Fr,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}_onRemoveRelayPeer=e=>{this.#H(e.detail)};async listen(e){this.log("listen on %a",e);const t=e.decapsulate("/p2p-circuit"),n=await this.connectionManager.openConnection(t);if(!this.relayStore.hasReservation(n.remotePeer))return this.log("making reservation on peer %p",n.remotePeer),void await this.relayStore.addRelay(n.remotePeer,"configured");const r=this.relayStore.getReservation(n.remotePeer);if(null==r)throw new x("Did not have reservation after making reservation","ERR_NO_RESERVATION");this.listeningAddrs.has(n.remotePeer)?this.log("already listening on relay %p",n.remotePeer):(this.listeningAddrs.set(n.remotePeer,r.addrs.map(e=>Wo(e).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening",{}))}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}#H(e){const t=this.listeningAddrs.has(e);this.log("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&(this.log.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))}}const FS=Math.LN2*Math.LN2;class zS{seeds;bits;buffer;constructor(e={}){null!=e.seeds?this.seeds=e.seeds:this.seeds=function(e){let t,n;const r=[];for(let i=0;i<e;i++)for(t=new me(mi(4)),r[i]=t.getUint32(0,!0),n=0;n<i;n++)if(r[i]===r[n]){i--;break}return r}(e.hashes??8),this.bits=e.bits??1024,this.buffer=Y(Math.ceil(this.bits/8))}add(e){"string"==typeof e&&(e=Hn(e));for(let t=0;t<this.seeds.length;t++){const n=yi.x86.hash32(e,this.seeds[t])%this.bits;this.setbit(n)}}has(e){"string"==typeof e&&(e=Hn(e));for(let t=0;t<this.seeds.length;t++){const n=yi.x86.hash32(e,this.seeds[t])%this.bits;if(!this.getbit(n))return!1}return!0}clear(){this.buffer.fill(0)}setbit(e){let t=0,n=e;for(;n>7;)t++,n-=8;let r=this.buffer[t];r|=1<<n,this.buffer[t]=r}getbit(e){let t=0,n=e;for(;n>7;)t++,n-=8;return!!(this.buffer[t]&1<<n)}}function VS(e){const t=e*BigInt(1e3),n=(new Date).getTime();return Number(t-BigInt(n))}class $S extends R{peerId;connectionManager;transportManager;peerStore;events;reserveQueue;reservations;maxDiscoveredRelays;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Fr,this.maxDiscoveredRelays=t?.discoverRelays??0,this.maxReservationQueueLength=t?.maxReservationQueueLength??100,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??1e3,this.started=!1,this.relayFilter=function(e,t=.005){const n=function(e,t=.005){const n=Math.round(-1*e*Math.log(t)/FS);return{bits:n,hashes:Math.round(n/e*Math.LN2)}}(e,t);return new zS(n)}(100),this.reserveQueue=new W({concurrency:t?.reservationConcurrency??1,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("peer:disconnect",e=>{this.#K(e.detail)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{}))}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}async addRelay(e,t){this.peerId.equals(e)?this.log("not trying to use self as relay"):this.reserveQueue.size>this.maxReservationQueueLength?this.log("not adding potential relay peer %p as the queue is full",e):this.reserveQueue.has(e)?this.log("potential relay peer %p is already in the reservation queue",e):this.relayFilter.has(e.toBytes())?this.log("potential relay peer %p has failed previously, not trying again",e):(this.log("try to reserve relay slot with %p",e),await this.reserveQueue.add(async()=>{const n=Date.now();try{const n=this.reservations.get(e);if(null!=n){if(VS(n.reservation.expire)>6e5)return void this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",e);clearTimeout(n.timeout),this.reservations.delete(e)}if("discovered"===t&&[...this.reservations.values()].reduce((e,t)=>("discovered"===t.type&&e++,e),0)>=this.maxDiscoveredRelays)return void this.log("already have enough discovered relays");const r=AbortSignal.timeout(this.reservationCompletionTimeout),i=await this.connectionManager.openConnection(e,{signal:r});if(i.remoteAddr.protoNames().includes("p2p-circuit"))return void this.log("not creating reservation over relayed connection");const o=await this.#q(i,{signal:r});this.log("created reservation on relay peer %p",e);const s=VS(o.expire),a=Math.min(Math.max(s-3e5,3e4),Math.pow(2,31)-1),l=setTimeout(()=>{this.addRelay(e,t).catch(t=>{this.log.error("could not refresh reservation to relay %p",e,t)})},a);this.reservations.set(e,{timeout:l,reservation:o,type:t}),await this.peerStore.merge(e,{tags:{[RS]:{value:1,ttl:s}}}),await this.transportManager.listen([Wo(`/p2p/${e.toString()}/p2p-circuit`)]),this.safeDispatchEvent("relay:created-reservation",{detail:e})}catch(t){this.log.error("could not reserve slot on %p after %dms",e,Date.now()-n,t);const r=this.reservations.get(e);null!=r&&clearTimeout(r.timeout),this.reservations.delete(e),this.relayFilter.add(e.toBytes())}},{peerId:e}))}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(){return this.reservations.size}async#q(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(IS,t),r=_S(n).pb(TS);let i;await r.write({type:TS.Type.RESERVE},t);try{i=await r.read(t)}catch(e){throw n.abort(e),e}finally{"closed"!==n.status&&await n.close(t)}if(i.status===LS.OK&&null!=i.reservation){let t=!1;const n=e.remoteAddr.bytes;for(const e of i.reservation.addrs)if(he(n,e)){t=!0;break}return t||i.reservation.addrs.push(n),i.reservation}const o=`reservation failed with status ${i.status??"undefined"}`;throw this.log.error(o),new Error(o)}#K(e){const t=this.reservations.get(e);null!=t&&(this.log("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}}class HS{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;stopTimeout;started;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??300,this.maxOutboundStopStreams=t.maxOutboundStopStreams??300,this.stopTimeout=t.stopTimeout??3e4;const n=t.discoverRelays??0;n>0&&(this.discovery=new MS(e,{filter:t.discoveryFilter??SS(4096,.001)}),this.discovery.addEventListener("relay:discover",e=>{this.reservationStore.addRelay(e.detail,"discovered").catch(t=>{this.log.error("could not add discovered relay %p",e.detail,t)})})),this.reservationStore=new $S(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:created-reservation",()=>{this.reservationStore.reservationCount()>=n&&this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[ey]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[ty](){return null!=this.discovery?["@libp2p/identify"]:[]}[Gy]=!0;isStarted(){return this.started}async start(){await this.registrar.handle(AS,e=>{this.onStop(e).catch(t=>{this.log.error("error while handling STOP protocol",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),await Aa(this.discovery,this.reservationStore),this.started=!0}async stop(){await xa(this.discovery,this.reservationStore),await this.registrar.unhandle(AS),this.started=!1}async dial(e,t){if(1!==e.protoCodes().filter(e=>290===e).length){const t="Invalid circuit relay address";throw this.log.error(t,e),new x(t,xS)}const n=e.toString().split("/p2p-circuit"),r=Wo(n[0]),i=Wo(n[n.length-1]),o=r.getPeerId(),s=i.getPeerId();if(null==o||null==s){const t=`Circuit relay dial to ${e.toString()} failed as address did not have peer ids`;throw this.log.error(t),new x(t,xS)}const a=Br(o),l=Br(s);let c,u=!1,d=this.connectionManager.getConnections(a)[0];null==d?(await this.peerStore.merge(a,{multiaddrs:[r]}),t.onProgress?.(new Fe("circuit-relay:open-connection")),d=await this.connectionManager.openConnection(a,t),u=!0):t.onProgress?.(new Fe("circuit-relay:reuse-connection"));try{return t.onProgress?.(new Fe("circuit-relay:open-hop-stream")),c=await d.newStream(IS),await this.connectV2({stream:c,connection:d,destinationPeer:l,destinationAddr:i,relayAddr:r,ma:e,disconnectOnFailure:u,onProgress:t.onProgress})}catch(e){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,a,e),null!=c&&c.abort(e),u&&await d.close(),e}}async connectV2({stream:e,connection:t,destinationPeer:n,destinationAddr:r,relayAddr:i,ma:o,disconnectOnFailure:s,onProgress:a}){try{const t=_S(e),s=t.pb(TS);a?.(new Fe("circuit-relay:write-connect-message")),await s.write({type:TS.Type.CONNECT,peer:{id:n.toBytes(),addrs:[Wo(r).bytes]}}),a?.(new Fe("circuit-relay:read-connect-response"));const l=await s.read();if(l.status!==LS.OK)throw new x(`failed to connect via relay with status ${l?.status?.toString()??"undefined"}`,"ERR_HOP_REQUEST_FAILED");const c=kS({stream:t.unwrap(),remoteAddr:o,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger});return this.log("new outbound relayed connection %a",c.remoteAddr),await this.upgrader.upgradeOutbound(c,{transient:null!=l.limit,onProgress:a})}catch(e){throw this.log.error(`Circuit relay dial to destination ${n.toString()} via relay ${t.remotePeer.toString()} failed`,e),s&&await t.close(),e}}createListener(e){return function(e){return new US(e)}({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}listenFilter(e){return(e=Array.isArray(e)?e:[e]).filter(e=>fS.matches(e))}dialFilter(e){return this.listenFilter(e)}async onStop({connection:e,stream:t}){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(e){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",e)}const n=AbortSignal.timeout(this.stopTimeout),r=_S(t).pb(CS),i=await r.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),void 0===i?.type)return this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await r.write({type:CS.Type.STATUS,status:LS.MALFORMED_MESSAGE},{signal:n}),void await t.close();if(i.type!==CS.Type.CONNECT)return this.log.error("invalid stop connect request via peer %p",e.remotePeer),await r.write({type:CS.Type.STATUS,status:LS.UNEXPECTED_MESSAGE},{signal:n}),void await t.close();if(!(e=>{if(null==e.peer)return!1;try{e.peer.addrs.forEach(Wo)}catch{return!1}return!0})(i))return this.log.error("invalid stop connect request via peer %p",e.remotePeer),await r.write({type:CS.Type.STATUS,status:LS.MALFORMED_MESSAGE},{signal:n}),void await t.close();const o=Or(i.peer.id);if(!0===await(this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)))return this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await r.write({type:CS.Type.STATUS,status:LS.PERMISSION_DENIED},{signal:n}),void await t.close();this.log.trace("sending success response to %p",e.remotePeer),await r.write({type:CS.Type.STATUS,status:LS.OK},{signal:n});const s=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),a=this.addressManager.getAddresses()[0],l=kS({stream:r.unwrap().unwrap(),remoteAddr:s,localAddr:a,logger:this.logger});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{transient:null!=i.limit}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}}function KS(e={}){return t=>new HS(t,e)}var qS;function jS(e,t){return!wo.matches(e)&&(null!=t.dialTransportForMultiaddr(e)&&(!!Xi.matches(e)||!!ro.matches(e)&&!1===Oi(e.toOptions().host)))}!function(e){let t,n,r;!function(e){e.UNUSED="UNUSED",e.CONNECT="CONNECT",e.SYNC="SYNC"}(t=e.Type||(e.Type={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.CONNECT=100]="CONNECT",e[e.SYNC=300]="SYNC"}(n||(n={})),function(e){e.codec=()=>gr(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=mr((t,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.observedAddresses)for(const e of t.observedAddresses)n.uint32(18),n.bytes(e);!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={observedAddresses:[]},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.observedAddresses.push(t.bytes());break;default:t.skipType(7&n)}}return r})),r),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(qS||(qS={}));class WS{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??5e3,this.retries=t.retries??3,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1}[Symbol.toStringTag]="@libp2p/dcutr";[ty]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(GS,{notifyOnTransient:!0,onConnect:(e,t)=>{t.transient&&"inbound"===t.direction&&this.upgradeInbound(t).catch(e=>{this.log.error("error during outgoing DCUtR attempt",e)})}}),await this.registrar.handle(GS,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(GS),null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const r={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([GS],{signal:r.signal,runOnTransientConnection:!0});const n=_S(t,{maxDataLength:4096}).pb(qS);this.log("B sending connect to %p",e.remotePeer);const i=Date.now();await n.write({type:qS.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(e=>e.bytes)},r),this.log("B receiving connect from %p",e.remotePeer);const o=await n.read(r);if(o.type!==qS.Type.CONNECT)throw this.log("A sent wrong message type"),new x("DCUtR message type was incorrect",N);const s=this.getDialableMultiaddrs(o.observedAddresses);if(0===s.length)throw this.log("A did not have any dialable multiaddrs"),new x("DCUtR connect message had no multiaddrs",N);const a=Date.now()-i;this.log("A sending sync, rtt %dms",a),await n.write({type:qS.Type.SYNC,observedAddresses:[]},r),this.log("A waiting for half RTT"),await cw(a/2),this.log("B dialing",s);const l=await this.connectionManager.openConnection(s,{signal:r.signal,priority:100});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,l.remoteAddr),await e.close(r);break}catch(e){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,e),t?.abort(e),n===this.retries)throw e}finally{null!=t&&await t.close(r)}}}async attemptUnilateralConnectionUpgrade(e){const t=(await this.peerStore.get(e.remotePeer)).addresses.map(t=>{const n=t.multiaddr;return null==n.getPeerId()?n.encapsulate(`/p2p/${e.remotePeer}`):n}).filter(e=>jS(e,this.transportManager));if(t.length>0){const n=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",t);const r=await this.connectionManager.openConnection(t,{signal:n,force:!0});if(r.transient)throw new Error("Could not open a new, non-transient, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,r.remoteAddr),await e.close({signal:n}),!0}catch(n){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,t,n)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)};try{const r=_S(e,{maxDataLength:4096}).pb(qS);this.log("A receiving connect");const i=await r.read(n);if(i.type!==qS.Type.CONNECT)throw this.log("B sent wrong message type"),new x("DCUtR message type was incorrect",N);if(0===i.observedAddresses.length)throw this.log("B sent no multiaddrs"),new x("DCUtR connect message had no multiaddrs",N);const o=this.getDialableMultiaddrs(i.observedAddresses);if(0===o.length)throw this.log("B had no dialable multiaddrs"),new x("DCUtR connect message had no dialable multiaddrs",N);if(this.log("A sending connect"),await r.write({type:qS.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(e=>e.bytes)}),this.log("A receiving sync"),(await r.read(n)).type!==qS.Type.SYNC)throw new x("DCUtR message type was incorrect",N);this.log("A dialing",o);const s=await this.connectionManager.openConnection(o,{signal:n.signal,priority:100,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,s.remoteAddr),await t.close(n)}catch(n){this.log.error("incoming DCUtR from %p failed",t.remotePeer,n),e.abort(n)}finally{await e.close(n)}}getDialableMultiaddrs(e){const t=[];for(const n of e)if(null!=n&&0!==n.length)try{const e=Wo(n);if(!jS(e,this.transportManager))continue;t.push(e)}catch{}return t}}const GS="/libp2p/dcutr";function YS(e={}){return t=>new WS(t,e)}var QS;!function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(const n of e.listenAddrs)t.uint32(18),t.bytes(n);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(const n of e.protocols)t.uint32(26),t.string(n);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={listenAddrs:[],protocols:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 5:n.protocolVersion=e.string();break;case 6:n.agentVersion=e.string();break;case 1:n.publicKey=e.bytes();break;case 2:n.listenAddrs.push(e.bytes());break;case 4:n.observedAddr=e.bytes();break;case 3:n.protocols.push(e.string());break;case 8:n.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(QS||(QS={}));var XS=n(866);const ZS="object"==typeof window&&"object"==typeof document&&9===document.nodeType,JS=XS(),ek=ZS&&!JS,tk=JS&&!ZS,nk=JS&&ZS,rk=void 0!==globalThis.process&&void 0!==globalThis.process.release&&"node"===globalThis.process.release.name&&!JS,ik="function"==typeof importScripts&&"undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,ok=(void 0!==globalThis.process&&void 0!==globalThis.process.env&&globalThis.process.env.NODE_ENV,"undefined"!=typeof navigator&&"ReactNative"===navigator.product),sk="ipfs",ak=5e3,lk=1,ck=1,uk=10,dk=8192,hk=!0,fk=!0,pk=!0,gk=32;async function mk(e,t,n,r,i){if(n("received identify from %p",r.remotePeer),null==i)throw new x("message was null or undefined","ERR_INVALID_MESSAGE");const o={};if(i.listenAddrs.length>0&&(o.addresses=i.listenAddrs.map(e=>({isCertified:!1,multiaddr:Wo(e)}))),i.protocols.length>0&&(o.protocols=i.protocols),null!=i.publicKey&&(o.publicKey=i.publicKey,!(await Mr(i.publicKey)).equals(r.remotePeer)))throw new x("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");let s;if(null!=i.signedPeerRecord){n("received signedPeerRecord from %p",r.remotePeer);let t=i.signedPeerRecord;const a=await yy.openAndCertify(t,Ey.DOMAIN);let l,c=Ey.createFromProtobuf(a.payload);if(!c.peerId.equals(a.peerId))throw new x("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!r.remotePeer.equals(c.peerId))throw new x("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");try{l=await e.get(c.peerId)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=l&&(o.metadata=l.metadata,null!=l.peerRecordEnvelope)){const e=await yy.createFromProtobuf(l.peerRecordEnvelope),r=Ey.createFromProtobuf(e.payload);r.seqNumber>=c.seqNumber&&(n("sequence number was lower or equal to existing sequence number - stored: %d received: %d",r.seqNumber,c.seqNumber),c=r,t=l.peerRecordEnvelope)}o.peerRecordEnvelope=t,o.addresses=c.multiaddrs.map(e=>({isCertified:!0,multiaddr:e})),s={seq:c.seqNumber,addresses:c.multiaddrs}}else n("%p did not send a signed peer record",r.remotePeer);if(n("patching %p with",r.remotePeer,o),await e.patch(r.remotePeer,o),null!=i.agentVersion||null!=i.protocolVersion){const t={};null!=i.agentVersion&&(t.AgentVersion=Hn(i.agentVersion)),null!=i.protocolVersion&&(t.ProtocolVersion=Hn(i.protocolVersion)),n("merging %p metadata",r.remotePeer,t),await e.merge(r.remotePeer,{metadata:t})}const a={peerId:r.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(e=>Wo(e)),observedAddr:null==i.observedAddr?void 0:Wo(i.observedAddr),protocols:i.protocols,signedPeerRecord:s,connection:r};return t.safeDispatchEvent("peer:identify",{detail:a}),a}class yk{host;protocol;started;timeout;peerId;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnTransientConnection;log;constructor(e,t){var n,r;this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??ak,this.maxInboundStreams=t.maxInboundStreams??lk,this.maxOutboundStreams=t.maxOutboundStreams??ck,this.maxMessageSize=t.maxMessageSize??dk,this.maxObservedAddresses=t.maxObservedAddresses??uk,this.runOnTransientConnection=t.runOnTransientConnection??pk,this.host={protocolVersion:`${t.protocolPrefix??sk}/0.1.0`,agentVersion:(n=e.nodeInfo,r=t.agentVersion,null!=r||(r=`${n.name}/${n.version}`,rk||tk?r+=` UserAgent=${globalThis.process.version}`:(ek||ik||nk||ok)&&(r+=` UserAgent=${globalThis.navigator.userAgent}`)),r)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:Hn(this.host.agentVersion),ProtocolVersion:Hn(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(e=>{this.log.error(e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}class wk extends yk{connectionManager;concurrency;constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??sk}/id/push/1.0.0`,log:e.logger.forComponent("libp2p:identify-push")}),this.connectionManager=e.connectionManager,this.concurrency=t.concurrency??gk,(t.runOnSelfUpdate??fk)&&e.events.addEventListener("self:peer:update",e=>{this.push().catch(e=>{this.log.error(e)})})}[ey]=["@libp2p/identify-push"];async push(){if(!this.isStarted())return;const e=this.addressManager.getAddresses().map(e=>e.decapsulateCode(Go("p2p").code)),t=new Ey({peerId:this.peerId,multiaddrs:e}),n=await yy.seal(t,this.peerId),r=this.registrar.getProtocols(),i=await this.peerStore.get(this.peerId),o=Ir(i.metadata.get("AgentVersion")??Hn(this.host.agentVersion)),s=Ir(i.metadata.get("ProtocolVersion")??Hn(this.host.protocolVersion)),a=this;await G(lb(async function*(){for(const t of a.connectionManager.getConnections())(await a.peerStore.get(t.remotePeer)).protocols.includes(a.protocol)&&(yield async()=>{let i;const l=AbortSignal.timeout(a.timeout);try{i=await t.newStream(a.protocol,{signal:l,runOnTransientConnection:a.runOnTransientConnection});const c=_S(i,{maxDataLength:a.maxMessageSize}).pb(QS);await c.write({listenAddrs:e.map(e=>e.bytes),signedPeerRecord:n.marshal(),protocols:r,agentVersion:o,protocolVersion:s},{signal:l}),await i.close({signal:l})}catch(e){a.log.error("could not push identify update to peer",e),i?.abort(e)}})}(),{concurrency:this.concurrency}))}async handleProtocol(e){const{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const e={signal:AbortSignal.timeout(this.timeout)},r=_S(n,{maxDataLength:this.maxMessageSize}).pb(QS),i=await r.read(e);await n.close(e),await mk(this.peerStore,this.events,this.log,t,i)}catch(e){return this.log.error("received invalid message",e),void n.abort(e)}this.log("handled push from %p",t.remotePeer)}}class bk extends yk{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??sk}/id/1.0.0`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??hk)&&e.events.addEventListener("connection:open",e=>{const t=e.detail;this.identify(t).catch(e=>{this.log.error("error during identify trigged by connection:open",e)})})}[ey]=["@libp2p/identify"];async _identify(e,t={}){let n;if(null==t.signal){const e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}try{n=await e.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection});const r=_S(n,{maxDataLength:this.maxMessageSize}).pb(QS),i=await r.read(t);return await n.close(t),i}catch(e){throw this.log.error("error while reading identify message",e),n?.abort(e),e}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:r,protocols:i,observedAddr:o}=n;if(null==r)throw new x("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");const s=await Mr(r);if(!e.remotePeer.equals(s))throw new x("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(s))throw new x("identified peer is our own peer id?","ERR_INVALID_PEER");const a=function(e){if(null!=e&&e.length>0)try{return Wo(e)}catch{}}(o);return this.log("identify completed for peer %p and protocols %o",s,i),this.log("our observed address is %a",a),null!=a&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(this.log("storing our observed address %a",a),this.addressManager.addObservedAddr(a)),mk(this.peerStore,this.events,this.log,e,n)}async handleProtocol(e){const{connection:t,stream:n}=e,r=AbortSignal.timeout(this.timeout);try{const e=this.peerId.publicKey??new Uint8Array(0),i=await this.peerStore.get(this.peerId),o=this.addressManager.getAddresses().map(e=>e.decapsulateCode(Go("p2p").code));let s=i.peerRecordEnvelope;if(o.length>0&&null==s){const e=new Ey({peerId:this.peerId,multiaddrs:o});s=(await yy.seal(e,this.peerId)).marshal().subarray()}let a=t.remoteAddr.bytes;no.matches(t.remoteAddr)||(a=void 0);const l=_S(n).pb(QS);await l.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:e,listenAddrs:o.map(e=>e.bytes),signedPeerRecord:s,observedAddr:a,protocols:i.protocols},{signal:r}),await n.close({signal:r})}catch(e){this.log.error("could not respond to identify request",e),n.abort(e)}}}function vk(e={}){return t=>new bk(t,e)}function Ek(e={}){return t=>new wk(t,e)}const Sk=36e5,kk=36*Sk,_k="/dht/provider",Rk=Sk,Ik=20,Ak=3;var xk,Tk,Ck,Nk,Dk,Pk,Lk,Bk;function Ok(e){const t=e.getUTCFullYear(),n=String(e.getUTCMonth()+1).padStart(2,"0"),r=String(e.getUTCDate()).padStart(2,"0"),i=String(e.getUTCHours()).padStart(2,"0"),o=String(e.getUTCMinutes()).padStart(2,"0"),s=String(e.getUTCSeconds()).padStart(2,"0"),a=e.getUTCMilliseconds();return`${t}-${n}-${r}T${i}:${o}:${s}.${String(1e3*a*1e3).padStart(9,"0")}Z`}!function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&e.key.byteLength>0&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),null!=e.timeReceived&&""!==e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==n.lengthDelimited&&t.ldelim()},(e,t,n={})=>{const r={key:Y(0),value:Y(0),timeReceived:""},i=null==t?e.len:e.pos+t;for(;e.pos<i;){const t=e.uint32();switch(t>>>3){case 1:r.key=e.bytes();break;case 2:r.value=e.bytes();break;case 5:r.timeReceived=e.string();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>rr(t,e.codec()),e.decode=(t,n)=>it(t,e.codec(),n)}(xk||(xk={}));class Mk{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return xk.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:Ok(this.timeReceived)}}static deserialize(e){const t=xk.decode(e);return new Mk(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=function(e){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),n=String(e).trim().match(t);if(null==n)throw new Error("Invalid format");const r=parseInt(n[1],10),i=parseInt(n[2],10)-1,o=parseInt(n[3],10),s=parseInt(n[4],10),a=parseInt(n[5],10),l=parseInt(n[6],10),c=parseInt(n[7].slice(0,-6),10);return new Date(Date.UTC(r,i,o,s,a,l,c))}(e.timeReceived);if(null==e.key)throw new Error("key missing from deserialized object");if(null==e.value)throw new Error("value missing from deserialized object");return new Mk(e.key,e.value,t)}}function Uk(e,t={}){const n={...e,name:"SEND_QUERY",type:0,messageName:e.type,messageType:e.type};return t.onProgress?.(new I("kad-dht:query:send-query",{detail:n})),n}function Fk(e,t={}){const n={...e,name:"PEER_RESPONSE",type:1,messageName:e.messageType,closer:e.closer??[],providers:e.providers??[]};return t.onProgress?.(new I("kad-dht:query:peer-response",{detail:n})),n}function zk(e,t={}){const n={...e,name:"FINAL_PEER",type:2};return t.onProgress?.(new I("kad-dht:query:final-peer",{detail:n})),n}function Vk(e,t={}){const n={...e,name:"QUERY_ERROR",type:3};return t.onProgress?.(new I("kad-dht:query:query-error",{detail:n})),n}function $k(e,t={}){const n={...e,name:"PROVIDER",type:4};return t.onProgress?.(new I("kad-dht:query:provider",{detail:n})),n}function Hk(e,t={}){const n={...e,name:"VALUE",type:5};return t.onProgress?.(new I("kad-dht:query:value",{detail:n})),n}function Kk(e,t={}){const n={...e,name:"DIAL_PEER",type:7};return t.onProgress?.(new I("kad-dht:query:dial-peer",{detail:n})),n}!function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.key&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&(t.uint32(18),t.bytes(e.value)),null!=e.author&&(t.uint32(26),t.bytes(e.author)),null!=e.signature&&(t.uint32(34),t.bytes(e.signature)),null!=e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.bytes();break;case 2:n.value=e.bytes();break;case 3:n.author=e.bytes();break;case 4:n.signature=e.bytes();break;case 5:n.timeReceived=e.string();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(Tk||(Tk={})),function(e){e.PUT_VALUE="PUT_VALUE",e.GET_VALUE="GET_VALUE",e.ADD_PROVIDER="ADD_PROVIDER",e.GET_PROVIDERS="GET_PROVIDERS",e.FIND_NODE="FIND_NODE",e.PING="PING"}(Ck||(Ck={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(Nk||(Nk={})),function(e){e.codec=()=>gr(Nk)}(Ck||(Ck={})),function(e){e.NOT_CONNECTED="NOT_CONNECTED",e.CONNECTED="CONNECTED",e.CAN_CONNECT="CAN_CONNECT",e.CANNOT_CONNECT="CANNOT_CONNECT"}(Dk||(Dk={})),function(e){e[e.NOT_CONNECTED=0]="NOT_CONNECTED",e[e.CONNECTED=1]="CONNECTED",e[e.CAN_CONNECT=2]="CAN_CONNECT",e[e.CANNOT_CONNECT=3]="CANNOT_CONNECT"}(Pk||(Pk={})),function(e){e.codec=()=>gr(Pk)}(Dk||(Dk={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.multiaddrs)for(const n of e.multiaddrs)t.uint32(18),t.bytes(n);null!=e.connection&&(t.uint32(24),Dk.codec().encode(e.connection,t)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={id:Y(0),multiaddrs:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.id=e.bytes();break;case 2:n.multiaddrs.push(e.bytes());break;case 3:n.connection=Dk.codec().decode(e);break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(Lk||(Lk={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{if(!1!==n.lengthDelimited&&t.fork(),null!=e.type&&0!==Nk[e.type]&&(t.uint32(8),Ck.codec().encode(e.type,t)),null!=e.clusterLevel&&(t.uint32(80),t.int32(e.clusterLevel)),null!=e.key&&(t.uint32(18),t.bytes(e.key)),null!=e.record&&(t.uint32(26),t.bytes(e.record)),null!=e.closer)for(const n of e.closer)t.uint32(66),Lk.codec().encode(n,t);if(null!=e.providers)for(const n of e.providers)t.uint32(74),Lk.codec().encode(n,t);!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={type:Ck.PUT_VALUE,closer:[],providers:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.type=Ck.codec().decode(e);break;case 10:n.clusterLevel=e.int32();break;case 2:n.key=e.bytes();break;case 3:n.record=e.bytes();break;case 8:n.closer.push(Lk.codec().decode(e,e.uint32()));break;case 9:n.providers.push(Lk.codec().decode(e,e.uint32()));break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(Bk||(Bk={}));const qk={pk:function(e,t){return 0}};async function jk(e,t){const n=t.key,r=Ir(n).split("/");if(r.length<3)return;const i=e[r[1].toString()];if(null==i){const e=`No validator available for key type "${r[1]}"`;throw new x(e,"ERR_INVALID_RECORD_KEY_TYPE")}await i(n,t.value)}const Wk={pk:async(e,t)=>{if(!(e instanceof Uint8Array))throw new x('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(e.byteLength<5)throw new x("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if("/pk/"!==Ir(e.subarray(0,4)))throw new x("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");if(!he(e.slice(4),(await xn.digest(t)).bytes))throw new x("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")}},Gk=Hn("/pk/");function Yk(e){return{...e,multiaddrs:e.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(53===t||54===t||55===t)return"localhost"!==n;if(4!==t&&6!==t)return!1;if(null==n)return!1;const r=Oi(n);return null==r||!r})}}async function Qk(e){return(await xn.digest(e)).digest}async function Xk(e){return Qk(e.toBytes())}function Zk(e){return new ba(`/dht/record/${Ir(e,"base32")}`,!1)}function Jk(e,t){const n=new Date;return new Mk(e,t,n).serialize()}class e_{log;components;validators;selectors;peerRouting;queryManager;network;constructor(e,t){const{validators:n,selectors:r,peerRouting:i,queryManager:o,network:s,logPrefix:a}=t;this.components=e,this.log=e.logger.forComponent(`${a}:content-fetching`),this.validators=n,this.selectors=r,this.peerRouting=i,this.queryManager=o,this.network=s}async getLocal(e){this.log("getLocal %b",e);const t=Zk(e);this.log("fetching record for key %k",t);const n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const r=Mk.deserialize(n);return await jk(this.validators,r),r}async*sendCorrectionRecord(e,t,n,r={}){this.log("sendCorrection for %b",e);const i=Jk(e,n);for(const{value:o,from:s}of t){if(he(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(s)){try{const t=Zk(e);this.log(`Storing corrected record for key ${t.toString()}`),await this.components.datastore.put(t,i.subarray())}catch(e){this.log.error("Failed error correcting self",e)}continue}let t=!1;const a={type:Ck.PUT_VALUE,key:e,record:i};for await(const e of this.network.sendRequest(s,a,r))"PEER_RESPONSE"===e.name&&null!=e.record&&he(e.record.value,Mk.deserialize(i).value)&&(t=!0),yield e;t||(yield Vk({from:s,error:new x("value not put correctly","ERR_PUT_VALUE_INVALID")},r)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);const r=Jk(e,t),i=Zk(e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,r.subarray()),yield*De(this.peerRouting.getClosestPeers(e,{signal:n.signal}),t=>xe(t,t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const i=[],o={type:Ck.PUT_VALUE,key:e,record:r};this.log("send put to %p",t.peer.id);for await(const e of this.network.sendRequest(t.peer.id,o,n))i.push(e),"PEER_RESPONSE"===e.name&&(null!=e.record&&he(e.record.value,Mk.deserialize(r).value)||i.push(Vk({from:t.peer.id,error:new x("value not put correctly","ERR_PUT_VALUE_INVALID")},n)));return i}),e=>lb(e,{ordered:!1,concurrency:Ak}),async function*(e){for await(const t of e)yield*t})}async*get(e,t={}){this.log("get %b",e);const n=[];for await(const r of this.getMany(e,t))"VALUE"===r.name&&n.push(r),yield r;if(0===n.length)return;const r=n.map(e=>e.value);let i=0;try{i=function(e,t,n){if(0===n.length)throw new x("No records given","ERR_NO_RECORDS_RECEIVED");const r=Ir(t).split("/");if(r.length<3)throw new x("Record key does not have a selector function","ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY");const i=e[r[1].toString()];if(null==i){const e=`No selector function configured for key type "${r[1]}"`;throw new x(e,"ERR_UNRECOGNIZED_KEY_PREFIX")}return 1===n.length?0:i(t,n)}(this.selectors,e,r)}catch(e){if("ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY"!==e.code)throw e}const o=r[i];if(this.log("GetValue %b %b",e,o),null==o)throw new x("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,o,t),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const n=await this.getLocal(e);yield Hk({value:n.value,from:this.components.peerId},t)}catch(t){this.log("error getting local value for %b",e,t)}const n=this;yield*this.queryManager.run(e,async function*({peer:r,signal:i}){for await(const o of n.peerRouting.getValueOrPeers(r,e,{signal:i}))yield o,"PEER_RESPONSE"===o.name&&null!=o.record&&(yield Hk({from:r,value:o.record.value},t))},t)}}function t_(e,t){const n={id:e.id.toBytes(),multiaddrs:(e.multiaddrs??[]).map(e=>e.bytes),connection:t};return n}function n_(e){if(null==e.id)throw new Error("Invalid peer in message");return{id:Or(e.id),multiaddrs:(e.multiaddrs??[]).map(e=>Wo(e))}}class r_{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:n,peerRouting:r,queryManager:i,routingTable:o,providers:s,logPrefix:a}=t;this.components=e,this.log=e.logger.forComponent(`${a}:content-routing`),this.network=n,this.peerRouting=r,this.queryManager=i,this.routingTable=o,this.providers=s}async*provide(e,t,n={}){this.log("provide %s",e);const r=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);const i={type:Ck.ADD_PROVIDER,key:r,providers:[t_({id:this.components.peerId,multiaddrs:t})]};let o=0;const s=t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const r=[];this.log("putProvider %s to %p",e,t.peer.id);try{this.log("sending provider record for %s to %p",e,t.peer.id);for await(const s of this.network.sendMessage(t.peer.id,i,n))"PEER_RESPONSE"===s.name&&(this.log("sent provider record for %s to %p",e,t.peer.id),o++),r.push(s)}catch(e){this.log.error("error sending provide record to peer %p",t.peer.id,e),r.push(Vk({from:t.peer.id,error:e},n))}return r};yield*De(this.peerRouting.getClosestPeers(r,n),e=>xe(e,e=>s(e)),e=>lb(e,{ordered:!1,concurrency:Ak}),async function*(e){for await(const t of e)yield*t}),this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let r=0;const i=e.multihash.bytes,o=this;this.log("findProviders %c",e);const s=await this.providers.getProviders(e);if(s.length>0){const e=[];for(const t of s.slice(0,n))try{const n=await this.components.peerStore.get(t);e.push({id:t,multiaddrs:n.addresses.map(({multiaddr:e})=>e)})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e;this.log("no peer store entry for %p",t)}if(yield Fk({from:this.components.peerId,messageType:Ck.GET_PROVIDERS,providers:e},t),yield $k({from:this.components.peerId,providers:e},t),r+=e.length,r>=n)return}const a=async function*({peer:e,signal:n}){const r={type:Ck.GET_PROVIDERS,key:i};yield*o.network.sendRequest(e,r,{...t,signal:n})},l=new gy(s);for await(const o of this.queryManager.run(i,a,t))if(yield o,"PEER_RESPONSE"===o.name){this.log("Found %d provider entries for %c and %d closer peers",o.providers.length,e,o.closer.length);const i=[];for(const e of o.providers)l.has(e.id)||(l.add(e.id),i.push(e));if(i.length>0&&(yield $k({from:o.from,providers:i},t),r+=i.length,r>=n))return}}}class i_ extends R{log;protocol;running;components;timeout;constructor(e,t){super();const{protocol:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=n,this.timeout=new Vw({...t.timeout??{},metrics:e.metrics,metricName:`${t.logPrefix.replaceAll(":","_")}_network_message_send_times_milliseconds`})}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(!this.running)return;const r=t.type;if(null==r)throw new yr("Message type was missing","ERR_INVALID_PARAMETERS");let i;this.log("sending %s to %p",t.type,e),yield Kk({peer:e},n),yield Uk({to:e,type:r},n);const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{const r=await this.components.connectionManager.openConnection(e,n);i=await r.newStream(this.protocol,n);const o=await this._writeReadMessage(i,t,n);i.close(n).catch(t=>{this.log.error("error closing stream to %p",e,t),i?.abort(t)}),yield Fk({from:e,messageType:o.type,closer:o.closer.map(n_),providers:o.providers.map(n_),record:null==o.record?void 0:Mk.deserialize(o.record)},n)}catch(r){i?.abort(r),this.log.error("could not send %s to %p",t.type,e,r),yield Vk({from:e,error:r},n)}finally{this.timeout.cleanUp(o)}}async*sendMessage(e,t,n={}){if(!this.running)return;const r=t.type;if(null==r)throw new yr("Message type was missing","ERR_INVALID_PARAMETERS");let i;this.log("sending %s to %p",t.type,e),yield Kk({peer:e},n),yield Uk({to:e,type:r},n);const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{const o=await this.components.connectionManager.openConnection(e,n);i=await o.newStream(this.protocol,n),await this._writeMessage(i,t,n),i.close(n).catch(t=>{this.log.error("error closing stream to %p",e,t),i?.abort(t)}),yield Fk({from:e,messageType:r},n)}catch(t){i?.abort(t),yield Vk({from:e,error:t},n)}finally{this.timeout.cleanUp(o)}}async _writeMessage(e,t,n){const r=_S(e);await r.write(t,Bk,n),await r.unwrap().close(n)}async _writeReadMessage(e,t,n){const r=_S(e);await r.write(t,Bk,n);const i=await r.read(Bk,n);return await r.unwrap().close(n),i.closer.forEach(e=>{this.safeDispatchEvent("peer",{detail:n_(e)})}),i.providers.forEach(e=>{this.safeDispatchEvent("peer",{detail:n_(e)})}),i}}function o_(e,t){if(e.length!==t.length)throw new Error("Inputs should have the same length");const n=Q(e.length);for(let r=0;r<e.length;r++)n[r]=e[r]^t[r];return n}function s_(e,t){if(e.byteLength!==t.byteLength)throw new Error("Inputs should have the same length");for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return e[n]<t[n]?-1:1;return 0}class a_{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peer)}async add(e){const t=await Xk(e.id);this.addWitKadId(e,t)}addWitKadId(e,t){if(null!=this.peerDistances.find(t=>t.peer.id.equals(e.id)))return;const n={peer:e,distance:o_(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort((e,t)=>s_(e.distance,t.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){return 0===this.length||-1===s_(o_(await Xk(e),this.originDhtKey),this.peerDistances[this.peerDistances.length-1].distance)}async anyCloser(e){return 0!==e.length&&Promise.any(e.map(async e=>this.isCloser(e)))}}class l_{log;routingTable;network;validators;queryManager;peerStore;peerId;constructor(e,t){const{routingTable:n,network:r,validators:i,queryManager:o,logPrefix:s}=t;this.routingTable=n,this.network=r,this.validators=i,this.queryManager=o,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${s}:peer-routing`)}async findPeerLocal(e){let t;const n=await this.routingTable.find(e);if(null!=n){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(n)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}}if(null==t)try{t=await this.peerStore.get(e)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(e=>e.multiaddr)}}async*_getValueSingle(e,t,n={}){const r={type:Ck.GET_VALUE,key:t};yield*this.network.sendRequest(e,r,n)}async*getPublicKeyFromNode(e,t={}){const n=function(e){return de([Gk,e.toBytes()])}(e);for await(const r of this._getValueSingle(e,n,t))if(yield r,"PEER_RESPONSE"===r.name&&null!=r.record){const n=await Mr(Xm({bytes:r.record.value}));if(!n.equals(e))throw new x("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(null==n.publicKey)throw new x("public key missing","ERR_PUBLIC_KEY_MISSING");yield Hk({from:e,value:n.publicKey},t)}throw new x(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){if(this.log("findPeer %p",e),!1!==t.useCache){const n=await this.findPeerLocal(e);if(null!=n)return this.log("found local"),void(yield zk({from:this.peerId,peer:n},t))}let n=!1;if(!1!==t.useNetwork){const r=this,i=async function*({peer:n,signal:i}){const o={type:Ck.FIND_NODE,key:e.toBytes()};for await(const s of r.network.sendRequest(n,o,{...t,signal:i}))if(yield s,"PEER_RESPONSE"===s.name){const n=s.closer.find(t=>t.id.equals(e));null!=n&&(yield zk({from:s.from,peer:n},t))}};for await(const r of this.queryManager.run(e.toBytes(),i,t))"FINAL_PEER"===r.name&&(n=!0),yield r}n||(yield Vk({from:this.peerId,error:new x("Not found","ERR_NOT_FOUND")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await Qk(e),r=this.routingTable.closestPeers(n),i=this,o=new a_(n,this.routingTable.kBucketSize);await Promise.all(r.map(async e=>{await o.add({id:e,multiaddrs:[]})}));const s=async function*({peer:n,signal:r}){i.log("closerPeersSingle %s from %p",Ir(e,"base32"),n);const o={type:Ck.FIND_NODE,key:e};yield*i.network.sendRequest(n,o,{...t,signal:r})};for await(const n of this.queryManager.run(e,s,t))"PEER_RESPONSE"===n.name&&await Promise.all(n.closer.map(async e=>{await o.add(e)})),yield n;this.log("found %d peers close to %b",o.length,e);for(const e of o.peers)yield zk({from:this.peerId,peer:e},t)}async*getValueOrPeers(e,t,n={}){for await(const r of this._getValueSingle(e,t,n)){if("PEER_RESPONSE"===r.name&&null!=r.record)try{await this._verifyRecordOnline(r.record)}catch(e){const t="invalid record received, discarded";this.log(t),yield Vk({from:r.from,error:new x(t,"ERR_INVALID_RECORD")},n);continue}yield r}}async _verifyRecordOnline(e){if(null==e.timeReceived)throw new x("invalid record received","ERR_INVALID_RECORD");await jk(this.validators,new Mk(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const n=await Qk(e),r=this.routingTable.closestPeers(n),i=[];for(const e of r)if(!e.equals(t))try{const t=await this.peerStore.get(e);i.push({id:e,multiaddrs:t.addresses.map(({multiaddr:e})=>e)})}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return i.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",i.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),i}}class c_{log;datastore;cache;cleanupInterval;provideValidity;syncQueue;started;cleaner;constructor(e,t={}){const{cacheSize:n,cleanupInterval:r,provideValidity:i}=t;this.log=e.logger.forComponent("libp2p:kad-dht:providers"),this.datastore=e.datastore,this.cleanupInterval=r??Rk,this.provideValidity=i??864e5,this.cache=Va(n??256),this.syncQueue=new Oa({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{this.log.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,null!=this.cleaner&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{const e=Date.now();let t=0,n=0;const r=new Map,i=this.datastore.batch(),o=this.datastore.query({prefix:_k});for await(const e of o)try{const{cid:o,peerId:s}=d_(e.key),a=h_(e.value).getTime(),l=Date.now(),c=l-a,u=c>this.provideValidity;if(this.log("comparing: %d - %d = %d > %d %s",l,a,c,this.provideValidity,u?"(expired)":""),u){n++,i.delete(e.key);const t=r.get(o)??new Set;t.add(s),r.set(o,t)}t++}catch(e){this.log.error(e.message)}r.size>0?(this.log("deleting %d / %d entries",n,t),await i.commit()):this.log("nothing to delete");for(const[e,t]of r){const n=u_(e),r=this.cache.get(n);if(null!=r){for(const e of t)r.delete(e);0===r.size?this.cache.remove(n):this.cache.set(n,r)}}this.log("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){const t=u_(e);let n=this.cache.get(t);return null==n&&(n=await async function(e,t){const n=new Map,r=e.query({prefix:u_(t)});for await(const e of r){const{peerId:t}=d_(e.key);n.set(t,h_(e.value))}return n}(this.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){await this.syncQueue.add(async()=>{this.log("%p provides %s",t,e);const n=await this._getProvidersMap(e);this.log("loaded %s provs",n.size);const r=new Date;n.set(t.toString(),r);const i=u_(e);this.cache.set(i,n),await async function(e,t,n,r){const i=[u_(t),"/",n.toString()].join(""),o=new ba(i),s=ce(r.getTime());await e.put(o,s)}(this.datastore,e,t,r)})}async getProviders(e){return this.syncQueue.add(async()=>(this.log("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(e=>Br(e))),{throwOnTimeout:!0})}}function u_(e){const t="string"==typeof e?e:Ir(e.multihash.bytes,"base32");return`${_k}/${t}`}function d_(e){const t=e.toString().split("/");if(5!==t.length)throw new Error(`incorrectly formatted provider entry key in datastore: ${e.toString()}`);return{cid:t[3],peerId:t[4]}}function h_(e){return new Date(ue(e))}class f_{disjointPaths;alpha;shutDownController;running;queries;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;metrics;constructor(e,t){const{disjointPaths:n=Ik,alpha:r=Ak,logPrefix:i}=t;this.logPrefix=i,this.disjointPaths=n??Ik,this.running=!1,this.alpha=r??Ak,this.queries=0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,null!=e.metrics&&(this.metrics={runningQueries:e.metrics.registerMetric(`${i.replaceAll(":","_")}_running_queries`),queryTime:e.metrics.registerMetric(`${i.replaceAll(":","_")}_query_time_seconds`)}),this.shutDownController=new AbortController,this.shutDownController.signal}isStarted(){return this.running}async start(){this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");const r=this.metrics?.queryTime.timer();if(null==n.signal){const e=AbortSignal.timeout(18e4);n={...n,signal:e}}const i=new AbortController,o=_([this.shutDownController.signal,i.signal,n.signal]);i.signal;const s=this.logger.forComponent(`${this.logPrefix}:query:`+Ir(e,"base58btc")),a=Date.now();let l=!1;try{!0!==n.isSelfQuery&&null!=this.initialQuerySelfHasRun&&(s("waiting for initial query-self query before continuing"),await H(this.initialQuerySelfHasRun.promise,o),this.initialQuerySelfHasRun=void 0),s("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries);const r=await Qk(e),i=this.routingTable.closestPeers(r),a=i.slice(0,Math.min(this.disjointPaths,i.length));if(0===i.length)return void s.error("Running query with no peers");const c=new gy,u=a.map((r,i)=>async function*(e){const{key:t,startingPeer:n,ourPeerId:r,signal:i,query:o,alpha:s,pathIndex:a,numPaths:l,queryFuncTimeout:c,log:u,peersSeen:d,connectionManager:h}=e,f=new j({concurrency:s,sort:(e,t)=>s_(e.options.distance,t.options.distance)}),p=await Qk(t);!function n(s,g){if(null==s)return;d.add(s);const m=o_(g,p);f.add(async()=>{const g=[i];null!=c&&g.push(AbortSignal.timeout(c));const y=_(g);try{for await(const e of o({key:t,peer:s,signal:y,pathIndex:a,numPaths:l})){if(y.aborted)return;if("PEER_RESPONSE"===e.name)for(const i of e.closer){if(d.has(i.id)){u("already seen %p in query",i.id);continue}if(r.equals(i.id)){u("not querying ourselves");continue}if(!await h.isDialable(i.multiaddrs)){u("not querying undialable peer");continue}const e=await Xk(i.id);-1===s_(o_(e,p),m)?(u("querying closer peer %p",i.id),n(i.id,e)):u("skipping %p as they are not closer to %b than %p",i.id,t,s)}f.safeDispatchEvent("completed",{detail:e})}}catch(t){if(!i.aborted)return Vk({from:s,error:t},e)}finally{y.clear()}},{distance:m}).catch(e=>{u.error(e)})}(n,await Xk(n));try{for await(const e of f.toGenerator({signal:i}))null!=e&&(yield e)}catch(e){if(i.aborted)throw new x("Query aborted","ERR_QUERY_ABORTED");throw e}}({key:e,startingPeer:r,ourPeerId:this.peerId,signal:o,query:t,pathIndex:i,numPaths:a.length,alpha:this.alpha,queryFuncTimeout:n.queryFuncTimeout,log:s,peersSeen:c,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(const e of Ne(...u)){if("QUERY_ERROR"===e.name&&s.error("query error",e.error),"PEER_RESPONSE"===e.name)for(const t of[...e.closer,...e.providers])await this.connectionManager.isDialable(t.multiaddrs)&&await this.routingTable.add(t.id);yield e}l=!0}catch(e){if(this.running||"ERR_QUERY_ABORTED"!==e.code)throw e}finally{l||(s("query exited early"),i.abort()),o.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),null!=r&&r(),s("query:done in %dms",Date.now()-a)}}}const p_=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{let t=0;for await(const n of e)t++;return t})();{let t=0;for(const n of e)t++;return t}};function g_(e,t,n){"function"==typeof n&&(n={filter:n});const r=function(e,t,n){let r;const i=new Promise((i,o)=>{if(!((n={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...n}).count>=0)||n.count!==Number.POSITIVE_INFINITY&&!Number.isInteger(n.count))throw new TypeError("The `count` option should be at least 0 or more");n.signal?.throwIfAborted();const s=[t].flat(),a=[],{addListener:l,removeListener:c}=(e=>{const t=e.addEventListener||e.on||e.addListener,n=e.removeEventListener||e.off||e.removeListener;if(!t||!n)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(e),removeListener:n.bind(e)}})(e),u=(...e)=>{const t=n.multiArgs?e:e[0];n.filter&&!n.filter(t)||(a.push(t),n.count===a.length&&(r(),i(a)))},d=e=>{r(),o(e)};r=()=>{for(const e of s)c(e,u);for(const e of n.rejectionEvents)c(e,d)};for(const e of s)l(e,u);for(const e of n.rejectionEvents)l(e,d);n.signal&&n.signal.addEventListener("abort",()=>{d(n.signal.reason)},{once:!0}),n.resolveImmediately&&i(a)});if(i.cancel=r,"number"==typeof n.timeout){const e=La(i,{milliseconds:n.timeout});return e.cancel=r,e}return i}(e,t,n={...n,count:1,resolveImmediately:!1}),i=r.then(e=>e[0]);return i.cancel=r.cancel,i}class m_{log;peerId;peerRouting;routingTable;count;interval;initialInterval;queryTimeout;started;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){const{peerRouting:n,logPrefix:r,count:i,interval:o,queryTimeout:s,routingTable:a}=t;this.peerId=e.peerId,this.log=e.logger.forComponent(`${r}:query-self`),this.started=!1,this.peerRouting=n,this.routingTable=a,this.count=i??Ik,this.interval=o??3e5,this.initialInterval=t.initialInterval??1e3,this.queryTimeout=s??5e3,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.started=!1,null!=this.timeoutId&&clearTimeout(this.timeoutId),null!=this.controller&&this.controller.abort()}async querySelf(){if(this.started){if(null!=this.querySelfPromise)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=D(),this.started){this.controller=new AbortController;const e=AbortSignal.timeout(this.queryTimeout),t=_([this.controller.signal,e]);this.controller.signal;try{0===this.routingTable.size&&(this.log("routing table was empty, waiting for some peers before running query"),await g_(this.routingTable,"peer:add",{signal:t})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const e=Date.now(),n=await De(this.peerRouting.getClosestPeers(this.peerId.toBytes(),{signal:t,isSelfQuery:!0}),e=>Ue(e,this.count),async e=>p_(e));this.log("self-query found %d peers in %dms",n,Date.now()-e)}catch(e){this.log.error("self-query error",e)}finally{t.clear(),null!=this.initialQuerySelfHasRun&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}else this.log("skip self-query because we are not started")}}function y_(e,t){if(!(t instanceof Uint8Array))throw new TypeError(e+" is not a Uint8Array");if(32!==t.byteLength)throw new TypeError(e+" had incorrect length")}function w_(e){return Array.isArray(e?.peers)}class b_ extends R{root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;constructor(e){super(),this.localPeer=e.localPeer,this.prefixLength=e.prefixLength,this.kBucketSize=e.kBucketSize??v_,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfNodesToPing??3,y_("options.localPeer.kadId",e.localPeer.kadId),this.root={prefix:"",depth:0,peers:[]}}add(e){y_("peer.kadId",e?.kadId);const t=this._determineBucket(e.kadId);if(!(this._indexOf(t,e.kadId)>-1))return t.peers.length===this.splitThreshold&&t.depth<this.prefixLength?(this._split(t),void this.add(e)):t.peers.length<this.kBucketSize?(t.peers.push(e),void this.safeDispatchEvent("added",{detail:e})):void this.safeDispatchEvent("ping",{detail:{oldContacts:t.peers.slice(0,this.numberOfNodesToPing),newContact:e}})}*closest(e,t=this.kBucketSize){const n=new a_(e,t);for(const e of this.toIterable())n.addWitKadId({id:e.peerId,multiaddrs:[]},e.kadId);yield*xe(n.peers,e=>e.id)}count(){return function e(t){if(w_(t))return t.peers.length;let n=0;return null!=t.left&&(n+=e(t.left)),null!=t.right&&(n+=e(t.right)),n}(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}remove(e){const t=this._determineBucket(e),n=this._indexOf(t,e);if(n>-1){const e=t.peers.splice(n,1)[0];this.safeDispatchEvent("removed",{detail:e})}}*toIterable(){yield*function*e(t){w_(t)?yield*t.peers:(yield*e(t.left),yield*e(t.right))}(this.root)}distance(e,t){return BigInt("0x"+Ir(o_(e,t),"base16"))}_determineBucket(e){const t=Ir(e,"base2").substring(0,this.prefixLength);return function e(n,r=0){return w_(n)?n:e("0"===t[r]?n.left:n.right,r+1)}(this.root)}_indexOf(e,t){return e.peers.findIndex(e=>function(e,t){if(e===t)return!0;if(e.length!==t.length)return!1;for(let n=0,r=e.length;n<r;++n)if(e[n]!==t[n])return!1;return!0}(e.kadId,t))}_split(e){const t=e.depth+1,n={prefix:"0",depth:t,peers:[]},r={prefix:"1",depth:t,peers:[]};for(const i of e.peers)"0"===Ir(i.kadId,"base2")[t]?n.peers.push(i):r.peers.push(i);delete e.peers,e.left=n,e.right=r}}const v_=20;class E_ extends R{kBucketSize;kb;pingQueue;log;components;prefixLength;splitThreshold;pingTimeout;pingConcurrency;running;protocol;tagName;tagValue;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??v_,this.pingTimeout=t.pingTimeout??1e4,this.pingConcurrency=t.pingConcurrency??10,this.running=!1,this.protocol=t.protocol,this.tagName=t.tagName??"kad-close",this.tagValue=t.tagValue??50,this.prefixLength=t.prefixLength??32,this.splitThreshold=t.splitThreshold??v_,this.pingQueue=new W({concurrency:this.pingConcurrency,metricName:`${t.logPrefix.replaceAll(":","_")}_ping_queue`,metrics:this.components.metrics}),this.pingQueue.addEventListener("error",e=>{this.log.error("error pinging peer",e.detail)}),null!=this.components.metrics&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_max_depth`)})}isStarted(){return this.running}async start(){this.running=!0;const e=new b_({localPeer:{kadId:await Xk(this.components.peerId),peerId:this.components.peerId},kBucketSize:this.kBucketSize,prefixLength:this.prefixLength,splitThreshold:this.splitThreshold,numberOfNodesToPing:1});this.kb=e,e.addEventListener("ping",e=>{this._onPing(e).catch(e=>{this.log.error("could not process k-bucket ping event",e)})});let t=0;for(const e of await this.components.peerStore.all())if(e.protocols.includes(this.protocol)){const n=await Xk(e.id);this.kb.add({kadId:n,peerId:e.id}),t++}this.log("added %d peer store peers to the routing table",t),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new gy;const n=function(e,t=100){let n;return()=>{clearTimeout(n),n=setTimeout(()=>{e()},t)}}(()=>{const n=new gy(e.closest(e.localPeer.kadId,v_)),r=n.difference(t),i=t.difference(n);Promise.resolve().then(async()=>{for(const e of r)await this.components.peerStore.merge(e,{tags:{[this.tagName]:{value:this.tagValue}}});for(const e of i)await this.components.peerStore.merge(e,{tags:{[this.tagName]:void 0}})}).catch(e=>{this.log.error("Could not update peer tags",e)}),t=n});e.addEventListener("added",e=>{n(),this.safeDispatchEvent("peer:add",{detail:e.detail.peerId})}),e.addEventListener("removed",e=>{n(),this.safeDispatchEvent("peer:remove",{detail:e.detail.peerId})})}async _onPing(e){if(!this.running)return;const{oldContacts:t,newContact:n}=e.detail,r=await Promise.all(t.map(async e=>{const t=this.pingQueue.find(e.peerId);return null!=t?t.join():this.pingQueue.add(async()=>{let t;try{const n={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",e.peerId);const r=await this.components.connectionManager.openConnection(e.peerId,n);t=await r.newStream(this.protocol,n);const i=_S(t);await i.write({type:Ck.PING},Bk,n);const o=await i.read(Bk,n);if(await i.unwrap().close(),o.type!==Ck.PING)throw new x(`Incorrect message type received, expected PING got ${o.type}`,"ERR_BAD_PING_RESPONSE");return!0}catch(n){return this.running&&null!=this.kb&&(this.log.error("could not ping peer %p",e.peerId,n),this.log("evicting old contact after ping failed %p",e.peerId),this.kb.remove(e.kadId)),t?.abort(n),!1}finally{this.metrics?.routingTableSize.update(this.size)}},{peerId:e.peerId})})),i=r.filter(e=>e).length;this.running&&i<t.length&&null!=this.kb&&(this.log("adding new contact %p",n.peerId),this.kb.add(n))}get size(){return null==this.kb?0:this.kb.count()}async find(e){const t=await Xk(e);return this.kb?.get(t)?.peerId}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return null==this.kb?[]:[...this.kb.closest(e,t)]}async add(e){if(null==this.kb)throw new Error("RoutingTable is not started");const t=await Xk(e);this.kb.add({kadId:t,peerId:e}),this.log("added %p with kad id %b",e,t),this.updateMetrics()}async remove(e){if(null==this.kb)throw new Error("RoutingTable is not started");const t=await Xk(e);this.kb.remove(t),this.updateMetrics()}updateMetrics(){if(null==this.metrics||null==this.kb)return;let e=0,t=0,n=0;!function r(i){if(w_(i))return i.depth>n&&(n=i.depth),t++,void(e+=i.peers.length);r(i.left),r(i.right)}(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMaxDepth.update(n)}}const S_=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];class k_{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:n,routingTable:r,refreshInterval:i,refreshQueryTimeout:o,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:routing-table:refresh`),this.peerRouting=n,this.routingTable=r,this.refreshInterval=i??3e5,this.refreshQueryTimeout=o??3e4,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){null!=this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(e=>e.toISOString()).join(", ")} ]`),Promise.all(n.map(async(r,i)=>{try{if(await this._refreshCommonPrefixLength(i,r,e),0===this._numPeersForCpl(t)){const t=Math.min(2*(i+1),n.length-1);for(let n=i+1;n<t+1;n++)try{await this._refreshCommonPrefixLength(n,r,e)}catch(e){this.log.error(e)}}}catch(e){this.log.error(e)}})).catch(e=>{this.log.error(e)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),null!=this.refreshTimeoutId.unref&&this.refreshTimeoutId.unref()}).catch(e=>{this.log.error(e)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval)return void this.log("not running refresh for cpl %s as time since last refresh not above interval",e);const r=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,r,this.routingTable.size);const i=AbortSignal.timeout(this.refreshQueryTimeout),o=await p_(this.peerRouting.getClosestPeers(r.toBytes(),{signal:i}));this.log(`found ${o} peers that were close to imaginary peer %p`,r),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,r,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>15&&(e=15);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(null==this.routingTable.kb)throw new Error("Routing table not started");const t=mi(2),n=(t[1]<<8)+t[0];return Or(await this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e))}async _makePeerId(e,t,n){if(n>15)throw new Error("Cannot generate peer ID for common prefix length greater than 15");const r=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1),i=65535<<16-(n+1),o=S_[(r^32768>>n)&i|t&~i],s=new ArrayBuffer(34),a=new DataView(s,0,s.byteLength);return a.setUint8(0,xn.code),a.setUint8(1,32),a.setUint32(2,o,!1),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(null!=this.routingTable.kb)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=o_(this.routingTable.kb.localPeer.kadId,e);let n=0;for(const e of t){if(0!==e)break;n++}yield n}}}class __{providers;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.providers=t.providers}async handle(e,t){if(this.log("start"),null==t.key||0===t.key.length)throw new x("Missing key","ERR_MISSING_KEY");let n;try{n=Pn.decode(t.key)}catch(e){throw new x("Invalid CID","ERR_INVALID_CID")}null!=t.providers&&0!==t.providers.length||this.log.error("no providers found in message"),await Promise.all(t.providers.map(async t=>{e.equals(t.id)?t.multiaddrs.length<1?this.log("no valid addresses for provider %p. Ignore",e):(this.log("received provider %p for %s (addrs %s)",e,n,t.multiaddrs.map(e=>Wo(e).toString())),await this.providers.addProvider(n,Or(t.id))):this.log("invalid provider peer %p from %p",t.id,e)}))}}class R_{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:n,logPrefix:r}=t;this.log=e.logger.forComponent(`${r}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),null==t.key)throw new x("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");const n=await this.peerRouting.getCloserPeersOffline(t.key,e);he(this.peerId.toBytes(),t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(e=>e.decapsulateCode(Go("p2p").code))});const r={type:Ck.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:e})=>e.length).map(e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map(e=>e.bytes)})),providers:[]};return 0===r.closer.length&&this.log("could not find any peers closer to %b than %p",t.key,e),r}}class I_{peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:n,providers:r,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerStore=e.peerStore,this.peerRouting=n,this.providers=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(null==t.key)throw new x("Invalid GET_PROVIDERS message received - key was missing","ERR_INVALID_MESSAGE");let n;try{n=Pn.decode(t.key)}catch(e){throw new x("Invalid CID","ERR_INVALID_CID")}this.log("%p asking for providers for %s",e,n);const[r,i]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),o=await this._getPeers(r),s=await this._getPeers(i.map(({id:e})=>e)),a={type:Ck.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:s.map(this.peerInfoMapper).filter(({multiaddrs:e})=>e.length).map(e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map(e=>e.bytes)})),providers:o.map(this.peerInfoMapper).filter(({multiaddrs:e})=>e.length).map(e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map(e=>e.bytes)}))};return this.log("got %s providers %s closerPeers",a.providers.length,a.closer.length),a}async _getAddresses(e){return[]}async _getPeers(e){const t=[];for(const n of e)try{const e=await this.peerStore.get(n),r=this.peerInfoMapper({id:n,multiaddrs:e.addresses.map(({multiaddr:e})=>e)});r.multiaddrs.length>0&&t.push(r)}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}return t}}class A_{peerStore;datastore;peerRouting;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),null==n||0===n.length)throw new x("Invalid key","ERR_INVALID_KEY");const r={type:Ck.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(function(e){return"/pk/"===Ir(e.subarray(0,4))}(n)){this.log("is public key");const e=function(e){return Or(e.subarray(4))}(n);let t;try{const n=await this.peerStore.get(e);if(null==n.id.publicKey)throw new x("No public key found in key book","ERR_NOT_FOUND");t=n.id.publicKey}catch(e){if("ERR_NOT_FOUND"!==e.code)throw e}if(null!=t)return this.log("returning found public key"),r.record=new Mk(n,t,new Date).serialize(),r}const[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(n,e)]);return null!=i&&(this.log("had record for %b in local datastore",n),r.record=i.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),r.closer=o.map(e=>({id:e.id.toBytes(),multiaddrs:e.multiaddrs.map(e=>e.bytes)}))),r}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=Zk(e);let n;try{n=await this.datastore.get(t)}catch(e){if("ERR_NOT_FOUND"===e.code)return;throw e}const r=Mk.deserialize(n);if(null==r)throw new x("Invalid record","ERR_INVALID_RECORD");if(!(null==r.timeReceived||Date.now()-r.timeReceived.getTime()>kk))return r;await this.datastore.delete(t)}}class x_{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class T_{components;validators;log;constructor(e,t){const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),null==t.record){const t=`Empty record from: ${e.toString()}`;throw this.log.error(t),new x(t,"ERR_EMPTY_RECORD")}try{const e=Mk.deserialize(t.record);await jk(this.validators,e),e.timeReceived=new Date;const r=Zk(e.key);await this.components.datastore.put(r,e.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,r)}catch(e){this.log("did not put record for key %b into datastore %o",n,e)}return t}}class C_{handlers;routingTable;log;constructor(e,t){const{providers:n,peerRouting:r,validators:i,logPrefix:o,peerInfoMapper:s}=t;this.log=e.logger.forComponent(`${o}:rpc`),this.routingTable=t.routingTable,this.handlers={[Ck.GET_VALUE.toString()]:new A_(e,{peerRouting:r,logPrefix:o}),[Ck.PUT_VALUE.toString()]:new T_(e,{validators:i,logPrefix:o}),[Ck.FIND_NODE.toString()]:new R_(e,{peerRouting:r,logPrefix:o,peerInfoMapper:s}),[Ck.ADD_PROVIDER.toString()]:new __(e,{providers:n,logPrefix:o}),[Ck.GET_PROVIDERS.toString()]:new I_(e,{peerRouting:r,providers:n,logPrefix:o,peerInfoMapper:s}),[Ck.PING.toString()]:new x_(e,{logPrefix:o})}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(e){this.log.error("Failed to update the kbucket store",e)}const n=this.handlers[t.type];if(null!=n)return n.handle(e,t);this.log.error(`no handler found for message type: ${t.type}`)}onIncomingStream(e){Promise.resolve().then(async()=>{const{stream:t,connection:n}=e,r=n.remotePeer;try{await this.routingTable.add(r)}catch(e){this.log.error(e)}const i=this;await De(t,e=>Ie(e),async function*(e){for await(const t of e){const e=Bk.decode(t);i.log("incoming %s from %p",e.type,r);const n=await i.handleMessage(r,e);null!=n&&(yield Bk.encode(n))}},e=>be(e),t)}).catch(e=>{this.log.error(e)})}}class N_ extends R{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:n,logPrefix:r}=t;this.components=e,this.log=e.logger.forComponent(`${r}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new I("peer",{detail:e}))}}))}async stop(){this.running=!1,null!=this.registrarId&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class D_{dht;constructor(e){this.dht=e}async provide(e,t={}){await G(this.dht.provide(e,t))}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))"PROVIDER"===n.name&&(yield*n.providers)}async put(e,t,n){await G(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if("VALUE"===n.name)return n.value;throw new x("Not found","ERR_NOT_FOUND")}}class P_{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if("FINAL_PEER"===n.name)return n.peer;throw new x("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))"FINAL_PEER"===n.name&&(yield n.peer)}}class L_ extends R{protocol;routingTable;providers;network;peerRouting;components;log;running;kBucketSize;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;constructor(e,t={}){super();const{kBucketSize:n,clientMode:r,validators:i,selectors:o,querySelfInterval:s,protocol:a,logPrefix:l,pingTimeout:c,pingConcurrency:u,maxInboundStreams:d,maxOutboundStreams:h,providers:f}=t,p=l??"libp2p:kad-dht";this.running=!1,this.components=e,this.log=e.logger.forComponent(p),this.protocol=a??"/ipfs/kad/1.0.0",this.kBucketSize=n??20,this.clientMode=r??!0,this.maxInboundStreams=d??32,this.maxOutboundStreams=h??64,this.peerInfoMapper=t.peerInfoMapper??Yk,this.routingTable=new E_(e,{kBucketSize:n,pingTimeout:c,pingConcurrency:u,protocol:this.protocol,logPrefix:p}),this.providers=new c_(e,f??{}),this.validators={...Wk,...i},this.selectors={...qk,...o},this.network=new i_(e,{protocol:this.protocol,logPrefix:p});const g=D();!0===t.allowQueryWithZeroPeers&&g.resolve(),this.queryManager=new f_(e,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:p,initialQuerySelfHasRun:g,routingTable:this.routingTable}),this.peerRouting=new l_(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:p}),this.contentFetching=new e_(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:p}),this.contentRouting=new r_(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:p}),this.routingTableRefresh=new k_(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:p}),this.rpc=new C_(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:p,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new N_(e,{protocol:this.protocol,logPrefix:p}),this.querySelf=new m_(e,{peerRouting:this.peerRouting,interval:s,initialInterval:t.initialQuerySelfInterval,logPrefix:p,initialQuerySelfHasRun:g,routingTable:this.routingTable}),this.network.addEventListener("peer",e=>{const t=e.detail;this.onPeerConnect(t).catch(e=>{this.log.error("could not add %p to routing table",t.id,e)}),this.dispatchEvent(new I("peer",{detail:t}))}),this.topologyListener.addEventListener("peer",e=>{const t=e.detail;Promise.resolve().then(async()=>{const e=await this.components.peerStore.get(t),n={id:t,multiaddrs:e.addresses.map(({multiaddr:e})=>e),protocols:e.protocols};await this.onPeerConnect(n)}).catch(e=>{this.log.error("could not add %p to routing table",t,e)})}),this.dhtPeerRouting=new P_(this),this.dhtContentRouting=new D_(this),null==t.clientMode&&e.events.addEventListener("self:peer:update",e=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const t=e.detail.peer.addresses.some(({multiaddr:e})=>function(e){const t=e.stringTuples();for(const e of t)if(290===e[0])return!1;if(54===t[0][0]||55===t[0][0]||56===t[0][0])return!0;if(4===t[0][0]||41===t[0][0]){const e=Oi(`${t[0][1]}`);return null==e||!e}return!1}(e)),n=this.getMode();t&&"client"===n?await this.setMode("server"):"server"!==n||t||await this.setMode("client")}).catch(e=>{this.log.error("error setting dht server mode",e)})})}[Symbol.toStringTag]="@libp2p/kad-dht";[ey]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"];[ty]=["@libp2p/identify"];get[_a](){return this.dhtContentRouting}get[Ra](){return this.dhtPeerRouting}get[py](){return this}async onPeerConnect(e){if(this.log("peer %p connected",e.id),0!==(e=this.peerInfoMapper(e)).multiaddrs.length)try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}else this.log("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(e=>e.toString()))}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),"client"===e?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Aa(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.topologyListener,this.routingTableRefresh)}async stop(){this.running=!1,await xa(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}var B_,O_;function M_(e={}){return t=>new L_(t,e)}!function(e){e[e.SEND_QUERY=0]="SEND_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADD_PEER=6]="ADD_PEER",e[e.DIAL_PEER=7]="DIAL_PEER"}(B_||(B_={})),function(e){e[e.NEW_STREAM=0]="NEW_STREAM",e[e.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",e[e.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",e[e.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",e[e.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",e[e.RESET_RECEIVER=5]="RESET_RECEIVER",e[e.RESET_INITIATOR=6]="RESET_INITIATOR"}(O_||(O_={}));const U_=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),F_=Object.freeze({NEW_STREAM:O_.NEW_STREAM,MESSAGE:O_.MESSAGE_INITIATOR,CLOSE:O_.CLOSE_INITIATOR,RESET:O_.RESET_INITIATOR}),z_=Object.freeze({MESSAGE:O_.MESSAGE_RECEIVER,CLOSE:O_.CLOSE_RECEIVER,RESET:O_.RESET_RECEIVER}),V_=1<<20;class $_{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=V_,t=4194304){this._buffer=new me,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(null==e||0===e.length)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const t=[];for(;0!==this._buffer.length;){if(null==this._headerInfo)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(e){if("ERR_MSG_TOO_BIG"===e.code)throw e;break}const{id:e,type:n,length:r,offset:i}=this._headerInfo;if(this._buffer.length-i<r)break;const o={id:e,type:n};n!==O_.NEW_STREAM&&n!==O_.MESSAGE_INITIATOR&&n!==O_.MESSAGE_RECEIVER||(o.data=this._buffer.sublist(i,i+r)),t.push(o),this._buffer.consume(i+r),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=q_(e),{value:r,offset:i}=q_(e,n),o=7&t;if(null==U_[o])throw new Error(`Invalid type received: ${o}`);if(r>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:n+i,length:r}}}const H_=128,K_=127;function q_(e,t=0){let n,r=0,i=0,o=t;const s=e.length;do{if(o>=s||i>49)throw t=0,new RangeError("Could not decode varint");n=e.get(o++),r+=i<28?(n&K_)<<i:(n&K_)*Math.pow(2,i),i+=7}while(n>=H_);return{value:r,offset:t=o-t}}const j_=10240,W_=new class{_pool;_poolOffset;constructor(){this._pool=Q(j_),this._poolOffset=0}write(e,t){const n=this._pool;let r=this._poolOffset;ce(e.id<<3|e.type,n,r),r+=se(e.id<<3|e.type),e.type!==O_.NEW_STREAM&&e.type!==O_.MESSAGE_INITIATOR&&e.type!==O_.MESSAGE_RECEIVER||null==e.data?(ce(0,n,r),r+=se(0)):(ce(e.data.length,n,r),r+=se(e.data.length));const i=n.subarray(this._poolOffset,r);j_-r<100?(this._pool=Q(j_),this._poolOffset=0):this._poolOffset=r,t.append(i),e.type!==O_.NEW_STREAM&&e.type!==O_.MESSAGE_INITIATOR&&e.type!==O_.MESSAGE_RECEIVER||null==e.data||t.append(e.data)}};class G_ extends sE{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types="outbound"===e.direction?F_:z_,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:F_.NEW_STREAM,data:new me(Hn(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function Y_(e){const t={...e,type:`${U_[e.type]} (${e.type})`};return e.type===O_.NEW_STREAM&&(t.data=Ir(e.data instanceof Uint8Array?e.data:e.data.subarray())),e.type!==O_.MESSAGE_INITIATOR&&e.type!==O_.MESSAGE_RECEIVER||(t.data=Ir(e.data instanceof Uint8Array?e.data:e.data.subarray(),"base16")),t}class Q_{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??500,this.sink=this._createSink(),this._source=O({objectMode:!0,onEnd:()=>{for(const e of this._streams.initiators.values())e.destroy();for(const e of this._streams.receivers.values())e.destroy()}}),this.source=De(this._source,e=>async function*(e){for await(const t of e){const e=new me;W_.write(t,e),yield e}}(e)),this.closeController=new AbortController,this.rateLimiter=new uw({points:t.disconnectThreshold??5,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const t=this._streamId++;e=null==e?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;const t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async e=>e.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(e){this.abort(e)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:n}=e,r=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:r})}_newStream(e){const{id:t,name:n,type:r,registry:i}=e;if(this.log("new %s stream %s",r,t),"initiator"===r&&this._streams.initiators.size===(this._init.maxOutboundStreams??1024))throw new x("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(i.has(t))throw new Error(`${r} stream ${t} already exists!`);const o=function(e){const{id:t,name:n,send:r,onEnd:i,type:o="initiator",maxMsgSize:s=V_}=e;return new G_({id:"initiator"===o?`i${t}`:`r${t}`,streamId:t,name:`${n??t}`,direction:"initiator"===o?"outbound":"inbound",maxDataSize:s,onEnd:i,send:r,log:e.logger.forComponent(`libp2p:mplex:stream:${o}:${t}`)})}({id:t,name:n,send:async e=>{this.log.enabled&&this.log.trace("%s stream %s send",r,t,Y_(e)),this._source.push(e)},type:r,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",r,t,o.protocol),i.delete(t),null!=this._init.onStreamEnd&&this._init.onStreamEnd(o)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return i.set(t,o),o}_createSink(){return async e=>{const t=()=>{iE(e,this.log)};this.closeController.signal.addEventListener("abort",t);try{const t=new $_(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const n of e)for(const e of t.write(n))await this._handleIncoming(e);this._source.end()}catch(e){this.log("error in sink",e),this._source.end(e)}finally{this.closeController.signal.removeEventListener("abort",t)}}}async _handleIncoming(e){const{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",Y_(e)),e.type===O_.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??1024)){this.log("too many inbound streams open"),this._source.push({id:t,type:O_.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{return this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),void this.abort(new Error("Too many open streams"))}return}const n=this._newReceiverStream({id:t,name:Ir(e.data instanceof Uint8Array?e.data:e.data.subarray())});return void(null!=this._init.onIncomingStream&&this._init.onIncomingStream(n))}const r=(1&~n?this._streams.receivers:this._streams.initiators).get(t);if(null==r){this.log("missing stream %s for message type %s",t,U_[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{return this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),void this.abort(new Error("Too many messages for missing streams"))}return}const i=this._init.maxStreamBufferSize??4194304;try{switch(n){case O_.MESSAGE_INITIATOR:case O_.MESSAGE_RECEIVER:if(r.sourceReadableLength()>i)throw this._source.push({id:e.id,type:n===O_.MESSAGE_INITIATOR?O_.RESET_RECEIVER:O_.RESET_INITIATOR}),new x("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");r.sourcePush(e.data);break;case O_.CLOSE_INITIATOR:case O_.CLOSE_RECEIVER:r.remoteCloseWrite();break;case O_.RESET_INITIATOR:case O_.RESET_RECEIVER:r.reset();break;default:this.log("unknown message type %s",n)}}catch(e){this.log.error("error while processing message",e),r.abort(e)}}}class X_{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[ey]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new Q_(this.components,{...e,...this._init})}}function Z_(e={}){return t=>new X_(t,e)}const J_="ERR_WRONG_PING_ACK";class eR{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnTransientConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnTransientConnection=t.runOnTransientConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,n=Date.now();AbortSignal.timeout(this.timeout).addEventListener("abort",()=>{t?.abort(new x("ping timeout",C))}),De(t,async function*(e){let n=0;for await(const r of e){if(n+=r.byteLength,n>32)return void t?.abort(new x("Too much data received",N));yield r}},t).catch(n=>{this.log.error("incoming ping from %p failed with error",e.connection.remotePeer,n),t?.abort(n)}).finally(()=>{const t=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,t)})}async ping(e,t={}){this.log("pinging %p",e);const n=Date.now(),r=mi(32),i=await this.components.connectionManager.openConnection(e,t);let o,s=()=>{};if(null==t.signal){const e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}try{o=await i.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection}),s=()=>{o?.abort(new x("ping timeout",C))},t.signal?.addEventListener("abort",s,{once:!0});const e=await De([r],o,async e=>CE(e)),a=Date.now()-n;if(null==e)throw new x(`Did not receive a ping ack after ${a}ms`,J_);if(!he(r,e.subarray()))throw new x(`Received wrong ping ack after ${a}ms`,J_);return this.log("ping %p complete in %dms",i.remotePeer,a),a}catch(e){throw this.log.error("error while pinging %p",i.remotePeer,e),o?.abort(e),e}finally{t.signal?.removeEventListener("abort",s),null!=o&&await o.close()}}}function tR(e={}){return t=>new eR(t,e)}var nR;!function(e){e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",e.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",e.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"}(nR||(nR={}));class rR extends x{constructor(e,t){super(`WebRTC transport error: ${e}`,t??""),this.name="WebRTCTransportError"}}class iR extends rR{constructor(e,t){super(`[stream: ${e}] data channel error: ${t}`,nR.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}}function oR(e,t){return new iR(e,t)}class sR extends rR{constructor(e){super(`There was a problem with the Multiaddr which was passed in: ${e}`,nR.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}}function aR(e){return new sR(e)}class lR extends rR{constructor(e){super(`There was a problem with a provided argument: ${e}`,nR.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}}function cR(e){return new lR(e)}class uR extends rR{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`,nR.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}}function dR(e,t){return new uR(e,t)}class hR extends rR{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`,nR.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}}class fR extends rR{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `,nR.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var pR=n(606),gR=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},mR=function(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"},yR=function(e){this.version=e,this.type="node",this.name="node",this.os=pR.platform},wR=function(e,t,n,r){this.name=e,this.version=t,this.os=n,this.bot=r,this.type="bot-device"},bR=function(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null},vR=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,ER=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],SR=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function kR(e){var t=function(e){return""!==e&&ER.reduce(function(t,n){var r=n[0],i=n[1];if(t)return t;var o=i.exec(e);return!!o&&[r,o]},!1)}(e);if(!t)return null;var n=t[0],r=t[1];if("searchbot"===n)return new bR;var i=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);i?i.length<3&&(i=gR(gR([],i,!0),function(e){for(var t=[],n=0;n<e;n++)t.push("0");return t}(3-i.length),!0)):i=[];var o=i.join("."),s=function(e){for(var t=0,n=SR.length;t<n;t++){var r=SR[t],i=r[0];if(r[1].exec(e))return i}return null}(e),a=vR.exec(e);return a&&a[1]?new wR(n,o,s,a[1]):new mR(n,o,s)}const _R=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],RR="undefined"==typeof document&&"undefined"!=typeof navigator&&"ReactNative"===navigator.product?new function(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}:"undefined"!=typeof navigator?kR(navigator.userAgent):void 0!==pR&&pR.version?new yR(pR.version.slice(1)):null;const IR=null!=RR&&"firefox"===RR.name,AR=async function*(){},xR=async e=>{};async function TR(e){return"function"==typeof(e=e??{})&&(e=await e()),e.iceServers=e.iceServers??_R.map(e=>({urls:[e]})),e}class CR{log;peerConnection;remoteAddr;timeline;metrics;source=AR();sink=xR;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",n),"disconnected"!==this.peerConnection.connectionState&&"failed"!==this.peerConnection.connectionState&&"closed"!==this.peerConnection.connectionState||(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}}var NR;!function(e){let t,n,r;!function(e){e.FIN="FIN",e.STOP_SENDING="STOP_SENDING",e.RESET="RESET",e.FIN_ACK="FIN_ACK"}(t=e.Flag||(e.Flag={})),function(e){e[e.FIN=0]="FIN",e[e.STOP_SENDING=1]="STOP_SENDING",e[e.RESET=2]="RESET",e[e.FIN_ACK=3]="FIN_ACK"}(n||(n={})),function(e){e.codec=()=>gr(n)}(t=e.Flag||(e.Flag={})),e.codec=()=>(null==r&&(r=mr((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.flag&&(n.uint32(8),e.Flag.codec().encode(t.flag,n)),null!=t.message&&(n.uint32(18),n.bytes(t.message)),!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.flag=e.Flag.codec().decode(t);break;case 2:r.message=t.bytes();break;default:t.skipType(7&n)}}return r})),r),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(NR||(NR={}));const DR=function(e=16384){const t=se(e-se(e)),n=1+se(Object.keys(NR.Flag).length-1);return t+n+1+se(e-t-n-1)}();class PR extends sE{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;constructor(e){const t=e.onEnd;switch(e.onEnd=e=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve(async()=>{if(null==this.timeline.abort&&null===this.timeline.reset)try{await La(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(e){this.log.error("error receiving FIN_ACK",e)}}).then(()=>{this.incomingData.end(),t?.(e)}).catch(e=>{this.log.error("error ending stream",e)})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=O(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??3e4,this.maxBufferedAmount=e.maxBufferedAmount??2097152,this.maxMessageSize=(e.maxMessageSize??16384)-DR,this.receiveFinAck=D(),this.finAckTimeout=e.closeTimeout??5e3,this.openTimeout=e.openTimeout??5e3,this.channel.readyState){case"open":this.timeline.open=(new Date).getTime();break;case"closed":case"closing":void 0!==this.timeline.close&&0!==this.timeline.close||(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new x("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=e=>{this.timeline.open=(new Date).getTime()},this.channel.onclose=e=>{this.receiveFinAck.resolve(),this.close().catch(e=>{this.log.error("error closing stream after channel closed",e)})},this.channel.onerror=e=>{const t=e.error;this.abort(t)},this.channel.onmessage=async e=>{const{data:t}=e;null!==t&&0!==t.byteLength&&this.incomingData.push(new Uint8Array(t,0,t.byteLength))};const n=this;Promise.resolve().then(async()=>{for await(const e of Ie(this.incomingData)){const t=n.processIncomingProtobuf(e);null!=t&&n.sourcePush(new me(t))}}).catch(e=>{this.log.error("error processing incoming data channel messages",e)})}sendNewStream(){}async _sendMessage(e,t=!0){if(t&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await g_(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(e){if(e instanceof Ca)throw new x(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT");throw e}if("closed"===this.channel.readyState||"closing"===this.channel.readyState)throw new x(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");"open"!==this.channel.readyState&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await g_(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(e.subarray())}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxMessageSize),n=e.subarray(0,t),r=NR.encode({message:n}),i=be.single(r);await this._sendMessage(i),e.consume(t)}}async sendReset(){await this._sendFlag(NR.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(NR.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await H(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(e){this.log.error("failed to await FIN_ACK",e)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(NR.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=NR.decode(e);if(void 0!==t.flag&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===NR.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(NR.Flag.FIN_ACK).catch(e=>{this.log.error("error sending FIN_ACK immediately",e)})),t.flag===NR.Flag.RESET&&this.reset(),t.flag===NR.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===NR.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),"ready"===this.readStatus)return t.message}async _sendFlag(e){if("open"!==this.channel.readyState)return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,e.toString()),!1;this.log.trace("sending flag %s",e.toString());const t=NR.encode({flag:e}),n=be.single(t);try{return await this._sendMessage(n,!1),!0}catch(t){this.log.error("could not send flag %s",e.toString(),t)}return!1}}function LR(e){const{channel:t,direction:n}=e;return new PR({id:"inbound"===n?`i${t.id}`:`r${t.id}`,log:e.logger.forComponent(`libp2p:webrtc:stream:${n}:${t.id}`),...e})}const BR="/webrtc";class OR{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??BR,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=({channel:t})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',t.id),"init"===t.label)return this.log.trace("closing early init channel"),void t.close();const n={},r=LR({channel:t,direction:"inbound",onEnd:e=>{n.onEnd(e)},logger:e.logger,...this.dataChannelOptions});n.stream=r,n.channel=t,n.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(e=>e.stream.id!==r.id)},this.bufferedStreams.push(n)}}createStreamMuxer(e){return new MR(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}class MR{init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(e=>e.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??BR,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:e})=>{if(this.log.trace("incoming datachannel with channel id %d",e.id),"init"===e.label)return this.log.trace("closing init channel"),void e.close();const n=LR({channel:e,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",e.id,e.readyState),this.#j(n,e)},logger:this.logger,...this.dataChannelOptions});this.streams.push(n),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(n)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(e=>{e.onEnd=()=>{this.log("incoming early channel %s ended with state %s",e.channel.id,e.channel.readyState),this.#j(e.stream,e.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(e.stream)})})}#j(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),function(e,t,n=3e4,r){"open"===e.readyState&&Promise.resolve().then(async()=>{if(e.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",t,e.bufferedAmount);const i=D();let o=!1;e.bufferedAmountLowThreshold=0;const s=()=>{o||(r.log("%s drain channel closed before drain",t),i.resolve())};e.addEventListener("close",s,{once:!0}),e.addEventListener("bufferedamountlow",()=>{o=!0,e.removeEventListener("close",s),i.resolve()}),await La(i.promise,{milliseconds:n})}}).then(async()=>{"open"===e.readyState&&e.close()}).catch(e=>{r.log.error("error closing outbound stream",e)})}(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(t=>t.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(e){this.abort(e)}}abort(e){for(const t of this.streams)t.abort(e)}source=AR();sink=xR;newStream(){const e=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",e.id);const t=LR({channel:e,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",e.id,e.readyState),this.#j(t,e)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(t),this.metrics?.increment({outgoing_stream:!0}),t}}const UR=globalThis.RTCPeerConnection,FR=globalThis.RTCSessionDescription,zR=globalThis.RTCIceCandidate;var VR;!function(e){let t,n,r;!function(e){e.SDP_OFFER="SDP_OFFER",e.SDP_ANSWER="SDP_ANSWER",e.ICE_CANDIDATE="ICE_CANDIDATE"}(t=e.Type||(e.Type={})),function(e){e[e.SDP_OFFER=0]="SDP_OFFER",e[e.SDP_ANSWER=1]="SDP_ANSWER",e[e.ICE_CANDIDATE=2]="ICE_CANDIDATE"}(n||(n={})),function(e){e.codec=()=>gr(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=mr((t,n,r={})=>{!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.data&&(n.uint32(18),n.string(t.data)),!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.data=t.string();break;default:t.skipType(7&n)}}return r})),r),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(VR||(VR={}));const $R=async(e,t,n)=>{try{const r=D();for(function(e,t){e[IR?"oniceconnectionstatechange":"onconnectionstatechange"]=n=>{switch(function(e){return IR?e.iceConnectionState:e.connectionState}(e)){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new x("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"))}}}(e,r);;){const i=await Promise.race([r.promise,t.read({signal:n.signal}).catch(()=>{})]);if(null==i){n.signal?.throwIfAborted();break}if(i.type!==VR.Type.ICE_CANDIDATE)throw new x("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");const o=JSON.parse(i.data??"null");if(""===o||null===o){n.onProgress?.(new Fe("webrtc:end-of-ice-candidates")),n.log.trace("end-of-candidates received");continue}const s=new zR(o);n.log.trace("%s received new ICE candidate %o",n.direction,o);try{n.onProgress?.(new Fe("webrtc:add-ice-candidate",s.candidate)),await e.addIceCandidate(s)}catch(e){n.log.error("%s bad candidate received",n.direction,o,e)}}}catch(e){if(n.log.error("%s error parsing ICE candidate",n.direction,e),!0===n.signal?.aborted)throw e}};class HR extends R{peerId;transportManager;shutdownController;constructor(e,t){super(),this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=t.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(e=>e!==this).map(e=>e.getAddrs().filter(e=>fS.matches(e)).map(e=>e.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}}const KR="/webrtc",qR="/p2p-circuit",jR="/webrtc-signaling/0.0.1";class WR{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[Gy]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[ey]=["@libp2p/transport"];[ty]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(jR,e=>{this._onProtocol(e).catch(t=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(jR),this._started=!1}createListener(e){return new HR(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(bo.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:n,peerConnection:r,muxerFactory:i}=await async function({rtcConfiguration:e,dataChannel:t,signal:n,metrics:r,multiaddr:i,connectionManager:o,transportManager:s,log:a,logger:l,onProgress:c}){const{baseAddr:u}=function(e){const t=e.toString().split(KR+"/");if(2!==t.length)throw new x("webrtc protocol was not present in multiaddr",nR.ERR_INVALID_MULTIADDR);if(!t[0].includes(qR))throw new x("p2p-circuit protocol was not present in multiaddr",nR.ERR_INVALID_MULTIADDR);let n=Wo(t[0]);const r=Wo("/"+t[1]).getPeerId();if(null==r)throw new x("destination peer id was missing",nR.ERR_INVALID_MULTIADDR);const i=n.protos().pop();if(void 0===i)throw new x("invalid multiaddr",nR.ERR_INVALID_MULTIADDR);return"p2p"!==i.name&&(n=n.encapsulate(`/p2p/${r}`)),{baseAddr:n,peerId:Br(r)}}(i);r?.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",u);const d=u.getPeerId();if(null==d)throw new x("Relay peer was missing","ERR_INVALID_ADDRESS");const h=o.getConnections(Br(d));let f,p=!1;0===h.length?(c?.(new Fe("webrtc:dial-relay")),f=await s.dial(u,{signal:n,onProgress:c}),p=!0):(c?.(new Fe("webrtc:reuse-relay-connection")),f=h[0]);try{c?.(new Fe("webrtc:open-signaling-stream"));const r=await f.newStream(jR,{signal:n,runOnTransientConnection:!0}),o=_S(r).pb(VR),s=new UR(e),u=new OR({logger:l},{peerConnection:s,dataChannelOptions:t});try{const e=s.createDataChannel("init");s.onicecandidate=({candidate:e})=>{const t=JSON.stringify(e?.toJSON()??null);a.trace("initiator sending ICE candidate %o",e),o.write({type:VR.Type.ICE_CANDIDATE,data:t},{signal:n}).catch(e=>{a.error("error sending ICE candidate",e)})},s.onicecandidateerror=e=>{a.error("initiator ICE candidate error",e)};const t=await s.createOffer().catch(e=>{throw a.error("could not execute createOffer",e),new x("Failed to set createOffer","ERR_SDP_HANDSHAKE_FAILED")});a.trace("initiator send SDP offer %s",t.sdp),c?.(new Fe("webrtc:send-sdp-offer")),await o.write({type:VR.Type.SDP_OFFER,data:t.sdp},{signal:n}),await s.setLocalDescription(t).catch(e=>{throw a.error("could not execute setLocalDescription",e),new x("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),c?.(new Fe("webrtc:read-sdp-answer"));const l=await o.read({signal:n});if(l.type!==VR.Type.SDP_ANSWER)throw new x("Remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",l.data);const d=new FR({type:"answer",sdp:l.data});return await s.setRemoteDescription(d).catch(e=>{throw a.error("could not execute setRemoteDescription",e),new x("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}),a.trace("initiator read candidates until connected"),c?.(new Fe("webrtc:read-ice-candidates")),await $R(s,o,{direction:"initiator",signal:n,log:a,onProgress:c}),a.trace("initiator connected, closing init channel"),e.close(),c?.(new Fe("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await r.close({signal:n}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:s,muxerFactory:u}}catch(e){throw a.error("outgoing signaling error",e),s.close(),r.abort(e),e}finally{s.onicecandidate=null,s.onicecandidateerror=null}}finally{if(p)try{await f.close({signal:n})}catch(e){f.abort(e)}}}({rtcConfiguration:await TR(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new CR(this.components,{peerConnection:r,timeline:{open:Date.now()},remoteAddr:n,metrics:this.metrics?.dialerEvents}),s=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:t.onProgress});return this._closeOnShutdown(r,o),s}async _onProtocol({connection:e,stream:t}){const n=AbortSignal.timeout(this.init.inboundConnectionTimeout??3e4),r=new UR(await TR(this.init.rtcConfiguration)),i=new OR(this.components,{peerConnection:r,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:o}=await async function({peerConnection:e,stream:t,signal:n,connection:r,log:i}){i.trace("new inbound signaling stream");const o=_S(t).pb(VR);try{e.onicecandidate=({candidate:e})=>{const t=JSON.stringify(e?.toJSON()??null);i.trace("recipient sending ICE candidate %s",t),o.write({type:VR.Type.ICE_CANDIDATE,data:t},{signal:n}).catch(e=>{i.error("error sending ICE candidate",e)})};const t=await o.read({signal:n});if(t.type!==VR.Type.SDP_OFFER)throw new x(`expected message type SDP_OFFER, received: ${t.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");i.trace("recipient receive SDP offer %s",t.data);const r=new FR({type:"offer",sdp:t.data});await e.setRemoteDescription(r).catch(e=>{throw i.error("could not execute setRemoteDescription",e),new x("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")});const s=await e.createAnswer().catch(e=>{throw i.error("could not execute createAnswer",e),new x("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")});i.trace("recipient send SDP answer %s",s.sdp),await o.write({type:VR.Type.SDP_ANSWER,data:s.sdp},{signal:n}),await e.setLocalDescription(s).catch(e=>{throw i.error("could not execute setLocalDescription",e),new x("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),i.trace("recipient read candidates until connected"),await $R(e,o,{direction:"recipient",signal:n,log:i})}catch(t){if("connected"!==e.connectionState)throw i.error("error while handling signaling stream from peer %a",r.remoteAddr,t),e.close(),t;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",r.remoteAddr,t)}const s=Wo(`/webrtc/p2p/${r.remoteAddr.getPeerId()}`);return i.trace("recipient connected to remote address %s",s),{remoteAddress:s}}({peerConnection:r,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});const s=new CR(this.components,{peerConnection:r,timeline:{open:(new Date).getTime()},remoteAddr:o,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(s,{skipEncryption:!0,skipProtection:!0,muxerFactory:i}),this._closeOnShutdown(r,s)}catch(e){throw this.log.error("incoming signaling error",e),r.close(),t.abort(e),e}}_closeOnShutdown(e,t){const n=()=>{t.close().catch(e=>{this.log.error("could not close WebRTCMultiaddrConnection",e)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}}const GR=Object.values(Un).map(e=>e.decoder).reduce((e,t)=>e.or(t));const YR=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function QR(e){const t=e.stringTuples().filter(e=>e[0]===tI).map(e=>e[1])[0];if(void 0===t||""===t)throw aR(`Couldn't find a certhash component of multiaddr: ${e.toString()}`);return t}function XR(e){return vn(GR.decode(e))}function ZR(e){switch(e){case 17:return"SHA-1";case 18:return"SHA-256";case 19:return"SHA-512";default:throw function(e){return new fR(e)}(e)}}function JR(e,t){const{host:n,port:r}=e.toOptions(),i=function(e){for(const t of e.protoNames())if(t.startsWith("ip"))return t.toUpperCase();return"IP6"}(e),[o]=function(e){const t=XR(QR(e)),n=ZR(t.code),r=t.digest.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),""),i=r.match(/.{1,2}/g);if(null==i)throw dR(r,e.toString());return[`${n} ${i.join(":").toUpperCase()}`,r]}(e);return`v=0\no=- 0 0 IN ${i} ${n}\ns=-\nc=IN ${i} ${n}\nt=0 0\na=ice-lite\nm=application ${r} UDP/DTLS/SCTP webrtc-datachannel\na=mid:0\na=setup:passive\na=ice-ufrag:${t}\na=ice-pwd:${t}\na=fingerprint:${o}\na=sctp-port:5000\na=max-message-size:16384\na=candidate:1467250027 1 UDP 1467250027 ${n} ${r} typ host\r\n`}const eI=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),tI=(Go("webrtc-direct").code,Go("certhash").code);class nI{log;metrics;components;init;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}[Gy]=!0;[Symbol.toStringTag]="@libp2p/webrtc-direct";[ey]=["@libp2p/transport"];async dial(e,t){const n=await this._connect(e,t);return this.log("dialing address: %a",e),n}createListener(e){throw new hR("WebRTCTransport.createListener")}listenFilter(e){return e.filter(po.exactMatch)}dialFilter(e){return this.listenFilter(e)}async _connect(e,t){const n=new AbortController,r=n.signal,i=e.getPeerId();if(null===i)throw aR("we need to have the remote's PeerId");const o=Br(i),s=XR(QR(e)),a=await UR.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:ZR(s.code)}),l=new UR({...await TR(this.init.rtcConfiguration),certificates:[a]});try{const i=new Promise((e,t)=>{const n=l.createDataChannel("",{negotiated:!0,id:0}),r=setTimeout(()=>{const e=`Data channel was never opened: state: ${n.readyState}`;this.log.error(e),this.metrics?.dialerEvents.increment({open_error:!0}),t(oR("data",e))},1e4);n.onopen=t=>{clearTimeout(r),e(n)},n.onerror=e=>{clearTimeout(r);const n=`Error opening a data channel for handshaking: ${e.target?.toString()??"not specified"}`;this.log.error(n),this.metrics?.dialerEvents.increment({unknown_error:!0}),t(oR("data",n))}}),a="libp2p+webrtc+v1/"+[...Array(32)].map(()=>eI.at(Math.floor(Math.random()*eI.length))).join(""),c=function(e,t){if(void 0===e.sdp)throw cR("Can't munge a missing SDP");return e.sdp=e.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,"\na=ice-ufrag:"+t+"\n").replace(/\na=ice-pwd:[^\n]*\n/,"\na=ice-pwd:"+t+"\n"),e}(await l.createOffer(),a);await l.setLocalDescription(c);const u=function(e,t){return{type:"answer",sdp:JR(e,t)}}(e,a);await l.setRemoteDescription(u);const d=await i,h=this.components.peerId,f=Mv({prologueBytes:this.generateNoisePrologue(l,s.code,e)})(this.components),p=LR({channel:d,direction:"inbound",logger:this.components.logger,...this.init.dataChannel??{}}),g={...p,sink:p.sink.bind(p),source:async function*(){for await(const e of p.source)for(const t of e)yield t}()},m=new CR(this.components,{peerConnection:l,remoteAddr:e,timeline:{open:Date.now()},metrics:this.metrics?.dialerEvents}),y=IR?"iceconnectionstatechange":"connectionstatechange";l.addEventListener(y,()=>{switch(l.connectionState){case"failed":case"disconnected":case"closed":m.close().catch(e=>{this.log.error("error closing connection",e)}).finally(()=>{n.abort()})}},{signal:r}),this.metrics?.dialerEvents.increment({peer_connection:!0});const w=new OR(this.components,{peerConnection:l,metrics:this.metrics?.dialerEvents,dataChannelOptions:this.init.dataChannel});return await f.secureInbound(h,g,o),await t.upgrader.upgradeOutbound(m,{skipProtection:!0,skipEncryption:!0,muxerFactory:w})}catch(e){throw l.close(),e}}generateNoisePrologue(e,t,n){if(0===e.getConfiguration().certificates?.length)throw cR("no local certificate");const r=function(e,t){const n=e.getConfiguration().certificates?.at(0);if(null==n?.getFingerprints){t.log.trace("fetching fingerprint from local SDP");const n=e.localDescription;if(null==n)return;return function(e){const t=e.match(YR);return t?.groups?.fingerprint}(n.sdp)}if(t.log.trace("fetching fingerprint from local certificate"),0===n.getFingerprints().length)return;const r=n.getFingerprints()[0].value;if(null==r)throw dR("","no fingerprint on local certificate");return r}(e,{log:this.log});if(null==r)throw cR("no local fingerprint found");const i=bn(t,Hn(r.trim().toLowerCase().replaceAll(":",""),"hex")),o=GR.decode(QR(n));return de([Hn("libp2p-webrtc-noise:"),i.bytes,o])}}function rI(e){return t=>new nI(t,e)}const iI=async e=>{if(e.readyState>=2)throw new Error("socket closed");1!==e.readyState&&await new Promise((t,n)=>{function r(){e.removeEventListener("open",i),e.removeEventListener("error",o)}function i(){r(),t()}function o(t){r(),n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))}e.addEventListener("open",i),e.addEventListener("error",o)})},oI=(e,t)=>((t=t??{}).closeOnEnd=!1!==t.closeOnEnd,async n=>{for await(const t of n){try{await iI(e)}catch(e){if("socket closed"===e.message)break;throw e}if(e.readyState===e.CLOSING||e.readyState===e.CLOSED)break;e.send(t)}null!=t.closeOnEnd&&e.readyState<=1&&await new Promise((t,n)=>{e.addEventListener("close",e=>{if(e.wasClean||1006===e.code)t();else{const t=Object.assign(new Error("ws error"),{event:e});n(t)}}),setTimeout(()=>{e.close()})})});var sI=n(544);function aI(e){return e instanceof ArrayBuffer||"ArrayBuffer"===e?.constructor?.name&&"number"==typeof e?.byteLength}const lI=WebSocket,cI={"http:":"ws:","https:":"wss:"};function uI(e,t){t=t??{};const n=((e,t)=>{if(e.startsWith("//")&&(e=`${t?.protocol??"ws:"}${e}`),e.startsWith("/")&&null!=t){const n=t.protocol??"ws:",r=t.host,i=null!=t.port&&!0!==r?.endsWith(`:${t.port}`)?`:${t.port}`:"";e=`${n}//${r}${i}${e}`}const n=new URL(e);for(const[e,t]of Object.entries(cI))n.protocol===e&&(n.protocol=t);return n})(e,"undefined"==typeof window?void 0:window.location);return((e,t)=>{t=t??{};const n=(e=>{e.binaryType="arraybuffer";const t=async()=>{await new Promise((t,n)=>{if(i)return void t();if(null!=r)return void n(r);const o=t=>{e.removeEventListener("open",s),e.removeEventListener("error",a),t()},s=()=>{o(t)},a=t=>{o(()=>{n(t.error??new Error(`connect ECONNREFUSED ${e.url}`))})};e.addEventListener("open",s),e.addEventListener("error",a)})},n=async function*(){const n=new sI.PP(({push:t,stop:n,fail:r})=>{const i=e=>{let n=null;"string"==typeof e.data&&(n=Hn(e.data)),aI(e.data)&&(n=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(n=e.data),null!=n&&t(n)},o=e=>{r(e.error??new Error("Socket error"))};return e.addEventListener("message",i),e.addEventListener("error",o),e.addEventListener("close",n),()=>{e.removeEventListener("message",i),e.removeEventListener("error",o),e.removeEventListener("close",n)}},{highWaterMark:1/0});await t();for await(const e of n)yield aI(e)?new Uint8Array(e):e}();let r,i=1===e.readyState;return e.addEventListener("open",()=>{i=!0,r=null}),e.addEventListener("close",()=>{i=!1,r=null}),e.addEventListener("error",t=>{i||(r=t.error??new Error(`connect ECONNREFUSED ${e.url}`))}),Object.assign(n,{connected:t})})(e);let r=t.remoteAddress,i=t.remotePort;if(null!=e.url)try{const t=new URL(e.url);r=t.hostname,i=parseInt(t.port,10)}catch{}if(null==r||null==i)throw new Error("Remote connection did not have address and/or port");return{sink:oI(e,t),source:n,connected:async()=>{await n.connected()},close:async()=>{e.readyState!==e.CONNECTING&&e.readyState!==e.OPEN||await new Promise(t=>{e.addEventListener("close",()=>{t()}),e.close()})},destroy:()=>{null!=e.terminate?e.terminate():e.close()},remoteAddress:r,remotePort:i,socket:e}})(new lI(n.toString(),t.websocket),t)}class dI{log;init;logger;metrics;components;constructor(e,t){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Gy]=!0;[Symbol.toStringTag]="@libp2p/websockets";[ey]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=function(e,t,n){const r=n.logger.forComponent("libp2p:websockets:maconn"),i=n.metrics,o=n.metricPrefix??"",s={log:r,async sink(t){try{await e.sink(async function*(){for await(const e of t)e instanceof Uint8Array?yield e:yield e.subarray()}())}catch(e){"aborted"!==e.type&&r.error(e)}},source:e.source,remoteAddr:t,timeline:{open:Date.now()},async close(t={}){const n=Date.now();if(null==t.signal){const e=AbortSignal.timeout(500);t={...t,signal:e}}const i=()=>{const{host:e,port:t}=s.remoteAddr.toOptions();r("timeout closing stream to %s:%s after %dms, destroying it manually",e,t,Date.now()-n),this.abort(new x("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};t.signal?.addEventListener("abort",i);try{await e.close()}catch(e){r.error("error closing WebSocket gracefully",e),this.abort(e)}finally{t.signal?.removeEventListener("abort",i),s.timeline.close=Date.now()}},abort(t){const{host:n,port:a}=s.remoteAddr.toOptions();r("timeout closing stream to %s:%s due to error",n,a,t),e.destroy(),s.timeline.close=Date.now(),i?.increment({[`${o}error`]:!0})}};return e.socket.addEventListener("close",()=>{i?.increment({[`${o}close`]:!0}),null==s.timeline.close&&(s.timeline.close=Date.now())},{once:!0}),s}(await this._connect(e,t),e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",n.remoteAddr);const r=await t.upgrader.upgradeOutbound(n,t);return this.log("outbound connection %s upgraded",n.remoteAddr),r}async _connect(e,t){t?.signal?.throwIfAborted();const n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);const r=D(),i=uI(ns(e),this.init);i.socket.addEventListener("error",()=>{const t=new x(`Could not connect to ${e.toString()}`,"ERR_CONNECTION_FAILED");this.log.error("connection error:",t),this.metrics?.dialerEvents.increment({error:!0}),r.reject(t)});try{t.onProgress?.(new Fe("websockets:open-connection")),await H(Promise.race([i.connected(),r.promise]),t.signal)}catch(e){throw!0===t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(e=>{this.log.error("error closing raw socket",e)}),e}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}((this.logger,this.components.metrics),this.init)}listenFilter(e){return e=Array.isArray(e)?e:[e],null!=this.init?.filter?this.init?.filter(e):ek||ik?function(e){return e.filter(e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return eS.matches(t)})}(e):function(e){return e.filter(e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return ZE.matches(t)||eS.matches(t)})}(e)}dialFilter(e){return this.listenFilter(e)}}function hI(e={}){return t=>new dI(t,e)}class fI extends sE{writer;reader;constructor(e){super(e),this.writer=e.bidiStream.writable.getWriter(),this.reader=e.bidiStream.readable.getReader(),Promise.resolve().then(async()=>{for(;;){const t=await this.reader.read();if(t.done)return void e.log("remote closed write");null!=t.value&&this.sourcePush(new me(t.value))}}).catch(t=>{e.log.error("error reading from stream",t),this.abort(t)}).finally(()=>{this.remoteCloseWrite()}),this.writer.closed.then(()=>{e.log("writer closed")}).catch(t=>{e.log("writer close promise rejected",t)}).finally(()=>{this.remoteCloseRead()})}sendNewStream(e){}async sendData(e,t){for await(const n of e)this.log("sendData waiting for writer to be ready"),await H(this.writer.ready,t?.signal),this.writer.write(n).catch(e=>{this.log.error("error sending stream data",e)})}async sendReset(e){this.log("sendReset aborting writer"),await H(this.writer.abort(),e?.signal),this.log("sendReset aborted writer")}async sendCloseWrite(e){this.log("sendCloseWrite closing writer"),await H(this.writer.close(),e?.signal),this.log("sendCloseWrite closed writer")}async sendCloseRead(e){this.log("sendCloseRead cancelling reader"),await H(this.reader.cancel(),e?.signal),this.log("sendCloseRead cancelled reader")}}async function pI(e,t,n,r,i,o){const s=o.forComponent(`libp2p:webtransport:stream:${n}:${t}`),a=new fI({bidiStream:e,id:t,direction:n,log:s,onEnd:()=>{const e=r.findIndex(e=>e===a);-1!==e&&r.splice(e,1),i?.(a)}});return a}function gI(){return{source:{[Symbol.asyncIterator]:()=>({next:async()=>new Promise(()=>{})})},sink:async e=>new Promise(()=>{})}}function mI(e,t,n,r){let i=0;const o=n.forComponent("libp2p:webtransport:muxer");return{protocol:"webtransport",createStreamMuxer:s=>{"function"==typeof s&&(s={onIncomingStream:s});const a=[];Promise.resolve().then(async()=>{for(;;){const{done:e,value:l}=await t.read();if(e)break;if(a.length>=r.maxInboundStreams)o(`too many inbound streams open - ${a.length}/${r.maxInboundStreams}, closing new incoming stream`),l.writable.close().catch(e=>{o.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${e.message}`)}),l.readable.cancel().catch(e=>{o.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${e.message}`)});else{const e=await pI(l,String(i++),"inbound",a,s?.onStreamEnd,n);a.push(e),s?.onIncomingStream?.(e)}}}).catch(e=>{o.error("could not create a new stream",e)});const l={protocol:"webtransport",streams:a,newStream:async t=>{o("new outgoing stream",t);const r=await e.createBidirectionalStream(),l=await pI(r,String(i++),s?.direction??"outbound",a,s?.onStreamEnd,n);return a.push(l),l},close:async()=>{o("closing webtransport muxer gracefully");try{e.close()}catch(e){l.abort(e)}},abort:t=>{o("closing webtransport muxer with err:",t);try{e.close()}catch(t){o.error("webtransport session threw error during close",t)}},...gI()};return l}}}const yI=Object.values(Un).map(e=>e.decoder).reduce((e,t)=>e.or(t));function wI(e){if(!mo.matches(e))throw new x("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");const t=e.stringTuples(),n=t.filter(([e,t])=>e===Go("certhash").code).map(([e,t])=>{return n=t??"",vn(yI.decode(n));var n}),r=t.filter(([e,t])=>e===Go("p2p").code).map(([e,t])=>Br(t??""))[0],i=e.toOptions();let o=i.host;return 6===i.family&&o?.includes(":")&&(o=`[${o}]`),{url:`https://${o}:${i.port}`,certhashes:n,remotePeer:r}}const bI=globalThis.WebTransport;class vI{log;components;config;metrics;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:webtransport"),this.components=e,this.config={...t,maxInboundStreams:t.maxInboundStreams??1e3,certificates:t.certificates??[]},null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}[Symbol.toStringTag]="@libp2p/webtransport";[Gy]=!0;[ey]=["@libp2p/transport"];async dial(e,t){if(!0===t?.signal?.aborted)throw new A;this.log("dialing %s",e);const n=this.components.peerId;if(void 0===n)throw new x("Need a local peerid","ERR_INVALID_PARAMETERS");t=t??{};const{url:r,certhashes:i,remotePeer:o}=wI(e);let s,a,l=()=>{},c=!1,u=!1,d=!1;try{this.metrics?.dialerEvents.increment({pending:!0});const h=new bI(`${r}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:i.map(e=>({algorithm:"sha-256",value:e.digest}))});if(l=e=>{if(!c)try{this.metrics?.dialerEvents.increment({[e]:!0}),h.close()}catch(e){this.log.error("error closing wt session",e)}finally{null!=a&&(a.timeline.close=Date.now()),c=!0}},s=()=>{l(u?"noise_timeout":"ready_timeout")},t.signal?.addEventListener("abort",s,{once:!0}),this.log("wait for session to be ready"),t.onProgress?.(new Fe("webtransport:wait-for-session")),await Promise.race([h.closed,h.ready]),this.log("session became ready"),u=!0,this.metrics?.dialerEvents.increment({ready:!0}),h.closed.catch(e=>{this.log.error("error on remote wt session close",e)}).finally(()=>{l("remote_close")}),d=await H(this.authenticateWebTransport({wt:h,localPeer:n,remotePeer:o,certhashes:i,...t}),t.signal),!d)throw new x("Failed to authenticate webtransport","ERR_AUTHENTICATION_FAILED");return this.metrics?.dialerEvents.increment({open:!0}),a={close:async()=>{this.log("closing webtransport"),l("close")},abort:e=>{this.log("aborting webtransport due to passed err",e),l("abort")},remoteAddr:e,timeline:{open:Date.now()},log:this.components.logger.forComponent("libp2p:webtransport:maconn"),...gI()},await t.upgrader.upgradeOutbound(a,{skipEncryption:!0,muxerFactory:mI(h,h.incomingBidirectionalStreams.getReader(),this.components.logger,this.config),skipProtection:!0,onProgress:t.onProgress})}catch(e){throw this.log.error("caught wt session err",e),l(d?"upgrade_error":u?"noise_error":"ready_error"),e}finally{null!=s&&t.signal?.removeEventListener("abort",s)}}async authenticateWebTransport({wt:e,localPeer:t,remotePeer:n,certhashes:r,onProgress:i,signal:o}){o?.throwIfAborted(),i?.(new Fe("webtransport:open-authentication-stream"));const s=await e.createBidirectionalStream(),a=s.writable.getWriter(),l=s.readable.getReader(),c={source:async function*(){for(;;){const e=await l.read();if(null!=e.value&&(yield e.value),e.done)break}}(),sink:async e=>{for await(const t of e){await H(a.ready,o);const e=t instanceof Uint8Array?t:t.subarray();a.write(e).catch(e=>{this.log.error("could not write chunk during authentication of WebTransport stream",e)})}}},u=Mv()(this.components);i?.(new Fe("webtransport:secure-outbound-connection"));const{remoteExtensions:d}=await u.secureOutbound(t,c,n);if(i?.(new Fe("webtransport:close-authentication-stream")),a.close().catch(e=>{this.log.error(`Failed to close authentication stream writer: ${e.message}`)}),l.cancel().catch(e=>{this.log.error(`Failed to close authentication stream reader: ${e.message}`)}),h=d?.webtransportCerthashes??[],(f=r.map(e=>e.bytes)).filter(e=>Boolean(h.find(t=>he(e,t)))).length!==f.length)throw new Error("Our certhashes are not a subset of the remote's reported certhashes");var h,f;return!0}createListener(e){return function(){throw new Error("Not implemented")}(this.components,(this.config.certificates,this.config.maxInboundStreams))}listenFilter(){return[]}dialFilter(e){return null==globalThis.WebTransport?[]:e.filter(e=>{if(!mo.exactMatch(e))return!1;const{url:t,certhashes:n}=wI(e);return null!=t&&n.length>0})}}function EI(e={}){return t=>new vI(t,e)}function SI(e,t){const n=t.map((e,t)=>({record:EE(e),index:t}));return n.sort((e,t)=>{const n=e.record.sequence,r=t.record.sequence;if(n>r)return-1;if(n<r)return 1;if(e.record.validityType===yE.ValidityType.EOL&&t.record.validityType===yE.ValidityType.EOL){const n=RE.fromString(e.record.validity).toDate(),r=RE.fromString(t.record.validity).toDate();if(n.getTime()>r.getTime())return-1;if(n.getTime()<r.getTime())return 1}return 0}),n[0].index}const kI={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};async function _I(e){const t=e.libp2p?.peerId,n=e.logger??ha(),r=new ba("/pkcs8/self");let i;null==t&&null!=e.datastore&&(i=fy(e.keychain)({datastore:e.datastore,logger:n}),await e.datastore.has(r)&&(e.libp2p=e.libp2p??{},e.libp2p.peerId=await i.exportPeerId("self")));const o=function(e={}){const t=`helia/4.2.6 ${Tb}/${xb} UserAgent=${globalThis.navigator.userAgent}`;return{peerId:e.peerId,dns:e.dns,addresses:{listen:["/webrtc"]},transports:[KS({discoverRelays:1}),e=>new WR(e,void 0),rI(),EI(),hI()],connectionEncryption:[Mv()],streamMuxers:[hE(),Z_()],peerDiscovery:[vS(kI)],services:{autoNAT:zE(),dcutr:YS(),delegatedRouting:()=>function(e,t={}){return new ME(new URL("https://delegated-ipfs.dev"),t)}(),dht:M_({clientMode:!0,validators:{ipns:AE},selectors:{ipns:SI}}),identify:vk({agentVersion:t}),identifyPush:Ek({agentVersion:t}),keychain:fy(e.keychain),ping:tR()}}}(e);o.datastore=o.datastore??e.datastore,e=e??{};const s=await async function(e={}){const t=await Nb(e);return!1!==e.start&&await t.start(),t}({...o,...e.libp2p,start:!1});return null!=t||null==i||await e.datastore.has(r)||await i.importPeer("self",s.peerId),s}const RI=function(e,t=1){return t=Number(t),null!=e[Symbol.asyncIterator]?async function*(){let n=[];if(t<1&&(t=1),t!==Math.round(t))throw new Error("Batch size must be an integer");for await(const r of e)for(n.push(r);n.length>=t;)yield n.slice(0,t),n=n.slice(t);for(;n.length>0;)yield n.slice(0,t),n=n.slice(t)}():function*(){let n=[];if(t<1&&(t=1),t!==Math.round(t))throw new Error("Batch size must be an integer");for(const r of e)for(n.push(r);n.length>=t;)yield n.slice(0,t),n=n.slice(t);for(;n.length>0;)yield n.slice(0,t),n=n.slice(t)}()};async function*II(e,t=1){for await(const n of RI(e,t)){const e=n.map(async e=>e().then(e=>({ok:!0,value:e}),e=>({ok:!1,err:e})));for(let t=0;t<e.length;t++){const n=await e[t];if(!n.ok)throw n.err;yield n.value}}}const AI=(e={})=>{const t=e.chunkSize??262144;return async function*(e){let n=new me,r=0,i=!1;for await(const o of e)for(n.append(o),r+=o.length;r>=t;)if(yield n.slice(0,t),i=!0,t===n.length)n=new me,r=0;else{const e=new me;e.append(n.sublist(t)),n=e,r-=t}(!i||r>0)&&(yield n.subarray(0,r))}};class xI extends Error{static name="InvalidTypeError";static code="ERR_INVALID_TYPE";name=xI.name;code=xI.code;constructor(e="Invalid type"){super(e)}}class TI extends Error{static name="InvalidUnixFSMessageError";static code="ERR_INVALID_MESSAGE";name=TI.name;code=TI.code;constructor(e="Invalid message"){super(e)}}var CI,NI,DI;!function(e){let t,n,r;!function(e){e.Raw="Raw",e.Directory="Directory",e.File="File",e.Metadata="Metadata",e.Symlink="Symlink",e.HAMTShard="HAMTShard"}(t=e.DataType||(e.DataType={})),function(e){e[e.Raw=0]="Raw",e[e.Directory=1]="Directory",e[e.File=2]="File",e[e.Metadata=3]="Metadata",e[e.Symlink=4]="Symlink",e[e.HAMTShard=5]="HAMTShard"}(n||(n={})),function(e){e.codec=()=>gr(n)}(t=e.DataType||(e.DataType={})),e.codec=()=>(null==r&&(r=mr((t,n,r={})=>{if(!1!==r.lengthDelimited&&n.fork(),null!=t.Type&&(n.uint32(8),e.DataType.codec().encode(t.Type,n)),null!=t.Data&&(n.uint32(18),n.bytes(t.Data)),null!=t.filesize&&(n.uint32(24),n.uint64(t.filesize)),null!=t.blocksizes)for(const e of t.blocksizes)n.uint32(32),n.uint64(e);null!=t.hashType&&(n.uint32(40),n.uint64(t.hashType)),null!=t.fanout&&(n.uint32(48),n.uint64(t.fanout)),null!=t.mode&&(n.uint32(56),n.uint32(t.mode)),null!=t.mtime&&(n.uint32(66),NI.codec().encode(t.mtime,n)),!1!==r.lengthDelimited&&n.ldelim()},(t,n)=>{const r={blocksizes:[]},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.Type=e.DataType.codec().decode(t);break;case 2:r.Data=t.bytes();break;case 3:r.filesize=t.uint64();break;case 4:r.blocksizes.push(t.uint64());break;case 5:r.hashType=t.uint64();break;case 6:r.fanout=t.uint64();break;case 7:r.mode=t.uint32();break;case 8:r.mtime=NI.codec().decode(t,t.uint32());break;default:t.skipType(7&n)}}return r})),r),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(CI||(CI={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.Seconds&&(t.uint32(8),t.int64(e.Seconds)),null!=e.FractionalNanoseconds&&(t.uint32(21),t.fixed32(e.FractionalNanoseconds)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Seconds=e.int64();break;case 2:n.FractionalNanoseconds=e.fixed32();break;default:e.skipType(7&t)}}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(NI||(NI={})),function(e){let t;e.codec=()=>(null==t&&(t=mr((e,t,n={})=>{!1!==n.lengthDelimited&&t.fork(),null!=e.MimeType&&(t.uint32(10),t.string(e.MimeType)),!1!==n.lengthDelimited&&t.ldelim()},(e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();t>>>3==1?n.MimeType=e.string():e.skipType(7&t)}return n})),t),e.encode=t=>rr(t,e.codec()),e.decode=t=>it(t,e.codec())}(DI||(DI={}));const PI={Raw:"raw",Directory:"directory",File:"file",Metadata:"metadata",Symlink:"symlink",HAMTShard:"hamt-sharded-directory"},LI=["directory","hamt-sharded-directory"],BI=parseInt("0644",8),OI=parseInt("0755",8),MI=BigInt(1024);class UI{static unmarshal(e){const t=CI.decode(e);if(null!=t.fanout&&t.fanout>MI)throw new TI(`Fanout size was too large - ${t.fanout} > ${MI}`);const n=new UI({type:PI[null!=t.Type?t.Type.toString():"File"],data:t.Data,blockSizes:t.blocksizes,mode:t.mode,mtime:null!=t.mtime?{secs:t.mtime.Seconds??0n,nsecs:t.mtime.FractionalNanoseconds}:void 0,fanout:t.fanout});return n._originalMode=t.mode??0,n}type;data;blockSizes;hashType;fanout;mtime;_mode;_originalMode;constructor(e={type:"file"}){const{type:t,data:n,blockSizes:r,hashType:i,fanout:o,mtime:s,mode:a}=e;if(null!=t&&!Object.values(PI).includes(t))throw new xI("Type: "+t+" is not valid");this.type=t??"file",this.data=n,this.hashType=i,this.fanout=o,this.blockSizes=r??[],this._originalMode=0,this.mode=a,this.mtime=s}set mode(e){this._mode=null==e?this.isDirectory()?OI:BI:4095&e}get mode(){return this._mode}isDirectory(){return LI.includes(this.type)}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0n;let e=0n;return this.blockSizes.forEach(t=>{e+=t}),null!=this.data&&(e+=BigInt(this.data.length)),e}marshal(){let e;switch(this.type){case"raw":e=CI.DataType.Raw;break;case"directory":e=CI.DataType.Directory;break;case"file":e=CI.DataType.File;break;case"metadata":e=CI.DataType.Metadata;break;case"symlink":e=CI.DataType.Symlink;break;case"hamt-sharded-directory":e=CI.DataType.HAMTShard;break;default:throw new xI(`Type: ${e} is not valid`)}let t,n,r=this.data;return null!=this.data&&0!==this.data.length||(r=void 0),null!=this.mode&&(t=4294963200&this._originalMode|(this.mode??0),t!==BI||this.isDirectory()||(t=void 0),t===OI&&this.isDirectory()&&(t=void 0)),null!=this.mtime&&(n={Seconds:this.mtime.secs,FractionalNanoseconds:this.mtime.nsecs}),CI.encode({Type:e,Data:r,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:t,mtime:n})}}const FI=async(e,t,n)=>{null==n.codec&&(n.codec=m);const r=await xn.digest(e),i=Pn.create(n.cidVersion,n.codec.code,r);return await t.put(i,e,n),i};function zI(e){return async function*(t,n){let r=0n;for await(let i of t.content)yield async()=>{let o;const s={codec:m,cidVersion:e.cidVersion,onProgress:e.onProgress};e.rawLeaves?(s.codec=h,s.cidVersion=1):(o=new UI({type:e.leafType,data:i}),i=Pu({Data:o.marshal(),Links:[]}));const a=await FI(i,n,s);return r+=BigInt(i.byteLength),e.onProgress?.(new Fe("unixfs:importer:progress:file:write",{bytesWritten:r,cid:a,path:t.path})),{cid:a,unixfs:o,size:BigInt(i.length),block:i}}}}class VI extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=VI.name;code=VI.code;constructor(e="Invalid parameters"){super(e)}}Error,Error,Error;class $I extends Error{static name="InvalidContentError";static code="ERR_INVALID_CONTENT";name=$I.name;code=$I.code;constructor(e="Invalid content"){super(e)}}const HI=async(e,t,n)=>{const r=new UI({type:"directory",mtime:e.mtime,mode:e.mode}),i=Pu(Au({Data:r.marshal()}));return{cid:await FI(i,t,n),path:e.path,unixfs:r,size:BigInt(i.length),originalPath:e.originalPath,block:i}};function KI(e){return!0===e.single}const qI=async(e,t,n)=>n.layout(async function*(e,t,n){let r,i=-1;for await(const o of II(n.bufferImporter(e,t),n.blockWriteConcurrency))i++,0!==i?(1===i&&null!=r&&(yield{...r,block:void 0,single:void 0},r=void 0),yield{...o,block:void 0}):r={...o,single:!0};null!=r&&(yield r)}(e,t,n),((e,t,n)=>async function(r){if(1===r.length&&KI(r[0])&&n.reduceSingleLeafToSelf){const i=r[0];let o=i.block;return!KI(i)||void 0===e.mtime&&void 0===e.mode||(i.unixfs=new UI({type:"file",mtime:e.mtime,mode:e.mode,data:i.block}),o={Data:i.unixfs.marshal(),Links:[]},i.block=Pu(Au(o)),i.cid=await FI(i.block,t,{...n,cidVersion:n.cidVersion}),i.size=BigInt(i.block.length)),n.onProgress?.(new Fe("unixfs:importer:progress:file:layout",{cid:i.cid,path:i.originalPath})),{cid:i.cid,path:e.path,unixfs:i.unixfs,size:i.size,originalPath:i.originalPath}}const i=new UI({type:"file",mtime:e.mtime,mode:e.mode}),o=r.filter(e=>e.cid.code===Xt&&e.size>0||null!=e.unixfs&&null==e.unixfs.data&&e.unixfs.fileSize()>0n||Boolean(e.unixfs?.data?.length)).map(e=>e.cid.code===Xt?(i.addBlockSize(e.size),{Name:"",Tsize:Number(e.size),Hash:e.cid}):(null==e.unixfs?.data?i.addBlockSize(e.unixfs?.fileSize()??0n):i.addBlockSize(BigInt(e.unixfs.data.length)),{Name:"",Tsize:Number(e.size),Hash:e.cid})),s={Data:i.marshal(),Links:o},a=Pu(Au(s)),l=await FI(a,t,n);return n.onProgress?.(new Fe("unixfs:importer:progress:file:layout",{cid:l,path:e.originalPath})),{cid:l,path:e.path,unixfs:i,size:BigInt(a.length+s.Links.reduce((e,t)=>e+(t.Tsize??0),0)),originalPath:e.originalPath,block:a}})(e,t,n));function jI(e){try{if(e instanceof Uint8Array)return async function*(){yield e}();if(t=e,Symbol.iterator in t)return async function*(){yield*e}();if(function(e){return Symbol.asyncIterator in e}(e))return e}catch{throw new $I("Content was invalid")}var t;throw new $I("Content was invalid")}function WI(e){return null!=e.content}function GI(e){const t=e?.maxChildrenPerNode??174;return async function e(n,r){const i=[];for await(const e of RI(n,t))i.push(await r(e));return i.length>1?e(i,r):i[0]}}class YI{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}}const QI=Pn.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),XI=Pn.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi");class ZI extends YI{_children;constructor(e,t){super(e,t),this._children=new Map}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,this._children.set(e,t)}async get(e){return Promise.resolve(this._children.get(e))}childCount(){return this._children.size}directChildrenCount(){return this.childCount()}onlyChild(){return this._children.values().next().value}*eachChildSeries(){for(const[e,t]of this._children.entries())yield{key:e,child:t}}estimateNodeSize(){if(void 0!==this.nodeSize)return this.nodeSize;this.nodeSize=0;for(const[e,t]of this._children.entries())null!=t.size&&null!=t.cid&&(this.nodeSize+=e.length+(1===this.options.cidVersion?XI.bytes.byteLength:QI.bytes.byteLength));return this.nodeSize}async*flush(e){const t=[];for(const[n,r]of this._children.entries()){let i=r;if(r instanceof YI)for await(const t of r.flush(e))i=t,yield t;null!=i.size&&null!=i.cid&&t.push({Name:n,Tsize:Number(i.size),Hash:i.cid})}const n=new UI({type:"directory",mtime:this.mtime,mode:this.mode}),r={Data:n.marshal(),Links:t},i=Pu(Au(r)),o=await FI(i,e,this.options),s=i.length+r.Links.reduce((e,t)=>e+(t.Tsize??0),0);this.cid=o,this.size=s,yield{cid:o,unixfs:n,path:this.path,size:BigInt(s)}}}_n({name:"murmur3-32",code:35,encode:e=>function(e){const t=new Array(4);for(let n=0;n<4;n++)t[n]=255&e,e>>=8;return new Uint8Array(t)}(yi.x86.hash32(e))});const JI=_n({name:"murmur3-128",code:34,encode:e=>st(yi.x64.hash128(e))});_n({name:"murmur3-x64-64",code:34,encode:e=>st(yi.x64.hash128(e)).subarray(0,8)});var eA=n(669);class tA{_options;_popCount;_parent;_posAtParent;_children;key;constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new eA,this.key=null}async put(e,t){const n=await this._findNewBucketAndPos(e);n.bucket._putAt(n,e,t)}async get(e){const t=await this._findChild(e);if(null!=t)return t.value}async del(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);null!=n&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((e,t)=>t instanceof tA?e+t.leafCount():e+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof tA?yield*t.eachLeafSeries():yield t}serialize(e,t){return t(this._children.reduce((n,r,i)=>(null!=r&&(r instanceof tA?n.push(r.serialize(e,t)):n.push(e(r,i))),n),[]))}async asyncTransform(e,t){return oA(this,e,t)}toJSON(){return this.serialize(rA,iA)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof tA))return null!=n&&n.key===e?n:void 0}async _findPlace(e){const t=this._options.hash("string"==typeof e?Hn(e):e),n=await t.take(this._options.bits),r=this._children.get(n);return r instanceof tA?r._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:r}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(null!=t.existingChild&&t.existingChild.key!==e){const e=new tA(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,e);const n=await e._findPlace(t.existingChild.hash);return n.bucket._putAt(n,t.existingChild.key,t.existingChild.value),e._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){null==this._children.get(e)&&this._popCount++,this._children.set(e,t)}_delAt(e){if(-1===e)throw new Error("Invalid position");null!=this._children.get(e)&&this._popCount--,this._children.unset(e),this._level()}_level(){if(null!=this._parent&&this._popCount<=1)if(1===this._popCount){const e=this._children.find(nA);if(null!=e&&!(e instanceof tA)){const t=e.hash;t.untake(this._options.bits);const n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function nA(e){return Boolean(e)}function rA(e,t){return e.key}function iA(e){return e}async function oA(e,t,n){const r=[];for(const i of e._children.compactArray())if(i instanceof tA)await oA(i,t,n);else{const n=await t(i);r.push({bitField:e._children.bitField(),children:n})}return n(r)}const sA=[255,254,252,248,240,224,192,128],aA=[1,3,7,15,31,63,127,255];class lA{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+8*this._currentBytePos}totalBits(){return 8*this._value.length}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const e=this._value[this._currentBytePos],r=this._currentBitPos+1,i=Math.min(r,t);n=(n<<i)+cA(e,r-i,i),t-=i,this._currentBitPos-=i,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function cA(e,t,n){const r=function(e,t){return sA[e]&aA[Math.min(t+e-1,7)]}(t,n);return(e&r)>>>t}function uA(e){return function(t){return t instanceof dA?t:new dA(t,e)}}class dA{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const e=this._buffers[this._currentBufferIndex],r=Math.min(e.availableBits(),t);n=(n<<r)+e.take(r),t-=r,this._availableBits-=r,0===e.availableBits()&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const e=this._buffers[this._currentBufferIndex],n=Math.min(e.totalBits()-e.availableBits(),t);e.untake(n),t-=n,this._availableBits+=n,this._currentBufferIndex>0&&e.totalBits()===e.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?de([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new lA(t);this._buffers.push(n),this._availableBits+=n.availableBits()}}function hA(e){if(null==e||null==e.hashFn)throw new Error("please define an options.hashFn");const t={bits:e.bits??8,hash:uA(e.hashFn)};return new tA(t)}async function fA(e){return(await JI.encode(e)).slice(0,8).reverse()}const pA=BigInt(34),gA=class extends YI{_bucket;constructor(e,t){super(e,t),this._bucket=hA({hashFn:fA,bits:t.shardFanoutBits??8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}*eachChildSeries(){for(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return void 0!==this.nodeSize||(this.nodeSize=wA(this._bucket,this,this.options)),this.nodeSize}async*flush(e){for await(const t of mA(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*mA(e,t,n,r){const i=e._children,o=(e.tableSize()-1).toString(16).length,s=[];let a=0n;for(let e=0;e<i.length;e++){const n=i.get(e);if(null==n)continue;const l=e.toString(16).toUpperCase().padStart(o,"0");if(n instanceof tA){let e;for await(const i of mA(n,t,null,r))e=i;if(null==e)throw new Error("Could not flush sharded directory, no subshard found");s.push({Name:l,Tsize:Number(e.size),Hash:e.cid}),a+=e.size}else if(yA(n.value)){const e=n.value;let r;for await(const n of e.flush(t))r=n,yield r;if(null==r)throw new Error("Did not flush dir");const i=l+n.key;s.push({Name:i,Tsize:Number(r.size),Hash:r.cid}),a+=r.size}else{const e=n.value;if(null==e.cid)continue;const t=l+n.key,r=e.size;s.push({Name:t,Tsize:Number(r),Hash:e.cid}),a+=BigInt(r??0)}}const l=Uint8Array.from(i.bitField().reverse()),c=new UI({type:"hamt-sharded-directory",data:l,fanout:BigInt(e.tableSize()),hashType:pA,mtime:n?.mtime,mode:n?.mode}),u=Pu(Au({Data:c.marshal(),Links:s})),d=await FI(u,t,r),h=BigInt(u.byteLength)+a;yield{cid:d,unixfs:c,size:h}}function yA(e){return"function"==typeof e.flush}function wA(e,t,n){const r=e._children,i=(e.tableSize()-1).toString(16).length,o=[];for(let e=0;e<r.length;e++){const t=r.get(e);if(null==t)continue;const s=e.toString(16).toUpperCase().padStart(i,"0");if(t instanceof tA){const e=wA(t,null,n);o.push({Name:s,Tsize:Number(e),Hash:0===n.cidVersion?QI:XI})}else if("function"==typeof t.value.flush){const e=t.value.nodeSize();o.push({Name:s+t.key,Tsize:Number(e),Hash:0===n.cidVersion?QI:XI})}else{const e=t.value;if(null==e.cid)continue;const n=s+t.key,r=e.size;o.push({Name:n,Tsize:Number(r),Hash:e.cid})}}const s=Uint8Array.from(r.bitField().reverse());return Pu(Au({Data:new UI({type:"hamt-sharded-directory",data:s,fanout:BigInt(e.tableSize()),hashType:pA,mtime:t?.mtime,mode:t?.mode}).marshal(),Links:o})).length}async function bA(e,t,n,r){let i=t;t instanceof ZI&&t.estimateNodeSize()>n&&(i=await async function(e,t){const n=new gA({root:e.root,dir:!0,parent:e.parent,parentKey:e.parentKey,path:e.path,dirty:e.dirty,flat:!1,mtime:e.mtime,mode:e.mode},t);for(const{key:t,child:r}of e.eachChildSeries())await n.put(t,r);return n}(t,r));const o=i.parent;if(null!=o){if(i!==t){if(null!=e&&(e.parent=i),null==i.parentKey)throw new Error("No parent key found");await o.put(i.parentKey,i)}return bA(i,o,n,r)}return i}async function vA(e,t,n){const r=((e="")=>e.split(/(?<!\\)\//).filter(Boolean))(e.path??""),i=r.length-1;let o=t,s="";for(let a=0;a<r.length;a++){const l=r[a];s+=`${""!==s?"/":""}${l}`;const c=a===i;if(o.dirty=!0,o.cid=void 0,o.size=void 0,c)await o.put(l,e),t=await bA(null,o,n.shardSplitThresholdBytes,n);else{let e=await o.get(l);null!=e&&e instanceof YI||(e=new ZI({root:!1,dir:!0,parent:o,parentKey:l,path:s,dirty:!0,flat:!0,mtime:e?.unixfs?.mtime,mode:e?.unixfs?.mode},n)),await o.put(l,e),o=e}}return t}async function*EA(e,t){e instanceof YI?yield*e.flush(t):!0===e.unixfs?.isDirectory()&&(yield e)}async function*SA(e,t,n={}){let r;r=Symbol.asyncIterator in e||Symbol.iterator in e?e:[e];const i=n.wrapWithDirectory??!1,o=n.shardSplitThresholdBytes??262144,s=n.shardFanoutBits??8,a=n.cidVersion??1,l=n.rawLeaves??!0,c=n.leafType??"file",u=n.fileImportConcurrency??50,d=n.blockWriteConcurrency??10,h=n.reduceSingleLeafToSelf??!0,f=n.chunker??AI(),p=n.chunkValidator??async function*(e){for await(const t of e){if(void 0===t.length)throw new $I("Content was invalid");if("string"==typeof t||t instanceof String)yield Hn(t.toString());else if(Array.isArray(t))yield Uint8Array.from(t);else{if(!(t instanceof Uint8Array))throw new $I("Content was invalid");yield t}}},g=n.dagBuilder??function(e){return async function*(t,n){for await(const r of t){let t;if(null!=r.path&&(t=r.path,r.path=r.path.split("/").filter(e=>null!=e&&"."!==e).join("/")),WI(r)){const i={path:r.path,mtime:r.mtime,mode:r.mode,content:async function*(){let t=0n;for await(const n of e.chunker(e.chunkValidator(jI(r.content)))){const i=BigInt(n.byteLength);t+=i,e.onProgress?.(new Fe("unixfs:importer:progress:file:read",{bytesRead:t,chunkSize:i,path:r.path})),yield n}}(),originalPath:t},o=e.fileBuilder??qI;yield async()=>o(i,n,e)}else{if(null==r.path)throw new Error("Import candidate must have content or path or both");{const i={path:r.path,mtime:r.mtime,mode:r.mode,originalPath:t},o=e.dirBuilder??HI;yield async()=>o(i,n,e)}}}}}({chunker:f,chunkValidator:p,wrapWithDirectory:i,layout:n.layout??GI(),bufferImporter:n.bufferImporter??zI({cidVersion:a,rawLeaves:l,leafType:c,onProgress:n.onProgress}),blockWriteConcurrency:d,reduceSingleLeafToSelf:h,cidVersion:a,onProgress:n.onProgress,dirBuilder:n.dirBuilder,fileBuilder:n.fileBuilder}),m=n.treeBuilder??function(e){return async function*(t,n){let r,i=new ZI({root:!0,dir:!0,path:"",dirty:!0,flat:!0},e),o=!1;for await(const n of t){if(null==n)continue;const t=`${n.originalPath??""}`.split("/")[0];null!=t&&""!==t&&(null==r?(r=t,o=!0):r!==t&&(o=!1)),i=await vA(n,i,e),!0!==n.unixfs?.isDirectory()&&(yield n)}if(e.wrapWithDirectory||o&&i.childCount()>1)yield*EA(i,n);else for(const e of i.eachChildSeries())null!=e&&(yield*EA(e.child,n))}}({wrapWithDirectory:i,shardSplitThresholdBytes:o,shardFanoutBits:s,cidVersion:a,onProgress:n.onProgress});for await(const e of m(II(g(r,t),u),t))yield{cid:e.cid,path:e.path,unixfs:e.unixfs,size:e.size}}async function kA(e,t,n={}){const r=await CE(SA([e],t,n));if(null==r)throw new VI("Nothing imported");return r}const _A={cidVersion:1,rawLeaves:!0,layout:GI({maxChildrenPerNode:1024}),chunker:AI({chunkSize:1048576})};const RA=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{let t;for await(const n of e)t=n;return t})();let t;for(const n of e)t=n;return t};class IA extends Error{static name="BadPathError";static code="ERR_BAD_PATH";name=IA.name;code=IA.code;constructor(e="Bad path"){super(e)}}class AA extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=AA.name;code=AA.code;constructor(e="Not found"){super(e)}}class xA extends Error{static name="NoResolverError";static code="ERR_NO_RESOLVER";name=xA.name;code=xA.code;constructor(e="No resolver"){super(e)}}class TA extends Error{static name="NotUnixFSError";static code="ERR_NOT_UNIXFS";name=TA.name;code=TA.code;constructor(e="Not UnixFS"){super(e)}}class CA extends Error{static name="OverReadError";static code="ERR_OVER_READ";name=CA.name;code=CA.code;constructor(e="Over read"){super(e)}}class NA extends Error{static name="UnderReadError";static code="ERR_UNDER_READ";name=NA.name;code=NA.code;constructor(e="Under read"){super(e)}}class DA extends Error{static name="NoPropError";static code="ERR_NO_PROP";name=DA.name;code=DA.code;constructor(e="No Property found"){super(e)}}class PA extends Error{static name="InvalidParametersError";static code="ERR_INVALID_PARAMS";name=PA.name;code=PA.code;constructor(e="Invalid parameters"){super(e)}}function LA(e,t,n,r,i,o,s){let a=e,l=i;for(;o.length>0;){const c=o[0];if(!(c in a))throw new DA(`No property named ${c} found in node ${n}`);{o.shift(),l=`${l}/${c}`;const u=Pn.asCID(a[c]);if(null!=u)return{entry:{type:"object",name:r,path:i,cid:n,node:t,depth:s,size:BigInt(t.length),content:async function*(){yield e}},next:{cid:u,name:c,path:l,toResolve:o}};a=a[c]}}return{entry:{type:"object",name:r,path:i,cid:n,node:t,depth:s,size:BigInt(t.length),content:async function*(){yield e}}}}const BA=function(e,t,n,r){const i=BigInt(e.length),o=BigInt(t+i);return n>=o||r<t?new Uint8Array(0):(r>=t&&r<o&&(e=e.subarray(0,Number(r-t))),n>=t&&n<o&&(e=e.subarray(Number(n-t))),e)},OA=(e,t=0,n=e)=>{const r=BigInt(e),i=BigInt(t??0);let o=BigInt(n);if(o!==r&&(o=i+o),o>r&&(o=r),i<0n)throw new PA("Offset must be greater than or equal to 0");if(i>r)throw new PA("Offset must be less than the file size");if(o<0n)throw new PA("Length must be greater than or equal to 0");if(o>r)throw new PA("Length must be less than the file size");return{start:i,end:o}},MA=async function(e){return(await JI.encode(e)).slice(0,8).reverse()},UA=(e,t)=>e.toString(16).toUpperCase().padStart(t,"0").substring(0,t),FA=async(e,t,n,r,i)=>{if(null==r){if(null==e.Data)throw new TA("no data in PBNode");let t;try{t=UI.unmarshal(e.Data)}catch(e){throw new TA(e.message)}if("hamt-sharded-directory"!==t.type)throw new TA("not a HAMT");if(null==t.fanout)throw new TA("missing fanout");const n=hA({hashFn:MA,bits:Math.log2(Number(t.fanout))});r={rootBucket:n,hamtDepth:1,lastBucket:n}}const o=(r.lastBucket.tableSize()-1).toString(16).length;await(async(e,t,n)=>{const r=(t.tableSize()-1).toString(16).length;await Promise.all(e.map(async e=>{if(null==e.Name)throw new Error("Unexpected Link without a Name");if(e.Name.length===r){const r=parseInt(e.Name,16);return void t._putObjectAt(r,new tA({hash:n._options.hash,bits:n._options.bits},t,r))}await n.put(e.Name.substring(2),!0)}))})(e.Links,r.lastBucket,r.rootBucket);const s=await r.rootBucket._findNewBucketAndPos(t);let a=UA(s.pos,o);const l=(e=>{let t=e.bucket;const n=[];for(;null!=t._parent;)n.push(t),t=t._parent;return n.push(t),n.reverse()})(s);l.length>r.hamtDepth&&(r.lastBucket=l[r.hamtDepth],a=UA(r.lastBucket._posAtParent,o));const c=e.Links.find(e=>{if(null==e.Name)return!1;const n=e.Name.substring(0,o),r=e.Name.substring(o);return n===a&&(""===r||r===t)});if(null!=c)return null!=c.Name&&c.Name.substring(o)===t?c.Hash:(r.hamtDepth++,e=Lu(await n.get(c.Hash,i)),FA(e,t,n,r,i))},zA=FA;function VA(e){return!1===e?.extended}async function $A(e,t,n,r,i,o,s){if(t instanceof Uint8Array){const e=BA(t,r,i,o);return void n.push(e)}if(null==t.Data)throw new TA("no data in PBNode");let a;try{a=UI.unmarshal(t.Data)}catch(e){throw new TA(e.message)}if(null!=a.data){const e=a.data,t=BA(e,r,i,o);n.push(t),r+=BigInt(t.byteLength)}const l=[];if(t.Links.length!==a.blockSizes.length)throw new TA("Inconsistent block sizes and dag links");for(let e=0;e<t.Links.length;e++){const n=t.Links[e],s=r,c=s+a.blockSizes[e];if((i>=s&&i<c||o>=s&&o<=c||i<s&&o>c)&&l.push({link:n,blockStart:r}),(r=c)>o)break}await De(l,t=>xe(t,t=>async()=>{const n=await e.get(t.link.Hash,s);return{...t,block:n}}),e=>lb(e,{ordered:!0,concurrency:s.blockReadConcurrency}),async t=>{for await(const{link:r,block:a,blockStart:l}of t){let t;switch(r.Hash.code){case Du:t=Lu(a);break;case Xt:t=a;break;default:return void n.end(new TA(`Unsupported codec: ${r.Hash.code}`))}const c=new Oa({concurrency:1});c.on("error",e=>{n.end(e)}),c.add(async()=>{s.onProgress?.(new Fe("unixfs:exporter:walk:file",{cid:r.Hash})),await $A(e,t,n,l,i,o,s)}),await c.onIdle()}}),r>=o&&n.end()}const HA=(e,t,n,r,i,o,s)=>async function*(r={}){const i=n.fileSize();if(void 0===i)throw new Error("File was a directory");const{start:o,end:a}=OA(i,r.offset,r.length);if(0n===a)return;let l=0n;const c=a-o,u=O();r.onProgress?.(new Fe("unixfs:exporter:walk:file",{cid:e})),$A(s,t,u,0n,o,a,r).catch(e=>{u.end(e)});for await(const e of u)if(null!=e){if(l+=BigInt(e.byteLength),l>c)throw u.end(),new CA("Read too many bytes - the file size reported by the UnixFS data in the root node may be incorrect");l===c&&u.end(),r.onProgress?.(new Fe("unixfs:exporter:progress:unixfs:file",{bytesRead:l,totalBytes:c,fileSize:i})),yield e}if(l<c)throw new NA("Traversed entire DAG but did not read enough bytes")};async function*KA(e,t,n,r,i,o){const s=e.Links;if(null==e.Data)throw new TA("no data in PBNode");let a;try{a=UI.unmarshal(e.Data)}catch(e){throw new TA(e.message)}if(null==a.fanout)throw new TA("missing fanout");const l=(a.fanout-1n).toString(16).length,c=De(s,s=>xe(s,s=>async()=>{const a=null!=s.Name?s.Name.substring(l):null;if(null!=a&&""!==a){const e=`${t}/${a}`;return VA(o)?{entries:[{cid:s.Hash,name:a,path:e}]}:{entries:[(await n(s.Hash,a,e,[],r+1,i,o)).entry].filter(Boolean)}}{const a=await i.get(s.Hash,o);return e=Lu(a),o.onProgress?.(new Fe("unixfs:exporter:walk:hamt-sharded-directory",{cid:s.Hash})),{entries:KA(e,t,n,r,i,o)}}}),e=>lb(e,{ordered:!0,concurrency:o.blockReadConcurrency}));for await(const{entries:e}of c)yield*e}const qA={raw:HA,file:HA,directory:(e,t,n,r,i,o,s)=>async function*(n={}){const a=n.offset??0,l=n.length??t.Links.length,c=t.Links.slice(a,l);n.onProgress?.(new Fe("unixfs:exporter:walk:directory",{cid:e})),yield*De(c,e=>xe(e,e=>async()=>{const t=e.Name??"",a=`${r}/${t}`;return VA(n)?{cid:e.Hash,name:t,path:a}:(await i(e.Hash,t,a,[],o+1,s,n)).entry}),e=>lb(e,{ordered:!0,concurrency:n.blockReadConcurrency}),e=>pa(e,e=>null!=e))},"hamt-sharded-directory":(e,t,n,r,i,o,s)=>function(n={}){return n.onProgress?.(new Fe("unixfs:exporter:walk:hamt-sharded-directory",{cid:e})),KA(t,r,i,o,s,n)},metadata:(e,t,n,r,i,o,s)=>()=>[],symlink:(e,t,n,r,i,o,s)=>()=>[]},jA={[Du]:async(e,t,n,r,i,o,s,a)=>{if(VA(a)&&0===r.length)return{entry:{cid:e,name:t,path:n}};const l=Lu(await s.get(e,a));let c,u;if(null==t&&(t=e.toString()),null==l.Data)throw new TA("no data in PBNode");try{c=UI.unmarshal(l.Data)}catch(e){throw new TA(e.message)}if(null==n&&(n=t),r.length>0){let e;if(e="hamt-sharded-directory"===c?.type?await zA(l,r[0],s):((e,t)=>{const n=e.Links.find(e=>e.Name===t);return n?.Hash})(l,r[0]),null==e)throw new AA("file does not exist");const t=r.shift();u={cid:e,toResolve:r,name:t??"",path:`${n}/${t}`}}const d=qA[c.type](e,l,c,n,i,o,s);if(null==d)throw new AA("could not find content exporter");return c.isDirectory()?{entry:{type:"directory",name:t,path:n,cid:e,content:d,unixfs:c,depth:o,node:l,size:c.fileSize()},next:u}:{entry:{type:"file",name:t,path:n,cid:e,content:d,unixfs:c,depth:o,node:l,size:c.fileSize()},next:u}},[Xt]:async(e,t,n,r,i,o,s,a)=>{if(r.length>0)throw new AA(`No link named ${n} found in raw node ${e}`);const l=await s.get(e,a);return{entry:{type:"raw",name:t,path:n,cid:e,content:(c=l,async function*(e={}){const{start:t,end:n}=OA(c.length,e.offset,e.length),r=BA(c,0n,t,n);e.onProgress?.(new Fe("unixfs:exporter:progress:raw",{bytesRead:BigInt(r.byteLength),totalBytes:n-t,fileSize:BigInt(c.byteLength)})),yield r}),depth:o,size:BigInt(l.length),node:l}};var c},[tu]:async(e,t,n,r,i,o,s,a)=>{const l=await s.get(e,a);return LA(nu(l),l,e,t,n,r,o)},[au]:async(e,t,n,r,i,o,s,a)=>{const l=await s.get(e,a);return LA((e=>{const t=function(e){return e instanceof ArrayBuffer?new Uint8Array(e,0,e.byteLength):e}(e);return iu(t,Object.assign(su,{tokenizer:new ou(t,su)}))})(l),l,e,t,n,r,o)},[kn.code]:async(e,t,n,r,i,o,s,a)=>{if(r.length>0)throw new AA(`No link named ${n} found in raw node ${e}`);const l=vn(e.multihash.bytes);return{entry:{type:"identity",name:t,path:n,cid:e,content:(c=l.digest,async function*(e={}){const{start:t,end:n}=OA(c.length,e.offset,e.length),r=BA(c,0n,t,n);e.onProgress?.(new Fe("unixfs:exporter:progress:identity",{bytesRead:BigInt(r.byteLength),totalBytes:n-t,fileSize:BigInt(c.byteLength)})),yield r}),depth:o,size:BigInt(l.digest.length),node:l.digest}};var c},[Wt]:async(e,t,n,r,i,o,s,a)=>{const l=await s.get(e,a);return LA(Yt(l),l,e,t,n,r,o)}},WA=async(e,t,n,r,i,o,s)=>{const a=jA[e.code];if(null==a)throw new xA(`No resolver for code ${e.code}`);return a(e,t,n,r,WA,i,o,s)},GA=WA;async function*YA(e,t,n={}){let{cid:r,toResolve:i}=(e=>{if(e instanceof Uint8Array)return{cid:Pn.decode(e),toResolve:[]};const t=Pn.asCID(e);if(null!=t)return{cid:t,toResolve:[]};if("string"==typeof e){0===e.indexOf("/ipfs/")&&(e=e.substring(6));const t=((e="")=>(e.trim().match(/([^\\^/]|\\\/)+/g)??[]).filter(Boolean))(e);return{cid:Pn.parse(t[0]),toResolve:t.slice(1)}}throw new IA(`Unknown path type ${e}`)})(e),o=r.toString(),s=o;const a=i.length;for(;;){const l=await GA(r,o,s,i,a,t,n);if(null==l.entry&&null==l.next)throw new AA(`Could not resolve ${e}`);if(null!=l.entry&&(yield l.entry),null==l.next)return;i=l.next.toResolve,r=l.next.cid,o=l.next.name,s=l.next.path}}async function QA(e,t,n={}){const r=await RA(YA(e,t,n));if(null==r)throw new AA(`Could not resolve ${e}`);return r}async function*XA(e,t,n={}){const r=await QA(e,t,n);if(null!=r&&(yield r,"directory"===r.type))for await(const e of async function*e(t,n){for await(const r of t.content(n))yield r,r instanceof Uint8Array||"directory"===r.type&&(yield*e(r,n))}(r,n))yield e}class ZA extends Error{name;code;constructor(e,t,n){super(e),this.name=t,this.code=n}}class JA extends ZA{constructor(e="not a Unixfs node"){super(e,"NotUnixFSError","ERR_NOT_UNIXFS")}}class ex extends ZA{constructor(e="invalid PBNode"){super(e,"InvalidPBNodeError","ERR_INVALID_PBNODE")}}class tx extends ZA{constructor(e="unknown error"){super(e,"InvalidPBNodeError","ERR_UNKNOWN_ERROR")}}class nx extends ZA{constructor(e="path already exists"){super(e,"AlreadyExistsError","ERR_ALREADY_EXISTS")}}class rx extends ZA{constructor(e="path does not exist"){super(e,"DoesNotExistError","ERR_DOES_NOT_EXIST")}}class ix extends ZA{constructor(e="no content"){super(e,"NoContentError","ERR_NO_CONTENT")}}class ox extends ZA{constructor(e="not a file"){super(e,"NotAFileError","ERR_NOT_A_FILE")}}class sx extends ZA{constructor(e="not a directory"){super(e,"NotADirectoryError","ERR_NOT_A_DIRECTORY")}}class ax extends ZA{constructor(e="invalid parameters"){super(e,"InvalidParametersError","ERR_INVALID_PARAMETERS")}}function lx(e){return function(t){return t instanceof cx?t:new cx(t,e)}}class cx{_value;_hashFn;_depth;_availableBits;_currentBufferIndex;_buffers;constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const e=this._buffers[this._currentBufferIndex],r=Math.min(e.availableBits(),t);n=(n<<r)+e.take(r),t-=r,this._availableBits-=r,0===e.availableBits()&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const e=this._buffers[this._currentBufferIndex],n=Math.min(e.totalBits()-e.availableBits(),t);e.untake(n),t-=n,this._availableBits+=n,this._currentBufferIndex>0&&e.totalBits()===e.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?de([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new hx(t);this._buffers.push(n),this._availableBits+=n.availableBits()}}const ux=[255,254,252,248,240,224,192,128],dx=[1,3,7,15,31,63,127,255];class hx{_value;_currentBytePos;_currentBitPos;constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+8*this._currentBytePos}totalBits(){return 8*this._value.length}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const e=this._value[this._currentBytePos],r=this._currentBitPos+1,i=Math.min(r,t);n=(n<<i)+fx(e,r-i,i),t-=i,this._currentBitPos-=i,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function fx(e,t,n){const r=function(e,t){return ux[e]&dx[Math.min(t+e-1,7)]}(t,n);return(e&r)>>>t}const px=BigInt(JI.code);async function gx(e){return(await JI.encode(e)).subarray(0,8).reverse()}const mx=async(e,t,n)=>{null==n.codec&&(n.codec=m);const r=await xn.digest(e),i=Pn.create(n.cidVersion,n.codec.code,r);return await t.put(i,e,{...n,signal:n.signal}),i};class yx{options;root;dir;path;dirty;flat;parent;parentKey;unixfs;mode;mtime;cid;size;nodeSize;constructor(e,t){this.options=t??{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime}}class wx extends yx{_bucket;constructor(e,t){super(e,t),this._bucket=hA({hashFn:gx,bits:8})}async put(e,t){this.cid=void 0,this.size=void 0,this.nodeSize=void 0,await this._bucket.put(e,t)}async get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}estimateNodeSize(){return void 0!==this.nodeSize||(this.nodeSize=Ex(this._bucket,this,this.options)),this.nodeSize}async*flush(e){for await(const t of bx(this._bucket,e,this,this.options))yield{...t,path:this.path}}}async function*bx(e,t,n,r){const i=e._children,o=[];let s=0n;for(let e=0;e<i.length;e++){const n=i.get(e);if(null==n)continue;const a=e.toString(16).toUpperCase().padStart(2,"0");if(n instanceof tA){let e;for await(const i of bx(n,t,null,r))e=i;if(null==e)throw new Error("Could not flush sharded directory, no subshard found");o.push({Name:a,Tsize:Number(e.size),Hash:e.cid}),s+=e.size}else if(vx(n.value)){const e=n.value;let r;for await(const n of e.flush(t))r=n,yield r;if(null==r)throw new Error("Did not flush dir");const i=a+n.key;o.push({Name:i,Tsize:Number(r.size),Hash:r.cid}),s+=r.size}else{const e=n.value;if(null==e.cid)continue;const t=a+n.key,r=e.size;o.push({Name:t,Tsize:Number(r),Hash:e.cid}),s+=BigInt(r??0)}}const a=Uint8Array.from(i.bitField().reverse()),l=new UI({type:"hamt-sharded-directory",data:a,fanout:BigInt(e.tableSize()),hashType:px,mtime:n?.mtime,mode:n?.mode}),c=Pu(Au({Data:l.marshal(),Links:o})),u=await mx(c,t,r),d=BigInt(c.byteLength)+s;yield{cid:u,unixfs:l,size:d}}function vx(e){return"function"==typeof e.flush}function Ex(e,t,n){const r=e._children,i=[];for(let e=0;e<r.length;e++){const t=r.get(e);if(null==t)continue;const o=e.toString(16).toUpperCase().padStart(2,"0");if(t instanceof tA){const e=Ex(t,null,n);i.push({Name:o,Tsize:Number(e),Hash:0===n.cidVersion?Sx:kx})}else if("function"==typeof t.value.flush){const e=t.value.nodeSize();i.push({Name:o+t.key,Tsize:Number(e),Hash:0===n.cidVersion?Sx:kx})}else{const e=t.value;if(null==e.cid)continue;const n=o+t.key,r=e.size;i.push({Name:n,Tsize:Number(r),Hash:e.cid})}}const o=Uint8Array.from(r.bitField().reverse());return Pu(Au({Data:new UI({type:"hamt-sharded-directory",data:o,fanout:BigInt(e.tableSize()),hashType:px,mtime:t?.mtime,mode:t?.mode}).marshal(),Links:i})).length}const Sx=Pn.parse("QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn"),kx=Pn.parse("zdj7WbTaiJT1fgatdet9Ei9iDB5hdCxkbVyhyh8YTUnXMiwYi"),_x=fa("helia:unixfs:commands:utils:hamt-utils"),Rx=e=>e.toString(16).toUpperCase().padStart(2,"0").substring(0,2),Ix=async(e,t,n)=>{const r=UI.unmarshal(e[0].node.Data??new Uint8Array(0)),i=BigInt(Math.pow(2,8));let o,s;e.reverse();for(let a=0;a<e.length;a++){const l=a===e.length-1,c=e[a],u=Uint8Array.from(c.children.bitField().reverse()),d=new UI({type:"hamt-sharded-directory",data:u,fanout:i,hashType:px});l&&(d.mtime=r.mtime,d.mode=r.mode),s={Data:d.marshal(),Links:c.node.Links};const h=Pu(Au(s));if(o=await mx(h,t,n),!l){const t=e[a+1];if(null==t)throw new Error("Was not operating on shard root but also had no parent?");_x("updating link in parent sub-shard with prefix %s",t.prefix),t.node.Links=t.node.Links.filter(e=>e.Name!==t.prefix),t.node.Links.push({Name:t.prefix,Hash:o,Tsize:c.node.Links.reduce((e,t)=>e+(t.Tsize??0),h.byteLength)})}}if(null==o||null==s)throw new Error("Noting persisted");return{cid:o,node:s}},Ax=async(e,t,n,r)=>{const i=lx(gx)(Hn(t)),o=[];for(;;){const s=Lu(await n.get(e,r)),a=new eA,l=await i.take(8),c=Rx(l);let u;o.push({prefix:c,children:a,node:s});for(const e of s.Links){const t=e.Name??"";if(t.length<2)throw new Error("Invalid HAMT - link name was too short");const n=parseInt(t.substring(0,2),16);a.set(n,!0),t.startsWith(c)&&(u=e)}if(null==u){_x("no link found with prefix %s for %s",c,t);break}const d=u.Name??"";if(d.length<2)throw new Error("Invalid HAMT - link name was too short");if(2!==d.length)break;e=u.Hash,_x("descend into sub-shard with prefix %s",d)}return{path:o,hash:i}};async function xx(e,t,n,r){if(null==e.Data)throw new Error("DagPB node had no data");const i=UI.unmarshal(e.Data);let o;if("directory"===i.type)o=function(e){let t=0;for(const n of e.Links)t+=(n.Name??"").length,t+=1===n.Hash.version?kx.bytes.byteLength:Sx.bytes.byteLength;return t}(e);else{if("hamt-sharded-directory"!==i.type)throw new Error("Can only estimate the size of directories or shards");o=await Tx(e,0,n,t,r)}return o>n}async function Tx(e,t,n,r,i){if(t>n)return n;if(null==e.Data)return t;if(!UI.unmarshal(e.Data).isDirectory())return t;for(const o of e.Links){let e=o.Name??"";if(e=e.substring(2),t+=e.length,t+=o.Hash.bytes.byteLength,o.Hash.code===Du){const e=Lu(await r.get(o.Hash,i));t+=await Tx(e,t,n,r,i)}}return t}const Cx=fa("helia:unixfs:components:utils:add-link");async function Nx(e,t,n,r){if(null==e.node.Data)throw new ax("Invalid parent passed to addLink");if("hamt-sharded-directory"===UI.unmarshal(e.node.Data).type)return Cx("adding link to sharded directory"),Lx(e,t,n,r);Cx(`adding ${t.Name} (${t.Hash}) to regular directory`);const i=await Px(e,t,n,r);if(await xx(i.node,n,r.shardSplitThresholdBytes,r)){Cx("converting directory to sharded directory");const e=await Dx(i,n);i.cid=e.cid,i.node=Lu(await n.get(e.cid,r))}return i}const Dx=async(e,t)=>{if(null==e.node.Data)throw new ax("Invalid parent passed to convertToShardedDirectory");const n=UI.unmarshal(e.node.Data),r=await(async(e,t,n)=>{const r=new wx({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:n.mtime,mode:n.mode},n);for(let e=0;e<t.length;e++)await r._bucket.put(t[e].name,{size:t[e].size,cid:t[e].cid});const i=await RA(r.flush(e));if(null==i)throw new Error("Flushing shard yielded no result");return i})(t,e.node.Links.map(e=>({name:e.Name??"",size:BigInt(e.Tsize??0),cid:e.Hash})),{mode:n.mode,mtime:n.mtime,cidVersion:e.cid.version});return Cx(`converted directory to sharded directory ${r.cid}`),r},Px=async(e,t,n,r)=>{const i=e.node.Links.filter(e=>{const n=e.Name===t.Name;if(n&&!r.allowOverwriting)throw new nx;return!n});if(i.push(t),null==e.node.Data)throw new ex("Parent node with no data passed to addToDirectory");const o=UI.unmarshal(e.node.Data);let s;if(null!=o.mtime){const e=Date.now(),t=Math.floor(e/1e3);o.mtime={secs:BigInt(t),nsecs:1e3*(e-1e3*t)},s=o.marshal()}else s=e.node.Data;e.node=Au({Data:s,Links:i});const a=Pu(e.node),l=await xn.digest(a),c=Pn.create(e.cid.version,Du,l);return await n.put(c,a),{node:e.node,cid:c}},Lx=async(e,t,n,r)=>{const{path:i,hash:o}=await Ax(e.cid,t.Name,n,r),s=i[i.length-1];if(null==s)throw new Error("Invalid HAMT, could not generate path");const a=s.prefix,l=parseInt(a,16);Cx("next prefix for %s is %s",t.Name,a);const c=`${a}${t.Name}`,u=s.node.Links.find(e=>(e.Name??"").startsWith(a));if(null!=u)if(Cx("link %s was present in shard",c),u.Name===c){if(!r.allowOverwriting)throw new nx;Cx("overwriting %s in subshard",t.Name),s.node.Links=s.node.Links.filter(e=>e.Name!==c),s.node.Links.push({Name:c,Hash:t.Hash,Tsize:t.Tsize})}else{if(2===u.Name?.length)throw new Error("Existing link was subshard?!");{Cx("prefix %s already exists, creating new subshard",a);const e=s.node.Links.findIndex(e=>e.Name?.startsWith(a)),n=s.node.Links.splice(e,1)[0],r=(n.Name??"").substring(2),l=lx(gx)(Hn(r));for(let e=0;e<i.length;e++)await l.take(8);for(;;){const e=await l.take(8),s=Rx(e);n.Name=`${s}${r}`;const c=await o.take(8),u=Rx(c);if(s===u){const e=new eA;e.set(c,!0),i.push({prefix:u,children:e,node:{Links:[]}});continue}const d=new eA;d.set(c,!0),d.set(e,!0),i.push({prefix:a,children:d,node:{Links:[n,{Name:`${u}${t.Name}`,Hash:t.Hash,Tsize:t.Tsize}]}});break}}}else Cx("link %s was not present in sub-shard",c),t.Name=c,s.node.Links.push(t),s.children.set(l,!0),Cx("adding %s to existing sub-shard",c);return Ix(i,n,r)};async function Bx(e,t,n={}){const r=await QA(e,t,n);if("directory"!==r.type)throw new sx(`${e.toString()} was not a UnixFS directory`);return{cid:e,node:r.node}}async function Ox(e,t,n,r){const i=await QA(e,n,r);if("directory"!==i.type&&"file"!==i.type&&"raw"!==i.type)throw new JA(`${e.toString()} was not a UnixFS node`);return{Name:t,Tsize:i.node instanceof Uint8Array?i.node.byteLength:Mx(i.node),Hash:e}}function Mx(e){const t=e.Links.reduce((e,t)=>e+(t.Tsize??0),0);return Pu(e).byteLength+t}const Ux=fa("helia:unixfs:components:utils:resolve");async function Fx(e,t,n,r){if(null==t||""===t)return{cid:e};const i=`/ipfs/${e}${null==t?"":`/${t}`}`,o=await va(YA(i,n,r));if(0===o.length)throw new rx("Could not find path in directory");return Ux("resolved %s to %c",t,e),{cid:o[o.length-1].cid,path:t,segments:o}}async function zx(e,t,n,r){if(null==t.segments||0===t.segments.length)return e;let i=t.segments.pop();if(null==i)throw new Error("Insufficient segments");i.cid=e,t.segments.reverse();for(const o of t.segments){const[t,s]=await Promise.all([Bx(o.cid,n,r),Ox(i.cid,i.name,n,r)]);e=(await Nx(t,s,n,{...r,allowOverwriting:!0,cidVersion:e.version})).cid,o.cid=e,i=o}return e}const Vx=ny.bind({ignoreUndefined:!0}),$x={},Hx=262144,Kx=ny.bind({ignoreUndefined:!0}),qx=fa("helia:unixfs:chmod"),jx={recursive:!1,shardSplitThresholdBytes:Hx},Wx=ny.bind({ignoreUndefined:!0}),Gx=fa("helia:unixfs:cp"),Yx={force:!1,shardSplitThresholdBytes:Hx},Qx=ny.bind({ignoreUndefined:!0}),Xx={},Zx=ny.bind({ignoreUndefined:!0}),Jx=fa("helia:unixfs:mkdir"),eT={cidVersion:1,force:!1,shardSplitThresholdBytes:Hx},tT=fa("helia:unixfs:utils:remove-link"),nT=ny.bind({ignoreUndefined:!0}),rT=fa("helia:unixfs:rm"),iT={shardSplitThresholdBytes:Hx};async function oT(e,t,n,r={}){const i=nT(iT,r);if(t.includes("/"))throw new ax("Name must not have slashes");const o=await Bx(e,n,i);rT("Removing %s from %c",t,e);const s=await async function(e,t,n,r){if(null==e.node.Data)throw new ex("Parent node had no data");if("hamt-sharded-directory"===UI.unmarshal(e.node.Data).type){tT(`removing ${t} from sharded directory`);const i=await(async(e,t,n,r)=>{const{path:i}=await Ax(e.cid,t,n,r),o=i[i.length-1];if(null==o)throw new Error("Invalid HAMT, could not generate path");const s=o.node.Links.filter(e=>(e.Name??"").substring(2)===t).map(e=>e.Name).pop();if(null==s)throw new Error("File not found");const a=s.substring(0,2),l=parseInt(a,16);if(o.node.Links=o.node.Links.filter(e=>e.Name!==s),o.children.unset(l),1===o.node.Links.length)for(;1!==i.length;){const e=i[i.length-1];if(null==e||e.node.Links.length>1)break;i.pop();const t=i[i.length-1];if(null==t)break;const n=e.node.Links[0];t.node.Links=t.node.Links.filter(e=>!(e.Name??"").startsWith(t.prefix)),t.node.Links.push({Hash:n.Hash,Name:`${t.prefix}${(n.Name??"").substring(2)}`,Tsize:n.Tsize})}return Ix(i,n,r)})(e,t,n,r);return await xx(i.node,n,r.shardSplitThresholdBytes,r)?i:(tT("converting shard to flat directory %c",e.cid),(async(e,t,n)=>{if(null==e.node.Data)throw new ax("Invalid parent passed to convertToFlatDirectory");const r={Links:[]},i=await QA(e.cid,t);if("directory"!==i.type)throw new Error("Unexpected node type");for await(const e of i.content()){let t=0;t=e.node instanceof Uint8Array?e.node.byteLength:Pu(e.node).length,r.Links.push({Hash:e.cid,Name:e.name,Tsize:t})}const o=UI.unmarshal(e.node.Data);r.Data=new UI({type:"directory",mode:o.mode,mtime:o.mtime}).marshal();const s=Pu(Au(r));return{cid:await mx(s,t,{codec:m,cidVersion:e.cid.version,signal:n.signal}),node:r}})(i,n,r))}return tT(`removing link ${t} regular directory`),(async(e,t,n,r)=>{e.node.Links=e.node.Links.filter(e=>e.Name!==t);const i=Pu(e.node),o=await mx(i,n,{...r,cidVersion:e.cid.version});return tT(`Updated regular directory ${o}`),{node:e.node,cid:o}})(e,t,n,r)}(o,t,n,{...i,cidVersion:e.version});return s.cid}const sT=ny.bind({ignoreUndefined:!0}),aT=fa("helia:unixfs:stat"),lT={};async function cT(e,t,n={}){const r=sT(lT,n),i=await Fx(e,n.path,t,r);aT("stat %c",i.cid);const o=await QA(i.cid,t,r);if("file"!==o.type&&"directory"!==o.type&&"raw"!==o.type)throw new JA;let s,a,l=0n,c=0n,u=0n,d=0n,h=0;const f=o.type;let p;if("raw"===o.type&&(l=BigInt(o.node.byteLength),c=BigInt(o.node.byteLength),u=BigInt(o.node.byteLength),d=BigInt(o.node.byteLength),h=1),"directory"===o.type&&(l=0n,c=BigInt(o.unixfs.marshal().byteLength),u=0n,d=c,h=1,s=o.unixfs.mode,a=o.unixfs.mtime,p=o.unixfs),"file"===o.type){const e=await uT(i.cid,t,r);l=o.unixfs.fileSize(),c=BigInt((o.node.Data?.byteLength??0)+o.node.Links.reduce((e,t)=>e+(t.Tsize??0),0)),u=BigInt(e.localFileSize),d=BigInt(e.localDagSize),h=e.blocks,s=o.unixfs.mode,a=o.unixfs.mtime,p=o.unixfs}return{cid:i.cid,mode:s,mtime:a,fileSize:l,dagSize:c,localFileSize:u,localDagSize:d,blocks:h,type:f,unixfs:p}}async function uT(e,t,n){const r={localFileSize:0,localDagSize:0,blocks:0};if(await t.has(e,n)){const i=await t.get(e,n);if(r.blocks++,r.localDagSize+=i.byteLength,e.code===Xt)r.localFileSize+=i.byteLength;else{if(e.code!==Du)throw new tx(`${e.toString()} was neither DAG_PB nor RAW`);{const o=Lu(i);if(o.Links.length>0)for(const e of o.Links){const i=await uT(e.Hash,t,n);r.localFileSize+=i.localFileSize,r.localDagSize+=i.localDagSize,r.blocks+=i.blocks}else{if(null==o.Data)throw new ex(`PBNode ${e.toString()} had no data`);const t=UI.unmarshal(o.Data);if(null==t.data)throw new ex(`UnixFS node ${e.toString()} had no data`);r.localFileSize+=t.data.byteLength??0}}}}return r}const dT=ny.bind({ignoreUndefined:!0}),hT=fa("helia:unixfs:touch"),fT={recursive:!1,shardSplitThresholdBytes:Hx};class pT{components;constructor(e){this.components=e}async*addAll(e,t={}){yield*async function*(e,t,n={}){yield*SA(e,t,{..._A,...n})}(e,this.components.blockstore,t)}async addBytes(e,t={}){return async function(e,t,n={}){const{cid:r}=await async function(e,t,n={}){return kA({content:e},t,n)}(e,t,{..._A,...n});return r}(e,this.components.blockstore,t)}async addByteStream(e,t={}){return async function(e,t,n={}){const{cid:r}=await async function(e,t,n={}){return kA({content:e},t,n)}(e,t,{..._A,...n});return r}(e,this.components.blockstore,t)}async addFile(e,t={}){return async function(e,t,n={}){const{cid:r}=await kA(e,t,{..._A,...n});return r}(e,this.components.blockstore,t)}async addDirectory(e={},t={}){return async function(e,t,n={}){const{cid:r}=await async function(e,t,n={}){const r=await CE(SA([e],t,n));if(null==r)throw new VI("Nothing imported");return r}({...e,path:e.path??"-"},t,{..._A,...n});return r}(e,this.components.blockstore,t)}async*cat(e,t={}){yield*async function*(e,t,n={}){const r=Vx($x,n),i=await Fx(e,r.path,t,r),o=await QA(i.cid,t,r);if("file"!==o.type&&"raw"!==o.type)throw new ox;if(null==o.content)throw new ix;yield*o.content(r)}(e,this.components.blockstore,t)}async chmod(e,t,n={}){return async function(e,t,n,r={}){const i=Kx(jx,r),o=await Fx(e,i.path,n,r);if(qx("chmod %c %d",o.cid,t),i.recursive){const s=await De(async function*(){for await(const e of XA(o.cid,n,r)){let n,r=[];if("raw"===e.type)n=new UI({type:"file",data:e.node});else{if("file"!==e.type&&"directory"!==e.type)throw new JA;n=e.unixfs,r=e.node.Links}n.mode=t;const i={Data:n.marshal(),Links:r};yield{path:e.path,content:i}}},t=>SA(t,n,{...i,dagBuilder:async function*(t,n){for await(const r of t)yield async function(){const t=r.content,o=Pu(t),s=await mx(o,n,{...i,cidVersion:e.version});if(null==t.Data)throw new ex(`${s} had no data`);const a=UI.unmarshal(t.Data);return{cid:s,size:BigInt(o.length),path:r.path,unixfs:a}}}}),async e=>RA(e));if(null==s)throw new tx(`Could not chmod ${o.cid.toString()}`);return zx(s.cid,o,n,i)}const s=await n.get(o.cid,r);let a,l=[];if(o.cid.code===Xt)a=new UI({type:"file",data:s});else{const e=Lu(s);if(null==e.Data)throw new ex(`${o.cid.toString()} had no data`);l=e.Links,a=UI.unmarshal(e.Data)}a.mode=t;const c=Pu({Data:a.marshal(),Links:l}),u=await xn.digest(c),d=Pn.create(o.cid.version,Du,u);return await n.put(d,c),zx(d,o,n,i)}(e,t,this.components.blockstore,n)}async cp(e,t,n,r={}){return async function(e,t,n,r,i={}){const o=Wx(Yx,i);if(n.includes("/"))throw new ax("Name must not have slashes");const[s,a]=await Promise.all([Bx(t,r,o),Ox(e,n,r,o)]);return Gx('Adding %c as "%s" to %c',e,n,t),(await Nx(s,a,r,{allowOverwriting:o.force,cidVersion:t.version,...o})).cid}(e,t,n,this.components.blockstore,r)}async*ls(e,t={}){yield*async function*(e,t,n={}){const r=Qx(Xx,n),i=await Fx(e,r.path,t,r),o=await QA(i.cid,t);if("file"!==o.type&&"raw"!==o.type){if(null==o.content)throw new ix;if("directory"!==o.type)throw new sx;yield*o.content({offset:n.offset,length:n.length})}else yield o}(e,this.components.blockstore,t)}async mkdir(e,t,n={}){return async function(e,t,n,r={}){const i=Zx(eT,r);if(t.includes("/"))throw new ax("Path must not have slashes");if("directory"!==(await QA(e,n,r)).type)throw new sx(`${e.toString()} was not a UnixFS directory`);Jx("creating %s",t);const o=Pu({Data:new UI({type:"directory",mode:i.mode,mtime:i.mtime}).marshal(),Links:[]}),s=await xn.digest(o),a=Pn.create(i.cidVersion,Du,s);await n.put(a,o);const[l,c]=await Promise.all([Bx(e,n,i),Ox(a,t,n,i)]);return Jx("adding empty dir called %s to %c",t,e),(await Nx(l,c,n,{...i,allowOverwriting:i.force})).cid}(e,t,this.components.blockstore,n)}async rm(e,t,n={}){return oT(e,t,this.components.blockstore,n)}async stat(e,t={}){return cT(e,this.components.blockstore,t)}async touch(e,t={}){return async function(e,t,n={}){const r=dT(fT,n),i=await Fx(e,r.path,t,r),o=r.mtime??{secs:BigInt(Math.round(Date.now()/1e3)),nsecs:0};if(hT("touch %c %o",i.cid,o),r.recursive){const n=await De(async function*(){for await(const e of XA(i.cid,t)){let t,n;if("raw"===e.type)t=new UI({data:e.node}),n=[];else{if("file"!==e.type&&"directory"!==e.type)throw new JA;t=e.unixfs,n=e.node.Links}t.mtime=o;const r={Data:t.marshal(),Links:n};yield{path:e.path,content:r}}},n=>SA(n,t,{...r,dagBuilder:async function*(t,n){for await(const i of t)yield async function(){const t=i.content,o=Pu(t),s=await mx(o,n,{...r,cidVersion:e.version});if(null==t.Data)throw new ex(`${s} had no data`);const a=UI.unmarshal(t.Data);return{cid:s,size:BigInt(o.length),path:i.path,unixfs:a}}}}),async e=>RA(e));if(null==n)throw new tx(`Could not chmod ${i.cid.toString()}`);return zx(n.cid,i,t,r)}const s=await t.get(i.cid,n);let a,l=[];if(i.cid.code===Xt)a=new UI({data:s});else{const e=Lu(s);if(l=e.Links,null==e.Data)throw new ex(`${i.cid.toString()} had no data`);a=UI.unmarshal(e.Data)}a.mtime=o;const c=Pu({Data:a.marshal(),Links:l}),u=await xn.digest(c),d=Pn.create(i.cid.version,Du,u);return await t.put(d,c),zx(d,i,t,r)}(e,this.components.blockstore,t)}}class gT{components;constructor(e){this.components=e}async add(e,t={}){const n=Gt(e),r=await(t.hasher??xn).digest(n),i=Pn.createV1(Wt,r);return await this.components.blockstore.put(i,n,t),i}async get(e,t={}){return Yt(await this.components.blockstore.get(e,t))}}var mT=n(203);const yT={Null:e=>null===e?e:void 0,Int:e=>Number.isInteger(e)?e:void 0,Float:e=>"number"==typeof e&&Number.isFinite(e)?e:void 0,String:e=>"string"==typeof e?e:void 0,Bool:e=>"boolean"==typeof e?e:void 0,Bytes:e=>e instanceof Uint8Array?e:void 0,Link:e=>null!==e&&"object"==typeof e&&e.asCID===e?e:void 0,List:e=>Array.isArray(e)?e:void 0,Map:e=>null===e||"object"!=typeof e||e.asCID===e||Array.isArray(e)||e instanceof Uint8Array?void 0:e},wT={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":yT.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(void 0!==yT.List(e)){for(let t=0;t<e.length;t++){let n=e[t];if(n=wT["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](n),void 0===n)return;if(n!==e[t]){const n=e.slice(0,t);for(let r=t;r<e.length;r++){let t=e[r];if(t=wT["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),void 0===t)return;n.push(t)}return n}}return e}},Int:yT.Int,CarV1HeaderOrV2Pragma:e=>{if(void 0===yT.Map(e))return;const t=Object.entries(e);let n=e,r=1;for(let i=0;i<t.length;i++){const[o,s]=t[i];switch(o){case"roots":{const r=wT["CarV1HeaderOrV2Pragma > roots (anon)"](e[o]);if(void 0===r)return;if(r!==s||n!==e){if(n===e){n={};for(let e=0;e<i;e++)n[t[e][0]]=t[e][1]}n.roots=r}}break;case"version":{r--;const a=wT.Int(e[o]);if(void 0===a)return;if(a!==s||n!==e){if(n===e){n={};for(let e=0;e<i;e++)n[t[e][0]]=t[e][1]}n.version=a}}break;default:return}}return r>0?void 0:n}},bT={"CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)":yT.Link,"CarV1HeaderOrV2Pragma > roots (anon)":e=>{if(void 0!==yT.List(e)){for(let t=0;t<e.length;t++){let n=e[t];if(n=bT["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](n),void 0===n)return;if(n!==e[t]){const n=e.slice(0,t);for(let r=t;r<e.length;r++){let t=e[r];if(t=bT["CarV1HeaderOrV2Pragma > roots (anon) > valueType (anon)"](t),void 0===t)return;n.push(t)}return n}}return e}},Int:yT.Int,CarV1HeaderOrV2Pragma:e=>{if(void 0===yT.Map(e))return;const t=Object.entries(e);let n=e,r=1;for(let i=0;i<t.length;i++){const[o,s]=t[i];switch(o){case"roots":{const r=bT["CarV1HeaderOrV2Pragma > roots (anon)"](s);if(void 0===r)return;if(r!==s||n!==e){if(n===e){n={};for(let e=0;e<i;e++)n[t[e][0]]=t[e][1]}n.roots=r}}break;case"version":{r--;const o=bT.Int(s);if(void 0===o)return;if(o!==s||n!==e){if(n===e){n={};for(let e=0;e<i;e++)n[t[e][0]]=t[e][1]}n.version=o}}break;default:return}}return r>0?void 0:n}},vT={toTyped:wT.CarV1HeaderOrV2Pragma,toRepresentation:bT.CarV1HeaderOrV2Pragma};async function ET(e,t){const n=function(e,t){if(!e.length)throw new Error("Unexpected end of data");const n=mT.decode(e);return t.seek(mT.decode.bytes),n}(await e.upTo(8),e);if(0===n)throw new Error("Invalid CAR header (zero length)");const r=await e.exactly(n,!0),i=nu(r);if(void 0===vT.toTyped(i))throw new Error("Invalid CAR header format");if(1!==i.version&&2!==i.version||void 0!==t&&i.version!==t)throw new Error(`Invalid CAR version: ${i.version}${void 0!==t?` (expected ${t})`:""}`);if(1===i.version){if(!Array.isArray(i.roots))throw new Error("Invalid CAR header format");return i}if(void 0!==i.roots)throw new Error("Invalid CAR header format");const o=function(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let n=0;return{version:2,characteristics:[t.getBigUint64(n,!0),t.getBigUint64(n+=8,!0)],dataOffset:Number(t.getBigUint64(n+=8,!0)),dataSize:Number(t.getBigUint64(n+=8,!0)),indexOffset:Number(t.getBigUint64(n+=8,!0))}}(await e.exactly(40,!0));e.seek(o.dataOffset-e.pos);const s=await ET(e,1);return Object.assign(s,o)}tc(),new Ga(Wa.map,2),new Ga(Wa.string,"version"),new Ga(Wa.uint,1),new Ga(Wa.string,"roots"),new Ga(Wa.tag,42),Symbol.asyncIterator;function ST(e){const t=uc({version:1,roots:e},Jc),n=mT.encode(t.length),r=new Uint8Array(n.length+t.length);return r.set(n,0),r.set(t,n.length),r}function kT(){}Symbol.asyncIterator,Symbol.asyncIterator;class _T{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array&&e.cid))throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");const t=Pn.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then(()=>this._encoder.writeBlock({cid:t,bytes:e.bytes})),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}version(){return this._encoder.version()}static create(e){e=function(e){if(void 0===e)return[];if(!Array.isArray(e)){const t=Pn.asCID(e);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}const t=[];for(const n of e){const e=Pn.asCID(n);if(!e)throw new TypeError("roots must be a single CID or an array of CIDs");t.push(e)}return t}(e);const{encoder:t,iterator:n}=IT();return{writer:new _T(e,t),out:new RT(n)}}static createAppender(){const{encoder:e,iterator:t}=IT();return e.setRoots=()=>Promise.resolve(),{writer:new _T([],e),out:new RT(t)}}static async updateRootsInBytes(e,t){const n=function(e){let t=0;return{upTo:async n=>e.subarray(t,t+Math.min(n,e.length-t)),async exactly(n,r=!1){if(n>e.length-t)throw new Error("Unexpected end of data");const i=e.subarray(t,t+n);return r&&(t+=n),i},seek(e){t+=e},get pos(){return t}}}(e);await ET(n);const r=ST(t);if(Number(n.pos)!==r.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${r.length} bytes)`);return e.set(r,0),e}}class RT{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}}function IT(){const e=function(){const e=[];let t=null,n=kT,r=!1,i=null,o=kT;const s=()=>(t||(t=new Promise(e=>{n=()=>{t=null,n=kT,e()}})),t),a={write(t){e.push(t);const n=s();return o(),n},async end(){r=!0;const e=s();o(),await e}},l={async next(){const t=e.shift();return t?(0===e.length&&n(),{done:!1,value:t}):r?(n(),{done:!0,value:void 0}):(i||(i=new Promise(e=>{o=()=>(i=null,o=kT,e(l.next()))})),i)}};return{writer:a,iterator:l}}(),{writer:t,iterator:n}=e,r=function(e){return{async setRoots(t){const n=ST(t);await e.write(n)},async writeBlock(t){const{cid:n,bytes:r}=t;await e.write(new Uint8Array(mT.encode(n.bytes.length+r.length))),await e.write(n.bytes),r.length&&await e.write(r)},async close(){await e.end()},version:()=>1}}(t);return{encoder:r,iterator:n}}const AT=(0,E.createContext)(null),xT=({children:e})=>{const[t,n]=(0,E.useState)(null),[r,i]=(0,E.useState)(null),[o,s]=(0,E.useState)(null),[a,l]=(0,E.useState)(!1);(0,E.useEffect)(()=>((async()=>{try{console.log("Initializing Helia...");const e=await async function(e={}){const t=e.datastore??new ka,n=e.blockstore??new Ys;let r;var i;r=null!=(i=e.libp2p)&&["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(e=>"function"==typeof i[e])?e.libp2p:await _I({...e,libp2p:{dns:e.dns,...e.libp2p,start:void 0},datastore:t});const o=new Zu({...e,libp2p:r,datastore:t,blockstore:n,blockBrokers:e.blockBrokers??[us(),Ti()],routers:[hs(r),Us()],metrics:r.metrics});return!1!==e.start&&await o.start(),o}({start:!0}),t=function(e){return new pT(e)}(e),r=function(e){return new gT(e)}(e);n(e),i(t),s(r),l(!0),console.log("Helia initialized successfully")}catch(e){console.error("Failed to initialize Helia:",e)}})(),()=>{t&&(console.log("Stopping Helia..."),t.stop().catch(console.error))}),[]);const c={isReady:a,addFile:async e=>{if(!r)throw new Error("Helia not ready");const t=new Uint8Array(await e.arrayBuffer());return(await r.addFile({content:t})).toString()},addMemory:async e=>{if(!o)throw new Error("Helia not ready");const t={...e,date:e.date||(new Date).toISOString()};return(await o.add(t)).toString()},getMemory:async e=>{if(!o)throw new Error("Helia not ready");try{const t=Pn.parse(e);return await o.get(t)}catch(e){return console.error("Failed to get memory:",e),null}},getFile:async e=>{if(!r)throw new Error("Helia not ready");try{const t=Pn.parse(e),n=[];for await(const e of r.cat(t))n.push(new Uint8Array(e));const i=n.reduce((e,t)=>e+t.length,0),o=new Uint8Array(i);let s=0;for(const e of n)o.set(e,s),s+=e.length;return o}catch(e){return console.error("Failed to get file:",e),null}},exportCAR:async e=>{if(!t)throw new Error("Helia not ready");try{const n=e.map(e=>Pn.parse(e)),{writer:r,out:i}=_T.create(n);for(const n of e)try{const e=Pn.parse(n),i=await t.blockstore.get(e);await r.put({cid:e,bytes:new Uint8Array(i)})}catch(e){console.warn(`Failed to add block ${n} to CAR:`,e)}await r.close();const o=[];for await(const e of i)o.push(new Uint8Array(e));const s=o.reduce((e,t)=>e+t.length,0),a=new Uint8Array(s);let l=0;for(const e of o)a.set(e,l),l+=e.length;return a}catch(e){throw console.error("Failed to create CAR:",e),new Error("Failed to export CAR file")}}};return(0,v.jsx)(AT.Provider,{value:c,children:e})},TT=()=>{const e=(0,E.useContext)(AT);if(!e)throw new Error("useHelia must be used within a HeliaProvider");return e},CT=({memory:e,onExport:t})=>{const{getFile:n}=TT(),[r,i]=(0,E.useState)(!1),[o,s]=(0,E.useState)(null),a=async(e,t)=>{try{await navigator.clipboard.writeText(e),console.log(`${t} CID copied to clipboard`)}catch(t){console.error("Failed to copy CID:",t);const n=document.createElement("textarea");n.value=e,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}},l=e.fileType?.startsWith("image/"),c=e.fileType?.startsWith("video/"),u=e.fileType?.startsWith("audio/");return(0,v.jsxs)("div",{style:NT.card,children:[(0,v.jsxs)("div",{style:NT.header,children:[(0,v.jsx)("h3",{style:NT.title,children:e.title}),(0,v.jsxs)("div",{style:NT.meta,children:[(0,v.jsx)("span",{style:NT.date,children:(e=>{if(!e)return"Unknown date";try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return"Invalid date"}})(e.date)}),e.fileSize&&(0,v.jsx)("span",{style:NT.size,children:(e=>{if(!e)return"Unknown size";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]})(e.fileSize)})]})]}),(0,v.jsxs)("div",{style:NT.content,children:[(0,v.jsx)("p",{style:NT.description,children:e.description}),e.tags&&e.tags.length>0&&(0,v.jsx)("div",{style:NT.tags,children:e.tags.map((e,t)=>(0,v.jsxs)("span",{style:NT.tag,children:["#",e]},t))}),(0,v.jsxs)("div",{style:NT.preview,children:[o&&l&&(0,v.jsx)("img",{src:o,alt:e.title,style:NT.previewImage}),o&&c&&(0,v.jsx)("video",{src:o,controls:!0,style:NT.previewVideo}),o&&u&&(0,v.jsx)("audio",{src:o,controls:!0,style:NT.previewAudio}),!o&&!r&&(0,v.jsxs)("div",{style:NT.previewPlaceholder,onClick:async()=>{if(!o&&!r){i(!0);try{const t=await n(e.fileCid);if(t){const n=new Blob([new Uint8Array(t)],{type:e.fileType||"application/octet-stream"}),r=URL.createObjectURL(n);s(r)}}catch(e){console.error("Failed to load preview:",e)}finally{i(!1)}}},children:[(0,v.jsx)("div",{style:NT.fileIcon,children:"📁"}),(0,v.jsx)("div",{style:NT.fileName,children:e.fileName||"Unknown file"}),(0,v.jsx)("div",{style:NT.previewText,children:"Click to preview"})]}),r&&(0,v.jsx)("div",{style:NT.previewPlaceholder,children:(0,v.jsx)("div",{style:NT.loading,children:"Loading..."})})]})]}),(0,v.jsxs)("div",{style:NT.footer,children:[(0,v.jsxs)("div",{style:NT.cids,children:[(0,v.jsxs)("div",{style:NT.cidItem,children:[(0,v.jsx)("strong",{children:"File CID:"}),(0,v.jsx)("code",{style:NT.cid,children:e.fileCid}),(0,v.jsx)("button",{style:NT.copyButton,onClick:()=>a(e.fileCid,"File"),title:"Copy File CID",children:"📋"})]}),(0,v.jsxs)("div",{style:NT.cidItem,children:[(0,v.jsx)("strong",{children:"Memory CID:"}),(0,v.jsx)("code",{style:NT.cid,children:e.metaCid}),(0,v.jsx)("button",{style:NT.copyButton,onClick:()=>a(e.metaCid,"Memory"),title:"Copy Memory CID",children:"📋"})]})]}),(0,v.jsxs)("div",{style:NT.actions,children:[(0,v.jsx)("button",{style:NT.button,onClick:async()=>{try{const t=await n(e.fileCid);if(t){const n=new Blob([new Uint8Array(t)],{type:e.fileType||"application/octet-stream"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download=e.fileName||`memory-${e.fileCid.slice(0,8)}`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r)}}catch(e){console.error("Failed to download file:",e)}},children:"📥 Download"}),t&&(0,v.jsx)("button",{style:NT.buttonSecondary,onClick:()=>t(e),children:"📦 Export CAR"})]})]})]})},NT={card:{background:"white",borderRadius:"12px",padding:"20px",marginBottom:"20px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",border:"1px solid #e1e5e9"},header:{marginBottom:"16px"},title:{margin:"0 0 8px 0",fontSize:"1.25rem",fontWeight:"bold",color:"#1a1a1a"},meta:{display:"flex",gap:"16px",fontSize:"0.875rem",color:"#666"},date:{},size:{},content:{marginBottom:"16px"},description:{margin:"0 0 12px 0",lineHeight:"1.5",color:"#333"},tags:{display:"flex",flexWrap:"wrap",gap:"6px",marginBottom:"16px"},tag:{background:"#e7f3ff",color:"#0066cc",padding:"2px 8px",borderRadius:"12px",fontSize:"0.75rem",fontWeight:"500"},preview:{border:"2px dashed #ddd",borderRadius:"8px",minHeight:"120px",display:"flex",alignItems:"center",justifyContent:"center",marginBottom:"16px",overflow:"hidden"},previewPlaceholder:{textAlign:"center",cursor:"pointer",padding:"20px",transition:"background-color 0.2s"},fileIcon:{fontSize:"2rem",marginBottom:"8px"},fileName:{fontWeight:"500",marginBottom:"4px",color:"#333"},previewText:{fontSize:"0.875rem",color:"#666"},previewImage:{maxWidth:"100%",maxHeight:"200px",objectFit:"contain"},previewVideo:{maxWidth:"100%",maxHeight:"200px"},previewAudio:{width:"100%"},loading:{color:"#666",fontStyle:"italic"},footer:{},cids:{marginBottom:"16px",fontSize:"0.75rem"},cidItem:{marginBottom:"4px",display:"flex",alignItems:"center",gap:"8px"},cid:{background:"#f5f5f5",padding:"2px 6px",borderRadius:"4px",fontSize:"0.7rem",fontFamily:"monospace",wordBreak:"break-all",flex:1},actions:{display:"flex",gap:"8px"},button:{background:"#667eea",color:"white",border:"none",padding:"8px 16px",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500",transition:"background-color 0.2s"},buttonSecondary:{background:"#6c757d",color:"white",border:"none",padding:"8px 16px",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500",transition:"background-color 0.2s"},copyButton:{background:"transparent",border:"none",cursor:"pointer",padding:"2px 4px",fontSize:"0.75rem",borderRadius:"3px",transition:"background-color 0.2s",marginLeft:"4px"}},DT=()=>{const{isReady:e,addFile:t,addMemory:n,getMemory:r,exportCAR:i}=TT(),[o,s]=(0,E.useState)([]),[a,l]=(0,E.useState)(!1),[c,u]=(0,E.useState)(""),[d,h]=(0,E.useState)(!1),[f,p]=(0,E.useState)(!1),[g,m]=(0,E.useState)(null),[y,w]=(0,E.useState)(""),[b,S]=(0,E.useState)(""),[k,_]=(0,E.useState)(""),R=(0,E.useRef)(null),I=async e=>{try{const t=[e.fileCid,e.metaCid],n=await i(t),r=new Blob([new Uint8Array(n)],{type:"application/vnd.ipld.car"}),o=URL.createObjectURL(r),s=document.createElement("a");s.href=o,s.download=`${e.title.replace(/[^a-zA-Z0-9]/g,"_")}.car`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}catch(e){console.error("Failed to export CAR:",e),alert("Failed to export CAR file. Please try again.")}};return e?(0,v.jsxs)("div",{style:PT.app,children:[(0,v.jsxs)("header",{style:PT.header,children:[(0,v.jsx)("h1",{style:PT.title,children:"🌌 Etherith"}),(0,v.jsx)("p",{style:PT.subtitle,children:"Minimalist IPFS Memory Archiver"})]}),(0,v.jsxs)("main",{style:PT.main,children:[(0,v.jsxs)("div",{style:PT.uploadSection,children:[(0,v.jsx)("h2",{style:PT.sectionTitle,children:"📁 Preserve a Memory"}),(0,v.jsxs)("div",{style:PT.formGrid,children:[(0,v.jsxs)("div",{style:{...PT.fileUpload,...f?PT.dragOver:{}},onDragOver:e=>{e.preventDefault(),p(!0)},onDragLeave:e=>{e.preventDefault(),p(!1)},onDrop:e=>{e.preventDefault(),p(!1);const t=e.dataTransfer.files;if(t.length>0){const e=t[0];m(e),y||w(e.name)}},className:"drop-zone",children:[(0,v.jsx)("input",{ref:R,type:"file",onChange:e=>{const t=e.target.files?.[0];t&&(m(t),y||w(t.name))},style:PT.fileInput,id:"file-input"}),(0,v.jsx)("label",{htmlFor:"file-input",style:PT.fileLabel,children:g?(0,v.jsxs)(v.Fragment,{children:["📁 ",g.name]}):(0,v.jsxs)(v.Fragment,{children:["📎 ",f?"Drop file here":"Choose File or Drag & Drop"]})})]}),(0,v.jsx)("input",{type:"text",placeholder:"Memory title...",value:y,onChange:e=>w(e.target.value),style:PT.input}),(0,v.jsx)("textarea",{placeholder:"Describe this memory...",value:b,onChange:e=>S(e.target.value),style:PT.textarea,rows:3}),(0,v.jsx)("input",{type:"text",placeholder:"Tags (comma-separated)...",value:k,onChange:e=>_(e.target.value),style:PT.input}),(0,v.jsx)("button",{onClick:async()=>{if(g&&y.trim()&&b.trim()){l(!0);try{const e=await t(g),r={title:y.trim(),description:b.trim(),tags:k.trim()?k.split(",").map(e=>e.trim()).filter(Boolean):void 0,fileCid:e,fileName:g.name,fileSize:g.size,fileType:g.type,date:(new Date).toISOString()},i=await n(r),o={...r,metaCid:i};s(e=>[o,...e]),m(null),w(""),S(""),_(""),R.current&&(R.current.value=""),console.log("Memory preserved:",{fileCid:e,metaCid:i})}catch(e){console.error("Failed to preserve memory:",e),alert("Failed to preserve memory. Please try again.")}finally{l(!1)}}else alert("Please fill in all required fields and select a file.")},disabled:!g||!y.trim()||!b.trim()||a,style:{...PT.button,...g&&y.trim()&&b.trim()&&!a?{}:PT.buttonDisabled},children:a?"🔄 Preserving...":"💾 Preserve Memory"})]})]}),(0,v.jsxs)("div",{style:PT.loadSection,children:[(0,v.jsx)("h2",{style:PT.sectionTitle,children:"🔍 Load Memory by CID"}),(0,v.jsxs)("div",{style:PT.loadForm,children:[(0,v.jsx)("input",{type:"text",placeholder:"Enter memory CID...",value:c,onChange:e=>u(e.target.value),style:{...PT.input,flex:1}}),(0,v.jsx)("button",{onClick:async()=>{if(c.trim()){h(!0);try{const e=await r(c.trim());if(e){const t={...e,metaCid:c.trim()},n=o.some(e=>e.metaCid===c.trim());n||s(e=>[t,...e]),u("")}else alert("Memory not found or could not be loaded.")}catch(e){console.error("Failed to load memory:",e),alert("Failed to load memory. Please check the CID and try again.")}finally{h(!1)}}else alert("Please enter a memory CID.")},disabled:!c.trim()||d,style:{...PT.button,...!c.trim()||d?PT.buttonDisabled:{}},children:d?"🔄 Loading...":"📥 Load"})]})]}),(0,v.jsxs)("div",{style:PT.memoriesSection,children:[(0,v.jsxs)("div",{style:PT.memoriesHeader,children:[(0,v.jsxs)("h2",{style:PT.sectionTitle,children:["💭 Memories (",o.length,")"]}),o.length>0&&(0,v.jsx)("button",{onClick:async()=>{if(0!==o.length)try{const e=o.flatMap(e=>[e.fileCid,e.metaCid]),t=await i(e),n=new Blob([new Uint8Array(t)],{type:"application/vnd.ipld.car"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=`etherith_memories_${(new Date).toISOString().split("T")[0]}.car`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}catch(e){console.error("Failed to export all memories:",e),alert("Failed to export all memories. Please try again.")}else alert("No memories to export.")},style:PT.buttonSecondary,children:"📦 Export All"})]}),0===o.length?(0,v.jsxs)("div",{style:PT.emptyState,children:[(0,v.jsx)("div",{style:PT.emptyIcon,children:"🌟"}),(0,v.jsx)("h3",{children:"No memories yet"}),(0,v.jsx)("p",{children:"Upload your first file to create a memory archive"})]}):(0,v.jsx)("div",{style:PT.memoriesList,children:o.map(e=>(0,v.jsx)(CT,{memory:e,onExport:I},e.metaCid))})]})]}),(0,v.jsx)("footer",{style:PT.footer,children:(0,v.jsx)("p",{children:"Built with React, TypeScript & Helia • Stateless IPFS memory archiving"})})]}):(0,v.jsx)("div",{style:PT.loading,children:(0,v.jsxs)("div",{style:PT.loadingContent,children:[(0,v.jsx)("div",{style:PT.spinner}),(0,v.jsx)("h2",{children:"Initializing Etherith..."}),(0,v.jsx)("p",{children:"Starting IPFS node with Helia"})]})})},PT={app:{minHeight:"100vh",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},loading:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},loadingContent:{textAlign:"center",color:"white"},spinner:{width:"40px",height:"40px",border:"4px solid rgba(255, 255, 255, 0.3)",borderTop:"4px solid white",borderRadius:"50%",animation:"spin 1s linear infinite",margin:"0 auto 20px"},header:{textAlign:"center",padding:"40px 20px",color:"white"},title:{fontSize:"3rem",margin:"0 0 10px 0",fontWeight:"bold",textShadow:"2px 2px 4px rgba(0,0,0,0.3)"},subtitle:{fontSize:"1.2rem",margin:0,opacity:.9},main:{maxWidth:"800px",margin:"0 auto",padding:"0 20px 40px"},uploadSection:{background:"white",borderRadius:"12px",padding:"24px",marginBottom:"24px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)"},loadSection:{background:"white",borderRadius:"12px",padding:"24px",marginBottom:"24px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)"},memoriesSection:{background:"white",borderRadius:"12px",padding:"24px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)"},sectionTitle:{margin:"0 0 20px 0",fontSize:"1.5rem",fontWeight:"bold",color:"#1a1a1a"},formGrid:{display:"grid",gap:"16px"},fileUpload:{position:"relative"},fileInput:{display:"none"},fileLabel:{display:"block",padding:"12px 16px",background:"#f8f9fa",border:"2px dashed #dee2e6",borderRadius:"8px",textAlign:"center",cursor:"pointer",transition:"all 0.2s",fontWeight:"500"},dragOver:{background:"#f0f8ff",borderColor:"#667eea",transform:"scale(1.02)"},input:{width:"100%",padding:"12px 16px",border:"2px solid #e1e5e9",borderRadius:"8px",fontSize:"1rem",transition:"border-color 0.2s",boxSizing:"border-box"},textarea:{width:"100%",padding:"12px 16px",border:"2px solid #e1e5e9",borderRadius:"8px",fontSize:"1rem",resize:"vertical",minHeight:"80px",transition:"border-color 0.2s",boxSizing:"border-box",fontFamily:"inherit"},button:{background:"#667eea",color:"white",border:"none",padding:"12px 24px",borderRadius:"8px",fontSize:"1rem",fontWeight:"600",cursor:"pointer",transition:"background-color 0.2s"},buttonDisabled:{background:"#ccc",cursor:"not-allowed"},buttonSecondary:{background:"#6c757d",color:"white",border:"none",padding:"8px 16px",borderRadius:"6px",fontSize:"0.875rem",fontWeight:"500",cursor:"pointer",transition:"background-color 0.2s"},loadForm:{display:"flex",gap:"12px",alignItems:"stretch"},memoriesHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px"},memoriesList:{},emptyState:{textAlign:"center",padding:"60px 20px",color:"#666"},emptyIcon:{fontSize:"4rem",marginBottom:"16px"},footer:{textAlign:"center",padding:"20px",color:"rgba(255, 255, 255, 0.8)",fontSize:"0.875rem"}},LT=document.createElement("style");LT.textContent="\n  * {\n    box-sizing: border-box;\n  }\n  \n  body {\n    margin: 0;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',\n        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',\n        sans-serif;\n    -webkit-font-smoothing: antialiased;\n    -moz-osx-font-smoothing: grayscale;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    min-height: 100vh;\n  }\n  \n  @keyframes spin {\n    0% { transform: rotate(0deg); }\n    100% { transform: rotate(360deg); }\n  }\n  \n  input:focus,\n  textarea:focus,\n  button:focus {\n    outline: 2px solid #667eea;\n    outline-offset: 2px;\n  }\n  \n  input:hover:not(:disabled),\n  textarea:hover:not(:disabled) {\n    border-color: #667eea;\n  }\n  \n  button:hover:not(:disabled) {\n    transform: translateY(-1px);\n    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);\n  }\n  \n  label:hover {\n    background: #e9ecef !important;\n    border-color: #667eea !important;\n  }\n  \n  .drop-zone {\n    transition: all 0.2s ease;\n  }\n  \n  .drop-zone.dragover {\n    background: #f0f8ff !important;\n    border-color: #667eea !important;\n    transform: scale(1.02);\n  }\n",document.head.appendChild(LT),S.createRoot(document.getElementById("root")).render((0,v.jsx)(E.StrictMode,{children:(0,v.jsx)(()=>(0,v.jsx)(xT,{children:(0,v.jsx)(DT,{})}),{})})),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").then(e=>{console.log("SW registered: ",e)}).catch(e=>{console.log("SW registration failed: ",e)})})})()})();